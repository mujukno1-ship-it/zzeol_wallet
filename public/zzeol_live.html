<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>코인 검색 (KRW 전용) · 매수/매도 타점 · zzeol wallet</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#151a21; --muted:#7e8899; --ok:#1f6f3d; --warn:#7f2a2a; --chip:#222a33; --text:#e6edf3; --acc:#8ab4ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--acc);text-decoration:none}
    .container{max-width:1100px;margin:48px auto;padding:0 16px}
    .h1{font-size:28px;font-weight:800;letter-spacing:-.3px;margin:0 0 18px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .panel{background:var(--panel);border:1px solid #212734;border-radius:16px;padding:18px}
    .panel + .panel{margin-top:14px}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #252f3a;padding:6px 10px;border-radius:999px;font-weight:600}
    .chip.ok{background:#123b24;border-color:#1d4e33}
    .chip.warn{background:#402020;border-color:#5b3232}
    .btn{background:#1c2530;border:1px solid #263241;border-radius:10px;padding:9px 12px;color:#dce6f2;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .input{background:#0f1319;border:1px solid #2a3442;border-radius:10px;padding:10px 12px;color:#e6edf3;min-width:260px}
    .kvs{display:flex;gap:8px;flex-wrap:wrap}
    .kv{background:#10151c;border:1px solid #1f2833;border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
    .kv .k{color:#9aa5b1;font-size:12px}
    .kv .v{font-weight:800}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px}
    thead th{background:#121821;color:#93a0b2;text-align:left;font-size:12px;letter-spacing:.2px;padding:12px;border-bottom:1px solid #222d3a}
    tbody td{padding:14px 12px;border-bottom:1px solid #1b2430}
    tbody tr:hover{background:#0f141a}
    .r{text-align:right}
    .positive{color:#39d353}
    .negative{color:#ff7b72}
    .footer{color:#5f6b7a;font-size:12px;margin-top:18px}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="h1">코인 검색 (KRW 전용) · 매수/매도 타점</div>
        <div class="muted">업비트 연결과 온체인 응답 보건 · 전일가 기반 등락률 보정</div>
      </div>
      <div id="health-badges" class="row"></div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <input id="search" class="input" placeholder="예: 비트코인 또는 BTC (현재 KRW-BTC 고정)" />
          <button class="btn" id="btnFind">검색</button>
          <button class="btn" id="btnTop">상승TOP10</button>
          <button class="btn" id="btnBoom">급등</button>
          <button class="btn" id="btnDump">급락</button>
          <button class="btn" id="btnReset">초기화</button>
        </div>
        <div class="row">
          <span class="chip ok">시스템: OK</span>
        </div>
      </div>
    </div>

    <!-- 상단: BTC 정보 카드 -->
    <div class="panel" id="card">
      <div class="row kvs" id="tickerChips">
        <!-- 동적 채움 -->
      </div>
    </div>

    <!-- 온체인: 타점 표 바로 위로 이동 (요청사항 반영) -->
    <div class="panel" id="onchain">
      <div class="row" style="justify-content:space-between">
        <strong>BTC 온체인 상태</strong>
        <span id="onchainAts" class="muted">–</span>
      </div>
      <div class="row kvs" id="onchainBody" style="margin-top:12px"></div>
    </div>

    <!-- 매수/매도 타점 표 -->
    <div class="panel">
      <table>
        <thead>
          <tr>
            <th style="width:12%">코인</th>
            <th class="r" style="width:14%">현재가</th>
            <th class="r" style="width:12%">등락</th>
            <th class="r" style="width:12%">매수호가</th>
            <th class="r" style="width:12%">매도호가</th>
            <th class="r" style="width:12%">매수 타점</th>
            <th class="r" style="width:12%">매도 타점</th>
            <th class="r" style="width:12%">손절</th>
            <th style="width:10%">AI 위험도</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="footer">© zzeol wallet</div>
    </div>
  </div>

<script>
// =============================
// 유틸리티
// =============================
const KR = new Intl.NumberFormat('ko-KR');
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

function fmtKRW(n){ if(n==null||isNaN(n)) return '-'; return KR.format(Math.round(n)); }
function pctColor(p){ return p>0?'positive':(p<0?'negative':''); }
function timeAgo(ts){
  if(!ts) return '-';
  const diff = Math.max(0, Date.now()-ts);
  const m = Math.floor(diff/60000);
  if(m < 1) return '방금';
  if(m < 60) return `T-${m}m`;
  const h = Math.floor(m/60); return `T-${h}h`;
}

async function fetchJSON(url, opt={}){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), opt.timeout ?? 8000);
  try{
    const res = await fetch(url,{...opt, signal:ctrl.signal});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  } finally{ clearTimeout(t); }
}

// =============================
// 업비트 데이터 (KRW-BTC)
// =============================
async function getUpbitTicker(){
  const j = await fetchJSON('https://api.upbit.com/v1/ticker?markets=KRW-BTC');
  return j?.[0];
}
async function getUpbitCandleDay(){
  const j = await fetchJSON('https://api.upbit.com/v1/candles/days?market=KRW-BTC&count=1');
  return j?.[0];
}
async function getUpbitOrderbook(){
  const j = await fetchJSON('https://api.upbit.com/v1/orderbook?markets=KRW-BTC');
  return j?.[0]?.orderbook_units?.[0];
}

function calcChangePct(nowPrice, dayCandle){
  // prev_closing_price 우선 사용 (업비트 표준)
  const prevClose = dayCandle?.prev_closing_price ?? dayCandle?.trade_price;
  if(!prevClose || prevClose <= 0 || !nowPrice) return 0;
  const p = ((nowPrice - prevClose) / prevClose) * 100;
  // 비정상치 보정 (±30% 초과시 전일가 미수신으로 간주)
  if (Math.abs(p) > 30) return 0; 
  return +p.toFixed(2);
}

// =============================
// 온체인 (프로젝트 프록시 기준; 없으면 더미 값)
// =============================
async function getOnchain(){
  try{
    const j = await fetchJSON('/api/onchain/btc/status');
    return j;
  }catch(e){
    // 더미 (프록시 없을 때 화면 유지)
    return {
      mvrv: null,
      exchange_netflow: null,
      funding: null,
      stable_ratio: null,
      staking_unlock: null,
      updated_at: null
    };
  }
}

// =============================
// 헬스 체크 뱃지
// =============================
async function pingUpbit(){
  try{
    const [t,c] = await Promise.all([getUpbitTicker(), getUpbitCandleDay()]);
    return !!(t?.trade_price && c?.prev_closing_price);
  }catch{ return false; }
}
async function pingOnchain(){
  try{
    const oc = await getOnchain();
    const fresh = oc?.updated_at ? (Date.now()-new Date(oc.updated_at).getTime())/60000 < 15 : true;
    const hasAny = (oc?.mvrv!=null) || (oc?.funding!=null) || (oc?.stable_ratio!=null);
    return !!(hasAny && fresh);
  }catch{ return false; }
}
async function renderHealth(){
  const [u,o] = await Promise.all([pingUpbit(), pingOnchain()]);
  const el = document.querySelector('#health-badges');
  if(!el) return;
  el.innerHTML = `
    <span class="chip ${u?'ok':'warn'}">업비트: ${u?'OK':'오류'}</span>
    <span class="chip ${o?'ok':'warn'}">온체인: ${o?'OK':'대기/오류'}</span>
  `;
}

// =============================
// 렌더러
// =============================
function renderTickerCard({now,bidask,pct}){
  const box = document.getElementById('tickerChips');
  if(!box) return;
  const sign = pct>0?'+':'';
  const pctCls = pctColor(pct);
  const stop = now * 0.99; // 손절 1% 예시 (원하시면 변경)
  box.innerHTML = `
    <span class="chip">BTC</span>
    <span class="chip"><b>현재가</b> <span>${fmtKRW(now)}</span></span>
    <span class="chip ${pctCls}"><b>등락</b> <span>${sign}${pct.toFixed(2)}%</span></span>
    <span class="chip"><b>Bid</b> <span>${fmtKRW(bidask?.bid_price)}</span></span>
    <span class="chip"><b>Ask</b> <span>${fmtKRW(bidask?.ask_price)}</span></span>
    <span class="chip"><b>매수</b> <span>${fmtKRW(now)}</span></span>
    <span class="chip"><b>매도</b> <span>${fmtKRW(now)}</span></span>
    <span class="chip"><b>손절</b> <span>${fmtKRW(stop)}</span></span>
  `;
}

function renderTable({now,bidask,pct}){
  const tb = document.getElementById('tbody');
  if(!tb) return;
  const stop = now * 0.99;
  const sign = pct>0?'+':'';
  tb.innerHTML = `
    <tr>
      <td>BTC</td>
      <td class="r">${fmtKRW(now)}</td>
      <td class="r ${pctColor(pct)}">${sign}${pct.toFixed(2)}%</td>
      <td class="r">${fmtKRW(bidask?.bid_price)}</td>
      <td class="r">${fmtKRW(bidask?.ask_price)}</td>
      <td class="r">${fmtKRW(now)}</td>
      <td class="r">${fmtKRW(now)}</td>
      <td class="r">${fmtKRW(stop)}</td>
      <td>관망</td>
    </tr>`;
}

function renderOnchain(oc){
  const body = document.getElementById('onchainBody');
  const ts = oc?.updated_at ? new Date(oc.updated_at).getTime() : null;
  document.getElementById('onchainAts').textContent = ts? `업데이트: ${timeAgo(ts)}` : '업데이트: -';
  const items = [
    {k:'MVRV Z-Score', v: oc?.mvrv},
    {k:'거래소 순유입/순유출', v: oc?.exchange_netflow},
    {k:'펀딩비', v: oc?.funding},
    {k:'스테이블 비율', v: oc?.stable_ratio},
    {k:'스테이킹 언락', v: oc?.staking_unlock}
  ];
  body.innerHTML = items.map(x=>{
    const val = (x.v==null||Number.isNaN(x.v))?'-':x.v;
    return `<div class="kv"><span class="k">${x.k}</span><span class="v">${val}</span></div>`;
  }).join('');
}

// =============================
// 주 루프
// =============================
async function refresh(){
  try{
    const [ticker, candle, ob, oc] = await Promise.all([
      getUpbitTicker(), getUpbitCandleDay(), getUpbitOrderbook(), getOnchain()
    ]);
    const now = ticker?.trade_price ?? 0;
    const pct = calcChangePct(now, candle);
    renderTickerCard({now, bidask:ob, pct});
    renderTable({now, bidask:ob, pct});
    renderOnchain(oc);
  }catch(e){ console.error(e); }
}

// 빠른 반응성(1.5초), 과금/쿨다운 고려 시 2~3초로 변경 가능
setInterval(()=>{ refresh(); renderHealth(); }, 1500);

// 초기 실행
renderHealth(); refresh();

// 버튼 (현재는 데모 동작; 기존 로직과 충돌하지 않도록 no-op)
['btnFind','btnTop','btnBoom','btnDump','btnReset'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click',()=>{
    // 기존 프로젝트의 라우팅/필터가 있다면 여기에 연결
    console.log(id,'clicked');
  });
});
</script>
</body>
</html>
