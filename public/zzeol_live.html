<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 — 온체인·김프·업비트 통합 시나리오 엔진 v2</title>
  <style>
    body{background:#0f1419;color:#e6edf3;font-family:Pretendard,system-ui,Segoe UI,Roboto,sans-serif;margin:0;padding:20px}
    .card{background:#151b22;border:1px solid #2a3545;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{padding:6px 12px;border-radius:999px;font-weight:600;font-size:14px;display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3545}
    .chip.green{background:#0f2417;color:#7ce4af;border-color:#175e3d}
    .chip.yellow{background:#2c2a0f;color:#e4da7c;border-color:#5c5517}
    .chip.red{background:#2c0f0f;color:#e47c7c;border-color:#5e1717}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h2>분석 기반 타점 — 시나리오 엔진 v2 (BTC/KRW)</h2>
      <button id="btnAnalyze" style="margin-left:auto;padding:8px 12px;border-radius:8px;background:#1f2d44;color:#e6edf3;border:1px solid #284161">분석 실행</button>
    </div>
    <div id="anaBox" style="margin-top:10px;display:none">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div class="chip" id="anaSignal">신호: –</div>
        <div class="chip" id="anaAccuracy">정확도: –</div>
        <div class=\"chip\" id=\"anaRisk\">위험도: –<\/div>
        <div class=\"chip\" id=\"anaOBI\">호가 불균형: –<\/div>
        <div class=\"chip\" id=\"anaStable\">스테이블 유입: –<\/div>
        <div class=\"chip\" id=\"anaETF\">ETF 유입: –<\/div>
        <div class=\"chip\" id=\"anaChange\">24h 등락: –<\/div>
      </div>
      <table style="width:100%;margin-top:10px;border-collapse:separate;border-spacing:0">
        <thead>
          <tr style="color:#9fb0c0;text-transform:uppercase;font-size:12px">
            <th>항목</th>
            <th>USDT</th>
            <th>KRW(틱보정)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><b>매수(진입)</b></td><td id="anaEntryU">–</td><td id="anaEntryK">–</td></tr>
          <tr><td><b>익절1(TP1)</b></td><td id="anaTP1U">–</td><td id="anaTP1K">–</td></tr>
          <tr><td><b>익절2(TP2)</b></td><td id="anaTP2U">–</td><td id="anaTP2K">–</td></tr>
          <tr><td><b>손절(SL)</b></td><td id="anaSLU">–</td><td id="anaSLK">–</td></tr>
        </tbody>
      </table>
      <div style="margin-top:10px;color:#9fb0c0" id="anaWhy">근거: –</div>
    </div>
  </div>

  <script>
    async function analyzeScenario(){
      try{
        const upbit = await fetch('https://api.upbit.com/v1/ticker?markets=KRW-BTC').then(r=>r.json());
        const upPrice = upbit[0].trade_price;
        const ob = await fetch('https://api.upbit.com/v1/orderbook?markets=KRW-BTC').then(r=>r.json());
        const units = ob?.[0]?.orderbook_units||[];
        const bidVol = units.slice(0,5).reduce((s,u)=>s+u.bid_size,0);
        const askVol = units.slice(0,5).reduce((s,u)=>s+u.ask_size,0);
        const obi = bidVol/(askVol||1);

        const bpx = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT').then(r=>r.json());
        const price = parseFloat(bpx.price);
        const xr = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=KRW').then(r=>r.json());
        const usdkrw = xr.rates.KRW;
        const kimchi = (upPrice/(price*usdkrw)-1)*100;
        const fr = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex?symbol=BTCUSDT').then(r=>r.json());
        const funding = parseFloat(fr.lastFundingRate)*100;

        const kl = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&limit=200').then(r=>r.json());
        const close = kl.map(k=>parseFloat(k[4]));
        const high  = kl.map(k=>parseFloat(k[2]));
        const low   = kl.map(k=>parseFloat(k[3]));
        const e20 = (function(){ const k=2/21; let e=close[0]; for(let i=1;i<close.length;i++){ e=close[i]*k+e*(1-k);} return e; })();
        const e50 = (function(){ const k=2/51; let e=close[0]; for(let i=1;i<close.length;i++){ e=close[i]*k+e*(1-k);} return e; })();
        const atr = (function(){ const tr=[]; for(let i=1;i<high.length;i++){ const h=high[i],l=low[i],pc=close[i-1]; tr.push(Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc))); } let a=tr.slice(0,14).reduce((s,v)=>s+v,0)/14; for(let i=14;i<tr.length;i++){ a=(a*13+tr[i])/14;} return a; })();
        const trend = (price>e20&&e20>e50)?'상승':(price<e20&&e20<e50)?'하락':'횡보';

        let stableInflowUSD = null;
        try{
          const cg = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=tether,usd-coin&price_change_percentage=24h').then(r=>r.json());
          stableInflowUSD = cg.reduce((s,x)=>s + (x.market_cap_change_24h||0), 0);
        }catch(_){ stableInflowUSD = null; }

        let etfInflowUSD = null;
        try{
          const txt = await fetch('https://r.jina.ai/http://www.farside.co.uk/bitcoin-etf-flows').then(r=>r.text());
          const m = txt.match(/Total\\s+net\\s+inflow[s]?[\\s\\S]*?(?:\\$|US\\$|USD)?\\s*([+\\-]?[0-9,.]+)\\s*million/i);
          if(m){ etfInflowUSD = parseFloat(m[1].replace(/[,]/g,''))*1_000_000; }
        }catch(_){ etfInflowUSD = null; }

        let penalty=0, bonus=0;
        if(trend==='횡보') penalty+=20;
        if(Math.abs(kimchi)>5) penalty+=10;
        if(Math.abs(funding)>0.05) penalty+=5;
        if(atr/price>0.015) penalty+=10;
        const obiPenalty=(obi>1.5||obi<0.67)?5:0; penalty+=obiPenalty;

        if(stableInflowUSD!=null){ if(stableInflowUSD>500_000_000) bonus+=3; if(stableInflowUSD<-200_000_000) penalty+=3; }
        if(etfInflowUSD!=null){ if(etfInflowUSD>100_000_000) bonus+=5; if(etfInflowUSD<0) penalty+=5; }
        const accuracy=Math.max(50,Math.min(98,100-penalty+bonus));

        const dir=trend==='상승'?+1:trend==='하락'?-1:0;
        let entry=price-dir*0.25*atr;
        let tp1=entry+dir*0.75*atr;
        let tp2=entry+dir*1.50*atr;
        let sl=entry-dir*0.75*atr;

        if(kimchi>5&&dir>0){ entry-=0.15*atr; tp1-=0.05*atr; tp2-=0.10*atr; }
        if(kimchi<-3&&dir<0){ entry+=0.15*atr; tp1+=0.05*atr; tp2+=0.10*atr; }
        if(Math.abs(funding)>0.05){ sl=entry-dir*0.9*atr; }
        if(obi>1.2&&dir>0){ entry+=0.10*atr; }
        if(obi<0.8&&dir<0){ entry-=0.10*atr; }

        if(stableInflowUSD!=null&&dir!==0){ if(stableInflowUSD>500_000_000){ tp1+=dir*0.05*atr; tp2+=dir*0.10*atr; } if(stableInflowUSD<-200_000_000){ tp1-=dir*0.05*atr; tp2-=dir*0.10*atr; } }
        if(etfInflowUSD!=null&&dir!==0){ if(etfInflowUSD>100_000_000){ tp1+=dir*0.05*atr; tp2+=dir*0.10*atr; } if(etfInflowUSD<0){ tp1-=dir*0.05*atr; tp2-=dir*0.10*atr; } }

        function krwTick(v){ const p=Math.abs(v); if(p>=2000000) return 1000; if(p>=1000000) return 500; if(p>=500000) return 100; if(p>=100000) return 50; if(p>=50000) return 10; if(p>=10000) return 5; if(p>=1000) return 1; if(p>=100) return 0.1; if(p>=10) return 0.01; if(p>=1) return 0.001; if(p>=0.1) return 0.0001; if(p>=0.01) return 0.00001; return 0.000001; }
        function roundTickKRW(v,mode){ const t=krwTick(v); const x=v/t; const y=mode<0?Math.floor(x):mode>0?Math.ceil(x):Math.round(x); return Number((y*t).toFixed(6)); }
        const entryK=dir>0?roundTickKRW(entry*usdkrw,-1):dir<0?roundTickKRW(entry*usdkrw,+1):roundTickKRW(entry*usdkrw,0);
        const tp1K=dir>0?roundTickKRW(tp1*usdkrw,+1):dir<0?roundTickKRW(tp1*usdkrw,-1):roundTickKRW(tp1*usdkrw,0);
        const tp2K=dir>0?roundTickKRW(tp2*usdkrw,+1):dir<0?roundTickKRW(tp2*usdkrw,-1):roundTickKRW(tp2*usdkrw,0);
        const slK=dir>0?roundTickKRW(sl*usdkrw,-1):dir<0?roundTickKRW(sl*usdkrw,+1):roundTickKRW(sl*usdkrw,0);

        const fmt=v=>Number(v).toFixed(2);
        const krw=v=>'₩ '+Math.round(v).toLocaleString('ko-KR');
        document.querySelector('#anaBox').style.display='block';
        document.querySelector('#anaSignal').textContent='신호: '+(dir>0?'롱(매수)':'숏(매도)');
        document.querySelector('#anaAccuracy').textContent='정확도: '+accuracy.toFixed(1)+'%';
        document.querySelector('#anaRisk').textContent='위험도: '+(accuracy>80?'낮음':accuracy>70?'보통':'높음');
        document.querySelector('#anaOBI').textContent='호가 불균형: '+obi.toFixed(2);
        // 업비트 24h 등락률 (정확 표기)
        try{ const diff=(upbit[0].signed_change_rate*100).toFixed(2); document.querySelector('#anaChange').textContent='24h 등락: '+(diff>0?'+':'')+diff+'%'; }catch(_){}
        document.querySelector('#anaStable').textContent='스테이블 유입: '+(stableInflowUSD==null?'N/A':(stableInflowUSD>0?'+':'')+(stableInflowUSD/1_000_000).toFixed(0)+'M$');
        document.querySelector('#anaETF').textContent='ETF 유입: '+(etfInflowUSD==null?'N/A':(etfInflowUSD>0?'+':'')+(etfInflowUSD/1_000_000).toFixed(0)+'M$');
        document.querySelector('#anaEntryU').textContent=fmt(entry);
        document.querySelector('#anaTP1U').textContent=fmt(tp1);
        document.querySelector('#anaTP2U').textContent=fmt(tp2);
        document.querySelector('#anaSLU').textContent=fmt(sl);
        document.querySelector('#anaEntryK').innerHTML=krw(entryK);
        document.querySelector('#anaTP1K').innerHTML=krw(tp1K);
        document.querySelector('#anaTP2K').innerHTML=krw(tp2K);
        document.querySelector('#anaSLK').innerHTML=krw(slK);
        document.querySelector('#anaWhy').textContent=`근거: 추세(${trend}) · ATR ${atr.toFixed(2)} · 김프 ${(kimchi>=0?'+':'')}${kimchi.toFixed(2)}% · 펀딩 ${(funding>=0?'+':'')}${funding.toFixed(4)}% · OBI ${obi.toFixed(2)} · Stable ${(stableInflowUSD==null?'N/A':((stableInflowUSD>0?'+':'')+(stableInflowUSD/1_000_000).toFixed(0)+'M$'))} · ETF ${(etfInflowUSD==null?'N/A':((etfInflowUSD>0?'+':'')+(etfInflowUSD/1_000_000).toFixed(0)+'M$'))}`;
      }catch(e){console.error(e);}
    }

    document.querySelector('#btnAnalyze').onclick=analyzeScenario;
    // ⏱ 1분 자동 새로고침 (분석 + 표 갱신)
    analyzeScenario();
    setInterval(()=>{ try{ analyzeScenario(); }catch(e){} try{ updateTF(); }catch(e){} }, 60_000);
  </script>
</body>
</html>
