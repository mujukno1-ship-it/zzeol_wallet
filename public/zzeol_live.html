<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1117; --card:#151b23; --text:#e6edf3; --muted:#9fb0c0;
      --accent:#74c0fc; --good:#2ecc71; --bad:#ff6b6b; --warn:#ffd43b;
      --line:#293241;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand{font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--muted);font-size:12px}
    .status{margin-left:auto;color:#6ef3a3}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    .row{display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--line)}
    .row:first-of-type{border-top:0}
    .pill{display:inline-block;padding:2px 8px;border-radius:10px;background:#0f1720;color:var(--muted);font-size:12px;border:1px solid var(--line)}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    input[type="text"]{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:#0f1720;color:var(--text);font-size:18px}
    input::placeholder{color:#708197}
    button{cursor:pointer;background:transparent;color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:10px}
    button:hover{background:#0f1720}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-top:1px solid var(--line);text-align:left}
    tbody tr:hover{background:#0f1720;cursor:pointer}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px}
    .k{text-align:left;color:var(--muted)}
    .v{text-align:right}
    ul.dots{margin:0;padding-left:16px}
    ul.dots li{margin:2px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">ì©”ì–´ì§€ê°‘ ğŸ”¥</div>
    <span class="badge">v10.4</span>
    <span class="badge">Upbit KRW ì‹¤ì‹œê°„</span>
    <span id="ws-status" class="status badge">ìƒíƒœ: ì—°ê²° ì¤€ë¹„</span>
  </div>

  <div class="grid">
    <!-- ì¢Œ: ê²€ìƒ‰/ìœ ë™ì„±/ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  -->
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="q" type="text" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ETH, SOL, ì‹œë°”ì´ëˆ„ ë“± (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ ì…ë ¥)"/>
        <button id="btn-refresh">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="muted" style="margin-top:8px">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·ì‹ í˜¸ ì¦‰ì‹œ ê°±ì‹ .</div>
    </div>

    <div class="card">
      <div class="title">ì„ íƒ ì½”ì¸</div>
      <div class="kvs">
        <div class="k">ì´ë¦„</div><div id="sel-name" class="v muted">-</div>
        <div class="k">ì‹¬ë³¼</div><div id="sel-symbol" class="v muted">-</div>
        <div class="k">í˜„ì¬ê°€</div><div id="sel-price" class="v">-</div>
        <div class="k">ë“±ë½ë¥ (24h)</div><div id="sel-change" class="v">-</div>
        <div class="k">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="sel-vol24" class="v">-</div>
        <div class="k">í‹± ì²´ê°ê°•ë„</div><div id="sel-tick" class="v">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">ìœ ë™ì„±Â·ë³€ë™ì„±</div>
      <div class="kvs">
        <div class="k">EMA20</div><div id="ema20" class="v muted">-</div>
        <div class="k">ATR(14)</div><div id="atr14" class="v muted">-</div>
        <div class="k">EMA ê¸°ìš¸ê¸°</div><div id="emaSlope" class="v muted">-</div>
        <div class="k">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="blk" class="v warn muted">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””</div>
      <div class="kvs">
        <div class="k">ì†ì ˆ</div><div id="risk-stop" class="v">-</div>
        <div class="k">ìœ„í—˜ë„</div><div id="risk-score" class="v">-</div>
        <div class="k">ì©”ì–´í•œë§ˆë””</div><div id="quip" class="v">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">ë§¤ìˆ˜ íƒ€ì </div>
      <ul id="buy-ul" class="dots">
        <li>â€¢ -</li><li>â€¢ -</li><li>â€¢ -</li>
      </ul>
      <div class="muted" style="margin-top:8px">ê¸°ë³¸ ë£°: EMA20 ê·¼ì²˜ ëˆŒë¦¼ + ATR ê¸°ë°˜ ë¶„í• ì§„ì….</div>
    </div>

    <div class="card">
      <div class="title">ë§¤ë„(ìµì ˆ) íƒ€ì </div>
      <ul id="sell-ul" class="dots">
        <li>â€¢ -</li><li>â€¢ -</li><li>â€¢ -</li>
      </ul>
      <div class="muted" style="margin-top:8px">ê¸°ë³¸ ë£°: í˜„ì¬ê°€ ê¸°ì¤€ ATRÃ—(1.0, 1.6, 2.2) ëª©í‘œ.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="title">KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</div>
    <table id="tbl">
      <thead><tr>
        <th style="width:90px">ì‹¬ë³¼</th>
        <th>ì½”ì¸ëª…(í•œê¸€)</th>
        <th style="width:140px">í˜„ì¬ê°€</th>
        <th style="width:100px">ë“±ë½ë¥ </th>
        <th style="width:180px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ======================= í™˜ê²½ì„¤ì • ======================= */
const API_BASE = '/upbit';  // â† í”„ë¡ì‹œ ê²½ë¡œ(ë‹¤ë¥´ë©´ ì´ ì¤„ë§Œ ìˆ˜ì •)

/* ======================= ìœ í‹¸ ======================= */
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function fmtKRW(n){
  if(n==null || isNaN(n)) return '-';
  const v = Number(n);
  if (v >= 100) return Math.round(v).toLocaleString() + 'ì›';
  if (v >= 1)   return v.toFixed(2).toLocaleString() + 'ì›';
  // 1ì› ë¯¸ë§Œ: ì†Œìˆ˜ 8ìë¦¬ê¹Œì§€, ë’¤ 0 ì œê±°
  let s = v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
  return s + 'ì›';
}
const pct = x => (Number(x)*100).toFixed(2) + '%';
const krw = x => Number(x??0).toLocaleString() + 'ì›';

function setText(id, val){
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function setBullets(ulId, arr){
  const ul = document.getElementById(ulId);
  if (!ul) return;
  const lis = ul.querySelectorAll('li');
  for(let i=0;i<3;i++){
    const v = arr[i] ?? '-';
    if(lis[i]) lis[i].textContent = 'â€¢ ' + v;
  }
}

/* ============ ê°„ë‹¨ íƒ€ì /ë¦¬ìŠ¤í¬ (EMA/ATR ì—†ì´ë„ ë™ì‘) ============ */
function calcTargets(price){
  const p = Number(price);
  const buys  = [0.985, 0.97, 0.955].map(m => fmtKRW(Math.max(p*m,0)));
  const sells = [1.01, 1.02, 1.03].map(m => fmtKRW(p*m));
  return {buys, sells};
}
function calcRisk(price, vol24){
  let score = 0.7;
  if (Number(vol24) > 1e11) score += 0.6; // 1000ì–µì›+
  if (Number(price) < 1)    score += 0.4; // 1ì› ë¯¸ë§Œ
  if (score > 5) score = 5;
  const oneLiner = score < 1.2 ? 'ì•ˆì • êµ¬ê°„(ë¶„í• ë§¤ìˆ˜ ìœ ë¦¬)'
                 : score < 2.2 ? 'ì¤‘ë¦½ êµ¬ê°„(ì¶”ì„¸ í™•ì¸)'
                 : 'ê³ ìœ„í—˜ êµ¬ê°„ â€” ì†ì ˆì—„ìˆ˜';
  return {score: score.toFixed(1)+' / 5.0', stop: 'ìµœê·¼ ì €ì  ì´íƒˆì‹œ', oneLiner};
}

/* ======================= API ======================= */
async function getMarkets(){
  const r = await fetch(`${API_BASE}/market/all?isDetails=true`);
  if(!r.ok) throw new Error('markets '+r.status);
  return r.json();
}
async function getTicker(market){ // market: KRW-BTC
  const r = await fetch(`${API_BASE}/ticker?markets=${market}`);
  if(!r.ok) throw new Error('ticker '+r.status);
  const j = await r.json();
  return j && j[0];
}

/* ======================= ëª©ë¡/ì„ íƒ ì±„ìš°ê¸° ======================= */
let KRW_LIST = [];

async function fillTable(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '<tr><td colspan="5" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>';
  let mk;
  try{
    mk = await getMarkets();
  }catch(e){
    tb.innerHTML = `<tr><td colspan="5" class="muted">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨. ì ì‹œ í›„ ìë™ ì¬ì‹œë„ (${e})</td></tr>`;
    await sleep(2500); return fillTable();
  }
  KRW_LIST = mk.filter(m => m.market.startsWith('KRW-'));
  // ìƒìœ„ 60ê°œë§Œ ìš°ì„  í‘œì‹œ(ì„±ëŠ¥/ì¿¼í„° ë³´í˜¸)
  const list = KRW_LIST.slice(0, 60);

  const rows = await Promise.all(list.map(async m=>{
    try{
      const t = await getTicker(m.market);
      const price = fmtKRW(t.trade_price);
      const change = t.signed_change_rate>=0 ? `<span class="good">${pct(t.signed_change_rate)}</span>` 
                                             : `<span class="bad">${pct(t.signed_change_rate)}</span>`;
      const vol = krw(t.acc_trade_price_24h);
      return `<tr data-market="${m.market}" data-korean="${m.korean_name}">
        <td>${m.market.replace('KRW-','')}</td>
        <td>${m.korean_name}</td>
        <td>${price}</td>
        <td>${change}</td>
        <td>${vol}</td>
      </tr>`;
    }catch{
      // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ í–‰
      return `<tr data-market="${m.market}" data-korean="${m.korean_name}">
        <td>${m.market.replace('KRW-','')}</td>
        <td>${m.korean_name}</td>
        <td>0ì›</td>
        <td>-</td>
        <td>-</td>
      </tr>`;
    }
  }));
  tb.innerHTML = rows.join('');

  // í–‰ í´ë¦­ â†’ ìš°ì¸¡ íŒ¨ë„ ì±„ìš°ê¸°
  tb.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const sym = tr.dataset.market;
      selectSymbol(sym);
    });
  });
}

async function selectSymbol(marketOrSym){
  const market = marketOrSym.startsWith('KRW-') ? marketOrSym : ('KRW-'+marketOrSym.toUpperCase());
  // ì´ë¦„ ì°¾ì•„ë‘ê¸°
  const found = KRW_LIST.find(x=>x.market===market);
  setText('sel-name', found ? found.korean_name : '-');
  setText('sel-symbol', market.replace('KRW-',''));

  try{
    const t = await getTicker(market);
    const price = t.trade_price;
    setText('sel-price', fmtKRW(price));
    const ch = pct(t.signed_change_rate);
    document.getElementById('sel-change').innerHTML = (t.signed_change_rate>=0?`<span class="good">${ch}</span>`:`<span class="bad">${ch}</span>`);
    setText('sel-vol24', krw(t.acc_trade_price_24h));
    setText('sel-tick', (t.signed_change_price ? Math.round(t.signed_change_price) : 0) + ' (ê°€ì¤‘)');

    // íƒ€ì /ë¦¬ìŠ¤í¬
    const tg = calcTargets(price);
    setBullets('buy-ul', tg.buys);
    setBullets('sell-ul', tg.sells);
    const risk = calcRisk(price, t.acc_trade_price_24h);
    setText('risk-stop',  risk.stop);
    setText('risk-score', risk.score);
    setText('quip',       risk.oneLiner);
  }catch(e){
    setText('sel-price','-'); setText('sel-change','-'); setText('sel-vol24','-'); setText('sel-tick','-');
    setBullets('buy-ul',['-','-','-']); setBullets('sell-ul',['-','-','-']);
    setText('risk-stop','-'); setText('risk-score','-'); setText('quip','-');
  }
}

/* ======================= ë°”ì¸ë”©/ì‹œì‘ ======================= */
document.getElementById('btn-refresh').addEventListener('click', fillTable);
document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const v = e.target.value.trim();
    if(!v) return;
    // í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ ëª¨ë‘ í—ˆìš©
    // ì‹¬ë³¼ì´ ì•„ë‹ˆë©´ í•œêµ­ì–´ ì´ë¦„ì—ì„œ ë§¤ì¹­
    const exact = KRW_LIST.find(x=>x.market==='KRW-'+v.toUpperCase());
    if (exact) return selectSymbol(exact.market);
    const byKo = KRW_LIST.find(x=>x.korean_name.replace(/\s/g,'')===v.replace(/\s/g,''));
    if (byKo)   return selectSymbol(byKo.market);
    // ëª¨ë¥´ë©´ ì¼ë‹¨ ì…ë ¥ì„ ì‹¬ë³¼ë¡œ ì‹œë„
    selectSymbol(v);
  }
});

// ì‹œì‘ ë£¨í‹´
(async function boot(){
  setText('ws-status','ìƒíƒœ: ì—°ê²° ì¤‘â€¦');
  await fillTable();
  setText('ws-status','ìƒíƒœ: ì •ìƒ ì—°ê²°');
  // 0ì› êµì •/ê°±ì‹ ì„ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ í…Œì´ë¸” ì¼ë¶€ ê°±ì‹ (ë¶€í•˜ ê³¼í•˜ì§€ ì•Šê²Œ)
  setInterval(fillTable, 60_000);
})();
</script>
</body>
</html>
