<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ Mini â€” ê°€ë¡œí˜• íƒ€ì /ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b1117;--card:#121826;--txt:#e6edf3;--mut:#9fb0c0;--line:#243044;
    --up:#25d695;--dn:#ff6b6b;--chip:#1a2333;--soft:#0e1522;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .title{font-weight:800;margin-bottom:8px}
  .mut{color:var(--mut)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .searchbar{display:grid;grid-template-columns:1fr auto;gap:8px}
  input[type="text"]{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:var(--soft);color:var(--txt);font-size:18px}
  button{border:1px solid var(--line);background:var(--chip);color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid var(--line);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  tr:hover{background:#0f1827;cursor:pointer}
  .good{color:var(--up)} .bad{color:var(--dn)}
  .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);color:var(--mut);font-size:12px}

  /* âœ… ê°€ë¡œí˜• ì¸í¬ë°” */
  .infobar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  .ibox{background:#0e1522;border:1px solid var(--line);border-radius:10px;padding:12px}
  .ibox .k{color:var(--mut);font-size:12px;margin-bottom:6px}
  .ibox .v{font-size:15px}
  @media (max-width:760px){ .infobar{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’ ì©”ì–´ì§€ê°‘ Mini</h1>

  <!-- ğŸ” ê²€ìƒ‰ -->
  <div class="card">
    <div class="title">ì½”ì¸ ê²€ìƒ‰</div>
    <div class="searchbar">
      <input id="q" type="text" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ â€” ì˜ˆ: ë¹„íŠ¸ì½”ì¸, SHIB, ETHâ€¦" />
      <button id="btnReload">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="mut" style="margin-top:6px">ì—”í„° â†’ ì²« ê²°ê³¼ë¥¼ ìë™ ì„ íƒí•©ë‹ˆë‹¤.</div>
  </div>

  <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ (ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜) -->
  <div class="card" id="searchCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="title">ê²€ìƒ‰ ê²°ê³¼</div>
      <span id="srCount" class="pill">0ê°œ</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…</th>
          <th style="width:120px">í˜„ì¬ê°€</th>
          <th style="width:90px">ë“±ë½ë¥ </th>
          <th style="width:160px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
        </tr>
      </thead>
      <tbody id="srBody"></tbody>
    </table>
  </div>

  <!-- ğŸš€ ì‹¤ì‹œê°„ ê¸‰ë“±ì½”ì¸ -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="title">ì‹¤ì‹œê°„ ê¸‰ë“±ì½”ì¸</div>
      <div class="row"><span class="pill" id="crit">ê¸°ì¤€: 5ë¶„ +3%â†‘ ë˜ëŠ” ìƒìœ„ ê±°ë˜ëŒ€ê¸ˆ</span><button id="btnPump">ê°±ì‹ </button></div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…</th>
          <th style="width:120px">í˜„ì¬ê°€</th>
          <th style="width:90px">ë“±ë½ë¥ </th>
          <th style="width:160px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
          <th style="width:80px">íƒœê·¸</th>
        </tr>
      </thead>
      <tbody id="pumpBody"></tbody>
    </table>
    <div class="mut" style="margin-top:6px">ìƒìœ„ 10ê°œ í‘œì‹œ Â· 60ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </div>
  </div>

  <!-- âœ… ê°€ë¡œí˜•: ë§¤ìˆ˜ Â· ë§¤ë„ Â· ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë”” -->
  <div class="card">
    <div class="title">ê°€ë¡œí˜• ë¶„ì„ ìš”ì•½</div>
    <div class="infobar">
      <div class="ibox">
        <div class="k">ğŸŸ¦ ë§¤ìˆ˜ íƒ€ì </div>
        <div class="v" id="buyBox">-</div>
      </div>
      <div class="ibox">
        <div class="k">ğŸŸ¥ ë§¤ë„(ìµì ˆ) íƒ€ì </div>
        <div class="v" id="sellBox">-</div>
      </div>
      <div class="ibox">
        <div class="k">âš ï¸ ìœ„í—˜ë„</div>
        <div class="v" id="riskBox">-</div>
      </div>
      <div class="ibox">
        <div class="k">ğŸ’¬ ì©”ì–´í•œë§ˆë””</div>
        <div class="v" id="quipBox">-</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== ê²½ë¡œ ===== */
const API_BASES = [
  '/upbit', // í”„ë¡ì‹œ ìš°ì„ 
  'https://api.upbit.com/v1' // ì—†ìœ¼ë©´ ê³µì‹ API
];
function url(p){ return API_BASES[0] + p; }

/* ===== ìœ í‹¸ ===== */
const $ = s=>document.querySelector(s);
function fmtKRW(v){
  if (v==null || isNaN(v)) return '-';
  v = Number(v);
  if (v>=100) return Math.round(v).toLocaleString('ko-KR')+'ì›';
  if (v>=1)   return v.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})+'ì›';
  const s = v.toFixed(8).replace(/0+$/,'').replace(/\.$/,''); // 1ì› ë¯¸ë§Œ
  return s+'ì›';
}
const pct = r => {
  const x = Number(r)*100;
  const cls = x>0?'good':(x<0?'bad':'');
  return `<span class="${cls}">${x>0?'+':''}${x.toFixed(2)}%</span>`;
}
const shortVol = v=>{
  v = Number(v||0);
  if (v>=1e12) return (v/1e12).toFixed(2)+'ì¡°ì›';
  if (v>=1e8)  return (v/1e8).toFixed(1)+'ì–µì›';
  return Math.round(v).toLocaleString('ko-KR')+'ì›';
}

/* ===== ë°ì´í„° ===== */
let KRW=[], TICK={};
async function getMarkets(){
  const r = await fetch(url('/market/all?isDetails=true')); if(!r.ok) throw 0;
  const j = await r.json(); return j.filter(x=>x.market.startsWith('KRW-'));
}
async function getTicker(markets){
  const r = await fetch(url('/ticker?markets='+encodeURIComponent(markets.join(',')))); if(!r.ok) throw 0;
  return r.json();
}
async function getCandles(unit, market, count=60){
  const r = await fetch(url(`/candles/minutes/${unit}?market=${market}&count=${count}`)); if(!r.ok) throw 0;
  return r.json();
}

/* ===== ì§€í‘œ ===== */
function ema(arr, p){ const k=2/(p+1); let e=arr[0]; for(let i=1;i<arr.length;i++){ e=arr[i]*k+e*(1-k); } return e; }
function atr(candles, p=14){
  const trs=[];
  for(let i=0;i<candles.length;i++){
    const c=candles[i], prev=candles[i+1]||c;
    const tr=Math.max(
      c.high_price-c.low_price,
      Math.abs(c.high_price-prev.trade_price),
      Math.abs(c.low_price-prev.trade_price)
    );
    trs.push(tr);
  }
  trs.reverse();
  return ema(trs,p);
}
function slope(vals){ if(vals.length<2) return 0; const a=vals[0], b=vals[vals.length-1]; return (b-a)/Math.max(1e-9,a); }

/* ===== ì‹ í˜¸ ===== */
function buyPoints(price, ema20, atr14){
  const arr=[];
  if (price<=ema20 && (ema20-price)<=atr14*0.6) arr.push(`EMA20 ëˆŒë¦¼`);
  if (price< ema20 && (ema20-price)<=atr14*1.2) arr.push(`ë¶„í• (1/2)`);
  if (!arr.length) arr.push(`ëŒ€ê¸°`);
  // ê°€ê²© ìˆ«ìë„ ê³ë“¤ì„
  const p1 = Math.max(price - atr14*0.6, 0);
  const p2 = Math.max(price - atr14*1.2, 0);
  return `${arr.join(' Â· ')} | ${fmtKRW(p1)} / ${fmtKRW(p2)}`;
}
function sellPoints(price, atr14){
  const tp1 = price + atr14*1.0;
  const tp2 = price + atr14*1.6;
  const tp3 = price + atr14*2.2;
  return `${fmtKRW(tp1)} / ${fmtKRW(tp2)} / ${fmtKRW(tp3)}`;
}
function riskScore(price, chgPct, emaSlope){
  let r=1.2;
  if (price<1) r+=0.7;
  if (Math.abs(chgPct)>5) r+=0.8;
  r += Math.min(2, Math.abs(emaSlope)*50);
  r = Math.max(0, Math.min(5,r));
  return r.toFixed(1)+' / 5.0';
}
function oneLiner(price, chgPct, emaSlope, ema20){
  if (price<1 && chgPct>2 && emaSlope>0) return 'ë‹¨íƒ€ ë§¤ìˆ˜(ì†Œì•¡)';
  if (emaSlope>0.004 && price>ema20) return 'ìƒìŠ¹ ì¶”ì„¸ ì¶”ì¢…, ë¶„í•  ë§¤ìˆ˜';
  if (emaSlope<-0.004 && price<ema20) return 'í•˜ë½ ì¶”ì„¸, ë°˜ë“± ë§¤ë„/í˜„ê¸ˆ';
  if (Math.abs(chgPct)<0.5) return 'íš¡ë³´ êµ¬ê°„, ê´€ë§';
  return 'ì¤‘ë¦½ â€” ëˆŒë¦¼ ëŒ€ê¸°';
}

/* ===== ì´ˆê¸°í™” ===== */
(async function init(){
  try{
    KRW = await getMarkets();
    await refreshTickers();
    bindUI();
    renderSearch();      // ì²˜ìŒì—” ë¹„ì›Œë‘ 
    await renderPump();  // ê¸‰ë“± ì´ˆê¸°
    setInterval(refreshTickers, 30_000);
    setInterval(renderPump, 60_000);
  }catch(e){
    console.error(e); alert('ì—°ê²° ì‹¤íŒ¨: ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
  }
})();

async function refreshTickers(){
  const mk = KRW.map(x=>x.market);
  for(let i=0;i<mk.length;i+=100){
    const chunk = mk.slice(i,i+100);
    const arr = await getTicker(chunk);
    for(const t of arr) TICK[t.market]=t;
    await new Promise(r=>setTimeout(r,120));
  }
}

function bindUI(){
  $('#q').addEventListener('input', renderSearch);
  $('#q').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const first = $('#srBody tr');
      if(first) first.click();
    }
  });
  $('#btnReload').addEventListener('click', async ()=>{
    KRW = await getMarkets();
    await refreshTickers();
    renderSearch(); renderPump();
  });
  $('#btnPump').addEventListener('click', renderPump);
}

/* ===== ê²€ìƒ‰ ê²°ê³¼ ===== */
function renderSearch(){
  const q = ($('#q').value||'').trim().toLowerCase();
  const card = $('#searchCard'), body = $('#srBody');
  if(!q){ card.style.display='none'; body.innerHTML=''; $('#srCount').textContent='0ê°œ'; return; }
  const list=[];
  for(const it of KRW){
    const sym = it.market.replace('KRW-',''), ko = it.korean_name.toLowerCase(), en=(it.english_name||'').toLowerCase();
    if (sym.toLowerCase().includes(q) || ko.includes(q) || en.includes(q)){
      const t = TICK[it.market]; if(!t) continue;
      list.push({it,t});
    }
  }
  list.sort((a,b)=>(b.t.acc_trade_price_24h||0)-(a.t.acc_trade_price_24h||0));
  body.innerHTML = list.map(({it,t})=>`
    <tr data-m="${it.market}">
      <td><b>${it.market.replace('KRW-','')}</b></td>
      <td>${it.korean_name}</td>
      <td>${fmtKRW(t.trade_price||0)}</td>
      <td>${pct(t.signed_change_rate||0)}</td>
      <td>${shortVol(t.acc_trade_price_24h||0)}</td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="mut">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
  $('#srCount').textContent = list.length+'ê°œ';
  card.style.display='block';
  [...body.querySelectorAll('tr')].forEach(tr=> tr.onclick=()=>select(tr.dataset.m));
}

/* ===== ê¸‰ë“± ===== */
async function renderPump(){
  const body = $('#pumpBody');
  const scored=[];
  for(const it of KRW){
    const m=it.market, t=TICK[m]; if(!t) continue;
    let ch5=0;
    try{
      const cs=await getCandles(5,m,2);
      if(cs.length>=2){ const a=cs[1].trade_price, b=cs[0].trade_price; ch5=((a-b)/b)*100; }
    }catch(_){}
    const ch24=(t.signed_change_rate||0)*100, vol=t.acc_trade_price_24h||0;
    let score=0; if(ch5>=3) score+=100; score+=Math.max(0,ch24); score+=Math.log10(Math.max(1,vol));
    scored.push({it,t,score});
    await new Promise(r=>setTimeout(r,6));
  }
  scored.sort((a,b)=>b.score-a.score);
  const top=scored.slice(0,10);
  body.innerHTML = top.map(({it,t})=>`
    <tr data-m="${it.market}">
      <td><b>${it.market.replace('KRW-','')}</b></td>
      <td>${it.korean_name}</td>
      <td>${fmtKRW(t.trade_price||0)}</td>
      <td>${pct(t.signed_change_rate||0)}</td>
      <td>${shortVol(t.acc_trade_price_24h||0)}</td>
      <td><span class="pill">ê¸‰ë“±</span></td>
    </tr>`).join('') || `<tr><td colspan="6" class="mut">ê¸‰ë“± ì½”ì¸ ì—†ìŒ</td></tr>`;
  [...body.querySelectorAll('tr')].forEach(tr=> tr.onclick=()=>select(tr.dataset.m));
}

/* ===== ì„ íƒ ì‹œ: ê°€ë¡œí˜• ë°” ì±„ìš°ê¸° ===== */
async function select(market){
  try{
    // ìµœì‹  í‹°ì»¤ ì¬ë³´ì •
    const t = (await getTicker([market]))[0];
    const price = Number(t.trade_price||0);
    const chgPct = (t.signed_change_rate||0)*100;

    // ìº”ë“¤ â†’ EMA/ATR
    const cs = await getCandles(5, market, 80);
    const prices = cs.map(c=>c.trade_price).reverse();
    const ema20 = ema(prices, 20);
    const atr14 = atr(cs, 14);
    const emaSlope = slope(prices.slice(-20));

    // ê°€ë¡œí˜• 4ì¹¸ ì±„ìš°ê¸°
    $('#buyBox').innerHTML  = buyPoints(price, ema20, atr14);
    $('#sellBox').innerHTML = sellPoints(price, atr14);
    $('#riskBox').textContent = riskScore(price, chgPct, emaSlope);
    $('#quipBox').textContent = oneLiner(price, chgPct, emaSlope, ema20);
  }catch(e){
    console.error(e);
    $('#buyBox').textContent='-';
    $('#sellBox').textContent='-';
    $('#riskBox').textContent='-';
    $('#quipBox').textContent='ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨';
  }
}
</script>
</body>
</html>
