<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.3.1 â€” Upbit KRW ì‹¤ì‹œê°„ (ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì /ìœ„í—˜ë„/ì©”ì–´ í•œë§ˆë””)</title>
<meta name="color-scheme" content="dark" />
<style>
:root{
  --bg:#0d1117; --card:#161b22; --line:#30363d; --text:#c9d1d9; --muted:#8b949e; --accent:#58a6ff;
  --good:#3fb950; --bad:#ff7b72; --warn:#f0883e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.row{display:grid;gap:12px}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.grid-4{grid-template-columns:repeat(4,1fr)}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
h1{display:flex;align-items:center;gap:10px;margin:0 0 10px;font-size:18px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted)}
select, input, button{background:var(--bg);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 10px}
button{cursor:pointer}
.tag{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:8px;padding:4px 8px;background:rgba(88,166,255,.08)}
.small{font-size:12px;color:var(--muted)}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px}
.kv div:nth-child(odd){color:var(--muted)}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.table th,.table td{border-top:1px solid var(--line);padding:10px 8px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table tr:hover{background:#0f141b}
.up{color:var(--good)} .down{color:var(--bad)} .flat{color:var(--muted)}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
.status{padding:8px 10px;border-radius:10px}
.ok{background:rgba(63,185,80,.12);border:1px solid rgba(63,185,80,.35)}
.err{background:rgba(255,123,114,.12);border:1px solid rgba(255,123,114,.35)}
.warn{background:rgba(240,136,62,.12);border:1px solid rgba(240,136,62,.35)}
.hr{height:1px;background:var(--line);margin:8px 0}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
footer{opacity:.7;margin:24px 0}
</style>
</head>
<body>
<div class="container">

  <h1>
    ì©”ì–´ì§€ê°‘ ğŸ”¥ <span class="badge">v10.3.1</span>
    <span id="conn" class="status warn small">ìƒíƒœ: ì´ˆê¸° ë¡œë“œ ì¤‘â€¦</span>
    <span class="right small code">/public/zzeol_live.html</span>
  </h1>

  <div class="flex">
    <div class="tag">ë¶„ë´‰
      <select id="tf" style="margin-left:6px">
        <option value="1">1ë¶„</option><option value="3">3ë¶„</option>
        <option value="5" selected>5ë¶„</option><option value="10">10ë¶„</option>
        <option value="15">15ë¶„</option><option value="30">30ë¶„</option>
        <option value="60">60ë¶„</option>
      </select>
    </div>
    <div class="tag">ìƒí•œ: 
      <select id="limit" style="margin-left:6px">
        <option value="80">80ê°œ</option>
        <option value="120" selected>120ê°œ</option>
        <option value="200">200ê°œ</option>
      </select>
    </div>
    <div class="right flex">
      <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼)" />
      <button id="reset">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="row grid-3" style="margin-top:10px">
    <div class="card">
      <div class="small" style="margin-bottom:6px">ì„ íƒ ì½”ì¸</div>
      <div class="kv small">
        <div>ì‹¬ë³¼ / í•œê¸€ëª…</div><div id="sel_name">-</div>
        <div>í˜„ì¬ê°€ (KRW)</div><div id="sel_price">-</div>
        <div>ë“±ë½ë¥ (24h)</div><div id="sel_chg">-</div>
        <div>ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="sel_vol">-</div>
        <div>í‹± ì²´ê²°ê°•ë„</div><div id="sel_tick">-</div>
        <div>ìœ ë™ì„±/ë³€ë™ì„±</div><div id="sel_vola">-</div>
        <div>ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="sel_black">-</div>
      </div>
    </div>
    <div class="card">
      <div class="small" style="margin-bottom:6px">ë§¤ìˆ˜ íƒ€ì </div>
      <div id="buy_points" class="small">-</div>
      <div class="hr"></div>
      <div class="small">ë©”ëª¨</div>
      <div id="buy_note" class="small muted">EMA20 ìƒìŠ¹ + ê±°ë˜ëŸ‰â†‘ + ì²´ê²°ê°•ë„â†‘ì¼ ë•Œ ìœ íš¨</div>
    </div>
    <div class="card">
      <div class="small" style="margin-bottom:6px">ë§¤ë„(ìµì ˆ/ì†ì ˆ) íƒ€ì </div>
      <div id="sell_points" class="small">-</div>
      <div class="hr"></div>
      <div class="small">ì†ì ˆ Â· ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      <div id="risk_line" class="small">ì†ì ˆ: - / ìœ„í—˜ë„: -</div>
      <div id="one_liner" class="small" style="margin-top:6px">-</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th style="width:90px">ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…(í•œê¸€)</th>
          <th style="width:100px">í˜„ì¬ê°€</th>
          <th style="width:90px">ë“±ë½ë¥ </th>
          <th style="width:120px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small" style="margin-top:6px">í–‰ í´ë¦­ ì‹œ ìƒë‹¨ íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” ì¦‰ì‹œ ê°±ì‹ .</div>
  </div>

  <footer class="small">
    Â© 2025 ì©”ì–´ì§€ê°‘ â€” Upbit KRW ì‹¤ì‹œê°„ | ë°ì´í„°: <span class="code">api.upbit.com</span> | ì•ˆì „í•œ ì¤‘ë³µìš”ì²­ ì°¨ë‹¨/ë ˆì´íŠ¸ë¦¬ë°‹ ëŒ€ì‘ ì ìš©
  </footer>
</div>

<script>
/* =========================
   ê°„ë‹¨ ìœ í‹¸
========================= */
const $ = sel => document.querySelector(sel);
const fmt = n => (n===null||n===undefined||Number.isNaN(n)) ? '-' :
  Intl.NumberFormat('ko-KR',{maximumFractionDigits: n<1?4:2}).format(n);
const pct = n => (n===null||n===undefined) ? '-' :
  (n>0?'<span class="up">+':'<span class="down">')+n.toFixed(2)+'%</span>';
const KRW = v => v<1 ? fmt(v) : fmt(v);

/* =========================
   ìƒíƒœ í‘œì‹œ/ìš”ì²­ ì œì–´
========================= */
const connEl = $('#conn');
let polling=null;
let inFlight = new Map(); // key -> AbortController

function setStatus(ok,msg){
  connEl.className='status small '+(ok?'ok':(msg.includes('ì´ˆê¸°')?'warn':'err'));
  connEl.textContent='ìƒíƒœ: '+msg;
}
function safeFetch(key, url){
  // ì¤‘ë³µ ìš”ì²­ ë°©ì§€ + ì´ì „ ìš”ì²­ ì·¨ì†Œ(ë ˆì´íŠ¸ë¦¬ë°‹ ë³´í˜¸)
  try{ if(inFlight.has(key)) inFlight.get(key).abort(); }catch(e){}
  const c = new AbortController(); inFlight.set(key,c);
  return fetch(url,{signal:c.signal}).finally(()=> inFlight.delete(key));
}

/* =========================
   Upbit Endpoints (ì§ì ‘ í˜¸ì¶œ)
========================= */
const EP = {
  markets : `https://api.upbit.com/v1/market/all?isDetails=true`,
  ticker  : (codes) => `https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
  candleM : (mkt, min, cnt=200) => `https://api.upbit.com/v1/candles/minutes/${min}?market=${mkt}&count=${cnt}`
};

/* =========================
   ë°ì´í„° ì ì¬
========================= */
let ALL=[]; // [{market, korean_name, english_name}]
let ROWS=[]; // ê°€ì‹œ ëª©ë¡
let SELECTED=null; // 'KRW-BTC' ê°™ì€ ë¬¸ìì—´
let TF = parseInt($('#tf').value,10); // ë¶„ë´‰

async function loadMarkets(){
  const r = await safeFetch('mk', EP.markets);
  if(!r.ok) throw new Error('ë§ˆì¼“ ëª©ë¡ ì‹¤íŒ¨');
  const js = await r.json();
  ALL = js.filter(x=>x.market.startsWith('KRW-'));
}

async function loadTickers(list){
  if(list.length===0) return [];
  const chunk = (arr,n)=>arr.reduce((a,_,i)=> (i%n? a[a.length-1].push(arr[i]) : a.push([arr[i]]), a), []);
  const packs = chunk(list, 90); // Upbit í•œ ë²ˆì— ë„ˆë¬´ ë§ì´ ë¶€ë¥´ë©´ 414 ë  ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ë¶„í• 
  const out=[];
  for(const p of packs){
    const r = await safeFetch('tk'+p.length, EP.ticker(p));
    if(!r.ok) throw new Error('í‹°ì»¤ ì‹¤íŒ¨');
    out.push(...await r.json());
  }
  return out;
}

/* =========================
   í…Œì´ë¸” ë Œë”
========================= */
function renderTable(ticks){
  const q = $('#q').value.trim().toLowerCase();
  const cap = parseInt($('#limit').value,10);
  const tbody = $('#tbl tbody');
  tbody.innerHTML='';

  const map = new Map(ticks.map(x=>[x.market,x]));
  const rows = ALL
    .map(m=>{
      const t = map.get(m.market);
      const price = t?.trade_price ?? null;
      const chg = t ? (t.signed_change_rate*100) : null;
      const vol24 = t?.acc_trade_price_24h ?? null;
      return {m, price, chg, vol24};
    })
    .filter(r=>{
      if(!q) return true;
      const s = `${r.m.market} ${r.m.korean_name} ${r.m.english_name}`.toLowerCase();
      return s.includes(q);
    })
    .sort((a,b)=> (b.vol24??0)-(a.vol24??0))
    .slice(0,cap);

  ROWS = rows;

  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="code">${r.m.market.replace('KRW-','')}</td>
      <td>${r.m.korean_name}</td>
      <td>${r.price===null?'-':KRW(r.price)}</td>
      <td>${r.chg===null?'-':pct(r.chg)}</td>
      <td>${r.vol24===null?'-':fmt(r.vol24)}</td>
    `;
    tr.onclick = ()=> selectCoin(r.m.market, r);
    tbody.appendChild(tr);
  }
}

/* =========================
   ê°„ë‹¨ ì§€í‘œ
========================= */
function ema(arr, period){
  if(arr.length<period) return null;
  const k = 2/(period+1);
  let e = arr.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for(let i=period;i<arr.length;i++) e = arr[i]*k + e*(1-k);
  return e;
}
function rsi(closes, period=14){
  if(closes.length<=period) return null;
  let gains=0,loss=0;
  for(let i=1;i<=period;i++){
    const d=closes[i]-closes[i-1];
    if(d>=0) gains+=d; else loss-=d;
  }
  gains/=period; loss/=period;
  let rs = loss===0 ? 100 : gains/loss;
  let out = 100 - (100/(1+rs));
  for(let i=period+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    const g = d>0?d:0, l = d<0?-d:0;
    gains=(gains*(period-1)+g)/period;
    loss=(loss*(period-1)+l)/period;
    rs = loss===0 ? 100 : gains/loss;
    out = 100 - (100/(1+rs));
  }
  return out;
}
function stdev(arr){
  if(arr.length<2) return 0;
  const m = arr.reduce((a,b)=>a+b,0)/arr.length;
  const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/(arr.length-1);
  return Math.sqrt(v);
}

/* =========================
   íƒ€ì  ê³„ì‚° / ìœ„í—˜ë„ / í•œë§ˆë””
========================= */
function buildSignals(candles, lastTick){
  // candles: ìµœì‹ ì´ 0ë²ˆì§¸ (Upbit ë¶„ë´‰ ì‘ë‹µì€ ìµœì‹ ìˆœ)
  const closes = candles.map(c=>c.trade_price).slice().reverse();
  const highs  = candles.map(c=>c.high_price).slice().reverse();
  const lows   = candles.map(c=>c.low_price).slice().reverse();
  const vols   = candles.map(c=>c.candle_acc_trade_price).slice().reverse();

  const E20 = ema(closes,20);
  const E50 = ema(closes,50);
  const RSI = rsi(closes,14);
  const volStdev = stdev(closes.slice(-30));
  const price = lastTick?.trade_price ?? closes.at(-1);
  const tickStr = lastTick && (lastTick.trade_volume>0)
    ? ((lastTick.ask_bid==='BID'?1:-1) * (lastTick.trade_volume))*100 : 0; // ê°„ì´ í‘œí˜„

  // ë§¤ìˆ˜ ë£°: E20 > E50 & RSI 48~65 & ìµœê·¼ ê³ ì  ëŒíŒŒ ì‹œë„
  const hh = Math.max(...highs.slice(-20));
  const buy = [];
  if(E20 && E50 && E20>E50) buy.push('ğŸ“ˆ ì¶”ì„¸: EMA20 > EMA50 (ìƒìŠ¹)');
  if(RSI && RSI>=48 && RSI<=65) buy.push('ğŸ’ª RSI 48~65(ê±´ê°•)');
  if(price>hh*0.998) buy.push(`ğŸš€ ì§ì „ê³ ì (${fmt(hh)}) ëŒíŒŒ ì‹œë„`);
  if(vols.at(-1) > (vols.slice(-20,-1).reduce((a,b)=>a+b,0)/19)*1.3) buy.push('ğŸ”Š ê±°ë˜ëŒ€ê¸ˆ ìŠ¤íŒŒì´í¬');

  // ë§¤ë„/ì†ì ˆ ë£°: E20<E50 í•˜ë½ë°˜ì „ or RSI>75 ê³¼ì—´ or ìµœê·¼ ì €ì  ì´íƒˆ
  const ll = Math.min(...lows.slice(-20));
  const sell = [];
  if(E20 && E50 && E20<E50) sell.push('ğŸ”» ì¶”ì„¸: EMA20 < EMA50 (í•˜ë½)');
  if(RSI && RSI>=75) sell.push('ğŸ”¥ RSI ê³¼ì—´ê¶Œ');
  if(price<ll*1.002) sell.push(`â›” ì§ì „ì €ì (${fmt(ll)}) ì´íƒˆì‹œ`);

  // ìœ„í—˜ë„(0~5): ë³€ë™ì„±(í‘œì¤€í¸ì°¨/ê°€ê²©), ì²´ê²°ê°•ë„(ê°„ì´), ë“±ë½ì†ë„ ì¡°í•©
  const volaN = Math.min(5, Math.max(0, (volStdev/price)*100*0.6 + (RSI?Math.abs(RSI-50)/50:0)*2 + (E20&&E50? (E20>E50?0.6:1.2):1)));
  const risk = Math.round(volaN);

  // ë¸”ë™ìŠ¤ì™„: ìµœê·¼ 3ê°œ ìº”ë“¤ ì¤‘ í•˜ë‚˜ë¼ë„ ì ˆëŒ€ ë³€ë™ë¥  > 3% + ê±°ë˜ëŒ€ê¸ˆ ê¸‰ì¦
  let black = '-';
  for(let i=candles.length-1;i>=Math.max(0,candles.length-3);i--){
    const c=candles[i], ch=Math.abs((c.high_price-c.low_price)/c.trade_price*100);
    if(ch>3 && c.candle_acc_trade_price > (vols.slice(-20).reduce((a,b)=>a+b,0)/20)*1.8){
      black = 'âš ï¸ ë³€ë™/ê±°ë˜ ê¸‰ì¦';
      break;
    }
  }

  // í•œë§ˆë””
  let one='';
  if(buy.length>=2 && risk<=2) one='ê´€ë§ â†’ ëˆŒë¦¼ë§¤ìˆ˜: ë°•ìŠ¤ ìƒë‹¨ ëŒíŒŒ ì‹œ ë¶„í•  ì§„ì…';
  else if(sell.length>=2 && risk>=3) one='ë¦¬ìŠ¤í¬ ê´€ë¦¬: ìƒìŠ¹ ë‘”í™”, ì¶”ì„¸ ë°˜ì „ì‹œ ë¹„ì¤‘ ì¶•ì†Œ';
  else if(RSI && RSI<35) one='ê³¼ë§¤ë„ êµ¬ê°„ ì ‘ê·¼: ê¸‰ë½ í›„ ë°˜ë“± ì²´í¬';
  else one='ì¤‘ë¦½: ê´€ë§ í›„ ëª…í™•í•œ ë°©í–¥ì„± í™•ì¸';

  return {
    buy, sell, risk,
    black,
    tickStrength: tickStr,
    info:{E20,E50,RSI,hh,ll,volStdev,price}
  };
}

/* =========================
   ì„ íƒ ì½”ì¸ í‘œì‹œ
========================= */
async function selectCoin(market, row){
  try{
    SELECTED = market;
    setStatus(true, `${market} ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
    const tf = parseInt($('#tf').value,10);
    const url = EP.candleM(market, tf, 120);
    const r = await safeFetch('cd'+market, url);
    if(!r.ok) throw new Error('ìº”ë“¤ ì‹¤íŒ¨');
    const candles = await r.json();

    const tick = row? {trade_price:row.price} : null;
    const sig = buildSignals(candles, tick);

    // ìƒë‹¨ ì •ë³´
    $('#sel_name').textContent = `${market.replace('KRW-','')} / ${(ALL.find(x=>x.market===market)?.korean_name)??'-'}`;
    $('#sel_price').textContent = KRW(row?.price ?? candles[0]?.trade_price ?? null);
    $('#sel_chg').innerHTML   = row?.chg===null?'-':pct(row.chg);
    $('#sel_vol').textContent = fmt(row?.vol24 ?? 0);
    $('#sel_tick').textContent= sig.tickStrength? (sig.tickStrength>0?`ë§¤ìˆ˜ìš°ìœ„`: `ë§¤ë„ìš°ìœ„`) : '-';
    $('#sel_vola').textContent= `Ïƒâ‰ˆ${(sig.info.volStdev??0).toFixed(2)}`;
    $('#sel_black').textContent=sig.black;

    $('#buy_points').innerHTML = sig.buy.length? ('â— '+sig.buy.join('<br>â— ')) : '-';
    $('#sell_points').innerHTML= sig.sell.length? ('â— '+sig.sell.join('<br>â— ')) : '-';
    $('#risk_line').textContent= `ì†ì ˆ: ${fmt(sig.info.ll??0)}  Â·  ìœ„í—˜ë„: ${sig.risk}/5`;
    $('#one_liner').textContent= sig.one;
    setStatus(true, 'ì—°ê²°ë¨');
  }catch(e){
    setStatus(false, 'ì„ íƒ ì½”ì¸ ë¡œë“œ ì‹¤íŒ¨');
    console.error(e);
  }
}

/* =========================
   ì£¼ê¸° ê°±ì‹ 
========================= */
async function refresh(){
  try{
    setStatus(true,'ì‹œì„¸ ê°±ì‹  ì¤‘â€¦');
    if(ALL.length===0) await loadMarkets();

    const codes = ALL.map(x=>x.market);
    const ticks = await loadTickers(codes);
    renderTable(ticks);

    // ì´ë¯¸ ì„ íƒëœ ì½”ì¸ì´ ìˆìœ¼ë©´ ìƒë‹¨ë„ ê°±ì‹ 
    if(SELECTED){
      const row = ROWS.find(r=>r.m.market===SELECTED);
      if(row) selectCoin(SELECTED, row);
    }
    setStatus(true,'ì—°ê²°ë¨');
  }catch(e){
    console.error(e);
    setStatus(false, 'HTTP 404/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
  }
}

/* =========================
   ì´ë²¤íŠ¸/ì´ˆê¸°í™”
========================= */
$('#tf').onchange = ()=> { TF=parseInt($('#tf').value,10); if(SELECTED) selectCoin(SELECTED); };
$('#limit').onchange = ()=> refresh();
$('#q').oninput = ()=> refresh();
$('#reset').onclick = ()=> { $('#q').value=''; SELECTED=null; refresh(); };

document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){ if(polling){clearInterval(polling); polling=null;} }
  else { if(!polling) polling=setInterval(refresh, 3500); refresh(); }
});

(async function init(){
  await refresh();
  polling = setInterval(refresh, 3500);
})();
</script>
</body>
</html>
