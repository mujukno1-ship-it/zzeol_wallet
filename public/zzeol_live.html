<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>쩔어지갑 v9.2 - Upbit KRW 실시간</title>
<style>
body{margin:0;background:#0d1117;color:#e6edf3;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
h2{margin-top:32px}
.container{max-width:1200px;margin:auto;padding:16px}
input,select,button{background:#151b23;border:1px solid #30363d;border-radius:6px;color:#e6edf3;padding:6px 10px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border-bottom:1px solid #30363d;text-align:right}
th:first-child,td:first-child{text-align:left}
.up{color:#2ecc71}.down{color:#e74c3c}
.status{font-size:13px;margin-bottom:8px;color:#aaa}
.card{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:10px;margin-top:8px}
footer{text-align:center;margin:40px 0;color:#777;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>쩔어지갑 <small style="font-size:13px;color:#999">v9.2</small></h1>
  <div id="ws-status" class="status">초기화중...</div>
  <input id="search" placeholder="코인 검색 (한글/영문/심볼)" style="width:250px">
  <button id="reset">초기화</button>
  <h2>매수 · 매도 · 손절 타점 (KRW)</h2>
  <div id="info" class="card">데이터 불러오는 중...</div>
  <table>
    <thead><tr><th>구분</th><th>1차</th><th>2차</th><th>3차</th></tr></thead>
    <tbody>
      <tr><td>매수</td><td id="buy1">-</td><td id="buy2">-</td><td id="buy3">-</td></tr>
      <tr><td>매도</td><td id="sell1">-</td><td id="sell2">-</td><td id="sell3">-</td></tr>
      <tr><td>손절</td><td id="stop1">-</td><td id="stop2">-</td><td id="stop3">-</td></tr>
    </tbody>
  </table>
  <h2>KRW 코인 목록</h2>
  <table id="coin-table"><thead><tr><th>심볼</th><th>한글명</th><th>현재가</th><th>등락률</th><th>거래대금(24h)</th></tr></thead><tbody></tbody></table>
  <footer>© 2025 쩔어지갑 — 실시간 업비트 연동 | 오류시 새로고침(F5)</footer>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=n=>Number(n).toLocaleString("ko-KR");
const API="https://api.upbit.com/v1";
const WSS="wss://api.upbit.com/websocket/v1";
let ws=null,alive=false,markets={},current="KRW-BTC",timer=null;

async function getJSON(u){const r=await fetch(u);return r.json();}
async function init(){
 try{
   $("#ws-status").textContent="시장 불러오는 중...";
   const list=await getJSON(`${API}/market/all?isDetails=false`);
   for(const x of list){markets[x.market]=x.korean_name;}
   $("#ws-status").textContent="WS 연결 중...";
   connectWS();
   loadList();
   setInterval(loadList,4000);
 }catch(e){$("#ws-status").textContent="초기화 실패";}
}

function connectWS(){
 try{ws?.close();}catch{}
 ws=new WebSocket(WSS);
 ws.binaryType="arraybuffer";
 ws.onopen=()=>{alive=true;$("#ws-status").textContent="WS 연결됨 — 실시간";subscribe();};
 ws.onclose=()=>{alive=false;$("#ws-status").textContent="WS 끊김 — 1초 백업모드";setTimeout(connectWS,1000);};
 ws.onmessage=e=>{
   const txt=new TextDecoder().decode(e.data);const d=JSON.parse(txt);
   if(d.cd===current){updateInfo(d);}
 };
}

function subscribe(){
 ws.send(JSON.stringify([{ticket:"zzeolwallet"},{type:"ticker",codes:[current]}]));
}

function updateInfo(d){
 const name=markets[d.cd]||d.cd;
 const price=d.tp; const rate=(d.scr*100).toFixed(2);
 $("#info").innerHTML=`<b>${name}</b> (${d.cd})<br>현재가: ${fmt(price)} KRW<br>등락률: <span class="${rate>=0?'up':'down'}">${rate}%</span>`;
 calc(price);
}

function calc(p){
 const tick=p>=2000000?1000:p>=1000000?500:p>=500000?100:p>=100000?50:p>=10000?10:p>=1000?1:p>=100?0.1:0.01;
 const f=x=>Math.round(x/tick)*tick;
 const buys=[p*0.99,p*0.985,p*0.98].map(f);
 const sells=[p*1.01,p*1.015,p*1.02].map(f);
 const stops=[p*0.985,p*0.975,p*0.965].map(f);
 [buy1,buy2,buy3].forEach((x,i)=>x.textContent=fmt(buys[i]));
 [sell1,sell2,sell3].forEach((x,i)=>x.textContent=fmt(sells[i]));
 [stop1,stop2,stop3].forEach((x,i)=>x.textContent=fmt(stops[i]));
}

async function loadList(){
 try{
  const krw=Object.keys(markets).filter(k=>k.startsWith("KRW-")).slice(0,100);
  const t=await getJSON(`${API}/ticker?markets=${krw.join(",")}`);
  const rows=t.sort((a,b)=>b.acc_trade_price_24h-a.acc_trade_price_24h).slice(0,50)
   .map(x=>`<tr><td>${x.market.replace("KRW-","")}</td><td>${markets[x.market]}</td><td>${fmt(x.trade_price)}</td><td class="${x.signed_change_rate>=0?'up':'down'}">${(x.signed_change_rate*100).toFixed(2)}%</td><td>${fmt(Math.round(x.acc_trade_price_24h))}</td></tr>`).join("");
  $("#coin-table tbody").innerHTML=rows;
 }catch{}
}

$("#search").addEventListener("change",()=>{
 const q=$("#search").value.trim().toUpperCase();
 const code=Object.keys(markets).find(k=>k.includes(q)||markets[k].includes(q));
 if(code){current=code;$("#ws-status").textContent=`${markets[code]} (${code})`;subscribe();}
});
$("#reset").onclick=()=>{current="KRW-BTC";subscribe();};

init();
</script>
</body>
</html>
