<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ v10.5 â€” Upbit ì‹¤ì‹œê°„</title>
  <style>
    body {
      background-color: #0d1117;
      color: #e6edf3;
      font-family: "Pretendard", sans-serif;
      margin: 0;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 18px; color: #58a6ff; margin: 0; }
    .search-box {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
    }
    button {
      background-color: #238636;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .panel {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-color: #161b22;
      border-radius: 10px;
      margin-top: 20px;
      padding: 15px;
      text-align: center;
    }
    .panel div {
      flex: 1;
      font-size: 16px;
    }
    .highlight { color: #58a6ff; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.5</h1>
    <span id="ws-status">ìƒíƒœ: ì—°ê²° ëŒ€ê¸°ì¤‘...</span>
  </div>

  <div class="search-box">
    <input id="search-input" placeholder="ì½”ì¸ëª… (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, ì‹œë°”ì´ëˆ„)" />
    <button onclick="startUpbitSync(document.getElementById('search-input').value)">ê²€ìƒ‰</button>
  </div>

  <!-- ê°€ë¡œí˜• íŒ¨ë„ -->
  <div class="panel">
    <div>í˜„ì¬ê°€: <span id="price" class="highlight">-</span></div>
    <div>ë§¤ìˆ˜: <span id="bid1" class="highlight">-</span></div>
    <div>ë§¤ë„: <span id="ask1" class="highlight">-</span></div>
    <div>ìœ„í—˜ë„: <span id="risk" class="highlight">-</span></div>
    <div>ì©”ì–´í•œë§ˆë””: <span id="comment" class="highlight">-</span></div>
  </div>

<script>
/* ========= ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ê·œì¹™ ========= */
function upbitTick(price){
  if (price >= 2000000) return 1000;
  if (price >= 1000000) return 500;
  if (price >=  500000) return 100;
  if (price >=  100000) return 50;
  if (price >=   10000) return 10;
  if (price >=    1000) return 1;
  if (price >=     100) return 0.1;
  if (price >=      10) return 0.01;
  return 0.001;
}
function roundToTick(price, mode="round"){
  const t = upbitTick(price);
  if (t === 0) return price;
  if (mode === "ceil")  return Math.ceil (price / t) * t;
  if (mode === "floor") return Math.floor(price / t) * t;
  return Math.round(price / t) * t;
}

/* ========= API ê³µìš© fetch ========= */
async function jfetch(url){
  try{
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }catch(e){
    console.error("[fetch error]", url, e);
    return null;
  }
}

/* ========= ì—…ë¹„íŠ¸ì™€ ë™ì¼í•œ í˜„ì¬ê°€ + í˜¸ê°€ ========= */
async function getUpbitExactPrice(market){
  const [ticker, ob] = await Promise.all([
    jfetch(`/api/ticker?markets=${market}`),
    jfetch(`/api/orderbook?markets=${market}`)
  ]);

  let tradePrice=null;
  if(Array.isArray(ticker)&&ticker.length) tradePrice=Number(ticker[0].trade_price);

  let ask1=null,bid1=null;
  if(ob && Array.isArray(ob.orderbook_units)){
    ask1=ob.orderbook_units[0].ask_price;
    bid1=ob.orderbook_units[0].bid_price;
  } else if(Array.isArray(ob) && ob.length){
    const u=ob[0]?.orderbook_units||[];
    if(u.length){ask1=u[0].ask_price;bid1=u[0].bid_price;}
  }

  return {
    price: tradePrice!=null ? roundToTick(tradePrice) : null,
    ask: ask1!=null ? roundToTick(ask1) : null,
    bid: bid1!=null ? roundToTick(bid1) : null
  };
}

/* ========= UI ê°±ì‹  ========= */
async function updatePanel(market){
  const $price=document.getElementById("price");
  const $ask=document.getElementById("ask1");
  const $bid=document.getElementById("bid1");
  const $risk=document.getElementById("risk");
  const $comment=document.getElementById("comment");

  const data=await getUpbitExactPrice(market);
  if(!data.price){$price.textContent="-";return;}

  $price.textContent=data.price.toLocaleString("ko-KR");
  $ask.textContent=data.ask?.toLocaleString("ko-KR")||"-";
  $bid.textContent=data.bid?.toLocaleString("ko-KR")||"-";

  // ìœ„í—˜ë„ì™€ ì©”ì–´í•œë§ˆë”” (ë‹¨ìˆœ ì˜ˆì‹œ)
  const diff=Math.abs(data.ask-data.bid);
  let risk="1";
  if(diff>100) risk="2";
  if(diff>500) risk="3";
  $risk.textContent=risk;
  $comment.textContent = risk==="1" ? "ì•ˆì •ì " :
                         risk==="2" ? "ì£¼ì˜ ìš”ë§" : "ë³€ë™ì„± ê¸‰ë“±";
}

/* ========= ìë™ ê°±ì‹  ========= */
let _sync=null;
function startUpbitSync(input){
  clearInterval(_sync);
  const market = input.toUpperCase().startsWith("KRW-") ? input.toUpperCase() : `KRW-${input.toUpperCase()}`;
  updatePanel(market);
  _sync=setInterval(()=>updatePanel(market),2000);
}

/* ========= ì´ˆê¸° ì—°ê²° ìƒíƒœ í™•ì¸ ========= */
document.getElementById("ws-status").textContent="ìƒíƒœ: ì •ìƒ ì—°ê²°";
startUpbitSync("KRW-SHIB");
</script>
</body>
</html>
