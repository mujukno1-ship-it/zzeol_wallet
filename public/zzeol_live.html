<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 v10.4 — Upbit KRW 실시간</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>🔥</text></svg>">
  <style>
    :root{
      --bg:#0f1115;--card:#151824;--line:#252a3b;--text:#dfe4f5;--muted:#8a92a6;--accent:#67bfff;
      --pos:#5be49b;--neg:#ff6b6b;--warn:#ffd166
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit}
    .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:18px}
    .brand{font-weight:700}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:var(--card);border-radius:999px;padding:6px 10px;color:var(--muted)}
    .status{margin-left:auto}
    .ok{color:var(--pos)} .bad{color:var(--neg)} .warn{color:var(--warn)}
    .grid{display:grid;gap:12px}
    .g4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0;font-size:13px;color:var(--muted);font-weight:600}
    input[type="text"]{width:100%;background:#0e111b;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:11px 12px}
    button{border:1px solid var(--line);background:var(--card);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:10px 8px;text-align:left}
    thead th{font-weight:600;color:var(--muted);border-top:none}
    tbody tr:hover{background:#111629}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .metric{background:#0e1322;border:1px solid var(--line);border-radius:12px;padding:12px}
    .metric .k{font-size:12px;color:var(--muted);margin-bottom:4px}
    .metric .v{font-size:18px;font-weight:700}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    .tag{font-size:12px;border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    @media (max-width:980px){.g4{grid-template-columns:1fr}.row{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">쩔어지갑 🔥 <span class="chip">v10.4</span></div>
      <div class="chip">Upbit KRW 실시간</div>
      <div class="chip status">상태: <span id="ws-status" class="warn">확인중…</span></div>
    </header>

    <!-- 검색 & 선택 -->
    <div class="grid g4">
      <div class="card">
        <h3>코인 검색</h3>
        <div class="flex">
          <input id="search" type="text" placeholder="한글/영문/심볼: 비트코인, ETH, SOL 등" />
          <button id="btn-refresh">KRW 목록 새로고침</button>
        </div>
        <div class="muted" style="margin-top:6px">KRW 마켓만 표시. 행 클릭 시 상세·신호 즉시 갱신.</div>
      </div>
      <div class="card">
        <h3>선택 코인</h3>
        <div class="flex"><span class="tag">이름</span><div id="sel-name" class="muted">-</div></div>
        <div class="flex" style="margin-top:6px"><span class="tag">심볼</span><div id="sel-symbol" class="muted">-</div></div>
      </div>
      <div class="card">
        <h3>상태</h3>
        <div id="sel-state" class="muted">-</div>
      </div>
      <div class="card">
        <h3>등록률(24h)</h3>
        <div id="sel-change24" class="muted">-</div>
      </div>
    </div>

    <!-- 가로형 핵심 패널 -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <div class="metric"><div class="k">현재가</div><div id="m-price" class="v">-</div></div>
        <div class="metric"><div class="k">매수(1/2/3)</div><div id="m-buys" class="v muted">-</div></div>
        <div class="metric"><div class="k">매도(익절 1/2/3)</div><div id="m-sells" class="v muted">-</div></div>
        <div class="metric"><div class="k">손절</div><div id="m-stop" class="v muted">-</div></div>
        <div class="metric"><div class="k">위험도</div><div id="m-risk" class="v">-</div></div>
        <div class="metric"><div class="k">쩔어한마디</div><div id="m-remark" class="v muted" style="font-size:16px">-</div></div>
      </div>
    </div>

    <!-- 보조 지표 -->
    <div class="grid g4" style="margin-top:12px">
      <div class="card"><h3>EMA20</h3><div id="box-ema" class="muted">-</div></div>
      <div class="card"><h3>ATR(14)</h3><div id="box-atr" class="muted">-</div></div>
      <div class="card"><h3>틱 체감강도 (최근)</h3><div id="box-ticks" class="muted">-</div></div>
      <div class="card"><h3>API 상태</h3><div id="api-status" class="muted">확인중…</div></div>
    </div>

    <!-- 실시간 KRW 리스트 -->
    <div class="card" style="margin-top:14px">
      <h3>KRW 코인 목록 (실시간)</h3>
      <div class="muted" style="margin:6px 0">행 클릭 시 상단 타점/위험도/한마디 즉시 갱신.</div>
      <table id="tbl">
        <thead>
          <tr><th style="width:90px">심볼</th><th>코인명(한글)</th><th style="width:160px">현재가</th><th style="width:120px">등락률</th><th style="width:180px">거래대금(24h)</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:16px">
      경로: <code>/public/zzeol_live.html</code>
    </div>
  </div>

  <script>
  // ===== API BASE (절대경로) =====
  const API_BASE_URL = "https://satoshijibag-api.vercel.app"; // 여기만 바꾸면 됨

  // ===== helpers =====
  const $ = s => document.querySelector(s);
  async function get(path, params = {}) {
    const url = new URL(API_BASE_URL + path);
    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, v);
    const res = await fetch(url, { cache: "no-store" });
    const text = await res.text();
    if (!res.ok) throw new Error("HTTP "+res.status+" "+res.statusText+"\n"+text.slice(0,200));
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    if (!ct.includes("application/json")) throw new Error("Expected JSON but got "+ct+"\n"+text.slice(0,200));
    return JSON.parse(text);
  }
  const toKRW = (n) => {
    if (!Number.isFinite(n)) return "-";
    if (n >= 1_000_000_000) return (n/1_000_000_000).toFixed(2) + "억";
    if (n >= 10_000) return Math.round(n).toLocaleString();
    if (n >= 1) return n.toLocaleString(undefined,{maximumFractionDigits:0});
    return n.toFixed(4);
  };

  // ===== indicators =====
  function EMA(closes, period){
    const k = 2/(period+1);
    let ema = closes[0];
    const out = [ema];
    for (let i=1;i<closes.length;i++){ ema = closes[i]*k + ema*(1-k); out.push(ema); }
    return out;
  }
  function ATR(highs, lows, closes, period){
    const TR = [];
    for (let i=0;i<closes.length;i++){
      if (i===0){ TR.push(highs[i]-lows[i]); continue; }
      const tr = Math.max(
        highs[i]-lows[i],
        Math.abs(highs[i]-closes[i-1]),
        Math.abs(lows[i]-closes[i-1]),
      );
      TR.push(tr);
    }
    const out = [];
    let prev = TR.slice(0,period).reduce((a,b)=>a+b,0)/period;
    out[period-1] = prev;
    for (let i=period;i<TR.length;i++){
      prev = (prev*(period-1) + TR[i]) / period;
      out[i] = prev;
    }
    return out;
  }

  // ===== DOM refs =====
  const wsStatus = $("#ws-status");
  const apiStatus = $("#api-status");
  const tbody = $("#tbody");
  const el = {
    search: $("#search"),
    refresh: $("#btn-refresh"),
    selName: $("#sel-name"),
    selSymbol: $("#sel-symbol"),
    selState: $("#sel-state"),
    selChange24: $("#sel-change24"),
    price: $("#m-price"), buys: $("#m-buys"), sells: $("#m-sells"),
    stop: $("#m-stop"), risk: $("#m-risk"), remark: $("#m-remark"),
    boxEma: $("#box-ema"), boxAtr: $("#box-atr"), boxTicks: $("#box-ticks"),
  };

  // ===== state =====
  let marketsKRW = [];
  let lastSelect = null;

  async function checkHealth(){
    try{
      await get("/api/health");
      wsStatus.textContent = "정상 연결"; wsStatus.className = "ok";
      apiStatus.textContent = "정상";
    }catch(e){
      wsStatus.textContent = "연결 실패"; wsStatus.className = "bad";
      apiStatus.textContent = "오류";
      console.error(e);
    }
  }

  async function loadMarkets(){
    const data = await get("/api/markets");
    marketsKRW = data.filter(m => m.market?.startsWith("KRW-"));
    renderTable();
    if (!lastSelect && marketsKRW.length) selectSymbol(marketsKRW[0].market);
  }

  function renderTable(){
    tbody.innerHTML = marketsKRW.map(m => `
      <tr data-m="${m.market}">
        <td class="muted">${m.market.replace("KRW-","")}</td>
        <td>${m.korean_name || "-"}</td>
        <td class="muted" data-x="price">-</td>
        <td class="muted" data-x="chg">-</td>
        <td class="muted" data-x="vol">-</td>
      </tr>`).join("");
    tbody.querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=> selectSymbol(tr.dataset.m));
    });
  }

  async function tickLoop(){
    if (!marketsKRW.length) return setTimeout(tickLoop, 5000);
    try{
      const chunk = (arr,n)=>arr.reduce((a,_,i)=>(i%n?a[a.length-1].push(arr[i]):a.push([arr[i]]),a),[]);
      const chunks = chunk(marketsKRW.map(m=>m.market), 50);
      let all = [];
      for (const c of chunks){
        const r = await get("/api/ticker",{markets:c.join(",")});
        all = all.concat(r);
      }
      all.forEach(t=>{
        const tr = tbody.querySelector(`tr[data-m="${t.market}"]`);
        if (!tr) return;
        tr.querySelector('[data-x="price"]').textContent = toKRW(t.trade_price);
        tr.querySelector('[data-x="chg"]').innerHTML =
          (t.signed_change_rate*100>=0? `<span class="pos">+${(t.signed_change_rate*100).toFixed(2)}%</span>`:
                                         `<span class="neg">${(t.signed_change_rate*100).toFixed(2)}%</span>`);
        tr.querySelector('[data-x="vol"]').textContent = toKRW(t.acc_trade_price_24h)+"원";
      });
      if (lastSelect) updateSelected(lastSelect);
    }catch(e){ console.error(e); }
    finally{ setTimeout(tickLoop, 5000); }
  }

  async function selectSymbol(market){
    lastSelect = market;
    const info = marketsKRW.find(m=>m.market===market);
    el.selName.textContent = info?.korean_name ?? "-";
    el.selSymbol.textContent = market ?? "-";
    el.selState.textContent="갱신중…"; el.selChange24.textContent="-";
    el.price.textContent="-"; el.buys.textContent="-"; el.sells.textContent="-";
    el.stop.textContent="-"; el.risk.textContent="-"; el.remark.textContent="-";
    el.boxEma.textContent="-"; el.boxAtr.textContent="-"; el.boxTicks.textContent="-";
    await updateSelected(market);
  }

  async function updateSelected(market){
    try{
      const [t] = await get("/api/ticker",{markets:market});
      const cs = await get("/api/candles",{market,unit:5,count:200});
      const closes = cs.map(c=>c.trade_price).reverse();
      const highs  = cs.map(c=>c.high_price).reverse();
      const lows   = cs.map(c=>c.low_price).reverse();

      const ema20 = EMA(closes,20).at(-1);
      const atr14 = ATR(highs,lows,closes,14).at(-1);
      const price = t.trade_price;
      const atrPct = atr14 / price;

      const stop = Math.max(price - atr14, 0);
      const tp1 = price + atr14*1.0, tp2 = price + atr14*1.6, tp3 = price + atr14*2.2;
      const b1 = Math.max(ema20 - atr14*0.4, 0);
      const b2 = Math.max(ema20 - atr14*0.8, 0);
      const b3 = Math.max(ema20 - atr14*1.2, 0);
      const riskLabel = atrPct < 0.004 ? "낮음" : atrPct < 0.009 ? "중간" : "높음";
      const remark = (() => {
        if (atrPct < 0.004 && price > ema20) return "완만한 우상향, 분할 접근";
        if (atrPct >= 0.009) return "변동 급증(블랙스완). 진입 자제/짧은 손절 필수";
        if (price < ema20) return "추세 하방. 큰 비중 진입 금지";
        return "중립—완만한 우상향, 분할 접근";
      })();

      el.selState.textContent = t.signed_change_rate*100>=0 ? "상승" : "하락";
      el.selChange24.innerHTML = t.signed_change_rate*100>=0
        ? `<span class="pos">+${(t.signed_change_rate*100).toFixed(2)}%</span>`
        : `<span class="neg">${(t.signed_change_rate*100).toFixed(2)}%</span>`;
      el.price.textContent = toKRW(price);
      el.buys.textContent  = [b1,b2,b3].map(toKRW).join(" / ");
      el.sells.textContent = [tp1,tp2,tp3].map(toKRW).join(" / ");
      el.stop.textContent  = toKRW(stop);
      el.risk.textContent  = `${riskLabel} (${(atrPct*100).toFixed(2)}%)`;
      el.remark.textContent= remark;
      el.boxEma.textContent = toKRW(ema20);
      el.boxAtr.textContent = `${toKRW(atr14)} (1x)`;
      el.boxTicks.textContent= `체결 강도 추정: +${t.trade_volume?.toLocaleString?.() ?? "-"}`;
    }catch(e){ console.error(e); }
  }

  // 검색/새로고침
  $("#search").addEventListener("input",(e)=>{
    const q = e.target.value.trim().toLowerCase();
    $("#tbody").querySelectorAll("tr").forEach(tr=>{
      const m = tr.dataset.m.toLowerCase();
      const name = tr.children[1].textContent.toLowerCase();
      tr.style.display = (m.includes(q) || name.includes(q)) ? "" : "none";
    });
  });
  $("#btn-refresh").addEventListener("click", loadMarkets);

  // 부트
  (async function(){
    await checkHealth();
    await loadMarkets();
    tickLoop();
  })();
  </script>
</body>
</html>
