<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ Mini â€” ê²€ìƒ‰ê²°ê³¼ & ì‹¤ì‹œê°„ ê¸‰ë“±ì½”ì¸</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b1117;--card:#121826;--txt:#e6edf3;--mut:#90a4b8;--line:#243044;
    --up:#25d695;--dn:#ff6b6b;--chip:#1a2333;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .title{font-weight:800;margin-bottom:8px}
  .mut{color:var(--mut)}
  .searchbar{display:grid;grid-template-columns:1fr auto;gap:8px}
  input[type="text"]{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:#0e1522;color:var(--txt);font-size:18px}
  button{border:1px solid var(--line);background:var(--chip);color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid var(--line);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  tr:hover{background:#0f1827;cursor:pointer}
  .good{color:var(--up)} .bad{color:var(--dn)}
  .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);color:var(--mut);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’ ì©”ì–´ì§€ê°‘ Mini</h1>

  <!-- ğŸ” ê²€ìƒ‰ì°½ -->
  <div class="card">
    <div class="title">ì½”ì¸ ê²€ìƒ‰</div>
    <div class="searchbar">
      <input id="q" type="text" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ ì…ë ¥ â€” ì˜ˆ: ë¹„íŠ¸ì½”ì¸, SHIB, ETHâ€¦" />
      <button id="btnReload">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="mut small" style="margin-top:6px">Tip: ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ì²« ê²°ê³¼ë¥¼ ë°”ë¡œ ì„ íƒí•´ ìƒì„¸ë¥¼ ë„ìš¸ ìˆ˜ ìˆì–´ìš”.</div>
  </div>

  <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ (ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜) -->
  <div class="card" id="searchCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="title">ê²€ìƒ‰ ê²°ê³¼</div>
      <span id="srCount" class="pill">0ê°œ</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…</th>
          <th style="width:120px">í˜„ì¬ê°€</th>
          <th style="width:90px">ë“±ë½ë¥ </th>
          <th style="width:160px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
        </tr>
      </thead>
      <tbody id="srBody"></tbody>
    </table>
  </div>

  <!-- ğŸš€ ì‹¤ì‹œê°„ ê¸‰ë“±ì½”ì¸ (ê²€ìƒ‰ ê²°ê³¼ ë°‘) -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="title">ì‹¤ì‹œê°„ ê¸‰ë“±ì½”ì¸</div>
      <div class="row"><span class="pill" id="crit">ê¸°ì¤€: 5ë¶„ +3%â†‘ ë˜ëŠ” ìƒìœ„ ê±°ë˜ëŒ€ê¸ˆ</span><button id="btnPump">ê°±ì‹ </button></div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…</th>
          <th style="width:120px">í˜„ì¬ê°€</th>
          <th style="width:90px">ë“±ë½ë¥ </th>
          <th style="width:160px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
          <th style="width:80px">íƒœê·¸</th>
        </tr>
      </thead>
      <tbody id="pumpBody"></tbody>
    </table>
    <div class="mut small" style="margin-top:6px">ìƒìœ„ 10ê°œ í‘œì‹œ Â· 60ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </div>
  </div>
</div>

<script>
/* ===== í™˜ê²½ ===== */
const API_BASES = [
  '/upbit', // í”„ë¡ì‹œê°€ ìˆìœ¼ë©´ ì´ ê²½ë¡œ ì‚¬ìš©
  'https://api.upbit.com/v1' // ì—†ìœ¼ë©´ ê³µì‹ API ì‚¬ìš©
];
function url(path){ return API_BASES[0] + path; } // 1ìˆœìœ„ ì‚¬ìš©

/* ===== ìœ í‹¸ ===== */
const $ = s=>document.querySelector(s);
const fmtKRW = v=>{
  if (v==null || isNaN(v)) return '-';
  v = Number(v);
  if (v>=100) return Math.round(v).toLocaleString('ko-KR')+'ì›';
  if (v>=1)   return v.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})+'ì›';
  // 1ì› ë¯¸ë§Œ: ì†Œìˆ˜ 8ìë¦¬ê¹Œì§€
  const s = v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
  return s+'ì›';
};
const pct = r => {
  const x = Number(r)*100;
  const cls = x>0?'good':(x<0?'bad':'');
  return `<span class="${cls}">${x>0?'+':''}${x.toFixed(2)}%</span>`;
};
const shortVol = v=>{
  v = Number(v||0);
  if (v>=1e12) return (v/1e12).toFixed(2)+'ì¡°ì›';
  if (v>=1e8)  return (v/1e8).toFixed(1)+'ì–µì›';
  return Math.round(v).toLocaleString('ko-KR')+'ì›';
};

/* ===== ë°ì´í„° ===== */
let KRW = [];     // [{market,korean_name,english_name}]
let TICK = {};    // market -> ticker

async function getMarkets(){
  const r = await fetch(url('/market/all?isDetails=true'));
  if (!r.ok) throw new Error('market '+r.status);
  const j = await r.json();
  return j.filter(x=>x.market.startsWith('KRW-'));
}
async function getTicker(markets){
  const r = await fetch(url('/ticker?markets='+encodeURIComponent(markets.join(','))));
  if (!r.ok) throw new Error('ticker '+r.status);
  return r.json();
}
async function getCandles(unit, market, count=30){
  const r = await fetch(url(`/candles/minutes/${unit}?market=${market}&count=${count}`));
  if (!r.ok) throw new Error('candles '+r.status);
  return r.json();
}

/* ===== ì´ˆê¸° ë¡œë“œ ===== */
(async function init(){
  try{
    KRW = await getMarkets();
    await refreshTickers();
    bindUI();
    renderSearch();    // ì²˜ìŒì—” ë¹„ì›€
    await renderPump(); // ê¸‰ë“± ì´ˆê¸° í‘œì‹œ
    setInterval(refreshTickers, 30_000);
    setInterval(renderPump, 60_000);
  }catch(e){
    console.error(e);
    alert('ì—°ê²° ì‹¤íŒ¨: ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
  }
})();

async function refreshTickers(){
  const mk = KRW.map(x=>x.market);
  for(let i=0;i<mk.length;i+=100){
    const chunk = mk.slice(i,i+100);
    const arr = await getTicker(chunk);
    for(const t of arr) TICK[t.market] = t;
    await new Promise(r=>setTimeout(r,120));
  }
}

/* ===== ê²€ìƒ‰ ===== */
function bindUI(){
  $('#q').addEventListener('input', renderSearch);
  $('#q').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const first = $('#srBody tr');
      if (first) first.click(); // ì²« ê²°ê³¼ ì„ íƒ
    }
  });
  $('#btnReload').addEventListener('click', async ()=>{
    KRW = await getMarkets();
    await refreshTickers();
    renderSearch();
    renderPump();
  });
  $('#btnPump').addEventListener('click', renderPump);
}

function renderSearch(){
  const q = ($('#q').value||'').trim().toLowerCase();
  const card = $('#searchCard');
  const body = $('#srBody');
  if (!q){
    card.style.display = 'none';
    body.innerHTML = '';
    $('#srCount').textContent = '0ê°œ';
    return;
  }
  const list = [];
  for(const it of KRW){
    const sym = it.market.replace('KRW-','');
    const ko = it.korean_name.toLowerCase();
    const en = (it.english_name||'').toLowerCase();
    if (sym.toLowerCase().includes(q) || ko.includes(q) || en.includes(q)){
      const t = TICK[it.market]; if (!t) continue;
      list.push({it,t});
    }
  }
  list.sort((a,b)=> (b.t.acc_trade_price_24h||0) - (a.t.acc_trade_price_24h||0));
  body.innerHTML = list.map(({it,t})=>`
    <tr data-m="${it.market}">
      <td><b>${it.market.replace('KRW-','')}</b></td>
      <td>${it.korean_name}</td>
      <td>${fmtKRW(t.trade_price||0)}</td>
      <td>${pct(t.signed_change_rate||0)}</td>
      <td>${shortVol(t.acc_trade_price_24h||0)}</td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="mut">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
  $('#srCount').textContent = list.length+'ê°œ';
  card.style.display = 'block';

  // í´ë¦­ ì‹œ ìƒì„¸ ë™ì‘(ì„ íƒ ì½œë°±ë§Œ ì˜ˆì‹œ)
  [...body.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', async ()=>{
      const m = tr.dataset.m;
      // ì„ íƒì‹œ ì›í•˜ëŠ” ì¶”ê°€ ì•¡ì…˜ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì„œ ì‹¤í–‰(ì˜ˆ: ê¸°ì¡´ ìƒì„¸ íŒ¨ë„ ê°±ì‹ )
      console.log('ì„ íƒ:', m);
    });
  });
}

/* ===== ê¸‰ë“±ì½”ì¸ ===== */
async function renderPump(){
  const body = $('#pumpBody');
  // ê¸°ì¤€: â‘  5ë¶„ë´‰ ìƒìŠ¹ë¥  â‰¥ +3%  OR  â‘¡ 24h ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ 30ìœ„ ì¤‘ ìƒìŠ¹ë¥  ìƒìœ„
  const scored = [];
  for(const it of KRW){
    const m = it.market;
    const t = TICK[m]; if(!t) continue;
    let score = 0;
    let ch5 = 0;
    try{
      const cs = await getCandles(5, m, 2); // ìµœê·¼ 2ê°œë¡œ 5ë¶„ ë³€ë™ë¥  ê·¼ì‚¬
      if (cs && cs.length>=2){
        const a = cs[1].trade_price, b = cs[0].trade_price;
        ch5 = ((a-b)/b)*100;
      }
    }catch(_){}
    const ch24 = (t.signed_change_rate||0)*100;
    const vol24 = t.acc_trade_price_24h||0;

    if (ch5 >= 3) score += 100;          // ê°•í•œ ê¸‰ë“±
    score += Math.max(0, ch24);          // 24h ìƒìŠ¹ ê°€ì‚°
    score += Math.log10(Math.max(1, vol24)); // ìœ ë™ì„± ê°€ì‚°

    scored.push({it,t,ch5,ch24,vol24,score});
    // ë¶€í•˜ ì™„í™”
    await new Promise(r=>setTimeout(r,8));
  }

  scored.sort((a,b)=> b.score - a.score);
  const top = scored.slice(0,10);

  body.innerHTML = top.map(({it,t,ch5,ch24,vol24})=>{
    const tag = ch5>=3 ? 'ê¸‰ë“±' : (ch24>=7 ? 'ê°•ì„¸' : '');
    return `
      <tr data-m="${it.market}">
        <td><b>${it.market.replace('KRW-','')}</b></td>
        <td>${it.korean_name}</td>
        <td>${fmtKRW(t.trade_price||0)}</td>
        <td>${pct((t.signed_change_rate||0))}</td>
        <td>${shortVol(vol24)}</td>
        <td>${tag?`<span class="pill">${tag}</span>`:''}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="6" class="mut">ê¸‰ë“± ì½”ì¸ ì—†ìŒ</td></tr>`;

  // í´ë¦­ ì—”ë“œí¬ì¸íŠ¸ (ì„ íƒ ì‹œ ì›í•˜ëŠ” ì¶”ê°€ ì•¡ì…˜ ì—°ê²°)
  [...body.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const m = tr.dataset.m;
      console.log('ê¸‰ë“± ì„ íƒ:', m);
    });
  });
}
</script>
</body>
</html>
