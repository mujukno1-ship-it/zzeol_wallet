<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>쩔어지갑 🔥 v10.3.1 — Upbit KRW 실시간 (매수·매도 타점/위험도/쩔어 한마디)</title>
<meta name="color-scheme" content="dark" />
<style>
:root{
  --bg:#0d1117; --card:#161b22; --line:#30363d; --text:#c9d1d9; --muted:#8b949e; --accent:#58a6ff;
  --good:#3fb950; --bad:#ff7b72; --warn:#f0883e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.row{display:grid;gap:12px}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.grid-4{grid-template-columns:repeat(4,1fr)}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
h1{display:flex;align-items:center;gap:10px;margin:0 0 10px;font-size:18px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted)}
select, input, button{background:var(--bg);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 10px}
button{cursor:pointer}
.tag{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:8px;padding:4px 8px;background:rgba(88,166,255,.08)}
.small{font-size:12px;color:var(--muted)}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px}
.kv div:nth-child(odd){color:var(--muted)}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.table th,.table td{border-top:1px solid var(--line);padding:10px 8px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table tr:hover{background:#0f141b}
.up{color:var(--good)} .down{color:var(--bad)} .flat{color:var(--muted)}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
.status{padding:8px 10px;border-radius:10px}
.ok{background:rgba(63,185,80,.12);border:1px solid rgba(63,185,80,.35)}
.err{background:rgba(255,123,114,.12);border:1px solid rgba(255,123,114,.35)}
.warn{background:rgba(240,136,62,.12);border:1px solid rgba(240,136,62,.35)}
.hr{height:1px;background:var(--line);margin:8px 0}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
footer{opacity:.7;margin:24px 0}
</style>
</head>
<body>
<div class="container">

  <h1>
    쩔어지갑 🔥 <span class="badge">v10.3.1</span>
    <span id="conn" class="status warn small">상태: 초기 로드 중…</span>
    <span class="right small code">/public/zzeol_live.html</span>
  </h1>

  <div class="flex">
    <div class="tag">분봉
      <select id="tf" style="margin-left:6px">
        <option value="1">1분</option><option value="3">3분</option>
        <option value="5" selected>5분</option><option value="10">10분</option>
        <option value="15">15분</option><option value="30">30분</option>
        <option value="60">60분</option>
      </select>
    </div>
    <div class="tag">상한: 
      <select id="limit" style="margin-left:6px">
        <option value="80">80개</option>
        <option value="120" selected>120개</option>
        <option value="200">200개</option>
      </select>
    </div>
    <div class="right flex">
      <input id="q" placeholder="코인 검색 (한글/영문/심볼)" />
      <button id="reset">초기화</button>
    </div>
  </div>

  <div class="row grid-3" style="margin-top:10px">
    <div class="card">
      <div class="small" style="margin-bottom:6px">선택 코인</div>
      <div class="kv small">
        <div>심볼 / 한글명</div><div id="sel_name">-</div>
        <div>현재가 (KRW)</div><div id="sel_price">-</div>
        <div>등락률(24h)</div><div id="sel_chg">-</div>
        <div>거래대금(24h)</div><div id="sel_vol">-</div>
        <div>틱 체결강도</div><div id="sel_tick">-</div>
        <div>유동성/변동성</div><div id="sel_vola">-</div>
        <div>블랙스완 감지</div><div id="sel_black">-</div>
      </div>
    </div>
    <div class="card">
      <div class="small" style="margin-bottom:6px">매수 타점</div>
      <div id="buy_points" class="small">-</div>
      <div class="hr"></div>
      <div class="small">메모</div>
      <div id="buy_note" class="small muted">EMA20 상승 + 거래량↑ + 체결강도↑일 때 유효</div>
    </div>
    <div class="card">
      <div class="small" style="margin-bottom:6px">매도(익절/손절) 타점</div>
      <div id="sell_points" class="small">-</div>
      <div class="hr"></div>
      <div class="small">손절 · 위험도 · 쩔어한마디</div>
      <div id="risk_line" class="small">손절: - / 위험도: -</div>
      <div id="one_liner" class="small" style="margin-top:6px">-</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th style="width:90px">심볼</th>
          <th>코인명(한글)</th>
          <th style="width:100px">현재가</th>
          <th style="width:90px">등락률</th>
          <th style="width:120px">거래대금(24h)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small" style="margin-top:6px">행 클릭 시 상단 타점/위험도/한마디 즉시 갱신.</div>
  </div>

  <footer class="small">
    © 2025 쩔어지갑 — Upbit KRW 실시간 | 데이터: <span class="code">api.upbit.com</span> | 안전한 중복요청 차단/레이트리밋 대응 적용
  </footer>
</div>

<script>
/* =========================
   간단 유틸
========================= */
const $ = sel => document.querySelector(sel);
const fmt = n => (n===null||n===undefined||Number.isNaN(n)) ? '-' :
  Intl.NumberFormat('ko-KR',{maximumFractionDigits: n<1?4:2}).format(n);
const pct = n => (n===null||n===undefined) ? '-' :
  (n>0?'<span class="up">+':'<span class="down">')+n.toFixed(2)+'%</span>';
const KRW = v => v<1 ? fmt(v) : fmt(v);

/* =========================
   상태 표시/요청 제어
========================= */
const connEl = $('#conn');
let polling=null;
let inFlight = new Map(); // key -> AbortController

function setStatus(ok,msg){
  connEl.className='status small '+(ok?'ok':(msg.includes('초기')?'warn':'err'));
  connEl.textContent='상태: '+msg;
}
function safeFetch(key, url){
  // 중복 요청 방지 + 이전 요청 취소(레이트리밋 보호)
  try{ if(inFlight.has(key)) inFlight.get(key).abort(); }catch(e){}
  const c = new AbortController(); inFlight.set(key,c);
  return fetch(url,{signal:c.signal}).finally(()=> inFlight.delete(key));
}

/* =========================
   Upbit Endpoints (직접 호출)
========================= */
const EP = {
  markets : `https://api.upbit.com/v1/market/all?isDetails=true`,
  ticker  : (codes) => `https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
  candleM : (mkt, min, cnt=200) => `https://api.upbit.com/v1/candles/minutes/${min}?market=${mkt}&count=${cnt}`
};

/* =========================
   데이터 적재
========================= */
let ALL=[]; // [{market, korean_name, english_name}]
let ROWS=[]; // 가시 목록
let SELECTED=null; // 'KRW-BTC' 같은 문자열
let TF = parseInt($('#tf').value,10); // 분봉

async function loadMarkets(){
  const r = await safeFetch('mk', EP.markets);
  if(!r.ok) throw new Error('마켓 목록 실패');
  const js = await r.json();
  ALL = js.filter(x=>x.market.startsWith('KRW-'));
}

async function loadTickers(list){
  if(list.length===0) return [];
  const chunk = (arr,n)=>arr.reduce((a,_,i)=> (i%n? a[a.length-1].push(arr[i]) : a.push([arr[i]]), a), []);
  const packs = chunk(list, 90); // Upbit 한 번에 너무 많이 부르면 414 될 수 있어 안전하게 분할
  const out=[];
  for(const p of packs){
    const r = await safeFetch('tk'+p.length, EP.ticker(p));
    if(!r.ok) throw new Error('티커 실패');
    out.push(...await r.json());
  }
  return out;
}

/* =========================
   테이블 렌더
========================= */
function renderTable(ticks){
  const q = $('#q').value.trim().toLowerCase();
  const cap = parseInt($('#limit').value,10);
  const tbody = $('#tbl tbody');
  tbody.innerHTML='';

  const map = new Map(ticks.map(x=>[x.market,x]));
  const rows = ALL
    .map(m=>{
      const t = map.get(m.market);
      const price = t?.trade_price ?? null;
      const chg = t ? (t.signed_change_rate*100) : null;
      const vol24 = t?.acc_trade_price_24h ?? null;
      return {m, price, chg, vol24};
    })
    .filter(r=>{
      if(!q) return true;
      const s = `${r.m.market} ${r.m.korean_name} ${r.m.english_name}`.toLowerCase();
      return s.includes(q);
    })
    .sort((a,b)=> (b.vol24??0)-(a.vol24??0))
    .slice(0,cap);

  ROWS = rows;

  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="code">${r.m.market.replace('KRW-','')}</td>
      <td>${r.m.korean_name}</td>
      <td>${r.price===null?'-':KRW(r.price)}</td>
      <td>${r.chg===null?'-':pct(r.chg)}</td>
      <td>${r.vol24===null?'-':fmt(r.vol24)}</td>
    `;
    tr.onclick = ()=> selectCoin(r.m.market, r);
    tbody.appendChild(tr);
  }
}

/* =========================
   간단 지표
========================= */
function ema(arr, period){
  if(arr.length<period) return null;
  const k = 2/(period+1);
  let e = arr.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for(let i=period;i<arr.length;i++) e = arr[i]*k + e*(1-k);
  return e;
}
function rsi(closes, period=14){
  if(closes.length<=period) return null;
  let gains=0,loss=0;
  for(let i=1;i<=period;i++){
    const d=closes[i]-closes[i-1];
    if(d>=0) gains+=d; else loss-=d;
  }
  gains/=period; loss/=period;
  let rs = loss===0 ? 100 : gains/loss;
  let out = 100 - (100/(1+rs));
  for(let i=period+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    const g = d>0?d:0, l = d<0?-d:0;
    gains=(gains*(period-1)+g)/period;
    loss=(loss*(period-1)+l)/period;
    rs = loss===0 ? 100 : gains/loss;
    out = 100 - (100/(1+rs));
  }
  return out;
}
function stdev(arr){
  if(arr.length<2) return 0;
  const m = arr.reduce((a,b)=>a+b,0)/arr.length;
  const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/(arr.length-1);
  return Math.sqrt(v);
}

/* =========================
   타점 계산 / 위험도 / 한마디
========================= */
function buildSignals(candles, lastTick){
  // candles: 최신이 0번째 (Upbit 분봉 응답은 최신순)
  const closes = candles.map(c=>c.trade_price).slice().reverse();
  const highs  = candles.map(c=>c.high_price).slice().reverse();
  const lows   = candles.map(c=>c.low_price).slice().reverse();
  const vols   = candles.map(c=>c.candle_acc_trade_price).slice().reverse();

  const E20 = ema(closes,20);
  const E50 = ema(closes,50);
  const RSI = rsi(closes,14);
  const volStdev = stdev(closes.slice(-30));
  const price = lastTick?.trade_price ?? closes.at(-1);
  const tickStr = lastTick && (lastTick.trade_volume>0)
    ? ((lastTick.ask_bid==='BID'?1:-1) * (lastTick.trade_volume))*100 : 0; // 간이 표현

  // 매수 룰: E20 > E50 & RSI 48~65 & 최근 고점 돌파 시도
  const hh = Math.max(...highs.slice(-20));
  const buy = [];
  if(E20 && E50 && E20>E50) buy.push('📈 추세: EMA20 > EMA50 (상승)');
  if(RSI && RSI>=48 && RSI<=65) buy.push('💪 RSI 48~65(건강)');
  if(price>hh*0.998) buy.push(`🚀 직전고점(${fmt(hh)}) 돌파 시도`);
  if(vols.at(-1) > (vols.slice(-20,-1).reduce((a,b)=>a+b,0)/19)*1.3) buy.push('🔊 거래대금 스파이크');

  // 매도/손절 룰: E20<E50 하락반전 or RSI>75 과열 or 최근 저점 이탈
  const ll = Math.min(...lows.slice(-20));
  const sell = [];
  if(E20 && E50 && E20<E50) sell.push('🔻 추세: EMA20 < EMA50 (하락)');
  if(RSI && RSI>=75) sell.push('🔥 RSI 과열권');
  if(price<ll*1.002) sell.push(`⛔ 직전저점(${fmt(ll)}) 이탈시`);

  // 위험도(0~5): 변동성(표준편차/가격), 체결강도(간이), 등락속도 조합
  const volaN = Math.min(5, Math.max(0, (volStdev/price)*100*0.6 + (RSI?Math.abs(RSI-50)/50:0)*2 + (E20&&E50? (E20>E50?0.6:1.2):1)));
  const risk = Math.round(volaN);

  // 블랙스완: 최근 3개 캔들 중 하나라도 절대 변동률 > 3% + 거래대금 급증
  let black = '-';
  for(let i=candles.length-1;i>=Math.max(0,candles.length-3);i--){
    const c=candles[i], ch=Math.abs((c.high_price-c.low_price)/c.trade_price*100);
    if(ch>3 && c.candle_acc_trade_price > (vols.slice(-20).reduce((a,b)=>a+b,0)/20)*1.8){
      black = '⚠️ 변동/거래 급증';
      break;
    }
  }

  // 한마디
  let one='';
  if(buy.length>=2 && risk<=2) one='관망 → 눌림매수: 박스 상단 돌파 시 분할 진입';
  else if(sell.length>=2 && risk>=3) one='리스크 관리: 상승 둔화, 추세 반전시 비중 축소';
  else if(RSI && RSI<35) one='과매도 구간 접근: 급락 후 반등 체크';
  else one='중립: 관망 후 명확한 방향성 확인';

  return {
    buy, sell, risk,
    black,
    tickStrength: tickStr,
    info:{E20,E50,RSI,hh,ll,volStdev,price}
  };
}

/* =========================
   선택 코인 표시
========================= */
async function selectCoin(market, row){
  try{
    SELECTED = market;
    setStatus(true, `${market} 데이터 불러오는 중…`);
    const tf = parseInt($('#tf').value,10);
    const url = EP.candleM(market, tf, 120);
    const r = await safeFetch('cd'+market, url);
    if(!r.ok) throw new Error('캔들 실패');
    const candles = await r.json();

    const tick = row? {trade_price:row.price} : null;
    const sig = buildSignals(candles, tick);

    // 상단 정보
    $('#sel_name').textContent = `${market.replace('KRW-','')} / ${(ALL.find(x=>x.market===market)?.korean_name)??'-'}`;
    $('#sel_price').textContent = KRW(row?.price ?? candles[0]?.trade_price ?? null);
    $('#sel_chg').innerHTML   = row?.chg===null?'-':pct(row.chg);
    $('#sel_vol').textContent = fmt(row?.vol24 ?? 0);
    $('#sel_tick').textContent= sig.tickStrength? (sig.tickStrength>0?`매수우위`: `매도우위`) : '-';
    $('#sel_vola').textContent= `σ≈${(sig.info.volStdev??0).toFixed(2)}`;
    $('#sel_black').textContent=sig.black;

    $('#buy_points').innerHTML = sig.buy.length? ('● '+sig.buy.join('<br>● ')) : '-';
    $('#sell_points').innerHTML= sig.sell.length? ('● '+sig.sell.join('<br>● ')) : '-';
    $('#risk_line').textContent= `손절: ${fmt(sig.info.ll??0)}  ·  위험도: ${sig.risk}/5`;
    $('#one_liner').textContent= sig.one;
    setStatus(true, '연결됨');
  }catch(e){
    setStatus(false, '선택 코인 로드 실패');
    console.error(e);
  }
}

/* =========================
   주기 갱신
========================= */
async function refresh(){
  try{
    setStatus(true,'시세 갱신 중…');
    if(ALL.length===0) await loadMarkets();

    const codes = ALL.map(x=>x.market);
    const ticks = await loadTickers(codes);
    renderTable(ticks);

    // 이미 선택된 코인이 있으면 상단도 갱신
    if(SELECTED){
      const row = ROWS.find(r=>r.m.market===SELECTED);
      if(row) selectCoin(SELECTED, row);
    }
    setStatus(true,'연결됨');
  }catch(e){
    console.error(e);
    setStatus(false, 'HTTP 404/네트워크 오류');
  }
}

/* =========================
   이벤트/초기화
========================= */
$('#tf').onchange = ()=> { TF=parseInt($('#tf').value,10); if(SELECTED) selectCoin(SELECTED); };
$('#limit').onchange = ()=> refresh();
$('#q').oninput = ()=> refresh();
$('#reset').onclick = ()=> { $('#q').value=''; SELECTED=null; refresh(); };

document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){ if(polling){clearInterval(polling); polling=null;} }
  else { if(!polling) polling=setInterval(refresh, 3500); refresh(); }
});

(async function init(){
  await refresh();
  polling = setInterval(refresh, 3500);
})();
</script>
</body>
</html>
