<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 🔥 v10.4 — Upbit KRW 실시간 (EMA/ATR/타점/위험도/쩔어한마디)</title>
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg:#0d1117; --card:#121826; --muted:#98a2b3; --text:#e6edf3;
      --line:#1f2633; --up:#14b8a6; --down:#ef4444; --accent:#3b82f6; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .brand{font-weight:800}
    .tag{padding:2px 8px;border:1px solid var(--line);background:var(--card);border-radius:8px}
    .status{margin-left:auto}
    .status.ok{color:var(--up)} .status.bad{color:var(--down)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{color:var(--muted);font-size:12px;margin-bottom:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--bg);border-radius:999px;padding:6px 10px}
    input[type="text"]{width:100%;padding:10px 12px;background:#0b1220;border:1px solid var(--line);color:var(--text);border-radius:8px}
    button{cursor:pointer;background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 12px;font-weight:700}
    button.ghost{background:transparent;border:1px solid var(--line)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px}
    .k{color:var(--muted)}
    .v b{font-weight:800}
    .muted{color:var(--muted)}
    .warn{color:var(--warn)} .up{color:var(--up)} .down{color:var(--down)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-top:1px solid var(--line);padding:10px 8px}
    th{color:var(--muted);text-align:left;font-weight:600;background:#0b1220;position:sticky;top:0}
    tr:hover{background:#0b1220}
    .right{text-align:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .targets{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){.targets{grid-template-columns:1fr}}
    .targets ul{margin:0;padding-left:16px}
    .danger{background:#2a0e12;border-color:#5a1d23}
    .okbox{background:#0e1f21;border-color:#1c3d40}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">쩔어지갑 🔥</div>
      <span class="tag">v10.4</span>
      <span class="tag">Upbit KRW 실시간</span>
      <span class="status tag" id="ws-status">상태: 연결 대기</span>
    </header>

    <!-- 검색/설정 -->
    <div class="grid">
      <div class="card">
        <div class="title">코인 검색</div>
        <div class="row" style="gap:8px">
          <input id="search" type="text" placeholder="한글/영문/심볼: 비트코인, ETH, SOL 등" />
          <button id="btn-refresh" class="ghost">KRW 목록 새로고침</button>
        </div>
        <div class="muted" style="margin-top:8px">KRW 마켓만 표시. 행 클릭 시 상세·신호 즉시 갱신.</div>
      </div>

      <div class="card">
        <div class="title">선택 코인</div>
        <div class="kvs">
          <div class="k">이름</div><div class="v" id="sel-name">-</div>
          <div class="k">심볼</div><div class="v" id="sel-sym">-</div>
          <div class="k">현재가</div><div class="v" id="sel-price">-</div>
          <div class="k">등락률(24h)</div><div class="v" id="sel-chg">-</div>
          <div class="k">거래대금(24h)</div><div class="v" id="sel-vol">-</div>
          <div class="k">틱 체감강도</div><div class="v" id="sel-tick">-</div>
        </div>
      </div>
    </div>

    <!-- 유동성/변동성 & 위험 -->
    <div class="grid">
      <div class="card">
        <div class="title">유동성·변동성</div>
        <div class="kvs">
          <div class="k">EMA20</div><div class="v" id="ema20">-</div>
          <div class="k">ATR(14)</div><div class="v" id="atr14">-</div>
          <div class="k">EMA 기울기</div><div class="v" id="emaSlope">-</div>
          <div class="k">블랙스완 감지</div><div class="v" id="black">-</div>
        </div>
      </div>

      <div class="card">
        <div class="title">손절·위험도·쩔어한마디</div>
        <div class="kvs">
          <div class="k">손절</div><div class="v" id="stop">-</div>
          <div class="k">위험도</div><div class="v" id="risk">-</div>
          <div class="k">쩔어한마디</div><div class="v" id="comment">-</div>
        </div>
      </div>
    </div>

    <!-- 타점 -->
    <div class="grid">
      <div class="card okbox">
        <div class="title">매수 타점</div>
        <ul id="buys">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="muted" style="margin-top:8px">기본 룰: EMA20 근처 눌림 + ATR 기반 분할진입.</div>
      </div>

      <div class="card">
        <div class="title">매도(익절) 타점</div>
        <ul id="sells">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="muted" style="margin-top:8px">기본 룰: 현재가 기준 ATR×(1.0, 1.6, 2.2) 목표.</div>
      </div>
    </div>

    <!-- 리스트 -->
    <div class="card">
      <div class="title">KRW 코인 목록 (실시간)</div>
      <table id="list">
        <thead>
          <tr>
            <th>심볼</th>
            <th>코인명(한글)</th>
            <th class="right">현재가</th>
            <th class="right">등락률</th>
            <th class="right">거래대금(24h)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===============================
    //  API (프록시 경유)  ← 중요: 이 4줄이 브라우저-업비트 연결 실패를 해결
    // ===============================
    const API = {
      markets: "/api/markets",
      ticker:  (ms) => `/api/ticker?ms=${ms.join(",")}`,
      candles: (unit, mkt, count=200) => `/api/candles?unit=${unit}&m=${encodeURIComponent(mkt)}&count=${count}`,
      ticks:   (mkt, count=60) => `/api/ticks?m=${encodeURIComponent(mkt)}&count=${count}`,
    };

    // 유틸
    const fmt = (n,d=0)=> n===null||n===undefined||isNaN(n) ? "-" : Number(n).toLocaleString("ko-KR",{maximumFractionDigits:d});
    const pct = (n)=> (n>0? "+" : "") + (isFinite(n)? n.toFixed(2):"-") + "%";
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    // 상태
    const state = {
      markets: [],             // {market,korean_name,english_name}
      krw: [],                 // KRW-*만
      bySym: {},               // "KRW-BTC" → { ... }
      tableData: [],           // 테이블 표시용
      selected: null,          // 선택한 마켓
      cacheTicker: new Map(),  // 간단 캐시
    };

    // DOM
    const el = (id)=> document.getElementById(id);
    const $tbody = el('tbody');
    const $status = el('ws-status');
    const $search = el('search');

    async function init() {
      setStatus("연결 중…");
      try {
        await loadMarkets();          // KRW 목록 로딩
        await fillTable();            // 가격/등락/거래대금 채우기
        setStatus("정상 연결", true);

        // 검색
        $search.addEventListener('input', onSearch);
        document.getElementById('btn-refresh').addEventListener('click', async ()=>{
          setStatus("목록 새로고침…");
          await fillTable(true);
          setStatus("정상 연결", true);
        });

      } catch (e) {
        console.error(e);
        setStatus("연결 실패", false);
      }
    }

    function setStatus(msg, ok=false){
      $status.textContent = `상태: ${msg}`;
      $status.classList.toggle('ok', !!ok);
      $status.classList.toggle('bad', !ok);
    }

    // 1) 마켓 로드
    async function loadMarkets(){
      const r = await fetch(API.markets);
      if(!r.ok) throw new Error('markets fail');
      const all = await r.json();
      state.markets = all;
      state.krw = all.filter(x=> x.market && x.market.startsWith("KRW-"));
      state.bySym = Object.fromEntries(state.krw.map(x=> [x.market, x]));
    }

    // 2) KRW 목록 테이블 채우기 (분할 호출)
    async function fillTable(force=false){
      const syms = state.krw.map(x=> x.market);
      const chunks = [];
      for(let i=0;i<syms.length;i+=20) chunks.push(syms.slice(i,i+20));

      const rows = [];
      for(const part of chunks){
        const cacheKey = part.join(",");
        let data;
        if(!force && state.cacheTicker.has(cacheKey) && (Date.now()-state.cacheTicker.get(cacheKey)._t<3000)){
          data = state.cacheTicker.get(cacheKey);
        }else{
          const r = await fetch(API.ticker(part));
          data = await r.json();
          data._t = Date.now();
          state.cacheTicker.set(cacheKey, data);
          await sleep(120); // 살짝 간격
        }
        for(const t of data){
          const m = state.bySym[t.market] || { korean_name:"-", market:t.market };
          rows.push({
            sym: t.market.replace("KRW-",""),
            kor: m.korean_name || "-",
            price: +t.trade_price || 0,
            chg: +t.signed_change_rate * 100,
            vol: +t.acc_trade_price_24h || 0,
            market: t.market
          });
        }
      }
      rows.sort((a,b)=> b.vol-a.vol);
      state.tableData = rows;
      renderTable(rows);
    }

    function renderTable(rows){
      $tbody.innerHTML = rows.map(r=>{
        const c = r.chg>0?'up':(r.chg<0?'down':'');
        return `<tr data-market="${r.market}">
          <td class="mono">${r.sym}</td>
          <td>${r.kor}</td>
          <td class="right mono">${fmt(r.price)}</td>
          <td class="right ${c}">${pct(r.chg)}</td>
          <td class="right mono">${fmt(r.vol,0)}원</td>
        </tr>`
      }).join('');
      [...$tbody.querySelectorAll('tr')].forEach(tr=>{
        tr.addEventListener('click', ()=> selectMarket(tr.dataset.market));
      });
    }

    function onSearch(){
      const q = $search.value.trim().toLowerCase();
      const rows = !q ? state.tableData :
        state.tableData.filter(r =>
          r.sym.toLowerCase().includes(q) ||
          r.kor.toLowerCase().includes(q)
        );
      renderTable(rows);
    }

    // 3) 선택 시 세부 계산
    async function selectMarket(market){
      try{
        setStatus(`분석 중… (${market})`);
        state.selected = market;
        const info = state.bySym[market] || {};
        el('sel-name').textContent = info.korean_name || '-';
        el('sel-sym').textContent = market;

        // 최신 호가·체결
        const t = await fetch(API.ticker([market])).then(r=>r.json()).then(r=>r[0]);
        const price = +t.trade_price || 0;
        const chg = (+t.signed_change_rate||0)*100;
        const vol24 = +t.acc_trade_price_24h || 0;
        el('sel-price').innerHTML = `<b class="mono">${fmt(price)}</b>`;
        el('sel-chg').innerHTML = `<b class="mono ${chg>0?'up':(chg<0?'down':'')}">${pct(chg)}</b>`;
        el('sel-vol').textContent = fmt(vol24)+'원';

        // 최근 틱 체감강도
        const ticks = await fetch(API.ticks(market, 60)).then(r=>r.json()).catch(()=>[]);
        const upTicks = ticks.filter(x=>x.ask_bid==='BID').length;
        const downTicks = ticks.filter(x=>x.ask_bid==='ASK').length;
        const tickScore = (upTicks - downTicks);
        el('sel-tick').textContent = (tickScore>0?'+':'')+tickScore + ` (${upTicks}/${downTicks})`;

        // 캔들(5분) → EMA20, ATR14, 기울기
        const candles = await fetch(API.candles(5, market, 200)).then(r=>r.json());
        const series = candles.slice().reverse().map(c=>({
          o:+c.opening_price, h:+c.high_price, l:+c.low_price, c:+c.trade_price
        }));

        const ema20 = EMA(series.map(s=>s.c), 20).slice(-1)[0];
        const atr14 = ATR(series, 14).slice(-1)[0];
        const slope = slopePct(EMA(series.map(s=>s.c),20).slice(-6)); // 최근 변화율

        el('ema20').innerHTML = `<b class="mono">${fmt(ema20)}</b>`;
        el('atr14').innerHTML = `<b class="mono">${fmt(atr14)}</b>`;
        el('emaSlope').innerHTML = `<b class="mono ${slope>0?'up':(slope<0?'down':'')}">${slope.toFixed(2)}%</b>`;

        // 블랙스완(비정상 변동) 간단 감지: 최근 5봉 중 고저폭>평균+2*표준편차
        const ranges = series.slice(-20).map(x=>x.h-x.l);
        const avg = mean(ranges), sd = std(ranges);
        const lastR = series.slice(-1)[0].h - series.slice(-1)[0].l;
        const black = lastR > (avg + 2*sd);
        el('black').innerHTML = black ? '<b class="warn">주의 (변동 급증)</b>' : '<span class="muted">정상</span>';

        // 손절/타점/위험도/한마디
        const st = Math.max(price - atr14*1.0, 1);   // 손절 = 가격 - ATR
        el('stop').innerHTML = `<b class="mono">${fmt(st)}</b>`;

        // 매수: EMA20 ± (ATR*0.25, 0.5, 0.8)
        setList('buys', [
          `EMA20 근처 눌림: ${fmt(ema20)}`,
          `분할①: ${fmt(ema20 - atr14*0.25)}  / 분할②: ${fmt(ema20 - atr14*0.5)}`,
          `돌파 재진입: ${fmt(ema20 + atr14*0.8)} (추세 가속시)`
        ]);

        // 매도: 현재가 + ATR×(1.0, 1.6, 2.2)
        setList('sells', [
          `TP1: ${fmt(price + atr14*1.0)}`,
          `TP2: ${fmt(price + atr14*1.6)}`,
          `TP3: ${fmt(price + atr14*2.2)}`
        ]);

        // 위험도: 변동성/가격 + 24h 등락/틱 강도 종합 (0~5 낮음 → 5 높음)
        const volRisk = clamp((atr14/Math.max(1,price))*100*8, 0, 5);
        const chgRisk = clamp(Math.abs(chg)/6, 0, 5);
        const tickRisk = clamp(Math.abs(tickScore)/20, 0, 5);
        const risk = clamp((volRisk*0.5 + chgRisk*0.3 + tickRisk*0.2), 0, 5);
        el('risk').innerHTML = `<b>${risk.toFixed(1)} / 5.0</b>`;

        // 쩔어한마디
        let msg = '대기';
        if (risk<=1.5 && price>=ema20 && slope>0) msg = '추세 우상향, 눌림·돌파 매수 유효';
        else if (risk<=2.5 && price>=ema20*0.99) msg = '중립~완만한 우상향, 분할 접근';
        else if (risk>=3.5 && slope<0) msg = '변동/약세 구간. 관망 또는 소량만';
        if (black) msg = '변동 급증(블랙스완). 진입 자제/짧은 손절 필수';
        el('comment').textContent = msg;

        setStatus("정상 연결", true);
      }catch(e){
        console.error(e);
        setStatus("연결 실패", false);
      }
    }

    function setList(id, items){
      el(id).innerHTML = items.map(s=>`<li>${s}</li>`).join('');
    }

    // === 지표 계산 ===
    function EMA(arr, p){
      if(arr.length===0) return [];
      const k = 2/(p+1);
      const out = []; let prev = arr[0];
      for(let i=0;i<arr.length;i++){
        const v = i===0 ? arr[0] : (arr[i]*k + prev*(1-k));
        out.push(v); prev = v;
      }
      return out;
    }
    function ATR(series, p){
      if(series.length===0) return [];
      const TR = [];
      for(let i=0;i<series.length;i++){
        const s=series[i], prev=series[i-1]||series[i];
        const tr = Math.max(s.h-s.l, Math.abs(s.h-prev.c), Math.abs(s.l-prev.c));
        TR.push(tr);
      }
      // RMA(=EMA with alpha=1/p but 초기값은 단순평균)
      const out=[]; let rma = mean(TR.slice(0,p));
      for(let i=0;i<TR.length;i++){
        if(i<p) out.push(TR[i]);
        else { rma = (rma*(p-1)+TR[i])/p; out.push(rma); }
      }
      return out;
    }
    const mean=a=> a.reduce((x,y)=>x+y,0)/Math.max(1,a.length);
    const std=a=>{const m=mean(a); return Math.sqrt(mean(a.map(x=>(x-m)*(x-m))));}
    const clamp=(x,min,max)=> Math.max(min, Math.min(max,x));
    function slopePct(arr){ // 마지막→처음 기울기(%)
      if(arr.length<2) return 0;
      const a = arr[arr.length-1], b = arr[0];
      return (a-b)/Math.max(1,b)*100;
    }

    // 시작
    init();
  </script>
</body>
</html>
