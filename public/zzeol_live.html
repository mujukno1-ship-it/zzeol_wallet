<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>쩔어지갑 🔥 v10.4 — Upbit KRW 실시간</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1117; --card:#151b23; --text:#e6edf3; --muted:#9fb0c0;
      --accent:#74c0fc; --good:#2ecc71; --bad:#ff6b6b; --warn:#ffd43b;
      --line:#293241;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand{font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--muted);font-size:12px}
    .status{margin-left:auto;color:#6ef3a3}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    .row{display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--line)}
    .row:first-of-type{border-top:0}
    .pill{display:inline-block;padding:2px 8px;border-radius:10px;background:#0f1720;color:var(--muted);font-size:12px;border:1px solid var(--line)}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    input[type="text"]{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:#0f1720;color:var(--text);font-size:18px}
    input::placeholder{color:#708197}
    button{cursor:pointer;background:transparent;color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:10px}
    button:hover{background:#0f1720}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-top:1px solid var(--line);text-align:left}
    tbody tr:hover{background:#0f1720;cursor:pointer}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px}
    .k{text-align:left;color:var(--muted)}
    .v{text-align:right}
    ul.dots{margin:0;padding-left:16px}
    ul.dots li{margin:2px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">쩔어지갑 🔥</div>
    <span class="badge">v10.4</span>
    <span class="badge">Upbit KRW 실시간</span>
    <span id="ws-status" class="status badge">상태: 연결 준비</span>
  </div>

  <div class="grid">
    <!-- 좌: 검색/유동성/매수·매도 타점 -->
    <div class="card">
      <div class="title">코인 검색</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="q" type="text" placeholder="예: 비트코인, ETH, SOL, 시바이누 등 (한글/영문/심볼 입력)"/>
        <button id="btn-refresh">KRW 목록 새로고침</button>
      </div>
      <div class="muted" style="margin-top:8px">KRW 마켓만 표시. 행 클릭 시 상세·신호 즉시 갱신.</div>
    </div>

    <div class="card">
      <div class="title">선택 코인</div>
      <div class="kvs">
        <div class="k">이름</div><div id="sel-name" class="v muted">-</div>
        <div class="k">심볼</div><div id="sel-symbol" class="v muted">-</div>
        <div class="k">현재가</div><div id="sel-price" class="v">-</div>
        <div class="k">등락률(24h)</div><div id="sel-change" class="v">-</div>
        <div class="k">거래대금(24h)</div><div id="sel-vol24" class="v">-</div>
        <div class="k">틱 체감강도</div><div id="sel-tick" class="v">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">유동성·변동성</div>
      <div class="kvs">
        <div class="k">EMA20</div><div id="ema20" class="v muted">-</div>
        <div class="k">ATR(14)</div><div id="atr14" class="v muted">-</div>
        <div class="k">EMA 기울기</div><div id="emaSlope" class="v muted">-</div>
        <div class="k">블랙스완 감지</div><div id="blk" class="v warn muted">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">손절·위험도·쩔어한마디</div>
      <div class="kvs">
        <div class="k">손절</div><div id="risk-stop" class="v">-</div>
        <div class="k">위험도</div><div id="risk-score" class="v">-</div>
        <div class="k">쩔어한마디</div><div id="quip" class="v">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">매수 타점</div>
      <ul id="buy-ul" class="dots">
        <li>• -</li><li>• -</li><li>• -</li>
      </ul>
      <div class="muted" style="margin-top:8px">기본 룰: EMA20 근처 눌림 + ATR 기반 분할진입.</div>
    </div>

    <div class="card">
      <div class="title">매도(익절) 타점</div>
      <ul id="sell-ul" class="dots">
        <li>• -</li><li>• -</li><li>• -</li>
      </ul>
      <div class="muted" style="margin-top:8px">기본 룰: 현재가 기준 ATR×(1.0, 1.6, 2.2) 목표.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="title">KRW 코인 목록 (실시간)</div>
    <table id="tbl">
      <thead><tr>
        <th style="width:90px">심볼</th>
        <th>코인명(한글)</th>
        <th style="width:140px">현재가</th>
        <th style="width:100px">등락률</th>
        <th style="width:180px">거래대금(24h)</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ======================= 환경설정 ======================= */
const API_BASE = '/upbit';  // ← 프록시 경로(다르면 이 줄만 수정)

/* ======================= 유틸 ======================= */
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function fmtKRW(n){
  if(n==null || isNaN(n)) return '-';
  const v = Number(n);
  if (v >= 100) return Math.round(v).toLocaleString() + '원';
  if (v >= 1)   return v.toFixed(2).toLocaleString() + '원';
  // 1원 미만: 소수 8자리까지, 뒤 0 제거
  let s = v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
  return s + '원';
}
const pct = x => (Number(x)*100).toFixed(2) + '%';
const krw = x => Number(x??0).toLocaleString() + '원';

function setText(id, val){
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function setBullets(ulId, arr){
  const ul = document.getElementById(ulId);
  if (!ul) return;
  const lis = ul.querySelectorAll('li');
  for(let i=0;i<3;i++){
    const v = arr[i] ?? '-';
    if(lis[i]) lis[i].textContent = '• ' + v;
  }
}

/* ============ 간단 타점/리스크 (EMA/ATR 없이도 동작) ============ */
function calcTargets(price){
  const p = Number(price);
  const buys  = [0.985, 0.97, 0.955].map(m => fmtKRW(Math.max(p*m,0)));
  const sells = [1.01, 1.02, 1.03].map(m => fmtKRW(p*m));
  return {buys, sells};
}
function calcRisk(price, vol24){
  let score = 0.7;
  if (Number(vol24) > 1e11) score += 0.6; // 1000억원+
  if (Number(price) < 1)    score += 0.4; // 1원 미만
  if (score > 5) score = 5;
  const oneLiner = score < 1.2 ? '안정 구간(분할매수 유리)'
                 : score < 2.2 ? '중립 구간(추세 확인)'
                 : '고위험 구간 — 손절엄수';
  return {score: score.toFixed(1)+' / 5.0', stop: '최근 저점 이탈시', oneLiner};
}

/* ======================= API ======================= */
async function getMarkets(){
  const r = await fetch(`${API_BASE}/market/all?isDetails=true`);
  if(!r.ok) throw new Error('markets '+r.status);
  return r.json();
}
async function getTicker(market){ // market: KRW-BTC
  const r = await fetch(`${API_BASE}/ticker?markets=${market}`);
  if(!r.ok) throw new Error('ticker '+r.status);
  const j = await r.json();
  return j && j[0];
}

/* ======================= 목록/선택 채우기 ======================= */
let KRW_LIST = [];

async function fillTable(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '<tr><td colspan="5" class="muted">불러오는 중…</td></tr>';
  let mk;
  try{
    mk = await getMarkets();
  }catch(e){
    tb.innerHTML = `<tr><td colspan="5" class="muted">목록 로드 실패. 잠시 후 자동 재시도 (${e})</td></tr>`;
    await sleep(2500); return fillTable();
  }
  KRW_LIST = mk.filter(m => m.market.startsWith('KRW-'));
  // 상위 60개만 우선 표시(성능/쿼터 보호)
  const list = KRW_LIST.slice(0, 60);

  const rows = await Promise.all(list.map(async m=>{
    try{
      const t = await getTicker(m.market);
      const price = fmtKRW(t.trade_price);
      const change = t.signed_change_rate>=0 ? `<span class="good">${pct(t.signed_change_rate)}</span>` 
                                             : `<span class="bad">${pct(t.signed_change_rate)}</span>`;
      const vol = krw(t.acc_trade_price_24h);
      return `<tr data-market="${m.market}" data-korean="${m.korean_name}">
        <td>${m.market.replace('KRW-','')}</td>
        <td>${m.korean_name}</td>
        <td>${price}</td>
        <td>${change}</td>
        <td>${vol}</td>
      </tr>`;
    }catch{
      // 실패해도 기본 행
      return `<tr data-market="${m.market}" data-korean="${m.korean_name}">
        <td>${m.market.replace('KRW-','')}</td>
        <td>${m.korean_name}</td>
        <td>0원</td>
        <td>-</td>
        <td>-</td>
      </tr>`;
    }
  }));
  tb.innerHTML = rows.join('');

  // 행 클릭 → 우측 패널 채우기
  tb.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const sym = tr.dataset.market;
      selectSymbol(sym);
    });
  });
}

async function selectSymbol(marketOrSym){
  const market = marketOrSym.startsWith('KRW-') ? marketOrSym : ('KRW-'+marketOrSym.toUpperCase());
  // 이름 찾아두기
  const found = KRW_LIST.find(x=>x.market===market);
  setText('sel-name', found ? found.korean_name : '-');
  setText('sel-symbol', market.replace('KRW-',''));

  try{
    const t = await getTicker(market);
    const price = t.trade_price;
    setText('sel-price', fmtKRW(price));
    const ch = pct(t.signed_change_rate);
    document.getElementById('sel-change').innerHTML = (t.signed_change_rate>=0?`<span class="good">${ch}</span>`:`<span class="bad">${ch}</span>`);
    setText('sel-vol24', krw(t.acc_trade_price_24h));
    setText('sel-tick', (t.signed_change_price ? Math.round(t.signed_change_price) : 0) + ' (가중)');

    // 타점/리스크
    const tg = calcTargets(price);
    setBullets('buy-ul', tg.buys);
    setBullets('sell-ul', tg.sells);
    const risk = calcRisk(price, t.acc_trade_price_24h);
    setText('risk-stop',  risk.stop);
    setText('risk-score', risk.score);
    setText('quip',       risk.oneLiner);
  }catch(e){
    setText('sel-price','-'); setText('sel-change','-'); setText('sel-vol24','-'); setText('sel-tick','-');
    setBullets('buy-ul',['-','-','-']); setBullets('sell-ul',['-','-','-']);
    setText('risk-stop','-'); setText('risk-score','-'); setText('quip','-');
  }
}

/* ======================= 바인딩/시작 ======================= */
document.getElementById('btn-refresh').addEventListener('click', fillTable);
document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const v = e.target.value.trim();
    if(!v) return;
    // 한글/영문/심볼 모두 허용
    // 심볼이 아니면 한국어 이름에서 매칭
    const exact = KRW_LIST.find(x=>x.market==='KRW-'+v.toUpperCase());
    if (exact) return selectSymbol(exact.market);
    const byKo = KRW_LIST.find(x=>x.korean_name.replace(/\s/g,'')===v.replace(/\s/g,''));
    if (byKo)   return selectSymbol(byKo.market);
    // 모르면 일단 입력을 심볼로 시도
    selectSymbol(v);
  }
});

// 시작 루틴
(async function boot(){
  setText('ws-status','상태: 연결 중…');
  await fillTable();
  setText('ws-status','상태: 정상 연결');
  // 0원 교정/갱신을 위해 주기적으로 테이블 일부 갱신(부하 과하지 않게)
  setInterval(fillTable, 60_000);
})();
</script>
</body>
</html>
