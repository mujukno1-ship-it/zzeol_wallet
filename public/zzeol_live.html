<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.3 â€” Upbit KRW ì‹¤ì‹œê°„ (íƒ€ì Â·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””)</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{--bg:#0d1117;--card:#121826;--muted:#98a2b3;--text:#e6edf3;--line:#1f2633;--up:#12e4a7;--dn:#ff6767;--warn:#f5a524;--accent:#4da3ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,AppleSDGothicNeo,'Noto Sans KR',Pretendard,Segoe UI}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0;font-weight:800}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:var(--card);border-radius:999px;padding:6px 10px;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin:12px 0}
  @media (max-width:1024px){.row{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .title{color:var(--muted);font-size:12px;margin-bottom:6px}
  .val{font-size:18px;font-weight:800}
  .note{color:var(--muted);font-size:12px;margin-top:6px}
  input,select,button{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1420;color:var(--text);padding:0 12px}
  button{cursor:pointer;background:#0f1525}
  button.primary{background:var(--accent);border-color:transparent;color:#001428;font-weight:800}
  table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line)}
  th{color:var(--muted);text-align:left;background:#0f1522;font-weight:700}
  tbody tr:hover{background:#0f1728}
  .right{text-align:right}
  .up{color:var(--up)} .dn{color:var(--dn)} .warn{color:var(--warn)}
  .badge{display:inline-block;padding:2px 8px;border-radius:8px;background:#0b1220;border:1px solid var(--line);color:#bcd1ff}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .risk{display:flex;gap:6px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);background:#0b1220;border-radius:999px;padding:4px 8px;font-size:12px;color:#a9b3c5}
  .mono{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.3 â€” Upbit KRW ì‹¤ì‹œê°„</h1>
    <span id="conn" class="chip">ìƒíƒœ: ì—°ê²° ì‹œë„ ì¤‘â€¦</span>
    <span class="chip">ê²½ë¡œ: /public/zzeol_live.html</span>
    <span class="chip">ë¶„ë´‰:
      <select id="tf">
        <option value="5">5ë¶„</option>
        <option value="15">15ë¶„</option>
        <option value="60">1ì‹œê°„</option>
      </select>
    </span>
    <span class="chip">ì„±í–¥:
      <select id="mode">
        <option value="balanced">ê¸°ë³¸í˜•</option>
        <option value="conservative">ë³´ìˆ˜í˜•</option>
        <option value="aggressive">ê³µê²©í˜•</option>
      </select>
    </span>
  </header>

  <!-- ê²€ìƒ‰ + ì„ íƒ/ì‹œì„¸/ë“±ë½/ê±°ë˜ëŒ€ê¸ˆ -->
  <div class="row">
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼)</div>
      <div class="grid2" style="gap:8px">
        <input id="q" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ETH, SOL ë“±" />
        <button id="reset">ì´ˆê¸°í™”</button>
      </div>
      <div class="note">KRW ë§ˆì¼“ë§Œ ê²€ìƒ‰/í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·íƒ€ì  ê°±ì‹ .</div>
    </div>
    <div class="card"><div class="title">ì„ íƒ ì½”ì¸</div><div id="sel" class="val">-</div></div>
    <div class="card"><div class="title">í˜„ì¬ê°€ (KRW)</div><div id="cur" class="val mono">-</div></div>
    <div class="card"><div class="title">ë“±ë½ë¥  (24h)</div><div id="chg" class="val mono">-</div></div>
  </div>

  <!-- ê±°ë˜ëŒ€ê¸ˆ/ì„¸ë ¥/ì¸ê°„/ë¸”ë™ìŠ¤ì™„ ìš”ì•½ -->
  <div class="row">
    <div class="card"><div class="title">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="acc" class="val mono">-</div></div>
    <div class="card"><div class="title">í‹± ì²´ê²°ê°•ë„ (ìµœê·¼)</div><div id="tick" class="val">-</div></div>
    <div class="card"><div class="title">ìœ ë™ì„±ë§µ(ë²½/ê°­)</div><div id="liq" class="val">-</div></div>
    <div class="card"><div class="title">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="bs" class="val">-</div></div>
  </div>

  <!-- íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” -->
  <div class="grid3">
    <div class="card">
      <div class="title">ë§¤ìˆ˜ íƒ€ì </div>
      <div id="buy1" class="val mono">-</div>
      <div id="buy2" class="val mono">-</div>
      <div id="buy3" class="val mono">-</div>
      <div class="note">EMA20 ëˆŒë¦¼ + ê±°ë˜ëŸ‰â†‘ + ì²´ê²°ê°•ë„â†‘ì¼ ë•Œ ìœ íš¨</div>
    </div>
    <div class="card">
      <div class="title">ë§¤ë„(ìµì ˆ) íƒ€ì </div>
      <div id="sell1" class="val mono">-</div>
      <div id="sell2" class="val mono">-</div>
      <div id="sell3" class="val mono">-</div>
    </div>
    <div class="card">
      <div class="title">ì†ì ˆ Â· ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      <div>ì†ì ˆ: <span id="stop" class="val mono">-</span></div>
      <div style="margin-top:8px;">ìœ„í—˜ë„: <span id="riskScore" class="badge">-</span></div>
      <div style="margin-top:8px;">ì©”ì–´í•œë§ˆë””:</div>
      <div id="comment" class="note">-</div>
    </div>
  </div>

  <!-- í‘œ -->
  <div class="row" style="grid-template-columns:1fr;">
    <div class="card">
      <div class="title">KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</div>
      <table>
        <thead>
          <tr>
            <th style="width:90px;">ì‹¬ë³¼</th>
            <th>ì½”ì¸ëª…</th>
            <th class="right" style="width:140px;">í˜„ì¬ê°€</th>
            <th class="right" style="width:120px;">ë“±ë½ë¥ </th>
            <th class="right" style="width:160px;">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
      <div class="note">í–‰ í´ë¦­ ì‹œ ìƒë‹¨ íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” ì¦‰ì‹œ ê°±ì‹ .</div>
    </div>
  </div>
</div>

<script>
/* ===== ê³µí†µ ===== */
const API = location.hostname.endsWith("vercel.app") ? "/api" : "/upbit";
const $ = (s, el=document)=>el.querySelector(s);
const fmtKRW = v => (v==null?'-':Math.round(v).toLocaleString('ko-KR'));
function fmtWonShort(v){
  if(v==null) return '-';
  if(v>=1e12) return (v/1e12).toFixed(1)+'ì¡°';
  if(v>=1e8)  return (v/1e8 ).toFixed(1)+'ì–µ';
  if(v>=1e4)  return (v/1e4 ).toFixed(1)+'ë§Œ';
  return Math.round(v).toLocaleString('ko-KR');
}
function rateText(r){
  if(r==null) return '-';
  const s=(r*100).toFixed(2)+'%';
  return (r>=0? 'â–² '+s : 'â–¼ '+s);
}
function krwTick(price){
  if(price>=2000000) return 1000;
  if(price>=1000000) return 500;
  if(price>=500000)  return 100;
  if(price>=100000)  return 50;
  if(price>=10000)   return 10;
  if(price>=1000)    return 5;
  if(price>=100)     return 1;
  if(price>=10)      return 0.1;
  return 0.01;
}
function roundTick(p){ const t=krwTick(p); return Math.round(p/t)*t; }

/* ===== ìƒíƒœ ===== */
const M = { marketMap:new Map(), rows:new Map(), sel:null, tf:5, mode:'balanced' };

/* ===== ë„¤íŠ¸ì›Œí¬ ===== */
async function jget(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }

/* ===== ë§ˆì¼“/í‘œ ===== */
const tbody = $('#body'); const stateEl = $('#conn');
async function loadMarkets(){
  stateEl.textContent='ìƒíƒœ: ë§ˆì¼“ ë¡œë“œ ì¤‘â€¦';
  const list = await jget(`${API}/market`);
  const krw = list.filter(x=>x.market?.startsWith('KRW-'));
  krw.forEach(x=>{
    const symbol = x.market.split('-')[1];
    M.marketMap.set(x.market, {...x, symbol});
    const tr=document.createElement('tr');
    tr.dataset.market=x.market;
    tr.innerHTML = `
      <td><span class="badge">${symbol}</span></td>
      <td>${x.korean_name}</td>
      <td class="right td-price">-</td>
      <td class="right td-rate">-</td>
      <td class="right td-acc">-</td>`;
    tr.addEventListener('click', onRowClick);
    tbody.appendChild(tr);
    M.rows.set(x.market,tr);
  });
  stateEl.textContent=`ìƒíƒœ: KRW ${krw.length}ì¢…ëª© ë¡œë“œë¨`;
}

/* ===== í‹°ì»¤ ë£¨í”„ ===== */
async function updateTickers(){
  if(M.marketMap.size===0) return;
  const markets = encodeURIComponent([...M.marketMap.keys()].join(','));
  const list = await jget(`${API}/ticker?markets=${markets}`);
  list.forEach(t=>{
    const tr=M.rows.get(t.market); if(!tr) return;
    tr._ticker=t;
    const price=tr.querySelector('.td-price');
    const rate=tr.querySelector('.td-rate');
    const acc =tr.querySelector('.td-acc');
    price.textContent = fmtKRW(t.trade_price);
    rate.textContent  = rateText(t.signed_change_rate);
    rate.className='right td-rate ' + (t.signed_change_rate>0?'up':(t.signed_change_rate<0?'dn':''));
    acc.textContent   = fmtWonShort(t.acc_trade_price_24h);
    // ì„ íƒì½”ì¸ ì¹´ë“œ
    if(M.sel===t.market) setTopCards(t);
  });
  stateEl.textContent='ìƒíƒœ: ì—°ê²°ë¨';
}
let loopBackoff=5000;
async function loop(){ try{ await updateTickers(); loopBackoff=5000; }catch(e){ stateEl.textContent='ìƒíƒœ: ì˜¤ë¥˜Â·ì¬ì‹œë„'; loopBackoff=Math.min(loopBackoff*1.6,30000);} finally{ setTimeout(loop,loopBackoff); }}

/* ===== ì„ íƒì½”ì¸ ì¹´ë“œ ===== */
function setTopCards(t){
  const coin = M.marketMap.get(t.market);
  $('#sel').textContent = `${coin.korean_name} (${coin.symbol})`;
  $('#cur').textContent = fmtKRW(t.trade_price);
  const chg = $('#chg');
  chg.textContent = rateText(t.signed_change_rate);
  chg.className='val mono ' + (t.signed_change_rate>0?'up':(t.signed_change_rate<0?'dn':'')); 
  $('#acc').textContent = fmtWonShort(t.acc_trade_price_24h);
}

/* ===== í–‰ í´ë¦­ â†’ ìƒì„¸ ë¶„ì„ ===== */
async function onRowClick(e){
  const tr = e.currentTarget;
  M.sel = tr.dataset.market;
  if(tr._ticker) setTopCards(tr._ticker);
  // ìƒì„¸ ë¶„ì„(ìº”ë“¤/ì²´ê²°/í˜¸ê°€)
  await analyzeSelected(tr.dataset.market);
}

/* ===== ê²€ìƒ‰ ===== */
$('#q').addEventListener('input',()=>{ const q=$('#q').value.toLowerCase(); M.rows.forEach((tr,m)=>{const c=M.marketMap.get(m); const key=(c.korean_name+' '+c.english_name+' '+c.symbol).toLowerCase(); tr.style.display= key.includes(q)?'':'';}); });
$('#reset').addEventListener('click',()=>{ $('#q').value=''; $('#q').dispatchEvent(new Event('input')); });

/* ===== ì‹¬í™” ë¶„ì„ ëª¨ë“ˆ ===== */
// 1) ìº”ë“¤
async function fetchCandles(market, unit=5, count=240){
  const data = await jget(`https://api.upbit.com/v1/candles/minutes/${unit}?market=${market}&count=${Math.min(count,200)}`);
  // ìµœì‹ â†’ê³¼ê±°ë¼ ì—­ìˆœ ì •ë ¬
  const arr = data.slice().reverse().map(x=>({t:x.timestamp,o:x.opening_price,h:x.high_price,l:x.low_price,c:x.trade_price,v:x.candle_acc_trade_volume}));
  return arr;
}
// 2) ì²´ê²°(í‹±) â€” ìµœê·¼ 120í‹±
async function fetchTrades(market, count=120){
  const data = await jget(`https://api.upbit.com/v1/trades/ticks?market=${market}&count=${Math.min(count,200)}`);
  // ìµœì‹ â†’ê³¼ê±°
  return data.map(x=>({price:x.trade_price, vol:x.trade_volume, side:x.ask_bid/* 'BID'='ë§¤ìˆ˜ì²´ê²°','ASK'='ë§¤ë„ì²´ê²°' */, ts:x.timestamp}));
}
// 3) í˜¸ê°€(ì˜¤ë”ë¶)
async function fetchOrderbook(market){
  const data = await jget(`https://api.upbit.com/v1/orderbook?markets=${market}`);
  const ob = data[0];
  return ob ? ob : null;
}

/* ===== ì¸ë””ì¼€ì´í„°(ë¦¬í˜ì¸íŠ¸ ì—†ìŒ: ì§ì „ì™„ë£Œë´‰ ê¸°ì¤€) ===== */
const IND = {
  SMA(a,p){ if(a.length<p) return null; let s=0; for(let i=a.length-p;i<a.length;i++) s+=a[i]; return s/p; },
  EMA(a,p){ if(a.length<p) return null; const k=2/(p+1); let e=IND.SMA(a,p); for(let i=p;i<a.length;i++) e=a[i]*k+e*(1-k); return e; },
  RSI(cl,p=14){
    if(cl.length<p+1) return null;
    let g=0,l=0; for(let i=1;i<=p;i++){const ch=cl[i]-cl[i-1]; if(ch>0) g+=ch; else l+=-ch;}
    g/=p; l/=p; let rs=l===0?100:g/l; let rsi=100-100/(1+rs);
    for(let i=p+1;i<cl.length;i++){const ch=cl[i]-cl[i-1]; const G=Math.max(ch,0), L=Math.max(-ch,0); g=(g*(p-1)+G)/p; l=(l*(p-1)+L)/p; rs=l===0?100:g/l; rsi=100-100/(1+rs);}
    return rsi;
  },
  ATR(c,p=14){
    if(c.length<p+1) return null; const TR=[]; for(let i=1;i<c.length;i++){const h=c[i].h,l=c[i].l,pc=c[i-1].c; TR.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); }
    return IND.EMA(TR,p) ?? IND.SMA(TR,p);
  },
  // MACD ë‹¨ìˆœ ë²„ì „
  MACD(cl,fast=12,slow=26,sig=9){
    if(cl.length<slow+sig) return null;
    const emaF = IND.EMA(cl,fast), emaS=IND.EMA(cl,slow); if(emaF==null||emaS==null) return null;
    const macd = emaF-emaS;
    // signal ê·¼ì‚¬
    const macdSeries=[]; for(let i=slow;i<=cl.length;i++){ const ef=IND.EMA(cl.slice(0,i),fast), es=IND.EMA(cl.slice(0,i),slow); macdSeries.push((ef!=null&&es!=null)? ef-es : null); }
    const sigLine = IND.EMA(macdSeries.filter(x=>x!=null),sig);
    return {macd, signal:sigLine, hist: (sigLine!=null? macd-sigLine : null)};
  }
};

/* ===== ê³ ê¸‰ ì‹ í˜¸ (ì²´ê²°ê°•ë„/ìœ ë™ì„±/ë¸”ë™ìŠ¤ì™„/ì¸ê°„ì§€í‘œ) ===== */
function tickStrength(trades){
  if(!trades||!trades.length) return {score:0, text:'-'};
  let buyVol=0, sellVol=0;
  for(const t of trades){ if(t.side==='BID') buyVol+=t.vol; else sellVol+=t.vol; }
  const total = buyVol+sellVol;
  const s = total? (buyVol - sellVol)/total : 0; // -1~+1
  const pct = Math.round((s*100));
  const text = pct>0? `ë§¤ìˆ˜ìš°ìœ„ ${pct}%` : (pct<0? `ë§¤ë„ìš°ìœ„ ${-pct}%` : 'ì¤‘ë¦½');
  return {score:s, text};
}
function liquidityMap(ob, mid){
  if(!ob) return {text:'-', risk:0, walls:[]};
  const asks = ob.orderbook_units.map(x=>({p:x.ask_price, s:x.ask_size}));
  const bids = ob.orderbook_units.map(x=>({p:x.bid_price, s:x.bid_size}));
  // í° ë²½ íƒì§€: ìƒí•˜ 1%ë‚´ ëˆ„ì ì²´ê²°ëŸ‰ í° êµ¬ê°„
  const near = 0.01*mid;
  const nearAsks = asks.filter(x=>x.p-mid<=near && x.p>=mid);
  const nearBids = bids.filter(x=>mid-x.p<=near && x.p<=mid);
  const askWall = nearAsks.sort((a,b)=>b.s-a.s)[0];
  const bidWall = nearBids.sort((a,b)=>b.s-a.s)[0];
  const gap = (()=>{ // ì±… ì–‡ìŒ(ê°­) ì ìˆ˜
    const sTop = (asks[0]?.s||0)+(bids[0]?.s||0);
    const sAvg = (asks.slice(0,5).reduce((a,x)=>a+x.s,0)+bids.slice(0,5).reduce((a,x)=>a+x.s,0))/10;
    return sAvg? (sTop/sAvg) : 0;
  })();
  // ìœ„í—˜: ìœ„ë²½ì´ ë§¤ìš° í¬ë©´ ìƒìŠ¹ ì €í•­â†‘, ì•„ë˜ë²½ ë§¤ìš° í¬ë©´ í•˜ë½ ë°©ì–´â†“
  let risk=0;
  if(askWall && askWall.s > (bids[0]?.s||0)*2) risk+=1;
  if(gap<0.5) risk+=1; // ì–‡ìŒ
  const text = [
    askWall? `ìƒë²½:${Math.round(askWall.p)}(${askWall.s.toFixed(2)})`:'ìƒë²½:-',
    bidWall? `í•˜ë²½:${Math.round(bidWall.p)}(${bidWall.s.toFixed(2)})`:'í•˜ë²½:-',
    gap<0.5? 'ê°­:ì–‡ìŒ':'ê°­:ë³´í†µ'
  ].join(' Â· ');
  return {text, risk:Math.min(risk,2), walls:[askWall,bidWall]};
}
function blackSwan(candles, ob, refBTC){
  // ê¸‰ê²©í•œ ìŠ¤í”„ë ˆë“œ/í˜¸ê°€ì–‡ìŒ + ê¸°ì¤€ìì‚°(BTC) ê¸‰ë½(5m -1.5%â†“) + ATR ìŠ¤íŒŒì´í¬
  const last = candles[candles.length-1], prev=candles[candles.length-2]||last;
  const atr = IND.ATR(candles,14) || 0;
  const atrRel = atr/Math.max(1,last.c);
  let flags=[];
  if(ob){
    const spread = (ob.orderbook_units[0].ask_price - ob.orderbook_units[0].bid_price)/last.c;
    if(spread>0.003) flags.push('ìŠ¤í”„ë ˆë“œâ†‘');
  }
  if(refBTC && refBTC.change<=-0.015) flags.push('BTCê¸‰ë½');
  if(atrRel>0.02) flags.push('ë³€ë™ì„±ìŠ¤íŒŒì´í¬');
  const risk = flags.length>0? 1:0; // ë¸”ë™ìŠ¤ì™„ ê²½ë³´ë©´ ìœ„í—˜ ê°€ì¤‘
  return {text: flags.length? flags.join(' / ') : 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ', risk};
}
function humanProxy(trades){
  // ì†Œì•¡ì²´ê²° ë¹„ì¤‘â†‘ + ê¸‰í•œ ìƒìŠ¹ = êµ°ì¤‘ FOMO / ê¸‰ë½ì‹œ = íŒ¨ë‹‰
  if(!trades||!trades.length) return {text:'-', mood:0};
  const KRW = t=> t.price*t.vol;
  let small=0, large=0, rising=0, falling=0;
  for(let i=0;i<trades.length;i++){
    const v = KRW(trades[i]);
    if(v<500000) small+=1; // 50ë§Œì› ë¯¸ë§Œ
    if(v>50000000) large+=1; // 5ì²œë§Œì› ì´ˆê³¼
    if(i>0){
      if(trades[i].price>trades[i-1].price) rising++;
      else if(trades[i].price<trades[i-1].price) falling++;
    }
  }
  const mood = (small>large? 1:0) * (rising>falling? 1:-1); // 1=FOMO, -1=íŒ¨ë‹‰
  const text = mood>0? 'ê°œë¯¸ FOMO ê¸°ë¥˜' : (mood<0? 'ê°œë¯¸ íŒ¨ë‹‰ ê¸°ë¥˜' : 'ì¤‘ë¦½/í˜¼ì¡°');
  return {text, mood};
}

/* ===== íƒ€ì  ê³„ì‚° (ë¦¬í˜ì¸íŠ¸ X) ===== */
function computeSignals(candles, trades, ob, mode='balanced'){
  if(!candles||candles.length<220) return null;
  const last = candles[candles.length-2]; // ì§ì „ì™„ë£Œë´‰
  const closes = candles.slice(0,-1).map(x=>x.c);
  const vols   = candles.slice(0,-1).map(x=>x.v);

  const ema20=IND.EMA(closes,20), ema50=IND.EMA(closes,50), ema200=IND.EMA(closes,200);
  const rsi14=IND.RSI(closes,14); const macd=IND.MACD(closes);
  const atr14=IND.ATR(candles.slice(0,-1),14); const vma20=IND.SMA(vols,20);

  // ì²´ê²°/í˜¸ê°€ ê¸°ë°˜
  const tks = tickStrength(trades); // -1~+1
  const lq  = liquidityMap(ob, last.c);
  // ë³´ìˆ˜/ê³µê²© íŒŒë¼ë¯¸í„°
  const cfg = {
    volMult: mode==='conservative'? 1.4 : mode==='aggressive'? 1.1 : 1.2,
    rsiMin : mode==='conservative'? 52  : mode==='aggressive'? 48  : 50,
    pullDev: mode==='conservative'? 0.008: mode==='aggressive'? 0.012: 0.01
  };
  const volOK = vma20 && last.v > cfg.volMult * vma20;
  const pullOK = ema20 && Math.abs((last.c-ema20)/ema20) < cfg.pullDev;
  const trendUp = ema20 && ema50 && last.c>ema20 && ema20>ema50 && (!ema200 || last.c>ema200);
  const rsiOK = rsi14 && rsi14>cfg.rsiMin && rsi14<=70;
  const macdOK = macd?.hist!=null && macd.hist>0 && macd.macd>macd.signal;
  const tickOK = tks.score>0.1;          // ì²´ê²°ê°•ë„ ë§¤ìˆ˜ìš°ìœ„
  const liqOK  = lq.risk===0;            // í˜¸ê°€ ì¶©ë¶„Â·ë²½ ì™œê³¡ ì—†ìŒ

  const longEntry = trendUp && rsiOK && macdOK && volOK && pullOK && tickOK && liqOK;

  // ì†ì ˆ/ëª©í‘œ(ATR ê¸°ë°˜ R)
  function swingLow(n=10){ let m=Infinity; for(let i=candles.length-1-n;i<candles.length-1;i++) m=Math.min(m,candles[i].l); return m; }
  const sw = swingLow(10);
  const stop = Math.max(sw - (atr14||0), sw*0.995);
  const R = (last.c - stop);
  const TP1 = roundTick(last.c + 1.0*R);
  const TP2 = roundTick(last.c + 2.0*R);
  const TP3 = roundTick(last.c + 3.0*R);

  // ìœ„í—˜ë„ ìŠ¤ì½”ì–´ (1~5)
  const atrRel = (atr14||0)/Math.max(1,last.c);
  let risk = 1;
  if(atrRel>0.02) risk++;
  if(!liqOK) risk++;
  if(tks.score<0) risk++;
  // ë¸”ë™ìŠ¤ì™„ì€ ë¶„ì„ë‹¨ê³„ì—ì„œ ê°€ì¤‘(ì•„ë˜ setDetailì—ì„œ ì¶”ê°€)

  // ì½”ë©˜íŠ¸
  let comment = "-";
  if(longEntry) comment = "ìƒìŠ¹ì¶”ì„¸ ë‚´ ëˆŒë¦¼ + ê±°ë˜ëŸ‰/ì²´ê²°ê°•ë„ ìš°ìœ„. ë¶„í• ë§¤ìˆ˜ ìœ ë¦¬";
  else if(!trendUp) comment = "ì¶”ì„¸ ì •ë ¬ ëŒ€ê¸°(EMA20/50)";
  else if(!rsiOK) comment = "ëª¨ë©˜í…€ ì•½í•¨(RSI)";
  else if(!macdOK) comment = "MACD í™•ì¸ ëŒ€ê¸°";
  else if(!volOK) comment = "ê±°ë˜ëŸ‰ ë¶€ì¡±";
  else if(!tickOK) comment = "ì²´ê²°ê°•ë„ ë§¤ìˆ˜ ìš°ìœ„ ì•„ë‹˜";
  else if(!liqOK) comment = "í˜¸ê°€ ë²½ ì™œê³¡/ì–‡ìŒ";

  return { entry: longEntry? roundTick(last.c): null, stop: roundTick(stop), tps:[TP1,TP2,TP3], risk, comment, debug:{tks, lq, ema20, ema50, ema200, rsi14, macdHist:macd?.hist??null, atr14, vma20} };
}

/* ===== ìƒì„¸ ì„¸íŠ¸ì—… ===== */
async function analyzeSelected(market){
  try{
    const tf = Number($('#tf').value)||5; M.tf=tf;
    const mode = $('#mode').value||'balanced'; M.mode=mode;

    const [cand, trades, ob] = await Promise.all([
      fetchCandles(market, tf, 260),
      fetchTrades(market, 120),
      fetchOrderbook(market)
    ]);

    // BTC ê¸°ì¤€ ê¸‰ë½ ê°ì§€(ë¸”ë™ìŠ¤ì™„ ë³´ì¡°)
    let btcRef=null;
    try{
      const btc = await fetchCandles('KRW-BTC', 5, 20);
      const last=btc.at(-2), prev=btc.at(-3)||last;
      const ch=(last.c-prev.c)/prev.c;
      btcRef={change: ch};
    }catch(_){}

    // ë³´ì¡° ì§€í‘œ í‘œì‹œ
    const tks = tickStrength(trades);
    $('#tick').textContent = tks.text;
    $('#tick').className = 'val ' + (tks.score>0.1?'up':(tks.score<-0.1?'dn':''));

    const lq = liquidityMap(ob, cand.at(-2).c);
    $('#liq').textContent = lq.text;

    const bs = blackSwan(cand, ob, btcRef);
    $('#bs').textContent = bs.text;
    if(bs.risk) $('#bs').classList.add('warn'); else $('#bs').classList.remove('warn');

    // ë©”ì¸ íƒ€ì 
    const sig = computeSignals(cand, trades, ob, mode);
    // ìœ„í—˜ë„ ê°€ì¤‘(ë¸”ë™ìŠ¤ì™„)
    let risk = Math.min(5, (sig?.risk ?? 3) + (bs.risk?1:0));
    $('#riskScore').textContent = 'Risk ' + risk;

    // ê°’ ë¿Œë¦¬ê¸°
    const p = cand.at(-2).c;
    const buys  = sig?.entry ? [roundTick(sig.entry*0.997), roundTick(sig.entry*0.994), roundTick(sig.entry*0.991)] : [roundTick(p*0.995), roundTick(p*0.990), roundTick(p*0.985)];
    const sells = sig?.tps || [roundTick(p*1.01), roundTick(p*1.015), roundTick(p*1.02)];
    const stops = [sig?.stop ?? roundTick(p*0.982)];

    $('#buy1').textContent = fmtKRW(buys[0]);
    $('#buy2').textContent = fmtKRW(buys[1]);
    $('#buy3').textContent = fmtKRW(buys[2]);

    $('#sell1').textContent = fmtKRW(sells[0]);
    $('#sell2').textContent = fmtKRW(sells[1]);
    $('#sell3').textContent = fmtKRW(sells[2]);

    $('#stop').textContent  = fmtKRW(stops[0]);

    // ì©”ì–´í•œë§ˆë”” (ìƒí™© ì¢…í•©)
    let cm = sig?.comment || '-';
    if(bs.risk) cm += ' Â· âš  ë¸”ë™ìŠ¤ì™„ ì‹ í˜¸ ì£¼ì˜';
    if(tks.score>0.2) cm += ' Â· ì²´ê²°ê°•ë„ ë§¤ìˆ˜ ê°•ì„¸';
    if(lq.risk>0) cm += ' Â· í˜¸ê°€ ì™œê³¡/ì–‡ìŒ ì£¼ì˜';
    $('#comment').textContent = cm;

  }catch(e){
    console.error(e);
    $('#comment').textContent='ë¶„ì„ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/í˜¸ì¶œì œí•œ). ì ì‹œ í›„ ìë™ ì¬ì‹œë„.';
  }
}

/* ===== ì´ˆê¸°í™” ===== */
(async function init(){
  try{
    await loadMarkets();
    // ê¸°ë³¸ ì„ íƒ: BTC ìš°ì„ 
    M.sel = [...M.marketMap.keys()].find(m=>m==='KRW-BTC') || [...M.marketMap.keys()][0];
    const tr = M.rows.get(M.sel); if(tr && tr._ticker) setTopCards(tr._ticker);
    // í•„í„°/ì„¤ì • ì´ë²¤íŠ¸
    $('#tf').addEventListener('change', ()=>{ if(M.sel) analyzeSelected(M.sel); });
    $('#mode').addEventListener('change', ()=>{ if(M.sel) analyzeSelected(M.sel); });
    // ì²« ë¶„ì„
    if(M.sel) await analyzeSelected(M.sel);
    // ë£¨í”„
    await updateTickers(); loop();
  }catch(e){ console.error(e); stateEl.textContent='ìƒíƒœ: ì´ˆê¸° ë¡œë“œ ì‹¤íŒ¨'; }
})();
</script>
</body>
</html>
