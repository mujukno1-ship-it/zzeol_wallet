<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.3.1 â€” KRW ì‹¤ì‹œê°„ (íƒ€ì Â·ìœ„í—˜ë„Â·ì´ˆì •ë°€Â·ëŠê¹€ë°©ì§€)</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{--bg:#0d1117;--card:#121826;--muted:#98a2b3;--text:#e6edf3;--line:#1f2633;--up:#12e4a7;--dn:#ff6767;--warn:#f5a524;--accent:#4da3ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,AppleSDGothicNeo,'Noto Sans KR',Pretendard,Segoe UI}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0;font-weight:800}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:var(--card);border-radius:999px;padding:6px 10px;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin:12px 0}
  @media (max-width:1024px){.row{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .title{color:var(--muted);font-size:12px;margin-bottom:6px}
  .val{font-size:18px;font-weight:800}
  .note{color:var(--muted);font-size:12px;margin-top:6px}
  input,select,button{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1420;color:var(--text);padding:0 12px}
  button{cursor:pointer;background:#0f1525}
  table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line)}
  th{color:var(--muted);text-align:left;background:#0f1522;font-weight:700}
  tbody tr:hover{background:#0f1728}
  .right{text-align:right}
  .up{color:var(--up)} .dn{color:var(--dn)} .warn{color:var(--warn)}
  .badge{display:inline-block;padding:2px 8px;border-radius:8px;background:#0b1220;border:1px solid var(--line);color:#bcd1ff}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .mono{font-variant-numeric:tabular-nums}
  /* ì—°ê²° ìƒíƒœ ìƒ‰ìƒ */
  .state-ok{color:#10e7a0}
  .state-warn{color:#ffd166}
  .state-err{color:#ff6b6b}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.3.1 â€” Upbit KRW ì‹¤ì‹œê°„</h1>
    <span id="conn" class="chip">ìƒíƒœ: ì‹œì‘ì¤‘â€¦</span>
    <span class="chip">ë¶„ë´‰:
      <select id="tf">
        <option value="5">5ë¶„</option>
        <option value="15">15ë¶„</option>
        <option value="60">1ì‹œê°„</option>
      </select>
    </span>
    <span class="chip">ì„±í–¥:
      <select id="mode">
        <option value="balanced">ê¸°ë³¸í˜•</option>
        <option value="conservative">ë³´ìˆ˜í˜•</option>
        <option value="aggressive">ê³µê²©í˜•</option>
        <option value="ultra">ì´ˆì •ë°€(97% ì§€í–¥)</option>
      </select>
    </span>
  </header>

  <div class="row">
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼)</div>
      <div class="grid2">
        <input id="q" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ETH, SOL ë“±" />
        <button id="reset">ì´ˆê¸°í™”</button>
      </div>
      <div class="note">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·íƒ€ì  ê°±ì‹ .</div>
    </div>
    <div class="card"><div class="title">ì„ íƒ ì½”ì¸</div><div id="sel" class="val">-</div></div>
    <div class="card"><div class="title">í˜„ì¬ê°€ (KRW)</div><div id="cur" class="val mono">-</div></div>
    <div class="card"><div class="title">ë“±ë½ë¥  (24h)</div><div id="chg" class="val mono">-</div></div>
  </div>

  <div class="row">
    <div class="card"><div class="title">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="acc" class="val mono">-</div></div>
    <div class="card"><div class="title">í‹± ì²´ê²°ê°•ë„ (ìµœê·¼)</div><div id="tick" class="val">-</div></div>
    <div class="card"><div class="title">ìœ ë™ì„±ë§µ(ë²½/ê°­)</div><div id="liq" class="val">-</div></div>
    <div class="card"><div class="title">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="bs" class="val">-</div></div>
  </div>

  <div class="grid3">
    <div class="card">
      <div class="title">ë§¤ìˆ˜ íƒ€ì </div>
      <div id="buy1" class="val mono">-</div>
      <div id="buy2" class="val mono">-</div>
      <div id="buy3" class="val mono">-</div>
      <div class="note">EMA20 ëˆŒë¦¼ + ê±°ë˜ëŸ‰â†‘ + ì²´ê²°ê°•ë„â†‘ì¼ ë•Œ ìœ íš¨</div>
    </div>
    <div class="card">
      <div class="title">ë§¤ë„(ìµì ˆ) íƒ€ì </div>
      <div id="sell1" class="val mono">-</div>
      <div id="sell2" class="val mono">-</div>
      <div id="sell3" class="val mono">-</div>
    </div>
    <div class="card">
      <div class="title">ì†ì ˆ Â· ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      <div>ì†ì ˆ: <span id="stop" class="val mono">-</span></div>
      <div style="margin-top:8px;">ìœ„í—˜ë„: <span id="riskScore" class="badge">-</span></div>
      <div style="margin-top:8px;">ì©”ì–´í•œë§ˆë””:</div>
      <div id="comment" class="note">-</div>
    </div>
  </div>

  <div class="row" style="grid-template-columns:1fr;">
    <div class="card">
      <div class="title">KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</div>
      <table>
        <thead>
          <tr>
            <th style="width:90px;">ì‹¬ë³¼</th>
            <th>ì½”ì¸ëª…</th>
            <th class="right" style="width:140px;">í˜„ì¬ê°€</th>
            <th class="right" style="width:120px;">ë“±ë½ë¥ </th>
            <th class="right" style="width:160px;">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
      <div class="note">í–‰ í´ë¦­ ì‹œ ìƒë‹¨ íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” ì¦‰ì‹œ ê°±ì‹ .</div>
    </div>
  </div>
</div>

<script>
/* ===== ê³µí†µ/ìœ í‹¸ ===== */
const API = location.hostname.endsWith("vercel.app") ? "/api" : "/upbit";
const $  = (s, el=document)=>el.querySelector(s);
const fmtKRW = v => (v==null?'-':Math.round(v).toLocaleString('ko-KR'));
function fmtWonShort(v){ if(v==null)return'-'; if(v>=1e12)return(v/1e12).toFixed(1)+'ì¡°'; if(v>=1e8)return(v/1e8).toFixed(1)+'ì–µ'; if(v>=1e4)return(v/1e4).toFixed(1)+'ë§Œ'; return Math.round(v).toLocaleString('ko-KR'); }
function rateText(r){ if(r==null)return '-'; const s=(r*100).toFixed(2)+'%'; return (r>=0? 'â–² '+s : 'â–¼ '+s); }
function krwTick(price){ if(price>=2000000)return 1000; if(price>=1000000)return 500; if(price>=500000)return 100; if(price>=100000)return 50; if(price>=10000)return 10; if(price>=1000)return 5; if(price>=100)return 1; if(price>=10)return .1; return .01; }
function roundTick(p){ const t=krwTick(p); return Math.round(p/t)*t; }

/* ===== ì—°ê²° ìƒíƒœ ë±ƒì§€ ===== */
const stateEl = $('#conn');
function setState(mode,msg){
  stateEl.classList.remove('state-ok','state-warn','state-err');
  if(mode==='ok') stateEl.classList.add('state-ok');
  else if(mode==='warn') stateEl.classList.add('state-warn');
  else if(mode==='err') stateEl.classList.add('state-err');
  stateEl.textContent = 'ìƒíƒœ: ' + msg;
}

/* ===== ìƒíƒœ ===== */
const M = { marketMap:new Map(), rows:new Map(), sel:null, tf:5, mode:'balanced' };

/* ===== ë„¤íŠ¸ì›Œí¬ (ì—ëŸ¬ì½”ë“œ ì „ë‹¬) ===== */
async function jget(u){
  const r = await fetch(u,{cache:'no-store'});
  if(!r.ok){ const e = new Error('HTTP '+r.status); e.status=r.status; throw e; }
  return r.json();
}

/* ===== ë§ˆì¼“/í‘œ ===== */
const tbody = $('#body');
async function loadMarkets(){
  setState('warn','ë§ˆì¼“ ë¡œë“œ ì¤‘â€¦');
  const list = await jget(`${API}/market`);
  const krw = list.filter(x=>x.market?.startsWith('KRW-'));
  krw.forEach(x=>{
    const symbol = x.market.split('-')[1];
    M.marketMap.set(x.market, {...x, symbol});
    const tr=document.createElement('tr');
    tr.dataset.market=x.market;
    tr.innerHTML = `
      <td><span class="badge">${symbol}</span></td>
      <td>${x.korean_name}</td>
      <td class="right td-price">-</td>
      <td class="right td-rate">-</td>
      <td class="right td-acc">-</td>`;
    tr.addEventListener('click', onRowClick);
    tbody.appendChild(tr);
    M.rows.set(x.market,tr);
  });
  setState('ok',`KRW ${krw.length}ì¢…ëª© ë¡œë“œë¨`);
}

/* ===== í‹°ì»¤ ë£¨í”„ (ëŠê¹€ ë°©ì§€: ì²­í¬ + ë°±ì˜¤í”„ + 429 ê°ì§€) ===== */
let loopBackoff = 5000;           // ê¸°ë³¸ 5s
let nextTimer    = null;

async function updateTickers(){
  if(M.marketMap.size===0) return;
  const markets = [...M.marketMap.keys()];
  const CHUNK = 110;              // ìš”ì²­ ë¶„í•  (429 ì˜ˆë°©)
  for(let i=0;i<markets.length;i+=CHUNK){
    const part = markets.slice(i,i+CHUNK).join(',');
    const list = await jget(`${API}/ticker?markets=${encodeURIComponent(part)}`);
    list.forEach(t=>{
      const tr=M.rows.get(t.market); if(!tr) return;
      tr._ticker=t;
      tr.querySelector('.td-price').textContent = fmtKRW(t.trade_price);
      const rateEl = tr.querySelector('.td-rate');
      rateEl.textContent  = rateText(t.signed_change_rate);
      rateEl.className='right td-rate ' + (t.signed_change_rate>0?'up':(t.signed_change_rate<0?'dn':''));
      tr.querySelector('.td-acc').textContent   = fmtWonShort(t.acc_trade_price_24h);
      if(M.sel===t.market) setTopCards(t);
    });
  }
  setState('ok','ì—°ê²°ë¨ âœ…');
}

async function loop(){
  try{
    await updateTickers();
    // ì„±ê³µ â†’ í´ë§ í…€ íšŒë³µ(ìµœì†Œ 5s)
    loopBackoff = 5000;
  }catch(e){
    // ì—ëŸ¬ ìœ í˜•ë³„ ë°±ì˜¤í”„
    if(e && e.status==429){
      // ë ˆì´íŠ¸ ì œí•œ â†’ 15~20së¡œ ëŠ˜ë¦¼
      loopBackoff = Math.max(loopBackoff, 20000);
      setState('warn',`ì¬ì‹œë„ì¤‘(429)â€¦ ${Math.round(loopBackoff/1000)}ì´ˆ`);
    }else{
      loopBackoff = Math.min(Math.max(loopBackoff*1.6, 8000), 30000);
      setState('warn',`ì¬ì‹œë„ì¤‘â€¦ ${Math.round(loopBackoff/1000)}ì´ˆ`);
    }
  }finally{
    clearTimeout(nextTimer);
    nextTimer = setTimeout(loop, loopBackoff);
  }
}

/* ===== ìƒë‹¨ ì¹´ë“œ ===== */
function setTopCards(t){
  const coin = M.marketMap.get(t.market);
  $('#sel').textContent = `${coin.korean_name} (${coin.symbol})`;
  $('#cur').textContent = fmtKRW(t.trade_price);
  const chg = $('#chg');
  chg.textContent = rateText(t.signed_change_rate);
  chg.className='val mono ' + (t.signed_change_rate>0?'up':(t.signed_change_rate<0?'dn':'')); 
  $('#acc').textContent = fmtWonShort(t.acc_trade_price_24h);
}

/* ===== í–‰ í´ë¦­ â†’ ìƒì„¸ ë¶„ì„ ===== */
async function onRowClick(e){
  const tr = e.currentTarget;
  M.sel = tr.dataset.market;
  if(tr._ticker) setTopCards(tr._ticker);
  await analyzeSelected(tr.dataset.market);
}

/* ===== ê²€ìƒ‰ ===== */
$('#q').addEventListener('input',()=>{
  const q=$('#q').value.toLowerCase();
  M.rows.forEach((tr,m)=>{
    const c=M.marketMap.get(m);
    const key=(c.korean_name+' '+c.english_name+' '+c.symbol).toLowerCase();
    tr.style.display= key.includes(q)?'':'none';
  });
});
$('#reset').addEventListener('click',()=>{ $('#q').value=''; $('#q').dispatchEvent(new Event('input')); });

/* ===== ì‹¬í™” ë¶„ì„ ===== */
async function fetchCandles(market, unit=5, count=260){
  const data = await jget(`https://api.upbit.com/v1/candles/minutes/${unit}?market=${market}&count=${Math.min(count,200)}`);
  return data.slice().reverse().map(x=>({t:x.timestamp,o:x.opening_price,h:x.high_price,l:x.low_price,c:x.trade_price,v:x.candle_acc_trade_volume}));
}
async function fetchTrades(market, count=120){
  const data = await jget(`https://api.upbit.com/v1/trades/ticks?market=${market}&count=${Math.min(count,200)}`);
  return data.map(x=>({price:x.trade_price, vol:x.trade_volume, side:x.ask_bid, ts:x.timestamp}));
}
async function fetchOrderbook(market){
  const data = await jget(`https://api.upbit.com/v1/orderbook?markets=${market}`);
  return data[0]||null;
}

/* ===== ì¸ë””ì¼€ì´í„° ===== */
const IND = {
  SMA(a,p){ if(a.length<p) return null; let s=0; for(let i=a.length-p;i<a.length;i++) s+=a[i]; return s/p; },
  EMA(a,p){ if(a.length<p) return null; const k=2/(p+1); let e=IND.SMA(a,p); for(let i=p;i<a.length;i++) e=a[i]*k+e*(1-k); return e; },
  RSI(cl,p=14){ if(cl.length<p+1) return null; let g=0,l=0; for(let i=1;i<=p;i++){const ch=cl[i]-cl[i-1]; if(ch>0)g+=ch; else l+=-ch;} g/=p; l/=p; let rs=l===0?100:g/l; let rsi=100-100/(1+rs);
    for(let i=p+1;i<cl.length;i++){const ch=cl[i]-cl[i-1]; const G=Math.max(ch,0), L=Math.max(-ch,0); g=(g*(p-1)+G)/p; l=(l*(p-1)+L)/p; rs=l===0?100:g/l; rsi=100-100/(1+rs);} return rsi; },
  ATR(c,p=14){ if(c.length<p+1) return null; const TR=[]; for(let i=1;i<c.length;i++){const h=c[i].h,l=c[i].l,pc=c[i-1].c; TR.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); } return IND.EMA(TR,p) ?? IND.SMA(TR,p); },
  MACD(cl,fast=12,slow=26,sig=9){ if(cl.length<slow+sig) return null; const emaF=IND.EMA(cl,fast), emaS=IND.EMA(cl,slow); if(emaF==null||emaS==null) return null; const macd=emaF-emaS;
    const macdSeries=[]; for(let i=slow;i<=cl.length;i++){const ef=IND.EMA(cl.slice(0,i),fast), es=IND.EMA(cl.slice(0,i),slow); macdSeries.push((ef!=null&&es!=null)?ef-es:null);} const sigLine=IND.EMA(macdSeries.filter(x=>x!=null),sig);
    return {macd, signal:sigLine, hist:(sigLine!=null? macd-sigLine:null)}; }
};

/* ===== ì„¸ë ¥/ì²´ê²°/ìœ ë™ì„±/ë¸”ë™ìŠ¤ì™„/ì¸ê°„ì§€í‘œ ===== */
function tickStrength(trades){
  if(!trades||!trades.length) return {score:0,text:'-'};
  let buy=0,sell=0; for(const t of trades){ if(t.side==='BID') buy+=t.vol; else sell+=t.vol; }
  const tot=buy+sell, s=tot? (buy-sell)/tot : 0, pct=Math.round(s*100);
  return {score:s, text:(pct>0?`ë§¤ìˆ˜ìš°ìœ„ ${pct}%`:(pct<0?`ë§¤ë„ìš°ìœ„ ${-pct}%`:'ì¤‘ë¦½'))};
}
function liquidityMap(ob, mid){
  if(!ob) return {text:'-',risk:0,walls:[]};
  const asks=ob.orderbook_units.map(x=>({p:x.ask_price,s:x.ask_size}));
  const bids=ob.orderbook_units.map(x=>({p:x.bid_price,s:x.bid_size}));
  const near=0.01*mid;
  const nearAsks=asks.filter(x=>x.p-mid<=near && x.p>=mid);
  const nearBids=bids.filter(x=>mid-x.p<=near && x.p<=mid);
  const askWall=nearAsks.sort((a,b)=>b.s-a.s)[0];
  const bidWall=nearBids.sort((a,b)=>b.s-a.s)[0];
  const sTop=(asks[0]?.s||0)+(bids[0]?.s||0);
  const sAvg=(asks.slice(0,5).reduce((a,x)=>a+x.s,0)+bids.slice(0,5).reduce((a,x)=>a+x.s,0))/10;
  const gap = sAvg? (sTop/sAvg) : 0;
  let risk=0; if(askWall && askWall.s>(bids[0]?.s||0)*2) risk+=1; if(gap<0.5) risk+=1;
  const text=[ askWall?`ìƒë²½:${Math.round(askWall.p)}(${askWall.s.toFixed(2)})`:'ìƒë²½:-',
               bidWall?`í•˜ë²½:${Math.round(bidWall.p)}(${bidWall.s.toFixed(2)})`:'í•˜ë²½:-',
               gap<0.5?'ê°­:ì–‡ìŒ':'ê°­:ë³´í†µ' ].join(' Â· ');
  return {text,risk:Math.min(risk,2),walls:[askWall,bidWall]};
}
function blackSwan(candles, ob, refBTC){
  const last=candles.at(-1), prev=candles.at(-2)||last;
  const atr=IND.ATR(candles,14)||0, atrRel=atr/Math.max(1,last.c);
  let flags=[]; if(ob){ const spread=(ob.orderbook_units[0].ask_price-ob.orderbook_units[0].bid_price)/last.c; if(spread>0.003) flags.push('ìŠ¤í”„ë ˆë“œâ†‘'); }
  if(refBTC && refBTC.change<=-0.015) flags.push('BTCê¸‰ë½');
  if(atrRel>0.02) flags.push('ë³€ë™ì„±ìŠ¤íŒŒì´í¬');
  return {text: flags.length? flags.join(' / ') : 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ', risk: (flags.length?1:0)};
}
function humanProxy(trades){
  if(!trades||!trades.length) return {text:'-',mood:0};
  const KRW=t=> t.price*t.vol; let small=0, large=0, rising=0, falling=0;
  for(let i=0;i<trades.length;i++){ const v=KRW(trades[i]); if(v<500000) small++; if(v>50000000) large++; if(i>0){ if(trades[i].price>trades[i-1].price) rising++; else if(trades[i].price<trades[i-1].price) falling++; } }
  const mood=(small>large?1:0)*(rising>falling?1:-1);
  return {text:(mood>0?'ê°œë¯¸ FOMO ê¸°ë¥˜':(mood<0?'ê°œë¯¸ íŒ¨ë‹‰ ê¸°ë¥˜':'ì¤‘ë¦½/í˜¼ì¡°')), mood};
}

/* ===== íƒ€ì  ê³„ì‚° (ë¦¬í˜ì¸íŠ¸ X) + ì´ˆì •ë°€ í”„ë¦¬ì…‹ ===== */
function computeSignals(candles, trades, ob, mode='balanced'){
  if(!candles||candles.length<220) return null;
  const last=candles.at(-2);
  const closes=candles.slice(0,-1).map(x=>x.c);
  const vols  =candles.slice(0,-1).map(x=>x.v);

  const ema20=IND.EMA(closes,20), ema50=IND.EMA(closes,50), ema200=IND.EMA(closes,200);
  const rsi14=IND.RSI(closes,14); const macd=IND.MACD(closes);
  const atr14=IND.ATR(candles.slice(0,-1),14); const vma20=IND.SMA(vols,20);

  const tks=tickStrength(trades); const lq=liquidityMap(ob,last.c);

  // í”„ë¦¬ì…‹ íŒŒë¼ë¯¸í„°
  const cfg = (()=>{
    if(mode==='ultra') return { volMult:1.4, rsiMin:55, pullDev:0.008, tickMin:0.25, liqSafe:true };
    if(mode==='conservative') return { volMult:1.4, rsiMin:52, pullDev:0.008, tickMin:0.10, liqSafe:true };
    if(mode==='aggressive')  return { volMult:1.1, rsiMin:48, pullDev:0.012, tickMin:0.05, liqSafe:false };
    return { volMult:1.2, rsiMin:50, pullDev:0.010, tickMin:0.10, liqSafe:true };
  })();

  const volOK  = vma20 && last.v > cfg.volMult * vma20;
  const pullOK = ema20 && Math.abs((last.c-ema20)/ema20) < cfg.pullDev;
  const trendUp= ema20 && ema50 && last.c>ema20 && ema20>ema50 && (!ema200 || last.c>ema200);
  const rsiOK  = rsi14 && rsi14>cfg.rsiMin && rsi14<=70;
  const macdOK = macd?.hist!=null && macd.hist>0 && macd.macd>macd.signal;
  const tickOK = tks.score >= cfg.tickMin;
  const liqOK  = cfg.liqSafe ? (lq.risk===0) : true;

  const longEntry = trendUp && rsiOK && macdOK && volOK && pullOK && tickOK && liqOK;

  // ì†ì ˆ/ëª©í‘œ
  function swingLow(n=10){ let m=Infinity; for(let i=candles.length-1-n;i<candles.length-1;i++) m=Math.min(m,candles[i].l); return m; }
  const sw=swingLow(10);
  const stop=Math.max(sw-(atr14||0), sw*0.995);
  const R=(last.c-stop);
  const TP1=roundTick(last.c+1.0*R), TP2=roundTick(last.c+2.0*R), TP3=roundTick(last.c+3.0*R);

  // ìœ„í—˜ë„(1~5)
  const atrRel=(atr14||0)/Math.max(1,last.c);
  let risk=1; if(atrRel>0.02) risk++; if(!liqOK) risk++; if(tks.score<0) risk++;
  let comment="-";
  if(longEntry) comment="ìƒìŠ¹ì¶”ì„¸ ë‚´ ëˆŒë¦¼ + ê±°ë˜ëŸ‰/ì²´ê²°ê°•ë„ ìš°ìœ„. ë¶„í• ë§¤ìˆ˜ ìœ ë¦¬";
  else if(!trendUp) comment="ì¶”ì„¸ ì •ë ¬ ëŒ€ê¸°(EMA20/50)";
  else if(!rsiOK) comment="ëª¨ë©˜í…€ ì•½í•¨(RSI)";
  else if(!macdOK) comment="MACD í™•ì¸ ëŒ€ê¸°";
  else if(!volOK) comment="ê±°ë˜ëŸ‰ ë¶€ì¡±";
  else if(!tickOK) comment="ì²´ê²°ê°•ë„ ì•½í•¨";
  else if(!liqOK) comment="í˜¸ê°€ ì™œê³¡/ì–‡ìŒ";

  return { entry: longEntry? roundTick(last.c): null, stop: roundTick(stop), tps:[TP1,TP2,TP3], risk, comment, debug:{tks,lq,ema20,ema50,ema200,rsi14,macdHist:macd?.hist??null,atr14,vma20} };
}

/* ===== ìƒì„¸ ë¶„ì„/í‘œì‹œ ===== */
async function analyzeSelected(market){
  try{
    const tf = Number($('#tf').value)||5; M.tf=tf;
    const mode = $('#mode').value||'balanced'; M.mode=mode;

    const [cand, trades, ob] = await Promise.all([
      fetchCandles(market, tf, 260),
      fetchTrades(market, 120),
      fetchOrderbook(market)
    ]);

    // BTC ê¸‰ë½ ë³´ì¡°
    let btcRef=null;
    try{
      const btc = await fetchCandles('KRW-BTC', 5, 20);
      const last=btc.at(-2), prev=btc.at(-3)||last;
      btcRef={change:(last.c-prev.c)/prev.c};
    }catch(_){}

    const tks = tickStrength(trades);
    $('#tick').textContent = tks.text;
    $('#tick').className = 'val ' + (tks.score>0.1?'up':(tks.score<-0.1?'dn':''));

    const lq = liquidityMap(ob, cand.at(-2).c);
    $('#liq').textContent = lq.text;

    const bs = blackSwan(cand, ob, btcRef);
    $('#bs').textContent = bs.text;
    if(bs.risk) $('#bs').classList.add('warn'); else $('#bs').classList.remove('warn');

    const sig = computeSignals(cand, trades, ob, mode);
    let risk = Math.min(5, (sig?.risk ?? 3) + (bs.risk?1:0));
    $('#riskScore').textContent = 'Risk ' + risk;

    const p = cand.at(-2).c;
    const buys  = sig?.entry ? [roundTick(sig.entry*0.997), roundTick(sig.entry*0.994), roundTick(sig.entry*0.991)] : [roundTick(p*0.995), roundTick(p*0.990), roundTick(p*0.985)];
    const sells = sig?.tps || [roundTick(p*1.01), roundTick(p*1.015), roundTick(p*1.02)];
    const stops = [sig?.stop ?? roundTick(p*0.982)];

    $('#buy1').textContent = fmtKRW(buys[0]);
    $('#buy2').textContent = fmtKRW(buys[1]);
    $('#buy3').textContent = fmtKRW(buys[2]);
    $('#sell1').textContent = fmtKRW(sells[0]);
    $('#sell2').textContent = fmtKRW(sells[1]);
    $('#sell3').textContent = fmtKRW(sells[2]);
    $('#stop').textContent  = fmtKRW(stops[0]);

    let cm = sig?.comment || '-';
    if(bs.risk) cm += ' Â· âš  ë¸”ë™ìŠ¤ì™„ ì‹ í˜¸ ì£¼ì˜';
    if(tks.score>0.2) cm += ' Â· ì²´ê²°ê°•ë„ ë§¤ìˆ˜ ê°•ì„¸';
    if(lq.risk>0) cm += ' Â· í˜¸ê°€ ì™œê³¡/ì–‡ìŒ ì£¼ì˜';
    $('#comment').textContent = cm;

  }catch(e){
    console.error(e);
    $('#comment').textContent='ë¶„ì„ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/í˜¸ì¶œì œí•œ). ì ì‹œ í›„ ìë™ ì¬ì‹œë„.';
  }
}

/* ===== ì´ˆê¸°í™” ===== */
(async function init(){
  try{
    await loadMarkets();
    // ê¸°ë³¸ ì„ íƒ: BTC
    M.sel = [...M.marketMap.keys()].find(m=>m==='KRW-BTC') || [...M.marketMap.keys()][0];
    const tr = M.rows.get(M.sel); if(tr && tr._ticker) setTopCards(tr._ticker);

    $('#tf').addEventListener('change', ()=>{ if(M.sel) analyzeSelected(M.sel); });
    $('#mode').addEventListener('change', ()=>{ if(M.sel) analyzeSelected(M.sel); });

    // ì²« ë¶„ì„ + í‹°ì»¤ ë£¨í”„ ì‹œì‘
    if(M.sel) await analyzeSelected(M.sel);
    await updateTickers();
    setState('ok','ì—°ê²°ë¨ âœ…');
    loop();
  }catch(e){ console.error(e); setState('err','ì´ˆê¸° ë¡œë“œ ì‹¤íŒ¨ âŒ'); }
})();
</script>
</body>
</html>
