<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b0f17;--card:#121a26;--muted:#98a2b3;--txt:#e6edf3;--line:#1f2633;
      --up:#00d08a;--dn:#ff5c5c;--acc:#4aa8ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial;letter-spacing:.1px}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .brand{font-weight:800}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:999px}
    .ok{color:var(--up)} .bad{color:var(--dn)} .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .big{font-weight:700;font-size:16px}
    input,button,select{border:1px solid var(--line);background:var(--bg);color:var(--txt);height:36px;border-radius:10px}
    input{padding:0 12px;width:100%}
    button{padding:0 12px;cursor:pointer}
    .searchbar{display:grid;grid-template-columns:1fr auto;gap:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-variant-numeric:tabular-nums}
    th{color:var(--muted);text-align:left}
    .tr{cursor:pointer} .tr:hover{background:#0f1624}
    .up{color:var(--up)} .dn{color:var(--dn)}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:var(--bg)}
    .kv{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #1a2331}
    .kv:last-child{border-bottom:0}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .right{justify-self:end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ì©”ì–´ì§€ê°‘ ğŸ”¥</div>
      <div class="chip">v10.4</div>
      <div id="ws" class="chip muted">ìƒíƒœ: ì—°ê²° ì¤€ë¹„</div>
      <div class="chip">ë¶„ë´‰
        <select id="tf">
          <option value="1">1ë¶„</option>
          <option value="3">3ë¶„</option>
          <option value="5" selected>5ë¶„</option>
          <option value="10">10ë¶„</option>
          <option value="15">15ë¶„</option>
        </select>
      </div>
    </header>

    <!-- ìƒë‹¨: ì¢Œ/ìš° ì •ë³´ -->
    <div class="row">
      <div class="card">
        <div class="title">ì½”ì¸ ê²€ìƒ‰</div>
        <div class="searchbar">
          <input id="q" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼. ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ETH, SOL ë“±" />
          <button id="btnReload">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="note">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸ì§€í‘œ ì¦‰ì‹œ ê°±ì‹ .</div>
      </div>

      <div class="card">
        <div class="title">ì„ íƒ ì½”ì¸</div>
        <div class="kv"><span>ì´ë¦„</span><span id="sel-name" class="right">-</span></div>
        <div class="kv"><span>ì‹¬ë³¼</span><span id="sel-sym" class="right">-</span></div>
        <div class="kv"><span>í˜„ì¬ê°€</span><span id="sel-price" class="right">-</span></div>
        <div class="kv"><span>ë“±ë½ë¥ (24h)</span><span id="sel-chg" class="right">-</span></div>
        <div class="kv"><span>ê±°ë˜ëŒ€ê¸ˆ(24h)</span><span id="sel-acc" class="right">-</span></div>
        <div class="kv"><span>í‹± ì²´ê²°ê°•ë„</span><span id="sel-tick" class="right">-</span></div>
      </div>
    </div>

    <!-- ì§€í‘œ/ì‹œê·¸ë„ -->
    <div class="row" style="margin-top:14px">
      <div class="card">
        <div class="title">ìœ ë™ì„±Â·ë³€ë™ì„±</div>
        <div class="grid-2">
          <div class="pill">EMA20: <b id="ema20" class="right">-</b></div>
          <div class="pill">ATR(14): <b id="atr14" class="right">-</b></div>
        </div>
      </div>
      <div class="card">
        <div class="title">ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””</div>
        <div class="grid-3">
          <div class="pill">ì†ì ˆ: <b id="stop" class="right">-</b></div>
          <div class="pill">ìœ„í—˜ë„: <b id="risk" class="right">-</b></div>
          <div class="pill">ì©”ì–´í•œë§ˆë””: <b id="say" class="right">-</b></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="card">
        <div class="title">ë§¤ìˆ˜ íƒ€ì </div>
        <div class="kv"><span>1ì°¨</span><span id="b1" class="right">-</span></div>
        <div class="kv"><span>2ì°¨</span><span id="b2" class="right">-</span></div>
        <div class="kv"><span>3ì°¨</span><span id="b3" class="right">-</span></div>
        <div class="note">ê¸°ë³¸ ë£°: EMA20 ê·¼ì²˜ ëˆŒë¦¼ + ATR ê¸°ë°˜ ë¶„í•  ì ‘ê·¼.</div>
      </div>
      <div class="card">
        <div class="title">ë§¤ë„(ìµì ˆ) íƒ€ì </div>
        <div class="kv"><span>TP1</span><span id="t1" class="right">-</span></div>
        <div class="kv"><span>TP2</span><span id="t2" class="right">-</span></div>
        <div class="kv"><span>TP3</span><span id="t3" class="right">-</span></div>
        <div class="note">ê¸°ë³¸ ë£°: í˜„ì¬ê°€ ê¸°ì¤€ ATRÃ—(1.0, 1.6, 2.2) ëª©í‘œ.</div>
      </div>
    </div>

    <!-- ëª©ë¡ -->
    <div class="card" style="margin-top:14px">
      <div class="title">KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</div>
      <table>
        <thead>
        <tr>
          <th>ì‹¬ë³¼</th>
          <th>ì½”ì¸ëª…(í•œê¸€)</th>
          <th>í˜„ì¬ê°€</th>
          <th>ë“±ë½ë¥ </th>
          <th>ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
        </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const UI = {
      ws: $('#ws'), tf: $('#tf'), q: $('#q'), btnReload: $('#btnReload'), list: $('#list'),
      selName: $('#sel-name'), selSym: $('#sel-sym'), selPrice: $('#sel-price'),
      selChg: $('#sel-chg'), selAcc: $('#sel-acc'), selTick: $('#sel-tick'),
      ema20: $('#ema20'), atr14: $('#atr14'), stop: $('#stop'), risk: $('#risk'), say: $('#say'),
      b1: $('#b1'), b2: $('#b2'), b3: $('#b3'), t1: $('#t1'), t2: $('#t2'), t3: $('#t3')
    };

    // ---------- Upbit API ----------
    const UPBIT = {
      base: 'https://api.upbit.com/v1',
      async json(url){ const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error(r.status); return r.json(); },
      markets(){ return this.json(this.base+'/market/all?isDetails=true'); },
      ticker(mkts){ return this.json(this.base+'/ticker?markets='+mkts.join(',')); },
      candles(unit, mkt, cnt=200){ return this.json(this.base+`/candles/minutes/${unit}?market=${mkt}&count=${cnt}`); },
      trades(mkt, cnt=200){ return this.json(this.base+`/trades/ticks?market=${mkt}&count=${cnt}`); }
    };

    // ---------- utils ----------
    const fmt = n => Number(n).toLocaleString('ko-KR');
    const pct = x => (x>0?'+':'')+(x*100).toFixed(2)+'%';
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

    // EMA / ATR
    function EMA(vals, p=20){
      const k = 2/(p+1); let ema = vals[0]; const out=[ema];
      for(let i=1;i<vals.length;i++){ ema = vals[i]*k + ema*(1-k); out.push(ema); }
      return out;
    }
    function ATR14(ohlc){
      // ohlc: [{c,h,l},{...}]
      const TR=[], len=ohlc.length;
      for(let i=0;i<len;i++){
        const {c:pc=ohlc[i].c, h, l} = ohlc[i], prev = i?ohlc[i-1].c:pc;
        const tr = Math.max(h-l, Math.abs(h-prev), Math.abs(l-prev));
        TR.push(tr);
      }
      // RMA(14)
      const p=14; let rma = TR.slice(0,p).reduce((a,b)=>a+b,0)/p;
      for(let i=p;i<TR.length;i++){ rma = (rma*(p-1)+TR[i])/p; }
      return rma;
    }
    function tickStrength(trades){
      if(!trades || !trades.length) return 0;
      let bid=0, ask=0;
      for(const t of trades){
        const v = Number(t.trade_volume||0);
        if(t.ask_bid==='BID') bid+=v; else ask+=v;
      }
      const s = (bid-ask)/(bid+ask);
      return isFinite(s)? s : 0;
    }

    // ---------- state ----------
    let KRW = [];       // [{market, korean_name, english_name, ...}]
    let TICK = {};      // by market from ticker
    let FILTERED = [];  // filtered list to render

    // ---------- render ----------
    function renderList(arr){
      UI.list.innerHTML = arr.map(row=>{
        const t = TICK[row.market]||{};
        const ch = Number(t.signed_change_rate||0);
        const price = t.trade_price!=null ? fmt(t.trade_price) : '-';
        const acc = t.acc_trade_price_24h!=null ? fmt(Math.round(t.acc_trade_price_24h))+'ì›' : '-';
        return `<tr class="tr" data-m="${row.market}" data-name="${row.korean_name}">
          <td>${row.market.replace('KRW-','')}</td>
          <td>${row.korean_name}</td>
          <td>${price}</td>
          <td class="${ch>0?'up':(ch<0?'dn':'')}">${ch?pct(ch):'-'}</td>
          <td>${acc}</td>
        </tr>`;
      }).join('');
      // í–‰ í´ë¦­ ì´ë²¤íŠ¸
      UI.list.querySelectorAll('.tr').forEach(tr=>{
        tr.addEventListener('click', ()=>selectMarket(tr.dataset.m, tr.dataset.name));
      });
      // âœ… ì²« í–‰ ìë™ ì„ íƒ
      const first = UI.list.querySelector('.tr');
      if(first) first.click();
    }

    // ---------- core: market select ----------
    async function selectMarket(market, name){
      try{
        UI.ws.classList.remove('bad'); UI.ws.classList.add('ok'); UI.ws.textContent = 'ìƒíƒœ: ì •ìƒ ì—°ê²°';
        const unit = Number(UI.tf.value);
        // candles
        const candles = await UPBIT.candles(unit, market, 200);
        const closes = candles.slice().reverse().map(c=>c.trade_price);
        const highs  = candles.slice().reverse().map(c=>c.high_price);
        const lows   = candles.slice().reverse().map(c=>c.low_price);
        const ohlc = closes.map((c,i)=>({c,h:highs[i], l:lows[i]}));

        // ì§€í‘œ
        const ema = EMA(closes,20).pop();
        const atr = ATR14(ohlc);
        // ticker(í˜„ì¬ê°€/ë“±ë½/ê±°ë˜ëŒ€ê¸ˆ)
        const tk = (await UPBIT.ticker([market]))[0];
        // trades (ì‹¤íŒ¨ì‹œ 0 ê°•ë„)
        let trades = []; try{ trades = await UPBIT.trades(market, 120);}catch{ trades = []; }
        const tStr = tickStrength(trades);

        // ë§¤ìˆ˜/ë§¤ë„ íƒ€ì  ê³„ì‚°
        const P = tk.trade_price;
        const buy1 = ema;
        const buy2 = ema - 0.5*atr;
        const buy3 = ema - 1.0*atr;

        const tp1 = P + 1.0*atr;
        const tp2 = P + 1.6*atr;
        const tp3 = P + 2.2*atr;

        // ì†ì ˆ/ìœ„í—˜ë„/ë©˜íŠ¸
        const stop = P - 1.2*atr;
        const vol = atr / P; // ë³€ë™ì„± ë¹„ìœ¨
        const riskScore = clamp( (vol*100) - (tStr*20), 0, 100 ); // 0(ì €ìœ„í—˜)~100(ê³ ìœ„í—˜)
        let riskLabel = 'ë‚®ìŒ';
        if(riskScore>66) riskLabel='ë†’ìŒ'; else if(riskScore>33) riskLabel='ì¤‘ê°„';

        let say = 'ëŒ€ê¸°.';
        if (tStr>0.15 && P>ema) say='ìƒìŠ¹ ì´ˆì…, ëˆŒë¦¼ ë§¤ìˆ˜ ìš°ì„ .';
        else if (tStr<-0.15 && P<ema) say='í•˜ë½ ìš°ìœ„, ë³´ìˆ˜ ì ‘ê·¼.';
        else say='ì¤‘ë¦½ êµ¬ê°„, ë¶„í•  ëŒ€ê¸°.';

        // ì±„ìš°ê¸°
        UI.selName.textContent = name;
        UI.selSym.textContent = market.replace('KRW-','');
        UI.selPrice.textContent = fmt(P);
        UI.selChg.innerHTML = `<span class="${tk.signed_change_rate>0?'up':(tk.signed_change_rate<0?'dn':'')}">${pct(tk.signed_change_rate||0)}</span>`;
        UI.selAcc.textContent = fmt(Math.round(tk.acc_trade_price_24h))+'ì›';
        UI.selTick.innerHTML = (tStr>0?'<span class="up">':'<span class="dn">')+(tStr*100).toFixed(1)+'%</span>';

        UI.ema20.textContent = fmt(ema.toFixed(0));
        UI.atr14.textContent  = fmt(atr.toFixed(0));

        UI.b1.textContent = fmt(buy1.toFixed(0));
        UI.b2.textContent = fmt(buy2.toFixed(0));
        UI.b3.textContent = fmt(buy3.toFixed(0));

        UI.t1.textContent = fmt(tp1.toFixed(0));
        UI.t2.textContent = fmt(tp2.toFixed(0));
        UI.t3.textContent = fmt(tp3.toFixed(0));

        UI.stop.textContent = fmt(stop.toFixed(0));
        UI.risk.textContent = `${riskLabel} (${riskScore.toFixed(0)}%)`;
        UI.say.textContent  = say;

      }catch(e){
        UI.ws.classList.add('bad'); UI.ws.classList.remove('ok'); UI.ws.textContent='ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
        console.error(e);
      }
    }

    // ---------- load KRW list ----------
    async function loadList(){
      UI.ws.textContent='ìƒíƒœ: ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      const all = await UPBIT.markets();
      KRW = all.filter(x=>x.market.startsWith('KRW-'));
      // ticker ì±„ìš°ê¸°
      const chunks = [];
      for(let i=0;i<KRW.length;i+=90) chunks.push(KRW.slice(i,i+90));
      TICK = {};
      for(const ch of chunks){
        const t = await UPBIT.ticker(ch.map(x=>x.market));
        for(const item of t) TICK[item.market]=item;
      }
      FILTERED = KRW.slice();
      applyFilter();
      UI.ws.classList.add('ok'); UI.ws.textContent='ìƒíƒœ: ì •ìƒ ì—°ê²°';
    }

    function applyFilter(){
      const q = UI.q.value.trim().toLowerCase();
      const arr = !q ? FILTERED : FILTERED.filter(x=>{
        const sym = x.market.replace('KRW-','').toLowerCase();
        return x.korean_name.toLowerCase().includes(q) || (x.english_name||'').toLowerCase().includes(q) || sym.includes(q);
      });
      renderList(arr);
    }

    // ---------- events ----------
    UI.q.addEventListener('input', ()=>applyFilter());
    UI.q.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const first = UI.list.querySelector('.tr');
        if(first) first.click();
      }
    });
    UI.btnReload.addEventListener('click', loadList);
    UI.tf.addEventListener('change', ()=>{
      const first = UI.list.querySelector('.tr');
      if(first) first.click();
    });

    // init
    loadList();
  </script>
</body>
</html>
