<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì©”ì–´ì§€ê°‘ ğŸ”¥ í’€ì„¸íŠ¸ 9.2 + Pump Radar (Vercel ì‹¤ì‹œê°„)</title>
<style>
:root{--bg:#0d1117;--card:#161b22;--line:#30363d;--text:#e6edf3;--muted:#9aa4b2;--up:#2ecc71;--down:#e74c3c;--warn:#f39c12}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
.container{max-width:1200px;margin:auto;padding:16px}
h1{margin:8px 0 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-top:10px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,button{background:#151b23;border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px 10px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right;font-size:14px}
th:first-child,td:first-child{text-align:left}
.small{font-size:12px;color:var(--muted)}
.up{color:var(--up)} .down{color:var(--down)} .warn{color:var(--warn)}
.badge{display:inline-block;border:1px solid var(--line);border-radius:20px;padding:2px 8px;margin-left:6px;font-size:12px;background:#12161d}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kv{display:flex;justify-content:space-between;border:1px solid var(--line);border-radius:8px;padding:8px;background:#0f141b}
footer{text-align:center;color:var(--muted);margin:30px 0 10px;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>ì©”ì–´ì§€ê°‘ ğŸ”¥ í’€ì„¸íŠ¸ 9.2 + Pump Radar
    <span id="wsStatus" class="badge">ì—°ê²°ì¤‘...</span>
  </h1>

  <div class="row">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼)" style="flex:1 1 350px">
    <button id="reset">ì´ˆê¸°í™”</button>
  </div>

  <div class="grid" style="margin-top:10px">
    <div class="card"><div class="small">ì„ íƒ ì½”ì¸</div><div id="sel">-</div></div>
    <div class="card"><div class="small">í˜„ì¬ê°€ (KRW)</div><div id="price">-</div></div>
    <div class="card"><div class="small">ë“±ë½ë¥  (24h)</div><div id="chg">-</div></div>
    <div class="card"><div class="small">ê³ ê°€ / ì €ê°€ (24h)</div><div id="hiLo">-</div></div>
    <div class="card"><div class="small">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="acc">-</div></div>
    <div class="card"><div class="small">ìƒíƒœ</div><div id="stat">-</div></div>
  </div>

  <h3 style="margin-top:20px">ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ íƒ€ì  (KRW)</h3>
  <div class="card">
    <table>
      <thead><tr><th>êµ¬ë¶„</th><th>1ì°¨</th><th>2ì°¨</th><th>3ì°¨</th></tr></thead>
      <tbody>
        <tr><td>ë§¤ìˆ˜</td><td id="buy1">-</td><td id="buy2">-</td><td id="buy3">-</td></tr>
        <tr><td>ë§¤ë„</td><td id="sell1">-</td><td id="sell2">-</td><td id="sell3">-</td></tr>
        <tr><td>ì†ì ˆ</td><td id="stop1">-</td><td id="stop2">-</td><td id="stop3">-</td></tr>
      </tbody>
    </table>
    <div class="small" style="margin-top:6px">â€» íƒ€ì ì€ í˜„ì¬ê°€ ê¸°ì¤€ ë™ì  ê³„ì‚° + ì—…ë¹„íŠ¸ í‹±ë‹¨ìœ„ ë°˜ì˜</div>
  </div>

  <h3 style="margin-top:20px">ê¸‰ë“± ë ˆì´ë”</h3>
  <div class="card">
    <div class="row">
      <label class="kv" style="flex:1 1 220px">ê°ì§€ êµ¬ê°„(ì´ˆ)
        <input id="winSec" type="number" min="5" max="120" value="15" style="width:90px">
      </label>
      <label class="kv" style="flex:1 1 220px">ìƒìŠ¹ ì„ê³„ê°’(%)
        <input id="thrPct" type="number" min="0.2" max="10" step="0.1" value="1.2" style="width:90px">
      </label>
      <label class="kv" style="flex:1 1 220px">ì—°ì† í‹± ìˆ˜
        <input id="ticks" type="number" min="1" max="10" value="3" style="width:90px">
      </label>
      <button id="clearRadar">ì´ˆê¸°í™”</button>
    </div>
    <table style="margin-top:10px" id="radarTbl">
      <thead><tr><th>ì‹œê°„</th><th>ì‹¬ë³¼</th><th>í˜„ì¬ê°€</th><th>ë³€í™”</th><th>ë©”ëª¨</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small">ì¡°ê±´: ìµœê·¼ <span id="winTxt">15</span>ì´ˆ ë™ì•ˆ <span id="thrTxt">1.2</span>%â†‘ ë˜ëŠ” ì—°ì† <span id="tickTxt">3</span>í‹± ìƒìŠ¹</div>
  </div>

  <h3 style="margin-top:20px">KRW ì½”ì¸ ëª©ë¡ (Top 50)</h3>
  <div class="card">
    <table id="listTbl">
      <thead><tr><th>ì‹¬ë³¼</th><th>ì½”ì¸ëª…</th><th>í˜„ì¬ê°€</th><th>ë“±ë½ë¥ </th><th>ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>Â© 2025 ì©”ì–´ì§€ê°‘ â€” Upbit ì‹¤ì‹œê°„ | vercel ì—°ë™ë²„ì „</footer>
</div>

<script>
// ============ UTIL ===============
const $ = s => document.querySelector(s);
const fmt = n => Number(n).toLocaleString("ko-KR");
const nowStr = () => new Date().toLocaleTimeString("ko-KR",{hour12:false});

// API ê²½ë¡œ (CORS ìš°íšŒ í¬í•¨)
const API_TRY = [
  "https://thingproxy.freeboard.io/fetch/https://api.upbit.com/v1",
  "https://corsproxy.io/?https://api.upbit.com/v1",
  "https://api.upbit.com/v1"
];

// ë‹¤ì¤‘ fetch ì‹œë„
async function getJSON(path){
  for(const base of API_TRY){
    try{
      const r = await fetch(base+path,{cache:"no-store"});
      if(!r.ok) continue;
      return await r.json();
    }catch(e){continue;}
  }
  throw new Error("API ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
}

// ============ GLOBAL ===============
let markets={}, current="KRW-BTC", ws, wsAlive=false, priceBuf=[], lastPrice=null, upTicks=0;
const WSS="wss://api.upbit.com/websocket/v1";

// ============ INIT =================
init();
async function init(){
  $("#wsStatus").textContent="ì½”ì¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  const all=await getJSON("/market/all?isDetails=false");
  all.forEach(x=>markets[x.market]=x.korean_name);
  buildList();
  setInterval(buildList,4000);
  connectWS();
  bindUI();
  setInterval(pumpScan,1000);
}

function bindUI(){
  $("#q").addEventListener("change",()=>{
    const q=$("#q").value.trim().toUpperCase();
    const code=Object.keys(markets).find(k=>k.includes(q)||markets[k].includes(q));
    if(code) selectSymbol(code);
  });
  $("#reset").onclick=()=>selectSymbol("KRW-BTC");
  $("#clearRadar").onclick=()=>{$("#radarTbl tbody").innerHTML="";priceBuf.length=0;upTicks=0;};
  ["winSec","thrPct","ticks"].forEach(id=>{
    $("#"+id).addEventListener("input",()=>{
      $("#winTxt").textContent=$("#winSec").value;
      $("#thrTxt").textContent=$("#thrPct").value;
      $("#tickTxt").textContent=$("#ticks").value;
    });
  });
}

// ============ WS ===================
function connectWS(){
  try{ws?.close();}catch{}
  ws=new WebSocket(WSS);
  ws.binaryType="arraybuffer";
  ws.onopen=()=>{wsAlive=true;setStatus("WS ì—°ê²°ë¨ â€” ì‹¤ì‹œê°„");subscribeWS();};
  ws.onclose=()=>{wsAlive=false;setStatus("WS ëŠê¹€ â€” REST ë°±ì—…ëª¨ë“œ");setTimeout(connectWS,1500);};
  ws.onmessage=e=>{
    const txt=new TextDecoder().decode(e.data);
    const d=JSON.parse(txt);
    if(d.ty && d.ty!=="ticker") return;
    if(d.cd===current) applyTicker(d);
  };
}
function subscribeWS(){
  if(!wsAlive) return;
  ws.send(JSON.stringify([{ticket:"zzeolwallet"},{type:"ticker",codes:[current]}]));
}
function setStatus(s){$("#wsStatus").textContent=s;}

// ============ TICKER ===============
function applyTicker(d){
  const name=markets[d.cd]||d.cd;
  const price=d.tp||d.trade_price;
  const chg=(d.signed_change_rate*100).toFixed(2);
  const acc=Math.round(d.acc_trade_price_24h||0);
  $("#sel").textContent=`${name} (${d.cd})`;
  $("#price").textContent=fmt(price);
  $("#chg").innerHTML=`<span class="${chg>=0?'up':'down'}">${chg}%</span>`;
  $("#acc").textContent=`${fmt(acc)} KRW`;
  calcTargets(price);
  priceStream(price);
}

// ============ TARGETS ==============
function calcTargets(p){
  const tick=p>=2000000?1000:p>=1000000?500:p>=500000?100:p>=100000?50:p>=10000?10:p>=1000?1:p>=100?0.1:0.01;
  const round=x=>Math.round(x/tick)*tick;
  const buys=[p*0.99,p*0.985,p*0.98].map(round);
  const sells=[p*1.01,p*1.015,p*1.02].map(round);
  const stops=[p*0.985,p*0.975,p*0.965].map(round);
  [buy1,buy2,buy3].forEach((e,i)=>e.textContent=fmt(buys[i]));
  [sell1,sell2,sell3].forEach((e,i)=>e.textContent=fmt(sells[i]));
  [stop1,stop2,stop3].forEach((e,i)=>e.textContent=fmt(stops[i]));
}

// ============ RADAR ================
function priceStream(p){
  const t=Date.now();priceBuf.push({t,p});
  const win=Number($("#winSec").value)*1000;
  while(priceBuf.length&&t-priceBuf[0].t>win)priceBuf.shift();
  if(lastPrice==null){lastPrice=p;return;}
  if(p>lastPrice)upTicks++;else if(p<lastPrice)upTicks=0;
  lastPrice=p;
}
function pumpScan(){
  if(priceBuf.length<2)return;
  const p0=priceBuf[0].p,p1=priceBuf[priceBuf.length-1].p;
  const pct=((p1-p0)/p0)*100;
  const needPct=Number($("#thrPct").value),needTick=Number($("#ticks").value);
  if(pct>=needPct||upTicks>=needTick){
    addRadarRow(current.replace("KRW-",""),p1,`${pct.toFixed(2)}%`,pct>=needPct?"ê¸‰ë“±":"ì—°ì†ìƒìŠ¹");
    upTicks=0;priceBuf.length=0;
  }
}
function addRadarRow(sym,price,changeTxt,memo){
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${nowStr()}</td><td>${sym}</td><td>${fmt(price)}</td><td class="up">${changeTxt}</td><td class="warn">${memo}</td>`;
  $("#radarTbl tbody").prepend(tr);
  $("#stat").innerHTML=`<span class="warn">Pump ê°ì§€: ${sym} (${changeTxt})</span>`;
}

// ============ LIST =================
async function buildList(){
  try{
    const krw=Object.keys(markets).filter(k=>k.startsWith("KRW-"));
    const t=await getJSON("/ticker?markets="+krw.join(","));
    const sorted=t.sort((a,b)=>(b.acc_trade_price_24h||0)-(a.acc_trade_price_24h||0)).slice(0,50);
    $("#listTbl tbody").innerHTML=sorted.map(x=>{
      const ch=((x.signed_change_rate||0)*100).toFixed(2);
      return `<tr><td>${x.market.replace("KRW-","")}</td><td>${markets[x.market]||x.market}</td><td>${fmt(x.trade_price)}</td><td class="${ch>=0?'up':'down'}">${ch}%</td><td>${fmt(Math.round(x.acc_trade_price_24h||0))}</td></tr>`;
    }).join("");
  }catch{ $("#stat").textContent="ëª©ë¡ ê°±ì‹  ì§€ì—°..."; }
}
</script>
</body>
</html>
