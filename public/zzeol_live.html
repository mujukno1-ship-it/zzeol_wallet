<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„ (EMA/ATR/íƒ€ì /ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””)</title>
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg:#0d1117; --card:#121826; --muted:#98a2b3; --text:#e6edf3;
      --line:#1f2633; --up:#14b8a6; --down:#ef4444; --accent:#3b82f6; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .brand{font-weight:800}
    .tag{padding:2px 8px;border:1px solid var(--line);background:var(--card);border-radius:8px}
    .status{margin-left:auto}
    .status.ok{color:var(--up)} .status.bad{color:var(--down)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{color:var(--muted);font-size:12px;margin-bottom:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--bg);border-radius:999px;padding:6px 10px}
    input[type="text"]{width:100%;padding:10px 12px;background:#0b1220;border:1px solid var(--line);color:var(--text);border-radius:8px}
    button{cursor:pointer;background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 12px;font-weight:700}
    button.ghost{background:transparent;border:1px solid var(--line)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px}
    .k{color:var(--muted)}
    .v b{font-weight:800}
    .muted{color:var(--muted)}
    .warn{color:var(--warn)} .up{color:var(--up)} .down{color:var(--down)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-top:1px solid var(--line);padding:10px 8px}
    th{color:var(--muted);text-align:left;font-weight:600;background:#0b1220;position:sticky;top:0}
    tr:hover{background:#0b1220}
    .right{text-align:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .targets{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){.targets{grid-template-columns:1fr}}
    .targets ul{margin:0;padding-left:16px}
    .danger{background:#2a0e12;border-color:#5a1d23}
    .okbox{background:#0e1f21;border-color:#1c3d40}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ì©”ì–´ì§€ê°‘ ğŸ”¥</div>
      <span class="tag">v10.4</span>
      <span class="tag">Upbit KRW ì‹¤ì‹œê°„</span>
      <span class="status tag" id="ws-status">ìƒíƒœ: ì—°ê²° ëŒ€ê¸°</span>
    </header>

    <!-- ê²€ìƒ‰/ì„¤ì • -->
    <div class="grid">
      <div class="card">
        <div class="title">ì½”ì¸ ê²€ìƒ‰</div>
        <div class="row" style="gap:8px">
          <input id="search" type="text" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼: ë¹„íŠ¸ì½”ì¸, ETH, SOL ë“±" />
          <button id="btn-refresh" class="ghost">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="muted" style="margin-top:8px">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·ì‹ í˜¸ ì¦‰ì‹œ ê°±ì‹ .</div>
      </div>

      <div class="card">
        <div class="title">ì„ íƒ ì½”ì¸</div>
        <div class="kvs">
          <div class="k">ì´ë¦„</div><div class="v" id="sel-name">-</div>
          <div class="k">ì‹¬ë³¼</div><div class="v" id="sel-sym">-</div>
          <div class="k">í˜„ì¬ê°€</div><div class="v" id="sel-price">-</div>
          <div class="k">ë“±ë½ë¥ (24h)</div><div class="v" id="sel-chg">-</div>
          <div class="k">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div class="v" id="sel-vol">-</div>
          <div class="k">í‹± ì²´ê°ê°•ë„</div><div class="v" id="sel-tick">-</div>
        </div>
      </div>
    </div>

    <!-- ìœ ë™ì„±/ë³€ë™ì„± & ìœ„í—˜ -->
    <div class="grid">
      <div class="card">
        <div class="title">ìœ ë™ì„±Â·ë³€ë™ì„±</div>
        <div class="kvs">
          <div class="k">EMA20</div><div class="v" id="ema20">-</div>
          <div class="k">ATR(14)</div><div class="v" id="atr14">-</div>
          <div class="k">EMA ê¸°ìš¸ê¸°</div><div class="v" id="emaSlope">-</div>
          <div class="k">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div class="v" id="black">-</div>
        </div>
      </div>

      <div class="card">
        <div class="title">ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””</div>
        <div class="kvs">
          <div class="k">ì†ì ˆ</div><div class="v" id="stop">-</div>
          <div class="k">ìœ„í—˜ë„</div><div class="v" id="risk">-</div>
          <div class="k">ì©”ì–´í•œë§ˆë””</div><div class="v" id="comment">-</div>
        </div>
      </div>
    </div>

    <!-- íƒ€ì  -->
    <div class="grid">
      <div class="card okbox">
        <div class="title">ë§¤ìˆ˜ íƒ€ì </div>
        <ul id="buys">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="muted" style="margin-top:8px">ê¸°ë³¸ ë£°: EMA20 ê·¼ì²˜ ëˆŒë¦¼ + ATR ê¸°ë°˜ ë¶„í• ì§„ì….</div>
      </div>

      <div class="card">
        <div class="title">ë§¤ë„(ìµì ˆ) íƒ€ì </div>
        <ul id="sells">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="muted" style="margin-top:8px">ê¸°ë³¸ ë£°: í˜„ì¬ê°€ ê¸°ì¤€ ATRÃ—(1.0, 1.6, 2.2) ëª©í‘œ.</div>
      </div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ -->
    <div class="card">
      <div class="title">KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</div>
      <table id="list">
        <thead>
          <tr>
            <th>ì‹¬ë³¼</th>
            <th>ì½”ì¸ëª…(í•œê¸€)</th>
            <th class="right">í˜„ì¬ê°€</th>
            <th class="right">ë“±ë½ë¥ </th>
            <th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===============================
    //  API (í”„ë¡ì‹œ ê²½ìœ )  â† ì¤‘ìš”: ì´ 4ì¤„ì´ ë¸Œë¼ìš°ì €-ì—…ë¹„íŠ¸ ì—°ê²° ì‹¤íŒ¨ë¥¼ í•´ê²°
    // ===============================
    const API = {
      markets: "/api/markets",
      ticker:  (ms) => `/api/ticker?ms=${ms.join(",")}`,
      candles: (unit, mkt, count=200) => `/api/candles?unit=${unit}&m=${encodeURIComponent(mkt)}&count=${count}`,
      ticks:   (mkt, count=60) => `/api/ticks?m=${encodeURIComponent(mkt)}&count=${count}`,
    };

    // ìœ í‹¸
    const fmt = (n,d=0)=> n===null||n===undefined||isNaN(n) ? "-" : Number(n).toLocaleString("ko-KR",{maximumFractionDigits:d});
    const pct = (n)=> (n>0? "+" : "") + (isFinite(n)? n.toFixed(2):"-") + "%";
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    // ìƒíƒœ
    const state = {
      markets: [],             // {market,korean_name,english_name}
      krw: [],                 // KRW-*ë§Œ
      bySym: {},               // "KRW-BTC" â†’ { ... }
      tableData: [],           // í…Œì´ë¸” í‘œì‹œìš©
      selected: null,          // ì„ íƒí•œ ë§ˆì¼“
      cacheTicker: new Map(),  // ê°„ë‹¨ ìºì‹œ
    };

    // DOM
    const el = (id)=> document.getElementById(id);
    const $tbody = el('tbody');
    const $status = el('ws-status');
    const $search = el('search');

    async function init() {
      setStatus("ì—°ê²° ì¤‘â€¦");
      try {
        await loadMarkets();          // KRW ëª©ë¡ ë¡œë”©
        await fillTable();            // ê°€ê²©/ë“±ë½/ê±°ë˜ëŒ€ê¸ˆ ì±„ìš°ê¸°
        setStatus("ì •ìƒ ì—°ê²°", true);

        // ê²€ìƒ‰
        $search.addEventListener('input', onSearch);
        document.getElementById('btn-refresh').addEventListener('click', async ()=>{
          setStatus("ëª©ë¡ ìƒˆë¡œê³ ì¹¨â€¦");
          await fillTable(true);
          setStatus("ì •ìƒ ì—°ê²°", true);
        });

      } catch (e) {
        console.error(e);
        setStatus("ì—°ê²° ì‹¤íŒ¨", false);
      }
    }

    function setStatus(msg, ok=false){
      $status.textContent = `ìƒíƒœ: ${msg}`;
      $status.classList.toggle('ok', !!ok);
      $status.classList.toggle('bad', !ok);
    }

    // 1) ë§ˆì¼“ ë¡œë“œ
    async function loadMarkets(){
      const r = await fetch(API.markets);
      if(!r.ok) throw new Error('markets fail');
      const all = await r.json();
      state.markets = all;
      state.krw = all.filter(x=> x.market && x.market.startsWith("KRW-"));
      state.bySym = Object.fromEntries(state.krw.map(x=> [x.market, x]));
    }

    // 2) KRW ëª©ë¡ í…Œì´ë¸” ì±„ìš°ê¸° (ë¶„í•  í˜¸ì¶œ)
    async function fillTable(force=false){
      const syms = state.krw.map(x=> x.market);
      const chunks = [];
      for(let i=0;i<syms.length;i+=20) chunks.push(syms.slice(i,i+20));

      const rows = [];
      for(const part of chunks){
        const cacheKey = part.join(",");
        let data;
        if(!force && state.cacheTicker.has(cacheKey) && (Date.now()-state.cacheTicker.get(cacheKey)._t<3000)){
          data = state.cacheTicker.get(cacheKey);
        }else{
          const r = await fetch(API.ticker(part));
          data = await r.json();
          data._t = Date.now();
          state.cacheTicker.set(cacheKey, data);
          await sleep(120); // ì‚´ì§ ê°„ê²©
        }
        for(const t of data){
          const m = state.bySym[t.market] || { korean_name:"-", market:t.market };
          rows.push({
            sym: t.market.replace("KRW-",""),
            kor: m.korean_name || "-",
            price: +t.trade_price || 0,
            chg: +t.signed_change_rate * 100,
            vol: +t.acc_trade_price_24h || 0,
            market: t.market
          });
        }
      }
      rows.sort((a,b)=> b.vol-a.vol);
      state.tableData = rows;
      renderTable(rows);
    }

    function renderTable(rows){
      $tbody.innerHTML = rows.map(r=>{
        const c = r.chg>0?'up':(r.chg<0?'down':'');
        return `<tr data-market="${r.market}">
          <td class="mono">${r.sym}</td>
          <td>${r.kor}</td>
          <td class="right mono">${fmt(r.price)}</td>
          <td class="right ${c}">${pct(r.chg)}</td>
          <td class="right mono">${fmt(r.vol,0)}ì›</td>
        </tr>`
      }).join('');
      [...$tbody.querySelectorAll('tr')].forEach(tr=>{
        tr.addEventListener('click', ()=> selectMarket(tr.dataset.market));
      });
    }

    function onSearch(){
      const q = $search.value.trim().toLowerCase();
      const rows = !q ? state.tableData :
        state.tableData.filter(r =>
          r.sym.toLowerCase().includes(q) ||
          r.kor.toLowerCase().includes(q)
        );
      renderTable(rows);
    }

    // 3) ì„ íƒ ì‹œ ì„¸ë¶€ ê³„ì‚°
    async function selectMarket(market){
      try{
        setStatus(`ë¶„ì„ ì¤‘â€¦ (${market})`);
        state.selected = market;
        const info = state.bySym[market] || {};
        el('sel-name').textContent = info.korean_name || '-';
        el('sel-sym').textContent = market;

        // ìµœì‹  í˜¸ê°€Â·ì²´ê²°
        const t = await fetch(API.ticker([market])).then(r=>r.json()).then(r=>r[0]);
        const price = +t.trade_price || 0;
        const chg = (+t.signed_change_rate||0)*100;
        const vol24 = +t.acc_trade_price_24h || 0;
        el('sel-price').innerHTML = `<b class="mono">${fmt(price)}</b>`;
        el('sel-chg').innerHTML = `<b class="mono ${chg>0?'up':(chg<0?'down':'')}">${pct(chg)}</b>`;
        el('sel-vol').textContent = fmt(vol24)+'ì›';

        // ìµœê·¼ í‹± ì²´ê°ê°•ë„
        const ticks = await fetch(API.ticks(market, 60)).then(r=>r.json()).catch(()=>[]);
        const upTicks = ticks.filter(x=>x.ask_bid==='BID').length;
        const downTicks = ticks.filter(x=>x.ask_bid==='ASK').length;
        const tickScore = (upTicks - downTicks);
        el('sel-tick').textContent = (tickScore>0?'+':'')+tickScore + ` (${upTicks}/${downTicks})`;

        // ìº”ë“¤(5ë¶„) â†’ EMA20, ATR14, ê¸°ìš¸ê¸°
        const candles = await fetch(API.candles(5, market, 200)).then(r=>r.json());
        const series = candles.slice().reverse().map(c=>({
          o:+c.opening_price, h:+c.high_price, l:+c.low_price, c:+c.trade_price
        }));

        const ema20 = EMA(series.map(s=>s.c), 20).slice(-1)[0];
        const atr14 = ATR(series, 14).slice(-1)[0];
        const slope = slopePct(EMA(series.map(s=>s.c),20).slice(-6)); // ìµœê·¼ ë³€í™”ìœ¨

        el('ema20').innerHTML = `<b class="mono">${fmt(ema20)}</b>`;
        el('atr14').innerHTML = `<b class="mono">${fmt(atr14)}</b>`;
        el('emaSlope').innerHTML = `<b class="mono ${slope>0?'up':(slope<0?'down':'')}">${slope.toFixed(2)}%</b>`;

        // ë¸”ë™ìŠ¤ì™„(ë¹„ì •ìƒ ë³€ë™) ê°„ë‹¨ ê°ì§€: ìµœê·¼ 5ë´‰ ì¤‘ ê³ ì €í­>í‰ê· +2*í‘œì¤€í¸ì°¨
        const ranges = series.slice(-20).map(x=>x.h-x.l);
        const avg = mean(ranges), sd = std(ranges);
        const lastR = series.slice(-1)[0].h - series.slice(-1)[0].l;
        const black = lastR > (avg + 2*sd);
        el('black').innerHTML = black ? '<b class="warn">ì£¼ì˜ (ë³€ë™ ê¸‰ì¦)</b>' : '<span class="muted">ì •ìƒ</span>';

        // ì†ì ˆ/íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë””
        const st = Math.max(price - atr14*1.0, 1);   // ì†ì ˆ = ê°€ê²© - ATR
        el('stop').innerHTML = `<b class="mono">${fmt(st)}</b>`;

        // ë§¤ìˆ˜: EMA20 Â± (ATR*0.25, 0.5, 0.8)
        setList('buys', [
          `EMA20 ê·¼ì²˜ ëˆŒë¦¼: ${fmt(ema20)}`,
          `ë¶„í• â‘ : ${fmt(ema20 - atr14*0.25)}  / ë¶„í• â‘¡: ${fmt(ema20 - atr14*0.5)}`,
          `ëŒíŒŒ ì¬ì§„ì…: ${fmt(ema20 + atr14*0.8)} (ì¶”ì„¸ ê°€ì†ì‹œ)`
        ]);

        // ë§¤ë„: í˜„ì¬ê°€ + ATRÃ—(1.0, 1.6, 2.2)
        setList('sells', [
          `TP1: ${fmt(price + atr14*1.0)}`,
          `TP2: ${fmt(price + atr14*1.6)}`,
          `TP3: ${fmt(price + atr14*2.2)}`
        ]);

        // ìœ„í—˜ë„: ë³€ë™ì„±/ê°€ê²© + 24h ë“±ë½/í‹± ê°•ë„ ì¢…í•© (0~5 ë‚®ìŒ â†’ 5 ë†’ìŒ)
        const volRisk = clamp((atr14/Math.max(1,price))*100*8, 0, 5);
        const chgRisk = clamp(Math.abs(chg)/6, 0, 5);
        const tickRisk = clamp(Math.abs(tickScore)/20, 0, 5);
        const risk = clamp((volRisk*0.5 + chgRisk*0.3 + tickRisk*0.2), 0, 5);
        el('risk').innerHTML = `<b>${risk.toFixed(1)} / 5.0</b>`;

        // ì©”ì–´í•œë§ˆë””
        let msg = 'ëŒ€ê¸°';
        if (risk<=1.5 && price>=ema20 && slope>0) msg = 'ì¶”ì„¸ ìš°ìƒí–¥, ëˆŒë¦¼Â·ëŒíŒŒ ë§¤ìˆ˜ ìœ íš¨';
        else if (risk<=2.5 && price>=ema20*0.99) msg = 'ì¤‘ë¦½~ì™„ë§Œí•œ ìš°ìƒí–¥, ë¶„í•  ì ‘ê·¼';
        else if (risk>=3.5 && slope<0) msg = 'ë³€ë™/ì•½ì„¸ êµ¬ê°„. ê´€ë§ ë˜ëŠ” ì†ŒëŸ‰ë§Œ';
        if (black) msg = 'ë³€ë™ ê¸‰ì¦(ë¸”ë™ìŠ¤ì™„). ì§„ì… ìì œ/ì§§ì€ ì†ì ˆ í•„ìˆ˜';
        el('comment').textContent = msg;

        setStatus("ì •ìƒ ì—°ê²°", true);
      }catch(e){
        console.error(e);
        setStatus("ì—°ê²° ì‹¤íŒ¨", false);
      }
    }

    function setList(id, items){
      el(id).innerHTML = items.map(s=>`<li>${s}</li>`).join('');
    }

    // === ì§€í‘œ ê³„ì‚° ===
    function EMA(arr, p){
      if(arr.length===0) return [];
      const k = 2/(p+1);
      const out = []; let prev = arr[0];
      for(let i=0;i<arr.length;i++){
        const v = i===0 ? arr[0] : (arr[i]*k + prev*(1-k));
        out.push(v); prev = v;
      }
      return out;
    }
    function ATR(series, p){
      if(series.length===0) return [];
      const TR = [];
      for(let i=0;i<series.length;i++){
        const s=series[i], prev=series[i-1]||series[i];
        const tr = Math.max(s.h-s.l, Math.abs(s.h-prev.c), Math.abs(s.l-prev.c));
        TR.push(tr);
      }
      // RMA(=EMA with alpha=1/p but ì´ˆê¸°ê°’ì€ ë‹¨ìˆœí‰ê· )
      const out=[]; let rma = mean(TR.slice(0,p));
      for(let i=0;i<TR.length;i++){
        if(i<p) out.push(TR[i]);
        else { rma = (rma*(p-1)+TR[i])/p; out.push(rma); }
      }
      return out;
    }
    const mean=a=> a.reduce((x,y)=>x+y,0)/Math.max(1,a.length);
    const std=a=>{const m=mean(a); return Math.sqrt(mean(a.map(x=>(x-m)*(x-m))));}
    const clamp=(x,min,max)=> Math.max(min, Math.min(max,x));
    function slopePct(arr){ // ë§ˆì§€ë§‰â†’ì²˜ìŒ ê¸°ìš¸ê¸°(%)
      if(arr.length<2) return 0;
      const a = arr[arr.length-1], b = arr[0];
      return (a-b)/Math.max(1,b)*100;
    }

    // ì‹œì‘
    init();
  </script>
</body>
</html>
