<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>쩔어지갑 Mini — 검색결과 & 실시간 급등코인</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b1117;--card:#121826;--txt:#e6edf3;--mut:#90a4b8;--line:#243044;
    --up:#25d695;--dn:#ff6b6b;--chip:#1a2333;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .title{font-weight:800;margin-bottom:8px}
  .mut{color:var(--mut)}
  .searchbar{display:grid;grid-template-columns:1fr auto;gap:8px}
  input[type="text"]{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:#0e1522;color:var(--txt);font-size:18px}
  button{border:1px solid var(--line);background:var(--chip);color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid var(--line);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  tr:hover{background:#0f1827;cursor:pointer}
  .good{color:var(--up)} .bad{color:var(--dn)}
  .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);color:var(--mut);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>💎 쩔어지갑 Mini</h1>

  <!-- 🔎 검색창 -->
  <div class="card">
    <div class="title">코인 검색</div>
    <div class="searchbar">
      <input id="q" type="text" placeholder="한글/영문/심볼 입력 — 예: 비트코인, SHIB, ETH…" />
      <button id="btnReload">KRW 목록 새로고침</button>
    </div>
    <div class="mut small" style="margin-top:6px">Tip: 엔터를 누르면 첫 결과를 바로 선택해 상세를 띄울 수 있어요.</div>
  </div>

  <!-- ✅ 검색 결과 (검색창 바로 아래) -->
  <div class="card" id="searchCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="title">검색 결과</div>
      <span id="srCount" class="pill">0개</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">심볼</th>
          <th>코인명</th>
          <th style="width:120px">현재가</th>
          <th style="width:90px">등락률</th>
          <th style="width:160px">거래대금(24h)</th>
        </tr>
      </thead>
      <tbody id="srBody"></tbody>
    </table>
  </div>

  <!-- 🚀 실시간 급등코인 (검색 결과 밑) -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="title">실시간 급등코인</div>
      <div class="row"><span class="pill" id="crit">기준: 5분 +3%↑ 또는 상위 거래대금</span><button id="btnPump">갱신</button></div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:90px">심볼</th>
          <th>코인명</th>
          <th style="width:120px">현재가</th>
          <th style="width:90px">등락률</th>
          <th style="width:160px">거래대금(24h)</th>
          <th style="width:80px">태그</th>
        </tr>
      </thead>
      <tbody id="pumpBody"></tbody>
    </table>
    <div class="mut small" style="margin-top:6px">상위 10개 표시 · 60초마다 자동 갱신</div>
  </div>
</div>

<script>
/* ===== 환경 ===== */
const API_BASES = [
  '/upbit', // 프록시가 있으면 이 경로 사용
  'https://api.upbit.com/v1' // 없으면 공식 API 사용
];
function url(path){ return API_BASES[0] + path; } // 1순위 사용

/* ===== 유틸 ===== */
const $ = s=>document.querySelector(s);
const fmtKRW = v=>{
  if (v==null || isNaN(v)) return '-';
  v = Number(v);
  if (v>=100) return Math.round(v).toLocaleString('ko-KR')+'원';
  if (v>=1)   return v.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})+'원';
  // 1원 미만: 소수 8자리까지
  const s = v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
  return s+'원';
};
const pct = r => {
  const x = Number(r)*100;
  const cls = x>0?'good':(x<0?'bad':'');
  return `<span class="${cls}">${x>0?'+':''}${x.toFixed(2)}%</span>`;
};
const shortVol = v=>{
  v = Number(v||0);
  if (v>=1e12) return (v/1e12).toFixed(2)+'조원';
  if (v>=1e8)  return (v/1e8).toFixed(1)+'억원';
  return Math.round(v).toLocaleString('ko-KR')+'원';
};

/* ===== 데이터 ===== */
let KRW = [];     // [{market,korean_name,english_name}]
let TICK = {};    // market -> ticker

async function getMarkets(){
  const r = await fetch(url('/market/all?isDetails=true'));
  if (!r.ok) throw new Error('market '+r.status);
  const j = await r.json();
  return j.filter(x=>x.market.startsWith('KRW-'));
}
async function getTicker(markets){
  const r = await fetch(url('/ticker?markets='+encodeURIComponent(markets.join(','))));
  if (!r.ok) throw new Error('ticker '+r.status);
  return r.json();
}
async function getCandles(unit, market, count=30){
  const r = await fetch(url(`/candles/minutes/${unit}?market=${market}&count=${count}`));
  if (!r.ok) throw new Error('candles '+r.status);
  return r.json();
}

/* ===== 초기 로드 ===== */
(async function init(){
  try{
    KRW = await getMarkets();
    await refreshTickers();
    bindUI();
    renderSearch();    // 처음엔 비움
    await renderPump(); // 급등 초기 표시
    setInterval(refreshTickers, 30_000);
    setInterval(renderPump, 60_000);
  }catch(e){
    console.error(e);
    alert('연결 실패: 새로고침 해주세요.');
  }
})();

async function refreshTickers(){
  const mk = KRW.map(x=>x.market);
  for(let i=0;i<mk.length;i+=100){
    const chunk = mk.slice(i,i+100);
    const arr = await getTicker(chunk);
    for(const t of arr) TICK[t.market] = t;
    await new Promise(r=>setTimeout(r,120));
  }
}

/* ===== 검색 ===== */
function bindUI(){
  $('#q').addEventListener('input', renderSearch);
  $('#q').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const first = $('#srBody tr');
      if (first) first.click(); // 첫 결과 선택
    }
  });
  $('#btnReload').addEventListener('click', async ()=>{
    KRW = await getMarkets();
    await refreshTickers();
    renderSearch();
    renderPump();
  });
  $('#btnPump').addEventListener('click', renderPump);
}

function renderSearch(){
  const q = ($('#q').value||'').trim().toLowerCase();
  const card = $('#searchCard');
  const body = $('#srBody');
  if (!q){
    card.style.display = 'none';
    body.innerHTML = '';
    $('#srCount').textContent = '0개';
    return;
  }
  const list = [];
  for(const it of KRW){
    const sym = it.market.replace('KRW-','');
    const ko = it.korean_name.toLowerCase();
    const en = (it.english_name||'').toLowerCase();
    if (sym.toLowerCase().includes(q) || ko.includes(q) || en.includes(q)){
      const t = TICK[it.market]; if (!t) continue;
      list.push({it,t});
    }
  }
  list.sort((a,b)=> (b.t.acc_trade_price_24h||0) - (a.t.acc_trade_price_24h||0));
  body.innerHTML = list.map(({it,t})=>`
    <tr data-m="${it.market}">
      <td><b>${it.market.replace('KRW-','')}</b></td>
      <td>${it.korean_name}</td>
      <td>${fmtKRW(t.trade_price||0)}</td>
      <td>${pct(t.signed_change_rate||0)}</td>
      <td>${shortVol(t.acc_trade_price_24h||0)}</td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="mut">검색 결과 없음</td></tr>`;
  $('#srCount').textContent = list.length+'개';
  card.style.display = 'block';

  // 클릭 시 상세 동작(선택 콜백만 예시)
  [...body.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', async ()=>{
      const m = tr.dataset.m;
      // 선택시 원하는 추가 액션이 있으면 여기서 실행(예: 기존 상세 패널 갱신)
      console.log('선택:', m);
    });
  });
}

/* ===== 급등코인 ===== */
async function renderPump(){
  const body = $('#pumpBody');
  // 기준: ① 5분봉 상승률 ≥ +3%  OR  ② 24h 거래대금 상위 30위 중 상승률 상위
  const scored = [];
  for(const it of KRW){
    const m = it.market;
    const t = TICK[m]; if(!t) continue;
    let score = 0;
    let ch5 = 0;
    try{
      const cs = await getCandles(5, m, 2); // 최근 2개로 5분 변동률 근사
      if (cs && cs.length>=2){
        const a = cs[1].trade_price, b = cs[0].trade_price;
        ch5 = ((a-b)/b)*100;
      }
    }catch(_){}
    const ch24 = (t.signed_change_rate||0)*100;
    const vol24 = t.acc_trade_price_24h||0;

    if (ch5 >= 3) score += 100;          // 강한 급등
    score += Math.max(0, ch24);          // 24h 상승 가산
    score += Math.log10(Math.max(1, vol24)); // 유동성 가산

    scored.push({it,t,ch5,ch24,vol24,score});
    // 부하 완화
    await new Promise(r=>setTimeout(r,8));
  }

  scored.sort((a,b)=> b.score - a.score);
  const top = scored.slice(0,10);

  body.innerHTML = top.map(({it,t,ch5,ch24,vol24})=>{
    const tag = ch5>=3 ? '급등' : (ch24>=7 ? '강세' : '');
    return `
      <tr data-m="${it.market}">
        <td><b>${it.market.replace('KRW-','')}</b></td>
        <td>${it.korean_name}</td>
        <td>${fmtKRW(t.trade_price||0)}</td>
        <td>${pct((t.signed_change_rate||0))}</td>
        <td>${shortVol(vol24)}</td>
        <td>${tag?`<span class="pill">${tag}</span>`:''}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="6" class="mut">급등 코인 없음</td></tr>`;

  // 클릭 엔드포인트 (선택 시 원하는 추가 액션 연결)
  [...body.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const m = tr.dataset.m;
      console.log('급등 선택:', m);
    });
  });
}
</script>
</body>
</html>
