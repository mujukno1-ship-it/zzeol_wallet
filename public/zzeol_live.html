<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ Live ì‹¤ì‹œê°„ ì½”ì¸í˜„í™©</title>
  <style>
    :root { --bg:#0c0c0c; --panel:#121212; --txt:#e7fce7; --muted:#9ad39a; --accent:#27e627; --danger:#ff4d4d; --warn:#f4d35e; --line:#223222; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 Pretendard,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:1100px;margin:28px auto;padding:0 14px}
    h1{font-size:28px;margin:0 0 10px;font-weight:800;color:#79ff79; text-align:center}
    .subtitle{color:var(--muted); text-align:center; margin-bottom:18px}
    .bar{display:flex;gap:10px; justify-content:center; margin:12px 0 18px}
    input,button{border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--txt);padding:10px 12px}
    input{min-width:280px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);overflow:hidden;border-radius:14px}
    th,td{padding:9px 10px;border-bottom:1px solid var(--line);text-align:center;white-space:nowrap}
    thead th{position:sticky;top:0;background:#111c11;z-index:1}
    tr:last-child td{border-bottom:none}
    .up{color:#72ff72;font-weight:700}
    .down{color:#ff6a6a;font-weight:700}
    .chip{padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
    .risk1{background:#163a16;color:#9aff9a;border:1px solid #245b24}
    .risk2{background:#273a16;color:#e4ff9a;border:1px solid #556b24}
    .risk3{background:#3a3516;color:#ffd59a;border:1px solid #6b5b24}
    .risk4{background:#3a2816;color:#ffc09a;border:1px solid #6b3f24}
    .risk5{background:#3a1616;color:#ff9a9a;border:1px solid #6b2424}
    .flash{animation:flash 0.3s}
    @keyframes flash{from{background:rgba(39,230,39,.25)}to{background:transparent}}
    .muted{color:#a6c9a6}
    .note{font-size:12px;color:#96c696;margin-top:10px;text-align:center}
    .foot{margin-top:14px;text-align:center}
    a.btn{display:inline-block;padding:10px 14px;background:#0d220d;border:1px solid var(--line);border-radius:10px;color:#9aff9a;text-decoration:none}
    .scroll{overflow:auto;max-height:70vh}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸš€ ì©”ì–´ì§€ê°‘ <span class="muted">Live</span> ì‹¤ì‹œê°„ ì½”ì¸í˜„í™©</h1>
    <div class="subtitle">ì´ í™”ë©´ì€ Vercel â†” GitHub â†” Upbit WebSocket ì—°ë™ìœ¼ë¡œ ì‹¤ì‹œê°„ ê°±ì‹ ë©ë‹ˆë‹¤.</div>

    <div class="bar">
      <input id="search" placeholder="ì½”ì¸ëª…(í•œê¸€/ì˜ë¬¸)" />
      <button id="refresh">ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="scroll">
      <table id="board">
        <thead>
          <tr>
            <th>ì½”ì¸ëª…</th>
            <th>ì‹¬ë³¼</th>
            <th>í˜„ì¬ê°€</th>
            <th>ë§¤ìˆ˜</th>
            <th>ì†ì ˆ</th>
            <th>TP1</th><th>TP2</th><th>TP3</th>
            <th>ìƒíƒœ</th>
            <th>ê¸‰ë“±ë½</th>
            <th>ìœ„í—˜ë„</th>
            <th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- ê¸°ë³¸ 5ì¢… (í•„ìš”ì‹œ ì•„ë˜ ëª©ë¡/JSì˜ MARKETS ì—ë§Œ ì¶”ê°€í•˜ë©´ ìë™ ë°˜ì˜) -->
          <tr data-row data-coin="XRP">
            <td>ë¦¬í”Œ</td><td>XRP</td>
            <td data-col="price">-</td>
            <td data-col="bid">-</td>
            <td data-col="stop">-</td>
            <td data-col="tp1">-</td><td data-col="tp2">-</td><td data-col="tp3">-</td>
            <td data-col="status" class="muted">-</td>
            <td data-col="spike" class="muted">-</td>
            <td data-col="risk"><span class="chip risk3">Risk 3</span></td>
            <td data-col="say" class="muted">-</td>
          </tr>
          <tr data-row data-coin="DOGE">
            <td>ë„ì§€ì½”ì¸</td><td>DOGE</td>
            <td data-col="price">-</td><td data-col="bid">-</td><td data-col="stop">-</td>
            <td data-col="tp1">-</td><td data-col="tp2">-</td><td data-col="tp3">-</td>
            <td data-col="status" class="muted">-</td><td data-col="spike" class="muted">-</td>
            <td data-col="risk"><span class="chip risk3">Risk 3</span></td>
            <td data-col="say" class="muted">-</td>
          </tr>
          <tr data-row data-coin="BTC">
            <td>ë¹„íŠ¸ì½”ì¸</td><td>BTC</td>
            <td data-col="price">-</td><td data-col="bid">-</td><td data-col="stop">-</td>
            <td data-col="tp1">-</td><td data-col="tp2">-</td><td data-col="tp3">-</td>
            <td data-col="status" class="muted">-</td><td data-col="spike" class="muted">-</td>
            <td data-col="risk"><span class="chip risk3">Risk 3</span></td>
            <td data-col="say" class="muted">-</td>
          </tr>
          <tr data-row data-coin="ETH">
            <td>ì´ë”ë¦¬ì›€</td><td>ETH</td>
            <td data-col="price">-</td><td data-col="bid">-</td><td data-col="stop">-</td>
            <td data-col="tp1">-</td><td data-col="tp2">-</td><td data-col="tp3">-</td>
            <td data-col="status" class="muted">-</td><td data-col="spike" class="muted">-</td>
            <td data-col="risk"><span class="chip risk3">Risk 3</span></td>
            <td data-col="say" class="muted">-</td>
          </tr>
          <tr data-row data-coin="CHZ">
            <td>ì¹ ë¦¬ì¦ˆ</td><td>CHZ</td>
            <td data-col="price">-</td><td data-col="bid">-</td><td data-col="stop">-</td>
            <td data-col="tp1">-</td><td data-col="tp2">-</td><td data-col="tp3">-</td>
            <td data-col="status" class="muted">-</td><td data-col="spike" class="muted">-</td>
            <td data-col="risk"><span class="chip risk3">Risk 3</span></td>
            <td data-col="say" class="muted">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="note">â€» ê¸°ë³¸ê°’ì€ ìë¦¬í‘œì‹œìì…ë‹ˆë‹¤. ì‹¤ì‹œê°„ ìˆ˜ì‹  ì¦‰ì‹œ ê°’ì´ ì±„ì›Œì§€ê³ , ì¹©/ìƒíƒœ/í•œë§ˆë””ë„ ìë™ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.</div>

    <div class="foot">
      <a href="/test_vercel.html" class="btn">í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì—´ê¸°</a>
    </div>
  </div>

  <script>
    // === 1) ì„¤ì • =========================
    const MARKETS = [
      { market: 'KRW-XRP', sym: 'XRP' },
      { market: 'KRW-DOGE', sym: 'DOGE' },
      { market: 'KRW-BTC', sym: 'BTC' },
      { market: 'KRW-ETH', sym: 'ETH' },
      { market: 'KRW-CHZ', sym: 'CHZ' },
      // í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ê³„ì† ì¶”ê°€
    ];
    const PRICE_MEMO = {};   // ìµœê·¼ nê°œ ê°€ê²© ì €ì¥(ë³€ë™ì„±/ê¸‰ë“±ë½ ê°ì§€ìš©)
    const MEMO_LEN   = 30;   // ë©”ì‹œì§€ ë²„í¼ ê¸¸ì´
    const fmt = new Intl.NumberFormat('ko-KR');

    // === 2) ë„ìš°ë¯¸ =======================
    function qCoin(sym, field){
      return document.querySelector(`[data-row][data-coin="${sym}"] [data-col="${field}"]`);
    }
    function flash(el){
      if(!el) return; el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 250);
    }
    function setText(sym, field, val, isKRW=false){
      const td = qCoin(sym, field);
      if(!td) return;
      td.textContent = isKRW && typeof val==='number' ? fmt.format(val)+'ì›' : val;
      flash(td);
    }
    function setRisk(sym, score){ // 1(ë‚®ìŒ)~5(ë†’ìŒ)
      const td = qCoin(sym,'risk'); if(!td) return;
      const span = td.querySelector('.chip') || document.createElement('span');
      span.className = 'chip '+('risk'+score);
      span.textContent = 'Risk '+score;
      td.innerHTML = ''; td.appendChild(span); flash(td);
    }
    function setSay(sym, text){
      setText(sym,'say', text);
    }

    // ê°„ë‹¨ ìƒíƒœ/ìœ„í—˜ë„ ë¡œì§
    function analyze(sym){
      const arr = PRICE_MEMO[sym]||[];
      if(arr.length<5) return { status:'ëŒ€ê¸°', risk:3, spike:'-' };

      const last = arr[arr.length-1];
      const prev = arr[arr.length-2]||last;
      const m5   = arr[Math.max(0, arr.length-6)]; // ëŒ€ëµ ìµœê·¼ 5í‹± ì´ì „
      const ch1  = (last-prev)/prev*100;
      const ch5  = (last-m5)/m5*100;

      let status = 'ë³´í•©';
      if (ch1>0) status='ìƒìŠ¹';
      if (ch1<0) status='í•˜ë½';

      let riskScore = 3;
      const vol = Math.abs(ch5);
      if (vol < 0.3) riskScore = 1;
      else if (vol < 0.8) riskScore = 2;
      else if (vol < 1.5) riskScore = 3;
      else if (vol < 3.0) riskScore = 4;
      else riskScore = 5;

      let spike = '-';
      if (Math.abs(ch1) > 0.6) spike = ch1>0 ? 'ê¸‰ë“±' : 'ê¸‰ë½';

      return { status, risk:riskScore, spike };
    }

    function sayFor(sym, status, risk){
      if (status==='ìƒìŠ¹' && risk<=2) return 'ê´€ë§ â†’ ì €ì  ëª¨ë‹ˆí„°';
      if (status==='ìƒìŠ¹' && risk>=4) return 'ë‹¨íƒ€ ë§¤ìˆ˜ ì£¼ì˜';
      if (status==='í•˜ë½' && risk>=4) return 'ê´€ë§ í•„ìš”';
      if (risk===1) return 'ì•ˆì •ì ';
      if (risk===5) return 'ë³€ë™ì„± í¼';
      return 'ë³´í†µ';
    }

    // === 3) WebSocket ====================
    let ws, retry=0;
    function connectWS(){
      ws = new WebSocket('wss://api.upbit.com/websocket/v1');
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        retry=0;
        const ticket = [{ticket:'zzeol_live'}];
        const req    = [{type:'ticker', codes:MARKETS.map(m=>m.market), isOnlyRealtime:true}];
        ws.send(new TextEncoder().encode(JSON.stringify(ticket)));
        ws.send(new TextEncoder().encode(JSON.stringify(req)));
      };

      ws.onmessage = (e) => {
        const text = new TextDecoder('utf-8').decode(e.data);
        const msg  = JSON.parse(text);
        const map  = MARKETS.find(m=>m.market===msg.market);
        if(!map) return;

        const sym   = map.sym;
        const price = msg.tp ?? msg.trade_price;
        const bid   = msg.bp ?? msg.bid_price ?? msg.best_bid;
        const chg   = msg.ch ?? msg.change; // RISE/FALL/EVEN

        if(!PRICE_MEMO[sym]) PRICE_MEMO[sym]=[];
        PRICE_MEMO[sym].push(price);
        if(PRICE_MEMO[sym].length>MEMO_LEN) PRICE_MEMO[sym].shift();

        // í‘œ ê°±ì‹ 
        setText(sym,'price', price, true);
        if(bid) setText(sym,'bid', bid, true);

        // ê°„ë‹¨ ì†ì ˆ/TP ìë™ ì œì•ˆ (ì›ë˜ ê°’ ìœ ì§€ ì›í•˜ë©´ ì£¼ì„)
        const stop = Math.round(price*0.97);
        const tp1  = Math.round(price*1.05);
        const tp2  = Math.round(price*1.08);
        const tp3  = Math.round(price*1.12);
        setText(sym,'stop', stop, true);
        setText(sym,'tp1', tp1);
        setText(sym,'tp2', tp2);
        setText(sym,'tp3', tp3);

        // ìƒíƒœ/ìœ„í—˜ë„/ê¸‰ë“±ë½/í•œë§ˆë””
        const {status, risk, spike} = analyze(sym);
        setText(sym,'status', status);
        setText(sym,'spike',  spike);
        setRisk(sym, risk);
        setSay(sym, sayFor(sym, status, risk));
      };

      ws.onerror = () => { try{ws.close()}catch{} };
      ws.onclose = () => {
        if (++retry <= 10) setTimeout(connectWS, Math.min(30000, 500*Math.pow(2,retry)));
      };
    }
    connectWS();

    // === 4) ê²€ìƒ‰/ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ===========
    const search = document.getElementById('search');
    search.addEventListener('input', () => {
      const v = search.value.trim().toLowerCase();
      document.querySelectorAll('[data-row]').forEach(tr=>{
        const txt = tr.innerText.toLowerCase();
        tr.style.display = txt.includes(v) ? '' : 'none';
      });
    });
    document.getElementById('refresh').addEventListener('click', () => {
      location.reload();
    });
  </script>
</body>
</html>
