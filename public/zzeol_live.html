<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„ (ë§¤ìˆ˜Â·ë§¤ë„Â·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””)</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1117; --card:#121826; --muted:#98a2b3; --text:#e6edf3;
      --line:#1f2633; --up:#2ecc71; --dn:#ff4d4d; --acc:#1b7fff; --warn:#f59f00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .brand{font-size:18px;font-weight:800}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:10px}
    .mut{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1024px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:15px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    select, input, button{
      background:transparent;border:1px solid var(--line);color:var(--text);
      padding:8px 10px;border-radius:10px;outline:none
    }
    button{cursor:pointer}
    button.acc{background:var(--acc);border-color:var(--acc);color:#fff}
    .grid{display:grid;grid-template-columns:120px 1fr 1fr 1fr;gap:8px}
    .grid div{padding:8px 0;border-bottom:1px dashed var(--line)}
    .th{color:var(--muted)}
    .tbl{width:100%;border-collapse:collapse;margin-top:12px}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--line)}
    .tbl th{color:var(--muted);font-weight:600;text-align:left}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .tag.up{border-color:var(--up);color:var(--up)}
    .tag.dn{border-color:var(--dn);color:var(--dn)}
    .tag.warn{border-color:var(--warn);color:var(--warn)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e1522;border:1px solid var(--line)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hint{margin-top:6px;color:var(--muted);font-size:12px}
    .danger{color:var(--dn)}
    .success{color:var(--up)}
    .right{display:flex;gap:8px;align-items:center;margin-left:auto}
    a{color:#8ab4ff;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„</div>
      <span class="badge">ìƒíƒœ: <span id="ws-status" class="mut">ì—°ê²°ì¤‘â€¦</span></span>
      <div class="right">
        <label class="mut">ë¶„ë´‰</label>
        <select id="unit">
          <option value="5">5ë¶„</option>
          <option value="15">15ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="60">60ë¶„</option>
          <option value="240">4ì‹œê°„</option>
        </select>
        <button id="btn-clear" title="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
      </div>
    </header>

    <div class="row">
      <div class="card">
        <h3>ì½”ì¸ ê²€ìƒ‰</h3>
        <div class="controls">
          <input id="search" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼: ë¹„íŠ¸ì½”ì¸, ETH, SOL ë“±" style="flex:1" />
          <button id="btn-reload" class="acc">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="hint">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·ì‹ í˜¸ ê°±ì‹ .</div>
      </div>

      <div class="card">
        <h3>ì„ íƒ ì½”ì¸</h3>
        <div class="grid">
          <div class="th">ì´ë¦„</div><div id="sel-name">-</div><div class="th">ì‹¬ë³¼</div><div id="sel-sym">-</div>
          <div class="th">í˜„ì¬ê°€</div><div id="sel-price">-</div><div class="th">ë“±ë½ë¥ (24h)</div><div id="sel-chg">-</div>
          <div class="th">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="sel-vol">-</div><div class="th">í‹± ì²´ê°ê°•ë„</div><div id="sel-tick">-</div>
        </div>
      </div>

      <div class="card">
        <h3>ìœ ë™ì„±Â·ë³€ë™ì„±</h3>
        <div class="grid">
          <div class="th">EMA20</div><div id="m-ema">-</div><div class="th">ATR(14)</div><div id="m-atr">-</div>
          <div class="th">EMA ê¸°ìš¸ê¸°</div><div id="m-slope">-</div><div class="th">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="m-swan">-</div>
        </div>
      </div>

      <div class="card">
        <h3>ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””</h3>
        <div class="grid">
          <div class="th">ì†ì ˆ</div><div id="m-sl" class="danger">-</div>
          <div class="th">ìœ„í—˜ë„</div><div id="m-risk">-</div>
          <div class="th">ì©”ì–´í•œë§ˆë””</div><div id="m-say">-</div>
        </div>
      </div>

      <div class="card">
        <h3>ë§¤ìˆ˜ íƒ€ì </h3>
        <ul id="buys" class="mono" style="margin:0;padding-left:18px">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="hint">ê¸°ë³¸ ë¡œì§: EMA20 ê·¼ì²˜ ëˆŒë¦¼ + ATR ê¸°ë°˜ ë¶„í• ì§„ì….</div>
      </div>

      <div class="card">
        <h3>ë§¤ë„(ìµì ˆ) íƒ€ì </h3>
        <ul id="sells" class="mono" style="margin:0;padding-left:18px">
          <li>-</li><li>-</li><li>-</li>
        </ul>
        <div class="hint">ê¸°ë³¸ ë¡œì§: í˜„ì¬ê°€ ê¸°ì¤€ ATRÃ—{1.0, 1.6, 2.2} ëª©í‘œ.</div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h3>KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</h3>
        <table class="tbl" id="tbl">
          <thead>
            <tr>
              <th>ì‹¬ë³¼</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë“±ë½ë¥ </th><th>ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="hint">í–‰ì„ í´ë¦­í•˜ë©´ ìƒë‹¨ íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” ì¦‰ì‹œ ê°±ì‹ .</div>
      </div>
    </div>
  </div>

<script>
/* ========================
   Upbit Endpoints (ê³µìš©)
   ======================== */
const API = {
  markets: "https://api.upbit.com/v1/market/all?isDetails=true",
  ticker:  (ms) => `https://api.upbit.com/v1/ticker?markets=${ms.join(",")}`,
  candles: (unit, mkt, count=200) => `https://api.upbit.com/v1/candles/minutes/${unit}?market=${mkt}&count=${count}`,
  ticks:   (mkt, count=100) => `https://api.upbit.com/v1/trades/ticks?market=${mkt}&count=${count}`,
};

// ìƒíƒœ
const state = {
  markets: [], // [{market, korean_name, english_name}]
  krw: [],     // KRW-xxxë§Œ
  map: {},     // market -> meta
  rows: [],    // ë Œë”ëœ í–‰ ë°ì´í„°
  unit: 5,
  selected: null,
};

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const fmt = (n, d=0) => {
  if (n == null || isNaN(n)) return "-";
  if (Math.abs(n)>=100000000) return (n/1e8).toFixed(2)+"ì–µ";
  if (Math.abs(n)>=10000) return (n/1e4).toFixed(2)+"ë§Œ";
  return Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
};
const pct = (x) => (x>0?`<span class="tag up">+${x.toFixed(2)}%</span>`:
                         x<0?`<span class="tag dn">${x.toFixed(2)}%</span>`:
                              `<span class="tag">0.00%</span>`);

/* ========================
   ìˆ˜í•™ & ì§€í‘œ
   ======================== */
function EMA(values, period=20){
  if (values.length<period) return Array(values.length).fill(null);
  const k = 2/(period+1);
  const out = Array(values.length).fill(null);
  let ema = values.slice(0,period).reduce((a,b)=>a+b,0)/period;
  out[period-1]=ema;
  for(let i=period;i<values.length;i++){
    ema = values[i]*k + ema*(1-k);
    out[i]=ema;
  }
  return out;
}
function ATR(candles, period=14){
  // candles: [{opening_price, high_price, low_price, trade_price}, â€¦] ìµœì‹ ì´ ì•ì— ìˆìŒ? UpbitëŠ” ìµœì‹ ì´ ì•ì— ì˜´
  const arr = candles.slice().reverse(); // ì˜¤ë˜ëœ -> ìµœì‹ 
  const TR = [];
  for(let i=0;i<arr.length;i++){
    const c = arr[i], prev = arr[i-1];
    if (!prev){ TR.push(c.high_price - c.low_price); continue; }
    const high = c.high_price, low = c.low_price, pc = prev.trade_price;
    const tr = Math.max(high-low, Math.abs(high-pc), Math.abs(low-pc));
    TR.push(tr);
  }
  const out = EMA(TR, period); // ê°„ë‹¨íˆ EMAë¡œ ìŠ¤ë¬´ë”©
  return out[out.length-1];
}
function slopeLast(emaArr, look=5){
  const xs = emaArr.filter(Boolean);
  if (xs.length<look+1) return 0;
  const a = xs[xs.length-1], b = xs[xs.length-1-look];
  return (a-b)/look;
}

/* ========================
   ë°ì´í„° ë¡œë”© & ë Œë”
   ======================== */
async function loadMarkets(){
  $("#ws-status").textContent="ì—°ê²°ì¤‘â€¦";
  const res = await fetch(API.markets);
  const data = await res.json();
  state.markets = data;
  state.krw = data.filter(x=>x.market.startsWith("KRW-"));
  state.map = Object.fromEntries(state.krw.map(x=>[x.market,x]));
  $("#ws-status").textContent="ì—°ê²°ë¨";
}
async function loadTickers(){
  const markets = state.krw.map(x=>x.market);
  const chunks = [];
  for (let i=0;i<markets.length;i+=50) chunks.push(markets.slice(i,i+50));
  const all = [];
  for (const ch of chunks){
    const res = await fetch(API.ticker(ch));
    all.push(...await res.json());
  }
  return all; // [{market, trade_price, signed_change_rate, acc_trade_price_24h}, ...]
}
function renderTable(tickers){
  const byM = Object.fromEntries(tickers.map(x=>[x.market,x]));
  const rows = state.krw.map(k=>{
    const t = byM[k.market];
    return {
      market: k.market,
      korean: k.korean_name,
      sym: k.market.replace("KRW-",""),
      price: t?.trade_price ?? 0,
      change: t?.signed_change_rate ?? 0,
      vol24: t?.acc_trade_price_24h ?? 0,
    };
  }).sort((a,b)=>b.vol24-a.vol24);
  state.rows = rows;
  const q = ($("#search").value||"").trim().toLowerCase();
  const body = rows
    .filter(r=>{
      if(!q) return true;
      const m = r.market.toLowerCase(), k = (state.map[r.market]?.korean_name||"").toLowerCase();
      return m.includes(q) || k.includes(q) || r.sym.toLowerCase().includes(q);
    })
    .map(r=>`
      <tr data-market="${r.market}" style="cursor:pointer">
        <td class="mono">${r.sym}</td>
        <td>${state.map[r.market]?.korean_name||"-"}</td>
        <td class="mono">${fmt(r.price)}</td>
        <td>${pct(r.change*100)}</td>
        <td class="mono">${fmt(r.vol24)}</td>
      </tr>
    `).join("");
  $("#tbody").innerHTML = body || `<tr><td colspan="5" class="mut">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
}
async function boot(){
  await loadMarkets();
  const tks = await loadTickers();
  renderTable(tks);
}
boot().catch(err=>{
  $("#ws-status").textContent="ì—°ê²° ì‹¤íŒ¨";
  console.error(err);
});

/* ========================
   ì½”ì¸ í´ë¦­ ì‹œ ì •ë°€ ë¶„ì„
   ======================== */
$("#tbody").addEventListener("click", async (e)=>{
  const tr = e.target.closest("tr[data-market]");
  if(!tr) return;
  const market = tr.dataset.market;
  state.selected = market;
  analyze(market).catch(console.error);
});

$("#btn-reload").addEventListener("click", async ()=>{
  const tks = await loadTickers();
  renderTable(tks);
});
$("#btn-clear").addEventListener("click", ()=>{
  $("#search").value="";
  $("#sel-name").textContent = $("#sel-sym").textContent = $("#sel-price").textContent = "-";
  $("#sel-chg").innerHTML = "-";
  $("#sel-vol").textContent = $("#sel-tick").textContent = "-";
  $("#m-ema").textContent = $("#m-atr").textContent = $("#m-slope").textContent = "-";
  $("#m-swan").innerHTML = "-";
  $("#m-sl").textContent = $("#m-risk").innerHTML = $("#m-say").textContent = "-";
  $("#buys").innerHTML = "<li>-</li><li>-</li><li>-</li>";
  $("#sells").innerHTML = "<li>-</li><li>-</li><li>-</li>";
});
$("#search").addEventListener("input", ()=>renderTable(state.rows.map(r=>({
  ...r
})))); // ë‹¨ìˆœ ì¬í•„í„°

$("#unit").addEventListener("change", async ()=>{
  state.unit = Number($("#unit").value);
  if (state.selected) analyze(state.selected).catch(console.error);
});

async function analyze(market){
  const meta = state.map[market];
  // ìƒë‹¨ ì •ë³´ ì±„ì›€(í‹°ì»¤)
  const tRes = await fetch(API.ticker([market]));
  const t = (await tRes.json())[0];

  $("#sel-name").textContent = meta.korean_name;
  $("#sel-sym").textContent = market.replace("KRW-","");
  $("#sel-price").textContent = fmt(t.trade_price);
  $("#sel-chg").innerHTML = pct(t.signed_change_rate*100);
  $("#sel-vol").textContent = fmt(t.acc_trade_price_24h);

  // ìµœê·¼ ì²´ê²° ê°•ë„(í‹±)
  let tickLabel = "-";
  try{
    const tkRes = await fetch(API.ticks(market, 60));
    const ticks = await tkRes.json(); // ìµœì‹ ì´ ì•
    const ups = ticks.filter(x=>x.ask_bid==="BID").length;
    const rate = (ups/ticks.length*100)||0;
    tickLabel = (rate>55?`ê°•í•¨(${rate.toFixed(0)}%)`:rate<45?`ì•½í•¨(${rate.toFixed(0)}%)`:`ì¤‘ë¦½(${rate.toFixed(0)}%)`);
  }catch(_){}
  $("#sel-tick").textContent = tickLabel;

  // ìº”ë“¤ ë¡œë”© + ì§€í‘œ
  const cRes = await fetch(API.candles(state.unit, market, 200));
  const cs = await cRes.json(); // ìµœì‹ ì´ ì•
  const close = cs.map(c=>c.trade_price).reverse();
  const ema20 = EMA(close, 20);
  const emaNow = ema20[ema20.length-1];
  const atr14 = ATR(cs, 14) || 0;
  const slope = slopeLast(ema20, 5);

  $("#m-ema").textContent = fmt(emaNow);
  $("#m-atr").textContent = fmt(atr14);
  $("#m-slope").innerHTML = slope>0 ? `<span class="tag up">ìƒìŠ¹</span>` :
                            slope<0 ? `<span class="tag dn">í•˜ë½</span>` : `<span class="tag">ì¤‘ë¦½</span>`;

  // ë¸”ë™ìŠ¤ì™„(ìµœê·¼ 10ê°œ ì¤‘ -3% ë„˜ëŠ” ìŒë´‰ ë¹„ìœ¨)
  let swan = "-";
  (function(){
    const recent = cs.slice(0,10); // ìµœì‹  10ê°œ
    let cnt = 0;
    for (const c of recent){
      const ret = (c.trade_price - c.opening_price)/c.opening_price*100;
      if (ret<=-3) cnt++;
    }
    if (cnt>=3) swan = `<span class="tag warn">ì£¼ì˜(ê¸‰ë½ í”ì )</span>`;
    else swan = `<span class="tag">ì •ìƒ</span>`;
  })();
  $("#m-swan").innerHTML = swan;

  // ë§¤ìˆ˜/ë§¤ë„ íƒ€ì  ê³„ì‚°
  const price = t.trade_price;
  const dist = price - emaNow;
  const trendUp = slope>0;

  // ë§¤ìˆ˜: EMA20 ê¸°ë°˜ ë¶„í• 
  const buy1 = Math.max(1, emaNow - 0.3*atr14);
  const buy2 = Math.max(1, emaNow - 0.7*atr14);
  const buy3 = Math.max(1, emaNow - 1.1*atr14);

  // ë§¤ë„(ìµì ˆ): ATR íƒ€ê²Ÿ
  const tp1 = price + (1.0*atr14);
  const tp2 = price + (1.618*atr14);
  const tp3 = price + (2.2*atr14);

  // ì†ì ˆ: EMA20-1.3*ATR (ì¶”ì„¸ìƒìŠ¹ ì‹œ), ì¶”ì„¸í•˜ë½ì´ë©´ ìµœê·¼ ì €ê°€ -0.8*ATR
  const lastLow = Math.min(...cs.slice(0,5).map(c=>c.low_price));
  const stop = trendUp ? (emaNow - 1.3*atr14) : (lastLow - 0.8*atr14);

  // ìœ„í—˜ë„ ìŠ¤ì½”ì–´ë§
  const vol = t.acc_trade_price_24h || 0;
  const volScore = vol>5e10 ? 0 : vol>2e10 ? 1 : 2;              // 50ì–µâ†‘ ë§¤ìš° ì–‘í˜¸, 20~50ì–µ ë³´í†µ, ì´í•˜ ë†’ìŒ
  const volaScore = (atr14/price)>0.03 ? 2 : (atr14/price)>0.015 ? 1 : 0; // ë³€ë™ì„± ë¹„ìœ¨
  const trendScore = trendUp ? 0 : Math.abs(slope)<1e-6 ? 1 : 2; // ìƒìŠ¹ 0, íš¡ë³´ 1, í•˜ë½ 2
  const riskSum = volScore + volaScore + trendScore;
  const riskTag = riskSum<=1 ? `<span class="tag up">Risk 1 (ë‚®ìŒ)</span>` :
                  riskSum<=3 ? `<span class="tag">Risk 2 (ë³´í†µ)</span>` :
                  riskSum<=4 ? `<span class="tag warn">Risk 3 (ì£¼ì˜)</span>` :
                  `<span class="tag dn">Risk 4 (ë†’ìŒ)</span>`;

  $("#m-sl").textContent = fmt(Math.max(1, stop));
  $("#m-risk").innerHTML = riskTag;

  // ì©”ì–´í•œë§ˆë””
  let say = "";
  if (trendUp && dist>0 && dist/atr14<1.0) say = "ìƒìŠ¹ ì¶”ì„¸ ìœ ì§€. EMA20 ê·¼ì²˜ ëˆŒë¦¼ ëŒ€ê¸° í›„ ë¶„í• ë§¤ìˆ˜ ì¶”ì²œ.";
  else if (trendUp && dist/atr14>=1.0) say = "ê³¼ì—´ êµ¬ê°„ ê°€ëŠ¥ì„±. ë‹¨ê¸° ì¡°ì • ê¸°ë‹¤ë ¸ë‹¤ ì§„ì… ê¶Œì¥.";
  else if (!trendUp && dist<0) say = "í•˜ë½ ì¶”ì„¸. ë°˜ë“± ìŠ¤ìº˜í•‘ì´ ì•„ë‹ˆë©´ ê´€ë§ì´ ìœ ë¦¬.";
  else say = "ì¤‘ë¦½. ê±°ë˜ëŒ€ê¸ˆê³¼ ìº”ë“¤ êµ¬ì¡° í™•ì¸ í›„ ì†Œì•¡ íƒìƒ‰.";
  if (/ê¸‰ë½/.test(swan)) say += " ìµœê·¼ ê¸‰ë½ í”ì  â†’ ì†ì ˆ ì—„ìˆ˜.";

  $("#m-say").textContent = say;

  $("#buys").innerHTML = `
    <li>1ì°¨: ${fmt(buy1)} (EMA20 - 0.3Ã—ATR)</li>
    <li>2ì°¨: ${fmt(buy2)} (EMA20 - 0.7Ã—ATR)</li>
    <li>3ì°¨: ${fmt(buy3)} (EMA20 - 1.1Ã—ATR)</li>
  `;
  $("#sells").innerHTML = `
    <li>TP1: ${fmt(tp1)} (í˜„ì¬ê°€ + 1.0Ã—ATR)</li>
    <li>TP2: ${fmt(tp2)} (í˜„ì¬ê°€ + 1.618Ã—ATR)</li>
    <li>TP3: ${fmt(tp3)} (í˜„ì¬ê°€ + 2.2Ã—ATR)</li>
  `;
}
</script>
</body>
</html>
