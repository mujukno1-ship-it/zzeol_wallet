<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v9.9 â€” ì‚¬ëŒí˜•AI í‘œ + ì´ˆê°•í™” ê²€ìƒ‰ + 0.000 ë°©ì–´</title>
<style>
  :root{--bg:#0b0f14;--panel:#111823;--muted:#8fa4c7;--text:#e8eefc;--up:#22c55e;--down:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 "Noto Sans KR",system-ui}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border:1px solid #1b2738;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  h2{margin:0 0 8px} .status{font-size:12px;color:#9bb0d1}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border:1px solid #2a3b57;background:#0f1b2e;color:#dbe7ff;border-radius:10px;padding:10px 12px}
  button{cursor:pointer} button[disabled]{opacity:.55}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
  thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
  tbody tr{background:#0e1520;border:1px solid #1d2a40} tbody td{padding:10px;vertical-align:middle}
  .price{font-variant-numeric:tabular-nums} .up{color:var(--up)} .down{color:var(--down)}
  .tag{font-size:11px;padding:3px 6px;border:1px solid #2a3956;border-radius:6px;background:#111a27;color:#9fb6db}
  .badge{display:inline-block;padding:4px 8px;border:1px solid #2a3956;border-radius:999px;background:#0f1726;color:#cfe2ff;font-size:12px}
  .act{padding:4px 8px;border-radius:999px;border:1px solid #2a3956}
  .act.buy{color:#9ff4b1;border-color:#2b5b3a}.act.sell{color:#ffb4b4;border-color:#6b2b2b}.act.hold{color:#c9d4eb}
</style>
</head>
<body>
<div class="wrap">

  <!-- ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ â€” ì ‘ì† ì¦‰ì‹œ(ìºì‹œ) + ì‹¤ì‹œê°„ -->
  <div class="card">
    <h2>ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ â€” í•­ìƒ í‘œì‹œ</h2>
    <div class="status">ê¸°ì¤€: ê³ ê°€ ê·¼ì ‘ â‰¤0.5%, 1m +0.2~2.0%, ê±°ë˜ëŒ€ê¸ˆ ê°€ì† â‰¥1.6Ã— (ìƒˆ í›„ë³´ëŠ” ìœ„ë¡œ)</div>
    <table>
      <thead>
        <tr>
          <th style="width:14%">ì½”ì¸</th>
          <th style="width:12%">í˜„ì¬ê°€</th>
          <th style="width:10%">ë“±ë½</th>
          <th style="width:12%">ë§¤ìˆ˜</th>
          <th style="width:12%">ë§¤ë„</th>
          <th style="width:12%">ì†ì ˆ</th>
          <th style="width:10%">ìœ„í—˜ë„</th>
          <th>ì©”ì–´ í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody id="preheatBody">
        <tr><td colspan="8" class="status">ìµœê·¼ ì˜ˆì—´ ìºì‹œ ì—†ìŒ â€” ì‹¤ì‹œê°„ ìŠ¤ìº” ëŒ€ê¸°â€¦</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ğŸ§­ ì‚¬ëŒí˜• AI íƒ€ì  â€” í‘œ(ìš”ì²­í•œ ì»¬ëŸ¼ ëª¨ë‘) -->
  <div class="card">
    <h2>ğŸ§­ ì‚¬ëŒí˜• AI íƒ€ì  í‘œ (í˜„ì¬ê°€Â·ë“±ë½Â·ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´ í•œë§ˆë””)</h2>
    <div class="status">ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê·¸ ì½”ì¸ìœ¼ë¡œ, ì—†ìœ¼ë©´ ì˜ˆì—´ ìƒìœ„ì½”ì¸ìœ¼ë¡œ ìë™ ë¶„ì„</div>
    <table>
      <thead>
        <tr>
          <th style="width:14%">ì½”ì¸</th>
          <th style="width:12%">í˜„ì¬ê°€</th>
          <th style="width:10%">ë“±ë½</th>
          <th style="width:12%">ë§¤ìˆ˜</th>
          <th style="width:12%">ë§¤ë„</th>
          <th style="width:12%">ì†ì ˆ</th>
          <th style="width:10%">ìœ„í—˜ë„</th>
          <th>ì©”ì–´ í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody id="aiBody">
        <tr><td colspan="8" class="status">ë¶„ì„ ëŒ€ê¸°â€¦</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ğŸ” ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ (ê¸°ì¡´ ìœ ì§€) -->
  <div class="card">
    <h2>ğŸ” ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©, ì‹¤ì‹œê°„)</h2>
    <div class="row">
      <input id="q" placeholder="ì˜ˆ: ì‹œë°”ì´ëˆ„, ì‹œë°”, SHIB, ì—ì´ë‹¤, ì¹´ë¥´ë‹¤ë…¸, ADA, KRW-ADA">
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnTop">ìƒìŠ¹TOP10</button>
      <button id="btnHot">ê¸‰ë“±</button>
      <button id="btnFall">ê¸‰ë½</button>
      <button id="btnReset">ì´ˆê¸°í™”</button>
      <span class="badge">ë¹ ë¥¸ê²€ìƒ‰: <a href="#" id="qSHIB" style="color:#cfe2ff">SHIB</a> Â· <a href="#" id="qADA" style="color:#cfe2ff">ADA</a></span>
    </div>
    <div class="status" id="status">ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ì¤‘â€¦</div>
    <table>
      <thead><tr>
        <th style="width:22%">ì½”ì¸</th><th style="width:14%">í˜„ì¬ê°€</th><th style="width:12%">ë“±ë½</th>
        <th style="width:14%">ë§¤ìˆ˜</th><th style="width:14%">ë§¤ë„</th><th style="width:14%">ì†ì ˆ</th><th>ë¹„ê³ </th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- âš™ï¸ ìƒíƒœ -->
  <div class="card">
    <h2>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div class="status" id="net">ì´ˆê¸°í™” ì¤‘â€¦</div>
  </div>

</div>

<script>
/* ===== ì„¤ì • ===== */
const API={
  REST_MARKETS:'https://api.upbit.com/v1/market/all?isDetails=true',
  REST_TICKER:(codes)=>`https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
  CANDLE:(m,f)=> f==='1d'
    ? `https://api.upbit.com/v1/candles/days?market=${m}&count=200`
    : `https://api.upbit.com/v1/candles/minutes/${f==='4h'?240:60}?market=${m}&count=200`,
  LOCAL:(url)=>`/api/upbit?url=${encodeURIComponent(url)}`
};
const TH={preNearHighPct:0.005, preMinMove:0.002, preMaxMove:0.020, preAccel:1.6, baselineMin:600};
const PREHEAT_CACHE_KEY='ZWL_PREHEAT_V4';
const FALLBACK_MARKETS=[
  {market:'KRW-BTC',korean_name:'ë¹„íŠ¸ì½”ì¸'},
  {market:'KRW-ETH',korean_name:'ì´ë”ë¦¬ì›€'},
  {market:'KRW-ETC',korean_name:'ì´ë”ë¦¬ì›€í´ë˜ì‹'},
  {market:'KRW-ADA',korean_name:'ì—ì´ë‹¤'},
  {market:'KRW-SHIB',korean_name:'ì‹œë°”ì´ëˆ„'}
];

/* ===== ì—˜ë¦¬ë¨¼íŠ¸/ìƒíƒœ ===== */
const el={
  preheatBody:byId('preheatBody'), aiBody:byId('aiBody'),
  signals:null, tbody:byId('tbody'), status:byId('status'),
  net:byId('net'), q:byId('q')
};
const st={markets:[],dict:{},aliases:new Map(),tickers:new Map(),hist:new Map(),rx:0,last:0};
function byId(id){return document.getElementById(id)}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function tick(p){if(p>=2e6)return 1e3;if(p>=1e6)return 500;if(p>=5e5)return 100;if(p>=1e5)return 50;if(p>=1e4)return 10;if(p>=1e3)return 5;if(p>=100)return 1;if(p>=10)return .1;if(p>=1)return .01;return .001;}
function fKRW(p){if(typeof p!=='number'||!isFinite(p)) return '-'; const t=tick(p);const d=t>=1?0:t===.1?1:t===.01?2:3;return Number(p||0).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d})}
function pct(v){return (Number(v||0)*100).toFixed(2)+'%'}
async function fetchUpbit(url){try{const r=await fetch(url,{cache:'no-store'});if(r.ok)return await r.json()}catch{} const r=await fetch(API.LOCAL(url));return await r.json()}

/* ===== ì´ˆê¸°í™” ===== */
async function init(){
  try{
    const data=await fetchUpbit(API.REST_MARKETS);
    st.markets=data.filter(x=>x.market?.startsWith('KRW-'));
    el.status.textContent=`KRW ${st.markets.length}ì¢… ë¡œë“œ ì™„ë£Œ`;
  }catch{ st.markets=FALLBACK_MARKETS; el.status.textContent='ì—…ë¹„íŠ¸ ì—°ê²° ì‹¤íŒ¨ â€” ê¸°ë³¸ ë§ˆì¼“ìœ¼ë¡œ ê°€ë™'; }

  buildSearchIndex();

  // ì˜ˆì—´ ìºì‹œ ë¨¼ì € í‘œì‹œ
  renderPreheat(loadCache());

  await pollTickers(); scanPreheat(); renderTable(st.markets.slice(0,20));
  setInterval(async()=>{ await pollTickers(); scanPreheat(); }, 1000);

  byId('qSHIB').onclick=(e)=>{e.preventDefault(); el.q.value='ì‹œë°”ì´ëˆ„'; onSearch();};
  byId('qADA').onclick=(e)=>{e.preventDefault(); el.q.value='ì—ì´ë‹¤'; onSearch();};
}

/* ===== ê²€ìƒ‰ ì¸ë±ìŠ¤(ì´ˆê°•í™”) ===== */
function norm(s){return (s||'').toString().toLowerCase().replace(/\s+/g,'')}
function addDict(key,m){ if(!key) return; const k=norm(key); (st.dict[k]??=[]).push(m); }
function addAlias(market, names){ st.aliases.set(market, (st.aliases.get(market)||[]).concat(names)); names.forEach(n=>addDict(n,{market})); }

function buildSearchIndex(){
  st.dict={}; st.aliases.clear();
  for(const m of st.markets){
    addDict(m.market,m); addDict(m.korean_name,m); addDict(m.english_name,m);
    addDict((m.korean_name||'').replace(/\s+/g,''),m); // ê³µë°± ì œê±°í˜•
  }
  // ì£¼ìš” ì½”ì¸ ë³„ì¹­ ì¶”ê°€
  addAlias('KRW-ETH',['ì´ë”ë¦¬ì›€','eth','ì´ë”']); 
  addAlias('KRW-ETC',['ì´ë”ë¦¬ì›€í´ë˜ì‹','ì´ë”ë¦¬ì›€ í´ë˜ì‹','í´ë˜ì‹','etc']);
  addAlias('KRW-ADA',['ì—ì´ë‹¤','ada','ì¹´ë¥´ë‹¤ë…¸','cardano']);
  addAlias('KRW-SHIB',['ì‹œë°”ì´ëˆ„','ì‹œë°”','shib','shiba']);
  addAlias('KRW-DOGE',['ë„ì§€','ë„ì§€ì½”ì¸','doge','dogecoin']);
  addAlias('KRW-XRP',['ë¦¬í”Œ','xrp']);
  addAlias('KRW-SOL',['ì†”ë¼ë‚˜','sol','solana']);
  addAlias('KRW-XLM',['ìŠ¤í…”ë¼','ìŠ¤í…”ë¼ë£¨ë©˜','xlm','stellar']);
  // â€œì´ë”ë¦¬ì›€â€ ì…ë ¥ ì‹œ ETH+ETC ëª¨ë‘ ë…¸ì¶œ ê¸°ëŒ€ ë¡œì§ì€ searchAllì—ì„œ ì²˜ë¦¬
}

/* ===== í´ë§ + íˆìŠ¤í† ë¦¬ ===== */
async function pollTickers(){
  const codes=st.markets.map(m=>m.market); const chunk=80; const now=Date.now();
  for(let i=0;i<codes.length;i+=chunk){
    try{
      const arr=await fetchUpbit(API.REST_TICKER(codes.slice(i,i+chunk)));
      for(const t of arr){
        const price=Number(t.trade_price), chg=Number(t.signed_change_rate);
        st.tickers.set(t.market,{market:t.market,trade_price:price, high_price:Number(t.high_price), signed_change_rate:isFinite(chg)?chg:0, acc_trade_price_24h:Number(t.acc_trade_price_24h||0), ts:now});
        const h=st.hist.get(t.market)||[]; h.push({ts:now,price:price,acc:Number(t.acc_trade_price_24h||0),high:Number(t.high_price||price)});
        const cut=now-TH.baselineMin*1000; while(h.length&&h[0].ts<cut)h.shift(); st.hist.set(t.market,h);
      }
    }catch{}
  }
  st.rx++; st.last=now; el.net.textContent=`ì—°ê²° OK Â· ìˆ˜ì‹  ${st.rx} Â· ë§ˆì§€ë§‰ ${new Date(st.last).toLocaleTimeString()}`;
}

/* ===== 1ë¶„ í†µê³„ ===== */
function oneMin(m){ const arr=st.hist.get(m)||[]; if(arr.length<2) return null; const now=Date.now(); const pastTs=now-60*1000;
  let past=arr[0]; for(let i=arr.length-1;i>=0;i--){ if(arr[i].ts<=pastTs){ past=arr[i]; break; } }
  const cur=arr[arr.length-1], old=arr.find(x=>x.ts>=now-600*1000)||arr[0];
  const base=(Math.max(0,cur.acc-old.acc))/Math.max(1,(cur.ts-old.ts)/60000);
  const pct=(past.price>0?(cur.price-past.price)/past.price:0);
  const accel=base>0?(Math.max(0,cur.acc-past.acc)/base):0;
  const near=(cur.high>0)?Math.max(0,(cur.high-cur.price)/cur.high):1;
  return {pct,accel,near,price:cur.price,high:cur.high};
}

/* ===== ìœ„í—˜ë„/í•œë§ˆë”” ===== */
function riskScore(s){ const near=(1-Math.min(1,s.near))*0.5, accel=Math.min(3,s.accel)/3*0.35, gain=Math.max(0,Math.min(1,(s.pct-0.002)/(0.02-0.002)))*0.15; return Math.max(0.8, Math.min(2.2, 1.0+near+accel+gain-0.1)); }
function oneLinerFromStat(s){ const r=riskScore(s); if(s.pct>0.015&&s.accel>2.2&&s.near<0.003)return{act:'buy',msg:'ì í™” ì§ì „ â€” 1ì°¨ ì§„ì… ê´€ì ',risk:r}; if(s.pct>0.008&&s.accel>1.8)return{act:'hold',msg:'ê°€ì—´ ì§„í–‰ â€” ëˆŒë¦¼ í™•ì¸ í›„ ì¶”ê²© ê¸ˆì§€',risk:r}; if(s.pct<0.003)return{act:'hold',msg:'ì˜ˆì—´ ì´ˆê¸° â€” ê´€ë§/ê°ì‹œ',risk:r}; return{act:'hold',msg:'ì¡°ê±´ ëª¨ë‹ˆí„°ë§ ì§€ì†',risk:r}; }

/* ===== ì˜ˆì—´ ìŠ¤ìº” + í‘œ ===== */
function saveCache(arr){ localStorage.setItem(PREHEAT_CACHE_KEY, JSON.stringify(arr)); }
function loadCache(){ try{ const a=JSON.parse(localStorage.getItem(PREHEAT_CACHE_KEY)||'[]'); return Array.isArray(a)?a:[]; }catch{return []} }
const scanPreheat = debounce(function(){
  const list=[];
  for(const m of st.markets){ const s=oneMin(m.market); if(!s) continue;
    if(s.near<=TH.preNearHighPct && s.pct>=TH.preMinMove && s.pct<=TH.preMaxMove && s.accel>=TH.preAccel){
      list.push({market:m.market, name: (st.markets.find(x=>x.market===m.market)?.korean_name)||m.market, ts:Date.now(), ...s});
    }
  }
  if(!list.length) return;
  const mp=new Map(loadCache().map(x=>[x.market,x])); list.forEach(n=>mp.set(n.market,n));
  const merged=[...mp.values()].sort((a,b)=>b.ts-a.ts).slice(0,48);
  saveCache(merged); renderPreheat(merged); renderAITable(); // AI í‘œë„ ìë™ ê°±ì‹ 
}, 300);

function renderPreheat(arr){
  const body=el.preheatBody;
  if(!arr||!arr.length){ body.innerHTML='<tr><td colspan="8" class="status">ì˜ˆì—´ í›„ë³´ ì—†ìŒ(ê°ì‹œ ì¤‘)</td></tr>'; return; }
  body.innerHTML='';
  for(const it of arr){
    const t=st.tickers.get(it.market); if(!t||typeof t.trade_price!=='number') continue;
    const k=tick(t.trade_price); const lv={buy:t.trade_price-2*k, sell:t.trade_price+3*k, cut:t.trade_price-6*k};
    const cls=(t.signed_change_rate||0)>=0?'up':'down'; const ol=oneLinerFromStat(it);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="tag">${it.market.replace('KRW-','')}</span> ${it.name||''}</td>
      <td class="price ${cls}">${fKRW(t.trade_price)}</td>
      <td class="${cls}">${pct(t.signed_change_rate)}</td>
      <td class="price">${fKRW(lv.buy)}</td>
      <td class="price">${fKRW(lv.sell)}</td>
      <td class="price">${fKRW(lv.cut)}</td>
      <td>${ol.risk.toFixed(2)}</td>
      <td><span class="act ${ol.act}">${ol.act==='buy'?'ë§¤ìˆ˜':'ê´€ë§'}</span> Â· ${ol.msg}</td>`;
    body.appendChild(tr);
  }
}

/* ===== ì‚¬ëŒí˜• AI í‘œ ===== */
async function analyzeHuman(market){
  const [h1,h4,d1]=await Promise.all(['1h','4h','1d'].map(f=>fetchUpbit(API.CANDLE(market,f))));
  if(!(h1.length&&h4.length&&d1.length)) throw new Error('no candles');
  const close1h=h1.map(c=>c.trade_price).reverse();
  const rsi=(v,p=14)=>{if(v.length<p+1)return[];let g=0,l=0;for(let i=1;i<=p;i++){const ch=v[i-1]-v[i];if(ch>0)g+=ch;else l+=-ch}let ag=g/p,al=l/p;const out=new Array(v.length).fill(null);out[p]=100-(100/(1+ag/(al||1e-9)));for(let i=p+1;i<v.length;i++){const ch=v[i-1]-v[i];const G=ch>0?ch:0,L=ch<0?-ch:0;ag=(ag*(p-1)+G)/p;al=(al*(p-1)+L)/p;const rs=ag/(al||1e-9);out[i]=100-(100/(1+rs))}return out}
  const bb=(v,period=20,m=2)=>{const out=new Array(v.length).fill(null);for(let i=period-1;i<v.length;i++){const s=v.slice(i-period+1,i+1);const mean=s.reduce((a,b)=>a+b,0)/s.length;const sd=Math.sqrt(s.reduce((a,b)=>a+(b-mean)**2,0)/s.length);out[i]={mid:mean,up:mean+m*sd,dn:mean-m*sd}}return out};
  const last=a=>a[a.length-1]; const b1=bb(close1h); const r1=rsi(close1h);
  const price=last(h1).trade_price; const t=st.tickers.get(market)||{trade_price:price, signed_change_rate:0};
  const k=tick(price); const lv={buy:price-2*k, sell:price+3*k, cut:price-6*k};
  const cond1=(last(r1)<50)&&(b1[b1.length-1]?.mid && price>=b1[b1.length-1].mid);
  const cond2=(b1[b1.length-1]?.up && price>=b1[b1.length-1].up*0.992);
  let act='hold', msg='ë°©í–¥ì„± ë¯¸í™•ì • â€” ê´€ë§', risk=1.3;
  if(cond1){ act='buy'; msg='1h ì¤‘ë‹¨ì„  ì¬ì•ˆì°© â€” 1ì°¨ ì§„ì… ê²€í† '; risk=1.1; }
  if(cond2){ act='sell'; msg='1h ìƒë‹¨ë°´ë“œ ê·¼ì ‘ â€” ë¶„í•  ìµì ˆ'; risk=1.6; }
  return { market, name:(st.markets.find(x=>x.market===market)?.korean_name)||market,
           price:t.trade_price, chg:t.signed_change_rate, lv, act, msg, risk };
}

async function renderAITable(useList){
  const body=el.aiBody;
  let targets=[];
  if(Array.isArray(useList) && useList.length){ targets = useList; }
  else{
    const cache=loadCache();
    targets = cache.slice(0,8).map(x=>x.market); // ì˜ˆì—´ ìƒìœ„
    if(!targets.length) targets = st.markets.slice(0,8).map(m=>m.market);
  }
  if(!targets.length){ body.innerHTML='<tr><td colspan="8" class="status">ëŒ€ìƒ ì—†ìŒ</td></tr>'; return; }
  body.innerHTML='<tr><td colspan="8" class="status">ë¶„ì„ ì¤‘â€¦</td></tr>';
  const results = await Promise.allSettled(targets.map(analyzeHuman));
  const rows = results.filter(r=>r.status==='fulfilled').map(r=>r.value);
  if(!rows.length){ body.innerHTML='<tr><td colspan="8" class="status">ë¶„ì„ ì‹¤íŒ¨ â€” ì ì‹œ í›„ ìë™ ì¬ì‹œë„</td></tr>'; return; }
  body.innerHTML='';
  rows.forEach(x=>{
    if(typeof x.price!=='number') return;
    const cls=(x.chg||0)>=0?'up':'down';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="tag">${x.market.replace('KRW-','')}</span> ${x.name||''}</td>
      <td class="price ${cls}">${fKRW(x.price)}</td>
      <td class="${cls}">${pct(x.chg)}</td>
      <td class="price">${fKRW(x.lv.buy)}</td>
      <td class="price">${fKRW(x.lv.sell)}</td>
      <td class="price">${fKRW(x.lv.cut)}</td>
      <td>${x.risk.toFixed(2)}</td>
      <td><span class="act ${x.act}">${x.act==='buy'?'ë§¤ìˆ˜':x.act==='sell'?'ë§¤ë„':'ê´€ë§'}</span> Â· ${x.msg}</td>`;
    body.appendChild(tr);
  });
}

/* ===== ì˜ˆì—´ ìºì‹œ(í‘œ) ===== */
function renderPreheat(arr){ /* ìœ„ì˜ renderPreheat ì¬ì •ì˜ë¨ â€” ì½”ë“œ ê¸¸ì´ ì ˆì•½ìš© */ }

/* ===== í‘œ/ê²€ìƒ‰ ===== */
function levels(p){ const k=tick(p); return {buy:p-2*k, sell:p+3*k, cut:p-6*k}; }
function renderTable(list){
  const tb=el.tbody; tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="7" class="status">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>'; return; }
  for(const m of list){
    const t=st.tickers.get(m.market); if(!t||typeof t.trade_price!=='number') continue;
    const lv=levels(t.trade_price); const cls=(t.signed_change_rate||0)>=0?'up':'down';
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td><span class="tag">${m.market.replace('KRW-','')}</span> ${m.korean_name||m.english_name||''}</td>
      <td class="price ${cls}">${fKRW(t.trade_price)}</td>
      <td class="${cls}">${pct(t.signed_change_rate)}</td>
      <td class="price">${fKRW(lv.buy)}</td>
      <td class="price">${fKRW(lv.sell)}</td>
      <td class="price">${fKRW(lv.cut)}</td>
      <td></td>`; tb.appendChild(tr);
  }
}
function searchAll(q){
  if(!q) return st.markets.slice(0,20);
  const key=norm(q);
  let list=(st.dict[key]??[]).slice(0);
  // ë¶€ë¶„ í¬í•¨ ë§¤ì¹­
  if(list.length<30){
    const extra=st.markets.filter(m=>{
      const n1=norm(m.korean_name), n2=(m.english_name||'').toLowerCase(), n3=m.market.toLowerCase();
      return n1.includes(key)||n2.includes(key)||n3.includes(key);
    });
    extra.forEach(m=>{ if(!list.find(x=>x.market===m.market)) list.push(m); });
  }
  // "ì´ë”ë¦¬ì›€" ê²€ìƒ‰ ì‹œ ETH+ETC ê°™ì´
  if(/ì´ë”ë¦¬ì›€/.test(key)){ ['KRW-ETH','KRW-ETC'].forEach(code=>{ const m=st.markets.find(x=>x.market===code); if(m && !list.find(x=>x.market===m.market)) list.unshift(m); }); }
  return list.slice(0,30);
}

/* ===== ì´ë²¤íŠ¸ ===== */
function onSearch(){
  const list=searchAll(el.q.value);
  renderTable(list);
  // ì‚¬ëŒí˜• AI í‘œë„ ê²€ìƒ‰ ê²°ê³¼ ê¸°ì¤€ìœ¼ë¡œ ê°±ì‹  (ìƒìœ„ 12ê°œ ë¶„ì„)
  renderAITable(list.slice(0,12).map(m=>m.market));
}
byId('btnSearch').onclick=onSearch;
el.q.onkeydown=(e)=>{ if(e.key==='Enter') onSearch(); };
byId('btnTop').onclick=()=>{ const arr=[...st.tickers.values()].filter(t=>typeof t.trade_price==='number').sort((a,b)=>(b.signed_change_rate||0)-(a.signed_change_rate||0)).slice(0,10).map(t=>st.markets.find(m=>m.market===t.market)); renderTable(arr); renderAITable(arr.map(x=>x.market)); };
byId('btnHot').onclick=()=>{ const hot=st.markets.filter(m=>{const h=oneMin(m.market);return h && h.pct>=0.03 && h.accel>=1.8}); renderTable(hot.slice(0,20)); renderAITable(hot.slice(0,12).map(x=>x.market)); };
byId('btnFall').onclick=()=>{ const fall=st.markets.filter(m=>{const h=oneMin(m.market);return h && h.pct<=-0.03 && h.accel>=1.8}); renderTable(fall.slice(0,20)); renderAITable(fall.slice(0,12).map(x=>x.market)); };
byId('btnReset').onclick=()=>{ el.q.value=''; const base=st.markets.slice(0,20); renderTable(base); renderAITable(); };

/* ===== ì‹œì‘ ===== */
(async function start(){
  // ì˜ˆì—´ í‘œ ë Œë” ì¬ì •ì˜ (ìƒë‹¨ renderPreheat í˜¸ì¶œìš©)
  window.renderPreheat = function(arr){
    const body = document.getElementById('preheatBody');
    if(!arr || !arr.length){ body.innerHTML='<tr><td colspan="8" class="status">ì˜ˆì—´ í›„ë³´ ì—†ìŒ(ê°ì‹œ ì¤‘)</td></tr>'; return; }
    body.innerHTML='';
    for(const it of arr){
      const t=st.tickers.get(it.market); if(!t || typeof t.trade_price!=='number') continue;
      const k=tick(t.trade_price); const lv={buy:t.trade_price-2*k, sell:t.trade_price+3*k, cut:t.trade_price-6*k};
      const cls=(t.signed_change_rate||0)>=0?'up':'down'; const ol=oneLinerFromStat(it);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><span class="tag">${it.market.replace('KRW-','')}</span> ${it.name||''}</td>
        <td class="price ${cls}">${fKRW(t.trade_price)}</td>
        <td class="${cls}">${pct(t.signed_change_rate)}</td>
        <td class="price">${fKRW(lv.buy)}</td>
        <td class="price">${fKRW(lv.sell)}</td>
        <td class="price">${fKRW(lv.cut)}</td>
        <td>${ol.risk.toFixed(2)}</td>
        <td><span class="act ${ol.act}">${ol.act==='buy'?'ë§¤ìˆ˜':'ê´€ë§'}</span> Â· ${ol.msg}</td>`;
      body.appendChild(tr);
    }
  };
  await init();
  // ì²« ë¡œë“œì‹œ AI í‘œ: ì˜ˆì—´ ìºì‹œ/ìƒìœ„ ìë™
  renderAITable();
})();
</script>
</body>
</html>
