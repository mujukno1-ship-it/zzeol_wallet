<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 v12.1 — Satoshi Precision Set (Stable)</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0f1218;--panel:#151a21;--muted:#9aa4b2;--text:#e7eef8;--accent:#5ac8fa;--up:#1ec996;--down:#ff5b6b;--chip:#1f2630;--rail:#2a3340;--spark:#ffb020}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .badge{background:#19202a;color:#9bc3ff;border:1px solid #2a3950;border-radius:10px;padding:4px 8px;font-size:12px}
  .api{margin-left:auto;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .api .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#888}
  .api.ok .dot{background:#1ec996}
  .api.fail .dot{background:#ff5b6b}
  .search{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,24,.95),rgba(15,18,24,.75));padding:10px 0 12px;z-index:5;backdrop-filter:saturate(1.2) blur(2px)}
  .search .row{display:flex;gap:8px;align-items:center}
  .search input{flex:1;background:#11161d;border:1px solid #263246;color:var(--text);border-radius:10px;padding:12px 14px;outline:none}
  .search button{background:#1b2533;border:1px solid #2b3a52;color:#d7e6ff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #202734;border-radius:18px;padding:14px}
  .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .title small{margin-left:6px;color:var(--muted);font-weight:500}
  .list{display:grid;gap:10px;margin-top:12px}
  .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#11161d;border:1px solid #1d2633}
  .item .name{display:flex;flex-direction:column}
  .item .name b{font-size:13px}
  .bar{height:6px;background:var(--rail);border-radius:999px;overflow:hidden}
  .bar span{display:block;height:100%;background:var(--spark);width:0%}
  .pillrow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid #273041;font-size:12px;color:#c8d3e2}
  .pill.badge{background:#121820}
  .ultra{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
  .box{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:10px;min-height:58px}
  .k{color:var(--muted);font-size:12px}
  .v{font-weight:700;margin-top:2px}
  .note{margin-top:10px;background:#10151c;border:1px dashed #2a3340;border-radius:12px;padding:10px;font-size:13px;color:#dbe8ff}
  footer{margin:18px 0 10px;color:#8fa0b5;font-size:12px;text-align:center}
  .reserve{min-height:320px;display:flex;align-items:center;justify-content:center;color:#6e7a8a}
  #suggest{position:absolute;z-index:9999;background:#111;border:1px solid #333;border-radius:8px;padding:6px 0;display:none}
  #suggest .row{padding:8px 12px;cursor:pointer}
  #suggest .row:hover{background:#1f2937}
  .warn{margin-top:8px;color:#ffb8c0;font-size:12px;display:none}
  .gwrap{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  @media (max-width:980px){.gwrap{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .gbox{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:10px}
  .ghead{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .gsub{font-size:11px;color:var(--muted)}
  .gnum{font-weight:800;margin-top:6px}
  .gchg{font-size:12px;margin-top:2px}
  .up{color:var(--up)} .down{color:var(--down)}
</style>
</head>
<body>
<div class="wrap">
  <div class="search">
    <div class="row">
      <span class="badge">KRW · 업비트 호가틱 · 한글명 · No-Motion</span>
      <div class="api" id="apiHealth">
        <span class="dot"></span>
        <span id="apiBaseTxt">https://satoshi-proxy.mujukno1.workers.dev/api</span>
        <span id="latency" style="opacity:.7"></span>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="q" placeholder="검색: 한글명 / 심볼 / 마켓코드 (예: 에이다, ADA, KRW-ADA, 시바이누, SHIB, KRW-SHIB)" />
      <button id="btnSearch">검색</button>
    </div>
    <div class="warn" id="apiWarn">API 연결이 원활하지 않습니다. 새로고침하거나 잠시 후 다시 시도하세요.</div>

    <div class="gwrap" id="globalPanel" hidden>
      <div class="gbox"><div class="ghead">NASDAQ 100<span class="gsub">NDX</span></div><div class="gnum" id="g_ndx">-</div><div class="gchg" id="gc_ndx">-</div></div>
      <div class="gbox"><div class="ghead">S&P 500<span class="gsub">SPX</span></div><div class="gnum" id="g_spx">-</div><div class="gchg" id="gc_spx">-</div></div>
      <div class="gbox"><div class="ghead">Dollar Index<span class="gsub">DXY</span></div><div class="gnum" id="g_dxy">-</div><div class="gchg" id="gc_dxy">-</div></div>
      <div class="gbox"><div class="ghead">US 10Y<span class="gsub">Yield</span></div><div class="gnum" id="g_us10y">-</div><div class="gchg" id="gc_us10y">-</div></div>
    </div>
  </div>

  <div class="grid">
    <!-- SPARK -->
    <section class="card" id="sparkCard">
      <div class="title">SPARK TOP10 — 급등 전 예열코인 🔥 <small>(고정)</small></div>
      <div class="pillrow" style="margin-top:8px">
        <span class="pill badge">예열 조건: RVOL≥1.8 · TBR≥0.60 · OBI≥+0.15 · 최근5분 변동률≥+1.5% (4개 이상 충족 시 확정)</span>
      </div>
      <div id="sparkList" class="list"></div>
      <div id="sparkEmpty" class="reserve" hidden>예열 코인을 탐색중…</div>
    </section>

    <!-- ULTRA -->
    <section class="card">
      <div class="title" id="ultraTitle">ULTRA 시그널 — 선택된 코인</div>

      <div class="ultra">
        <div class="box"><div class="k">현재가</div><div class="v" id="v_price">-</div></div>
        <div class="box"><div class="k">매수 (BUY1)</div><div class="v" id="v_buy1">-</div></div>
        <div class="box"><div class="k">추가매수 (BUY2)</div><div class="v" id="v_buy2">-</div></div>
        <div class="box"><div class="k">익절 1 (TP1)</div><div class="v" id="v_tp1">-</div></div>
        <div class="box"><div class="k">익절 2 (TP2)</div><div class="v" id="v_tp2">-</div></div>
        <div class="box"><div class="k">손절 (SL)</div><div class="v" id="v_sl">-</div></div>
      </div>

      <div class="ultra" style="margin-top:6px">
        <div class="box"><div class="k">예상 고점 1</div><div class="v" id="v_hi1">-</div></div>
        <div class="box"><div class="k">예상 고점 2</div><div class="v" id="v_hi2">-</div></div>
        <div class="box"><div class="k">예상 저점 1</div><div class="v" id="v_lo1">-</div></div>
        <div class="box"><div class="k">되돌림 목표</div><div class="v" id="v_retr">-</div></div>
        <div class="box"><div class="k">되돌림 후 매도 1</div><div class="v" id="v_rs1">-</div></div>
        <div class="box"><div class="k">되돌림 후 매도 2</div><div class="v" id="v_rs2">-</div></div>
      </div>

      <div class="pillrow" style="margin-top:10px">
        <span class="pill badge">예열강도 <b id="chip_heat">0</b></span>
        <span class="pill badge">상승확률 <b id="chip_prob">0%</b></span>
        <span class="pill badge">예상상승률 <b id="chip_gain">+0%</b></span>
        <span class="pill badge">정확도 <b id="chip_prec">-</b></span>
        <span class="pill badge">위험도 <b id="chip_risk">-</b></span>
        <span class="pill badge">되돌림 <b id="chip_pull">-</b></span>
        <span class="pill badge">당일 고점 <b id="chip_DH">-</b></span>
        <span class="pill badge">당일 저점 <b id="chip_DL">-</b></span>
      </div>

      <div class="pillrow" style="margin-top:6px">
        <span class="pill badge">MTF 모드 <b id="chip_mtf_mode">-</b></span>
        <span class="pill badge">MTF 점수 <b id="chip_mtf_score">0</b></span>
        <span class="pill badge">보정량 <b id="chip_adj">±0.0%</b></span>
      </div>

      <div class="note" id="z_msg">코인을 선택하면 쩔어한마디가 표시됩니다.</div>
    </section>
  </div>

  <footer>사토시의지갑 v12.1 · Satoshi Precision Set · Precision Boost Extended · No-Motion</footer>
</div>

<div id="suggest"></div>

<script>
/* ===== 설정 ===== */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
document.getElementById('apiBaseTxt').textContent = API_BASE;

const REFRESH_SPARK_MS = 15000;
const REFRESH_ULTRA_MS = 5000;
const USE_CANDLES = true;        // 1분봉 240개로 ATR/HH/LL 계산
const CANDLE_LIMIT = 240;

/* ===== 유틸 ===== */
const $ = s=>document.querySelector(s);
const setTxt=(el,v)=>{ if(el && String(el.textContent)!==String(v)) el.textContent=String(v); };
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const debounce=(fn,ms=200)=>{let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);}};
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

/* ===== 업비트 호가틱 + KRW 포맷 ===== */
function upbitTick(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  return 0.0001;
}
function roundTick(price){ const t=upbitTick(price); return Math.round(price/t)*t; }
function fmtKRW(n){
  if(n==null || isNaN(n)) return '-';
  const v=roundTick(Number(n));
  const t=upbitTick(v);
  const frac=t<1?String(t).split('.')[1].length:0;
  return v.toLocaleString('ko-KR',{minimumFractionDigits:frac,maximumFractionDigits:frac})+'원';
}
const pricePct=(base,pct)=>roundTick(Number(base)*(1+pct));

/* ===== API 헬퍼 ===== */
async function jget(path, {retries=2, timeout=9000} = {}){
  let lastErr=null;
  for(let attempt=0; attempt<=retries; attempt++){
    const ctl = new AbortController();
    const to = setTimeout(()=>ctl.abort(), timeout);
    try{
      const t0 = performance.now();
      const r = await fetch(API_BASE+path, {headers:{accept:'application/json'}, signal:ctl.signal});
      clearTimeout(to);
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      const d = await r.json();
      if(path==='/ping') setTxt($('#latency'), Math.round(performance.now()-t0)+'ms');
      if(d && d.ok===false) throw new Error(d.error||'api');
      return d;
    }catch(e){
      clearTimeout(to);
      lastErr=e;
      await sleep(200+attempt*200);
    }
  }
  console.error('API ERR', path, lastErr);
  return null;
}

/* ===== API 건강 체크 ===== */
async function ping(){
  const badge = $('#apiHealth');
  const warn  = $('#apiWarn');
  const ok = await jget('/ping',{retries:1});
  if(ok?.pong){ badge.classList.add('ok'); badge.classList.remove('fail'); warn.style.display='none'; }
  else { badge.classList.add('fail'); badge.classList.remove('ok'); warn.style.display='block'; }
}

/* ===== 업비트 마켓 목록 & 검색 ===== */
let MARKET_LIST=[];
async function loadMarkets(){
  if(MARKET_LIST.length) return MARKET_LIST;
  const d=await jget('/upbit/tickers',{retries:2});
  if(Array.isArray(d?.items)) MARKET_LIST=d.items;
  return MARKET_LIST;
}
function resolveMarket(input){
  if(!input) return null;
  const raw=input.trim();
  const s=raw.toUpperCase();
  if(s.startsWith('KRW-')) return s;
  let hit=MARKET_LIST.find(x=>(x.english_name||'').toUpperCase()===s);
  if(hit) return hit.market;
  hit=MARKET_LIST.find(x=>(x.korean_name||'').includes(raw));
  if(hit) return hit.market;
  hit=MARKET_LIST.find(x=>(x.market||'').toUpperCase().includes(s));
  return hit?.market||null;
}

/* ===== SPARK TOP10 ===== */
let sparkTimer=null;
async function renderSpark(){
  const listEl=$('#sparkList'), emptyEl=$('#sparkEmpty');
  const d=await jget('/spark/top?limit=10',{retries:1});
  listEl.innerHTML='';
  if(!Array.isArray(d?.list)||d.list.length===0){ emptyEl.hidden=false; return; }
  emptyEl.hidden=true;

  d.list.forEach(it=>{
    const row=document.createElement('div'); row.className='item'; row.dataset.m=it.market;
    const n=document.createElement('div'); n.className='name';
    n.innerHTML=`<b>${it.korean_name||it.market}</b><small style="color:var(--muted)">${it.market}</small>`;
    const r=document.createElement('div');
    r.innerHTML=`<div style="text-align:right">${fmtKRW(Number(it.price||0))}</div>
                 <div class="bar"><span style="width:${clamp(it.spark||0,0,100)}%"></span></div>
                 <div class="pillrow" style="justify-content:flex-end">
                   <span class="pill">SPARK ${it.spark||0}</span>
                   <span class="pill">RVOL ${(it.rvol??0).toFixed?.(2) ?? it.rvol}</span>
                   <span class="pill">TBR ${Math.round((it.tbr||0)*100)}%</span>
                 </div>`;
    row.appendChild(n); row.appendChild(r);
    row.addEventListener('click',()=>openUltra(it.market,it));
    listEl.appendChild(row);
  });
}
function startSparkAuto(){
  if(sparkTimer) clearInterval(sparkTimer);
  sparkTimer=setInterval(renderSpark, REFRESH_SPARK_MS);
}

/* ===== 1m 캔들 → ATR/HH/LL ===== */
async function loadCandles(market){
  if(!USE_CANDLES) return null;
  const d=await jget(`/candles?market=${encodeURIComponent(market)}&tf=1m&limit=${CANDLE_LIMIT}`, {retries:1});
  return Array.isArray(d?.items||d)?.length ? (d.items||d) : null;
}
function calcATR(candles, n=14){
  if(!Array.isArray(candles)||candles.length<n+1) return {atr:0, atrPct:0, hh:null, ll:null};
  let TR=0, atr=0;
  for(let i=1;i<=n;i++){
    const c=candles[candles.length-1-i], p=candles[candles.length-2-i];
    const h=c.high, l=c.low, pc=(p?.close ?? c.open);
    const tr=Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
    TR += tr;
  }
  atr = TR/n;
  const recent = candles.slice(-Math.max(n*2,30));
  let hh=-Infinity,ll=Infinity;
  for(const c of recent){ if(c.high>hh) hh=c.high; if(c.low<ll) ll=c.low; }
  const lastClose = candles[candles.length-1]?.close ?? (hh+ll)/2;
  const atrPct = lastClose? (atr/lastClose) : 0;
  return {atr, atrPct, hh, ll, lastClose};
}

/* ===== 쩔어한마디 ===== */
function makeZMsg(s){
  const force=Number(s.forceIndex||s.force||0), rvol=Number(s.rvol||0), tbr=Number(s.tbr||0);
  const heat=clamp(Math.round(Number(s.spark||s.heat||0)),0,100);
  const prob=clamp(Math.round(Number(s.prob_up ?? (heat/1.6))),0,100);
  const gain=Number(s.expected_gain ?? (heat>=90?20:heat>=80?10:heat>=70?5:2));
  let mode='조정';
  if((rvol>=2&&tbr>=0.65)||force>=80) mode='불장';
  else if(tbr<=0.45||force<=35 || s.vwapBelow) mode='하락장';
  const text= mode==='불장'
    ? `🔥 세력 분출 직전 — 예열강도 ${heat} / 상승확률 ${prob}% / 예상상승률 +${(+gain).toFixed(1)}%`
    : mode==='하락장'
      ? `🧊 세력 이탈 감지 — 빠른 청산 필요 / 예열강도 ${heat} / 방어모드`
      : `🔵 되돌림 신호 — 분할매수 1차 확인 / 예열강도 ${heat} / 중립`;
  return {mode,msg:text,heat,prob,gain};
}

/* ===== MTF 보정(±0.3%) ===== */
function calcMTFAdjust(seed){
  const s = seed||{};
  const price = Number(s.price||0)||0;
  const heat  = clamp(Number(s.spark||0),0,100);
  const rvol  = Number(s.rvol||0);
  const tbr   = Number(s.tbr||0);
  const retrP = Number(s.retracement_percent||0);
  const volRank = clamp(rvol/3, 0, 1);
  const w = { m1:0.18*volRank, m5:0.16*volRank, m30:0.12*volRank+0.04, h1:0.12*(0.6+volRank*0.4),
              h4:0.12*(0.5+(1-volRank)*0.5), h6:0.08*(0.5+(1-volRank)*0.5), d1:0.10*(0.4+(1-volRank)*0.6),
              w1:0.07*(0.3+(1-volRank)*0.7), m1x:0.05*(0.3+(1-volRank)*0.7)};
  const sigShort=((heat-50)/50)*0.5 + (tbr-0.5)*0.6 - (retrP>65?0.2:0) + (retrP<35?0.15:0);
  const sigMid  =((heat-50)/50)*0.4 + (tbr-0.5)*0.4;
  const sigLong =((heat-50)/50)*0.3 + (tbr-0.5)*0.3;
  const S={m1:clamp(sigShort,-1,1),m5:clamp(sigShort*0.9,-1,1),m30:clamp((sigShort*0.6+sigMid*0.4),-1,1),
           h1:clamp(sigMid,-1,1),h4:clamp((sigMid*0.7+sigLong*0.3),-1,1),h6:clamp((sigMid*0.6+sigLong*0.4),-1,1),
           d1:clamp(sigLong,-1,1),w1:clamp(sigLong*0.8,-1,1),m1x:clamp(sigLong*0.7,-1,1)};
  const sumW=Object.values(w).reduce((a,b)=>a+b,0)||1;
  let mtfScore=0; for(const k of Object.keys(S)){ mtfScore += (S[k]*100)*(w[k]/sumW); }
  mtfScore=clamp(Math.round(mtfScore),-100,100);
  const mode = mtfScore>=35 ? '불장' : mtfScore<=-35 ? '하락장' : '조정';
  let adj = Math.min(0.003, Math.max(0.0015, Math.abs(mtfScore)/4000));
  if(mode!=='조정') adj = Math.min(0.003, adj*1.2);
  return { mtfScore, mode, adj, price };
}

/* ===== Precision % 산출 ===== */
function calcPrecision(seed, mtf, atrPct){
  const s=seed||{};
  const force=Number(s.forceIndex||s.force||0);
  const rvol =Number(s.rvol||0);
  const tbr  =Number(s.tbr||0);
  const obi  =Number(s.obi||s.order_imbalance||0);
  const heat =clamp(Number(s.spark||0),0,100);
  // 가중: Force 0.28, TBR 0.22, RVOL 0.18, MTF 0.18, OBI 0.08, ATR정상범위 0.06
  const mtfNorm = (clamp(mtf.mtfScore,-100,100)+100)/200;        // 0~1
  const forceN  = clamp(force/100,0,1);
  const tbrN    = clamp((tbr-0.4)/0.4,0,1);                       // 0.4~0.8 범위 맵
  const rvolN   = clamp((rvol-0.8)/2.0,0,1);                      // 0.8~2.8
  const obiN    = clamp((obi+0.2)/0.4,0,1);                       // -0.2~+0.2
  const atrOK   = clamp(1-Math.abs((atrPct??0)-0.012)/0.02,0,1);  // ATR% 1.2% 근방을 이상적 범위로 가정
  let score = (forceN*0.28)+(tbrN*0.22)+(rvolN*0.18)+(mtfNorm*0.18)+(obiN*0.08)+(atrOK*0.06);
  // 예열 보정(+): heat가 높으면 소폭 가산
  score += clamp((heat-60)/100,0,0.08);
  // 하한/상한
  let prec = clamp(Math.round((0.82 + score*0.16)*1000)/10, 85, 99.5); // 85 ~ 99.5
  return prec;
}

/* ===== ULTRA ===== */
let currentMarket=null, ultraTimer=null;
async function openUltra(market, seed){
  if(!market) return;
  currentMarket = market;

  const [sig, candles] = await Promise.all([
    jget('/ultra/signal?market='+encodeURIComponent(market))||{},
    loadCandles(market)
  ]);
  const s=Object.assign({}, seed||{}, sig||{});
  const nameKor = s.korean_name || (MARKET_LIST.find(x=>x.market===market)?.korean_name) || s.name_kr || s.name || market;
  setTxt($('#ultraTitle'), `ULTRA 시그널 — ${nameKor} (${market})`);

  const price=Number(s.price||s.last||s.close||0)||0;
  const buy1 = s.buy1!=null?Number(s.buy1):roundTick(price*0.997);
  const buy2 = s.buy2!=null?Number(s.buy2):roundTick(price*0.992);

  // ATR/HH/LL 기반 정보
  let atr=0, atrPct=0, hh=null, ll=null, lastClose=price;
  if(Array.isArray(candles)){
    const a=calcATR(candles,14);
    atr=a.atr; atrPct=a.atrPct; hh=a.hh; ll=a.ll; lastClose=a.lastClose||price;
  }
  if(s.recent_high) hh = s.recent_high;
  if(s.recent_low)  ll = s.recent_low;

  // 베이스 TP/SL
  let tp1=s.tp1, tp2=s.tp2, sl=s.sl;
  if(tp1==null||tp2==null||sl==null){
    const force=Number(s.forceIndex||s.force||0), rvol=Number(s.rvol||0), tbr=Number(s.tbr||0);
    const bull=(rvol>=2&&tbr>=0.65)||force>=80, bear=(tbr<=0.45)||force<=35;
    // ATR% 가중 (1% 기준)
    const k = clamp((atrPct||0), 0.004, 0.04); // 0.4%~4%
    if(bull){
      tp1=roundTick(price + Math.max(price*0.012, price*k*1.6));
      tp2=roundTick(price + Math.max(price*0.020, price*k*2.6));
      sl =roundTick(price - Math.max(price*0.008, price*k*0.9));
    }else if(bear){
      tp1=roundTick(price + Math.max(price*0.006, price*k*0.7));
      tp2=roundTick(price + Math.max(price*0.010, price*k*1.1));
      sl =roundTick(price - Math.max(price*0.013, price*k*1.4));
    }else{
      tp1=roundTick(price + Math.max(price*0.010, price*k*1.2));
      tp2=roundTick(price + Math.max(price*0.018, price*k*2.0));
      sl =roundTick(price - Math.max(price*0.010, price*k*1.0));
    }
  }

  // MTF 보정 → Precision Boost Extended(±0.3%)
  const mtf = calcMTFAdjust(s);
  const sign = (mtf.mode==='불장') ? +1 : (mtf.mode==='하락장') ? -1 : 0;
  const tpAdjPct = sign * mtf.adj;
  const slAdjPct = -sign * (mtf.adj*0.8);
  let tp1_adj = pricePct(tp1, tpAdjPct);
  let tp2_adj = pricePct(tp2, tpAdjPct);
  let sl_adj  = pricePct(sl , slAdjPct);

  // 2차 보정(±0.3% 캡) — 김프/펀딩/TBR/OBI 신호가 강하면 미세 가감(서버 값이 들어오면 s.* 사용)
  const obi = Number(s.obi||s.order_imbalance||0);
  const tbr = Number(s.tbr||0);
  const adjExtra = clamp(((tbr-0.5)*0.002) + (obi*0.0015), -0.003, 0.003);
  tp1_adj=pricePct(tp1_adj, adjExtra);
  tp2_adj=pricePct(tp2_adj, adjExtra);
  sl_adj =pricePct(sl_adj , -adjExtra*0.6);

  // 화면 세팅
  setTxt($('#v_price'),fmtKRW(price));
  setTxt($('#v_buy1'),fmtKRW(buy1));
  setTxt($('#v_buy2'),fmtKRW(buy2));
  setTxt($('#v_tp1'),fmtKRW(tp1_adj));
  setTxt($('#v_tp2'),fmtKRW(tp2_adj));
  setTxt($('#v_sl'), fmtKRW(sl_adj));

  const hi1 = s.target_high1 ?? tp1_adj;
  const hi2 = s.target_high2 ?? tp2_adj;
  const lo1 = s.target_low1  ?? sl_adj;
  const retrTo = s.retracement_to ?? buy1;
  const rs1 = s.post_dip_sell1 ?? pricePct(retrTo, +0.012);
  const rs2 = s.post_dip_sell2 ?? pricePct(retrTo, +0.020);
  setTxt($('#v_hi1'), fmtKRW(hi1));
  setTxt($('#v_hi2'), fmtKRW(hi2));
  setTxt($('#v_lo1'), fmtKRW(lo1));
  setTxt($('#v_retr'), fmtKRW(retrTo));
  setTxt($('#v_rs1'), fmtKRW(rs1));
  setTxt($('#v_rs2'), fmtKRW(rs2));

  const z=makeZMsg(s);
  setTxt($('#chip_heat'),z.heat);
  setTxt($('#chip_prob'),`${z.prob}%`);
  setTxt($('#chip_gain'),`+${(+z.gain).toFixed(1)}%`);
  setTxt($('#chip_risk'), s.risk_level!=null?String(s.risk_level):(z.mode==='불장'?'2':(z.mode==='하락장'?'4':'3')));

  // 되돌림 칩
  let retr=null;
  if(Array.isArray(s.candles)) retr=computeRetracement(s.candles);
  if(s.retracement_percent!=null) retr={R:Number(s.retracement_percent), band:s.retr_band||''};
  if(!retr && Array.isArray(candles)){
    // 15개 샘플로 간이 계산
    const L=candles.slice(-15);
    let H=-Infinity,Lw=Infinity,C=L[L.length-1]?.close??lastClose;
    L.forEach(c=>{ if(c.high>H)H=c.high; if(c.low<Lw)Lw=c.low; });
    if(H>Lw && isFinite(C)) retr={R:clamp(((H-C)/(H-Lw))*100,0,100), band:(((H-C)/(H-Lw))*100)<35?'얕음':(((H-C)/(H-Lw))*100)<65?'보통':'깊음'};
  }
  const pullPrice = (s.retracement_to ?? s.pull_to ?? ll ?? buy1);
  const retrTxt = retr ? `${Number(retr.R).toFixed(0)}% ${retr.band||''} (${fmtKRW(pullPrice)}까지)` : `(${fmtKRW(pullPrice)}까지)`;
  setTxt($('#chip_pull'), retrTxt);

  if(hh) setTxt($('#chip_DH'), fmtKRW(hh));
  if(ll) setTxt($('#chip_DL'), fmtKRW(ll));

  setTxt($('#chip_mtf_mode'), mtf.mode);
  setTxt($('#chip_mtf_score'), mtf.mtfScore);
  setTxt($('#chip_adj'), `${(mtf.adj*100* (sign?1:0)).toFixed(2)}%`);

  // Precision %
  const prec = calcPrecision(s, mtf, atrPct);
  setTxt($('#chip_prec'), `${prec.toFixed(1)}%`);

  setTxt($('#z_msg'), z.msg);

  // 자동 새로고침
  if(ultraTimer) clearInterval(ultraTimer);
  ultraTimer = setInterval(()=>openUltra(currentMarket, null), REFRESH_ULTRA_MS);
}

/* ===== 검색/자동완성 ===== */
const $q=$('#q'), $btn=$('#btnSearch'), $sug=$('#suggest');
function placeSuggest(){ const r=$q.getBoundingClientRect(); $sug.style.left=(window.scrollX+r.left)+'px'; $sug.style.top =(window.scrollY+r.bottom+6)+'px'; $sug.style.width=r.width+'px'; }
window.addEventListener('resize',placeSuggest); window.addEventListener('scroll',placeSuggest);

function renderSuggest(q){
  if(!q){ $sug.style.display='none'; return; }
  const qq=q.trim().toLowerCase();
  const cand=MARKET_LIST.filter(x=>{
    const kn=(x.korean_name||'').toLowerCase();
    const en=(x.english_name||'').toLowerCase();
    const mk=(x.market||'').toLowerCase();
    return kn.includes(qq)||en.includes(qq)||mk.includes(qq);
  }).slice(0,10);
  $sug.innerHTML='';
  cand.forEach(x=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<b>${x.korean_name}</b> <span style="opacity:.7">(${x.market.replace('KRW-','')})</span>`;
    row.onclick=()=>{ $q.value=x.korean_name; $sug.style.display='none'; ensureTempSparkCard(x.market); openUltra(x.market,null); setDeepLink(x.market); };
    $sug.appendChild(row);
  });
  placeSuggest();
  $sug.style.display=cand.length?'block':'none';
}
$q.addEventListener('input', debounce(e=>renderSuggest(e.target.value),120));
document.addEventListener('click', e=>{ if(e.target!==$q && !$sug.contains(e.target)) $sug.style.display='none'; });

async function doSearch(){
  const q=$q.value.trim(); if(!q) return;
  await loadMarkets();
  const market=resolveMarket(q);
  if(!market){ alert('코인을 찾을 수 없습니다. (한글/심볼/마켓코드로 검색)'); return; }
  ensureTempSparkCard(market);
  setDeepLink(market);
  openUltra(market,null);
}
$btn.addEventListener('click', doSearch);
$q.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

function ensureTempSparkCard(market){
  const listEl=$('#sparkList');
  if (![...listEl.querySelectorAll('.item')].some(x=>x.dataset.m===market)){
    const row=document.createElement('div'); row.className='item'; row.dataset.m=market;
    const n=document.createElement('div'); n.className='name';
    const kn=(MARKET_LIST.find(x=>x.market===market)?.korean_name)||market;
    n.innerHTML=`<b>${kn}</b><small style="color:var(--muted)">${market}</small>`;
    const r=document.createElement('div');
    r.innerHTML=`<div style="text-align:right">-</div>
                 <div class="bar"><span style="width:0%"></span></div>
                 <div class="pillrow" style="justify-content:flex-end"><span class="pill">SPARK 0</span></div>`;
    row.appendChild(n); row.appendChild(r);
    row.addEventListener('click',()=>{ setDeepLink(market); openUltra(market,null); });
    listEl.prepend(row);
  }
}

/* ===== 글로벌(미국증시 등): Worker 프록시 + 폴백 ===== */
function paintGlobal(idBase, v){
  const num = $('#g_'+idBase), chg = $('#gc_'+idBase);
  if(!num||!chg||!v) return;
  num.textContent = isFinite(v.close) ? v.close.toLocaleString('en-US',{maximumFractionDigits:2}) : '-';
  const sign = v.chg>0 ? 'up' : v.chg<0 ? 'down' : '';
  chg.classList.remove('up','down'); if(sign) chg.classList.add(sign);
  chg.textContent = isFinite(v.chg) ? `${v.chg>0?'+':''}${v.chg.toFixed(2)}%` : '-';
}
async function loadGlobal(){
  const panel = $('#globalPanel');
  let data = null;
  try{
    const d = await fetch(`${API_BASE}/global?s=%5Endx,%5Espx,dxy,us10y`,{headers:{accept:'application/json'}}).then(r=>r.json());
    if(d?.ok) data = d.data;
  }catch(e){}
  if(!data){
    try{
      const url = 'https://r.jina.ai/http://stooq.com/q/l/?s=%5Endx,%5Espx,dxy,us10y&f=sd2t2ohlcv&h&e=csv';
      const text = await fetch(url).then(r=>r.text());
      const lines = text.trim().split(/\r?\n/);
      const out = {};
      for(let i=1;i<lines.length;i++){
        const c = lines[i].split(',');
        const sym = c[0].toLowerCase();
        const close = parseFloat(c[6]), open  = parseFloat(c[3]);
        const chg   = (isFinite(close)&&isFinite(open)) ? ((close-open)/open*100) : 0;
        out[sym] = { close, open, chg };
      }
      data = out;
    }catch(e){}
  }
  if(!data){ panel.hidden=true; return; }
  panel.hidden=false;
  paintGlobal('ndx',  data['^ndx'] || data['ndx']);
  paintGlobal('spx',  data['^spx'] || data['spx']);
  paintGlobal('dxy',  data['dxy']);
  paintGlobal('us10y',data['us10y']);
}

/* ===== 딥링크 ===== */
function getDeepLink(){
  const u = new URL(location.href);
  return u.searchParams.get('m') || (location.hash||'').replace('#','') || null;
}
function setDeepLink(market){
  const u = new URL(location.href);
  u.searchParams.set('m', market);
  history.replaceState(null,'',u.toString());
}

/* ===== 부팅 ===== */
(async function boot(){
  await ping().catch(()=>{});
  await loadGlobal().catch(()=>{});
  await loadMarkets().catch(()=>{});

  await renderSpark();
  startSparkAuto();

  const deep = getDeepLink();
  if(deep){ ensureTempSparkCard(deep); openUltra(deep,null); }
  else{
    const first=$('#sparkList .item'); if(first){ first.click(); }
  }
})();
</script>
</body>
</html>
