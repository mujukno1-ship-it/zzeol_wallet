<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v13.2 â€” Learning Dashboard + BuyZone + RiskGuard + ProTargets</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0f1218;--panel:#151a21;--muted:#9aa4b2;--text:#e7eef8;--accent:#5ac8fa;--up:#1ec996;--down:#ff5b6b;--chip:#1f2630;--rail:#2a3340;--spark:#ffb020}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .badge{background:#19202a;color:#9bc3ff;border:1px solid #2a3950;border-radius:10px;padding:4px 8px;font-size:12px}
  .api{margin-left:auto;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .api .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#888}
  .api.ok .dot{background:#1ec996}
  .api.fail .dot{background:#ff5b6b}

  .search{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,24,.95),rgba(15,18,24,.75));padding:10px 0 12px;z-index:6;backdrop-filter:saturate(1.2) blur(2px)}
  .search .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .search input{flex:1;background:#11161d;border:1px solid #263246;color:var(--text);border-radius:10px;padding:12px 14px;outline:none;min-width:260px}
  .search button{background:#1b2533;border:1px solid #2b3a52;color:#d7e6ff;border-radius:10px;padding:10px 14px;cursor:pointer}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid #202734;border-radius:18px;padding:14px}
  .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .title small{margin-left:6px;color:var(--muted);font-weight:500}

  .pillrow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid #273041;font-size:12px;color:#c8d3e2}
  .pill.badge{background:#121820}

  .list{display:grid;gap:10px;margin-top:12px}
  .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#11161d;border:1px solid #1d2633}
  .item .name{display:flex;flex-direction:column}
  .item .name b{font-size:13px}
  .bar{height:6px;background:var(--rail);border-radius:999px;overflow:hidden}
  .bar span{display:block;height:100%;background:var(--spark);width:0%}

  .ultra{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
  .box{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:10px;min-height:58px}
  .k{color:var(--muted);font-size:12px}
  .v{font-weight:700;margin-top:2px}
  .note{margin-top:10px;background:#10151c;border:1px dashed #2a3340;border-radius:12px;padding:10px;font-size:13px;color:#dbe8ff}

  footer{margin:18px 0 10px;color:#8fa0b5;font-size:12px;text-align:center}
  .reserve{min-height:320px;display:flex;align-items:center;justify-content:center;color:#6e7a8a}

  #suggest{position:absolute;z-index:9999;background:#111;border:1px solid #333;border-radius:8px;padding:6px 0;display:none}
  #suggest .row{padding:8px 12px;cursor:pointer}
  #suggest .row:hover{background:#1f2937}
  .warn{margin-top:8px;color:#ffb8c0;font-size:12px;display:none}

  .gwrap{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  @media (max-width:980px){.gwrap{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .gbox{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:10px}
  .ghead{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .gsub{font-size:11px;color:var(--muted)}
  .gnum{font-weight:800;margin-top:6px}
  .gchg{font-size:12px;margin-top:2px}
  .up{color:var(--up)} .down{color:var(--down)}

  .sniperGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
  @media (max-width:980px){.sniperGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .snline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{cursor:pointer;background:#1b2533;border:1px solid #2b3a52;color:#d7e6ff;border-radius:10px;padding:8px 10px}

  /* BuyZone chips */
  .buyzones{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .bz{padding:8px 12px;border-radius:999px;background:#0e1620;border:1px solid #243043;color:#cfeeff;font-weight:700;cursor:pointer}
  .bz .sub{display:block;font-size:11px;color:var(--muted);font-weight:500;margin-top:4px}
  .bz.good{background:linear-gradient(90deg,#062b1f,#093430);border-color:#1ec996}
  .bz.warn{background:linear-gradient(90deg,#2b0a0a,#3a0f0f);border-color:#ff5b6b}

  /* Learning Dashboard */
  .learn{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:12px}
  @media (max-width:820px){.learn{grid-template-columns:1fr}}
  .gauge{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center}
  .gauge svg{width:64px;height:64px}
  .gauge .meta{display:flex;flex-direction:column}
  .gauge .meta .h{font-weight:800;font-size:13px}
  .gauge .meta .s{font-size:11px;color:var(--muted)}
  .sparkline{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:8px}
  .sparkline svg{width:100%;height:70px}

  /* RISK_OFF & sound */
  .risk-banner{position:sticky; top:0; z-index:9999; background:#2a0b0b; color:#ffd7d7; border:1px solid #ff5b6b; border-left:0; border-right:0; font-weight:700; letter-spacing:.2px; padding:10px 14px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.25);}
  .chip-risk{display:inline-block; padding:4px 8px; margin-left:8px; background:#3a0f10; color:#ffb3b8; border:1px solid #ff5b6b; border-radius:12px; font-size:12px; font-weight:700;}
  .chip-sound,.chip-pro{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;margin-left:8px;border:1px solid #2b3a52;border-radius:12px;background:#1b2533;color:#cfeeff;font-weight:700;cursor:pointer;user-select:none}
  .chip-sound.muted,.chip-pro.off{opacity:.6}

  /* Pro targets wrap (show/hide) */
  .pro-wrap[hidden]{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div id="risk-banner" class="risk-banner" style="display:none;">
    âš ï¸ ë¹„íŠ¸ì½”ì¸ í•˜ë½ê°ì§€ â€” ë§¤ìˆ˜ê¸ˆì§€ êµ¬ê°„ (ì‹œì¥ ìœ„í—˜ë„ â†‘)
  </div>

  <div class="search">
    <div class="row">
      <span class="badge">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</span>
      <span id="risk-chip" class="chip-risk" style="display:none;">ë§¤ìˆ˜ê¸ˆì§€</span>
      <span id="chipSound" class="chip-sound">ğŸ”” ì†Œë¦¬ ON</span>
      <span id="chipPro" class="chip-pro off" title="ê³ ê¸‰ íƒ€ì  ON/OFF">âš™ï¸ ê³ ê¸‰ íƒ€ì  OFF</span>
      <div class="api" id="apiHealth" title="API í—¬ìŠ¤">
        <span class="dot"></span>
        <span id="apiBaseTxt">https://satoshi-proxy.mujukno1.workers.dev/api</span>
        <span id="latency" style="opacity:.7"></span>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="q" placeholder="ê²€ìƒ‰: í•œê¸€ëª… / ì‹¬ë³¼ / ë§ˆì¼“ì½”ë“œ (ì˜ˆ: ì—ì´ë‹¤, ADA, KRW-ADA, ì‹œë°”ì´ëˆ„, SHIB, KRW-SHIB)" />
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
    <div class="warn" id="apiWarn">API ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</div>

    <div class="gwrap" id="globalPanel" hidden>
      <div class="gbox"><div class="ghead">NASDAQ 100<span class="gsub">NDX</span></div><div class="gnum" id="g_ndx">-</div><div class="gchg" id="gc_ndx">-</div></div>
      <div class="gbox"><div class="ghead">S&P 500<span class="gsub">SPX</span></div><div class="gnum" id="g_spx">-</div><div class="gchg" id="gc_spx">-</div></div>
      <div class="gbox"><div class="ghead">Dollar Index<span class="gsub">DXY</span></div><div class="gnum" id="g_dxy">-</div><div class="gchg" id="gc_dxy">-</div></div>
      <div class="gbox"><div class="ghead">US 10Y<span class="gsub">Yield</span></div><div class="gnum" id="g_us10y">-</div><div class="gchg" id="gc_us10y">-</div></div>
    </div>
  </div>

  <div class="grid">
    <!-- SPARK -->
    <section class="card" id="sparkCard">
      <div class="title">SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸ ğŸ”¥ <small>(ê³ ì •)</small></div>
      <div class="pillrow" style="margin-top:8px">
        <span class="pill badge">ì˜ˆì—´ ì¡°ê±´: RVOLâ‰¥1.8 Â· TBRâ‰¥0.60 Â· OBIâ‰¥+0.15 Â· ìµœê·¼5ë¶„ ë³€ë™ë¥ â‰¥+1.5% (4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ í™•ì •)</span>
      </div>
      <div id="sparkList" class="list"></div>
      <div id="sparkEmpty" class="reserve" hidden>ì˜ˆì—´ ì½”ì¸ì„ íƒìƒ‰ì¤‘â€¦</div>
    </section>

    <!-- ULTRA -->
    <section class="card">
      <div class="title" id="ultraTitle">ULTRA ì‹œê·¸ë„ â€” ì„ íƒëœ ì½”ì¸</div>

      <!-- ê¸°ë³¸ íƒ€ì  -->
      <div class="ultra">
        <div class="box"><div class="k">í˜„ì¬ê°€</div><div class="v" id="v_price">-</div></div>
        <div class="box"><div class="k">ë§¤ìˆ˜ (BUY1)</div><div class="v" id="v_buy1">-</div></div>
        <div class="box"><div class="k">ì¶”ê°€ë§¤ìˆ˜ (BUY2)</div><div class="v" id="v_buy2">-</div></div>
        <div class="box"><div class="k">ìµì ˆ 1 (TP1)</div><div class="v" id="v_tp1">-</div></div>
        <div class="box"><div class="k">ìµì ˆ 2 (TP2)</div><div class="v" id="v_tp2">-</div></div>
        <div class="box"><div class="k">ì†ì ˆ (SL)</div><div class="v" id="v_sl">-</div></div>
      </div>

      <!-- í™•ì¥ íƒ€ì (Pro) -->
      <div id="proWrap" class="ultra pro-wrap" hidden>
        <div class="box"><div class="k">ìµì ˆ 3 (TP3)</div><div class="v" id="v_tp3">-</div></div>
        <div class="box"><div class="k">íŠ¸ë ˆì¼ë§ SL 1</div><div class="v" id="v_tsl1">-</div></div>
        <div class="box"><div class="k">íŠ¸ë ˆì¼ë§ SL 2</div><div class="v" id="v_tsl2">-</div></div>
        <div class="box"><div class="k">ë¶„í•  ìµì ˆ ë ˆë”</div><div class="v" id="v_ladder">TP1 33% Â· TP2 33% Â· TP3 34%</div></div>
      </div>

      <div class="ultra" style="margin-top:6px">
        <div class="box"><div class="k">ì˜ˆìƒ ê³ ì  1</div><div class="v" id="v_hi1">-</div></div>
        <div class="box"><div class="k">ì˜ˆìƒ ê³ ì  2</div><div class="v" id="v_hi2">-</div></div>
        <div class="box"><div class="k">ì˜ˆìƒ ì €ì  1</div><div class="v" id="v_lo1">-</div></div>
        <div class="box"><div class="k">ë˜ëŒë¦¼ ëª©í‘œ</div><div class="v" id="v_retr">-</div></div>
        <div class="box"><div class="k">ë˜ëŒë¦¼ í›„ ë§¤ë„ 1</div><div class="v" id="v_rs1">-</div></div>
        <div class="box"><div class="k">ë˜ëŒë¦¼ í›„ ë§¤ë„ 2</div><div class="v" id="v_rs2">-</div></div>
      </div>

      <!-- Learning Dashboard -->
      <div class="title" style="margin-top:12px">AI í•™ìŠµ ëŒ€ì‹œë³´ë“œ</div>
      <div class="learn">
        <div class="gauge">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" stroke="#243043" stroke-width="14" fill="none"/>
            <circle id="gPrec" cx="60" cy="60" r="50" stroke="#1ec996" stroke-width="14" fill="none" stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="314" stroke-dashoffset="314"/>
            <text id="tPrec" x="60" y="66" text-anchor="middle" font-size="16" fill="#e7eef8">-</text>
          </svg>
          <div class="meta">
            <div class="h">ì •í™•ë„(Precision)</div>
            <div class="s">ì‹¤ì‹œê°„ Â±0.3% ë³´ì • Â· í•™ìŠµ ë°˜ì˜</div>
          </div>
        </div>
        <div class="gauge">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" stroke="#243043" stroke-width="14" fill="none"/>
            <circle id="gConf" cx="60" cy="60" r="50" stroke="#5ac8fa" stroke-width="14" fill="none" stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="314" stroke-dashoffset="314"/>
            <text id="tConf" x="60" y="66" text-anchor="middle" font-size="16" fill="#e7eef8">-</text>
          </svg>
          <div class="meta">
            <div class="h">ì‹ ë¢°ë„(Confidence)</div>
            <div class="s">Sniper / ë³€ë™ì„± / ì²´ê²°ê°•ë„ ì¢…í•©</div>
          </div>
        </div>
        <div class="sparkline">
          <div class="k" style="margin-bottom:6px">ì •í™•ë„ ì¶”ì„¸(ìµœê·¼)</div>
          <svg id="precSpark" viewBox="0 0 300 80" preserveAspectRatio="none">
            <polyline id="precLine" fill="none" stroke="#1ec996" stroke-width="2" points=""/>
          </svg>
          <div class="pillrow" style="margin-top:6px">
            <span class="pill badge">ìƒ˜í”Œ <b id="precCount">0</b></span>
            <span class="pill badge">ìµœê·¼í‰ê·  <b id="precAvg">-</b></span>
            <span class="pill badge">í•™ìŠµë¥  Î·=<b id="precEta">0.85</b></span>
          </div>
        </div>
      </div>

      <div id="buyZoneArea" style="margin-top:12px">
        <div class="k">ë§¤ìˆ˜íƒ€ì  (Multi-Timeframe)</div>
        <div class="buyzones" id="buyzones"></div>
      </div>

      <div class="pillrow" style="margin-top:10px">
        <span class="pill badge">ì˜ˆì—´ê°•ë„ <b id="chip_heat">0</b></span>
        <span class="pill badge">ìƒìŠ¹í™•ë¥  <b id="chip_prob">0%</b></span>
        <span class="pill badge">ì˜ˆìƒìƒìŠ¹ë¥  <b id="chip_gain">+0%</b></span>
        <span class="pill badge">ì •í™•ë„ <b id="chip_prec">-</b></span>
        <span class="pill badge">ìœ„í—˜ë„ <b id="chip_risk">-</b></span>
        <span class="pill badge">ë˜ëŒë¦¼ <b id="chip_pull">-</b></span>
        <span class="pill badge">ë‹¹ì¼ ê³ ì  <b id="chip_DH">-</b></span>
        <span class="pill badge">ë‹¹ì¼ ì €ì  <b id="chip_DL">-</b></span>
      </div>

      <div class="pillrow" style="margin-top:6px">
        <span class="pill badge">MTF ëª¨ë“œ <b id="chip_mtf_mode">-</b></span>
        <span class="pill badge">MTF ì ìˆ˜ <b id="chip_mtf_score">0</b></span>
        <span class="pill badge">ë³´ì •ëŸ‰ <b id="chip_adj">Â±0.0%</b></span>
      </div>

      <div class="note" id="z_msg">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <div class="title" style="margin-top:12px">Sniper ë°”ë‹¥Â·ì²œì¥ í¬ì°© (AI)</div>
      <div class="sniperGrid">
        <div class="box"><div class="k">AI ì˜ˆìƒ ë°”ë‹¥ (ai_low)</div><div class="v" id="sn_low">-</div></div>
        <div class="box"><div class="k">AI ì˜ˆìƒ ì²œì¥ (ai_high)</div><div class="v" id="sn_high">-</div></div>
        <div class="box"><div class="k">ì‹ ë¢°ë„ (Confidence)</div><div class="v" id="sn_conf">-</div></div>
      </div>
      <div class="snline" style="margin-top:8px">
        <button class="btn" id="btnSniper">/sniper/point ê°±ì‹ </button>
        <button class="btn" id="btnCopyLevels">ë ˆë²¨ ë³µì‚¬</button>
        <span class="pill badge" id="sn_reason_low">-</span>
        <span class="pill badge" id="sn_reason_high">-</span>
      </div>
    </section>
  </div>

  <footer>ì‚¬í† ì‹œì˜ì§€ê°‘ v13.2 Â· ProTargets(TP3/TSL/Ladder) Â· RiskGuard Â· Precision ì„œë²„ì €ì¥</footer>
</div>

<div id="suggest"></div>
<div class="popup" id="bzPopup"><h4 id="bzTitle">-</h4><p id="bzText">-</p></div>

<script>
/* ===== ì„¤ì • ===== */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
document.getElementById('apiBaseTxt').textContent = API_BASE;

/* ì§€ìˆ˜ API ìŠ¤ìœ„ì¹˜ (ì½˜ì†” 404 ë°©ì§€) */
const USE_RENDER_INDICES = false;
const INDICES_URL = API_BASE + '/indices';

const REFRESH_SPARK_MS = 15000;
const REFRESH_ULTRA_MS  = 5000;
const USE_CANDLES = true;
const CANDLE_LIMIT = 240;

/* ===== ìœ í‹¸ ===== */
const $ = s => document.querySelector(s);
const setTxt = (el, v)=>{ if(el && String(el.textContent)!==String(v)) el.textContent=String(v); };
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const debounce=(fn,ms=200)=>{let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);}};
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const avg   = a => a.length? a.reduce((x,y)=>x+y,0)/a.length : 0;

/* ===== ì•Œë¦¼ìŒ ===== */
let SND_MUTED = localStorage.getItem('SND_MUTED')==='1';
const chipSound = $('#chipSound');
function setSoundChip(){
  chipSound.classList.toggle('muted', SND_MUTED);
  chipSound.textContent = SND_MUTED ? 'ğŸ”• ì†Œë¦¬ OFF' : 'ğŸ”” ì†Œë¦¬ ON';
}
chipSound.addEventListener('click', ()=>{
  SND_MUTED=!SND_MUTED; localStorage.setItem('SND_MUTED', SND_MUTED?'1':'0'); setSoundChip();
});
setSoundChip();
let audioCtx=null;
function beep(freq=660, ms=180, type='sine', vol=0.08){
  if(SND_MUTED) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value=freq;
    g.gain.value = vol; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>{ o.stop(); }, ms);
  }catch(e){}
}
function soundRiskOn(){ beep(420,220,'sawtooth',0.09); beep(320,220,'sine',0.06); }
function soundRiskOff(){ beep(880,120,'triangle',0.07); setTimeout(()=>beep(1040,140,'triangle',0.06),110); }

/* ===== ì—…ë¹„íŠ¸ í˜¸ê°€í‹± + KRW í¬ë§· ===== */
function upbitTick(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  return 0.0001;
}
function roundTick(price){ const t=upbitTick(price); return Math.round(Number(price)/t)*t; }
function fmtKRW(n){
  if(n==null || isNaN(n)) return '-';
  const v=roundTick(Number(n));
  const t=upbitTick(v);
  const frac=t<1?String(t).split('.')[1].length:0;
  return v.toLocaleString('ko-KR',{minimumFractionDigits:frac,maximumFractionDigits:frac})+'ì›';
}
function pricePct(base,pct){ return roundTick(Number(base)*(1+Number(pct))); }

/* ===== API í—¬í¼ ===== */
async function jget(path, {retries=2, timeout=9000} = {}){
  let lastErr=null;
  for(let attempt=0; attempt<=retries; attempt++){
    const ctl = new AbortController();
    const to = setTimeout(()=>ctl.abort(), timeout);
    try{
      const t0 = performance.now();
      const r = await fetch(API_BASE+path, {headers:{accept:'application/json'}, signal:ctl.signal});
      clearTimeout(to);
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      const d = await r.json();
      if(path==='/ping') setTxt($('#latency'), Math.round(performance.now()-t0)+'ms');
      if(d && d.ok===false) throw new Error(d.error||'api');
      return d;
    }catch(e){ clearTimeout(to); lastErr=e; await sleep(200+attempt*250); }
  }
  console.error('API ERR', path, lastErr);
  return null;
}

/* ===== API í—¬ìŠ¤ ===== */
async function ping(){
  const badge = $('#apiHealth');
  const warn  = $('#apiWarn');
  const ok = await jget('/ping',{retries:1});
  if(ok?.pong){ badge.classList.add('ok'); badge.classList.remove('fail'); warn.style.display='none'; }
  else { badge.classList.add('fail'); badge.classList.remove('ok'); warn.style.display='block'; }
}

/* ===== Pro Targets í† ê¸€ ===== */
let ADV_ON = localStorage.getItem('ADV_ON')==='1';
const chipPro = $('#chipPro'), proWrap = $('#proWrap');
function paintProToggle(){
  chipPro.classList.toggle('off', !ADV_ON);
  chipPro.textContent = ADV_ON ? 'âš™ï¸ ê³ ê¸‰ íƒ€ì  ON' : 'âš™ï¸ ê³ ê¸‰ íƒ€ì  OFF';
  proWrap.hidden = !ADV_ON;
}
chipPro.addEventListener('click', ()=>{
  ADV_ON=!ADV_ON; localStorage.setItem('ADV_ON', ADV_ON?'1':'0');
  paintProToggle();
  if(currentMarket) openUltra(currentMarket,null);
});
paintProToggle();

/* ===== ë§ˆì¼“ ëª©ë¡ & ê²€ìƒ‰ ===== */
let MARKET_LIST=[];
async function loadMarkets(){
  if(MARKET_LIST.length) return MARKET_LIST;
  const d=await jget('/upbit/tickers',{retries:2});
  if(Array.isArray(d?.items)) MARKET_LIST=d.items;
  return MARKET_LIST;
}
function resolveMarket(input){
  if(!input) return null;
  const raw=input.trim();
  const s=raw.toUpperCase();
  if(s.startsWith('KRW-')) return s;
  let hit=MARKET_LIST.find(x=>(x.english_name||'').toUpperCase()===s);
  if(hit) return hit.market;
  hit=MARKET_LIST.find(x=>(x.korean_name||'').includes(raw));
  if(hit) return hit.market;
  hit=MARKET_LIST.find(x=>(x.market||'').toUpperCase().includes(s));
  return hit?.market||null;
}

/* ===== SPARK TOP10 ===== */
let sparkTimer=null;
async function renderSpark(){
  const listEl=$('#sparkList'), emptyEl=$('#sparkEmpty');
  const d=await jget('/spark/top?limit=10',{retries:1});
  listEl.innerHTML='';
  if(!Array.isArray(d?.list)||d.list.length===0){ emptyEl.hidden=false; return; }
  emptyEl.hidden=true;
  d.list.forEach(it=>{
    const row=document.createElement('div'); row.className='item'; row.dataset.m=it.market;
    const n=document.createElement('div'); n.className='name';
    n.innerHTML=`<b>${it.korean_name||it.market}</b><small style="color:var(--muted)">${it.market}</small>`;
    const r=document.createElement('div');
    r.innerHTML=`
      <div style="text-align:right">${fmtKRW(Number(it.price||0))}</div>
      <div class="bar"><span style="width:${clamp(it.spark||0,0,100)}%"></span></div>
      <div class="pillrow" style="justify-content:flex-end">
        <span class="pill">SPARK ${it.spark||0}</span>
        <span class="pill">RVOL ${(it.rvol??0).toFixed?.(2) ?? it.rvol}</span>
        <span class="pill">TBR ${Math.round((it.tbr||0)*100)}%</span>
      </div>`;
    row.appendChild(n); row.appendChild(r);
    row.addEventListener('click',()=>openUltra(it.market,it));
    listEl.appendChild(row);
  });
}
function startSparkAuto(){ if(sparkTimer) clearInterval(sparkTimer); sparkTimer=setInterval(renderSpark, REFRESH_SPARK_MS); }

/* ===== Candles/ATR/RVOL ===== */
async function loadCandles(market){
  if(!USE_CANDLES) return null;
  const d=await jget(`/candles?market=${encodeURIComponent(market)}&tf=1m&limit=${CANDLE_LIMIT}`, {retries:1});
  return Array.isArray(d?.items||d)?.length ? (d.items||d) : null;
}
function calcATR(candles, n=14){
  if(!Array.isArray(candles)||candles.length<n+1) {
    const lastClose = candles?.[candles.length-1]?.close ?? 0;
    return {atr:0,atrPct:0,hh:null,ll:null,lastClose};
  }
  let TR=0;
  for(let i=1;i<=n;i++){
    const c=candles[candles.length-1-i], p=candles[candles.length-2-i]||c;
    const tr=Math.max(c.high-c.low, Math.abs(c.high-p.close), Math.abs(c.low-p.close));
    TR += tr;
  }
  const atr = TR/n;
  const recent = candles.slice(-Math.max(n*2,30));
  let hh=-Infinity,ll=Infinity;
  for(const c of recent){ if(c.high>hh) hh=c.high; if(c.low<ll) ll=c.low; }
  const lastClose = candles[candles.length-1]?.close ?? (isFinite(hh)&&isFinite(ll)? (hh+ll)/2 : 0);
  const atrPct = lastClose? (atr/lastClose) : 0;
  return {atr, atrPct, hh, ll, lastClose};
}
function calcRVOL(candles, look=20){
  const arr=(candles||[]).slice(-look);
  if(arr.length<5) return 0;
  const vols=arr.map(c=>Number(c.volume)||0);
  const vLast=vols[vols.length-1];
  const vMean=vols.slice(0,-1).reduce((a,b)=>a+b,0)/(vols.length-1||1);
  return vMean? vLast/vMean : 0;
}

/* ===== ì©”ì–´í•œë§ˆë”” / MTF / Precision ===== */
function makeZMsg(s){
  const force=Number(s.force||s.forceIndex||0), rvol=Number(s.rvol||0), tbr=Number(s.tbr||0);
  const heat=clamp(Math.round(Number(s.spark||s.heat||0)),0,100);
  const prob=clamp(Math.round(Number(s.prob_up ?? (heat/1.6))),0,100);
  const gain=Number(s.expected_gain ?? (heat>=90?20:heat>=80?10:heat>=70?5:2));
  let mode='ì¡°ì •';
  if((rvol>=2&&tbr>=0.65)||force>=80) mode='ë¶ˆì¥';
  else if(tbr<=0.45||force<=35 || s.vwapBelow) mode='í•˜ë½ì¥';
  const text= mode==='ë¶ˆì¥'
    ? `ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ì˜ˆì—´ê°•ë„ ${heat} / ìƒìŠ¹í™•ë¥  ${prob}% / ì˜ˆìƒìƒìŠ¹ë¥  +${(+gain).toFixed(1)}%`
    : mode==='í•˜ë½ì¥'
    ? `ğŸ§Š ì„¸ë ¥ ì´íƒˆ ê°ì§€ â€” ë¹ ë¥¸ ì²­ì‚° í•„ìš” / ì˜ˆì—´ê°•ë„ ${heat} / ë°©ì–´ëª¨ë“œ`
    : `ğŸ”µ ë˜ëŒë¦¼ ì‹ í˜¸ â€” ë¶„í• ë§¤ìˆ˜ 1ì°¨ í™•ì¸ / ì˜ˆì—´ê°•ë„ ${heat} / ì¤‘ë¦½`;
  return {mode,msg:text,heat,prob,gain};
}
function calcMTFAdjust(seed){
  const s=seed||{}; const heat=clamp(Number(s.spark||0),0,100);
  const rvol=Number(s.rvol||0); const tbr=Number(s.tbr||0); const retrP=Number(s.retracement_percent||0);
  const volRank=clamp(rvol/3,0,1);
  const w={m1:0.18*volRank,m5:0.16*volRank,m30:0.12*volRank+0.04,h1:0.12*(0.6+volRank*0.4),h4:0.12*(0.5+(1-volRank)*0.5),h6:0.08*(0.5+(1-volRank)*0.5),d1:0.10*(0.4+(1-volRank)*0.6),w1:0.07*(0.3+(1-volRank)*0.7),m1x:0.05*(0.3+(1-volRank)*0.7)};
  const sigShort=((heat-50)/50)*0.5 + (tbr-0.5)*0.6 - (retrP>65?0.2:0) + (retrP<35?0.15:0);
  const sigMid  =((heat-50)/50)*0.4 + (tbr-0.5)*0.4;
  const sigLong =((heat-50)/50)*0.3 + (tbr-0.5)*0.3;
  const S={m1:clamp(sigShort,-1,1),m5:clamp(sigShort*0.9,-1,1),m30:clamp((sigShort*0.6+sigMid*0.4),-1,1),h1:clamp(sigMid,-1,1),h4:clamp((sigMid*0.7+sigLong*0.3),-1,1),h6:clamp((sigMid*0.6+sigLong*0.4),-1,1),d1:clamp(sigLong,-1,1),w1:clamp(sigLong*0.8,-1,1),m1x:clamp(sigLong*0.7,-1,1)};
  const sumW=Object.values(w).reduce((a,b)=>a+b,0)||1;
  let mtfScore=0; for(const k of Object.keys(S)){ mtfScore += (S[k]*100)*(w[k]/sumW); }
  mtfScore=clamp(Math.round(mtfScore),-100,100);
  const mode = mtfScore>=35 ? 'ë¶ˆì¥' : mtfScore<=-35 ? 'í•˜ë½ì¥' : 'ì¡°ì •';
  let adj = Math.min(0.003, Math.max(0.0015, Math.abs(mtfScore)/4000)); if(mode!=='ì¡°ì •') adj = Math.min(0.003, adj*1.2);
  return { mtfScore, mode, adj };
}
function calcPrecision(s, mtf, atrPct){
  const force=Number(s.forceIndex||s.force||0), rvol=Number(s.rvol||0), tbr=Number(s.tbr||0), obi=Number(s.obi||s.order_imbalance||0), heat=clamp(Number(s.spark||0),0,100);
  const mtfNorm=(clamp(mtf.mtfScore,-100,100)+100)/200; const forceN=clamp(force/100,0,1); const tbrN=clamp((tbr-0.4)/0.4,0,1); const rvolN=clamp((rvol-0.8)/2.0,0,1); const obiN=clamp((obi+0.2)/0.4,0,1); const atrOK=clamp(1-Math.abs((atrPct??0)-0.012)/0.02,0,1);
  let score=(forceN*0.28)+(tbrN*0.22)+(rvolN*0.18)+(mtfNorm*0.18)+(obiN*0.08)+(atrOK*0.06); score+=clamp((heat-60)/100,0,0.08);
  return clamp(Math.round((0.82 + score*0.16)*1000)/10, 85, 99.9);
}

/* ===== Precision History ===== */
const PREC_KEY='satoshi_prec_history';
function pushPrecisionHistory(v){
  try{
    const arr = JSON.parse(localStorage.getItem(PREC_KEY)||'[]');
    arr.push(Math.round(v*10)/10);
    while(arr.length>240) arr.shift();
    localStorage.setItem(PREC_KEY, JSON.stringify(arr));
    return arr;
  }catch{ return [v]; }
}
function readPrecisionHistory(){ try{ return JSON.parse(localStorage.getItem(PREC_KEY)||'[]'); }catch{ return []; } }
async function savePrecisionHistory(arr, market='ALL'){
  try{ await fetch(API_BASE+'/prec/save',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({values:arr, market}) }); }catch(e){}
}
async function loadPrecisionHistory(market='ALL'){
  try{
    const r = await jget('/prec/load?market='+encodeURIComponent(market), {retries:0});
    if(r?.ok && Array.isArray(r.values) && r.values.length){
      localStorage.setItem(PREC_KEY, JSON.stringify(r.values.slice(-240)));
      return r.values;
    }
  }catch(e){}
  return readPrecisionHistory();
}
function drawSparkline(values){
  const svg = $('#precSpark'), line = $('#precLine'); if(!svg||!line) return;
  const w = 300, h = 80, pad=6, n = values.length || 1;
  const min = Math.min(...values, 80), max = Math.max(...values, 100);
  const xs = i => pad + (w-2*pad)* (n<=1?0.5: i/(n-1));
  const ys = v => h - pad - (h-2*pad) * ((v-min)/Math.max(1,(max-min)||1));
  const pts = values.map((v,i)=> `${xs(i)},${ys(v)}`).join(' ');
  line.setAttribute('points', pts);
  setTxt($('#precCount'), n);
  setTxt($('#precAvg'), ((Math.round(avg(values)*10)/10) || '-') + '%');
}
function setGauge(circleEl, textEl, pct){
  const C = 2*Math.PI*50; const d = C * (1 - clamp(pct,0,100)/100);
  circleEl.setAttribute('stroke-dashoffset', d.toFixed(1));
  setTxt(textEl, `${pct.toFixed(1)}%`);
}

/* ===== ìƒíƒœ ===== */
let currentMarket=null, ultraTimer=null;

/* ===== ULTRA ===== */
async function openUltra(market, seed){
  if(!market) return;
  currentMarket = market;

  const [sig, candles] = await Promise.all([
    jget('/ultra/signal?market='+encodeURIComponent(market))||{},
    loadCandles(market)
  ]);
  const s=Object.assign({}, seed||{}, sig||{});
  const nameKor = s.korean_name || (MARKET_LIST.find(x=>x.market===market)?.korean_name) || s.name_kr || s.name || market;
  setTxt($('#ultraTitle'), `ULTRA ì‹œê·¸ë„ â€” ${nameKor} (${market})`);

  const lastCandleClose = candles?.[candles.length-1]?.close || 0;
  const price = roundTick(Number(s.price||s.last||s.close|| lastCandleClose)||0);
  const buy1 = s.buy1!=null?roundTick(Number(s.buy1)):roundTick(price*0.997);
  const buy2 = s.buy2!=null?roundTick(Number(s.buy2)):roundTick(price*0.992);

  let atr=0, atrPct=0, hh=null, ll=null;
  if(Array.isArray(candles)){ const a=calcATR(candles,14); atr=a.atr; atrPct=a.atrPct; hh=a.hh; ll=a.ll; }
  if(s.recent_high) hh = s.recent_high;
  if(s.recent_low)  ll = s.recent_low;

  const rvol = Number(s.rvol ?? (Array.isArray(candles)?calcRVOL(candles,20):0));
  const tbr  = Number(s.tbr ?? 0.5);
  const bull = (rvol>=2&&tbr>=0.65) || rvol>=3;
  const bear = tbr<=0.45 || rvol<=0.8;
  const k = clamp(atrPct || 0, 0.004, 0.04); // ë³€ë™ì„± ê³„ìˆ˜

  let tp1=s.tp1, tp2=s.tp2, sl=s.sl;
  if(tp1==null||tp2==null||sl==null){
    if(bull){ tp1=roundTick(price + Math.max(price*0.012, price*k*1.6));
              tp2=roundTick(price + Math.max(price*0.020, price*k*2.6));
              sl =roundTick(price - Math.max(price*0.008, price*k*0.9)); }
    else if(bear){ tp1=roundTick(price + Math.max(price*0.006, price*k*0.7));
                   tp2=roundTick(price + Math.max(price*0.010, price*k*1.1));
                   sl =roundTick(price - Math.max(price*0.013, price*k*1.4)); }
    else{ tp1=roundTick(price + Math.max(price*0.010, price*k*1.2));
          tp2=roundTick(price + Math.max(price*0.018, price*k*2.0));
          sl =roundTick(price - Math.max(price*0.010, price*k*1.0)); }
  }

  const mtf = calcMTFAdjust(s);
  const sign = (mtf.mode==='ë¶ˆì¥') ? +1 : (mtf.mode==='í•˜ë½ì¥') ? -1 : 0;
  const tpAdjPct = sign * mtf.adj;
  const slAdjPct = -sign * (mtf.adj*0.8);
  let tp1_adj = pricePct(tp1, tpAdjPct);
  let tp2_adj = pricePct(tp2, tpAdjPct);
  let sl_adj  = pricePct(sl , slAdjPct);

  const obi = Number(s.obi||s.order_imbalance||0);
  const adjExtra = clamp(((tbr-0.5)*0.002) + (obi*0.0015), -0.003, 0.003);
  tp1_adj=pricePct(tp1_adj, adjExtra);
  tp2_adj=pricePct(tp2_adj, adjExtra);
  sl_adj =pricePct(sl_adj , -adjExtra*0.6);

  // === Pro Targets ê³„ì‚° ===
  let tp3_adj='-', tsl1='-', tsl2='-';
  if(ADV_ON){
    // TP3: ì¥ì„¸ë³„ í•œ ìŠ¤í… ë”
    let tp3;
    if(bull)      tp3 = roundTick(price + Math.max(price*0.028, price*k*3.6));
    else if(bear) tp3 = roundTick(price + Math.max(price*0.015, price*k*1.6));
    else          tp3 = roundTick(price + Math.max(price*0.022, price*k*2.8));
    tp3 = pricePct(tp3, tpAdjPct + adjExtra);
    tp3_adj = fmtKRW(tp3);

    // Trailing SL ê°€ì´ë“œ
    const atrAdd1 = Math.max(upbitTick(price), roundTick(atr*0.30));
    const atrAdd2 = Math.max(upbitTick(price), roundTick(atr*0.60));
    const breakeven = buy1 ? roundTick(buy1) : price;
    tsl1 = fmtKRW(Math.max(breakeven, sl_adj + atrAdd1));
    tsl2 = fmtKRW(Math.max(breakeven, sl_adj + atrAdd2));
  }

  // === í™”ë©´ ë°˜ì˜ ===
  setTxt($('#v_price'),fmtKRW(price));
  setTxt($('#v_buy1'),fmtKRW(buy1));
  setTxt($('#v_buy2'),fmtKRW(buy2));
  setTxt($('#v_tp1'),fmtKRW(tp1_adj));
  setTxt($('#v_tp2'),fmtKRW(tp2_adj));
  setTxt($('#v_sl'), fmtKRW(sl_adj));
  if(ADV_ON){
    setTxt($('#v_tp3'), tp3_adj);
    setTxt($('#v_tsl1'), tsl1);
    setTxt($('#v_tsl2'), tsl2);
  }

  const hi1 = s.target_high1 ?? tp1_adj;
  const hi2 = s.target_high2 ?? tp2_adj;
  const lo1 = s.target_low1  ?? sl_adj;
  const retrTo = s.retracement_to ?? buy1;
  const rs1 = s.post_dip_sell1 ?? pricePct(retrTo, +0.012);
  const rs2 = s.post_dip_sell2 ?? pricePct(retrTo, +0.020);
  setTxt($('#v_hi1'), fmtKRW(hi1)); setTxt($('#v_hi2'), fmtKRW(hi2));
  setTxt($('#v_lo1'), fmtKRW(lo1)); setTxt($('#v_retr'), fmtKRW(retrTo));
  setTxt($('#v_rs1'), fmtKRW(rs1)); setTxt($('#v_rs2'), fmtKRW(rs2));

  const z=makeZMsg(s);
  setTxt($('#chip_heat'),z.heat);
  setTxt($('#chip_prob'),`${z.prob}%`);
  setTxt($('#chip_gain'),`+${(+z.gain).toFixed(1)}%`);
  setTxt($('#chip_risk'), s.risk_level!=null?String(s.risk_level):(z.mode==='ë¶ˆì¥'?'2':(z.mode==='í•˜ë½ì¥'?'4':'3')));

  let retr=null;
  if(Array.isArray(s.candles)) retr=computeRetracementFromCandles(s.candles);
  if(s.retracement_percent!=null) retr={R:Number(s.retracement_percent), band:s.retr_band||''};
  if(!retr && Array.isArray(candles)) retr=computeRetracementFromCandles(candles);
  const pullPrice = (s.retracement_to ?? s.pull_to ?? (retr?.pullTo ?? lo1));
  const retrTxt = retr ? `${Number(retr.R).toFixed(0)}% ${retr.band||''} (${fmtKRW(pullPrice)}ê¹Œì§€)` : `(${fmtKRW(pullPrice)}ê¹Œì§€)`;
  setTxt($('#chip_pull'), retrTxt);

  if(hh) setTxt($('#chip_DH'), fmtKRW(hh));
  if(ll) setTxt($('#chip_DL'), fmtKRW(ll));

  setTxt($('#chip_mtf_mode'), mtf.mode);
  setTxt($('#chip_mtf_score'), mtf.mtfScore);
  setTxt($('#chip_adj'), `${(mtf.adj*100* (sign?1:0)).toFixed(2)}%`);

  // ì •í™•ë„
  const prec = calcPrecision(s, mtf, atrPct);
  setTxt($('#chip_prec'), `${prec.toFixed(1)}%`);
  const hist = pushPrecisionHistory(prec);
  drawSparkline(hist);
  setGauge($('#gPrec'), $('#tPrec'), prec);

  // ì„œë²„ ë™ê¸°í™”(ì˜µì…˜)
  if(!window.__precSyncTimer){
    window.__precSyncTimer = setInterval(()=> {
      const arr = readPrecisionHistory();
      savePrecisionHistory(arr, 'ALL').catch(()=>{});
    }, 30000);
  }

  setTxt($('#z_msg'), z.msg);

  // === 3ë‹¨ê³„ ë§¤ìˆ˜ íƒ€ì  ===
  const recent_high = hh || price, recent_low = ll || price;
  const atrVal = atr || Math.max(1, Math.round(price*0.01));
  const shortMul = ( (rvol>=2&&tbr>=0.65) || rvol>=3 ) ? 0.25 : (tbr<=0.45 || rvol<=0.8) ? 0.6 : 0.4;
  const midMul   = ( (rvol>=2&&tbr>=0.65) || rvol>=3 ) ? 1.0  : (tbr<=0.45 || rvol<=0.8) ? 1.4 : 1.1;
  const longPct  = 0.38;

  let buy_short = roundTick(price - atrVal * shortMul);
  let buy_mid   = roundTick(price - atrVal * midMul);
  let buy_long  = roundTick(recent_low + (price - recent_low) * longPct);

  if(buy_long > buy_mid) buy_long = buy_mid;
  if(buy_mid > buy_short) buy_mid = buy_short;
  if(buy_short > price) buy_short = roundTick(price * 0.997);

  const tickGap = Math.max(1, upbitTick(price));
  if(price - buy_short < tickGap) buy_short = roundTick(price - tickGap);
  if(buy_short - buy_mid < tickGap) buy_mid = roundTick(buy_short - tickGap);
  if(buy_mid - buy_long < tickGap) buy_long = roundTick(buy_mid - tickGap);

  renderBuyZones({short:buy_short,mid:buy_mid,long:buy_long,prec,mode:mtf.mode,heat:z.heat,prob:z.prob});

  await refreshSniper(false);

  if(ultraTimer) clearInterval(ultraTimer);
  ultraTimer = setInterval(()=>openUltra(currentMarket, null), REFRESH_ULTRA_MS);
}

/* ===== buyzone ë Œë” ===== */
function renderBuyZones(data){
  const el = $('#buyzones'); el.innerHTML='';
  const shortEl = document.createElement('div'); shortEl.className='bz good'; shortEl.innerHTML=`ë‹¨ê¸°<br><span class="sub">${fmtKRW(data.short)}</span>`;
  const midEl   = document.createElement('div'); midEl.className='bz';       midEl.innerHTML  =`ì¤‘ê¸°<br><span class="sub">${fmtKRW(data.mid)}</span>`;
  const longEl  = document.createElement('div'); longEl.className='bz warn'; longEl.innerHTML =`ì¥ê¸°<br><span class="sub">${fmtKRW(data.long)}</span>`;
  el.appendChild(shortEl); el.appendChild(midEl); el.appendChild(longEl);

  const popup = $('#bzPopup');
  function showInfo(title, text){
    setTxt($('#bzTitle'), title);
    setTxt($('#bzText'), text);
    popup.style.display='block';
    setTimeout(()=>{ popup.style.display='none'; }, 7000);
  }
  shortEl.onclick = ()=> showInfo('ë‹¨ê¸° ë§¤ìˆ˜ íƒ€ì ', `ê°€ê²©: ${fmtKRW(data.short)}\nì •í™•ë„: ${data.prec.toFixed(1)}%\nê¶Œì¥: ìŠ¤ìº˜í”„Â·ë‹¨íƒ€(ë¹ ë¥¸ ë°˜ë“± ê¸°ëŒ€)`);
  midEl.onclick   = ()=> showInfo('ì¤‘ê¸° ë§¤ìˆ˜ íƒ€ì ', `ê°€ê²©: ${fmtKRW(data.mid)}\nì •í™•ë„: ${data.prec.toFixed(1)}%\nê¶Œì¥: ë¶„í• ì§„ì…(ì¤‘ê¸° ì¶”ì„¸ í™•ì¸)`);
  longEl.onclick  = ()=> showInfo('ì¥ê¸° ë§¤ìˆ˜ íƒ€ì ', `ê°€ê²©: ${fmtKRW(data.long)}\nì •í™•ë„: ${data.prec.toFixed(1)}%\nê¶Œì¥: ëˆŒë¦¼ë§¤ìˆ˜Â·í™€ë”©(ì¥ê¸° ê´€ì )`);
}

/* ===== Sniper ===== */
async function refreshSniper(showToast=true){
  if(!currentMarket) return;
  const d = await jget(`/sniper/point?market=${encodeURIComponent(currentMarket)}`, {retries:1});
  if(!d?.ok){ if(showToast) console.warn('sniper_failed'); return; }
  const s = d.sniper || {};
  setTxt($('#sn_low'), fmtKRW(s.ai_low));
  setTxt($('#sn_high'), fmtKRW(s.ai_high));
  setTxt($('#sn_conf'), (s.confidence!=null? s.confidence+'%' : '-'));
  setTxt($('#sn_reason_low'),  s.ai_low_reason || '-');
  setTxt($('#sn_reason_high'), s.ai_high_reason || '-');

  const conf = Number(s.confidence)||0;
  setGauge($('#gConf'), $('#tConf'), clamp(conf,0,100));
}
const btnSniper = $('#btnSniper');
if(btnSniper){ btnSniper.addEventListener('click', ()=>refreshSniper(true)); }

const btnCopy = $('#btnCopyLevels');
if(btnCopy){
  btnCopy.addEventListener('click', async ()=>{
    const txt = [
      `ì‹œì¥: ${currentMarket||'-'}`,
      `ê°€ê²©: ${$('#v_price')?.textContent||'-'}`,
      `BUY1: ${$('#v_buy1')?.textContent||'-'}`,
      `BUY2: ${$('#v_buy2')?.textContent||'-'}`,
      `TP1: ${$('#v_tp1')?.textContent||'-'}`,
      `TP2: ${$('#v_tp2')?.textContent||'-'}`,
      `TP3: ${$('#v_tp3')?.textContent||'-'}`,
      `SL: ${$('#v_sl')?.textContent||'-'}`,
      `TSL1: ${$('#v_tsl1')?.textContent||'-'}`,
      `TSL2: ${$('#v_tsl2')?.textContent||'-'}`,
      `AI Low: ${$('#sn_low')?.textContent||'-'}`,
      `AI High: ${$('#sn_high')?.textContent||'-'}`,
      `Conf: ${$('#sn_conf')?.textContent||'-'}`
    ].join('\n');
    try{
      await navigator.clipboard.writeText(txt);
      toast('ë ˆë²¨ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }catch(e){
      console.warn(e); toast('ë³µì‚¬ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
    }
  });
}

/* ===== ë˜ëŒë¦¼ ë³´ì¡° ===== */
function computeRetracementFromCandles(candles){
  try{
    if(!Array.isArray(candles)||candles.length<10) return null;
    const arr=candles.slice(-20);
    let H=-Infinity, Lw=Infinity;
    const C=arr[arr.length-1]?.close;
    for(const c of arr){ if(c.high>H)H=c.high; if(c.low<Lw)Lw=c.low; }
    if(!(H>Lw) || !isFinite(C)) return null;
    const R = clamp(((H-C)/(H-Lw))*100,0,100);
    const band = R<35?'ì–•ìŒ':(R<65?'ë³´í†µ':'ê¹ŠìŒ');
    return {R, band, pullTo: roundTick(Lw + (H-Lw)*0.38)};
  }catch{ return null; }
}

/* ===== ê¸€ë¡œë²Œ ===== */
function paintGlobal(idBase, v){
  const num = $('#g_'+idBase), chg = $('#gc_'+idBase);
  if(!num||!chg||!v) return;
  num.textContent = isFinite(v.close) ? v.close.toLocaleString('en-US',{maximumFractionDigits:2}) : '-';
  const sign = v.chg>0 ? 'up' : v.chg<0 ? 'down' : '';
  chg.classList.remove('up','down'); if(sign) chg.classList.add(sign);
  chg.textContent = isFinite(v.chg) ? `${v.chg>0?'+':''}${v.chg.toFixed(2)}%` : '-';
}
function pick(map, keys){ for(const k of keys){ if(map?.[k]) return map[k]; } return null; }
async function loadGlobal(){
  const panel = $('#globalPanel');
  let data = null;
  if (USE_RENDER_INDICES){
    try{
      const res = await fetch(INDICES_URL, {headers:{accept:'application/json'}});
      if(res.ok){
        const d = await res.json();
        if(d?.ok && Array.isArray(d.data)){
          const out={};
          d.data.forEach(q=>{
            const sym=(q.symbol||'').toUpperCase();
            const close=Number(q.regularMarketPrice);
            const chg=Number(q.regularMarketChangePercent);
            if(sym.includes('^NDX') || sym.includes('NDX')) out['^ndx']={close, chg};
            else if(sym.includes('^GSPC') || sym.includes('SPX')) out['^spx']={close, chg};
            else if(sym.includes('DXY') || sym.includes('USDX')) out['dxy']={close, chg};
            else if(sym.includes('^TNX') || sym.includes('US10Y') || sym.includes('10Y')) out['us10y']={close, chg};
          });
          if(Object.keys(out).length) data = out;
        }
      }
    }catch(e){}
  }
  if(!data){
    try{
      const url = 'https://r.jina.ai/http://stooq.com/q/l/?s=%5Endx,%5Espx,dxy,us10y&f=sd2t2ohlcv&h&e=csv';
      const text = await fetch(url).then(r=>r.text());
      const lines = text.trim().split(/\r?\n/); const out = {};
      for(let i=1;i<lines.length;i++){
        const c = lines[i].split(',');
        const sym = (c[0]||'').toLowerCase();
        const close = parseFloat(c[6]), open  = parseFloat(c[3]);
        const chg   = (isFinite(close)&&isFinite(open)) ? ((close-open)/open*100) : 0;
        out[sym] = { close, open, chg };
      }
      data = out;
    }catch(e){}
  }
  if(!data || (!pick(data,['^ndx','ndx']) && !pick(data,['^spx','spx']))){ panel.hidden=true; return; }
  panel.hidden=false;
  paintGlobal('ndx',  pick(data,['^ndx','ndx']));
  paintGlobal('spx',  pick(data,['^spx','spx']));
  paintGlobal('dxy',  pick(data,['dxy']));
  paintGlobal('us10y',pick(data,['us10y']));
}

/* ===== RISK_OFF: BTC í•˜ë½ ê°ì§€ + ì•Œë¦¼ìŒ ===== */
window.RiskGuard = (function(){
  let RISK_OFF = false;
  let lastState = null;
  let listeners = new Set();

  function setBanner(show){ const el = document.getElementById('risk-banner'); if (!el) return; el.style.display = show ? 'block' : 'none'; }
  function setChip(show){ const el = document.getElementById('risk-chip'); if (!el) return; el.style.display = show ? 'inline-block' : 'none'; }
  function emit(){ const snapshot = { RISK_OFF }; const s = JSON.stringify(snapshot); if (s === lastState) return; lastState = s; listeners.forEach(fn=>{ try{ fn(snapshot); }catch(e){} }); }

  async function fetchBTC(){
    const market = 'KRW-BTC';
    const [sig, candles] = await Promise.all([
      jget('/ultra/signal?market=' + encodeURIComponent(market)).catch(()=>null),
      loadCandles(market).catch(()=>null)
    ]);
    let price=null, ref24=null, change24=null, force=null, drop30m=null;
    if(sig){
      price = Number(sig.price ?? sig.last ?? sig.close ?? null);
      force = (typeof sig.ForceIndex_AI==='number')? sig.ForceIndex_AI
            : (typeof sig.forceIndex==='number')? sig.forceIndex : null;
      if(typeof sig.change_24h==='number') change24 = sig.change_24h;
      if(typeof sig.changePct==='number')  change24 = change24 ?? sig.changePct;
      if(typeof sig.refPrice==='number')   ref24    = sig.refPrice;
    }
    if((change24==null || !isFinite(change24)) && ref24 && price) change24 = ((price/ref24)-1)*100;
    if(Array.isArray(candles) && candles.length>35){
      const last = candles[candles.length-1]?.close;
      const idx = Math.max(0, candles.length-31);
      const past = candles[idx]?.close;
      if(isFinite(last) && isFinite(past) && past>0) drop30m = ((last/past)-1)*100;
      if(price==null && isFinite(last)) price = last;
    }
    return { price, change24, force, drop30m };
  }

  async function evaluate(){
    try{
      const btc = await fetchBTC();
      const chg = btc.change24;
      const fi  = btc.force;
      const d30 = btc.drop30m;

      const condA = (typeof chg === 'number' && chg <= -1.5);
      const condB = (typeof d30 === 'number' && d30 <= -0.8);
      const condC = (typeof fi  === 'number' ? fi < 45 : true);

      const next = !!((condA || condB) && condC);
      if (next !== RISK_OFF){
        RISK_OFF = next;
        setBanner(RISK_OFF);
        setChip(RISK_OFF);
        emit();
        if(RISK_OFF){ toast('âš ï¸ ë¹„íŠ¸ì½”ì¸ í•˜ë½ê°ì§€ â€” ë§¤ìˆ˜ê¸ˆì§€ êµ¬ê°„ ì§„ì…'); soundRiskOn(); }
        else        { toast('âœ… ìœ„í—˜ í•´ì œ â€” ë§¤ìˆ˜ ê°€ëŠ¥ êµ¬ê°„ìœ¼ë¡œ ë³µê·€'); soundRiskOff(); }
      }
    }catch(e){}
  }

  setInterval(evaluate, 10000);
  evaluate();

  function canBuy(){ return !RISK_OFF; }
  function blockBuyIfNeeded(){ if(!RISK_OFF) return true; toast('âš ï¸ ë¹„íŠ¸ì½”ì¸ í•˜ë½ê°ì§€ â€” í˜„ì¬ ë§¤ìˆ˜ê¸ˆì§€ êµ¬ê°„ì…ë‹ˆë‹¤.'); return false; }
  function onChange(cb){ listeners.add(cb); return ()=>listeners.delete(cb); }

  return { get RISK_OFF(){ return RISK_OFF; }, canBuy, blockBuyIfNeeded, onChange };
})();

/* ===== ê²€ìƒ‰/ì˜¤í† ì™„ì„± + ë”¥ë§í¬/í† ìŠ¤íŠ¸ ===== */
const $q=$('#q'), $btn=$('#btnSearch'), $sug=$('#suggest');
function placeSuggest(){ const r=$q.getBoundingClientRect(); $sug.style.left=(window.scrollX+r.left)+'px'; $sug.style.top =(window.scrollY+r.bottom+6)+'px'; $sug.style.width=r.width+'px'; }
window.addEventListener('resize',placeSuggest); window.addEventListener('scroll',placeSuggest);
function renderSuggest(q){
  if(!q){ $sug.style.display='none'; return; }
  const qq=q.trim().toLowerCase();
  const cand=MARKET_LIST.filter(x=>{
    const kn=(x.korean_name||'').toLowerCase();
    const en=(x.english_name||'').toLowerCase();
    const mk=(x.market||'').toLowerCase();
    return kn.includes(qq)||en.includes(qq)||mk.includes(qq);
  }).slice(0,10);
  $sug.innerHTML='';
  cand.forEach(x=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<b>${x.korean_name}</b> <span style="opacity:.7">(${x.market.replace('KRW-','')})</span>`;
    row.onclick=()=>{ $q.value=x.korean_name; $sug.style.display='none'; ensureTempSparkCard(x.market); openUltra(x.market,null); setDeepLink(x.market); };
    $sug.appendChild(row);
  });
  placeSuggest(); $sug.style.display=cand.length?'block':'none';
}
$q.addEventListener('input', debounce(e=>renderSuggest(e.target.value),120));
document.addEventListener('click', e=>{ if(e.target!==$q && !$sug.contains(e.target)) $sug.style.display='none'; });
document.addEventListener('keydown', e=>{
  if(e.key==='/' && document.activeElement!==$q){ e.preventDefault(); $q.focus(); }
  if(e.key==='Enter' && document.activeElement===$q){ e.preventDefault(); doSearch(); }
});
async function doSearch(){
  const q=$q.value.trim(); if(!q) return;
  await loadMarkets();
  const market=resolveMarket(q);
  if(!market){ alert('ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í•œê¸€/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œë¡œ ê²€ìƒ‰)'); return; }
  ensureTempSparkCard(market);
  setDeepLink(market);
  openUltra(market,null);
}
$btn.addEventListener('click', doSearch);
function ensureTempSparkCard(market){
  const listEl=$('#sparkList');
  if (![...listEl.querySelectorAll('.item')].some(x=>x.dataset.m===market)){
    const row=document.createElement('div'); row.className='item'; row.dataset.m=market;
    const n=document.createElement('div'); n.className='name';
    const kn=(MARKET_LIST.find(x=>x.market===market)?.korean_name)||market;
    n.innerHTML=`<b>${kn}</b><small style="color:var(--muted)">${market}</small>`;
    const r=document.createElement('div');
    r.innerHTML=`
      <div style="text-align:right">-</div>
      <div class="bar"><span style="width:0%"></span></div>
      <div class="pillrow" style="justify-content:flex-end"><span class="pill">SPARK 0</span></div>`;
    row.appendChild(n); row.appendChild(r);
    row.addEventListener('click',()=>{ setDeepLink(market); openUltra(market,null); });
    listEl.prepend(row);
  }
}
function getDeepLink(){ const u = new URL(location.href); return u.searchParams.get('m') || (location.hash||'').replace('#','') || null; }
function setDeepLink(market){ const u = new URL(location.href); u.searchParams.set('m', market); history.replaceState(null,'',u.toString()); }
function toast(msg){
  const p = $('#bzPopup');
  setTxt($('#bzTitle'),'ì•Œë¦¼');
  setTxt($('#bzText'), msg);
  p.style.display='block';
  setTimeout(()=>{ p.style.display='none'; }, 3000);
}

/* ===== ë¶€íŒ… ===== */
(async function boot(){
  await ping().catch(()=>{});
  await loadGlobal().catch(()=>{});
  await loadMarkets().catch(()=>{});

  await loadPrecisionHistory('ALL').then(drawSparkline).catch(()=>{ drawSparkline(readPrecisionHistory()); });

  await renderSpark(); startSparkAuto();

  const deep = getDeepLink();
  if(deep){ ensureTempSparkCard(deep); openUltra(deep,null); }
  else{ const first=$('#sparkList .item'); if(first){ first.click(); } }
})();
</script>
</body>
</html>
