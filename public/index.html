<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ 10.1 (ì—…ë¹„íŠ¸ ë™ì¼ ê²€ìƒ‰ + SPARK íƒ€ì )</title>
<style>
  :root{--bg:#0f1117;--panel:#151a23;--text:#e8eef6;--muted:#9aa4b2;--ok:#2bdd8a;--warn:#ffb020;--bad:#ff6b6b;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:var(--panel);border:1px solid #223046;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .muted{color:var(--muted)} .btn{background:#1e2635;border:1px solid #2a3550;color:#dce9ff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .input{background:#0d131c;border:1px solid #27364a;border-radius:10px;padding:10px 12px;width:100%;color:var(--text)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #223046;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kv{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kv .box{background:#0e141d;border:1px solid #223046;border-radius:10px;padding:12px}
  .kv .k{font-size:12px;color:var(--muted)} .kv .v{font-size:18px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .risk1{background:#0f3521;color:#7bf0a5}.risk2{background:#102c36;color:#8ad9ff}
  .risk3{background:#362f10;color:#ffe08a}.risk4{background:#381c12;color:#ffb39b}.risk5{background:#351113;color:#ff8686}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’« ì „ì„¤íŒ 10.1 <span class="muted" id="apiState">API ì—°ê²° í™•ì¸ì¤‘â€¦</span></h1>

  <div class="card">
    <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px">
      <input id="q" class="input" placeholder="ì—…ë¹„íŠ¸ ë™ì¼: ì‹¬ë³¼/í•œê¸€/ì˜ë¬¸ ê²€ìƒ‰ (ì˜ˆ: BTC, ë¹„íŠ¸ì½”ì¸, shiba inu)"/>
      <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
      <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
    </div>
    <div id="searchResult" style="margin-top:12px"></div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (BTC)</h3>
      <div class="kv">
        <div class="box"><div class="k">ì—…ë¹„íŠ¸ KRW</div><div class="v" id="kp_upbit">-</div></div>
        <div class="box"><div class="k">ê¸€ë¡œë²Œ USD</div><div class="v" id="kp_usd">-</div></div>
        <div class="box"><div class="k">USD/KRW</div><div class="v" id="kp_fx">-</div></div>
      </div>
      <div class="box" style="margin-top:12px"><div class="k">í”„ë¦¬ë¯¸ì—„(%)</div><div class="v" id="kp_prem">-</div></div>
      <div class="muted" id="kp_src" style="margin-top:8px">ì†ŒìŠ¤: -</div>
    </div>

    <div class="card">
      <h3>ğŸ§  ì˜¨ì²´ì¸ TVL (ETH)</h3>
      <div class="kv">
        <div class="box"><div class="k">TVL</div><div class="v" id="tvl_v">-</div></div>
        <div class="box"><div class="k">ì†ŒìŠ¤</div><div class="v" id="tvl_src">-</div></div>
        <div class="box"><div class="k">ì—…ë°ì´íŠ¸</div><div class="v" id="tvl_ts">-</div></div>
      </div>
      <div class="muted" style="margin-top:8px">DefiLlama ì‹¤íŒ¨ ì‹œ ìë™ í´ë°±</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>âš¡ SPARK (ê¸‰ë“± ê°ì§€ Â· TOP 10)</h3>
    <div class="muted" style="margin:4px 0 8px">í˜„ì¬ê°€Â·ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´ê²°ë¡  í¬í•¨</div>
    <table>
      <thead>
        <tr>
          <th>ì½”ì¸</th><th>í˜„ì¬ê°€</th><th>60m</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th>
        </tr>
      </thead>
      <tbody id="sparkRows"><tr><td colspan="8" class="muted">ë™ê¸°í™” ì¤‘â€¦</td></tr></tbody>
    </table>
  </div>

  <div class="muted" style="text-align:center;margin:24px 0 36px">Â© 2025 ì©”ì–´ì§„ê°‘ âˆ | ì—…ë¹„íŠ¸Â·ì˜¨ì²´ì¸Â·ê¹€í”„ ì—°ë™</div>
</div>

<script>
  // ===== í™˜ê²½ =====
  const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev"; // â˜…â˜…â˜… ë„¤ ì›Œì»¤ URLë¡œ êµì²´ â˜…â˜…â˜…

  // ===== ìœ í‹¸ =====
  const $ = s=>document.querySelector(s);
  const fmtKRW = n => (n||n===0) ? Number(n).toLocaleString("ko-KR")+"ì›" : "-";
  const riskTag = r => `<span class="pill risk${Math.max(1,Math.min(5,r|0))}">${Math.max(1,Math.min(5,r|0))}</span>`;

  // ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ê·¼ì‚¬
  function tickKRW(p){
    if (p >= 2_000_000) return 1000;
    if (p >= 100_000)  return 50;
    if (p >= 10_000)   return 10;
    if (p >= 1_000)    return 1;
    if (p >= 100)      return 0.1;
    if (p >= 10)       return 0.01;
    if (p >= 1)        return 0.001;
    return 0.0001;
  }
  const roundTick = p => Math.round(p / tickKRW(p)) * tickKRW(p);

  // ë¶ˆì¥/í•˜ë½ ìë™íŒë³„ í¬í•¨ íƒ€ì 
  function decide(price, opts={}){
    const { premiumPct=0, vol=1.0 } = opts;
    const spread = premiumPct>2 || vol>1.05 ? 0.006 : premiumPct<-1 || vol<0.95 ? 0.003 : 0.004; // ê³µê²©/ë³´ìˆ˜/ê¸°ë³¸
    const stopMul = premiumPct>2 || vol>1.05 ? 0.975 : premiumPct<-1 || vol<0.95 ? 0.99 : 0.985;

    const buy  = roundTick(price*(1-spread));
    const sell = roundTick(price*(1+spread));
    const stop = roundTick(price*stopMul);

    let risk = 3;
    if (premiumPct>3 || vol>1.08) risk = 5;
    else if (premiumPct>2 || vol>1.05) risk = 4;
    else if (premiumPct<-1 || vol<0.95) risk = 2;
    else risk = 3;

    let verdict = "ì¤‘ë¦½, ê´€ë§ êµ¬ê°„";
    if (premiumPct>2 || vol>1.05) verdict = "ğŸ”¥ ë¶ˆì¥ëª¨ë“œ â€” ë‹¨ê¸° ê³¼ì—´, ë¶„í•  ë§¤ë„ ìœ ë¦¬";
    else if (premiumPct<-1 || vol<0.95) verdict = "â„ï¸ í•˜ë½ì¥ëª¨ë“œ â€” ì•½ì„¸, ì†ì ˆÂ·ê´€ë§";
    else verdict = "âš–ï¸ ì¤‘ë¦½, ìŠ¤ìœ™ ëŒ€ì‘";

    return { buy, sell, stop, risk, verdict };
  }

  async function j(path){ const r = await fetch(API_BASE+path, {cache:"no-store"}); return r.json(); }

  // API ìƒíƒœ
  (async ()=>{
    try{ const h = await j("/api/health"); $("#apiState").textContent = h.ok?"API ì—°ê²°: ì •ìƒ":"API ì—°ê²°: ëŒ€ê¸°"; }
    catch{ $("#apiState").textContent = "API ì—°ê²°: ì˜¤ë¥˜"; }
  })();

  // ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„(BTC)
  async function loadPremium(sym="BTC"){
    try{
      const p = await j(`/api/premium?symbol=${sym}`);
      if (p.ok){
        $("#kp_upbit").textContent = fmtKRW(p.upbitKrw);
        $("#kp_usd").textContent   = p.globalUsd?("$"+p.globalUsd.toLocaleString("en-US")):"-";
        $("#kp_fx").textContent    = p.usdkrw?.toLocaleString("ko-KR")||"-";
        $("#kp_prem").textContent  = (p.premiumPct>=0?"+":"")+p.premiumPct.toFixed(2)+" %";
        $("#kp_src").textContent   = `ì†ŒìŠ¤: ${p.src.global} Â· ${p.src.fx} Â· ${p.src.krw} Â· ${new Date(p.updatedAt).toLocaleString()}`;
      }
    }catch{}
  }
  loadPremium("BTC");

  // ì˜¨ì²´ì¸ TVL(ETH)
  async function loadTVL(){
    try{
      const x = await j("/api/onchain?chain=Ethereum");
      $("#tvl_v").textContent = x.tvl ? "$"+x.tvl.toLocaleString("en-US") : "-";
      $("#tvl_src").textContent = x.src || "-";
      $("#tvl_ts").textContent = new Date(x.updatedAt||Date.now()).toLocaleString();
    }catch{
      $("#tvl_v").textContent="-"; $("#tvl_src").textContent="ì˜¤ë¥˜"; $("#tvl_ts").textContent="-";
    }
  }
  loadTVL();

  // ê²€ìƒ‰: ì—…ë¹„íŠ¸ ë™ì¼ ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜
  async function doSearch(){
    const q = $("#q").value.trim();
    if (!q){ $("#searchResult").innerHTML=""; return; }
    const all = await j("/api/markets");
    const rows = all.filter(x =>
      x.symbol.toLowerCase().includes(q.toLowerCase()) ||
      x.name_kr.includes(q) ||
      x.name_en.toLowerCase().includes(q.toLowerCase())
    ).slice(0, 20);

    if (!rows.length){
      $("#searchResult").innerHTML = `<div class="muted">ê²€ìƒ‰ ì‹¤íŒ¨: ì¼ì¹˜ í•­ëª© ì—†ìŒ</div>`;
      return;
    }

    let html = `<table><thead>
      <tr><th>ì½”ì¸</th><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th></tr>
    </thead><tbody>`;
    for (const r of rows){
      try{
        const qj = await j(`/api/quote?symbol=${r.symbol}`);
        const d  = decide(qj.price, { premiumPct: 0, vol: 1 + Math.abs(qj.change_rate||0) });
        html += `<tr>
          <td>${r.symbol}</td>
          <td>${fmtKRW(qj.price)}</td>
          <td>${fmtKRW(d.buy)}</td>
          <td>${fmtKRW(d.sell)}</td>
          <td>${fmtKRW(d.stop)}</td>
          <td>${riskTag(d.risk)}</td>
          <td>${d.verdict}</td>
        </tr>`;
      }catch{
        html += `<tr><td colspan="7">ë°ì´í„° ì˜¤ë¥˜</td></tr>`;
      }
    }
    html += `</tbody></table>`;
    $("#searchResult").innerHTML = html;
  }
  $("#btnSearch").onclick = doSearch;
  $("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });
  $("#btnReset").onclick = ()=>{ $("#q").value=""; $("#searchResult").innerHTML=""; };

  // SPARK: TOP 10 (í˜„ì¬ê°€/íƒ€ì /ìœ„í—˜ë„/ê²°ë¡ )
  async function loadSpark(){
    try{
      const sp = await j("/api/spark?limit=10");
      const tb = $("#sparkRows");
      tb.innerHTML = "";
      for (const r of sp.items){
        const d = decide(r.price, { premiumPct: 0, vol: (100+Math.abs(r.chg60m))/100 });
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.symbol}</td>
          <td>${fmtKRW(r.price)}</td>
          <td class="${r.chg60m>=0?'ok':'bad'}">${(r.chg60m>=0?'+':'')}${r.chg60m.toFixed(2)}%</td>
          <td>${fmtKRW(d.buy)}</td>
          <td>${fmtKRW(d.sell)}</td>
          <td>${fmtKRW(d.stop)}</td>
          <td>${riskTag(d.risk)}</td>
          <td>${d.verdict}</td>
        `;
        tb.appendChild(tr);
      }
    }catch{
      $("#sparkRows").innerHTML = `<tr><td colspan="8" class="muted">SPARK ë¡œë”© ì˜¤ë¥˜</td></tr>`;
    }
  }
  loadSpark();
  setInterval(()=>{ loadPremium("BTC"); loadTVL(); loadSpark(); }, 30_000); // 30ì´ˆ ì£¼ê¸°
</script>
</body>
</html>
