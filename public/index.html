<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KRW 코인 검색 · 매수/매도 타점</title>
<style>
:root{
  --bg:#0d0f12;--card:#12151b;--muted:#8892a6;--line:#1f2a36;
  --fg:#e7ecf8;--green:#22c55e;--red:#ef4444;--warn:#facc15;
}
body{background:var(--bg);color:var(--fg);font-family:'Segoe UI',sans-serif;margin:32px}
h2{margin-bottom:16px}
input,button{padding:10px;border:0;border-radius:8px;font-size:15px}
input{background:#0b0e13;color:var(--fg);border:1px solid var(--line);width:240px}
button{background:#1c2733;color:var(--fg);cursor:pointer}
button:hover{background:#263648}
table{border-collapse:collapse;width:100%;margin-top:6px}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 0}
.banner{margin-top:14px;padding:10px 14px;border-radius:12px;font-weight:600}
.banner.ok{background:#0e1f15;color:#22c55e}
.banner.warn{background:#1f1b0f;color:#eab308}
.banner.dang{background:#1f0f0f;color:#ef4444}
.chip{display:inline-block;background:#1e293b;padding:5px 9px;border-radius:999px;font-size:13px}
#loader{position:fixed;bottom:16px;right:16px;background:#0b0e13;border:1px solid #223043;padding:8px 12px;border-radius:10px;opacity:0;transition:.2s}
#loader.on{opacity:1}
</style>
</head>
<body>
<h2>KRW 코인 검색 · 매수/매도 타점</h2>

<div>
  <input id="q" placeholder="예: 비트코인, BTC, KRW-ETH">
  <button id="searchBtn">검색</button>
  <span id="sys" class="chip">시스템: 대기</span>
  <span id="risk" class="chip">위험도: -</span>
</div>

<div id="oneLine" class="banner warn">검색 결과 없음</div>

<div class="card">
<table>
<thead><tr><th>지표</th><th>값</th><th>설명</th></tr></thead>
<tbody>
<tr><td>코인</td><td id="coin">-</td><td>현재가/등락</td></tr>
<tr><td>현재가</td><td id="price">-</td><td>매수/매도 타점 기준</td></tr>
<tr><td>등락</td><td id="chg">-</td><td>전일 대비 등락률</td></tr>
<tr><td>김치 프리미엄</td><td id="kimchi">-</td><td>업비트 vs 코인베이스</td></tr>
<tr><td>온체인 자금흐름</td><td id="onchain">-</td><td>Stablecoin 순유입/유출</td></tr>
<tr><td>매수 타점</td><td id="buy">-</td><td>추천 매수가</td></tr>
<tr><td>매도 타점</td><td id="sell">-</td><td>추천 매도가</td></tr>
<tr><td>손절 라인</td><td id="stop">-</td><td>위험 관리 손절가</td></tr>
</tbody>
</table>
</div>

<div id="loader">⏳ 데이터 불러오는 중...</div>

<script>
const $=id=>document.getElementById(id);
const showLoad=x=>$('loader').classList.toggle('on',x);
const fmt=v=>Number(v||0).toLocaleString('ko-KR');
const pct=v=>`${v>0?'+':''}${(v||0).toFixed(2)}%`;

function tickSize(p){
  if(p>=2_000_000) return 1000;
  if(p>=1_000_000) return 500;
  if(p>=500_000) return 100;
  if(p>=100_000) return 50;
  if(p>=10_000) return 10;
  if(p>=1000) return 5;
  if(p>=100) return 1;
  if(p>=10) return 0.1;
  if(p>=1) return 0.01;
  if(p>=0.1) return 0.001;
  return 0.0001;
}

function riskScore(chg,kim){
  if(Math.abs(chg)<0.5&&Math.abs(kim)<1)return{t:'관망',c:'warn'};
  if(chg>1.2&&kim>1.5)return{t:'주의',c:'warn'};
  if(chg<-1.2||kim>4)return{t:'경고',c:'dang'};
  return{t:'보통',c:'ok'};
}

async function getSummary(market){
  const r=await fetch(`/api/summary?market=${market}`);
  return r.ok?await r.json():null;
}

async function render(s){
  const u=s?.upbit;
  if(!u)return;
  const chg=(u.signed_change_price/u.prev_closing_price)*100;
  const kim=s?.kimchi?.kimchi??0;
  const oc=s?.onchain?.total?.change24h??0;

  $('coin').textContent=u.market.replace('KRW-','');
  $('price').textContent=fmt(u.trade_price);
  $('chg').textContent=pct(chg);
  $('kimchi').textContent=pct(kim);
  $('onchain').textContent=`${pct(oc)} / ₩${fmt(s?.onchain?.total?.mcapKRW||0)}`;

  // 타점 계산 (업비트 호가 기준)
  const t=tickSize(u.trade_price);
  const base=u.trade_price;
  const buy=base-(t*4);
  const sell=base+(t*4);
  const stop=base-(t*8);
  $('buy').textContent=fmt(buy);
  $('sell').textContent=fmt(sell);
  $('stop').textContent=fmt(stop);

  const risk=riskScore(chg,kim);
  $('risk').textContent=`위험도: ${risk.t}`;
  $('risk').className=`chip ${risk.c}`;
  $('sys').textContent="시스템: OK";
  $('sys').className='chip ok';
  $('oneLine').className=`banner ${risk.c}`;
  $('oneLine').textContent=`(${u.market}) 등락 ${pct(chg)} · 김프 ${pct(kim)} · 온체인 ${pct(oc)} → 매수 ${fmt(buy)} · 매도 ${fmt(sell)} · 손절 ${fmt(stop)} · 위험도 ${risk.t}`;
}

async function search(){
  const q=$('q').value.trim();
  if(!q)return;
  const market=q.startsWith('KRW-')?q.toUpperCase():'KRW-'+q.toUpperCase();
  showLoad(true);
  try{
    const s=await getSummary(market);
    await render(s);
  }catch(e){
    console.error(e);
    $('sys').textContent="시스템: 오류";
    $('oneLine').textContent="데이터 오류 발생";
  }finally{showLoad(false);}
}

$('searchBtn').addEventListener('click',search);
document.addEventListener('DOMContentLoaded',()=>{search()});
</script>
</body>
</html>
