<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v9.4.0 â€” WS ì´ˆê³ ì†íŒ(ì˜ˆì—´ ìƒì‹œíŒ¨ë„)</title>
<style>
  :root{--bg:#0b0f14;--panel:#111823;--muted:#7c8aa5;--text:#e8eefc;--up:#22c55e;--down:#ef4444;--btn:#0f1b2e;--btnb:#2a3b57}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border:1px solid #1d2736;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  h2{margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border-radius:12px;border:1px solid var(--btnb);background:var(--btn);color:#dbe7ff}
  input{padding:12px 14px;flex:1;min-width:220px}
  button{padding:10px 12px;cursor:pointer}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{padding:6px 10px;border-radius:999px;background:#151f2f;border:1px solid #25344f;font-size:12px}
  .status{margin-top:6px;font-size:12px;color:#9bb0d1}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
  thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
  tbody tr{background:#0e1520;border:1px solid #1d2a40}
  tbody td{padding:10px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  .price{font-variant-numeric:tabular-nums}
  .up{color:var(--up)} .down{color:var(--down)}
  .tag{font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #2a3956;color:#9fb6db;background:#111a27}
  .pill-wrap{display:flex;flex-wrap:wrap;align-items:flex-start}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;margin:6px;border:1px solid #26344f;border-radius:999px;background:#0f1726;transition:transform .15s, box-shadow .15s}
  .pill.new{box-shadow:0 0 0 2px rgba(34,197,94,.35)}
  .pill .sym{font-weight:700}
  .pill .m{font-size:12px;color:#a7b7d4}
</style>
</head>
<body>
<div class="wrap">

  <!-- ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡: í•­ìƒ ë³´ì„/ëˆ„ì /ìµœì‹  ìš°ì„  -->
  <div class="card" id="preheatPanel">
    <h2>ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ (ìƒì‹œ í™œì„± / ìµœì‹ ì´ ìœ„)</h2>
    <div class="badge">ê¸°ì¤€: ê³ ê°€ê·¼ì ‘ â‰¤0.5%, 1m +0.2~2.0%, ê°€ì† â‰¥1.6Ã—</div>
    <div id="preheatBox" class="pill-wrap status" style="margin-top:10px">ì´ˆê¸° ìŠ¤ìº” ì¤‘â€¦</div>
  </div>

  <!-- ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ -->
  <div class="card">
    <h2>ğŸ” ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©, WS ì‹¤ì‹œê°„)</h2>
    <div class="row">
      <input id="q" placeholder="ì½”ì¸ëª…/í‹°ì»¤ (ì˜ˆ: ì´ë”ë¦¬ì›€, ETH, KRW-ETH)">
      <button id="btnSearch" disabled>ê²€ìƒ‰</button>
      <button id="btnTop" disabled>ìƒìŠ¹ TOP10</button>
      <button id="btnHot" disabled>ê¸‰ë“±(ë¶„ì„)</button>
      <button id="btnFall" disabled>ê¸‰ë½(ë¶„ì„)</button>
      <button id="btnPre" disabled>ì˜ˆì—´(í‘œë¡œ ë³´ê¸°)</button>
      <button id="btnReset" disabled>ì´ˆê¸°í™”</button>
    </div>
    <div class="toolbar">
      <span class="badge" id="wsStatus">WS ì—°ê²° ì¤€ë¹„ì¤‘â€¦</span>
      <span class="badge">WSëŠ” ì´ˆì €ì§€ì—°(HTTP ì—†ìŒ)</span>
    </div>
    <div class="status" id="status">ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ì¤‘â€¦</div>

    <table>
      <thead>
        <tr>
          <th style="width:20%">ì½”ì¸</th>
          <th style="width:12%">í˜„ì¬ê°€</th>
          <th style="width:10%">24hë“±ë½</th>
          <th style="width:12%">ë§¤ìˆ˜</th>
          <th style="width:12%">ë§¤ë„</th>
          <th style="width:12%">ì†ì ˆ</th>
          <th style="width:8%">ì‹œê·¸ë„</th>
          <th>ë¶„ì„</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
  <div class="card">
    <h2>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div class="status">ì—…ë¹„íŠ¸ WebSocket ì‹¤ì‹œê°„ ìˆ˜ì‹ . RESTëŠ” ì´ˆê¸° ë§ˆì¼“ë§Œ ì‚¬ìš©.</div>
  </div>
</div>

<script>
/* ===== ì„ê³„ê°’ ===== */
const THRESH = {
  pct1mUp: 0.03, pct1mDown: -0.03, accel: 1.8, windowSec: 60, baselineMin: 600,
  preNearHighPct: 0.005, preMinMove: 0.002, preMaxMove: 0.020, preAccel: 1.6
};
const PREHEAT_TTL_MS = 30*60*1000;
const PREHEAT_MAX = 48;

/* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const el = {
  q: document.getElementById('q'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  wsStatus: document.getElementById('wsStatus'),
  preheatBox: document.getElementById('preheatBox'),
  btnSearch: document.getElementById('btnSearch'),
  btnTop: document.getElementById('btnTop'),
  btnHot: document.getElementById('btnHot'),
  btnFall: document.getElementById('btnFall'),
  btnPre: document.getElementById('btnPre'),
  btnReset: document.getElementById('btnReset')
};

/* ===== ìƒíƒœ ===== */
const state = {
  markets: [],
  dict: {},
  // ì‹¤ì‹œê°„ ìŠ¤ëƒ…ìƒ·
  tickers: new Map(), // market -> {trade_price, high_price, signed_change_rate, acc_trade_price_24h, ts}
  hist: new Map(),    // market -> [{ts, price, acc, high}]
  preheatMap: new Map(), // market -> {nearHigh, pricePct1m, accel, score, lastSeen, firstSeen}
  sockets: [],
  lastList: [],
};

/* ===== ìœ í‹¸ ===== */
function enableAll(){ [el.btnSearch, el.btnTop, el.btnHot, el.btnFall, el.btnPre, el.btnReset].forEach(b=>b.disabled=false); }
function krwTick(p){
  if(p>=2000000) return 1000; if(p>=1000000) return 500; if(p>=500000) return 100;
  if(p>=100000) return 50; if(p>=10000) return 10; if(p>=1000) return 5;
  if(p>=100) return 1; if(p>=10) return 0.1; if(p>=1) return 0.01; return 0.001;
}
function fmtKRW(p){ const t=krwTick(p); const d=t>=1?0:t===0.1?1:t===0.01?2:3;
  return Number(p||0).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d}); }
function setStatus(s){ el.status.textContent=s; }

/* ===== ì´ˆê¸° ë§ˆì¼“ ëª©ë¡(REST) ===== */
async function loadMarkets(){
  const r = await fetch('https://api.upbit.com/v1/market/all?isDetails=true',{cache:'no-store'});
  const data = await r.json();
  state.markets = data.filter(x=>x.market?.startsWith('KRW-'));
  // ê²€ìƒ‰ ì‚¬ì „
  state.dict = {};
  for(const m of state.markets){
    const keys=[m.market,m.korean_name,m.english_name,m.korean_name?.replace(/\s+/g,''),m.english_name?.replace(/\s+/g,'')]
      .filter(Boolean).map(x=>x.toLowerCase());
    for(const k of keys) (state.dict[k]??=[]).push(m);
  }
  setStatus(`KRW ${state.markets.length}ì¢… ë¡œë“œ ì™„ë£Œ â€” WS ì—°ê²° ì¤‘â€¦`);
}

/* ===== WebSocket êµ¬ë… (ì´ˆê³ ì†) =====
   - ì—…ë¹„íŠ¸ WS: wss://api.upbit.com/websocket/v1
   - ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥ (CORS X)
   - ë§ˆì¼“ì„ 80ê°œì”© ë‚˜ëˆ  ì—¬ëŸ¬ ì†Œì¼“ìœ¼ë¡œ êµ¬ë…
*/
function openSockets(){
  closeSockets();
  const chunk=80;
  const markets = state.markets.map(m=>m.market);
  for(let i=0;i<markets.length;i+=chunk){
    const part = markets.slice(i,i+chunk);
    const ws = new WebSocket('wss://api.upbit.com/websocket/v1');
    ws.binaryType = 'arraybuffer';
    ws.onopen = () => {
      el.wsStatus.textContent = `WS ì—°ê²°ë¨(${state.sockets.length+1}ê°œ) â€” ì‹¤ì‹œê°„ ìˆ˜ì‹  ì¤‘`;
      // êµ¬ë… ë©”ì‹œì§€ ì „ì†¡
      const msg = [
        {ticket: "satoshi-wallet"},
        {type: "ticker", codes: part, isOnlyRealtime: true}
      ];
      ws.send(new TextEncoder().encode(JSON.stringify(msg)));
    };
    ws.onmessage = (ev)=>{
      // ì—…ë¹„íŠ¸ WSëŠ” ArrayBuffer(JSON)ë¥¼ ë³´ëƒ„
      const txt = new TextDecoder("utf-8").decode(ev.data);
      const t = JSON.parse(txt);
      // í•„ìš”í•œ í•„ë“œ ì €ì¥
      const item = {
        market: t.code,
        trade_price: t.trade_price,
        high_price: t.high_price || t.high,        // ë³´í˜¸
        signed_change_rate: (t.signed_change_rate ?? t.change_rate ?? 0),
        acc_trade_price_24h: t.acc_trade_price_24h ?? 0,
        ts: Date.now()
      };
      state.tickers.set(item.market, item);
      updateHistoryFromTicker(item);
      // ì˜ˆì—´ ìë™ ê°±ì‹ (ë¶€ë‹´ ë‚®ê²Œ: 200ms ë””ë°”ìš´ìŠ¤)
      schedulePreheatScan();
    };
    ws.onclose = ()=>{ el.wsStatus.textContent = 'WS ì—°ê²° ëŠê¹€ â€” ì¬ì—°ê²° ëŒ€ê¸°â€¦'; setTimeout(openSockets, 1500); };
    ws.onerror = ()=>{ /* ìë™ ì¬ì‹œë„ */ };
    state.sockets.push(ws);
  }
}
function closeSockets(){ state.sockets.forEach(s=>{try{s.close()}catch{}}); state.sockets=[]; }

/* ===== íˆìŠ¤í† ë¦¬/ë¶„ì„ ===== */
function updateHistoryFromTicker(t){
  const key = t.market; const now = t.ts;
  const arr = state.hist.get(key) || [];
  arr.push({ts:now, price:t.trade_price, acc:t.acc_trade_price_24h||0, high:t.high_price||t.trade_price});
  const cutoff = now - THRESH.baselineMin*1000;
  while(arr.length && arr[0].ts < cutoff) arr.shift();
  state.hist.set(key, arr);
}
function oneMinStats(key){
  const now = Date.now();
  const arr = state.hist.get(key) || [];
  if(arr.length<2) return null;
  const target = now - 60*1000;
  let past = arr[0];
  for(let i=arr.length-1;i>=0;i--){ if(arr[i].ts<=target){ past=arr[i]; break; } }
  const cur = arr[arr.length-1];
  const old = arr.find(x=>x.ts>=now-600*1000) || arr[0];
  const basePerMin = (Math.max(0,cur.acc-old.acc))/Math.max(1,((cur.ts-old.ts)/60000));
  const pricePct1m = past.price>0 ? (cur.price - past.price)/past.price : 0;
  const accel = basePerMin>0 ? (Math.max(0,cur.acc-past.acc)/basePerMin) : 0;
  const nearHigh = (cur.high>0) ? Math.max(0,(cur.high - cur.price)/cur.high) : 1;
  return {pricePct1m, accel, nearHigh};
}

/* ===== ì˜ˆì—´ íŒ¨ë„(ëˆ„ì /ìµœì‹ ìš°ì„ ) ===== */
function preheatScore(st){
  const nearScore = 1 - Math.min(1, st.nearHigh);
  const accelScore = Math.min(3, st.accel)/3;
  const pctBonus = Math.max(0, Math.min(1, (st.pricePct1m-0.002)/(0.02-0.002)));
  return nearScore*0.5 + accelScore*0.35 + pctBonus*0.15;
}
function upsertPreheat(market, st){
  const now = Date.now();
  const prev = state.preheatMap.get(market);
  state.preheatMap.set(market, {
    nearHigh: st.nearHigh, pricePct1m: st.pricePct1m, accel: st.accel,
    score: preheatScore(st),
    firstSeen: prev?.firstSeen ?? now,
    lastSeen: now
  });
  // ì˜¤ë˜ëœ í•­ëª© ì²­ì†Œ
  const del=[];
  state.preheatMap.forEach((v,k)=>{ if(now - v.lastSeen > PREHEAT_TTL_MS) del.push(k); });
  del.forEach(k=>state.preheatMap.delete(k));
  // ìƒí•œ ìœ ì§€
  if(state.preheatMap.size > PREHEAT_MAX){
    const arr = [...state.preheatMap.entries()]
      .sort((a,b)=> (a[1].lastSeen - b[1].lastSeen) || (a[1].score - b[1].score));
    for(let i=0;i<state.preheatMap.size-PREHEAT_MAX;i++){ state.preheatMap.delete(arr[i][0]); }
  }
}
function renderPreheatPanel(){
  const box = el.preheatBox;
  const now = Date.now();
  const arr = [...state.preheatMap.entries()]
    .map(([market,v])=>({market,...v}))
    .sort((a,b)=> (b.lastSeen - a.lastSeen) || (b.score - a.score));
  if(!arr.length){ box.textContent='ì˜ˆì—´ í›„ë³´ ì—†ìŒ(ìë™ ê°ì‹œ ì¤‘)'; return; }
  box.textContent='';
  arr.slice(0,48).forEach(item=>{
    const isNew = (now - item.firstSeen) < 5000;
    const div=document.createElement('div');
    div.className='pill' + (isNew?' new':'');
    div.innerHTML = `
      <span class="sym">${item.market.replace('KRW-','')}</span>
      <span class="m">ê°€ê¹Œì›€ ${(item.nearHigh*100).toFixed(2)}%</span>
      <span class="m">1m ${(item.pricePct1m*100).toFixed(2)}%</span>
      <span class="m">ê°€ì† ${item.accel.toFixed(1)}Ã—</span>`;
    box.appendChild(div);
  });
}
let preheatTimer=null;
function schedulePreheatScan(){
  // ë„ˆë¬´ ìì£¼ ëŒì§€ ì•Šê²Œ 200ms ë””ë°”ìš´ìŠ¤
  if(preheatTimer) return;
  preheatTimer = setTimeout(()=>{
    preheatTimer=null;
    // ëª¨ë“  ë§ˆì¼“ ì¤‘ ì¡°ê±´ ë§ëŠ” ì• ë§Œ ëˆ„ì 
    for(const m of state.markets){
      const key = m.market;
      const st = oneMinStats(key); if(!st) continue;
      if(st.nearHigh<=THRESH.preNearHighPct &&
         st.pricePct1m>=THRESH.preMinMove && st.pricePct1m<=THRESH.preMaxMove &&
         st.accel>=THRESH.preAccel){
        upsertPreheat(key, st);
      }
    }
    renderPreheatPanel();
  }, 200);
}

/* ===== ë¦¬ìŠ¤íŠ¸ ë Œë” ===== */
function levelsBasic(p){ const t=krwTick(p); return {buy:p-2*t, sell:p+3*t, cut:p-6*t}; }
function renderRows(rows, empty='ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.'){
  el.tbody.innerHTML='';
  if(!rows.length){ el.tbody.innerHTML=`<tr><td colspan="8" class="status">${empty}</td></tr>`; return; }
  for(const r of rows){
    const cls = (r.signed_change_rate||0)>=0 ? 'up':'down';
    const lv = levelsBasic(r.trade_price);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.market.replace('KRW-','')}</span> ${r.name}</td>
      <td class="price ${cls}">${fmtKRW(r.trade_price)}</td>
      <td class="${cls}">${((r.signed_change_rate||0)*100).toFixed(2)}%</td>
      <td class="price">${fmtKRW(lv.buy)}</td>
      <td class="price">${fmtKRW(lv.sell)}</td>
      <td class="price down">${fmtKRW(lv.cut)}</td>
      <td>${r.signal||''}</td>
      <td>${r.note||''}</td>`;
    el.tbody.appendChild(tr);
  }
}

/* ===== ê²€ìƒ‰/ì •ë ¬(ìŠ¤ëƒ…ìƒ· ê¸°ë°˜, ë„¤íŠ¸ì›Œí¬ X) ===== */
function searchLocal(q){
  if(!q) return state.markets.slice(0,20);
  const key=q.trim().toLowerCase();
  let l=state.dict[key]?[...state.dict[key]]:[];
  if(!l.length){
    l=state.markets.filter(m=>
      m.market.toLowerCase().includes(key)||
      m.korean_name.toLowerCase().includes(key)||
      m.english_name.toLowerCase().includes(key)
    );
  }
  return l.slice(0,30);
}
function buildRowsFromSnapshot(list, mode='basic'){
  const rows=[];
  for(const m of list){
    const t = state.tickers.get(m.market);
    if(!t) continue;
    const base = {market:m.market, name:m.korean_name||m.english_name, ...t};
    if(mode==='hot' || mode==='fall'){
      const st = oneMinStats(m.market); if(!st) continue;
      const ok = mode==='hot'
        ? (st.pricePct1m>=THRESH.pct1mUp && st.accel>=THRESH.accel)
        : (st.pricePct1m<=THRESH.pct1mDown && st.accel>=THRESH.accel);
      if(!ok) continue;
      base.signal = mode==='hot'?'ê¸‰ë“±':'ê¸‰ë½';
      base.note = `1m ${(st.pricePct1m*100).toFixed(2)}%, ê°€ì† ${st.accel.toFixed(1)}Ã—`;
    }
    if(mode==='pre'){
      const st = oneMinStats(m.market); if(!st) continue;
      const near = st.nearHigh;
      if(!(near<=THRESH.preNearHighPct && st.pricePct1m>=THRESH.preMinMove && st.pricePct1m<=THRESH.preMaxMove && st.accel>=THRESH.preAccel)) continue;
      base.signal='ì˜ˆì—´'; base.note=`ê°€ê¹Œì›€ ${(near*100).toFixed(2)}%, 1m ${(st.pricePct1m*100).toFixed(2)}%, ê°€ì† ${st.accel.toFixed(1)}Ã—`;
    }
    rows.push(base);
  }
  return rows;
}

/* ===== ë²„íŠ¼ ===== */
el.btnSearch.onclick = ()=>{
  const list = searchLocal(el.q.value);
  state.lastList = list;
  renderRows(buildRowsFromSnapshot(list,'basic'), 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
};
el.q.onkeydown = e=>{ if(e.key==='Enter') el.btnSearch.click(); };

el.btnTop.onclick = ()=>{
  const all = state.markets.map(m=>{
    const t=state.tickers.get(m.market); if(!t) return null;
    return {market:m.market, name:m.korean_name||m.english_name, ...t};
  }).filter(Boolean);
  all.sort((a,b)=> (b.signed_change_rate||0) - (a.signed_change_rate||0));
  renderRows(all.slice(0,10));
};
el.btnHot.onclick = ()=>{
  const rows = buildRowsFromSnapshot(state.markets,'hot')
    .sort((a,b)=> (b.signed_change_rate||0) - (a.signed_change_rate||0))
    .slice(0,20);
  renderRows(rows, 'ê¸‰ë“± ì¡°ê±´ ì—†ìŒ');
};
el.btnFall.onclick = ()=>{
  const rows = buildRowsFromSnapshot(state.markets,'fall')
    .sort((a,b)=> (a.signed_change_rate||0) - (b.signed_change_rate||0))
    .slice(0,20);
  renderRows(rows, 'ê¸‰ë½ ì¡°ê±´ ì—†ìŒ');
};
el.btnPre.onclick = ()=>{
  const rows = buildRowsFromSnapshot(state.markets,'pre')
    .sort((a,b)=> { // ê³ ê°€ ë” ê·¼ì ‘ + ê°€ì† í° ìˆœ
      const sa = preheatScore(oneMinStats(a.market)||{nearHigh:1,pricePct1m:0,accel:0});
      const sb = preheatScore(oneMinStats(b.market)||{nearHigh:1,pricePct1m:0,accel:0});
      return sb - sa;
    }).slice(0,20);
  renderRows(rows, 'ì˜ˆì—´ í›„ë³´ ì—†ìŒ');
};
el.btnReset.onclick = ()=>{
  el.q.value='';
  const list = state.markets.slice(0,20);
  state.lastList = list;
  renderRows(buildRowsFromSnapshot(list,'basic'));
};

/* ===== ì‹œì‘ ===== */
(async function init(){
  await loadMarkets();
  enableAll();
  // WS ì—°ê²°
  openSockets();
  // ì ‘ì† ì§í›„: ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ(WS ìŠ¤ëƒ…ìƒ· ìŒ“ì´ëŠ”ëŒ€ë¡œ ì¦‰ì‹œ ê°±ì‹ í•˜ë ¤ê³  500ms ì§€ì—°)
  setTimeout(()=>{
    const list = state.markets.slice(0,20);
    state.lastList = list;
    renderRows(buildRowsFromSnapshot(list,'basic'));
    el.wsStatus.textContent = 'WS ì¤€ë¹„ ì™„ë£Œ â€” ë²„íŠ¼ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥';
  }, 500);
})();
</script>
</body>
</html>
