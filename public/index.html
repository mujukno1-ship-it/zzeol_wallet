<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v9.3.5 â€“ ì˜ˆì—´ ì˜ˆì¸¡ ìƒì‹œíŒ¨ë„(ê³ ì •/ëˆ„ì /ìµœì‹  ìš°ì„ )</title>
<style>
  :root{--bg:#0b0f14;--panel:#111823;--muted:#7c8aa5;--text:#e8eefc;--up:#22c55e;--down:#ef4444;--btn:#0f1b2e;--btnb:#2a3b57}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border:1px solid #1d2736;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  h2{margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border-radius:12px;border:1px solid var(--btnb);background:var(--btn);color:#dbe7ff}
  input{padding:12px 14px;flex:1;min-width:220px}
  button{padding:10px 12px;cursor:pointer}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{padding:6px 10px;border-radius:999px;background:#151f2f;border:1px solid #25344f;font-size:12px}
  .status{margin-top:6px;font-size:12px;color:#9bb0d1}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
  thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
  tbody tr{background:#0e1520;border:1px solid #1d2a40}
  tbody td{padding:10px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  .price{font-variant-numeric:tabular-nums}
  .up{color:var(--up)} .down{color:var(--down)}
  .tag{font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #2a3956;color:#9fb6db;background:#111a27}
  .pill-wrap{display:flex;flex-wrap:wrap;align-items:flex-start}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;margin:6px;border:1px solid #26344f;border-radius:999px;background:#0f1726;transition:transform .15s ease, box-shadow .15s ease}
  .pill.new{box-shadow:0 0 0 2px rgba(34,197,94,.35)}
  .pill .sym{font-weight:700}
  .pill .m{font-size:12px;color:#a7b7d4}
</style>
</head>
<body>
<div class="wrap">
  <!-- ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ íŒ¨ë„: í•­ìƒ ë§¨ ìœ„ì— ê³ ì • -->
  <div class="card" id="preheatPanel">
    <h2>ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ (í•­ìƒ í™œì„±/ëˆ„ì , ìµœì‹  ë°œê²¬ì´ ìœ„ë¡œ)</h2>
    <div class="badge">ê¸°ì¤€: ê³ ê°€ê·¼ì ‘ â‰¤0.5%, 1m +0.2~2.0%, ê°€ì† â‰¥1.6Ã—</div>
    <div id="preheatBox" class="pill-wrap status" style="margin-top:10px">ì´ˆê¸° ìŠ¤ìº” ì¤‘â€¦</div>
  </div>

  <!-- ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ -->
  <div class="card">
    <h2>ğŸ” ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©, ë¶„ì„ê¸°ë°˜)</h2>
    <div class="row">
      <input id="q" placeholder="ì½”ì¸ëª…/í‹°ì»¤ (ì˜ˆ: ì´ë”ë¦¬ì›€, ETH, KRW-ETH)">
      <button id="btnSearch" disabled>ê²€ìƒ‰</button>
      <button id="btnTop" disabled>ìƒìŠ¹ TOP10</button>
      <button id="btnHot" disabled>ê¸‰ë“±(ë¶„ì„)</button>
      <button id="btnFall" disabled>ê¸‰ë½(ë¶„ì„)</button>
      <button id="btnPre" disabled>ì˜ˆì—´(ë²„íŠ¼ ìˆ˜ë™ ë³´ê¸°)</button>
      <button id="btnReset" disabled>ì´ˆê¸°í™”</button>
    </div>
    <div class="toolbar">
      <button id="btn1s" disabled>í´ë§ 1ì´ˆ</button>
      <button id="btn2s" disabled>2ì´ˆ</button>
      <button id="btn5s" disabled>5ì´ˆ</button>
      <button id="btnStop" disabled>ì •ì§€</button>
      <span class="badge">ìƒë‹¨ íŒ¨ë„ì€ ìë™ ìœ ì§€/ìë™ ì—…ë°ì´íŠ¸</span>
    </div>
    <div class="status" id="status">ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ì¤‘â€¦</div>

    <table>
      <thead>
        <tr>
          <th style="width:20%">ì½”ì¸</th>
          <th style="width:12%">í˜„ì¬ê°€</th>
          <th style="width:10%">24hë“±ë½</th>
          <th style="width:12%">ë§¤ìˆ˜</th>
          <th style="width:12%">ë§¤ë„</th>
          <th style="width:12%">ì†ì ˆ</th>
          <th style="width:8%">ì‹œê·¸ë„</th>
          <th>ë¶„ì„</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
  <div class="card">
    <h2>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div class="status">ì—…ë¹„íŠ¸ REST ì§ì ‘ ì—°ë™(CORS í—ˆìš©). í”„ë¡ì‹œ(/api/upbit) ì—†ì´ ë™ì‘.</div>
  </div>
</div>

<script>
/* -------------------- ì„ê³„ê°’/ì„¤ì • -------------------- */
const THRESH = {
  pct1mUp: 0.03, pct1mDown: -0.03, accel: 1.8, windowSec: 60, baselineMin: 600,
  preNearHighPct: 0.005, preMinMove: 0.002, preMaxMove: 0.020, preAccel: 1.6
};
const POLL_DEFAULT = 1000;
const PREHEAT_MAX = 48;           // íŒ¨ë„ì— ë³´ê´€í•  ìµœëŒ€ í›„ë³´ ìˆ˜
const PREHEAT_TTL_MS = 30*60*1000;// 30ë¶„ ì§€ë‚˜ë©´ ìì—° ì •ë¦¬(ì‚¬ë¼ì§€ì§€ ì•Šë˜ ì˜¤ë˜ëœ ê±´ ì²­ì†Œ)

/* -------------------- ì „ì—­ -------------------- */
const el = {
  q: document.getElementById('q'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  preheatBox: document.getElementById('preheatBox'),
  btnSearch: document.getElementById('btnSearch'),
  btnTop: document.getElementById('btnTop'),
  btnHot: document.getElementById('btnHot'),
  btnFall: document.getElementById('btnFall'),
  btnPre: document.getElementById('btnPre'),
  btnReset: document.getElementById('btnReset'),
  btn1s: document.getElementById('btn1s'),
  btn2s: document.getElementById('btn2s'),
  btn5s: document.getElementById('btn5s'),
  btnStop: document.getElementById('btnStop'),
};
const UPBIT = {
  markets: 'https://api.upbit.com/v1/market/all?isDetails=true',
  ticker: (codes)=>`https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
};
const state = {
  markets: [], dict: {},
  pollMs: POLL_DEFAULT, timer: null, lastList: [],
  hist: new Map(),
  scanCounter: 0,
  // ì˜ˆì—´ í›„ë³´ë¥¼ "ì˜ì†" ë³´ê´€: market -> {nearHigh, pricePct1m, accel, score, lastSeen}
  preheatMap: new Map()
};

/* -------------------- ìœ í‹¸ -------------------- */
function krwTick(p){
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 5;
  if(p>=100)     return 1;
  if(p>=10)      return 0.1;
  if(p>=1)       return 0.01;
  return 0.001;
}
function fmtKRW(p){
  const t=krwTick(p);
  const d=t>=1?0:t===0.1?1:t===0.01?2:3;
  return Number(p).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function setStatus(s){ el.status.textContent = s; }
function enableAll(){
  [el.btnSearch,el.btnTop,el.btnHot,el.btnFall,el.btnPre,el.btnReset,el.btn1s,el.btn2s,el.btn5s,el.btnStop].forEach(b=>b.disabled=false);
}

/* -------------------- ë°ì´í„° ë¡œë“œ/í˜¸ì¶œ -------------------- */
async function loadMarkets(){
  const res = await fetch(UPBIT.markets, {cache:'no-store'});
  const data = await res.json();
  const krw = data.filter(x=>x.market?.startsWith('KRW-'));
  state.markets = krw;
  state.dict = {};
  for(const m of krw){
    const keys=[m.market,m.korean_name,m.english_name,m.korean_name?.replace(/\s+/g,''),m.english_name?.replace(/\s+/g,'')]
      .filter(Boolean).map(x=>x.toLowerCase());
    for(const k of keys){ (state.dict[k]??=[]).push(m); }
  }
  setStatus(`KRW ë§ˆì¼“ ${krw.length}ì¢… ë¡œë“œ ì™„ë£Œ`);
  enableAll();
}
async function fetchTicker(list){
  if(!list.length) return [];
  const codes=list.map(x=>x.market);
  const chunk=80, out=[];
  for(let i=0;i<codes.length;i+=chunk){
    const part=codes.slice(i,i+chunk);
    let data=[], ok=false;
    for(let tries=1; tries<=3 && !ok; tries++){
      try{
        const r=await fetch(UPBIT.ticker(part), {cache:'no-store'});
        if(r.ok){ data=await r.json(); ok=true; }
        else { await new Promise(res=>setTimeout(res, 120*tries)); }
      }catch(e){ await new Promise(res=>setTimeout(res, 150*tries)); }
    }
    out.push(...data);
    await new Promise(res=>setTimeout(res, 100));
  }
  return out;
}

/* -------------------- ë¶„ì„ìš© íˆìŠ¤í† ë¦¬/í†µê³„ -------------------- */
function updateHistory(ticks){
  const now=Date.now();
  for(const t of ticks){
    const key=t.market; const arr=state.hist.get(key)||[];
    arr.push({ts:now, price:t.trade_price, acc:t.acc_trade_price_24h||0, high:t.high_price||t.trade_price});
    const cutoff=now-600*1000; while(arr.length && arr[0].ts<cutoff) arr.shift();
    state.hist.set(key,arr);
  }
}
function oneMinStats(key){
  const now=Date.now(), arr=state.hist.get(key)||[]; if(arr.length<2) return null;
  const target=now-60*1000; let past=arr[0];
  for(let i=arr.length-1;i>=0;i--){ if(arr[i].ts<=target){ past=arr[i]; break; } }
  const cur=arr[arr.length-1], old=arr.find(x=>x.ts>=now-600*1000)||arr[0];
  const base=(Math.max(0,cur.acc-old.acc))/Math.max(1,((cur.ts-old.ts)/60000));
  const pct=past.price>0?(cur.price-past.price)/past.price:0;
  const accel=base>0?(Math.max(0,cur.acc-past.acc)/base):(Math.max(0,cur.acc-past.acc)>0?99:0);
  const near=(cur.high>0)?Math.max(0,(cur.high-cur.price)/cur.high):1;
  return {pricePct1m:pct, accel, nearHigh:near};
}

/* -------------------- ë¦¬ìŠ¤íŠ¸ ë Œë” -------------------- */
function levelsBasic(tk){ const p=+tk.trade_price, t=krwTick(p); return {buy:p-2*t, sell:p+3*t, cut:p-6*t, sig:'ê¸°ë³¸', say:''}; }
function renderRows(rows, emptyMsg='ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.'){
  el.tbody.innerHTML='';
  if(!rows.length){ el.tbody.innerHTML=`<tr><td colspan="8" class="status">${emptyMsg}</td></tr>`; return; }
  for(const r of rows){
    const cls=r.ticker.signed_change_rate>=0?'up':'down';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="tag">${r.market.replace('KRW-','')}</span> ${r.name}</td>
      <td class="price ${cls}">${fmtKRW(r.ticker.trade_price)}</td>
      <td class="${cls}">${(r.ticker.signed_change_rate*100).toFixed(2)}%</td>
      <td class="price">${fmtKRW(r.levels.buy)}</td>
      <td class="price">${fmtKRW(r.levels.sell)}</td>
      <td class="price down">${fmtKRW(r.levels.cut)}</td>
      <td>${r.levels.sig}</td>
      <td>${r.levels.say||''}</td>`;
    el.tbody.appendChild(tr);
  }
}

/* -------------------- ì˜ˆì—´ íŒ¨ë„(ì˜ì†/ìµœì‹  ìš°ì„ ) -------------------- */
function preheatScore(st){
  // ì ìˆ˜: ê³ ê°€ ê·¼ì ‘(ê°€ê¹Œìš¸ìˆ˜ë¡â†‘) + ê°€ì†(í´ìˆ˜ë¡â†‘) + 1mìƒìŠ¹(ì¤‘ê°„ë²”ìœ„ ë³´ë„ˆìŠ¤)
  const nearScore = 1 - Math.min(1, st.nearHigh);         // 0~1
  const accelScore = Math.min(3, st.accel)/3;             // 0~1(ìµœëŒ€ 3ë°° ìº¡)
  const pctBonus = Math.max(0, Math.min(1, (st.pricePct1m-0.002)/(0.02-0.002))); // 0.2~2.0% ìŠ¤ì¼€ì¼ë§
  return nearScore*0.5 + accelScore*0.35 + pctBonus*0.15;
}
function upsertPreheat(market, st){
  const now=Date.now();
  const score=preheatScore(st);
  const prev = state.preheatMap.get(market);
  // ìƒˆë¡œ ë“¤ì–´ì˜¤ë©´ ë°”ë¡œ ìµœì‹ ìœ¼ë¡œ ë³´ì´ë„ë¡ lastSeen ê°±ì‹ 
  state.preheatMap.set(market, {
    nearHigh: st.nearHigh, pricePct1m: st.pricePct1m, accel: st.accel,
    score: score, lastSeen: now, firstSeen: prev?.firstSeen ?? now
  });
  // ê³¼ë„í•œ ëˆ„ì  ë°©ì§€: ì˜¤ë˜ëœ í•­ëª© ì •ë¦¬
  const toDelete=[];
  state.preheatMap.forEach((v,k)=>{ if(now - v.lastSeen > PREHEAT_TTL_MS) toDelete.push(k); });
  toDelete.forEach(k=> state.preheatMap.delete(k));
  // ìƒí•œ ìœ ì§€
  if(state.preheatMap.size > PREHEAT_MAX){
    // ì˜¤ë˜ë˜ê³  ì ìˆ˜ ë‚®ì€ ê²ƒë¶€í„° ì œê±°
    const arr=[...state.preheatMap.entries()]
      .sort((a,b)=> (a[1].lastSeen - b[1].lastSeen) || (a[1].score - b[1].score));
    const excess = state.preheatMap.size - PREHEAT_MAX;
    for(let i=0;i<excess;i++){ state.preheatMap.delete(arr[i][0]); }
  }
}
function renderPreheatPanel(){
  const box = el.preheatBox;
  const arr = [...state.preheatMap.entries()]
    .map(([market,v])=>({market, ...v}))
    .sort((a,b)=> (b.lastSeen - a.lastSeen) || (b.score - a.score)); // â˜… ìµœì‹  ìš°ì„ , ê·¸ë‹¤ìŒ ì ìˆ˜
  if(!arr.length){ box.textContent='ì˜ˆì—´ í›„ë³´ ì—†ìŒ(ìë™ ê°ì‹œ ì¤‘)'; return; }
  box.textContent='';
  const now=Date.now();
  arr.slice(0,48).forEach(item=>{
    const isNew = (now - item.firstSeen) < 5000; // 5ì´ˆ ì´ë‚´ ì‹ ê·œ í‘œì‹
    const div=document.createElement('div');
    div.className='pill' + (isNew? ' new':'');
    div.innerHTML=`
      <span class="sym">${item.market.replace('KRW-','')}</span>
      <span class="m">ê°€ê¹Œì›€ ${(item.nearHigh*100).toFixed(2)}%</span>
      <span class="m">1m ${(item.pricePct1m*100).toFixed(2)}%</span>
      <span class="m">ê°€ì† ${item.accel.toFixed(1)}Ã—</span>
    `;
    box.appendChild(div);
  });
}
async function scanPreheat(){
  const tks = await fetchTicker(state.markets);
  if(!tks.length) return;
  updateHistory(tks);
  for(const m of state.markets){
    const st = oneMinStats(m.market); if(!st) continue;
    const tk = tks.find(x=>x.market===m.market); if(!tk || !tk.high_price) continue;
    const condNear  = st.nearHigh <= THRESH.preNearHighPct;
    const condMove  = st.pricePct1m >= THRESH.preMinMove && st.pricePct1m <= THRESH.preMaxMove;
    const condAccel = st.accel >= THRESH.preAccel;
    if(condNear && condMove && condAccel){
      upsertPreheat(m.market, st); // â˜… ëˆ„ì /ìµœì‹ í™”
    }
  }
  renderPreheatPanel();
}

/* -------------------- í´ë§ -------------------- */
async function poll(){
  try{
    const base = state.lastList.length? state.lastList : state.markets.slice(0,40);
    const tks=await fetchTicker(base);
    if(tks.length){
      updateHistory(tks);
      const rows=base.map(m=>{
        const tk=tks.find(x=>x.market===m.market); if(!tk) return null;
        return {market:m.market, name:m.korean_name||m.english_name, ticker:tk, levels:levelsBasic(tk)};
      }).filter(Boolean);
      renderRows(rows);
      setStatus(`ì‹¤ì‹œê°„ ê°±ì‹  ì¤‘â€¦ (ì£¼ê¸° ${state.pollMs/1000}s)`);
    }
    // ì˜ˆì—´ ìŠ¤ìº”: 5ì´ˆ ê°„ê²©(1ì´ˆ í´ë§ ê¸°ì¤€ìœ¼ë¡œ 5ë²ˆì— 1íšŒ)
    state.scanCounter = (state.scanCounter+1)%5;
    if(state.scanCounter===0){ scanPreheat(); }
  }catch(e){ console.error(e); }
}
function start(){ stop(); state.timer=setInterval(poll,state.pollMs); poll(); }
function stop(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

/* -------------------- ê²€ìƒ‰/ë²„íŠ¼ -------------------- */
function searchLocal(q){
  if(!q) return state.markets.slice(0,20);
  const key=q.trim().toLowerCase();
  let l=state.dict[key]?[...state.dict[key]]:[];
  if(!l.length){
    l=state.markets.filter(m=>
      m.market.toLowerCase().includes(key)||
      m.korean_name.toLowerCase().includes(key)||
      m.english_name.toLowerCase().includes(key)
    );
  }
  return l.slice(0,30);
}
el.btnSearch.onclick = async ()=>{
  const list=searchLocal(el.q.value);
  state.lastList=list;
  const tks=await fetchTicker(list);
  if(tks.length){
    updateHistory(tks);
    const rows=list.map(m=>({market:m.market,name:m.korean_name||m.english_name,ticker:tks.find(x=>x.market===m.market),levels:levelsBasic(tks.find(x=>x.market===m.market))})).filter(r=>r.ticker);
    renderRows(rows,'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
  }else{ renderRows([], 'ê²€ìƒ‰ ì‘ë‹µ ì§€ì—° â€” ë‹¤ì‹œ ì‹œë„'); }
  start();
};
el.q.onkeydown = e=>{ if(e.key==='Enter') el.btnSearch.click(); };

el.btnTop.onclick = async ()=>{
  const tks=await fetchTicker(state.markets); if(!tks.length){ renderRows([], 'ì§€ì—°'); return; }
  updateHistory(tks);
  const top=[...tks].sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const set=new Set(top.map(t=>t.market));
  const list=state.markets.filter(m=>set.has(m.market));
  const rows=list.map(m=>({market:m.market,name:m.korean_name||m.english_name,ticker:top.find(x=>x.market===m.market),levels:levelsBasic(top.find(x=>x.market===m.market))}));
  renderRows(rows); start();
};
el.btnHot.onclick = async ()=>{
  const tks=await fetchTicker(state.markets); if(!tks.length){ renderRows([], 'ì§€ì—°'); return; }
  updateHistory(tks);
  const rows=[];
  for(const m of state.markets){
    const st=oneMinStats(m.market); if(!st) continue;
    if(st.pricePct1m>=THRESH.pct1mUp && st.accel>=THRESH.accel){
      const tk=tks.find(x=>x.market===m.market); if(!tk) continue;
      rows.push({market:m.market,name:m.korean_name||m.english_name,ticker:tk,levels:levelsBasic(tk)});
    }
  }
  rows.sort((a,b)=>b.ticker.signed_change_rate-a.ticker.signed_change_rate);
  renderRows(rows.slice(0,20)); start();
};
el.btnFall.onclick = async ()=>{
  const tks=await fetchTicker(state.markets); if(!tks.length){ renderRows([], 'ì§€ì—°'); return; }
  updateHistory(tks);
  const rows=[];
  for(const m of state.markets){
    const st=oneMinStats(m.market); if(!st) continue;
    if(st.pricePct1m<=THRESH.pct1mDown && st.accel>=THRESH.accel){
      const tk=tks.find(x=>x.market===m.market); if(!tk) continue;
      rows.push({market:m.market,name:m.korean_name||m.english_name,ticker:tk,levels:levelsBasic(tk)});
    }
  }
  rows.sort((a,b)=>a.ticker.signed_change_rate-b.ticker.signed_change_rate);
  renderRows(rows.slice(0,20)); start();
};
// ìˆ˜ë™ ì˜ˆì—´ ë³´ê¸°(ë²„íŠ¼): ìƒë‹¨ íŒ¨ë„ê³¼ ë³„ê°œë¡œ í‘œì— ìƒì„¸ ì •ë ¬
el.btnPre.onclick = async ()=>{
  const tks=await fetchTicker(state.markets); if(!tks.length){ renderRows([], 'ì§€ì—°'); return; }
  updateHistory(tks);
  const rows=[];
  for(const m of state.markets){
    const st=oneMinStats(m.market); if(!st) continue;
    const tk=tks.find(x=>x.market===m.market); if(!tk || !tk.high_price) continue;
    const condNear=st.nearHigh<=THRESH.preNearHighPct;
    const condMove=st.pricePct1m>=THRESH.preMinMove && st.pricePct1m<=THRESH.preMaxMove;
    const condAccel=st.accel>=THRESH.preAccel;
    if(condNear&&condMove&&condAccel){
      // ìƒë‹¨ íŒ¨ë„ì—ë„ ëˆ„ì 
      upsertPreheat(m.market, st);
      rows.push({market:m.market,name:m.korean_name||m.english_name,ticker:tk,levels:levelsBasic(tk)});
    }
  }
  // í‘œì—ì„œëŠ” ì ìˆ˜ ë†’ì€ ìˆœ
  rows.sort((a,b)=>{
    const sa=preheatScore(oneMinStats(a.market)||{nearHigh:1,accel:0,pricePct1m:0});
    const sb=preheatScore(oneMinStats(b.market)||{nearHigh:1,accel:0,pricePct1m:0});
    return sb - sa;
  });
  renderRows(rows.slice(0,20));
  renderPreheatPanel(); // ìƒë‹¨ë„ ê°±ì‹ 
  start();
};

el.btnReset.onclick = ()=>{ el.q.value=''; state.lastList=state.markets.slice(0,40); start(); };
el.btn1s.onclick = ()=>{ state.pollMs=1000; start(); };
el.btn2s.onclick = ()=>{ state.pollMs=2000; start(); };
el.btn5s.onclick = ()=>{ state.pollMs=5000; start(); };
el.btnStop.onclick = ()=>{ stop(); setStatus('ì¼ì‹œì •ì§€'); };

/* -------------------- ì‹œì‘ -------------------- */
(async function init(){
  try{
    await loadMarkets();
    state.lastList=state.markets.slice(0,40);
    // ì‹œì‘ ì¦‰ì‹œ 1íšŒ ìŠ¤ìº” â†’ íŒ¨ë„ í‘œì‹œ (í•­ìƒ ì ‘ì†ì‹œ ë³´ì„)
    await scanPreheat();
    start();
  }catch(e){
    console.error(e);
    setStatus('ë§ˆì¼“ ë¡œë“œ ì‹¤íŒ¨ â€” Ctrl+F5 í›„ ì¬ì‹œë„');
  }
})();
</script>
</body>
</html>
