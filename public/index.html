<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRW 코인 검색 · 타점 · 스파크</title>
  <style>
    :root{
      --bg:#0e0f13; --panel:#16181f; --text:#e6e6e6; --muted:#9aa0ab;
      --pos:#1ec780; --neg:#ff5577; --warn:#f5a524; --chip:#1b1f2a;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial;}
    .wrap{max-width:1120px; margin:28px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 14px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    input[type=text]{background:#0c0d11; color:var(--text); border:1px solid #232634; padding:10px 12px; border-radius:10px; width:240px; outline:none;}
    button{background:#23283b; color:var(--text); border:0; padding:10px 14px; border-radius:10px; cursor:pointer}
    button.primary{background:#3856ff}
    .badge{padding:6px 10px; border-radius:999px; font-size:12px; background:var(--chip); color:#d5d8df}
    .badge.ok{background:#0f2b3d; color:#7dd3fc}
    .badge.warn{background:#3a2b12; color:#f6d28b}
    .badge.danger{background:#3a1117; color:#ffb3c2}
    .panel{background:var(--panel); border:1px solid #232634; border-radius:12px; overflow:hidden}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:12px 14px; border-bottom:1px solid #222532; text-align:left; font-size:14px}
    th{color:#aab1bc; background:#12141b; font-weight:600}
    td.val{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    .one{margin-top:10px; padding:12px 14px; border-radius:10px; background:#10131a; border:1px dashed #2a2e3d; color:#dfe4ee; font-size:14px}
    .minh{min-height: 420px;}
    .foot{margin-top:16px; color:#717786; font-size:12px}
    a{color:#7dd3fc; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KRW 코인 검색 · 타점 · 스파크</h1>

    <!-- 검색/요약 기존 기능 유지 -->
    <div class="row" style="margin-bottom:10px">
      <input id="q" type="text" placeholder="예: 비트코인, BTC, KRW-ETH" />
      <button id="btn" class="primary">검색</button>
      <span id="sys" class="badge">시스템: 대기</span>
      <span id="risk" class="badge">위험도: -</span>
      <span id="ts" class="muted" style="font-size:12px"></span>
    </div>

    <div class="panel minh" id="summary-panel">
      <table>
        <tbody id="rows">
          <tr><th>코인</th><td class="val" id="sym">-</td><td class="muted">현재가격/등락</td></tr>
          <tr><th>현재가</th><td class="val" id="price">-</td><td class="muted">매수/매도 타점 기준</td></tr>
          <tr><th>등락</th><td class="val" id="chg">-</td><td class="muted">전일 대비 등락률</td></tr>
          <tr><th>김치 프리미엄</th><td class="val" id="kimchi">-</td><td class="muted">KRW vs USD 근사</td></tr>
          <tr><th>온체인 자금흐름</th><td class="val" id="onchain">-</td><td class="muted">Stablecoin 24h 순유입/유출(샘플)</td></tr>
          <tr><th>매수</th><td class="val" id="buy">-</td><td class="muted">권장 매수가격</td></tr>
          <tr><th>매도</th><td class="val" id="sell">-</td><td class="muted">권장 매도가격</td></tr>
          <tr><th>손절</th><td class="val" id="stop">-</td><td class="muted">위험 관리 기준</td></tr>
        </tbody>
      </table>
    </div>
    <div id="one" class="one">검색해 주세요.</div>

    <!-- ⚡ 스파크 : 항시 표시 + 15초 자동 갱신 -->
    <section id="spark-section" style="margin-top:20px;">
      <h3 style="margin:0 0 10px 0; color:#1ec780;">⚡ 스파크 코인</h3>
      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>코인(한글)</th>
              <th>현재가</th>
              <th>매수</th>
              <th>매도</th>
              <th>손절</th>
              <th>위험도</th>
              <th>시간</th>
              <th>쩔어한마디</th>
            </tr>
          </thead>
          <tbody id="spark-body">
            <tr><td colspan="8" class="muted" style="padding:12px">스파크 코인 불러오는 중...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div class="foot">
      API: <a href="/api/summary?market=KRW-ETH" target="_blank">/api/summary</a> ·
      <a href="/api/spark" target="_blank">/api/spark</a>
    </div>
  </div>

<script>
/* ===== 유틸/호가단위/포맷 ===== */
const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('ko-KR');
const pct = v => `${(Number(v)||0).toFixed(2)}%`;
function tickKRW(p){
  p = Number(p)||0;
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 1;
  if(p>=100)     return 0.1;
  if(p>=10)      return 0.01;
  if(p>=1)       return 0.001;
  return 0.0001;
}
const roundTick=(v,dir='nearest')=>{
  const t=tickKRW(v); const n=v/t;
  if(dir==='up') return Math.ceil(n)*t;
  if(dir==='down') return Math.floor(n)*t;
  return Math.round(n)*t;
};
const KRW = v => (v<1? Number(v||0).toFixed(4) : fmt.format(Math.round(v)));
const looksLikeHTML = t => (t||'').trim().toLowerCase().startsWith('<');

/* ===== 상태표시 ===== */
function setSys(s){
  const el=$('#sys'); el.className='badge';
  if(s==='OK'){ el.classList.add('ok'); el.textContent='시스템: OK';}
  else if(s==='WARN'){ el.classList.add('warn'); el.textContent='시스템: 로딩';}
  else if(s==='ERR'){ el.classList.add('danger'); el.textContent='시스템: 오류';}
  else{ el.textContent='시스템: 대기';}
}
function setRiskBadge(r){
  const el=$('#risk'); el.className='badge';
  if(r==='danger'){ el.classList.add('danger'); el.textContent='위험도: 높음'; }
  else if(r==='caution'){ el.classList.add('warn'); el.textContent='위험도: 보통'; }
  else { el.classList.add('ok'); el.textContent='위험도: 낮음'; }
}

/* ===== 요약(검색) 기존 기능 ===== */
async function loadSummary(){
  if(loadSummary._busy) return; loadSummary._busy=true; setSys('WARN');
  try{
    const q = ($('#q').value||'ETH').trim().toUpperCase();
    const market = q.startsWith('KRW-') ? q : (q.length<=5? `KRW-${q}` : q);
    const res = await fetch(`/api/summary?market=${encodeURIComponent(market)}`, {cache:'no-store'});
    const text = await res.text();
    if(looksLikeHTML(text)) throw new Error('HTML_RESPONSE');
    const data = JSON.parse(text);
    if(!data.ok) throw new Error(data.error||'API 오류');

    const price = Number(data.price)||0;
    const buy  = roundTick(price*0.994,'nearest');
    const sell = roundTick(price*1.006,'nearest');
    const stop = roundTick(price*0.978,'nearest');

    $('#sym').textContent = data.symbol||market;
    $('#price').textContent = KRW(price);
    const chg = Number(data.change)||0;
    $('#chg').innerHTML = (chg>=0? `<span class="pos">+${pct(chg)}</span>`:`<span class="neg">${pct(chg)}</span>`);
    const kp = Number(data.kimchi)||0;
    $('#kimchi').innerHTML = (kp>=0? `<span class="pos">+${kp.toFixed(2)}%</span>`:`<span class="neg">${kp.toFixed(2)}%</span>`);
    $('#onchain').textContent = '-'; // 샘플 자리
    $('#buy').textContent  = KRW(buy);
    $('#sell').textContent = KRW(sell);
    $('#stop').textContent = KRW(stop);
    setRiskBadge(data.risk||'neutral');
    $('#ts').textContent = new Date().toLocaleTimeString();

    // 쩔어 한마디
    let line = '';
    if((data.risk||'')==='danger') line = '변동성 ↑ : 급등락 주의. 분할/짧은 손절 권장.';
    else if((data.risk||'')==='caution') line = '주의 구간: 거래량 확인하며 진입.';
    else line = '보통 구간: 추세 따라 분할 접근.';
    if(kp>4) line += ' 김치프리미엄 과열 주의.';
    $('#one').textContent = line || '분석 대기.';
    setSys('OK');
  }catch(e){
    setSys('ERR');
    $('#one').textContent='데이터 로드 실패. 잠시 후 재시도.';
    ['sym','price','chg','kimchi','onchain','buy','sell','stop'].forEach(id=>{$('#'+id).textContent='-';});
  }finally{ loadSummary._busy=false; }
}
$('#btn').addEventListener('click', loadSummary);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') loadSummary(); });

/* ===== 스파크(새 기능) : 한글/타점/위험도/시간/한마디 ===== */
const KOR = {
  "KRW-BTC":"비트코인","KRW-ETH":"이더리움","KRW-SHIB":"시바이누","KRW-XRP":"리플","KRW-CHZ":"칠리즈",
  "KRW-DOGE":"도지코인","KRW-AVAX":"아발란체","KRW-NEAR":"니어프로토콜","KRW-INJ":"인젝티브","KRW-CTC":"크레딧코인"
};
function riskFromRise(r){
  if(r>5) return {label:"높음", cls:"danger"};
  if(r>2) return {label:"보통", cls:"warn"};
  return {label:"낮음", cls:"ok"};
}
async function loadSpark(){
  try{
    const tbody = $('#spark-body');
    tbody.innerHTML = `<tr><td colspan="8" class="muted" style="padding:12px">불러오는 중...</td></tr>`;
    const res = await fetch('/api/spark?minRise=2&minVolRatio=3&limit=60',{cache:'no-store'});
    const text = await res.text();
    if(looksLikeHTML(text)) throw new Error('HTML_RESPONSE');
    const j = JSON.parse(text);
    if(!j.ok) throw new Error(j.error||'spark error');

    if(!j.items || !j.items.length){
      tbody.innerHTML = `<tr><td colspan="8" class="muted" style="padding:12px">현재 스파크 코인이 없습니다.</td></tr>`;
      return;
    }

    tbody.innerHTML = j.items.map(c=>{
      const price = Number(c.price)||0;
      const buy  = roundTick(price*0.985,'down');  // -1.5%
      const sell = roundTick(price*1.03,'up');     // +3%
      const stop = roundTick(price*0.97,'down');   // -3%
      const risk = riskFromRise(Number(c.rise3m)||0);
      const msg  = (c.rise3m>6) ? '급등 주의! 익절 준비.'
                  : (c.rise3m>3) ? '단타 구간, 추세 유지.' : '관망 구간, 세력 확인.';
      const name = KOR[c.market] || c.market.replace('KRW-','');
      const time = new Date(c.ts||Date.now()).toLocaleTimeString();

      return `<tr>
        <td>${name}</td>
        <td class="val">${KRW(price)}</td>
        <td class="val" style="color:#00e3b2">${KRW(buy)}</td>
        <td class="val" style="color:#ffd166">${KRW(sell)}</td>
        <td class="val" style="color:#ff6b6b">${KRW(stop)}</td>
        <td><span class="badge ${risk.cls}">위험도: ${risk.label}</span></td>
        <td class="muted">${time}</td>
        <td class="muted">${msg}</td>
      </tr>`;
    }).join('');
  }catch(e){
    $('#spark-body').innerHTML = `<tr><td colspan="8" style="padding:12px; color:#ffb3c2">스파크 로드 실패: ${e.message}</td></tr>`;
  }
}

/* ===== 초기 구동 ===== */
window.addEventListener('load', ()=>{
  // 첫 진입 기본 검색(ETH)
  $('#q').value='ETH';
  loadSummary();

  // 스파크 항시 표시 & 15초마다 갱신
  loadSpark();
  setInterval(loadSpark, 15000);
});
</script>
</body>
</html>
