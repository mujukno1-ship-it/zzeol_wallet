<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 v11.1 — No-Motion · KRW · 업비트틱</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --muted:#9aa4af; --text:#e8eef5; --accent:#68b0ff;
    --ok:#43d18b; --warn:#ffb74d; --risk:#ff6b6b; --line:#1a2230;
  }
  *{box-sizing:border-box; transition:none!important; animation:none!important}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
  .title{font-weight:700;margin:0 0 12px 0}
  .sub{color:var(--muted);font-size:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#142033;border:1px solid #1d2a3f;color:#9ec7ff;font-size:12px}
  /* 검색 */
  .search-bar{display:flex;gap:8px}
  .search-input{flex:1;height:44px;border-radius:12px;border:1px solid var(--line);background:#0c1219;color:var(--text);padding:0 14px;font-size:15px;outline:none}
  .chip{height:32px;border-radius:999px;border:1px solid var(--line);background:#0c1219;color:var(--muted);padding:0 10px;font-size:12px}
  .search-results{margin-top:10px;border:1px solid var(--line);border-radius:12px;background:#0c1219;max-height:260px;overflow:auto;width:100%}
  .sr-empty{color:var(--muted);padding:14px}
  .sr-item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-top:1px solid #0f1a26;cursor:pointer}
  .sr-item:first-child{border-top:0}
  .sr-item:hover{background:#0f1620}
  .tag{color:#8ea2b3;font-size:12px}
  /* SPARK */
  .spark-item{display:grid;grid-template-columns:1fr 82px;gap:14px;padding:10px 0;border-top:1px solid #0f1a26}
  .spark-item:first-child{border-top:0}
  .spark-name{display:flex;gap:10px;align-items:center}
  .bar{position:relative;height:8px;border-radius:8px;background:#101926;border:1px solid #122033;overflow:hidden}
  .fill{position:absolute;inset:0;width:0%}
  .fill.orange{background:#ff9d4d} .fill.red{background:#ff6b6b} .fill.yellow{background:#ffd166}
  .price{color:#cfe6ff;text-align:right}
  /* ULTRA */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1219}
  .k{color:#8ea2b3;font-size:12px;margin-bottom:4px}
  .v{font-size:16px;font-weight:700}
  .risk-1{color:#7ddf9a}.risk-2{color:#a6f0c5}.risk-3{color:#ffd166}.risk-4{color:#ff9d4d}.risk-5{color:#ff6b6b}
  .comment{min-height:78px;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0c1219}
  .mt6{margin-top:6px}.mt10{margin-top:10px}.mt16{margin-top:16px}.mt20{margin-top:20px}
  @media (max-width:820px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- 검색 -->
    <div class="card">
      <div class="title">코인 검색 (KRW 전용) — 한글명/심볼 입력</div>
      <div class="search-bar">
        <input id="search" class="search-input" placeholder="예: 이더리움 / ETH / KRW-ETH" />
        <button id="btn-krw" class="chip">KRW 기준</button>
        <button id="btn-upbit" class="chip">업비트 호가틱</button>
        <button id="btn-nomotion" class="chip">No-Motion</button>
      </div>
      <div id="sr" class="search-results" hidden></div>
      <div class="sub">연동: 업비트 마켓/스파크/ULTRA · 모든 가격 KRW, 코인명 한글 · 검색 결과는 <b>최대 5개</b></div>
    </div>

    <!-- ULTRA 시그널 (검색 바로 아래) -->
    <div class="card">
      <div class="title">ULTRA 시그널 — 선택한 코인</div>
      <div id="sparkMeta" class="sub"></div> <!-- 예열강도·예상상승률·판단 -->
      <div id="ultraTarget" class="sub">코인을 선택하면 매수/익절/손절, 위험도, 쩔어한마디가 표시됩니다.</div>

      <div class="grid2 mt10">
        <div class="kv"><div class="k">현재가</div><div id="v-price" class="v">-</div></div>
        <div class="kv"><div class="k">위험도(1~5)</div><div id="v-risk" class="v">-</div></div>
        <div class="kv"><div class="k">매수(BUY1)</div><div id="v-buy1" class="v">-</div></div>
        <div class="kv"><div class="k">매수(BUY2)</div><div id="v-buy2" class="v">-</div></div>
        <div class="kv"><div class="k">익절(TP1)</div><div id="v-tp1" class="v">-</div></div>
        <div class="kv"><div class="k">익절(TP2)</div><div id="v-tp2" class="v">-</div></div>
        <div class="kv"><div class="k">손절(SL)</div><div id="v-sl" class="v">-</div></div>
        <div class="kv"><div class="k">세력지수</div><div id="v-force" class="v">-</div></div>
      </div>

      <div class="comment mt16">
        <div class="k">쩔어한마디</div>
        <div id="v-comment" class="v" style="font-size:14px;line-height:1.55">-</div>
      </div>
    </div>

    <!-- SPARK TOP10 -->
    <div class="card">
      <div class="title">🔥 SPARK TOP10 — 급등 사전 예열 감지</div>
      <div class="sub">필터: RVOL·TBR·OBI·ATR·ForceIndex 종합 (예열 ≥ 조건 충족)</div>
      <div id="spark"></div>
    </div>
  </div>

<script>
/* ===== 기본 설정 ===== */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";
let MARKETS = []; // KRW 마켓 목록

async function safeFetch(url, opt={}){
  const res = await fetch(url, {mode:"cors", cache:"no-store", ...opt});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ===== 업비트 마켓 로드 (1회) ===== */
async function loadMarkets(){
  try{
    const data = await safeFetch(`${API_BASE}/upbit/markets`);
    MARKETS = data.filter(x => x.market?.startsWith("KRW-"));
  }catch(e){ console.error("loadMarkets", e); }
}

/* ===== 검색 ===== */
const $search = document.getElementById('search');
const $sr = document.getElementById('sr');

$search.addEventListener('input', () => {
  const q = $search.value.trim().toLowerCase();
  if(!q){ $sr.hidden = true; $sr.innerHTML = ""; return; }

  const m = MARKETS.filter(x=>{
    const s1 = (x.korean_name||"").toLowerCase();
    const s2 = (x.english_name||"").toLowerCase();
    const s3 = (x.market||"").toLowerCase();
    return s1.includes(q) || s2.includes(q) || s3.includes(q);
  }).slice(0,5); // 최대 5개

  if(m.length===0){ $sr.hidden=false; $sr.innerHTML = `<div class="sr-empty">검색 결과가 없습니다.</div>`; return; }

  $sr.hidden = false;
  $sr.innerHTML = m.map(x=>`
    <div class="sr-item" data-market="${x.market}">
      <div><b>${x.korean_name}</b> <span class="tag">(${x.market})</span></div>
      <button class="chip">선택</button>
    </div>`).join('');
});

$sr.addEventListener('click', (e)=>{
  const host = e.target.closest('.sr-item');
  if(!host) return;
  selectMarket(host.getAttribute('data-market'));
});

/* ===== SPARK 점수 → 상승률(%) 계산 & 라벨 ===== */
function expectedRiseFromScore(score, { rvol=1.0, tbr=0.5, force=50 } = {}){
  // 기본 밴드 (사토시 메모리 규칙)
  let base = score>=90 ? 20 : score>=80 ? 10 : score>=70 ? 5 : 3;
  // Precision Boost Mode 근사 보정
  if (rvol  > 1.8) base += (rvol  - 1.8) * 3;
  if (tbr   > 0.60) base += (tbr   - 0.60) * 10;
  if (force > 70)   base += (force - 70) * 0.10;
  base = Math.max(4, Math.min(25, base));
  return Math.round(base * 10) / 10;
}
function sparkLabel(score){
  if(score >= 90) return "폭발 임박🔥";
  if(score >= 80) return "강력 예열";
  if(score >= 70) return "예열";
  return "관망";
}

/* ===== SPARK TOP10 ===== */
async function loadSpark(){
  try{
    const data = await safeFetch(`${API_BASE}/spark/top10`);
    const list = (Array.isArray(data)?data:[]).slice(0,10);

    const html = list.map(row=>{
      const price = row.price != null ? Number(row.price).toLocaleString('ko-KR')+"원" : "-";
      const score = Math.max(0, Math.min(100, Math.round(Number(row.score ?? row.force_index ?? 0))));
      const w = Math.max(6, Math.min(100, score));
      const color = score>=85 ? "red" : (score>=70 ? "orange" : "yellow");

      const risePct = expectedRiseFromScore(score, {
        rvol:  Number(row.rvol ?? 1.0),
        tbr:   Number(row.tbr  ?? 0.5),
        force: Number(row.force_index ?? 50)
      });
      const label = sparkLabel(score);

      return `
        <div class="spark-item" data-market="${row.market}">
          <div class="spark-name">
            <span class="badge">SPARK ${score}%</span>
            <div>
              <div><b>${row.korean_name||row.market}</b> <span class="tag">${row.market||""}</span></div>
              <div class="bar mt6"><span class="fill ${color}" style="width:${w}%"></span></div>
              <div class="sub">예상상승률: <b>+${risePct}%</b> · AI: ${label}</div>
            </div>
          </div>
          <div class="price">${price}</div>
        </div>
      `;
    }).join('');

    const $wrap = document.getElementById('spark');
    $wrap.innerHTML = html || `<div class="sub">SPARK 데이터 없음</div>`;
    $wrap.onclick = (e)=>{
      const host = e.target.closest('.spark-item');
      if(!host) return;
      selectMarket(host.getAttribute('data-market'));
    };
  }catch(e){
    console.error("loadSpark", e);
    document.getElementById('spark').innerHTML = `<div class="sub">연동 실패</div>`;
  }
}

/* ===== 업비트 호가틱 반올림 (간단 근사) ===== */
function roundTick(p){
  p = Number(p)||0;
  if(p < 10) return Math.round(p*100)/100;
  if(p < 100) return Math.round(p*10)/10;
  if(p < 1000) return Math.round(p);
  if(p < 10000) return Math.round(p/5)*5;
  if(p < 100000) return Math.round(p/10)*10;
  return Math.round(p/50)*50;
}
function fmtKRW(n){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString('ko-KR')+'원'; }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = (v ?? '-'); }
function clamp(a,b,x){ return Math.max(a, Math.min(b, x)); }

/* ===== ULTRA 시그널 ===== */
async function selectMarket(market){
  try{
    document.getElementById('ultraTarget').textContent = `${market} 분석 불러오는 중…`;
    const data = await safeFetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);

    const P = Number(data.price||0); // 현재가

    // SPARK_SCORE 근사 (서버가 score/force_index 제공 시 사용)
    const scoreApprox =
      (data.score!=null) ? Number(data.score) :
      (data.force_index!=null) ? Math.max(0, Math.min(100, Math.round(Number(data.force_index)))) : 0;

    // 예열 강도 기반 예상 상승률(%)
    const risePct = expectedRiseFromScore(scoreApprox, {
      rvol:  Number(data.rvol ?? 1.0),
      tbr:   Number(data.tbr  ?? 0.5),
      force: Number(data.force_index ?? 50)
    });
    const label = sparkLabel(scoreApprox);

    // 표기
    const $meta = document.getElementById('sparkMeta');
    $meta.textContent = `SPARK_SCORE: ${scoreApprox}% (${label}) · 예상상승률: +${risePct}% · AI 판단 반영`;

    // AI가 준 up/down %가 있으면 사용, 없으면 예열기반 보정 사용
    const upP = Number((data.up_pct ?? data.upProb ?? risePct) || 0);
    const dnP = Number((data.down_pct ?? data.downProb) || Math.max(3, risePct*0.4));

    // BUY/TP/SL 계산 (사토시 메모리 규칙: 분석 퍼센트 기반 + 호가틱 반올림)
    const buy1 = roundTick(P * (1 - Math.min(0.004, dnP/100/2))); // 살짝 당김(최대 0.4%)
    const buy2 = roundTick(P * (1 - Math.min(0.010, dnP/100)));   // 더 당김
    const tp1  = roundTick(P * (1 + Math.max(0.005, upP/100*0.6)));
    const tp2  = roundTick(P * (1 + Math.max(0.010, upP/100)));
    const sl   = roundTick(P * (1 - Math.max(0.006, dnP/100)));

    const risk = clamp(1,5, Math.round((Number(data.risk)||0) || (dnP/4) || 3));
    const force = Number(data.force_index||data.force||0);

    // 모드 (불장/하락/되돌림)
    const mode = ((data.rvol||0) >= 2.0 && (data.tbr||0) >= 0.65 && force >= 80) ? "bull"
               : ((data.tbr||0) <= 0.45 || force <= 35) ? "bear" : "retrace";

    // UI 세팅
    document.getElementById('ultraTarget').textContent = `${(data.korean_name || market)} (${market})`;
    setText('v-price', fmtKRW(P));
    const $risk = document.getElementById('v-risk'); $risk.className = 'v risk-'+risk; $risk.textContent = risk;
    setText('v-buy1', fmtKRW(buy1));
    setText('v-buy2', fmtKRW(buy2));
    setText('v-tp1',  fmtKRW(tp1));
    setText('v-tp2',  fmtKRW(tp2));
    setText('v-sl',   fmtKRW(sl));
    setText('v-force', force.toFixed(0));

    // 쩔어한마디
    document.getElementById('v-comment').textContent = makeComment({
      base:P, upProb:upP, downProb:dnP, rvol:Number(data.rvol||0), tbr:Number(data.tbr||0),
      force:Number(force||0), aboveVWAP: !!data.above_vwap, mode
    });

  }catch(e){
    console.error("selectMarket", e);
    document.getElementById('ultraTarget').textContent = `연동 실패 — ${market}`;
    document.getElementById('sparkMeta').textContent = "";
  }
}

/* ===== 쩔어한마디 ===== */
function makeComment({base,upProb,downProb,rvol,tbr,force,aboveVWAP,mode}){
  if(mode==='bull'){
    return `불장 신호🔥 — RVOL ${rvol.toFixed(2)}, 체결강도 ${tbr.toFixed(2)}, 세력지수 ${force}.
익절은 늦추고(TP2 우선) 분할매수 유지. 과열구간 주의.`;
  }
  if(mode==='bear'){
    return `하락장 경계⚠️ — 체결 약세(TBR ${tbr.toFixed(2)}), 세력지수 ${force}.
추가 진입 금지, 손절 강화(SL 우선), 시간 제한 청산 권장.`;
  }
  const bias = aboveVWAP ? "VWAP 상단" : "VWAP 하단";
  return `되돌림 관찰↔️ — ${bias}, RVOL ${rvol.toFixed(2)}.
예상 상승 +${(+upProb).toFixed(1)}%, 하락 −${(+downProb).toFixed(1)}% 기준으로 분할매수/분할익절 운영.`;
}

/* ===== 초기 구동 ===== */
(async function init(){
  await loadMarkets();
  loadSpark();
  // 주기 갱신(스파크 30초) — 화면 깜빡임 없음
  setInterval(loadSpark, 30000);
})();
</script>
<script>
/* ============================== *
 *  Upbit KRW Tick & Rounding Kit
 *  — paste above </body>
 * ============================== */

// 업비트 KRW 호가 단위 테이블
function getTickSizeKRW(p) {
  const price = Number(p);
  if (price >= 2_000_000) return 1000;
  if (price >= 1_000_000) return 500;
  if (price >= 500_000)  return 100;
  if (price >= 100_000)  return 50;
  if (price >= 10_000)   return 10;
  if (price >= 1_000)    return 1;
  if (price >= 100)      return 0.1;
  if (price >= 10)       return 0.01;
  if (price >= 1)        return 0.001;   // SHIB 같은 저가 코인
  return 0.0001;
}

// 틱단위 기준 반올림(기본: 최근접), 올림/내림 지원
function roundTick(p, mode = "nearest") {
  const price = Number(p);
  const tick = getTickSizeKRW(price);
  const n = price / tick;

  let q;
  if (mode === "up")      q = Math.ceil(n);
  else if (mode === "down") q = Math.floor(n);
  else                    q = Math.round(n);

  const v = q * tick;

  // 소수점 자릿수는 tick에 맞게 자동 지정
  const decimals = (tick.toString().split(".")[1] || "").length;
  return Number(v.toFixed(decimals));
}

// KRW 포맷 (틱에 맞춰 자릿수 유지)
function formatKRW(p) {
  const price = Number(p);
  const tick = getTickSizeKRW(price);
  const decimals = (tick.toString().split(".")[1] || "").length;
  return price.toLocaleString("ko-KR", {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }) + "원";
}

/* ------------------------------
 *  한 번에 값들 전부 보정하는 훅
 *  사용예:
 *    const out = applyUpbitTicks({
 *      current: cur, buy1: b1, buy2: b2, tp1, tp2, sl
 *    });
 *    // out.buy1Formatted 처럼 사용해서 UI 갱신
 * ------------------------------ */
function applyUpbitTicks(levels) {
  const out = {};
  const keys = ["current","buy1","buy2","tp1","tp2","sl"];
  keys.forEach(k => {
    if (levels[k] == null || levels[k] === "") return;
    // 매수/익절은 최근접, 손절은 안전하게 내림 적용(원하면 'down'을 'nearest'로 바꿔도 됨)
    const mode = (k === "sl") ? "down" : "nearest";
    const v    = roundTick(levels[k], mode);
    out[k] = v;
    out[k + "Formatted"] = formatKRW(v);
  });
  return out;
}

/* ------------------------------
 *  ✅ 기존 코드에 연결하는 최소 가이드
 *  - 지금까지 계산된 숫자(buy1, tp1, sl 등)를
 *    마지막 표시 직전에 applyUpbitTicks에 넣고
 *    반환값으로 UI를 업데이트하면 끝.
 *
 *  예시:
 *    // 기존 계산 결과 (예: AI 분석 결과)
 *    const cur = 0.01523;   // 현재가
 *    const b1  = 0.0108;    // 매수1
 *    const b2  = 0.01095;   // 매수2
 *    const t1  = 0.0197;    // 익절1
 *    const t2  = 0.0212;    // 익절2
 *    const sL  = 0.00949;   // 손절
 *
 *    const fixed = applyUpbitTicks({
 *      current: cur, buy1: b1, buy2: b2, tp1: t1, tp2: t2, sl: sL
 *    });
 *
 *    // UI 바인딩(예: innerText)
 *    $('#cur').innerText  = fixed.currentFormatted;
 *    $('#buy1').innerText = fixed.buy1Formatted;
 *    $('#buy2').innerText = fixed.buy2Formatted;
 *    $('#tp1').innerText  = fixed.tp1Formatted;
 *    $('#tp2').innerText  = fixed.tp2Formatted;
 *    $('#sl').innerText   = fixed.slFormatted;
 * ------------------------------ */
</script>  
  <script>
/* ===== Upbit KRW Tick Enforcer (Display-level) ===== */

// KRW 호가틱
function getTickSizeKRW(p){
  const x = Number(p);
  if (x >= 2_000_000) return 1000;
  if (x >= 1_000_000) return 500;
  if (x >= 500_000)  return 100;
  if (x >= 100_000)  return 50;
  if (x >= 10_000)   return 10;
  if (x >= 1_000)    return 1;
  if (x >= 100)      return 0.1;
  if (x >= 10)       return 0.01;
  if (x >= 1)        return 0.001;
  return 0.0001;
}
function roundTick(p, mode="nearest"){
  const price = Number(p);
  const tick  = getTickSizeKRW(price);
  const n = price / tick;
  let q = mode==="up" ? Math.ceil(n) : mode==="down" ? Math.floor(n) : Math.round(n);
  const v = q * tick;
  const d = (tick.toString().split(".")[1] || "").length;
  return Number(v.toFixed(d));
}
function formatKRW(p){
  const price = Number(p);
  const tick  = getTickSizeKRW(price);
  const d = (tick.toString().split(".")[1] || "").length;
  return price.toLocaleString("ko-KR",{minimumFractionDigits:d,maximumFractionDigits:d}) + "원";
}

/* 핵심: 화면상의 모든 가격 엘리먼트를 주기적으로 틱 보정
   - 가격 표시 엘리먼트에 class="upbit-price" 를 달아줘.
   - 가능한 경우 data-value(원시 숫자)를 함께 넣어주면 정확도↑
   - 손절은 안전하게 내림, 나머지는 최근접 반올림
*/
function enforceUpbitTicks(){
  document.querySelectorAll(".upbit-price").forEach(el=>{
    // 원시값 우선: data-value > data-raw > 텍스트 숫자 추출
    let raw = el.getAttribute("data-value")
            ?? el.getAttribute("data-raw")
            ?? (el.textContent||"").replace(/[^\d.\-]/g,"");
    if(raw==="" || isNaN(raw)) return;

    const isSL = el.classList.contains("is-sl"); // 손절 표시엔 이 클래스 추가
    const v = roundTick(raw, isSL ? "down" : "nearest");
    el.setAttribute("data-value", v);
    el.textContent = formatKRW(v);
  });
}
enforceUpbitTicks();
setInterval(enforceUpbitTicks, 400); // 갱신 루프(가벼움)

/* 디버그 도우미: 콘솔에서 확인용
   window.testTick(0.01523) 같은 식으로 체크 */
window.testTick = (x)=>({in:x, tick:getTickSizeKRW(x), out:roundTick(x), fmt:formatKRW(roundTick(x))});
</script>
</body>
</html>
