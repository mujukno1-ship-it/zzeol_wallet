<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 v12 — KRW 실시간</title>
<style>
  :root{
    --bg:#0e1116; --panel:#151a21; --muted:#8a94a6; --text:#e7edf5; --accent:#5ac8fa; --danger:#ff6b6b; --ok:#7ee081; --warn:#ffd166;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,apple-system,Segoe UI,Roboto,Pretendard,Helvetica,Arial}
  .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
  .row{display:grid;gap:16px}
  .panel{background:var(--panel);border-radius:var(--radius);border:1px solid #1e2530;padding:16px}
  .title{margin:0 0 10px;font-weight:700;font-size:16px}
  .sub{color:var(--muted);font-size:12px}
  .k-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){.k-row{grid-template-columns:1fr}}
  .search{display:flex;gap:8px;align-items:center}
  .search input{
    flex:1;height:44px;border-radius:12px;border:1px solid #222a35;background:#0f141b;color:var(--text);padding:0 14px;font-size:16px}
  .chip{height:28px;padding:0 10px;border-radius:999px;background:#101722;border:1px solid #1e2430;color:#bcd;display:inline-flex;align-items:center;gap:6px}
  .list{display:grid;gap:8px}
  .li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #1f2732;background:#0f141b}
  .btn{cursor:pointer;user-select:none;border:1px solid #2b3646;background:#131a24;color:#d6e3f5;border-radius:10px;height:32px;padding:0 10px}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #253243;background:#0f1721;color:#cbd6e6}
  .green{color:var(--ok)} .red{color:var(--danger)} .yellow{color:var(--warn)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:4px 0}
  .val{font-weight:700}
  hr{border:none;height:1px;background:#1b2330;margin:10px 0}
  .right{justify-self:end}
  .small{font-size:12px;color:#aab6c8}
  /* No-Motion: 애니/트랜지션 전부 제거 */
  *, *:before, *:after {transition:none !important; animation:none !important}
</style>
</head>
<body>
<div class="wrap">
  <!-- 검색 (상단 고정, 결과 5개 제한, No-Motion) -->
  <div class="panel">
    <div class="search">
      <input id="q" placeholder="코인 이름 또는 심볼 입력… (KRW 전용)" autocomplete="off" />
      <button id="btnKRW" class="btn chip">KRW 기준</button>
      <button id="btnNoMotion" class="btn chip">No-Motion</button>
    </div>
    <div id="searchBox" class="list" style="margin-top:10px"></div>
    <div class="small">검색 결과는 입력 시 표시 (최대 5개). 결과/화면 깜빡임 없이 갱신됩니다.</div>
  </div>

  <div class="row">
    <!-- ULTRA: 선택 코인 타점/멘트 -->
    <div class="panel">
      <h3 class="title">⚡ ULTRA 시그널 — 선택한 코인 <span id="ultraMarket" class="pill"></span></h3>
      <div id="ultraEmpty" class="small">코인을 선택하면 매수·매도·손절 타점이 표시됩니다.</div>
      <div id="ultra" style="display:none">
        <div class="k-row">
          <div>
            <div class="kv"><div>현재가</div><div class="val" id="now"></div></div>
            <div class="kv"><div>위험도</div><div id="risk"></div></div>
            <div class="kv"><div>예상상승률</div><div id="rise"></div></div>
            <div class="kv"><div>예상하락률</div><div id="fall"></div></div>
          </div>
          <div>
            <div class="kv"><div>매수(BUY1)</div><div class="val" id="buy1"></div></div>
            <div class="kv"><div>매수(BUY2)</div><div class="val" id="buy2"></div></div>
            <div class="kv"><div>익절(TP1 / TP2)</div><div class="val" id="tp"></div></div>
            <div class="kv"><div>손절(SL)</div><div class="val red" id="sl"></div></div>
          </div>
        </div>
        <hr/>
        <div class="kv">
          <div>쩔어한마디</div>
          <div id="ment" class="small"></div>
        </div>
      </div>
    </div>

    <!-- SPARK: 급등 사전 예열 감지 (TOP10 상시노출) -->
    <div class="panel">
      <h3 class="title">🔥 SPARK TOP10 — 급등 사전 예열 감지</h3>
      <div class="small">필터: RVOL·TBR·OBI·ForceIndex 종합, 5분변동 ≥ +1.5% (4개↑ 예열 확정). 클릭 시 ULTRA로 연동.</div>
      <div id="spark" class="list" style="margin-top:10px"></div>
      <div id="sparkEmpty" class="small">SPARK 데이터 없음.</div>
    </div>
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // 헬스: /health
const ENDPOINTS = {
  markets: API_BASE + "/upbit/markets",     // KRW 마켓 + 한글명
  spark:   API_BASE + "/spark/top10",       // SPARK TOP10
  ultra:   API_BASE + "/ultra/signal"       // ?market=KRW-XXX
};

// KRW 가격 호가틱(업비트 규칙) 반올림
function roundUpbitKRW(p){
  p = Number(p);
  const abs = Math.abs(p);
  let tick = 1;
  if (abs >= 2_000_000) tick = 1000;
  else if (abs >= 1_000_000) tick = 500;
  else if (abs >= 500_000) tick = 100;
  else if (abs >= 100_000) tick = 50;
  else if (abs >= 10_000) tick = 10;
  else if (abs >= 1_000) tick = 5;
  else if (abs >= 100) tick = 1;
  else if (abs >= 10) tick = 0.1;
  else tick = 0.01;
  return Math.round(p / tick) * tick;
}
function fmtKRW(n){
  // 0.01 단위까지 표시
  const fixed = (n < 10 ? 2 : 0);
  const s = (fixed ? n.toFixed(2) : Math.round(n).toString());
  return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "원";
}
function pct(n, sign=true){ const v = (n===null||n===undefined)?0:n; return (sign&&v>0?"+":"") + v.toFixed(1) + "%"; }

// No-Motion: DOM 교체 없이 텍스트만 갱신
function setText(el, v){ if(el && el.textContent !== v) el.textContent = v; }
function setHTML(el, v){ if(el && el.innerHTML !== v) el.innerHTML = v; }

// 상태
let KRW_MARKETS = []; // {market:"KRW-ETH", korean_name:"이더리움", ...}
let LAST_SPARK = [];
let currentMarket = null;

// 공통 fetch (CORS/에러 안전)
async function jget(url){
  const r = await fetch(url, {mode:'cors',cache:'no-cache'});
  if(!r.ok){ throw new Error("HTTP " + r.status); }
  return r.json();
}

/** ====== 초기 로드 ====== **/
init();
async function init(){
  try{
    await loadMarkets();
    wireSearch();
    await loadSpark();
  }catch(e){
    console.error(e);
    setHTML(document.getElementById('spark'), "");
    setText(document.getElementById('sparkEmpty'), "연동 실패: " + (e?.message||e));
  }
}

/** ====== 마켓 목록 ====== **/
async function loadMarkets(){
  const js = await jget(ENDPOINTS.markets);
  // KRW 전용 + 한글명 보유
  KRW_MARKETS = (js || []).filter(x=> String(x.market||"").startsWith("KRW-"));
}

/** ====== SPARK ====== **/
async function loadSpark(){
  const box = document.getElementById('spark');
  const empty = document.getElementById('sparkEmpty');
  setHTML(box, ""); setText(empty, "불러오는 중…");

  let data;
  try{
    data = await jget(ENDPOINTS.spark);
  }catch(e){
    setText(empty, "SPARK 불러오기 실패: " + (e?.message||e));
    return;
  }
  LAST_SPARK = Array.isArray(data)? data : (data.items || []);

  if(!LAST_SPARK.length){ setText(empty, "SPARK 데이터 없음."); return; }
  setText(empty, "");

  // 렌더 (TOP10)
  const frag = document.createDocumentFragment();
  LAST_SPARK.slice(0,10).forEach(item=>{
    const li = document.createElement('div'); li.className = 'li';
    const left = document.createElement('div');
    const right = document.createElement('div'); right.className='right small';

    const name = (item.korean_name || item.market || "").replace("KRW-","");
    const price = Number(item.price||0);
    const score = Number(item.spark_score||item.force_index||0);
    const prob = item.prob || item.prob_up || null; // 있을 때만
    const badge = document.createElement('span'); badge.className='pill';
    const label = (score>=90 ? "폭발 임박" : score>=80 ? "강력 예열" : score>=70 ? "예열" : "관망");
    badge.textContent = `${label} • ${score|0}점`;

    left.innerHTML = `<b>${name}</b> <span class="small">(${item.market})</span><br/><span class="small">${fmtKRW(price)}</span> `;
    left.appendChild(badge);

    const b = document.createElement('button'); b.className='btn'; b.textContent='선택';
    b.onclick = ()=>selectMarket(item.market);

    if (prob!=null){
      right.textContent = `상승확률 ${pct(Number(prob),false)}`;
    }

    li.append(left,right,b);
    frag.append(li);
  });
  box.appendChild(frag);
}

/** ====== ULTRA ====== **/
async function selectMarket(market){
  currentMarket = market;
  setText(document.getElementById('ultraMarket'), market || "");
  setDisplay('ultraEmpty', false); setDisplay('ultra', true);

  try{
    const js = await jget(ENDPOINTS.ultra + "?market=" + encodeURIComponent(market));
    renderUltraFromAPI(js);
  }catch(e){
    // API가 퍼센트 제공 안할 때: 기본 안전 계산 (예열/리스크에 따라)
    console.warn("ULTRA 연동 실패, 안전 계산으로 대체:", e?.message||e);
    fallbackUltra(market);
  }
}
function setDisplay(id, show){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = show? '' : 'none';
}
function renderUltraFromAPI(js){
  const m = document.getElementById('ultraMarket');
  const now = Number(js?.price ?? js?.now ?? 0);
  const rUp = Number(js?.expected_rise ?? js?.rise ?? 0);     // %
  const rDn = Number(js?.expected_fall ?? js?.fall ?? 0);     // %
  const risk = Number(js?.risk ?? js?.risk_level ?? 3);

  // 호가틱 반영 계산
  const BUY1 = roundUpbitKRW(js?.buy1 ?? now * (1 - Math.max(rDn,1)/100 * 0.5));
  const BUY2 = roundUpbitKRW(js?.buy2 ?? now * (1 - Math.max(rDn,1)/100));
  const TP1  = roundUpbitKRW(js?.tp1  ?? now * (1 + Math.max(rUp,1)/100 * 0.6));
  const TP2  = roundUpbitKRW(js?.tp2  ?? now * (1 + Math.max(rUp,1)/100));
  const SL   = roundUpbitKRW(js?.sl   ?? now * (1 - Math.max(rDn,1)/100 * 0.7));

  setText(document.getElementById('now'), fmtKRW(now));
  setText(document.getElementById('risk'), `레벨 ${risk}`);
  setText(document.getElementById('rise'), pct(rUp));
  setText(document.getElementById('fall'), pct(rDn,false).replace("-","") + "↓");

  setText(document.getElementById('buy1'), fmtKRW(BUY1));
  setText(document.getElementById('buy2'), fmtKRW(BUY2));
  setText(document.getElementById('tp'),   `${fmtKRW(TP1)} / ${fmtKRW(TP2)}`);
  setText(document.getElementById('sl'),   fmtKRW(SL));

  // 쩔어멘트 (분석형)
  const mode = js?.mode || (rUp>=15? "불장" : (rDn>=8? "하락" : "조정"));
  const spark = Number(js?.spark_score ?? 0);
  const fi = Number(js?.force_index ?? 0);
  const prob = Number(js?.prob_up ?? js?.prob ?? 0);
  const msg = buildMent(mode, spark, prob, rUp, rDn, fi);
  setText(document.getElementById('ment'), msg);
}
function fallbackUltra(market){
  // SPARK/마켓 가격을 이용한 보수적 계산
  const s = LAST_SPARK.find(x=>x.market===market) || {};
  const now = Number(s.price||0);
  const score = Number(s.spark_score||0);

  const estUp = score>=90 ? 18 : score>=80 ? 11 : score>=70 ? 6 : 3;
  const estDn = score>=90 ? 6  : score>=80 ? 8  : score>=70 ? 7 : 5;
  const risk  = score>=90 ? 3  : score>=80 ? 2  : score>=70 ? 2 : 1;

  const BUY1 = roundUpbitKRW(now * (1 - estDn/100 * 0.5));
  const BUY2 = roundUpbitKRW(now * (1 - estDn/100));
  const TP1  = roundUpbitKRW(now * (1 + estUp/100 * 0.6));
  const TP2  = roundUpbitKRW(now * (1 + estUp/100));
  const SL   = roundUpbitKRW(now * (1 - estDn/100 * 0.7));

  setText(document.getElementById('now'), fmtKRW(now));
  setText(document.getElementById('risk'), `레벨 ${risk}`);
  setText(document.getElementById('rise'), pct(estUp));
  setText(document.getElementById('fall'), pct(estDn,false).replace("-","") + "↓");
  setText(document.getElementById('buy1'), fmtKRW(BUY1));
  setText(document.getElementById('buy2'), fmtKRW(BUY2));
  setText(document.getElementById('tp'),   `${fmtKRW(TP1)} / ${fmtKRW(TP2)}`);
  setText(document.getElementById('sl'),   fmtKRW(SL));

  const ment = buildMent(score>=80?"불장":score>=70?"예열":"조정", score, (60+score/2), estUp, estDn, score);
  setText(document.getElementById('ment'), ment);
}

/** ====== 쩔어 멘트 생성 (분석형) ====== **/
function buildMent(mode, sparkScore, probUp, risePct, fallPct, forceIdx){
  const parts = [];
  const tag = (t)=>`【${t}】`;
  parts.push(mode==="불장" ? tag("🔥 불장") : mode==="하락" ? tag("⚠ 하락") : tag("↔ 조정"));
  if (sparkScore) parts.push(`예열강도 ${sparkScore|0}`);
  if (probUp) parts.push(`상승확률 ${pct(Number(probUp),false)}`);
  if (risePct) parts.push(`예상상승률 ${pct(Number(risePct),false)}`);
  if (fallPct) parts.push(`예상하락률 ${pct(Number(fallPct),false)}`);
  if (forceIdx) parts.push(`세력지수 ${forceIdx|0}`);

  // 행동 권고
  let action = "";
  if(mode==="불장"){ action = "익절 지연·분할홀딩, SL 완화. 눌림 시 BUY2 고려."; }
  else if(mode==="하락"){ action = "추가진입 금지, 타임아웃 청산/트레일링 강화."; }
  else { action = "되돌림 시 분할진입, POC/VWAP 재테스트 확인 후 대응."; }

  return parts.join(" / ") + " — " + action;
}

/** ====== 검색: 입력 시 5개 제한, 결과 폭=검색박스 폭 ====== **/
function wireSearch(){
  const q = document.getElementById('q');
  const box = document.getElementById('searchBox');
  q.addEventListener('input', ()=>{
    const s = (q.value||"").trim();
    box.innerHTML = "";
    if(!s){ return; }
    const low = s.toLowerCase();
    const m = KRW_MARKETS.filter(x=>{
      return x.korean_name?.toLowerCase().includes(low) || x.market?.toLowerCase().includes(low);
    }).slice(0,5);
    m.forEach(row=>{
      const li = document.createElement('div'); li.className='li';
      const left = document.createElement('div');
      const right = document.createElement('div'); right.className='right small';
      left.innerHTML = `<b>${row.korean_name}</b> <span class="small">(${row.market})</span>`;
      right.textContent = "선택 시 타점 표시";
      const b = document.createElement('button'); b.className='btn'; b.textContent='선택';
      b.onclick = ()=>{ selectMarket(row.market); q.blur(); };
      li.append(left,right,b); box.appendChild(li);
    });
  });
}

// 유틸 버튼(보기용)
document.getElementById('btnKRW').onclick = ()=>alert("KRW 기준 / 업비트 호가틱 / 한글 코인명 — 이미 적용됨");
document.getElementById('btnNoMotion').onclick = ()=>alert("No-Motion 모드 — 모든 애니/트랜지션 비활성화");

</script>
  <script>
/* ▼▼ 추가: 어떤 형식이 와도 배열로 바꿔주는 유틸 */
function asArr(x){
  if (Array.isArray(x)) return x;
  if (x && Array.isArray(x.items)) return x.items;      // {items:[...]}
  if (x && Array.isArray(x.data))  return x.data;       // {data:[...]}
  if (x && typeof x === 'object') {
    // { "KRW-BTC": {...}, "KRW-ETH": {...} } 형태도 대응
    const vals = Object.values(x).filter(v=>v!=null);
    // 값들이 배열 한 겹 더 들어있는 경우 [ [...], [...]]
    if (vals.length && Array.isArray(vals[0])) return vals.flat();
    return vals;
  }
  return [];
}

/* ▼▼ 공통 fetch (그대로, 단 ok:false 처리만 추가) */
async function jget(url){
  const r = await fetch(url, {mode:'cors',cache:'no-cache'});
  const js = await r.json().catch(()=>null);
  if (!r.ok) throw new Error("HTTP " + r.status);
  if (js && js.ok === false) throw new Error(js.error || "API ok:false");
  return js;
}

/* ▼▼ 마켓 목록 로더 — 응답을 배열로 정규화 */
async function loadMarkets(){
  const js = await jget(ENDPOINTS.markets);
  const arr = asArr(js);
  // 일부 엔드포인트가 {market, korean_name}가 아닌 경우 키 맞춤
  KRW_MARKETS = arr
    .map(x=>{
      // 표준키 보정
      const market = x.market || x.code || x.ticker || "";
      const korean = x.korean_name || x.korName || x.name_kr || x.name || "";
      return { market, korean_name: korean };
    })
    .filter(x => String(x.market||"").startsWith("KRW-"));
}

/* ▼▼ SPARK 로더 — 응답을 배열로 정규화 + 에러 출력 */
async function loadSpark(){
  const box = document.getElementById('spark');
  const empty = document.getElementById('sparkEmpty');
  setHTML(box, ""); setText(empty, "불러오는 중…");
  let data;
  try{
    const js = await jget(ENDPOINTS.spark);
    data = asArr(js);
  }catch(e){
    setText(empty, "SPARK 불러오기 실패: " + (e?.message||e));
    return;
  }
  LAST_SPARK = data.map(it=>{
    return {
      market: it.market || it.code || it.ticker || "",
      korean_name: it.korean_name || it.korName || it.name_kr || it.name || "",
      price: Number(it.price ?? it.now ?? it.last ?? 0),
      spark_score: Number(it.spark_score ?? it.score ?? it.force_index ?? 0),
      prob_up: it.prob_up ?? it.prob ?? null,
      force_index: Number(it.force_index ?? 0)
    };
  }).filter(x=>x.market.startsWith("KRW-"));

  if(!LAST_SPARK.length){ setText(empty, "SPARK 데이터 없음."); return; }
  setText(empty, "");
  const frag = document.createDocumentFragment();
  LAST_SPARK.slice(0,10).forEach(item=>{
    const li = document.createElement('div'); li.className = 'li';
    const left = document.createElement('div');
    const right = document.createElement('div'); right.className='right small';

    const name = (item.korean_name || item.market || "").replace("KRW-","");
    const price = Number(item.price||0);
    const score = Number(item.spark_score||item.force_index||0);
    const prob = item.prob_up ?? null;

    const badge = document.createElement('span'); badge.className='pill';
    const label = (score>=90 ? "폭발 임박" : score>=80 ? "강력 예열" : score>=70 ? "예열" : "관망");
    badge.textContent = `${label} • ${score|0}점`;

    left.innerHTML = `<b>${name}</b> <span class="small">(${item.market})</span><br/><span class="small">${fmtKRW(price)}</span> `;
    left.appendChild(badge);

    const b = document.createElement('button'); b.className='btn'; b.textContent='선택';
    b.onclick = ()=>selectMarket(item.market);

    if (prob!=null){ right.textContent = `상승확률 ${pct(Number(prob),false)}`; }

    li.append(left,right,b);
    frag.append(li);
  });
  box.appendChild(frag);
}

/* ▼▼ ULTRA 선택 — ok:false/비정형 응답 대비 */
async function selectMarket(market){
  currentMarket = market;
  setText(document.getElementById('ultraMarket'), market || "");
  setDisplay('ultraEmpty', false); setDisplay('ultra', true);
  try{
    const raw = await jget(ENDPOINTS.ultra + "?market=" + encodeURIComponent(market));
    // 일부 워커가 {data:{...}}로 줄 수도 있어 풀어주기
    const js = raw?.data || raw;
    renderUltraFromAPI(js);
  }catch(e){
    console.warn("ULTRA 연동 실패, 안전 계산으로 대체:", e?.message||e);
    fallbackUltra(market);
  }
}
</script>
<script>
/* 사토시 핫픽스 v1 — API 베이스 + 배열 가드 + 에러 안전화 */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";

/* 안전 파서: API 응답이 배열/객체 어떤 형태여도 프론트가 절대 안터지도록 */
function toArray(x) {
  if (Array.isArray(x)) return x;
  if (x && Array.isArray(x.items)) return x.items;
  return [];
}

/* 업비트 마켓 불러오기 (검색용) */
async function loadMarkets() {
  try {
    const r = await fetch(`${API_BASE}/upbit/markets`, { cache: "no-store" });
    const js = await r.json();
    const list = toArray(js);
    // TODO: 기존 검색 렌더 함수로 연결 (아래 예시는 이벤트 발생용 훅)
    window.__UPBIT_MARKETS__ = list;
    document.dispatchEvent(new CustomEvent("markets:loaded", { detail: list }));
  } catch (e) {
    console.error("loadMarkets error", e);
    window.__UPBIT_MARKETS__ = [];
  }
}

/* SPARK TOP10 로드 (없으면 빈배열) */
async function loadSpark() {
  try {
    const r = await fetch(`${API_BASE}/spark/top10`, { cache: "no-store" });
    const js = await r.json();
    const list = toArray(js);
    document.dispatchEvent(new CustomEvent("spark:loaded", { detail: list }));
  } catch (e) {
    console.error("loadSpark error", e);
    document.dispatchEvent(new CustomEvent("spark:loaded", { detail: [] }));
  }
}

/* 특정 코인 선택 시 ULTRA 신호 로드 (시장 파라미터는 KRW-XXX) */
async function loadUltra(market) {
  if (!market) return;
  try {
    const r = await fetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`, { cache: "no-store" });
    const js = await r.json();
    document.dispatchEvent(new CustomEvent("ultra:loaded", { detail: js }));
  } catch (e) {
    console.error("loadUltra error", e);
    document.dispatchEvent(new CustomEvent("ultra:loaded", { detail: { ok:false, error:String(e) } }));
  }
}

/* 페이지 초기 구동 */
(async function initSatoshiHotfix(){
  // 기존 init 전에 먼저 불러서 데이터 보장
  await Promise.all([loadMarkets(), loadSpark()]);
  // 기존 코드에서 선택 이벤트 발생 시, 아래 함수를 호출만 해주면 됨:
  // loadUltra("KRW-BTC")
})();
</script>
 window.API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";
<script>
(async function () {
  // --- 엘리먼트 훅 (ID는 실제 페이지에 맞게 조정) ---
  const $input = document.querySelector('input[type="search"], #search, [data-id="search"]') 
              || document.querySelector('input'); // 안전훅
  const $resultBox = document.querySelector('#search-results') 
                  || createResultBox();
  const $ultraBox  = document.querySelector('#ultra-panel') 
                  || document.querySelector('[data-ultra]') 
                  || createUltraBox();

  // 검색결과 박스가 없으면 만들어서 붙인다
  function createResultBox(){
    const div = document.createElement('div');
    div.id = 'search-results';
    div.style.marginTop = '8px';
    div.style.background = 'rgba(255,255,255,0.03)';
    div.style.border = '1px solid rgba(255,255,255,0.08)';
    div.style.borderRadius = '10px';
    div.style.padding = '8px';
    div.style.maxHeight = '220px';
    div.style.overflowY = 'auto';
    $input.parentNode.insertAdjacentElement('afterend', div);
    return div;
  }

  // ULTRA 패널이 없으면 간단 박스 생성 (기존 패널 있으면 생략됨)
  function createUltraBox(){
    const div = document.createElement('div');
    div.id = 'ultra-panel';
    div.style.marginTop = '16px';
    div.style.padding = '12px';
    div.style.borderRadius = '12px';
    div.style.background = 'rgba(255,255,255,0.03)';
    div.style.border = '1px solid rgba(255,255,255,0.08)';
    $resultBox.insertAdjacentElement('afterend', div);
    div.innerHTML = `<b>ULTRA 시그널 — 선택한 코인</b><div style="opacity:.7">코인을 선택하면 매수·익절·손절(스켈레톤)이 표시됩니다.</div>`;
    return div;
  }

  // --- 마켓 로딩 (5분 캐시) ---
  let markets = [];
  async function loadMarkets() {
    try {
      const r = await fetch(API_BASE + "/api/upbit/markets");
      const j = await r.json();
      if (j.ok) markets = j.items || [];
    } catch(e) { console.warn("markets load fail", e); }
  }
  await loadMarkets();

  // --- 검색 & 렌더 (최대 5개) ---
  let last = "";
  $input && $input.addEventListener('input', () => {
    const q = ($input.value || "").trim();
    if (q === last) return;
    last = q;
    renderResults(q);
  });

  function renderResults(q){
    $resultBox.innerHTML = "";
    if (!q) return;
    const q2 = q.toLowerCase();
    const hits = markets.filter(m =>
      (m.korean_name && m.korean_name.includes(q)) ||
      (m.market && m.market.toLowerCase().includes(q2)) ||
      (m.english_name && m.english_name.toLowerCase().includes(q2))
    ).slice(0, 5); // 최대 5개

    if (!hits.length){
      $resultBox.innerHTML = `<div style="opacity:.6">검색 결과 없음</div>`;
      return;
    }

    for (const m of hits){
      const btn = document.createElement('button');
      btn.textContent = `${m.korean_name} (${m.market})`;
      btn.style.display = 'block';
      btn.style.width = '100%';
      btn.style.textAlign = 'left';
      btn.style.margin = '6px 0';
      btn.style.padding = '10px 12px';
      btn.style.borderRadius = '10px';
      btn.style.border = '1px solid rgba(255,255,255,0.1)';
      btn.style.background = 'rgba(255,255,255,0.02)';
      btn.onmouseenter = () => btn.style.background = 'rgba(255,255,255,0.06)';
      btn.onmouseleave = () => btn.style.background = 'rgba(255,255,255,0.02)';
      btn.onclick = () => selectMarket(m.market, m.korean_name);
      $resultBox.appendChild(btn);
    }
  }

  // --- 선택 시 ULTRA 시그널 호출 & 표시 ---
  async function selectMarket(market, kor){
    try{
      // ULTRA API
      const r = await fetch(API_BASE + "/api/ultra/signal?market=" + encodeURIComponent(market));
      const j = await r.json();
      if (!j.ok && !j.market) throw new Error(j.error || "signal fail");
      renderUltra(j, kor);
      // 스크롤 포커스 (모바일 배려)
      $ultraBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }catch(e){
      renderUltra({ ok:false, market, comment: "신호 호출 실패: " + e.message }, kor);
    }
  }

  function renderUltra(sig, korName){
    const m = sig.market || "";
    const title = korName ? `${korName} (${m})` : m;
    $ultraBox.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <b>ULTRA 시그널 — 선택한 코인</b>
        <span style="opacity:.7">${title}</span>
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
        <div>현재가: <b>${fmt(sig.price)}</b></div>
        <div>위험도: <b>${fmt(sig.risk)}</b></div>
        <div>매수(BUY1): <b>${fmt(sig.buy1)}</b></div>
        <div>매수(BUY2): <b>${fmt(sig.buy2)}</b></div>
        <div>익절(TP1/TP2): <b>${fmt(sig.tp1)} / ${fmt(sig.tp2)}</b></div>
        <div>손절(SL): <b style="color:#ff6a6a">${fmt(sig.sl)}</b></div>
      </div>
      <div style="margin-top:10px;opacity:.9">쩔어한마디: ${sig.comment || '-'}</div>
    `;
  }

  function fmt(v){ return (v===undefined || v===null) ? '-' : v; }

  // 초기 상태 메시지
  if ($input && $input.value) renderResults($input.value);
})();
</script>

</body>
</html>
