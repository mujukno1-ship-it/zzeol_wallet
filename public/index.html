<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRW 코인 검색 · 매수/매도 타점</title>
  <style>
    body{background:#0d0f13;color:#e6e6e6;font-family:"Noto Sans KR",sans-serif;margin:0;padding:0;}
    .wrap{max-width:1100px;margin:25px auto;padding:0 15px;}
    h1{font-size:22px;margin-bottom:14px;}
    input{background:#12151b;color:#e6e6e6;border:1px solid #2c3142;border-radius:8px;padding:8px 12px;}
    button{background:#2c3142;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer;}
    button:hover{background:#3a4060;}
    .panel{background:#151821;border:1px solid #232634;border-radius:10px;padding:12px;margin-top:12px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 12px;border-bottom:1px solid #222634;text-align:left;font-size:14px;}
    th{color:#9aa0ab;}
    .muted{color:#9aa0ab;}
    .pos{color:#00e68a;}
    .neg{color:#ff6b6b;}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;margin-left:6px;}
    .ok{background:#142c3b;color:#74d7ff;}
    .warn{background:#3b3212;color:#ffd37b;}
    .danger{background:#3b1114;color:#ffb5be;}
    #spark-body tr td{transition:background-color 0.3s ease;}
    #spark-body tr:hover td{background:#1b1e27;}
    #loading-msg{color:#9aa0ab;text-align:center;padding:10px;font-size:13px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KRW 코인 검색 · 매수/매도 타점</h1>

    <div style="margin-bottom:10px;">
      <input id="q" placeholder="예: BTC 또는 KRW-ETH" />
      <button id="btn">검색</button>
      <span id="sys" class="badge ok">시스템: OK</span>
      <span id="risk" class="badge warn">위험도: -</span>
    </div>

    <!-- 기존 검색 결과 패널 -->
    <div class="panel">
      <table>
        <tbody>
          <tr><th>코인</th><td id="sym">-</td><td class="muted">현재가격/등락</td></tr>
          <tr><th>현재가</th><td id="price">-</td><td class="muted">매수/매도 타점 기준</td></tr>
          <tr><th>등락</th><td id="chg">-</td><td class="muted">전일 대비 등락률</td></tr>
          <tr><th>매수</th><td id="buy">-</td><td class="muted">추천 매수가</td></tr>
          <tr><th>매도</th><td id="sell">-</td><td class="muted">추천 매도가</td></tr>
          <tr><th>손절</th><td id="stop">-</td><td class="muted">위험관리 손절가</td></tr>
        </tbody>
      </table>
    </div>

    <div id="one" class="panel muted" style="font-size:13px;">검색해주세요.</div>

    <!-- ⚡ 스파크 코인 항상 표시 -->
    <div class="panel" id="spark-panel">
      <h3 style="margin:0 0 8px 0;">⚡ 스파크 코인 (15초마다 자동 갱신)</h3>
      <div id="loading-msg">불러오는 중...</div>
      <table>
        <thead>
          <tr>
            <th>코인(한글)</th>
            <th>현재가</th>
            <th>매수</th>
            <th>매도</th>
            <th>손절</th>
            <th>위험도</th>
            <th>시간</th>
            <th>쩔어한마디</th>
          </tr>
        </thead>
        <tbody id="spark-body"></tbody>
      </table>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('ko-KR');
const pct = n => (Number(n) >= 0 ? '+' : '') + Number(n).toFixed(2) + '%';
const KRW = v => (v < 1 ? v.toFixed(4) : fmt.format(Math.round(v)));

function tick(p){
  if(p>=2000000)return 1000;
  if(p>=1000000)return 500;
  if(p>=500000)return 100;
  if(p>=100000)return 50;
  if(p>=10000)return 10;
  if(p>=1000)return 1;
  if(p>=100)return 0.1;
  if(p>=10)return 0.01;
  if(p>=1)return 0.001;
  return 0.0001;
}
function rTick(v,d="nearest"){
  const t=tick(v),n=v/t;
  if(d==="up")return Math.ceil(n)*t;
  if(d==="down")return Math.floor(n)*t;
  return Math.round(n)*t;
}

async function loadSpark(){
  const msg=$('#loading-msg');
  msg.style.display='block';
  const body=$('#spark-body');
  body.innerHTML=''; // 기존 잔상 제거

  try{
    const r=await fetch('/api/spark?minRise=1&minVolRatio=1.2',{cache:'no-store'});
    const t=await r.text();
    const j=JSON.parse(t);

    if(!j.ok){throw new Error(j.error||'스파크 오류');}

    const items=j.items;
    if(!items || items.length===0){
      msg.innerText='현재 포착된 스파크 코인이 없습니다.';
      return;
    }
    msg.style.display='none'; // 불러오기 문구 제거

    body.innerHTML=items.map(x=>{
      const name=x.market.replace('KRW-','');
      const price=Number(x.price)||0;
      const buy=rTick(price*0.985);
      const sell=rTick(price*1.03);
      const stop=rTick(price*0.97);
      const risk=(x.rise3m>5)?'높음':(x.rise3m>2?'보통':'낮음');
      const riskColor=(risk==='높음')?'danger':(risk==='보통'?'warn':'ok');
      const time=new Date(x.ts).toLocaleTimeString('ko-KR',{hour12:false});
      const msgTxt=(x.rise3m>5)?'급등 주의':'단기 추세 지속';
      return `
        <tr>
          <td>${name}</td>
          <td>${KRW(price)}</td>
          <td>${KRW(buy)}</td>
          <td>${KRW(sell)}</td>
          <td>${KRW(stop)}</td>
          <td><span class="badge ${riskColor}">${risk}</span></td>
          <td>${time}</td>
          <td>${msgTxt}</td>
        </tr>`;
    }).join('');
  }catch(e){
    msg.innerText='스파크 데이터 불러오기 실패';
  }
}

async function loadSummary(){
  try{
    const q=$('#q').value.trim().toUpperCase();
    const market=q.startsWith('KRW-')?q:`KRW-${q}`;
    const res=await fetch(`/api/summary?market=${market}`);
    const j=await res.json();

    const p=j.price||0;
    $('#sym').textContent=market;
    $('#price').textContent=KRW(p);
    $('#chg').innerHTML=(j.change>=0)?`<span class="pos">${pct(j.change)}</span>`:`<span class="neg">${pct(j.change)}</span>`;
    $('#buy').textContent=KRW(rTick(p*0.985));
    $('#sell').textContent=KRW(rTick(p*1.015));
    $('#stop').textContent=KRW(rTick(p*0.97));
    $('#one').textContent='쩔어한마디: 단기 변동 주의, 분할 접근이 유리.';
  }catch(e){
    $('#one').textContent='데이터 로드 실패.';
  }
}

$('#btn').addEventListener('click',loadSummary);
$('#q').addEventListener('keydown',e=>{if(e.key==='Enter')loadSummary();});

window.addEventListener('load',()=>{
  loadSpark();
  setInterval(loadSpark,15000); // 15초마다 갱신
});
</script>
</body>
</html>
