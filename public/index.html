<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KRW 코인 검색 · 타점 · 스파크</title>
<style>
:root{--bg:#0e0f13;--panel:#16181f;--text:#e6e6e6;--muted:#9aa0ab;--pos:#1ec780;--neg:#ff5577;--warn:#f5a524;--border:#232634;}
body{background:var(--bg);color:var(--text);margin:0;font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR;}
.wrap{max-width:1100px;margin:30px auto;padding:0 16px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-top:14px;overflow:hidden}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input{background:#0c0d11;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;width:260px}
button{background:#3856ff;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #222532;font-size:14px;text-align:left}
th{background:#12141b;color:#aab1bc}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;background:#1b1f2a;color:#d5d8df}
.ok{background:#0f2b3d;color:#7dd3fc}
.warn{background:#3a2b12;color:#f6d28b}
.danger{background:#3a1117;color:#ffb3c2}
#spark-body tr:hover td{background:#1b1e27}
#loading-msg{color:var(--muted);text-align:center;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>KRW 코인 검색 · 타점</h1>

  <!-- 검색창 -->
  <div class="row">
    <input id="q" type="text" placeholder="예: BTC, ETH 또는 KRW-ETH" />
    <button id="btn">검색</button>
  </div>

  <!-- ⚡ 스파크 코인 (검색 아래 고정, 항상 표시) -->
  <section class="panel" id="spark-panel">
    <h3 style="margin:8px 12px">⚡ 스파크 코인</h3>
    <div id="loading-msg">불러오는 중...</div>
    <table>
      <thead>
        <tr>
          <th>코인(한글)</th><th>현재가</th><th>매수</th><th>매도</th><th>손절</th>
          <th>위험도</th><th>시간</th><th>쩔어한마디</th>
        </tr>
      </thead>
      <tbody id="spark-body"></tbody>
    </table>
  </section>

  <!-- 검색 결과 -->
  <div class="panel">
    <table>
      <tbody>
        <tr><th>코인</th><td id="sym">-</td></tr>
        <tr><th>현재가</th><td id="price">-</td></tr>
        <tr><th>등락</th><td id="chg">-</td></tr>
        <tr><th>매수</th><td id="buy">-</td></tr>
        <tr><th>매도</th><td id="sell">-</td></tr>
        <tr><th>손절</th><td id="stop">-</td></tr>
      </tbody>
    </table>
  </div>
  <div class="panel" style="padding:10px;font-size:13px" id="one">검색해주세요.</div>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=new Intl.NumberFormat('ko-KR');
const KRW=v=>(v<1?Number(v||0).toFixed(4):fmt.format(Math.round(v||0)));
const pct=v=>`${(Number(v)||0).toFixed(2)}%`;
function tickKRW(p){p=Number(p)||0;if(p>=2e6)return 1e3;if(p>=1e6)return 500;if(p>=5e5)return 100;if(p>=1e5)return 50;if(p>=1e4)return 10;if(p>=1e3)return 1;if(p>=100)return 0.1;if(p>=10)return 0.01;if(p>=1)return 0.001;return 0.0001;}
const roundTick=(v,d='nearest')=>{const t=tickKRW(v),n=v/t;if(d==='up')return Math.ceil(n)*t;if(d==='down')return Math.floor(n)*t;return Math.round(n)*t;};

/* ===== 기존 기능: 검색 요약 ===== */
async function loadSummary(){
 try{
  const q=($('#q').value||'ETH').trim().toUpperCase();
  const m=q.startsWith('KRW-')?q:`KRW-${q}`;
  const r=await fetch(`/api/summary?market=${encodeURIComponent(m)}`,{cache:'no-store'});
  const j=await r.json();
  if(!j.ok) throw new Error(j.error);
  const p=Number(j.price)||0,c=Number(j.change)||0;
  $('#sym').textContent=j.symbol||m;
  $('#price').textContent=KRW(p);
  $('#chg').innerHTML=c>=0?`<span style="color:#1ec780">+${pct(c)}</span>`:`<span style="color:#ff5577">${pct(c)}</span>`;
  $('#buy').textContent=KRW(roundTick(p*0.994));
  $('#sell').textContent=KRW(roundTick(p*1.006));
  $('#stop').textContent=KRW(roundTick(p*0.978));
  $('#one').textContent=(c>3)?'단기 급등 주의, 분할 익절 구간.':(c<-3)?'하락 주의, 손절 관리 필수.':'보통 구간: 관망 또는 추세 진입.';
 }catch(e){$('#one').textContent='데이터 로드 실패';}
}
$('#btn').addEventListener('click',loadSummary);
$('#q').addEventListener('keydown',e=>{if(e.key==='Enter')loadSummary();});

/* ===== 스파크 기능 (24시간 유지 / 10개 제한 / 무깜빡) ===== */
const SPARK={cache:new Map(),LINGER_MS:24*60*60*1000,FIRST:false};
function patchRow(tbody,item){
 const id=item.market;let tr=tbody.querySelector(`tr[data-id="${id}"]`);
 const isStale=!!item._stale;const price=Number(item.price)||0;
 const buy=roundTick(price*0.985,'down'),sell=roundTick(price*1.03,'up'),stop=roundTick(price*0.97,'down');
 const risk=(item.rise3m>5)?{t:'높음',c:'danger'}:(item.rise3m>2)?{t:'보통',c:'warn'}:{t:'낮음',c:'ok'};
 const msg=(item.rise3m>6)?'급등 주의! 익절 준비.':(item.rise3m>3)?'단타 구간, 추세 유지.':'관망 구간, 세력 확인.';
 const name=item.kor||item.market.replace('KRW-','');
 const time=new Date(item.ts||Date.now()).toLocaleTimeString('ko-KR',{hour12:false});
 const html=`<td>${name}</td><td>${KRW(price)}</td><td style="color:#00e3b2">${KRW(buy)}</td><td style="color:#ffd166">${KRW(sell)}</td><td style="color:#ff6b6b">${KRW(stop)}</td><td><span class="badge ${risk.c}">위험도:${risk.t}</span></td><td class="muted">${time}${isStale?' · 최근감지':''}</td><td>${msg}</td>`;
 if(!tr){tr=document.createElement('tr');tr.setAttribute('data-id',id);if(isStale)tr.style.opacity='0.55';tr.innerHTML=html;tbody.appendChild(tr);}
 else{tr.style.opacity=isStale?'0.55':'';const tmp=document.createElement('tbody');tmp.innerHTML=`<tr>${html}</tr>`;const n=tmp.querySelectorAll('td'),o=tr.querySelectorAll('td');n.forEach((td,i)=>{if(o[i]&&o[i].innerHTML!==td.innerHTML)o[i].innerHTML=td.innerHTML;});}
}
function gcRows(tb){const now=Date.now();for(const[k,v]of SPARK.cache){if(now-v.lastSeen>SPARK.LINGER_MS){SPARK.cache.delete(k);const tr=tb.querySelector(`tr[data-id="${k}"]`);tr&&tr.remove();}}}
async function loadSpark(){
 const msg=$('#loading-msg'),tb=$('#spark-body');
 if(!SPARK.FIRST&&msg)msg.style.display='block';
 try{
  const r=await fetch(`/api/spark?minRise=1&minVolRatio=1.2&limit=60`,{cache:'no-store'});
  const j=await r.json();const now=Date.now();
  if(j.ok&&Array.isArray(j.items)){
   j.items.forEach(it=>SPARK.cache.set(it.market,{...it,lastSeen:now}));
   const list=Array.from(SPARK.cache.values()).sort((a,b)=>(b.lastSeen-a.lastSeen)||(b.rise3m-a.rise3m));
   const top=list.slice(0,10),overflow=list.slice(10);
   top.forEach(it=>patchRow(tb,{...it,_stale:(now-it.lastSeen>15e3)}));
   overflow.forEach(it=>{SPARK.cache.delete(it.market);const tr=tb.querySelector(`tr[data-id="${it.market}"]`);tr&&tr.remove();});
   gcRows(tb);
  }
  if(!SPARK.FIRST&&msg){msg.style.display=SPARK.cache.size?'none':'block';SPARK.FIRST=true;}
 }catch(e){if(!SPARK.FIRST&&msg)msg.textContent='스파크 로드 실패';}
}
window.addEventListener('load',()=>{loadSummary();loadSpark();setInterval(loadSpark,15000);});
</script>
</body>
</html>
