<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v11.1 â€” No-Motion Â· KRW Â· ì—…ë¹„íŠ¸í‹±</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --muted:#9aa4af; --text:#e8eef5; --accent:#68b0ff;
    --ok:#43d18b; --warn:#ffb74d; --risk:#ff6b6b; --line:#1a2230;
  }
  *{box-sizing:border-box; transition:none!important; animation:none!important}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
  .title{font-weight:700;margin:0 0 12px 0}
  .sub{color:var(--muted);font-size:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#142033;border:1px solid #1d2a3f;color:#9ec7ff;font-size:12px}
  /* ê²€ìƒ‰ */
  .search-bar{display:flex;gap:8px}
  .search-input{flex:1;height:44px;border-radius:12px;border:1px solid var(--line);background:#0c1219;color:var(--text);padding:0 14px;font-size:15px;outline:none}
  .chip{height:32px;border-radius:999px;border:1px solid var(--line);background:#0c1219;color:var(--muted);padding:0 10px;font-size:12px}
  .search-results{margin-top:10px;border:1px solid var(--line);border-radius:12px;background:#0c1219;max-height:260px;overflow:auto;width:100%}
  .sr-empty{color:var(--muted);padding:14px}
  .sr-item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-top:1px solid #0f1a26;cursor:pointer}
  .sr-item:first-child{border-top:0}
  .sr-item:hover{background:#0f1620}
  .tag{color:#8ea2b3;font-size:12px}
  /* SPARK */
  .spark-item{display:grid;grid-template-columns:1fr 82px;gap:14px;padding:10px 0;border-top:1px solid #0f1a26}
  .spark-item:first-child{border-top:0}
  .spark-name{display:flex;gap:10px;align-items:center}
  .bar{position:relative;height:8px;border-radius:8px;background:#101926;border:1px solid #122033;overflow:hidden}
  .fill{position:absolute;inset:0;width:0%}
  .fill.orange{background:#ff9d4d} .fill.red{background:#ff6b6b} .fill.yellow{background:#ffd166}
  .price{color:#cfe6ff;text-align:right}
  /* ULTRA */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1219}
  .k{color:#8ea2b3;font-size:12px;margin-bottom:4px}
  .v{font-size:16px;font-weight:700}
  .risk-1{color:#7ddf9a}.risk-2{color:#a6f0c5}.risk-3{color:#ffd166}.risk-4{color:#ff9d4d}.risk-5{color:#ff6b6b}
  .comment{min-height:78px;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0c1219}
  .mt6{margin-top:6px}.mt10{margin-top:10px}.mt16{margin-top:16px}.mt20{margin-top:20px}
  @media (max-width:820px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- ê²€ìƒ‰ -->
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©) â€” í•œê¸€ëª…/ì‹¬ë³¼ ì…ë ¥</div>
      <div class="search-bar">
        <input id="search" class="search-input" placeholder="ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH" />
        <button id="btn-krw" class="chip">KRW ê¸°ì¤€</button>
        <button id="btn-upbit" class="chip">ì—…ë¹„íŠ¸ í˜¸ê°€í‹±</button>
        <button id="btn-nomotion" class="chip">No-Motion</button>
      </div>
      <div id="sr" class="search-results" hidden></div>
      <div class="sub">ì—°ë™: ì—…ë¹„íŠ¸ ë§ˆì¼“/ìŠ¤íŒŒí¬/ULTRA Â· ëª¨ë“  ê°€ê²© KRW, ì½”ì¸ëª… í•œê¸€ Â· ê²€ìƒ‰ ê²°ê³¼ëŠ” <b>ìµœëŒ€ 5ê°œ</b></div>
    </div>

    <!-- ULTRA ì‹œê·¸ë„ (ê²€ìƒ‰ ë°”ë¡œ ì•„ë˜) -->
    <div class="card">
      <div class="title">ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</div>
      <div id="sparkMeta" class="sub"></div> <!-- ì˜ˆì—´ê°•ë„Â·ì˜ˆìƒìƒìŠ¹ë¥ Â·íŒë‹¨ -->
      <div id="ultraTarget" class="sub">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜/ìµì ˆ/ì†ì ˆ, ìœ„í—˜ë„, ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <div class="grid2 mt10">
        <div class="kv"><div class="k">í˜„ì¬ê°€</div><div id="v-price" class="v">-</div></div>
        <div class="kv"><div class="k">ìœ„í—˜ë„(1~5)</div><div id="v-risk" class="v">-</div></div>
        <div class="kv"><div class="k">ë§¤ìˆ˜(BUY1)</div><div id="v-buy1" class="v">-</div></div>
        <div class="kv"><div class="k">ë§¤ìˆ˜(BUY2)</div><div id="v-buy2" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ(TP1)</div><div id="v-tp1" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ(TP2)</div><div id="v-tp2" class="v">-</div></div>
        <div class="kv"><div class="k">ì†ì ˆ(SL)</div><div id="v-sl" class="v">-</div></div>
        <div class="kv"><div class="k">ì„¸ë ¥ì§€ìˆ˜</div><div id="v-force" class="v">-</div></div>
      </div>

      <div class="comment mt16">
        <div class="k">ì©”ì–´í•œë§ˆë””</div>
        <div id="v-comment" class="v" style="font-size:14px;line-height:1.55">-</div>
      </div>
    </div>

    <!-- SPARK TOP10 -->
    <div class="card">
      <div class="title">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€</div>
      <div class="sub">í•„í„°: RVOLÂ·TBRÂ·OBIÂ·ATRÂ·ForceIndex ì¢…í•© (ì˜ˆì—´ â‰¥ ì¡°ê±´ ì¶©ì¡±)</div>
      <div id="spark"></div>
    </div>
  </div>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";
let MARKETS = []; // KRW ë§ˆì¼“ ëª©ë¡

async function safeFetch(url, opt={}){
  const res = await fetch(url, {mode:"cors", cache:"no-store", ...opt});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ===== ì—…ë¹„íŠ¸ ë§ˆì¼“ ë¡œë“œ (1íšŒ) ===== */
async function loadMarkets(){
  try{
    const data = await safeFetch(`${API_BASE}/upbit/markets`);
    MARKETS = data.filter(x => x.market?.startsWith("KRW-"));
  }catch(e){ console.error("loadMarkets", e); }
}

/* ===== ê²€ìƒ‰ ===== */
const $search = document.getElementById('search');
const $sr = document.getElementById('sr');

$search.addEventListener('input', () => {
  const q = $search.value.trim().toLowerCase();
  if(!q){ $sr.hidden = true; $sr.innerHTML = ""; return; }

  const m = MARKETS.filter(x=>{
    const s1 = (x.korean_name||"").toLowerCase();
    const s2 = (x.english_name||"").toLowerCase();
    const s3 = (x.market||"").toLowerCase();
    return s1.includes(q) || s2.includes(q) || s3.includes(q);
  }).slice(0,5); // ìµœëŒ€ 5ê°œ

  if(m.length===0){ $sr.hidden=false; $sr.innerHTML = `<div class="sr-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

  $sr.hidden = false;
  $sr.innerHTML = m.map(x=>`
    <div class="sr-item" data-market="${x.market}">
      <div><b>${x.korean_name}</b> <span class="tag">(${x.market})</span></div>
      <button class="chip">ì„ íƒ</button>
    </div>`).join('');
});

$sr.addEventListener('click', (e)=>{
  const host = e.target.closest('.sr-item');
  if(!host) return;
  selectMarket(host.getAttribute('data-market'));
});

/* ===== SPARK ì ìˆ˜ â†’ ìƒìŠ¹ë¥ (%) ê³„ì‚° & ë¼ë²¨ ===== */
function expectedRiseFromScore(score, { rvol=1.0, tbr=0.5, force=50 } = {}){
  // ê¸°ë³¸ ë°´ë“œ (ì‚¬í† ì‹œ ë©”ëª¨ë¦¬ ê·œì¹™)
  let base = score>=90 ? 20 : score>=80 ? 10 : score>=70 ? 5 : 3;
  // Precision Boost Mode ê·¼ì‚¬ ë³´ì •
  if (rvol  > 1.8) base += (rvol  - 1.8) * 3;
  if (tbr   > 0.60) base += (tbr   - 0.60) * 10;
  if (force > 70)   base += (force - 70) * 0.10;
  base = Math.max(4, Math.min(25, base));
  return Math.round(base * 10) / 10;
}
function sparkLabel(score){
  if(score >= 90) return "í­ë°œ ì„ë°•ğŸ”¥";
  if(score >= 80) return "ê°•ë ¥ ì˜ˆì—´";
  if(score >= 70) return "ì˜ˆì—´";
  return "ê´€ë§";
}

/* ===== SPARK TOP10 ===== */
async function loadSpark(){
  try{
    const data = await safeFetch(`${API_BASE}/spark/top10`);
    const list = (Array.isArray(data)?data:[]).slice(0,10);

    const html = list.map(row=>{
      const price = row.price != null ? Number(row.price).toLocaleString('ko-KR')+"ì›" : "-";
      const score = Math.max(0, Math.min(100, Math.round(Number(row.score ?? row.force_index ?? 0))));
      const w = Math.max(6, Math.min(100, score));
      const color = score>=85 ? "red" : (score>=70 ? "orange" : "yellow");

      const risePct = expectedRiseFromScore(score, {
        rvol:  Number(row.rvol ?? 1.0),
        tbr:   Number(row.tbr  ?? 0.5),
        force: Number(row.force_index ?? 50)
      });
      const label = sparkLabel(score);

      return `
        <div class="spark-item" data-market="${row.market}">
          <div class="spark-name">
            <span class="badge">SPARK ${score}%</span>
            <div>
              <div><b>${row.korean_name||row.market}</b> <span class="tag">${row.market||""}</span></div>
              <div class="bar mt6"><span class="fill ${color}" style="width:${w}%"></span></div>
              <div class="sub">ì˜ˆìƒìƒìŠ¹ë¥ : <b>+${risePct}%</b> Â· AI: ${label}</div>
            </div>
          </div>
          <div class="price">${price}</div>
        </div>
      `;
    }).join('');

    const $wrap = document.getElementById('spark');
    $wrap.innerHTML = html || `<div class="sub">SPARK ë°ì´í„° ì—†ìŒ</div>`;
    $wrap.onclick = (e)=>{
      const host = e.target.closest('.spark-item');
      if(!host) return;
      selectMarket(host.getAttribute('data-market'));
    };
  }catch(e){
    console.error("loadSpark", e);
    document.getElementById('spark').innerHTML = `<div class="sub">ì—°ë™ ì‹¤íŒ¨</div>`;
  }
}

/* ===== ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼ (ê°„ë‹¨ ê·¼ì‚¬) ===== */
function roundTick(p){
  p = Number(p)||0;
  if(p < 10) return Math.round(p*100)/100;
  if(p < 100) return Math.round(p*10)/10;
  if(p < 1000) return Math.round(p);
  if(p < 10000) return Math.round(p/5)*5;
  if(p < 100000) return Math.round(p/10)*10;
  return Math.round(p/50)*50;
}
function fmtKRW(n){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString('ko-KR')+'ì›'; }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = (v ?? '-'); }
function clamp(a,b,x){ return Math.max(a, Math.min(b, x)); }

/* ===== ULTRA ì‹œê·¸ë„ ===== */
async function selectMarket(market){
  try{
    document.getElementById('ultraTarget').textContent = `${market} ë¶„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`;
    const data = await safeFetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);

    const P = Number(data.price||0); // í˜„ì¬ê°€

    // SPARK_SCORE ê·¼ì‚¬ (ì„œë²„ê°€ score/force_index ì œê³µ ì‹œ ì‚¬ìš©)
    const scoreApprox =
      (data.score!=null) ? Number(data.score) :
      (data.force_index!=null) ? Math.max(0, Math.min(100, Math.round(Number(data.force_index)))) : 0;

    // ì˜ˆì—´ ê°•ë„ ê¸°ë°˜ ì˜ˆìƒ ìƒìŠ¹ë¥ (%)
    const risePct = expectedRiseFromScore(scoreApprox, {
      rvol:  Number(data.rvol ?? 1.0),
      tbr:   Number(data.tbr  ?? 0.5),
      force: Number(data.force_index ?? 50)
    });
    const label = sparkLabel(scoreApprox);

    // í‘œê¸°
    const $meta = document.getElementById('sparkMeta');
    $meta.textContent = `SPARK_SCORE: ${scoreApprox}% (${label}) Â· ì˜ˆìƒìƒìŠ¹ë¥ : +${risePct}% Â· AI íŒë‹¨ ë°˜ì˜`;

    // AIê°€ ì¤€ up/down %ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì˜ˆì—´ê¸°ë°˜ ë³´ì • ì‚¬ìš©
    const upP = Number((data.up_pct ?? data.upProb ?? risePct) || 0);
    const dnP = Number((data.down_pct ?? data.downProb) || Math.max(3, risePct*0.4));

    // BUY/TP/SL ê³„ì‚° (ì‚¬í† ì‹œ ë©”ëª¨ë¦¬ ê·œì¹™: ë¶„ì„ í¼ì„¼íŠ¸ ê¸°ë°˜ + í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼)
    const buy1 = roundTick(P * (1 - Math.min(0.004, dnP/100/2))); // ì‚´ì§ ë‹¹ê¹€(ìµœëŒ€ 0.4%)
    const buy2 = roundTick(P * (1 - Math.min(0.010, dnP/100)));   // ë” ë‹¹ê¹€
    const tp1  = roundTick(P * (1 + Math.max(0.005, upP/100*0.6)));
    const tp2  = roundTick(P * (1 + Math.max(0.010, upP/100)));
    const sl   = roundTick(P * (1 - Math.max(0.006, dnP/100)));

    const risk = clamp(1,5, Math.round((Number(data.risk)||0) || (dnP/4) || 3));
    const force = Number(data.force_index||data.force||0);

    // ëª¨ë“œ (ë¶ˆì¥/í•˜ë½/ë˜ëŒë¦¼)
    const mode = ((data.rvol||0) >= 2.0 && (data.tbr||0) >= 0.65 && force >= 80) ? "bull"
               : ((data.tbr||0) <= 0.45 || force <= 35) ? "bear" : "retrace";

    // UI ì„¸íŒ…
    document.getElementById('ultraTarget').textContent = `${(data.korean_name || market)} (${market})`;
    setText('v-price', fmtKRW(P));
    const $risk = document.getElementById('v-risk'); $risk.className = 'v risk-'+risk; $risk.textContent = risk;
    setText('v-buy1', fmtKRW(buy1));
    setText('v-buy2', fmtKRW(buy2));
    setText('v-tp1',  fmtKRW(tp1));
    setText('v-tp2',  fmtKRW(tp2));
    setText('v-sl',   fmtKRW(sl));
    setText('v-force', force.toFixed(0));

    // ì©”ì–´í•œë§ˆë””
    document.getElementById('v-comment').textContent = makeComment({
      base:P, upProb:upP, downProb:dnP, rvol:Number(data.rvol||0), tbr:Number(data.tbr||0),
      force:Number(force||0), aboveVWAP: !!data.above_vwap, mode
    });

  }catch(e){
    console.error("selectMarket", e);
    document.getElementById('ultraTarget').textContent = `ì—°ë™ ì‹¤íŒ¨ â€” ${market}`;
    document.getElementById('sparkMeta').textContent = "";
  }
}

/* ===== ì©”ì–´í•œë§ˆë”” ===== */
function makeComment({base,upProb,downProb,rvol,tbr,force,aboveVWAP,mode}){
  if(mode==='bull'){
    return `ë¶ˆì¥ ì‹ í˜¸ğŸ”¥ â€” RVOL ${rvol.toFixed(2)}, ì²´ê²°ê°•ë„ ${tbr.toFixed(2)}, ì„¸ë ¥ì§€ìˆ˜ ${force}.
ìµì ˆì€ ëŠ¦ì¶”ê³ (TP2 ìš°ì„ ) ë¶„í• ë§¤ìˆ˜ ìœ ì§€. ê³¼ì—´êµ¬ê°„ ì£¼ì˜.`;
  }
  if(mode==='bear'){
    return `í•˜ë½ì¥ ê²½ê³„âš ï¸ â€” ì²´ê²° ì•½ì„¸(TBR ${tbr.toFixed(2)}), ì„¸ë ¥ì§€ìˆ˜ ${force}.
ì¶”ê°€ ì§„ì… ê¸ˆì§€, ì†ì ˆ ê°•í™”(SL ìš°ì„ ), ì‹œê°„ ì œí•œ ì²­ì‚° ê¶Œì¥.`;
  }
  const bias = aboveVWAP ? "VWAP ìƒë‹¨" : "VWAP í•˜ë‹¨";
  return `ë˜ëŒë¦¼ ê´€ì°°â†”ï¸ â€” ${bias}, RVOL ${rvol.toFixed(2)}.
ì˜ˆìƒ ìƒìŠ¹ +${(+upProb).toFixed(1)}%, í•˜ë½ âˆ’${(+downProb).toFixed(1)}% ê¸°ì¤€ìœ¼ë¡œ ë¶„í• ë§¤ìˆ˜/ë¶„í• ìµì ˆ ìš´ì˜.`;
}

/* ===== ì´ˆê¸° êµ¬ë™ ===== */
(async function init(){
  await loadMarkets();
  loadSpark();
  // ì£¼ê¸° ê°±ì‹ (ìŠ¤íŒŒí¬ 30ì´ˆ) â€” í™”ë©´ ê¹œë¹¡ì„ ì—†ìŒ
  setInterval(loadSpark, 30000);
})();
</script>
<script>
/* ============================== *
 *  Upbit KRW Tick & Rounding Kit
 *  â€” paste above </body>
 * ============================== */

// ì—…ë¹„íŠ¸ KRW í˜¸ê°€ ë‹¨ìœ„ í…Œì´ë¸”
function getTickSizeKRW(p) {
  const price = Number(p);
  if (price >= 2_000_000) return 1000;
  if (price >= 1_000_000) return 500;
  if (price >= 500_000)  return 100;
  if (price >= 100_000)  return 50;
  if (price >= 10_000)   return 10;
  if (price >= 1_000)    return 1;
  if (price >= 100)      return 0.1;
  if (price >= 10)       return 0.01;
  if (price >= 1)        return 0.001;   // SHIB ê°™ì€ ì €ê°€ ì½”ì¸
  return 0.0001;
}

// í‹±ë‹¨ìœ„ ê¸°ì¤€ ë°˜ì˜¬ë¦¼(ê¸°ë³¸: ìµœê·¼ì ‘), ì˜¬ë¦¼/ë‚´ë¦¼ ì§€ì›
function roundTick(p, mode = "nearest") {
  const price = Number(p);
  const tick = getTickSizeKRW(price);
  const n = price / tick;

  let q;
  if (mode === "up")      q = Math.ceil(n);
  else if (mode === "down") q = Math.floor(n);
  else                    q = Math.round(n);

  const v = q * tick;

  // ì†Œìˆ˜ì  ìë¦¿ìˆ˜ëŠ” tickì— ë§ê²Œ ìë™ ì§€ì •
  const decimals = (tick.toString().split(".")[1] || "").length;
  return Number(v.toFixed(decimals));
}

// KRW í¬ë§· (í‹±ì— ë§ì¶° ìë¦¿ìˆ˜ ìœ ì§€)
function formatKRW(p) {
  const price = Number(p);
  const tick = getTickSizeKRW(price);
  const decimals = (tick.toString().split(".")[1] || "").length;
  return price.toLocaleString("ko-KR", {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }) + "ì›";
}

/* ------------------------------
 *  í•œ ë²ˆì— ê°’ë“¤ ì „ë¶€ ë³´ì •í•˜ëŠ” í›…
 *  ì‚¬ìš©ì˜ˆ:
 *    const out = applyUpbitTicks({
 *      current: cur, buy1: b1, buy2: b2, tp1, tp2, sl
 *    });
 *    // out.buy1Formatted ì²˜ëŸ¼ ì‚¬ìš©í•´ì„œ UI ê°±ì‹ 
 * ------------------------------ */
function applyUpbitTicks(levels) {
  const out = {};
  const keys = ["current","buy1","buy2","tp1","tp2","sl"];
  keys.forEach(k => {
    if (levels[k] == null || levels[k] === "") return;
    // ë§¤ìˆ˜/ìµì ˆì€ ìµœê·¼ì ‘, ì†ì ˆì€ ì•ˆì „í•˜ê²Œ ë‚´ë¦¼ ì ìš©(ì›í•˜ë©´ 'down'ì„ 'nearest'ë¡œ ë°”ê¿”ë„ ë¨)
    const mode = (k === "sl") ? "down" : "nearest";
    const v    = roundTick(levels[k], mode);
    out[k] = v;
    out[k + "Formatted"] = formatKRW(v);
  });
  return out;
}

/* ------------------------------
 *  âœ… ê¸°ì¡´ ì½”ë“œì— ì—°ê²°í•˜ëŠ” ìµœì†Œ ê°€ì´ë“œ
 *  - ì§€ê¸ˆê¹Œì§€ ê³„ì‚°ëœ ìˆ«ì(buy1, tp1, sl ë“±)ë¥¼
 *    ë§ˆì§€ë§‰ í‘œì‹œ ì§ì „ì— applyUpbitTicksì— ë„£ê³ 
 *    ë°˜í™˜ê°’ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ë©´ ë.
 *
 *  ì˜ˆì‹œ:
 *    // ê¸°ì¡´ ê³„ì‚° ê²°ê³¼ (ì˜ˆ: AI ë¶„ì„ ê²°ê³¼)
 *    const cur = 0.01523;   // í˜„ì¬ê°€
 *    const b1  = 0.0108;    // ë§¤ìˆ˜1
 *    const b2  = 0.01095;   // ë§¤ìˆ˜2
 *    const t1  = 0.0197;    // ìµì ˆ1
 *    const t2  = 0.0212;    // ìµì ˆ2
 *    const sL  = 0.00949;   // ì†ì ˆ
 *
 *    const fixed = applyUpbitTicks({
 *      current: cur, buy1: b1, buy2: b2, tp1: t1, tp2: t2, sl: sL
 *    });
 *
 *    // UI ë°”ì¸ë”©(ì˜ˆ: innerText)
 *    $('#cur').innerText  = fixed.currentFormatted;
 *    $('#buy1').innerText = fixed.buy1Formatted;
 *    $('#buy2').innerText = fixed.buy2Formatted;
 *    $('#tp1').innerText  = fixed.tp1Formatted;
 *    $('#tp2').innerText  = fixed.tp2Formatted;
 *    $('#sl').innerText   = fixed.slFormatted;
 * ------------------------------ */
</script>  
  <script>
/* ===== Upbit KRW Tick Enforcer (Display-level) ===== */

// KRW í˜¸ê°€í‹±
function getTickSizeKRW(p){
  const x = Number(p);
  if (x >= 2_000_000) return 1000;
  if (x >= 1_000_000) return 500;
  if (x >= 500_000)  return 100;
  if (x >= 100_000)  return 50;
  if (x >= 10_000)   return 10;
  if (x >= 1_000)    return 1;
  if (x >= 100)      return 0.1;
  if (x >= 10)       return 0.01;
  if (x >= 1)        return 0.001;
  return 0.0001;
}
function roundTick(p, mode="nearest"){
  const price = Number(p);
  const tick  = getTickSizeKRW(price);
  const n = price / tick;
  let q = mode==="up" ? Math.ceil(n) : mode==="down" ? Math.floor(n) : Math.round(n);
  const v = q * tick;
  const d = (tick.toString().split(".")[1] || "").length;
  return Number(v.toFixed(d));
}
function formatKRW(p){
  const price = Number(p);
  const tick  = getTickSizeKRW(price);
  const d = (tick.toString().split(".")[1] || "").length;
  return price.toLocaleString("ko-KR",{minimumFractionDigits:d,maximumFractionDigits:d}) + "ì›";
}

/* í•µì‹¬: í™”ë©´ìƒì˜ ëª¨ë“  ê°€ê²© ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í‹± ë³´ì •
   - ê°€ê²© í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸ì— class="upbit-price" ë¥¼ ë‹¬ì•„ì¤˜.
   - ê°€ëŠ¥í•œ ê²½ìš° data-value(ì›ì‹œ ìˆ«ì)ë¥¼ í•¨ê»˜ ë„£ì–´ì£¼ë©´ ì •í™•ë„â†‘
   - ì†ì ˆì€ ì•ˆì „í•˜ê²Œ ë‚´ë¦¼, ë‚˜ë¨¸ì§€ëŠ” ìµœê·¼ì ‘ ë°˜ì˜¬ë¦¼
*/
function enforceUpbitTicks(){
  document.querySelectorAll(".upbit-price").forEach(el=>{
    // ì›ì‹œê°’ ìš°ì„ : data-value > data-raw > í…ìŠ¤íŠ¸ ìˆ«ì ì¶”ì¶œ
    let raw = el.getAttribute("data-value")
            ?? el.getAttribute("data-raw")
            ?? (el.textContent||"").replace(/[^\d.\-]/g,"");
    if(raw==="" || isNaN(raw)) return;

    const isSL = el.classList.contains("is-sl"); // ì†ì ˆ í‘œì‹œì—” ì´ í´ë˜ìŠ¤ ì¶”ê°€
    const v = roundTick(raw, isSL ? "down" : "nearest");
    el.setAttribute("data-value", v);
    el.textContent = formatKRW(v);
  });
}
enforceUpbitTicks();
setInterval(enforceUpbitTicks, 400); // ê°±ì‹  ë£¨í”„(ê°€ë²¼ì›€)

/* ë””ë²„ê·¸ ë„ìš°ë¯¸: ì½˜ì†”ì—ì„œ í™•ì¸ìš©
   window.testTick(0.01523) ê°™ì€ ì‹ìœ¼ë¡œ ì²´í¬ */
window.testTick = (x)=>({in:x, tick:getTickSizeKRW(x), out:roundTick(x), fmt:formatKRW(roundTick(x))});
</script>
</body>
</html>
