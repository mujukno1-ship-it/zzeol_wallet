<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>사토시의지갑 v13.2 — Full Precision Sniper Overdrive</title>
<link rel="icon" href="data:,">
<style>
  body{background:#0f1218;color:#e7eef8;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:0}
  .wrap{max-width:1200px;margin:auto;padding:16px}
  .search{position:sticky;top:0;background:#11161d;padding:10px;border-bottom:1px solid #1d2633;z-index:99}
  .badge{background:#1f2630;color:#9bc3ff;border-radius:8px;padding:4px 8px;font-size:12px;margin-right:6px}
  input{width:100%;padding:10px;border:1px solid #2a3340;border-radius:8px;background:#0f141c;color:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .card{background:#151a21;border:1px solid #202734;border-radius:12px;padding:12px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #1d2633}
  .bar{height:5px;background:#2a3340;border-radius:10px;overflow:hidden;margin-top:4px}
  .bar span{display:block;height:100%;background:#ffb020;width:0%}
  .up{color:#1ec996}.down{color:#ff5b6b}
  .note{margin-top:10px;padding:10px;border:1px dashed #2a3340;border-radius:10px;background:#10151c;color:#c8d3e2}
</style>
</head>
<body>
<div class="wrap">
  <div class="search">
    <span class="badge">KRW · 업비트 호가틱 · 한글명 · No-Motion</span>
    <input id="q" placeholder="코인명, 심볼, 마켓코드 (예: 에이다, ADA, KRW-ADA)"/>
  </div>

  <section class="card">
    <h3>🔥 SPARK 예열 TOP10</h3>
    <div id="sparkList"></div>
    <div id="sparkEmpty" style="color:#777;margin:12px 0;text-align:center;">예열코인 탐색중...</div>
  </section>

  <section class="card">
    <h3>⚡ ULTRA 시그널</h3>
    <div><b>현재가:</b> <span id="v_price">-</span></div>
    <div><b>매수(BUY1):</b> <span id="v_buy1">-</span></div>
    <div><b>익절(TP1):</b> <span id="v_tp1">-</span></div>
    <div><b>손절(SL):</b> <span id="v_sl">-</span></div>
    <div class="note" id="z_msg">코인을 선택하면 쩔어한마디가 표시됩니다.</div>
  </section>

  <section class="card">
    <h3>🎯 AI 스나이퍼 바닥·천장</h3>
    <div>AI 예상 바닥: <span id="sn_low">-</span></div>
    <div>AI 예상 천장: <span id="sn_high">-</span></div>
    <div>신뢰도: <span id="sn_conf">-</span></div>
  </section>

  <section class="card">
    <h3>🌐 글로벌 4대 지표 (워커 → Stooq → Yahoo)</h3>
    <div id="globalPanel">
      <div class="item"><b>NASDAQ100</b><span id="g_ndx">-</span></div>
      <div class="item"><b>S&P500</b><span id="g_spx">-</span></div>
      <div class="item"><b>DXY</b><span id="g_dxy">-</span></div>
      <div class="item"><b>US10Y</b><span id="g_us10y">-</span></div>
    </div>
  </section>

  <footer class="note">사토시의지갑 v13.2 — 기존기능 유지 + 글로벌 백업 + Precision Overdrive</footer>
</div>

<script>
const API_BASE="https://satoshi-proxy.mujukno1.workers.dev/api";
const $=s=>document.querySelector(s);
const fmt=n=>isNaN(n)?"-":Number(n).toLocaleString("ko-KR");
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

/* ---------------- 공통 API ---------------- */
async function jget(path,{retries=2,timeout=9000}={}) {
  let lastErr=null;
  for(let i=0;i<=retries;i++){
    const ctl=new AbortController();
    const to=setTimeout(()=>ctl.abort(),timeout);
    try{
      const url=`${API_BASE}${path}${path.includes('?')?'&':'?'}_ts=${Date.now()}`;
      const r=await fetch(url,{
        method:"GET",mode:"cors",cache:"no-store",
        headers:{
          "accept":"application/json",
          "cache-control":"no-cache, no-store, must-revalidate",
          "pragma":"no-cache","expires":"0"
        },
        signal:ctl.signal
      });
      clearTimeout(to);
      if(!r.ok) throw new Error(r.status);
      const d=await r.json();
      if(d.ok===false) throw new Error(d.error||"api");
      return d;
    }catch(e){clearTimeout(to);lastErr=e;await new Promise(r=>setTimeout(r,200+i*250));}
  }
  console.warn("API 실패",path,lastErr);return null;
}

/* ---------------- SPARK ---------------- */
async function loadSpark(){
  const d=await jget("/spark/top?limit=10");
  const list=$("#sparkList");list.innerHTML="";
  if(!d?.list?.length){$("#sparkEmpty").style.display="block";return;}
  $("#sparkEmpty").style.display="none";
  d.list.forEach(it=>{
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`<div>${it.korean_name||it.market}
      <div class="bar"><span style="width:${clamp(it.spark,0,100)}%"></span></div></div>
      <div>${fmt(it.price)}원</div>`;
    row.onclick=()=>openUltra(it.market);
    list.append(row);
  });
}

/* ---------------- ULTRA ---------------- */
async function openUltra(m){
  const s=await jget("/ultra/signal?market="+encodeURIComponent(m));
  if(!s){alert("신호 없음");return;}
  const p=Number(s.price||0);
  $("#v_price").textContent=fmt(p)+"원";
  $("#v_buy1").textContent=fmt(p*0.995)+"원";
  $("#v_tp1").textContent=fmt(p*1.02)+"원";
  $("#v_sl").textContent=fmt(p*0.985)+"원";
  $("#z_msg").textContent=`🔥 세력 분출 직전 — 예열강도 ${s.spark||80} / 상승확률 ${(s.prob_up||85)}%`;
  refreshSniper(m);
}

/* ---------------- SNIPER ---------------- */
async function refreshSniper(m){
  const d=await jget("/sniper/point?market="+encodeURIComponent(m));
  if(!d?.sniper)return;
  const s=d.sniper;
  $("#sn_low").textContent=fmt(s.ai_low)+"원";
  $("#sn_high").textContent=fmt(s.ai_high)+"원";
  $("#sn_conf").textContent=s.confidence? s.confidence+"%" : "-";
}

/* ---------------- 글로벌지표 ---------------- */
function paintGlobal(idBase,v){
  const num=$("#g_"+idBase);
  if(!num||!v)return;
  num.textContent=isFinite(v.close)?v.close.toLocaleString("en-US",{maximumFractionDigits:2}):"-";
}
async function loadGlobal(){
  let data=null;
  // 1) Worker
  try{
    const d=await fetch(`${API_BASE}/global?_ts=${Date.now()}`,{mode:"cors",cache:"no-store"})
      .then(r=>r.ok?r.json():null);
    if(d?.ok)data=d.data;
  }catch{}
  // 2) Stooq CSV
  if(!data){
    try{
      const text=await fetch("https://r.jina.ai/http://stooq.com/q/l/?s=%5Endx,%5Espx,dxy,us10y&f=sd2t2ohlcv&h&e=csv&_ts="+Date.now())
        .then(r=>r.text());
      const lines=text.trim().split(/\r?\n/).slice(1);
      data={};
      lines.forEach(l=>{
        const c=l.split(","),sym=c[0].toLowerCase(),close=parseFloat(c[6]);
        data[sym]={close};
      });
    }catch{}
  }
  // 3) Yahoo
  if(!data?.ndx){
    try{
      const y=await fetch("https://r.jina.ai/http://query1.finance.yahoo.com/v7/finance/quote?symbols=%5ENDX,%5EGSPC,DX-Y.NYB,%5ETNX&_ts="+Date.now())
        .then(r=>r.json());
      const q=y?.quoteResponse?.result||[];
      data={
        ndx:{close:q.find(x=>x.symbol=="^NDX")?.regularMarketPrice},
        spx:{close:q.find(x=>x.symbol=="^GSPC")?.regularMarketPrice},
        dxy:{close:q.find(x=>x.symbol=="DX-Y.NYB")?.regularMarketPrice},
        us10y:{close:q.find(x=>x.symbol=="^TNX")?.regularMarketPrice}
      };
    }catch{}
  }
  if(!data)return;
  paintGlobal("ndx",data.ndx);paintGlobal("spx",data.spx);
  paintGlobal("dxy",data.dxy);paintGlobal("us10y",data.us10y);
}

/* ---------------- 실행 ---------------- */
(async()=>{
  await loadGlobal();
  await loadSpark();
})();
</script>
</body>
</html>
