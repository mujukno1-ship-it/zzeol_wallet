<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사토시의지갑 v12.1 완전체</title>
  <style>
    body {
      background: #0d0d0d;
      color: #fff;
      font-family: Pretendard, sans-serif;
      margin: 0;
      padding: 0;
    }
    #search {
      display: flex;
      justify-content: center;
      margin: 20px;
    }
    input {
      width: 400px;
      padding: 10px;
      border-radius: 10px;
      border: none;
      text-align: center;
    }
    section {
      background: #141414;
      border-radius: 16px;
      margin: 10px auto;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 0 8px rgba(255,255,255,0.1);
    }
    .spark-item, .ultra-box {
      background: #1c1c1c;
      border-radius: 10px;
      margin: 6px 0;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .spark-item:hover { background: #252525; }
    .price { color: #00ff9d; font-weight: 600; }
  </style>
</head>
<body>
  <div id="search">
    <input id="search-input" placeholder="코인 이름 또는 심볼 입력..." />
  </div>

  <!-- ① ULTRA 시그널 (위로 올림) -->
  <section id="ultra-section">
    <h3>⚡ ULTRA 시그널 — 선택한 코인</h3>
    <div id="ultra-content">코인을 선택하면 매수·매도·손절 타점이 표시됩니다.</div>
  </section>

  <!-- ② SPARK TOP10 (아래로 이동) -->
  <section id="spark-section">
    <h3>🔥 SPARK TOP10 — 급등 사전 예열 감지</h3>
    <div id="spark-content">불러오는 중...</div>
  </section>

  <script>
    // ============ [업비트 호가틱 반올림] ============
    function roundPriceKRW(price) {
      if (price < 1) return Math.round(price * 1000) / 1000;
      if (price < 10) return Math.round(price * 100) / 100;
      if (price < 100) return Math.round(price * 10) / 10;
      if (price < 1000) return Math.round(price);
      if (price < 10000) return Math.round(price / 5) * 5;
      return Math.round(price / 10) * 10;
    }

    // ============ [SPARK 예열 데이터 모의 예시] ============
    const sparkList = [
      { name: "시바이누", symbol: "KRW-SHIB", price: 0.015, rvol: 4.7, force: 82, score: 91 },
      { name: "에테나", symbol: "KRW-ENA", price: 732, rvol: 3.2, force: 74, score: 85 },
      { name: "아비트럼", symbol: "KRW-ARB", price: 1420, rvol: 2.8, force: 88, score: 92 },
      { name: "체인링크", symbol: "KRW-LINK", price: 26610, rvol: 2.9, force: 69, score: 83 },
      { name: "온도코인", symbol: "KRW-ONDO", price: 1250, rvol: 2.4, force: 80, score: 89 }
    ];

    const sparkDiv = document.getElementById("spark-content");
    sparkDiv.innerHTML = sparkList.map(c => `
      <div class="spark-item" onclick="showUltra('${c.name}','${c.symbol}',${c.price},${c.score})">
        <div>${c.name} <small>${c.symbol}</small></div>
        <div class="price">${roundPriceKRW(c.price)}원</div>
        <div>예열강도 ${c.score}%</div>
      </div>
    `).join('');

    // ============ [ULTRA 시그널 — 매수·매도 타점 계산] ============
    function showUltra(name, symbol, current, score) {
      const ultraDiv = document.getElementById("ultra-content");

      // AI 상승률 예측 (SPARK 예열강도 기반)
      let rise = 0, fall = 0;
      if (score >= 90) { rise = 0.20; fall = 0.05; }     // 폭발 임박
      else if (score >= 80) { rise = 0.10; fall = 0.06; } // 강력 예열
      else if (score >= 70) { rise = 0.06; fall = 0.08; } // 예열
      else { rise = 0.03; fall = 0.10; }                  // 약세

      const buy1 = roundPriceKRW(current * (1 - fall));
      const tp1  = roundPriceKRW(current * (1 + rise));
      const tp2  = roundPriceKRW(current * (1 + rise * 1.5));
      const sl   = roundPriceKRW(current * (1 - fall * 1.2));

      let comment = "";
      if (score >= 90) comment = "🔥 세력 분출 직전, 단기 급등 확률 매우 높음!";
      else if (score >= 80) comment = "⚡ 강력 예열 구간 — 분할 진입 유효.";
      else if (score >= 70) comment = "🟡 예열 시작 — 추세 전환 가능성 관망.";
      else comment = "⚫ 관망 구간 — 매수 신호 약함.";

      ultraDiv.innerHTML = `
        <div class="ultra-box"><b>${name}</b> (${symbol})</div>
        <div class="ultra-box">현재가: ${roundPriceKRW(current)}원</div>
        <div class="ultra-box">매수(BUY1): ${buy1}원</div>
        <div class="ultra-box">익절(TP1): ${tp1}원 / TP2: ${tp2}원</div>
        <div class="ultra-box">손절(SL): ${sl}원</div>
        <div class="ultra-box">예상상승률: +${(rise*100).toFixed(1)}% / 예상하락률: −${(fall*100).toFixed(1)}%</div>
        <div class="ultra-box">쩔어한마디: ${comment}</div>
      `;
    }
  </script>
  <!-- === Satoshi: Search + API wiring (기존기능유지) === -->
<style>
  .satoshi-search-wrap{display:flex;gap:8px;justify-content:center;align-items:center;margin:16px auto;max-width:720px}
  .satoshi-search{flex:1;padding:10px 14px;border-radius:10px;border:1px solid #333;background:#111;color:#eee}
  .satoshi-btn{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1f2937;color:#fff;cursor:pointer}
  .satoshi-results{max-width:720px;margin:8px auto 24px;display:grid;gap:8px}
  .satoshi-card{padding:10px 12px;border:1px solid #30363d;border-radius:12px;background:#0b0f14;color:#e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .satoshi-pill{font-size:12px;padding:3px 8px;border-radius:999px;background:#1f2937;border:1px solid #374151}
  .satoshi-msg{max-width:720px;margin:12px auto;color:#9CA3AF;font-size:14px;text-align:center}
</style>

<div id="satoshi-search-area" class="satoshi-search-wrap">
  <input id="satoshi-search-input" class="satoshi-search" placeholder="코인 이름 또는 심볼 입력… (예: 시바이누, ETH, KRW-ETH)" />
  <button id="satoshi-search-btn" class="satoshi-btn">검색</button>
</div>
<div id="satoshi-search-results" class="satoshi-results"></div>
<div id="satoshi-search-msg" class="satoshi-msg"></div>

<script>
(function(){
  // 0) API 베이스 (워커 주소 정확히!)
  const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';

  // 1) 헬스체크로 연결 확인 후 안내
  async function ping(){
    try{
      const r = await fetch(`${API_BASE}/health`, {mode:'cors'});
      const j = await r.json();
      if(!j.ok) throw 0;
      msg('연결 완료 ✅');
    }catch(e){
      msg('연결 실패 ❌ (CORS 또는 워커 배포 확인 필요)');
    }
  }

  // 2) 업비트 마켓 목록 받아서 로컬 캐시
  let MARKET_CACHE = [];
  async function loadMarkets(){
    if (MARKET_CACHE.length) return MARKET_CACHE;
    const r = await fetch(`${API_BASE}/upbit/markets`);
    const j = await r.json();
    // KRW 마켓만, 한국어명 포함
    MARKET_CACHE = (j.markets || j || [])
      .filter(m => (m.market||'').startsWith('KRW-'))
      .map(m => ({market:m.market, korean_name:m.korean_name || m.koreanName || '', english_name:m.english_name || ''}));
    return MARKET_CACHE;
  }

  // 3) 검색 실행 (최대 5개)
  async function doSearch(){
    const q = (inp.value || '').trim().toLowerCase();
    if (!q){ render([], '검색어를 입력하세요.'); return; }
    try{
      await loadMarkets();
      const matched = MARKET_CACHE.filter(m => 
        m.market.toLowerCase().includes(q) ||
        (m.korean_name||'').toLowerCase().includes(q) ||
        (m.english_name||'').toLowerCase().includes(q)
      ).slice(0,5); // 5개 제한
      if(!matched.length){ render([], '검색 결과가 없습니다.'); return; }
      render(matched);
    }catch(e){
      render([], '검색 실패 (연결 확인 필요)');
    }
  }

  // 4) 검색 결과 렌더 & 클릭 시 ULTRA 시그널 불러오기
  async function onPick(market){
    try{
      msg('ULTRA 시그널 불러오는 중…');
      const r = await fetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);
      const j = await r.json();
      msg(''); // 안내 지움
      // 화면 어딘가에 이미 존재하는 ULTRA 영역이 있다면 값을 채우고, 없으면 간단히 알림.
      // 여기선 최소 표시(현재가/BUY1/TP/SL/예상상승·하락률)만 안내:
      alert(
        `[${market}] ULTRA 시그널\n` +
        `현재가: ${j.price ?? '-'}원\n` +
        `BUY1 : ${j.buy1 ?? '-'}원\n` +
        `TP1/TP2: ${j.tp1 ?? '-'} / ${j.tp2 ?? '-'}원\n` +
        `SL   : ${j.sl ?? '-'}원\n` +
        `예상상승률 / 하락률: ${j.exp_up ?? '-'}% / ${j.exp_down ?? '-'}%`
      );
    }catch(e){
      msg('ULTRA 불러오기 실패 (CORS 또는 API 오류)');
    }
  }

  // 5) DOM 헬퍼
  const inp = document.getElementById('satoshi-search-input');
  const btn = document.getElementById('satoshi-search-btn');
  const box = document.getElementById('satoshi-search-results');
  const msgBox = document.getElementById('satoshi-search-msg');

  function render(list, hint=''){
    box.innerHTML = '';
    if (hint) msg(hint); else msg('');
    list.forEach(m=>{
      const row = document.createElement('div');
      row.className = 'satoshi-card';
      row.innerHTML = `
        <div>
          <div style="font-weight:600">${m.korean_name || '-'} <span class="satoshi-pill">${m.market}</span></div>
          <div style="font-size:12px;color:#9ca3af">${m.english_name || ''}</div>
        </div>
        <button class="satoshi-btn" data-market="${m.market}">선택</button>
      `;
      row.querySelector('button').onclick = () => onPick(m.market);
      box.appendChild(row);
    });
  }
  function msg(t){ msgBox.textContent = t || ''; }

  // 6) 이벤트 (No-Motion: 입력시 화면 점프 없음)
  btn.addEventListener('click', doSearch);
  inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

  // 시작 시 헬스핑
  ping();
})();
</script>
<!-- === /Satoshi: Search + API wiring === -->
</body>
</html>
