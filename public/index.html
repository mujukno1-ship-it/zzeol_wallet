<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v11 â€” No-Motion í•œë°©ë²„ì „</title>
<style>
  :root{
    --bg:#0d1117;--panel:#151b23;--muted:#7d8590;--text:#e6edf3;
    --accent:#2f81f7;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji}
  /* No-Motion */
  *,*:before,*:after{transition:none!important;animation:none!important}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 12px 0;font-weight:700}
  .sub{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  /* ê²€ìƒ‰ ë°•ìŠ¤ + ê²°ê³¼(ìµœëŒ€ 5ê°œ) */
  .search-wrap{position:relative;margin:10px 0 22px}
  .search-input{
    width:100%;max-width:780px;height:44px;border-radius:10px;padding:0 14px;
    background:#0f141b;border:1px solid var(--border);color:var(--text);font-size:16px;outline:none;
  }
  .results{
    position:absolute;left:0;top:48px; width:100%; max-width:780px;
    background:var(--panel); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; z-index:10; box-shadow:none;
  }
  .result-item{
    padding:9px 12px; cursor:pointer; border-top:1px solid #131922; font-size:14px;
  }
  .result-item:hover{background:#0f141b}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted)}
  /* ì¹´ë“œ */
  .card{
    background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0;
  }
  .card h2{margin:0 0 10px 0;font-size:16px}
  /* SPARK ë¦¬ìŠ¤íŠ¸ */
  .spark-list{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .spark-item{padding:10px;border:1px solid #1a2330;border-radius:10px;background:#0f141b;cursor:pointer}
  .spark-item:hover{background:#101722}
  .score{font-weight:700;margin-left:6px}
  .bar{height:6px;background:#0e1620;border-radius:6px;margin-top:8px;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#ff7a7a,#ffb36b)}
  /* ì‹œê·¸ë„ íŒ¨ë„ */
  .signal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#0f141b;border:1px solid #1a2330;border-radius:10px;padding:10px}
  .kv b{display:block;color:#aab1bd;font-size:12px;margin-bottom:4px}
  .comment{white-space:pre-wrap;background:#0f141b;border:1px dashed #263042;border-radius:10px;padding:12px;margin-top:10px;color:#cbd5e1}
  .chip{border:1px solid #263042;background:#0f141b;color:#d1d6de;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer;margin-right:6px}
  .chip:hover{background:#111a26}
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)} .ok{color:var(--ok)} .warn{color:var(--warn)}
  .hidden{display:none}
  /* ì‘ì€ í™”ë©´ */
  @media (max-width:720px){
    .spark-list{grid-template-columns:1fr}
    .signal-grid{grid-template-columns:1fr}
    .search-input,.results{max-width:100%}
  }
</style>
</head>
<body>
  <div class="container">
    <h1>ì‚¬í† ì‹œì˜ì§€ê°‘ v11 â€” <span class="pill">No-Motion</span> <span class="pill">KRWÂ·ì—…ë¹„íŠ¸ í˜¸ê°€í‹±</span></h1>

    <!-- ê²€ìƒ‰ -->
    <div class="search-wrap">
      <input id="search" class="search-input" placeholder="ì½”ì¸ ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: ì´ë”ë¦¬ì›€, KRW-ETH)" autocomplete="off" />
      <div id="results" class="results hidden"></div>
      <div class="sub">ê²€ìƒ‰ ê²°ê³¼ëŠ” **ìµœëŒ€ 5ê°œ**ë§Œ í‘œì‹œë©ë‹ˆë‹¤. (ì—…ë¹„íŠ¸ KRW ì „ìš©)</div>
    </div>

    <!-- SPARK -->
    <div class="card">
      <h2>ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€ <span id="sparkStatus" class="sub"></span></h2>
      <div id="sparkList" class="spark-list"></div>
    </div>

    <!-- ULTRA ì‹œê·¸ë„ -->
    <div class="card">
      <h2>ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</h2>
      <div id="signalHeader" class="sub">ì½”ì¸ì„ ì„ íƒí•˜ë©´ AI ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="signal" class="signal-grid hidden"></div>

      <div id="tpSl" class="hidden" style="margin-top:8px">
        <div class="inline">
          <span class="muted">ìµì ˆ(ìƒìŠ¹ë¥ ):</span>
          <button class="chip tp" data-p="5">+5%</button>
          <button class="chip tp" data-p="8">+8%</button>
          <button class="chip tp" data-p="10">+10%</button>
          <button class="chip tp" data-p="12">+12%</button>
          <button class="chip tp" data-p="15">+15%</button>
          <input id="tpIn" type="number" step="0.5" placeholder="ì§ì ‘ì…ë ¥(%)" class="chip" style="width:96px">
          <button id="tpApply" class="chip">ì ìš©</button>
          <span id="tpPrev" class="sub"></span>
        </div>
        <div class="inline" style="margin-top:6px">
          <span class="muted">ì†ì ˆ(í•˜ë½ë¥ ):</span>
          <button class="chip sl" data-p="3">-3%</button>
          <button class="chip sl" data-p="5">-5%</button>
          <button class="chip sl" data-p="8">-8%</button>
          <button class="chip sl" data-p="10">-10%</button>
          <input id="slIn" type="number" step="0.5" placeholder="ì§ì ‘ì…ë ¥(%)" class="chip" style="width:96px">
          <button id="slApply" class="chip">ì ìš©</button>
          <span id="slPrev" class="sub"></span>
        </div>
      </div>

      <div id="comment" class="comment hidden"></div>
    </div>
  </div>

<script>
/* =========================
   Satoshi â€” Single-file App
   ========================= */
const API = "https://satoshi-proxy.mujukno1.workers.dev/api"; // í•„ìš”ì‹œ ë°”ê¿”ë„ ë¨

const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => [...p.querySelectorAll(s)];

const elSearch  = $("#search");
const elResults = $("#results");
const elSpark   = $("#sparkList");
const elSparkSt = $("#sparkStatus");
const elSignal  = $("#signal");
const elHeader  = $("#signalHeader");
const elTPWrap  = $("#tpSl");
const elTPPrev  = $("#tpPrev");
const elSLPrev  = $("#slPrev");
const elCmt     = $("#comment");

// ---------- ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ----------
function tickUnit(price){
  if (price >= 2000000) return 1000;
  if (price >= 1000000) return 500;
  if (price >= 500000)  return 100;
  if (price >= 100000)  return 50;
  if (price >= 10000)   return 10;
  if (price >= 1000)    return 1;
  if (price >= 100)     return 0.1;
  if (price >= 10)      return 0.01;
  return 0.001;
}
function roundTick(p, dir="nearest"){
  const t = tickUnit(p), v = p/t;
  if(dir==="up") return Math.ceil(v)*t;
  if(dir==="down") return Math.floor(v)*t;
  return Math.round(v)*t;
}
function fmt(n){ return (n??"-").toLocaleString?.("ko-KR") ?? n; }

// ---------- ë°ì´í„° ë¡œë”© ----------
let MARKET_CACHE = []; // ì—…ë¹„íŠ¸ ë§ˆì¼“(ê²€ìƒ‰ìš©)
let CUR = null;        // í˜„ì¬ ì‹œê·¸ë„ ë°ì´í„°

async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(r.status+" "+url);
  return r.json();
}

// ì—…ë¹„íŠ¸ ë§ˆì¼“ ë¡œë“œ
async function loadMarkets(){
  try{
    const arr = await fetchJSON(`${API}/upbit/markets`);
    MARKET_CACHE = arr.filter(x=>x.market?.startsWith("KRW-"));
  }catch(e){ console.warn("loadMarkets", e); }
}
loadMarkets();

// SPARK TOP10 ë¡œë“œ
async function loadSpark(){
  elSparkSt.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  try{
    const list = await fetchJSON(`${API}/spark/top10`);
    // ê¸°ëŒ€í˜•íƒœ: [{market,korean_name,score,price,...}]
    elSpark.innerHTML = list.map(c=>{
      const heat = Math.max(0, Math.min(100, c.score ?? 0));
      const color = heat>=90 ? "#ff4d4d" : heat>=80 ? "#ff9900" : "#9aa";
      return `
      <div class="spark-item" data-market="${c.market}">
        <div class="row" style="justify-content:space-between">
          <div><b>${c.korean_name}</b> <span class="sub">(${c.market})</span></div>
          <div class="score" style="color:${color}">${heat}</div>
        </div>
        <div class="bar"><span style="width:${heat}%;"></span></div>
        <div class="sub" style="margin-top:6px">í˜„ì¬ê°€: ${fmt(c.price)}ì›</div>
      </div>`;
    }).join("");
    elSparkSt.textContent = "";
  }catch(e){
    console.error(e);
    elSparkSt.textContent = "SPARK ë°ì´í„° ì—†ìŒ";
  }
}
loadSpark(); setInterval(loadSpark, 30000);

// ---------- ê²€ìƒ‰(ìµœëŒ€ 5ê°œ, ë¡œì»¬ í•„í„°) ----------
function renderResults(items){
  if(!items.length){ elResults.classList.add("hidden"); elResults.innerHTML=""; return; }
  elResults.classList.remove("hidden");
  elResults.innerHTML = items.map(x=>`
    <div class="result-item" data-market="${x.market}">
      ${x.korean_name} <span class="sub">(${x.market})</span>
    </div>
  `).join("");
}
elSearch.addEventListener("input", ()=>{
  const q = elSearch.value.trim();
  if(!q){ renderResults([]); return; }
  const res = MARKET_CACHE
    .filter(x => x.korean_name.includes(q) || x.market.replace("KRW-","").includes(q.toUpperCase()))
    .slice(0,5);
  renderResults(res);
});
document.addEventListener("click",(e)=>{
  const r = e.target.closest(".result-item");
  if(!r) return;
  renderResults([]);
  openSignal(r.dataset.market);
});

// ---------- SPARK í´ë¦­ â†’ ì‹œê·¸ë„ ----------
elSpark.addEventListener("click",(e)=>{
  const item = e.target.closest(".spark-item");
  if(!item) return;
  openSignal(item.dataset.market);
});

// ---------- ì‹œê·¸ë„ í‘œì‹œ ----------
async function openSignal(market){
  elHeader.textContent = `${market} ë¶„ì„ì¤‘â€¦`;
  elSignal.classList.add("hidden");
  elTPWrap.classList.add("hidden");
  elCmt.classList.add("hidden");
  try{
    const s = await fetchJSON(`${API}/ultra/signal?market=${encodeURIComponent(market)}`);
    CUR = s; // {market,korean_name,price,buy1,tp1,sl,upProb,downProb,risk,...}
    renderSignal(s);
  }catch(e){
    console.error(e);
    elHeader.textContent = "ì‹œê·¸ë„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
  }
}

function renderKV(title,val,cls=""){
  return `<div class="kv ${cls}"><b>${title}</b><div>${val ?? "-"}</div></div>`;
}

function renderSignal(s){
  elHeader.textContent = `${s.korean_name} (${s.market})`;
  const base = s.price ?? 0;

  // ê¸°ë³¸ê°’ ë³´ì •(ì—†ì–´ë„ ë™ì‘)
  const buy1 = s.buy1 ?? roundTick(base*0.997,"down");
  const tp1  = s.tp1  ?? roundTick(base*1.01,"up");
  const sl   = s.sl   ?? roundTick(base*0.99,"down");
  const risk = s.risk ?? 3;

  elSignal.innerHTML = `
    ${renderKV("í˜„ì¬ê°€", `${fmt(base)}ì›`)}
    ${renderKV("ìœ„í—˜ë„", risk)}
    ${renderKV("ë§¤ìˆ˜(BUY1)", `${fmt(buy1)}ì›`)}
    ${renderKV("ë§¤ìˆ˜(BUY2)", s.buy2?`${fmt(s.buy2)}ì›`:"-")}
    ${renderKV("ìµì ˆ(TP1)", `${fmt(tp1)}ì›`)}
    ${renderKV("ìµì ˆ(TP2)", s.tp2?`${fmt(s.tp2)}ì›`:"-")}
    ${renderKV("ì†ì ˆ(SL)", `${fmt(sl)}ì›`, "danger")}
    ${renderKV("ì„¸ë ¥ì§€ìˆ˜", s.force_index ?? "-")}
  `;
  elSignal.classList.remove("hidden");
  elTPWrap.classList.remove("hidden");

  // ì©”ì–´í•œë§ˆë””(ë¶ˆì¥/í•˜ë½/ë˜ëŒë¦¼ ìë™ íŒë‹¨)
  const cmt = makeComment({
    base, upProb:s.upProb, downProb:s.downProb,
    rvol:s.rvol, tbr:s.tbr, force:s.force_index,
    aboveVWAP:s.above_vwap
  });
  elCmt.textContent = cmt;
  elCmt.classList.remove("hidden");

  // ì¹© ë™ì‘
  $$(".tp").forEach(b=>b.onclick=()=>applyTP(+b.dataset.p, base));
  $$(".sl").forEach(b=>b.onclick=()=>applySL(+b.dataset.p, base));
  $("#tpApply").onclick=()=>{const v=+$("#tpIn").value; if(v>0) applyTP(v, base);};
  $("#slApply").onclick=()=>{const v=+$("#slIn").value; if(v>0) applySL(v, base);};
}

// TP/SL ì ìš© ë¯¸ë¦¬ë³´ê¸°
function applyTP(pct, base){
  const tp = roundTick(base*(1+pct/100), "up");
  elTPPrev.textContent = `â†’ +${pct}% ìµì ˆê°€: ${fmt(tp)}ì› (ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼)`;
}
function applySL(pct, base){
  const sl = roundTick(base*(1-pct/100), "down");
  elSLPrev.textContent = `â†’ -${pct}% ì†ì ˆê°€: ${fmt(sl)}ì› (ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼)`;
}

// ---------- 'ì©”ì–´í•œë§ˆë””' ìƒì„± (ë¶ˆì¥/í•˜ë½/ë˜ëŒë¦¼) ----------
function makeComment({base,upProb,downProb,rvol,tbr,force,aboveVWAP}){
  // ì…ë ¥ê°’ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ í•©ë¦¬ì  ê¸°ë³¸ ë¡œì§
  upProb    = upProb ?? 50;
  downProb  = downProb ?? (100-upProb);
  rvol      = rvol ?? 1.0;
  tbr       = tbr ?? 0.5;          // 0~1 ì‚¬ì´ ê°€ì •
  force     = force ?? 50;         // 0~100
  aboveVWAP = aboveVWAP ?? (upProb>=downProb);

  // ë¶ˆì¥ ì¡°ê±´(ì˜ˆì‹œ): RVOLâ‰¥1.8, TBRâ‰¥0.60, VWAP ìƒë‹¨, Forceâ‰¥80
  const bull = (rvol>=1.8) + (tbr>=0.60) + (aboveVWAP) + (force>=80);
  // í•˜ë½ì¥ ì¡°ê±´(ì˜ˆì‹œ): RVOLâ‰¥1.4 & VWAP í•˜ë‹¨, TBRâ‰¤0.45, Forceâ‰¤35
  const bear = (rvol>=1.4 && !aboveVWAP) + (tbr<=0.45) + (force<=35);
  // ë˜ëŒë¦¼: ë³€ë™ì„±ì€ ìˆìœ¼ë‚˜ í˜¼í•©(HV ê°€ì •ì¹˜: up/down ë¹„ìŠ·) ë˜ëŠ” VWAP ê·¼ì²˜
  const retr = Math.abs(upProb-downProb) <= 15 || (rvol>=1.2 && force>=40 && force<=70);

  if(bull>=3){
    return [
      "ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸ â€” ìµì ˆì€ ëŠ¦ì¶”ê³  í™€ë”© ê¶Œì¥.",
      "TP1ì€ +1.6Ã—ATR, TP2ëŠ” +2.8Ã—ATR ê¶Œì¥.",
      "SLì€ ì™„í™”(Câˆ’0.8Ã—ATR) í›„ BEP ì´ë™ ì§€ì—°(1.5Ã—ATR)."
    ].join("\n");
  }
  if(bear>=2){
    return [
      "âš ï¸ í•˜ë½ì¥ ê²½ê³„ â€” ë¹ ë¥¸ ì²­ì‚° ìš°ì„ .",
      "TP í­ì„ ì¶•ì†Œ(+0.6~1.0Ã—ATR), SL ê°•í™”(Câˆ’1.3Ã—ATR).",
      "ì§„ì… í›„ 15~30ë¶„ ë‚´ ëª©í‘œ ë¯¸ë„ë‹¬ ì‹œ ì‹œê°„ê¸°ë°˜ ì²­ì‚°."
    ].join("\n");
  }
  if(retr){
    return [
      "â†”ï¸ ë˜ëŒë¦¼(ë°˜ë“±/ì¡°ì •) êµ¬ê°„ ê°ì§€.",
      "ë¶„í• ë§¤ìˆ˜ 1ì°¨ â†’ ë°˜ë“± ì‹¤íŒ¨ ì‹œ ì‹ ì† ì •ë¦¬, ì„±ê³µ ì‹œ 1ì°¨ ìµì ˆ ì¤€ë¹„.",
      "VWAP ë° ìµœê·¼ ê³ ì € ë²”ìœ„ í™•ì¸: ê³¼ë§¤ìˆ˜ ì‹œ ì¶”ê²© ê¸ˆì§€."
    ].join("\n");
  }
  // ì¤‘ë¦½ ê¸°ë³¸ ë©˜íŠ¸
  return [
    "ğŸŸ¦ ì¤‘ë¦½ êµ¬ê°„ â€” ì‹ í˜¸ ëŒ€ê¸°.",
    "ë‹¤ì¤‘ íƒ€ì„í”„ë ˆì„ í•©ì¹˜(5m/1h/4h)ì™€ RVOL ì²´í¬ í›„ ì§„ì… ê¶Œì¥."
  ].join("\n");
}
</script>
</body>
</html>
