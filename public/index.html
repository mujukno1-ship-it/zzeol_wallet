<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v11.0 â€” No-Motion</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --muted:#9aa4af; --text:#e8eef5; --accent:#68b0ff;
    --ok:#43d18b; --warn:#ffb74d; --risk:#ff6b6b; --line:#1a2230;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica,Arial;
    /* No-Motion */
    scroll-behavior:auto; overscroll-behavior:none;
  }
  /* No animation / transition */
  *{transition:none !important;animation:none !important}

  .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
  .title{font-weight:700;margin:0 0 12px 0}
  .sub{color:var(--muted);font-size:12px;margin-top:6px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#142033;border:1px solid #1d2a3f;color:#9ec7ff;font-size:12px}

  /* ê²€ìƒ‰ */
  .search-bar{display:flex;gap:8px}
  .search-input{
    flex:1;height:44px;border-radius:12px;border:1px solid var(--line);background:#0c1219;color:var(--text);
    padding:0 14px;font-size:15px;outline:none;
  }
  .chip{height:32px;border-radius:999px;border:1px solid var(--line);background:#0c1219;color:var(--muted);padding:0 10px;font-size:12px}
  .search-results{
    margin-top:10px;border:1px solid var(--line);border-radius:12px;background:#0c1219;max-height:260px;overflow:auto;
    width:100%;
  }
  .sr-empty{color:var(--muted);padding:14px}
  .sr-item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-top:1px solid #0f1a26;cursor:pointer}
  .sr-item:first-child{border-top:0}
  .sr-item:hover{background:#0f1620}
  .tag{color:#8ea2b3;font-size:12px}

  /* SPARK */
  .spark-item{display:grid;grid-template-columns:1fr 82px;gap:14px;padding:10px 0;border-top:1px solid #0f1a26}
  .spark-item:first-child{border-top:0}
  .spark-name{display:flex;gap:10px;align-items:center}
  .bar{position:relative;height:8px;border-radius:8px;background:#101926;border:1px solid #122033;overflow:hidden}
  .fill{position:absolute;inset:0;width:0%}
  .fill.orange{background:#ff9d4d} .fill.red{background:#ff6b6b} .fill.yellow{background:#ffd166}
  .price{color:#cfe6ff;text-align:right}

  /* ULTRA */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1219}
  .k{color:#8ea2b3;font-size:12px;margin-bottom:4px}
  .v{font-size:16px;font-weight:700}
  .risk-1{color:#7ddf9a}.risk-2{color:#a6f0c5}.risk-3{color:#ffd166}.risk-4{color:#ff9d4d}.risk-5{color:#ff6b6b}
  .comment{min-height:78px;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0c1219}

  .mt6{margin-top:6px}.mt10{margin-top:10px}.mt16{margin-top:16px}.mt20{margin-top:20px}
</style>
</head>
<body>
  <div class="wrap">

    <!-- ê²€ìƒ‰ + ì»¨íŠ¸ë¡¤ -->
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©) â€” í•œê¸€ëª…/ì‹¬ë³¼ ì…ë ¥</div>
      <div class="search-bar">
        <input id="search" class="search-input" placeholder="ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH" />
        <button id="btn-krw" class="chip">KRW ê¸°ì¤€</button>
        <button id="btn-upbit" class="chip">ì—…ë¹„íŠ¸ í˜¸ê°€í‹±</button>
        <button id="btn-nomotion" class="chip">No-Motion</button>
      </div>
      <div id="sr" class="search-results" hidden></div>
      <div class="sub">ì—°ë™: ì—…ë¹„íŠ¸ ë§ˆì¼“/ìŠ¤íŒŒí¬/ULTRA Â· ëª¨ë“  ê°€ê²©ì€ KRW, ì½”ì¸ëª…ì€ í•œê¸€ë¡œ í‘œì‹œ Â· ê²€ìƒ‰ ê²°ê³¼ëŠ” ìµœëŒ€ 5ê°œ</div>
    </div>

    <!-- ULTRA ì‹œê·¸ë„ â€” ê²€ìƒ‰ ë°”ë¡œ ì•„ë˜ -->
    <div class="card">
      <div class="title">ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</div>
      <div id="ultraTarget" class="sub">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜/ìµì ˆ/ì†ì ˆ, ìœ„í—˜ë„, ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <div class="grid2 mt10">
        <div class="kv"><div class="k">í˜„ì¬ê°€</div><div id="v-price" class="v">-</div></div>
        <div class="kv"><div class="k">ìœ„í—˜ë„(1~5)</div><div id="v-risk" class="v">-</div></div>
        <div class="kv"><div class="k">ë§¤ìˆ˜(BUY1)</div><div id="v-buy1" class="v">-</div></div>
        <div class="kv"><div class="k">ë§¤ìˆ˜(BUY2)</div><div id="v-buy2" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ(TP1)</div><div id="v-tp1" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ(TP2)</div><div id="v-tp2" class="v">-</div></div>
        <div class="kv"><div class="k">ì†ì ˆ(SL)</div><div id="v-sl" class="v">-</div></div>
        <div class="kv"><div class="k">ì„¸ë ¥ì§€ìˆ˜</div><div id="v-force" class="v">-</div></div>
      </div>

      <div class="comment mt16">
        <div class="k">ì©”ì–´í•œë§ˆë””</div>
        <div id="v-comment" class="v" style="font-size:14px;line-height:1.55">-</div>
      </div>
    </div>

    <!-- SPARK TOP10 -->
    <div class="card">
      <div class="title">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€</div>
      <div class="sub">í•„í„°: RVOLÂ·TBRÂ·OBIÂ·ATRÂ·ForceIndex ì¢…í•© (ì˜ˆì—´ â‰¥ ì¡°ê±´ ì¶©ì¡±)</div>
      <div id="spark"></div>
    </div>
  </div>

<script>
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // ì‚¬í† ì‹œ í”„ë¡ì‹œ
let MARKETS = []; // {market:"KRW-ETH", korean_name:"ì´ë”ë¦¬ì›€", english_name:"Ethereum"}

async function safeFetch(url, opt={}){
  const res = await fetch(url, {mode:"cors", cache:"no-store", ...opt});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ---------- ì—…ë¹„íŠ¸ ë§ˆì¼“ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° 1íšŒ) ---------- */
async function loadMarkets(){
  try{
    const data = await safeFetch(`${API_BASE}/upbit/markets`);
    // KRW ì „ìš©ë§Œ ë³´ê´€
    MARKETS = data.filter(x => x.market?.startsWith("KRW-"));
  }catch(e){
    console.error("loadMarkets", e);
  }
}

/* ---------- ê²€ìƒ‰ ---------- */
const $search = document.getElementById('search');
const $sr = document.getElementById('sr');

$search.addEventListener('input', () => {
  const q = $search.value.trim().toLowerCase();
  if(!q){ $sr.hidden = true; $sr.innerHTML = ""; return; }

  const m = MARKETS.filter(x=>{
    const s1 = (x.korean_name||"").toLowerCase();
    const s2 = (x.english_name||"").toLowerCase();
    const s3 = (x.market||"").toLowerCase();
    return s1.includes(q) || s2.includes(q) || s3.includes(q);
  }).slice(0,5);

  if(m.length===0){ $sr.hidden=false; $sr.innerHTML = `<div class="sr-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

  $sr.hidden = false;
  $sr.innerHTML = m.map(x=>`
    <div class="sr-item" data-market="${x.market}">
      <div><b>${x.korean_name}</b> <span class="tag">(${x.market})</span></div>
      <button class="chip">ì„ íƒ</button>
    </div>
  `).join('');
});

$sr.addEventListener('click', (e)=>{
  const host = e.target.closest('.sr-item');
  if(!host) return;
  const market = host.getAttribute('data-market');
  selectMarket(market);
});

/* ---------- SPARK ---------- */
async function loadSpark(){
  try{
    const data = await safeFetch(`${API_BASE}/spark/top10`);
    // í•­ìƒ 10ê°œë§Œ, ì´ë¦„/ê°€ê²©/ì˜ˆì—´ê°•ë„ ê²Œì´ì§€
    const list = (Array.isArray(data)?data:[]).slice(0,10);

    const html = list.map(row=>{
      const name = row.korean_name || row.market || "-";
      const price = row.price != null ? Number(row.price).toLocaleString('ko-KR')+"ì›" : "-";
      // ì˜ˆì—´ ê°•ë„ ê·¼ì‚¬ì¹˜: force_index / atr_rank / rvol ë“± í•©ì„± ì ìˆ˜ ì¡´ì¬ ê°€ì •
      const score = Math.max(0, Math.min(100, Math.round(
        (Number(row.force_index||0)) * 1.0
      )));
      const w = Math.max(6, Math.min(100, score)); // ìµœì†Œ 6%ë¡œ ë³´ì´ê²Œ
      const color = score>=85 ? "red" : (score>=70 ? "orange" : "yellow");
      return `
        <div class="spark-item" data-market="${row.market}">
          <div class="spark-name">
            <span class="badge">ì˜ˆì—´ ${score}%</span>
            <div>
              <div><b>${row.korean_name||row.market}</b> <span class="tag">${row.market||""}</span></div>
              <div class="bar mt6"><span class="fill ${color}" style="width:${w}%"></span></div>
            </div>
          </div>
          <div class="price">${price}</div>
        </div>
      `;
    }).join('');

    const $wrap = document.getElementById('spark');
    $wrap.innerHTML = html || `<div class="sub">SPARK ë°ì´í„° ì—†ìŒ</div>`;
    $wrap.onclick = (e)=>{
      const host = e.target.closest('.spark-item');
      if(!host) return;
      const m = host.getAttribute('data-market');
      selectMarket(m);
    };
  }catch(e){
    console.error("loadSpark", e);
    document.getElementById('spark').innerHTML = `<div class="sub">ì—°ë™ ì‹¤íŒ¨</div>`;
  }
}

/* ---------- ULTRA ì‹œê·¸ë„ ---------- */
async function selectMarket(market){
  try{
    document.getElementById('ultraTarget').textContent = `${market} ë¶„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`;
    const data = await safeFetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);

    // ì˜ˆìƒ ìƒìŠ¹/í•˜ë½ë¥ (%)ì„ ê¸°ë°˜ìœ¼ë¡œ BUY/TP/SL ê³„ì‚° (ì‚¬í† ì‹œ ë©”ëª¨ë¦¬ ê·œì¹™)
    const P = Number(data.price||0);          // í˜„ì¬ê°€
    const upP = Number(data.up_pct||data.upProb||0);   // +X.X%
    const dnP = Number(data.down_pct||data.downProb||0); // -Y.Y%
    const buy1 = roundTick(P * (1 - Math.min(0.004, dnP/100/2))); // ì‚´ì§ ë‹¹ê¹€ (ìµœëŒ€ 0.4%)
    const buy2 = roundTick(P * (1 - Math.min(0.010, dnP/100)));   // ë” ë‹¹ê¹€
    const tp1  = roundTick(P * (1 + Math.max(0.005, upP/100*0.6)));
    const tp2  = roundTick(P * (1 + Math.max(0.010, upP/100)));
    const sl   = roundTick(P * (1 - Math.max(0.006, dnP/100)));

    // ìœ„í—˜ë„(1~5) â€” ê°„ë‹¨ ê·¼ì‚¬: dnP/4 + (RVOL/TBR/Force ë³´ì •)
    const risk = clamp(1,5, Math.round(
      (Number(data.risk)||0) || (dnP/4) || 3
    ));
    const force = Number(data.force_index||data.force||0);

    // ëª¨ë“œ íŒë³„(ë¶ˆì¥/í•˜ë½/ë˜ëŒë¦¼) â€” ê°„ë‹¨ ê·œì¹™
    let mode = "neutral";
    if((data.rvol||0) >= 2.0 && (data.tbr||0) >= 0.65 && force >= 80) mode="bull";
    else if((data.tbr||0) <= 0.45 || force <= 35) mode="bear";
    else mode = "retrace";

    document.getElementById('ultraTarget').textContent = `${(data.korean_name || market)} (${market})`;

    setText('v-price', fmtKRW(P));
    const $risk = document.getElementById('v-risk');
    $risk.className = 'v risk-'+risk; $risk.textContent = risk;

    setText('v-buy1', fmtKRW(buy1));
    setText('v-buy2', fmtKRW(buy2));
    setText('v-tp1',  fmtKRW(tp1));
    setText('v-tp2',  fmtKRW(tp2));
    setText('v-sl',   fmtKRW(sl));
    setText('v-force', force.toFixed(0));

    document.getElementById('v-comment').textContent = makeComment({
      base:P, upProb:upP, downProb:dnP, rvol:Number(data.rvol||0), tbr:Number(data.tbr||0),
      force:Number(force||0), aboveVWAP: !!data.above_vwap, mode
    });
  }catch(e){
    console.error("selectMarket", e);
    document.getElementById('ultraTarget').textContent = `ì—°ë™ ì‹¤íŒ¨ â€” ${market}`;
  }
}

/* ---------- ì©”ì–´í•œë§ˆë”” ---------- */
function makeComment({base,upProb,downProb,rvol,tbr,force,aboveVWAP,mode}){
  // ëª¨ë“œ ìš°ì„  ë©”ì‹œì§€
  if(mode==='bull'){
    return `ë¶ˆì¥ ì‹ í˜¸ğŸ”¥ â€” RVOL ${rvol.toFixed(2)}, ì²´ê²°ê°•ë„ ${tbr.toFixed(2)}, ì„¸ë ¥ì§€ìˆ˜ ${force}.
ìµì ˆì€ ëŠ¦ì¶”ê³ (TP2 ìš°ì„ ) ë¶„í• ë§¤ìˆ˜ ìœ ì§€. ê³¼ì—´êµ¬ê°„ ì£¼ì˜.`;
  }
  if(mode==='bear'){
    return `í•˜ë½ì¥ ê²½ê³„âš ï¸ â€” ì²´ê²° ì•½ì„¸(TBR ${tbr.toFixed(2)}), ì„¸ë ¥ì§€ìˆ˜ ${force}.
ì¶”ê°€ ì§„ì… ê¸ˆì§€, ì†ì ˆ ê°•í™”(SL ìš°ì„ ), ì‹œê°„ ì œí•œ ì²­ì‚° ê¶Œì¥.`;
  }
  // ë˜ëŒë¦¼/ì¤‘ë¦½
  const bias = aboveVWAP ? "VWAP ìƒë‹¨" : "VWAP í•˜ë‹¨";
  return `ë˜ëŒë¦¼ ê´€ì°°â†”ï¸ â€” ${bias}, RVOL ${rvol.toFixed(2)}. 
ì˜ˆìƒ ìƒìŠ¹ +${upProb.toFixed(1)}%, í•˜ë½ âˆ’${downProb.toFixed(1)}% ê¸°ì¤€ìœ¼ë¡œ ë¶„í• ë§¤ìˆ˜/ë¶„í• ìµì ˆ ìš´ì˜.`;
}

/* ---------- ìœ í‹¸ ---------- */
function setText(id, v){ document.getElementById(id).textContent = (v ?? '-'); }
function fmtKRW(n){ if(!isFinite(n)) return '-'; return Number(n).toLocaleString('ko-KR')+'ì›'; }
function clamp(a,b,x){ return Math.max(a, Math.min(b, x)); }
// ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼(ê°„ë‹¨ ê·¼ì‚¬: ê°€ê²© êµ¬ê°„ë³„)
function roundTick(p){
  p = Number(p)||0;
  if(p < 10) return Math.round(p*100)/100;
  if(p < 100) return Math.round(p*10)/10;
  if(p < 1000) return Math.round(p);
  if(p < 10000) return Math.round(p/5)*5;
  if(p < 100000) return Math.round(p/10)*10;
  return Math.round(p/50)*50;
}

/* ---------- ì´ˆê¸° êµ¬ë™ ---------- */
(async function init(){
  await loadMarkets();
  loadSpark();
})();
</script>
</body>
</html>
