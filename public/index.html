<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ v11.2 â€” KRW ì‹¤ì‹œê°„</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b7; --text:#e6eef6; --accent:#66e0a3; --danger:#ff6b6b; --warn:#ffcd70;
      --chip:#1a2333; --chip2:#1c2a3f; --border:#1c2736; --good:#36d399; --bad:#f87272;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
    .row{display:flex;gap:12px;align-items:center}
    .topbar{justify-content:flex-start;margin-bottom:16px}
    .input{flex:1;background:#0e1522;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;outline:none}
    .btn{background:#0e1522;color:#cfe2ff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .h{font-weight:700;margin:2px 0 12px 0;font-size:15px;display:flex;gap:8px;align-items:center}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .spark-list{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .spark-item{background:var(--chip);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .spark-name{font-weight:700}
    .spark-price{color:#cfe2ff}
    .bar{width:48%;height:8px;border-radius:999px;background:#0e1724;position:relative;overflow:hidden}
    .bar>.fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#3b82f6,#22d3ee);transition:width .25s}
    .chip{background:var(--chip2);border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:11px;color:#bcd0e6}
    .ultra-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kv{background:#0e1522;border:1px solid var(--border);border-radius:12px;padding:10px}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-size:16px;margin-top:4px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .note{background:#0e1522;border:1px dashed var(--border);border-radius:12px;padding:10px;color:#c6d6ea}
    .small{font-size:12px;color:var(--muted)}
    .row-s{display:flex;gap:8px;flex-wrap:wrap}
    /* No-Motion: ë ˆì´ì•„ì›ƒ ì í”„ ë°©ì§€ */
    .spark-list, .ultra-grid{min-height:220px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- ê²€ìƒ‰ & ì»¨íŠ¸ë¡¤ -->
  <div class="row topbar">
    <input id="q" class="input" placeholder="ì½”ì¸ ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ì…ë ¥â€¦ (KRW ì „ìš©)"/>
    <button id="btnKRW" class="btn">KRW ê¸°ì¤€</button>
    <button id="btnNoMotion" class="btn">No-Motion</button>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ (ìµœëŒ€ 5ê°œ / ì…ë ¥ì‹œ í‘œê¸°) -->
  <div id="searchBox" class="card">
    <div class="h">ê²€ìƒ‰ ê²°ê³¼ â€” ì…ë ¥ ì‹œ í‘œì‹œ <span class="sub">(ì—…ë¹„íŠ¸ KRW, ìµœëŒ€ 5ê°œ)</span></div>
    <div id="searchList" class="spark-list"></div>
  </div>

  <!-- SPARK TOP10 -->
  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€
      <span class="sub">RVOLÂ·TBRÂ·OBIÂ·ForceIndex ì¢…í•©. 5ë¶„ë´‰ì¦+ ì¡°ê±´ ì¶©ì¡± ì‹œ í‘œê¸°</span>
    </div>
    <div id="sparkList" class="spark-list"></div>
  </div>

  <!-- ULTRA (ì„ íƒí•œ ì½”ì¸) -->
  <div class="card" style="margin-top:12px">
    <div class="h">ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸ <span id="selName" class="sub"></span></div>

    <div class="ultra-grid">
      <div class="kv"><div class="k">í˜„ì¬ê°€</div><div id="vPrice" class="v">-</div></div>
      <div class="kv"><div class="k">ìœ„í—˜ë„</div><div id="vRisk" class="v">-</div></div>

      <div class="kv"><div class="k">ë§¤ìˆ˜(BUY1)</div><div id="vBuy1" class="v">-</div><div class="small" id="vBuy1p"></div></div>
      <div class="kv"><div class="k">ë§¤ìˆ˜(BUY2)</div><div id="vBuy2" class="v">-</div><div class="small" id="vBuy2p"></div></div>

      <div class="kv"><div class="k">ìµì ˆ(TP1)</div><div id="vTp1" class="v">-</div><div class="small" id="vTp1p"></div></div>
      <div class="kv"><div class="k">ìµì ˆ(TP2)</div><div id="vTp2" class="v">-</div><div class="small" id="vTp2p"></div></div>

      <div class="kv"><div class="k">ì†ì ˆ(SL)</div><div id="vSl" class="v">-</div><div class="small" id="vSlp"></div></div>
      <div class="kv"><div class="k">ì„¸ë ¥ì§€ìˆ˜</div><div id="vForce" class="v">-</div></div>
    </div>

    <div class="note" style="margin-top:12px">
      <div id="oneLiner">-</div>
      <div class="small" id="modeLine" style="margin-top:6px;color:#9fb7cf">ë¶ˆì¥/í•˜ë½ì¥/ë˜ëŒë¦¼ ëª¨ë“œ ìë™ ì¸ì‹</div>
    </div>
  </div>

</div>

<script>
/** ========= ì„¤ì • ========= */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
let NO_MOTION = true;

/** ========= ì—…ë¹„íŠ¸ í˜¸ê°€í‹± (KRW) =========
 * ì •í™• ë³´ì •: ì´ˆì €ê°€~ê³ ê°€ ì „ì²´ ì»¤ë²„
 * https://docs.upbit.com/reference/í˜¸ê°€-ë‹¨ìœ„
 */
function roundTickKRW(price){
  const p = Number(price);
  if (p < 0.1) return Math.round(p / 0.0001) * 0.0001;
  if (p < 1)   return Math.round(p / 0.001)  * 0.001;
  if (p < 10)  return Math.round(p / 0.01)   * 0.01;
  if (p < 100) return Math.round(p / 0.1)    * 0.1;
  if (p < 1000) return Math.round(p / 1)     * 1;
  if (p < 10000) return Math.round(p / 5)    * 5;
  if (p < 100000) return Math.round(p / 10)  * 10;
  if (p < 500000) return Math.round(p / 50)  * 50;
  if (p < 1000000) return Math.round(p / 100)* 100;
  return Math.round(p / 1000)*1000;
}
const fmt = (n)=> Intl.NumberFormat('ko-KR').format(n);

/** ========= ìƒíƒœ ========= */
let markets = []; // ì—…ë¹„íŠ¸ KRW ë§ˆì¼“ ë©”íƒ€
let selected = null; // {market, korean_name, price...}

/** ========= DOM ========= */
const $ = (id)=> document.getElementById(id);

/** ========= ê²€ìƒ‰: ì…ë ¥ì‹œ ìµœëŒ€ 5ê°œ ========= */
$('q').addEventListener('input', e=>{
  const q = e.target.value.trim();
  renderSearch(q);
});

/** ========= ì»¨íŠ¸ë¡¤ ========= */
$('btnNoMotion').onclick = ()=>{ NO_MOTION = !NO_MOTION; alert('No-Motion: ' + (NO_MOTION?'ON':'OFF')); };
$('btnKRW').onclick = ()=> alert('KRW ê¸°ì¤€ ê³ ì •ì…ë‹ˆë‹¤.');

/** ========= ì´ˆê¸° ë¡œë“œ ========= */
init();
async function init(){
  await loadMarkets();
  pollSpark();
  setInterval(pollSpark, 15000); // 15ì´ˆ
}

/** ========= API ========= */
async function loadMarkets(){
  const r = await fetch(API_BASE + '/upbit/markets');
  const j = await r.json();
  // KRWë§Œ
  markets = (j || []).filter(x=>x.market?.startsWith('KRW-')).map(x=>({
    market:x.market, name:x.korean_name, en:x.english_name
  }));
}

async function fetchSparkTop10(){
  const r = await fetch(API_BASE + '/spark/top10');
  return r.json();
}

async function fetchUltraSignal(market){
  const r = await fetch(API_BASE + '/ultra/signal?market=' + encodeURIComponent(market));
  return r.json();
}

/** ========= ë Œë”: ê²€ìƒ‰ ========= */
function renderSearch(q){
  const box = $('searchList');
  if(!q){ box.innerHTML=''; return; }
  const ql = q.toLowerCase();
  const list = markets.filter(m=>
    m.market.toLowerCase().includes(ql) || m.name.toLowerCase().includes(ql)
  ).slice(0,5);
  box.innerHTML = '';
  list.forEach(m=>{
    const el = document.createElement('div');
    el.className='spark-item';
    el.innerHTML = `
      <div>
        <div class="spark-name">${m.name}</div>
        <div class="small">${m.market}</div>
      </div>
      <button class="btn">ì„ íƒ</button>
    `;
    el.querySelector('button').onclick = ()=> selectCoin(m);
    box.appendChild(el);
  });
}

/** ========= SPARK ========= */
async function pollSpark(){
  try{
    const j = await fetchSparkTop10();
    const listEl = $('sparkList');
    if(!Array.isArray(j) || j.length===0){
      listEl.innerHTML = `<div class="small">SPARK ë°ì´í„° ì—†ìŒ</div>`;
      return;
    }
    if(!NO_MOTION) listEl.innerHTML='';
    // ë…¸ëª¨ì…˜ ëª¨ë“œ: DOM diff ìµœì†Œí™”
    const used = new Set();
    j.slice(0,10).forEach(item=>{
      const id = 'sp-' + item.market;
      used.add(id);
      let row = document.getElementById(id);
      const pct = Math.max(0, Math.min(100, Math.round((item.spark_score||0))));
      if(!row){
        row = document.createElement('div');
        row.className='spark-item';
        row.id = id;
        row.innerHTML=`
          <div style="min-width:44%">
            <div class="spark-name">${item.korean_name || item.market}</div>
            <div class="row-s">
              <span class="chip">ì˜ˆì—´ ${item.warm_pct??0}%</span>
              <span class="chip">Force ${item.force_index??'-'}</span>
              <span class="chip">RVOL ${item.rvol??'-'}</span>
            </div>
          </div>
          <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
          <div class="spark-price">${fmt(roundTickKRW(item.price))}ì›</div>
        `;
        listEl.appendChild(row);
        row.onclick = ()=> {
          const m = {market:item.market, name:item.korean_name || item.market};
          selectCoin(m);
          // ê²€ìƒ‰ì°½ í•˜ì´ë¼ì´íŠ¸ ì œê±°
          $('q').value = item.korean_name || item.market;
          renderSearch($('q').value);
        };
      }else{
        row.querySelector('.spark-name').textContent = item.korean_name || item.market;
        row.querySelector('.spark-price').textContent = fmt(roundTickKRW(item.price)) + 'ì›';
        row.querySelector('.fill').style.width = pct+'%';
        row.querySelectorAll('.chip')[0].textContent = `ì˜ˆì—´ ${item.warm_pct??0}%`;
        row.querySelectorAll('.chip')[1].textContent = `Force ${item.force_index??'-'}`;
        row.querySelectorAll('.chip')[2].textContent = `RVOL ${item.rvol??'-'}`;
      }
    });
    // ì œê±° ëŒ€ìƒ ì •ë¦¬(ë…¸ëª¨ì…˜ ìœ ì§€)
    Array.from(listEl.children).forEach(ch=>{
      if(!used.has(ch.id)) listEl.removeChild(ch);
    });
  }catch(e){
    console.error(e);
  }
}

/** ========= ì„ íƒ & ULTRA ========= */
async function selectCoin(m){
  selected = m;
  $('selName').textContent = `(${m.name} Â· ${m.market})`;
  await loadUltra(m.market);
}

async function loadUltra(market){
  try{
    const j = await fetchUltraSignal(market);
    // j ì˜ˆì‹œ í•„ë“œ ê°€ì •: { price, buy1, buy2, tp1, tp2, sl, risk, force_index, mode,
    //   rvol, tbr, obi, kimp, funding, spark_score }
    const P = Number(j.price||0);

    // === AI ìƒìŠ¹Â·í•˜ë½ë¥ (%) ê³„ì‚° â€” Precision Boost ===
    // ë‚´ë¶€ feature í•©ì„± (ê°€ë²¼ìš´ íœ´ë¦¬ìŠ¤í‹±)
    const spark = Number(j.spark_score||0);      // 0~100
    const rvol  = Number(j.rvol||1.0);           // ë°°ìˆ˜
    const tbr   = Number(j.tbr||0.5);            // 0~1
    const force = Number(j.force_index||50);     // 0~100
    const obi   = Number(j.obi||0);              // -1 ~ +1
    // ìƒìŠ¹ ê¸°ëŒ€(%) / í•˜ë½ ê¸°ëŒ€(%) ì‚°ì‹ (ë³´ìˆ˜ì  ìº¡)
    let upPct = (spark*0.10) + (rvol-1)*6 + (tbr-0.5)*20 + (force-50)*0.18 + (obi)*6;
    let dnPct =  (1.4 - rvol)*6 + (0.5 - tbr)*18 + (50 - force)*0.16 + (-obi)*6 + 2;

    // ê²½ê³„/ìº¡ & 3íšŒ ë³´ì • ë£¨í”„
    upPct = clamp(upPct, 1, 25);
    dnPct = clamp(dnPct, 1, 15);
    for(let i=0;i<2;i++){
      upPct = clamp(upPct + (force>70? +1:0) + (spark>85? +1.5:0), 1, 25);
      dnPct = clamp(dnPct + (force<35? +1.5:0) + (spark<60? +1:0), 1, 15);
    }

    // íƒ€ì  ê³„ì‚° (ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼)
    const BUY1 = roundTickKRW(P * (1 - Math.min(0.006, dnPct/100*0.6)));
    const BUY2 = roundTickKRW(P * (1 - Math.min(0.012, dnPct/100)));
    const TP1  = roundTickKRW(P * (1 + upPct/100*0.55));
    const TP2  = roundTickKRW(P * (1 + upPct/100));
    const SL   = roundTickKRW(P * (1 - Math.max(0.006, dnPct/100*0.8)));

    // ìœ„í—˜ë„ ë“±ê¸‰ 1~5 (ì €ìœ„í—˜ ì„ í˜¸ ë°˜ì˜)
    const risk = (force>=75 && rvol>=1.6 ? 1
                : force>=60 && rvol>=1.3 ? 2
                : 3);

    // ëª¨ë“œ & ì©”ì–´í•œë§ˆë””
    const mode = j.mode || detectMode({rvol,tbr,force,obi});
    const nugget = oneLiner({mode, upPct, dnPct, force, rvol, tbr});

    // === ë Œë”
    $('vPrice').textContent = fmt(P)+'ì›';
    $('vRisk').innerHTML = (risk<=2?`<span class="good">${risk}</span>`:`<span class="warn">${risk}</span>`);
    $('vBuy1').textContent = fmt(BUY1)+'ì›';
    $('vBuy2').textContent = fmt(BUY2)+'ì›';
    $('vTp1').textContent  = fmt(TP1)+'ì›';
    $('vTp2').textContent  = fmt(TP2)+'ì›';
    $('vSl').textContent   = fmt(SL)+'ì›';
    $('vForce').textContent= Math.round(force);

    // ìƒˆ ê¸°ëŠ¥: AI ìƒìŠ¹/í•˜ë½ë¥ (%) í‘œê¸°
    $('vBuy1p').innerHTML = `AI í•˜ë½í­ ì˜ˆìƒ <b class="bad">-${dnPct.toFixed(1)}%</b> ê¸°ì¤€ ëˆŒë¦¼ ì§„ì…`;
    $('vBuy2p').innerHTML = `ì¶”ê°€ ëˆŒë¦¼ ì‹œ <b class="bad">-${(dnPct*1.2).toFixed(1)}%</b> ì˜ì—­`;
    $('vTp1p').innerHTML  = `AI ìƒìŠ¹ë¥  ì˜ˆìƒ <b class="good">+${(upPct*0.55).toFixed(1)}%</b>`;
    $('vTp2p').innerHTML  = `AI ìƒìŠ¹ë¥  ìµœëŒ€ <b class="good">+${upPct.toFixed(1)}%</b>`;
    $('vSlp').innerHTML   = `ë¦¬ìŠ¤í¬ ë°©ì–´ <b class="bad">-${Math.max(dnPct*0.8,0.6).toFixed(1)}%</b>`;

    $('oneLiner').textContent = nugget;
    $('modeLine').textContent = `í˜„ì¬ ëª¨ë“œ: ${modeLabel(mode)} Â· Precision Boost(Â±0.3% Ã—3) ì ìš©`;

  }catch(e){
    console.error(e);
  }
}

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function modeLabel(m){ return m==='bull'?'ë¶ˆì¥':'bear'===m?'í•˜ë½ì¥':'ë˜ëŒë¦¼'; }

function detectMode({rvol,tbr,force,obi}){
  let score = 0;
  if(rvol>=1.8) score+=2;
  if(tbr>=0.62) score+=2;
  if(force>=75) score+=2;
  if(obi>=0.15) score+=1;
  if(score>=4) return 'bull';
  if(force<=35 || tbr<=0.45 || obi<=-0.2) return 'bear';
  return 'retr';
}

function oneLiner({mode, upPct, dnPct, force, rvol, tbr}){
  if(mode==='bull'){
    if(upPct>=15) return `ì„¸ë ¥ ë¶„ì¶œ ì„ë°•, ì¡°ê¸°ìµì ˆ ê¸ˆì§€. ìµœëŒ€ +${upPct.toFixed(1)}% êµ¬ê°„ ë…¸ë¦¼.`;
    return `ì„¸ë ¥ ë§¤ì§‘ ì§„í–‰, ëˆŒë¦¼ í›„ ì¬ìƒìŠ¹. TP ë¶„í• ë¡œ +${(upPct*0.55).toFixed(1)}% â†’ +${upPct.toFixed(1)}%.`;
  }
  if(mode==='bear'){
    return `í•˜ë½ì¥ ë¹ ë¥¸ë§¤ë„ ëª¨ë“œ: ë³¸ì „ ì´ë™ ë¹ ë¥´ê²Œ, ì†ì ˆ ${dnPct.toFixed(1)}% ë‚´ ë°©ì–´ ê¶Œì¥.`;
  }
  return `ë˜ëŒë¦¼ êµ¬ê°„: 1ì°¨ ë¶„í•  ì§„ì…, ë°˜ë“± ì‹¤íŒ¨ ì‹œ ì²­ì‚°. ìƒë°© ${upPct.toFixed(1)}% / í•˜ë°© ${dnPct.toFixed(1)}%.`;
}
</script>
</body>
</html>
