<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>사토시의지갑 – 실시간 업비트 연동 (전설판)</title>
  <style>
    :root{--bg:#0f1115;--card:#161a22;--muted:#9aa4b2;--txt:#e7ecf3;--acc:#7dd3fc;--good:#22c55e;--bad:#ef4444}
    html,body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.6 system-ui,apple sd gothic neo,Segoe UI}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #242c3a;border-radius:12px;padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #23324a;color:#a9c1ff;font-size:12px}
    .sec h3{margin:0 0 8px}
    .flex{display:flex;gap:8px;align-items:center}
    input{background:#0c1220;border:1px solid #273247;border-radius:10px;color:#e8f0ff;padding:10px 12px;outline:none;width:220px}
    button{background:#193253;border:1px solid #2b537f;color:#e8f0ff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kimp{font-size:28px;font-weight:700}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hint{font-size:12px;color:#8fa1b7}
    .tag{font-size:12px;color:#9fb3c8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>💰 사토시의지갑 – 실시간 업비트 연동 <span class="tag">전설판</span></h1>

    <div class="flex" style="gap:10px;margin:10px 0 18px">
      <input id="q" placeholder="코인/심볼 검색… (예: 비트코인, BTC, ETH)"/>
      <button id="apply">적용</button>
      <div class="muted" id="status">프로세스 상태: <b class="mono" id="health">확인중…</b></div>
    </div>

    <div class="row">
      <section class="card sec" id="sec-kimp">
        <h3>💎 김치 프리미엄 <span class="pill mono" id="coin-pill">BTC</span></h3>
        <div class="grid" style="grid-template-columns: 160px 1fr;">
          <div class="muted">업비트 KRW:</div> <div class="mono" id="upbit">-</div>
          <div class="muted">글로벌 USD:</div> <div class="mono" id="g-usd">-</div>
          <div class="muted">USD/KRW:</div> <div class="mono" id="fx">-</div>
          <div class="muted">프리미엄(%):</div> <div class="kimp" id="kimp">-</div>
          <div class="muted">소스:</div> <div id="kimp-src" class="muted">-</div>
        </div>
        <div class="hint" style="margin-top:6px">CoinGecko / open.er-api.com / Upbit</div>
      </section>

      <section class="card sec" id="sec-onchain">
        <h3>🧠 온체인 TVL(ETH) <span class="pill">자동 폴백</span></h3>
        <div class="grid" style="grid-template-columns: 120px 1fr;">
          <div class="muted">TVL:</div> <div class="mono" id="tvl">-</div>
          <div class="muted">소스:</div> <div class="muted" id="tvl-src">-</div>
        </div>
        <div class="hint" style="margin-top:6px">DefiLlama 장애 시 /v2/chains로 자동 전환</div>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card sec">
        <h3>🍓 시그널</h3>
        <div class="grid" style="grid-template-columns: 120px 1fr;">
          <div class="muted">현재가:</div> <div class="mono" id="sig-price">-</div>
          <div class="muted">매수:</div>   <div class="mono" id="sig-buy">-</div>
          <div class="muted">매도:</div>   <div class="mono" id="sig-sell">-</div>
          <div class="muted">손절:</div>   <div class="mono" id="sig-stop">-</div>
          <div class="muted">위험도:</div> <div class="mono" id="sig-risk">-</div>
        </div>
        <div class="hint" style="margin-top:6px">※ 단순 계산형 참고지표(테스트). 실제 매매 책임은 본인에게 있습니다.</div>
      </section>

      <section class="card sec">
        <h3>💬 쩔어 한마디 <span class="pill">베타</span></h3>
        <div class="mono" id="one-liner">-</div>
        <div class="hint" style="margin-top:6px">업데이트: <span id="updated">-</span></div>
      </section>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="muted">영구 고정: <b>⚡ SPARK</b> (관심코인 고정표시)</div>
      <div id="spark" class="mono" style="margin-top:8px">SPARK: -</div>
    </div>
  </div>

<script>
const API_BASE = (location.origin.includes("pages.dev") || location.hostname.endsWith(".pages.dev"))
  ? "https://satoshi-proxy.mujukno1.workers.dev"
  : "https://satoshi-proxy.mujukno1.workers.dev"; // 필요하면 바꿔도 됨.

const $ = (id)=>document.getElementById(id);
const fmt = (n)=> Number(n).toLocaleString("ko-KR");

async function getJSON(u){ const r=await fetch(u); return r.json(); }

function symbolFromQuery(q){
  q = (q||"").trim().toUpperCase();
  if (!q) return "BTC";
  if (q.includes("비트")) return "BTC";
  if (q.includes("이더")) return "ETH";
  if (q.includes("솔라") || q==="SOL") return "SOL";
  return q.length<=5 ? q : "BTC";
}

function buildSignal(up, usd, fx){
  const usdk = usd*fx;
  const prem = (up/usdk - 1)*100;
  const buy  = up * (prem<-1 ? 0.992 : 0.996);
  const sell = up * (prem> 1 ? 1.008 : 1.004);
  const stop = up * 0.985;
  const risk = Math.min(99, Math.abs(prem).toFixed(1));
  return { price: up, buy, sell, stop, risk, prem };
}

async function refresh(symbol="BTC"){
  $("coin-pill").textContent = symbol;

  // health
  try {
    const h = await getJSON(`${API_BASE}/api/health`);
    $("health").textContent = h.ok? "정상":"오류";
  } catch { $("health").textContent = "오류"; }

  // premium
  const prem = await getJSON(`${API_BASE}/api/premium?symbol=${symbol}`);
  if (prem.ok){
    $("upbit").textContent = fmt(prem.upbitPrice)+" KRW";
    $("g-usd").textContent = fmt(prem.globalUsd)+" USD";
    $("fx").textContent   = fmt(prem.usdkrw);
    $("kimp").textContent = (prem.premiumPct>0?"+":"") + prem.premiumPct + " %";
    $("kimp").className = "kimp " + (prem.premiumPct>=0 ? "bad" : "good");
    $("kimp-src").textContent = `${prem.global} / ${prem.fx} / ${prem.krw}`;

    const s = buildSignal(prem.upbitPrice, prem.globalUsd, prem.usdkrw);
    $("sig-price").textContent = fmt(s.price)+" KRW";
    $("sig-buy").textContent   = fmt(s.buy.toFixed(0))+" KRW";
    $("sig-sell").textContent  = fmt(s.sell.toFixed(0))+" KRW";
    $("sig-stop").textContent  = fmt(s.stop.toFixed(0))+" KRW";
    $("sig-risk").textContent  = s.risk+" %";

    $("one-liner").textContent =
      s.prem>1 ? "프리미엄 과열, 분할 매도 구간 탐색"
               : s.prem<-1 ? "역프리미엄, 분할 매수 구간 탐색"
                           : "중립 구간, 관망 또는 박스 트레이딩";
    $("updated").textContent = (prem.updatedAt||"").replace("T"," ").replace("Z","");
  } else {
    $("kimp").textContent = "-"; $("kimp-src").textContent="오류";
  }

  // onchain (ETH 고정 표시, 입력 심볼이 ETH면 동일)
  const on = await getJSON(`${API_BASE}/api/onchain?symbol=ETH`);
  if (on.ok){
    $("tvl").textContent = fmt(on.tvl)+" USD";
    $("tvl-src").textContent = `${on.src} @ ${on.chain}`;
  } else {
    $("tvl").textContent = "-";
    $("tvl-src").textContent = "오류";
  }

  // SPARK 고정 라벨(표시용, 데이터 더 붙이면 이 블록 확장 가능)
  $("spark").textContent = "SPARK: 관심코인 고정 – 시그널/알림 연동 예정";
}

$("apply").onclick = ()=>{
  const sym = symbolFromQuery($("q").value);
  refresh(sym);
};
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("apply").click(); });

refresh("BTC");
</script>
</body>
</html>
