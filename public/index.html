<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>쩔어지갑 · KRW 실시간 코인 타점</title>
<style>
:root{--bg:#0b0f14;--card:#0f151b;--line:#1e293b;--muted:#a3b1c2;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e6edf3;font-family:system-ui,Segoe UI,Roboto}
.wrap{max-width:1080px;margin:40px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px 18px;margin-top:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:#0a1220;border:1px solid #1f2a44;padding:8px 12px;border-radius:999px}
.green{color:var(--ok)} .red{color:var(--err)} .muted{color:var(--muted)}
input,button{height:40px;border-radius:10px;border:1px solid var(--line);background:#0c1420;color:#e6edf3;padding:0 12px}
button{cursor:pointer} table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:10px 8px;border-top:1px solid var(--line);text-align:left} small{opacity:.75}
.risk{padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
.risk.ok{color:var(--ok);border-color:#1d3b2a;background:#0d1f16}
.risk.warn{color:var(--warn);border-color:#3a2d14;background:#1a140a}
.risk.dang{color:var(--err);border-color:#3b1f23;background:#1a0d0f}
.badge{display:inline-flex;gap:6px;align-items:center}
.spinner{width:14px;height:14px;border:2px solid #334155;border-top-color:#93c5fd;border-radius:50%;animation:sp .9s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.sub{font-size:13px;color:#94a3b8}
.k{opacity:.85}
</style>
</head>
<body>
<div class="wrap">
  <h2>KRW 코인 검색 · 매수/매도 타점</h2>

  <div class="card">
    <div class="row">
      <input id="q" placeholder="예: 비트코인, BTC, 비트코인캐시, BCH / KRW-ETH" />
      <button id="searchBtn">검색</button>
      <span id="systemBadge" class="pill">시스템: 확인중…</span>
      <span id="riskChip" class="risk">위험도: -</span>
      <span id="updatedAt" class="muted"><small></small></span>
      <span id="loader" class="badge" style="display:none"><span class="spinner"></span><small>불러오는 중…</small></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <span id="symPill" class="pill">ETH</span>
      <span>현재가: <b id="price">-</b></span>
      <span>등락: <b id="chg" class="muted">-</b></span>
      <span>매수: <b id="buy" class="muted">-</b></span>
      <span>매도: <b id="sell" class="muted">-</b></span>
    </div>
    <table>
      <thead><tr><th>지표</th><th>값</th><th>설명</th></tr></thead>
      <tbody>
        <tr>
          <td>김치 프리미엄</td>
          <td id="kimchi">-</td>
          <td class="muted">업비트 KRW-BTC vs 코인베이스 BTC-USD (환율 포함)</td>
        </tr>
        <tr>
          <td>온체인 자금흐름</td>
          <td id="onchain">-</td>
          <td class="muted">USDT·USDC·DAI 24h 유입/유출</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <div class="row" style="gap:6px;flex-wrap:wrap;">
      <button onclick="loadList('rising')">상승 TOP10</button>
      <button onclick="loadList('spike')">급등</button>
      <button onclick="loadList('dump')">급락</button>
      <button onclick="loadSpark()">스파크⚡</button>
      <button onclick="loadSpark(true)">스파크 히스토리</button>
      <span class="sub k">스파크: 최근 3분 상승률+거래량 폭증(캐시 10분 유지, 히스토리 30분)</span>
    </div>
    <table id="listTable" style="margin-top:8px;">
      <thead><tr><th>코인</th><th>현재가</th><th>등락</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
/* ===== KRW 호가단위 (업비트와 동일) ===== */
const $=(id)=>document.getElementById(id);
const pct=v=>`${v>0?'+':''}${(Number(v)||0).toFixed(2)}%`;
function tickSizeKRW(p){
  p=Number(p)||0;
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 5;
  if(p>=100)     return 1;
  if(p>=10)      return 0.1;
  if(p>=1)       return 0.01;
  if(p>=0.1)     return 0.001;
  return 0.0001;
}
const dec=(t)=>String(t).includes('.')?String(t).split('.')[1].length:0;
const roundTick=(v,t,dir='nearest')=>{
  const n=v/t; let r=n;
  if(dir==='down') r=Math.floor(n);
  else if(dir==='up') r=Math.ceil(n);
  else r=Math.round(n);
  return Number((r*t).toFixed(dec(t)));
};
const fmtKRW=(v)=>{const t=tickSizeKRW(v);return Number(v||0).toLocaleString('ko-KR',{minimumFractionDigits:dec(t),maximumFractionDigits:dec(t)})};

/* ===== 마켓 매핑 ===== */
let MARKET_MAP=null;
(async()=>{try{MARKET_MAP=(await (await fetch('/api/markets')).json()).map;}catch{}})();
function toMarket(t){
  const raw=(t||'').trim(); if(!raw) return 'KRW-ETH';
  const key=raw.toUpperCase().replace(/\s+/g,'').replace(/-/g,'');
  if(MARKET_MAP && MARKET_MAP[key]) return MARKET_MAP[key];
  if(key==='비트코인'||key==='BTC') return 'KRW-BTC';
  if(key==='이더리움'||key==='ETH') return 'KRW-ETH';
  if(key==='비트코인캐시'||key==='BCH') return 'KRW-BCH';
  if(/^KRW-[A-Z]+$/.test(raw.toUpperCase())) return raw.toUpperCase();
  return 'KRW-'+raw.toUpperCase();
}

/* ===== 위험도 간단 점수 ===== */
function riskScore(changePct, kimchiPct){
  if(kimchiPct==null) return {label:'관망', cls:'warn'};
  if(Math.abs(changePct)<0.8 && Math.abs(kimchiPct)<1.0) return {label:'관망', cls:'warn'};
  if(changePct>=1.2 && kimchiPct>=1.5) return {label:'주의', cls:'warn'};
  if(changePct<=-1.2 || kimchiPct>=4.0) return {label:'경고', cls:'dang'};
  return {label:'보통', cls:'ok'};
}

/* ===== 요약 로드/렌더 ===== */
async function loadSummary(market){
  const r=await fetch(`/api/summary?market=${encodeURIComponent(market)}`);
  if(!r.ok) throw new Error('summary http '+r.status);
  return r.json();
}

function renderSummary(s){
  const up=s?.upbit;
  if(up){
    const chg=(up.signed_change_price/up.prev_closing_price)*100;
    const tick=tickSizeKRW(up.trade_price);

    $('symPill').textContent=up.market.replace('KRW-','');
    $('price').textContent=fmtKRW(up.trade_price);
    $('chg').textContent=pct(chg); $('chg').className=chg>=0?'green':'red';

    // ✅ 스프레드 반영 타점 (업비트 호가 완전 일치)
    const N=2; // 필요하면 3~4로 조정
    const buyTarget = roundTick(up.bid_price - N*tick, tick, 'down');
    const sellTarget= roundTick(up.ask_price + N*tick, tick, 'up');
    $('buy').textContent=fmtKRW(buyTarget);
    $('sell').textContent=fmtKRW(sellTarget);

    const kp=s?.kimchi?.kimchi ?? null;
    const rk=riskScore(chg,kp);
    $('riskChip').textContent='위험도: '+rk.label;
    $('riskChip').className='risk '+rk.cls;
  }

  if(s?.kimchi?.kimchi!=null){
    const k=s.kimchi.kimchi; $('kimchi').textContent=pct(k);
    $('kimchi').className=k>=0?'green':'red';
  }else{$('kimchi').textContent='-';$('kimchi').className='muted'}

  if(s?.onchain?.ok){
    const t=s.onchain.total;
    $('onchain').textContent=`₩${Number(t.mcapKRW).toLocaleString('ko-KR')} (${pct(t.change24h)}) ${t.risk||''}`;
    $('onchain').className=t.change24h<0?'red':(t.change24h>0?'green':'muted');
  }else{$('onchain').textContent='오류';$('onchain').className='red'}

  const ok=!!up && (s?.kimchi?.kimchi!=null);
  $('systemBadge').innerHTML=ok?"시스템: <b style='color:#22c55e'>OK</b>":"시스템: <b style='color:#ef4444'>오류</b>";
  $('updatedAt').innerHTML=`<small>${new Date().toLocaleTimeString()}</small>`;
}

/* ===== 주기 갱신 ===== */
let currentMarket='KRW-ETH', timer=null;
async function tick(){
  try{$('loader').style.display='inline-flex'; renderSummary(await loadSummary(currentMarket));}
  catch(e){console.error(e);$('systemBadge').innerHTML="시스템: <b style='color:#ef4444'>오류</b>";}
  finally{$('loader').style.display='none';}
}
document.getElementById('searchBtn').addEventListener('click', ()=>{
  currentMarket=toMarket(document.getElementById('q').value);
  clearInterval(timer); tick(); timer=setInterval(tick,1500);
});
tick(); timer=setInterval(tick,1500);

/* ===== 리스트/스파크 ===== */
async function loadList(type){
  $('loader').style.display='inline-flex';
  try{
    const j=await (await fetch(`/api/list?type=${type}`)).json();
    fillTable(j.list||[], type);
  } finally{$('loader').style.display='none';}
}
async function loadSpark(history=false){
  $('loader').style.display='inline-flex';
  try{
    const j=await (await fetch('/api/spark')).json();
    fillTable(history ? (j.history||[]) : (j.list||[]), history?'spark-his':'spark');
  } finally{$('loader').style.display='none';}
}
function fillTable(arr, mode){
  const tb=document.querySelector("#listTable tbody"); tb.innerHTML="";
  arr.forEach(c=>{
    const name=c.name ?? c.market?.replace('KRW-','') ?? '-';
    const price=c.price ?? c.price_krw ?? 0;
    let changeCell, cls;
    if(mode==='spark' || mode==='spark-his'){
      changeCell=`${pct(c.deltaPct)} · Vx${(c.volRatio||0).toFixed(1)}${mode==='spark-his'&&c.at?` · ${new Date(c.at).toLocaleTimeString()}`:''}`;
      cls=c.deltaPct>=0?'green':'red';
    }else{
      changeCell=pct(c.change); cls=c.change>=0?'green':'red';
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${name}</td><td>${fmtKRW(price)}</td><td class="${cls}">${changeCell}</td>`;
    tb.appendChild(tr);
  });
}
loadList('rising');
</script>



