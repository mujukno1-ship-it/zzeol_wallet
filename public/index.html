<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ (ì‹¤ì‹œê°„ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì )</title>
<style>
  :root{
    --bg:#0c0f14;--panel:#151a21;--muted:#8ea0b5;--text:#e7eef8;--good:#2bd576;--bad:#ff6b6b;--warn:#ffb020;--accent:#5ab0ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,AppleSDGothicNeo,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:grid;gap:16px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .card{background:var(--panel);border:1px solid #233041;border-radius:12px;padding:16px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#243141;color:#9bb2c9;font-size:12px}
  .btn{background:#1f2a38;border:1px solid #2a3a4d;color:#dbe8f5;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #2a3a4d;background:#10151c;color:#e7eef8}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #223243}
  th{color:#a9bed3;text-align:left}
  .right{text-align:right}
  .tag{display:inline-block;min-width:24px;text-align:center;padding:2px 8px;border-radius:8px}
  .risk0{background:#173a2a;color:#2bd576}.risk1{background:#1b3b1b;color:#2bd576}
  .risk2{background:#2f2a14;color:#ffb020}.risk3{background:#3d2a17;color:#ff9b20}
  .risk4{background:#3b1e1e;color:#ff6b6b}.risk5{background:#4a1d1d;color:#ff6b6b}
  .grid-head{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ <span class="pill" id="apiState">ì—°ê²° í™•ì¸ì¤‘â€¦</span></h1>

  <!-- ê²€ìƒ‰ -->
  <div class="card">
    <div class="grid-head">
      <strong>ê²€ìƒ‰</strong>
      <div class="muted">ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ / ê¹€í”„ / ì˜¨ì²´ì¸ / ì‹œê·¸ë„ ì—°ë™</div>
    </div>
    <div class="row g3">
      <div><input id="q" type="text" placeholder="ì˜ˆ) ë¹„íŠ¸ì½”ì¸, ë¹„íŠ¸ì½”ì¸ìºì‹œ, ì´ë”ë¦¬ì›€, ì†”ë¼ë‚˜, ì‹œë°”ì´ëˆ„â€¦" /></div>
      <div><button class="btn" id="btnSearch">ê²€ìƒ‰</button></div>
      <div><button class="btn" id="btnReset">ì´ˆê¸°í™”</button></div>
    </div>
    <div id="searchResult" style="margin-top:14px;display:none">
      <table>
        <thead>
          <tr>
            <th>ì½”ì¸</th><th class="right">í˜„ì¬ê°€</th><th class="right">ë§¤ìˆ˜</th><th class="right">ë§¤ë„</th>
            <th class="right">ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th>
          </tr>
        </thead>
        <tbody id="searchRows"></tbody>
      </table>
    </div>
  </div>

  <!-- ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ + ì˜¨ì²´ì¸ -->
  <div class="row g2" style="margin-top:16px">
    <div class="card">
      <div class="grid-head"><strong>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</strong><span class="muted" id="kpTime">-</span></div>
      <div class="row g3">
        <div>
          <div class="muted">ì—…ë¹„íŠ¸ KRW</div>
          <div id="kpKrw" style="font-size:18px">-</div>
        </div>
        <div>
          <div class="muted">ê¸€ë¡œë²Œ USD</div>
          <div id="kpUsd" style="font-size:18px">-</div>
        </div>
        <div>
          <div class="muted">í”„ë¦¬ë¯¸ì—„(%)</div>
          <div id="kpPct" style="font-size:18px">-</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">ì†ŒìŠ¤: CoinGecko Â· open-erapi Â· Upbit</div>
    </div>

    <div class="card">
      <div class="grid-head"><strong>ì˜¨ì²´ì¸ TVL (ETH)</strong><span class="pill" id="tvlAuto">ìë™ ë¡¤ë°±</span></div>
      <div class="row g3">
        <div>
          <div class="muted">TVL</div>
          <div id="tvl" style="font-size:18px">-</div>
        </div>
        <div>
          <div class="muted">ì†ŒìŠ¤</div>
          <div id="tvlSrc">-</div>
        </div>
        <div>
          <div class="muted">ì—…ë°ì´íŠ¸</div>
          <div id="tvlTime">-</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">DefiLlama ì¥ì•  ì‹œ /v2/chainsë¡œ ìë™ ì „í™˜</div>
    </div>
  </div>

  <!-- SPARK + ê´€ì‹¬ì½”ì¸ -->
  <div class="card" style="margin-top:16px">
    <div class="grid-head"><strong>âš¡ SPARK (ê¸‰ë“± ê°ì§€ Â· ìƒë‹¨ ê³ ì • TOP 10)</strong>
      <span class="muted">ìµœê·¼ 60ë¶„ ëŒ€ë¹„ ìƒìŠ¹ë¥  ê¸°ì¤€</span>
    </div>
    <table>
      <thead>
      <tr><th>ì½”ì¸</th><th class="right">í˜„ì¬ê°€</th><th class="right">60m</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th></tr>
      </thead>
      <tbody id="sparkRows"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="grid-head"><strong>â­ ê´€ì‹¬ì½”ì¸ (ìµœëŒ€ 10ê°œ)</strong>
      <div class="muted">ì½”ì¸ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì¶”ê°€/ì‚­ì œ</div>
    </div>
    <div id="favTags" class="muted">BTC ETH BCH XRP SOL DOGE MATIC AVAX LINK SHIB</div>
    <div style="margin-top:10px;overflow:auto">
      <table style="min-width:720px">
        <thead>
        <tr>
          <th>ì½”ì¸</th><th class="right">í˜„ì¬ê°€</th><th class="right">ë§¤ìˆ˜</th><th class="right">ë§¤ë„</th>
          <th class="right">ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th>
        </tr>
        </thead>
        <tbody id="favRows"></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="grid-head"><strong>ğŸ’¬ ì©”ì–´ í•œë§ˆë””</strong><span class="muted" id="aiTime">-</span></div>
    <div id="aiLine">ìƒë‹¨ ì €í•­ êµ¬ê°„, ë¶„í•  ë§¤ë„ ìœ ë¦¬</div>
  </div>

  <div class="muted" style="text-align:center;margin:20px 0 40px">
    Â© 2025 ì©”ì–´ì§„ê°‘ âˆ | ì—…ë¹„íŠ¸Â·ì˜¨ì²´ì¸Â·ê¹€í”„ ì‹¤ì‹œê°„ ì—°ë™
  </div>
</div>

<script>
/** â–‘ Front settings â–‘ */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev";  // â† â† â† â˜…â˜…â˜… ì—¬ê¸°ë§Œ ì—¬ëŸ¬ë¶„ì˜ Worker URLë¡œ êµì²´ â˜…â˜…â˜…
const FAVORITES_KEY = "zz_favorites";

/** â–‘ Utils â–‘ */
const fmtKRW = (n) => (n==null? "-" : Number(n).toLocaleString("ko-KR") + "ì›");
const fmtNum = (n, d=2) => (n==null? "-" : Number(n).toFixed(d));
const riskTag = (r) => `<span class="tag risk${r}">${r}</span>`;

// ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„
function tickKRW(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  return 0.0001;
}
const roundTick = (p) => Math.round(p / tickKRW(p)) * tickKRW(p);

// ê°„ë‹¨ íƒ€ì /ìœ„í—˜ë„(ê¹€í”„Â·ë³€ë™ì„± ê¸°ë°˜)
function decide(price, premiumPct){
  const risk =
    premiumPct > 3.5 ? 5 :
    premiumPct > 2.0 ? 4 :
    premiumPct > 1.0 ? 3 :
    premiumPct > 0.3 ? 2 :
    1;

  const buy  = roundTick(price * (risk>=4 ? 0.985 : risk>=3 ? 0.992 : 0.996));
  const sell = roundTick(price * (risk>=4 ? 1.012 : risk>=3 ? 1.008 : 1.004));
  const stop = roundTick(price * (risk>=4 ? 0.97  : risk>=3 ? 0.985 : 0.99 ));

  const verdict =
    risk >= 5 ? "ë§¤ë„ ì£¼ì˜, ì„¸ë ¥ êµ¬ê°„" :
    risk >= 4 ? "ë§¤ë„ ì£¼ì˜, ì„¸ë ¥ êµ¬ê°„" :
    risk >= 3 ? "ì¤‘ë¦½, ê´€ë§ êµ¬ê°„" :
    risk >= 2 ? "ì•ˆì •ì , ë§¤ìˆ˜ ê°€ëŠ¥" :
    "ì €ìœ„í—˜, ë¶„í• ë§¤ìˆ˜ êµ¬ê°„";

  return { risk, buy, sell, stop, verdict };
}

/** â–‘ API â–‘ */
async function jget(path){
  const r = await fetch(API_BASE + path, { cache:"no-store" });
  return r.json();
}
async function getPremium(sym){ return jget(`/api/premium?symbol=${encodeURIComponent(sym)}`) }
async function getOnchain(sym){ return jget(`/api/onchain?symbol=${encodeURIComponent(sym)}`) }
async function getSpark(){ return jget(`/api/spark`) }

/** â–‘ UI helpers â–‘ */
function rowHtml(sym, price, prem, adv){
  const d = decide(price, prem);
  return `<tr>
    <td>${sym}</td>
    <td class="right">${fmtKRW(price)}</td>
    <td class="right">${fmtKRW(d.buy)}</td>
    <td class="right">${fmtKRW(d.sell)}</td>
    <td class="right">${fmtKRW(d.stop)}</td>
    <td>${riskTag(d.risk)}</td>
    <td>${d.verdict}</td>
  </tr>`;
}

/** â–‘ App â–‘ */
const el = (id) => document.getElementById(id);
const $apiState = el("apiState");
const $kpKrw = el("kpKrw"), $kpUsd = el("kpUsd"), $kpPct = el("kpPct"), $kpTime = el("kpTime");
const $tvl = el("tvl"), $tvlSrc = el("tvlSrc"), $tvlTime = el("tvlTime");
const $sparkRows = el("sparkRows"), $favRows = el("favRows"), $favTags = el("favTags");
const $searchRows = el("searchRows"), $searchPanel = el("searchResult");

function getFavs(){ try { return JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]") } catch { return [] } }
function setFavs(a){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(a.slice(0,10))) }

async function boot(){
  // API ì—°ê²° í™•ì¸
  try {
    const h = await jget("/api/health");
    $apiState.textContent = h.ok ? "ì—°ê²° ì •ìƒ" : "ì—°ê²° ëŒ€ê¸°";
    $apiState.style.background = h.ok ? "#10361f" : "#3a1515";
  } catch {
    $apiState.textContent = "ì—°ê²° ì˜¤ë¥˜";
    $apiState.style.background = "#3a1515";
  }

  // ê¹€í”„(BTC)
  try {
    const p = await getPremium("BTC");
    if (p.ok){
      $kpKrw.textContent = fmtKRW(p.upbitPrice);
      $kpUsd.textContent = p.globalUsd ? `${p.globalUsd.toLocaleString()} USD` : "-";
      $kpPct.textContent = (p.premiumPct>0?"+":"")+fmtNum(p.premiumPct,2)+" %";
      $kpPct.style.color = p.premiumPct>0 ? "var(--bad)" : "var(--good)";
      $kpTime.textContent = new Date(p.updatedAt).toLocaleString();
    }
  } catch(e){ /* mute */ }

  // ì˜¨ì²´ì¸(ETH)
  try {
    const oc = await getOnchain("ETH");
    if (oc.ok){
      $tvl.textContent = oc.tvl? oc.tvl.toLocaleString()+" USD" : "-";
      $tvlSrc.textContent = `${oc.src} @ ${oc.chain}`;
      $tvlTime.textContent = new Date(oc.updatedAt).toLocaleString();
    } else {
      $tvl.textContent = "-"; $tvlSrc.textContent = "ì˜¤ë¥˜"; $tvlTime.textContent="-";
    }
  } catch(e){ $tvl.textContent="-"; }

  // SPARK
  try {
    const sp = await getSpark();
    if (sp.ok){
      $sparkRows.innerHTML = sp.rows.map(r=>{
        const d = decide(r.price, /*í”„ë¦¬ë¯¸ì—„ ëª¨ë¥¼ ë•ŒëŠ”*/ 1.2);
        return `<tr>
          <td>${r.symbol}</td>
          <td class="right">${fmtKRW(r.price)}</td>
          <td class="right" style="color:${r.changePct60m>=0?'var(--good)':'var(--bad)'}">${fmtNum(r.changePct60m,2)} %</td>
          <td>${riskTag(d.risk)}</td>
          <td>${d.verdict}</td>
        </tr>`;
      }).join("");
    }
  } catch(e){ /* mute */ }

  // ê´€ì‹¬ì½”ì¸ í‘œ
  await renderFavs();
}
async function renderFavs(){
  const favs = getFavs();
  if (!favs.length){ $favRows.innerHTML = ""; return; }
  const out = [];
  for (const sym of favs){
    try{
      const p = await getPremium(sym);
      if (p.ok) out.push(rowHtml(sym, p.upbitPrice, p.premiumPct));
    }catch{}
  }
  $favRows.innerHTML = out.join("");
}

// ê´€ì‹¬ì½”ì¸ í† ê¸€
$favTags.onclick = (e)=>{
  const t = e.target.textContent?.trim().toUpperCase();
  if (!t) return;
  let favs = getFavs();
  if (favs.includes(t)) favs = favs.filter(x=>x!==t);
  else {
    favs.unshift(t);
    favs = [...new Set(favs)].slice(0,10);
  }
  setFavs(favs);
  renderFavs();
};

// ê²€ìƒ‰
el("btnSearch").onclick = async ()=>{
  const q = el("q").value.trim();
  if (!q) return;
  // ì•„ì£¼ ê°„ë‹¨ ë§¤í•‘
  const map = {"ë¹„íŠ¸ì½”ì¸":"BTC","ë¹„íŠ¸ì½”ì¸ìºì‹œ":"BCH","ì´ë”ë¦¬ì›€":"ETH","ì´ë”ë¦¬ì›€í´ë˜ì‹":"ETC","ì†”ë¼ë‚˜":"SOL","ì‹œë°”ì´ëˆ„":"SHIB","ë„ì§€ì½”ì¸":"DOGE"};
  const sym = (map[q] || q).toUpperCase();
  try{
    const p = await getPremium(sym);
    if (p.ok){
      $searchRows.innerHTML = rowHtml(sym, p.upbitPrice, p.premiumPct);
      $searchPanel.style.display = "";
    }else{
      $searchRows.innerHTML = `<tr><td colspan="7">ê²€ìƒ‰ ì‹¤íŒ¨: ${p.error||"ì•Œ ìˆ˜ ì—†ìŒ"}</td></tr>`;
      $searchPanel.style.display = "";
    }
  }catch(e){
    $searchRows.innerHTML = `<tr><td colspan="7">ê²€ìƒ‰ ì—ëŸ¬</td></tr>`;
    $searchPanel.style.display = "";
  }
};
el("btnReset").onclick = ()=>{
  el("q").value = "";
  $searchPanel.style.display = "none";
  $searchRows.innerHTML = "";
};

// ì£¼ê¸° ê°±ì‹ 
boot();
setInterval(boot, 25_000);
</script>
</body>
</html>
