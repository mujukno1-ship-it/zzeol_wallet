<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>사토시의지갑 v9.3.0 – 분석기반 급등·급락 타점(한방)</title>
<style>
  :root{--bg:#0b0f14;--panel:#111823;--muted:#7c8aa5;--text:#e8eefc;--up:#22c55e;--down:#ef4444;--btn:#0f1b2e;--btnb:#2a3b57}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border:1px solid #1d2736;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  h2{margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border-radius:12px;border:1px solid var(--btnb);background:var(--btn);color:#dbe7ff}
  input{padding:12px 14px;flex:1;min-width:220px}
  button{padding:10px 12px;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
  thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
  tbody tr{background:#0e1520;border:1px solid #1d2a40}
  tbody td{padding:10px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  .price{font-variant-numeric:tabular-nums}
  .up{color:var(--up)} .down{color:var(--down)}
  .tag{font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #2a3956;color:#9fb6db;background:#111a27}
  .flex{display:flex;align-items:center;gap:8px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{padding:6px 10px;border-radius:999px;background:#151f2f;border:1px solid #25344f;font-size:12px}
  .status{margin-top:6px;font-size:12px;color:#9bb0d1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>🔎 코인 검색 (KRW 전용, 분석기반 급등·급락 타점)</h2>
    <div class="row">
      <input id="q" placeholder="코인명/티커 (예: 이더리움, ETH, KRW-ETH)">
      <button id="btnSearch">검색</button>
      <button id="btnTop">상승 TOP10</button>
      <button id="btnHot">급등(분석)</button>
      <button id="btnFall">급락(분석)</button>
      <button id="btnReset">초기화</button>
    </div>
    <div class="toolbar">
      <button id="btn1s">폴링 1초</button>
      <button id="btn2s">2초</button>
      <button id="btn5s">5초</button>
      <button id="btnStop">정지</button>
      <span class="badge">분석기준: ①1분 변동률 ±3% ②1분 거래대금이 10분 평균의 ×1.8배↑</span>
    </div>
    <div class="status" id="status">대기중…</div>

    <table>
      <thead>
        <tr>
          <th style="width:20%">코인</th>
          <th style="width:12%">현재가</th>
          <th style="width:10%">24h등락</th>
          <th style="width:12%">매수</th>
          <th style="width:12%">매도</th>
          <th style="width:12%">손절</th>
          <th style="width:8%">시그널</th>
          <th>분석(1분변동/거래가속)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>⚙️ 시스템 상태</h2>
    <div class="status">업비트 REST 직접 연동(CORS 허용). 프록시(/api/upbit) 없이 동작.</div>
  </div>
</div>

<script>
// ===== 설정 =====
const THRESH = { pct1mUp: 0.03, pct1mDown: -0.03, accel: 1.8, windowSec: 60, baselineMin: 600 }; // 10분=baseline
const POLL_DEFAULT = 1000;

// ===== 전역 =====
const el = {
  q: document.getElementById('q'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  btnSearch: document.getElementById('btnSearch'),
  btnTop: document.getElementById('btnTop'),
  btnHot: document.getElementById('btnHot'),
  btnFall: document.getElementById('btnFall'),
  btnReset: document.getElementById('btnReset'),
  btn1s: document.getElementById('btn1s'),
  btn2s: document.getElementById('btn2s'),
  btn5s: document.getElementById('btn5s'),
  btnStop: document.getElementById('btnStop'),
};

const UPBIT = {
  markets: 'https://api.upbit.com/v1/market/all?isDetails=true',
  ticker: (codes)=>`https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
};

const state = {
  markets: [],           // KRW-* only
  dict: {},              // 검색 사전
  pollMs: POLL_DEFAULT,
  timer: null,
  lastList: [],
  hist: new Map(),       // market -> [{ts, price, acc}]
};

// ===== 유틸 =====
function krwTick(p){
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 5;
  if(p>=100)     return 1;
  if(p>=10)      return 0.1;
  if(p>=1)       return 0.01;
  return 0.001;
}
function fmtKRW(p){
  const t=krwTick(p);
  const d=t>=1?0:t===0.1?1:t===0.01?2:3;
  return Number(p).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function setStatus(s){ el.status.textContent = s; }

// ===== 데이터 로드 =====
async function loadMarkets(){
  setStatus('마켓 목록 로드 중…');
  const res = await fetch(UPBIT.markets);
  const data = await res.json();
  const krw = data.filter(x=>x.market?.startsWith('KRW-'));
  state.markets = krw;
  state.dict = {};
  for(const m of krw){
    const keys = [
      m.market?.toLowerCase(),
      m.korean_name?.toLowerCase(),
      m.english_name?.toLowerCase(),
      m.korean_name?.replace(/\s+/g,'').toLowerCase(),
      m.english_name?.replace(/\s+/g,'').toLowerCase(),
    ].filter(Boolean);
    for(const k of keys){ (state.dict[k] ??= []).push(m); }
  }
  setStatus(`KRW 마켓 ${krw.length}종 로드 완료`);
}

// ===== 배치 ticker =====
async function fetchTicker(list){
  if(!list.length) return [];
  const codes = list.map(x=>x.market);
  const chunk = 100;
  const out = [];
  for(let i=0;i<codes.length;i+=chunk){
    const part = codes.slice(i,i+chunk);
    const r = await fetch(UPBIT.ticker(part));
    if(!r.ok) continue;
    out.push(...await r.json());
  }
  return out;
}

// ===== 히스토리 업데이트 & 1분 통계 =====
function updateHistory(tickers){
  const now = Date.now();
  for(const t of tickers){
    const key = t.market;
    const arr = state.hist.get(key) || [];
    arr.push({ts: now, price: t.trade_price, acc: t.acc_trade_price_24h||0});
    // 10분만 유지
    const cutoff = now - THRESH.baselineMin*1000;
    while(arr.length && arr[0].ts < cutoff) arr.shift();
    state.hist.set(key, arr);
  }
}

function oneMinStats(key){
  const now = Date.now();
  const arr = state.hist.get(key) || [];
  if(arr.length < 2) return null;

  // 1분 전 데이터 찾기(가장 가까운 과거 샘플)
  const targetTs = now - THRESH.windowSec*1000;
  let past = arr[0];
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i].ts <= targetTs){ past = arr[i]; break; }
    past = arr[0];
  }
  const cur = arr[arr.length-1];

  // 10분 baseline(분당 거래대금 평균)
  const tenMinAgoTs = now - THRESH.baselineMin*1000;
  const old = arr.find(x=>x.ts>=tenMinAgoTs) || arr[0];
  const delta10m = Math.max(0, (cur.acc - old.acc));
  const baselinePerMin = delta10m / Math.max(1, ( (cur.ts - old.ts)/60000 ));

  // 1분 변화
  const pricePct1m = past.price>0 ? (cur.price - past.price)/past.price : 0;
  const delta1m = Math.max(0, cur.acc - past.acc);
  const accel = baselinePerMin>0 ? (delta1m / baselinePerMin) : (delta1m>0? 99 : 0);

  return {pricePct1m, delta1m, accel, curPrice: cur.price};
}

// ===== 분석 기반 타점 =====
function levelsBySignal(ticker, type, stats){
  const p = Number(ticker.trade_price);
  const tk = krwTick(p);
  const pct = Math.abs(stats?.pricePct1m||0);

  // 틱/퍼센트 혼합 타점(분석형)
  const upTake   = Math.max(3*tk, p*0.006); // 익절폭
  const upStop   = Math.max(3*tk, p*0.004); // 손절폭
  const dnTake   = Math.max(3*tk, p*0.005);
  const dnStop   = Math.max(5*tk, p*0.008);

  if(type==='surge'){ // 급등 추격-돌파
    return {
      buy:  p - Math.max(tk, p*0.001),   // 살짝 눌림 진입
      sell: p + upTake,
      cut:  p - upStop,
      sig:  '급등',
      say:  `1m +${(pct*100).toFixed(1)}%, 가속 ${(stats.accel).toFixed(1)}×`
    };
  }else{              // 급락 역매수-반등
    return {
      buy:  p + Math.max(tk, p*0.001),   // 되돌림 확인 진입
      sell: p + dnTake,
      cut:  p - dnStop,
      sig:  '급락',
      say:  `1m ${(stats.pricePct1m*100).toFixed(1)}%, 가속 ${(stats.accel).toFixed(1)}×`
    };
  }
}

// ===== 렌더 =====
function renderRows(rows){
  el.tbody.innerHTML='';
  for(const r of rows){
    const cls = r.ticker.signed_change_rate>=0? 'up':'down';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="flex"><span class="tag">${r.market.replace('KRW-','')}</span> ${r.name}</td>
      <td class="price ${cls}">${fmtKRW(r.ticker.trade_price)}</td>
      <td class="${cls}">${(r.ticker.signed_change_rate*100).toFixed(2)}%</td>
      <td class="price">${fmtKRW(r.levels.buy)}</td>
      <td class="price">${fmtKRW(r.levels.sell)}</td>
      <td class="price down">${fmtKRW(r.levels.cut)}</td>
      <td>${r.levels.sig}</td>
      <td>${r.levels.say}</td>
    `;
    el.tbody.appendChild(tr);
  }
  if(!rows.length){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td colspan="8" class="status">조건에 맞는 코인이 없습니다.</td>`;
    el.tbody.appendChild(tr);
  }
}

// ===== 검색/필터 =====
function searchLocal(q){
  if(!q) return state.markets.slice(0,20);
  const key=q.trim().toLowerCase();
  let list = state.dict[key] ? [...state.dict[key]] : [];
  if(list.length===0){
    list = state.markets.filter(m=>
      m.market.toLowerCase().includes(key) ||
      m.korean_name.toLowerCase().includes(key) ||
      m.english_name.toLowerCase().includes(key)
    );
  }
  return list.slice(0,30);
}

// ===== 폴링 =====
async function poll(){
  try{
    const base = state.lastList.length? state.lastList : state.markets.slice(0,80); // 초기 80종 시세
    const tks = await fetchTicker(base);
    updateHistory(tks);
    // 일반 목록 렌더
    const rows = base.map(m=>{
      const tk = tks.find(x=>x.market===m.market);
      if(!tk) return null;
      const lv = levelsBySignal(tk,'surge',{pricePct1m:0, accel:0}); // 표시용 기본(기존과 동일 느낌)
      return {market:m.market, name:m.korean_name||m.english_name, ticker:tk, levels:lv};
    }).filter(Boolean);
    renderRows(rows);
    setStatus(`실시간 갱신 중… (주기 ${state.pollMs/1000}s)`);
  }catch(e){
    // 표기는 조용히, 콘솔만
    console.error(e);
  }
}
function start(){ stop(); state.timer=setInterval(poll, state.pollMs); poll(); }
function stop(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

// ===== 버튼 =====
el.btnSearch.onclick = async ()=>{
  const list = searchLocal(el.q.value);
  state.lastList = list;
  start();
};
el.q.onkeydown = e=>{ if(e.key==='Enter') el.btnSearch.click(); };

el.btnTop.onclick = async ()=>{
  setStatus('상승 TOP10 계산 중…');
  const tks = await fetchTicker(state.markets);
  updateHistory(tks);
  const top = [...tks].sort((a,b)=> b.signed_change_rate - a.signed_change_rate).slice(0,10);
  const markets = top.map(t=>t.market);
  const list = state.markets.filter(m=>markets.includes(m.market));
  const rows = list.map(m=>{
    const tk = top.find(x=>x.market===m.market);
    const lv = levelsBySignal(tk,'surge',{pricePct1m:0, accel:0});
    return {market:m.market, name:m.korean_name||m.english_name, ticker:tk, levels:lv};
  });
  renderRows(rows);
  setStatus('상승 TOP10');
};

// ★ 분석기반 급등
el.btnHot.onclick = async ()=>{
  setStatus('급등(분석) 탐색 중…');
  const tks = await fetchTicker(state.markets);
  updateHistory(tks);
  const rows=[];
  for(const m of state.markets){
    const tk = tks.find(x=>x.market===m.market);
    if(!tk) continue;
    const st = oneMinStats(m.market);
    if(!st) continue;
    if(st.pricePct1m >= THRESH.pct1mUp && st.accel >= THRESH.accel){
      const lv = levelsBySignal(tk,'surge',st);
      rows.push({market:m.market, name:m.korean_name||m.english_name, ticker:tk, levels:lv});
    }
  }
  rows.sort((a,b)=> (b.levels.curPrice??b.ticker.trade_price) - (a.levels.curPrice??a.ticker.trade_price));
  renderRows(rows.slice(0,20));
  setStatus(`급등(1m +3% & 가속 ≥1.8×) — ${rows.length}건`);
};

// ★ 분석기반 급락
el.btnFall.onclick = async ()=>{
  setStatus('급락(분석) 탐색 중…');
  const tks = await fetchTicker(state.markets);
  updateHistory(tks);
  const rows=[];
  for(const m of state.markets){
    const tk = tks.find(x=>x.market===m.market);
    if(!tk) continue;
    const st = oneMinStats(m.market);
    if(!st) continue;
    if(st.pricePct1m <= THRESH.pct1mDown && st.accel >= THRESH.accel){
      const lv = levelsBySignal(tk,'drop',st);
      rows.push({market:m.market, name:m.korean_name||m.english_name, ticker:tk, levels:lv});
    }
  }
  rows.sort((a,b)=> (a.ticker.signed_change_rate - b.ticker.signed_change_rate));
  renderRows(rows.slice(0,20));
  setStatus(`급락(1m -3% & 가속 ≥1.8×) — ${rows.length}건`);
};

el.btnReset.onclick = ()=>{
  el.q.value='';
  state.lastList = state.markets.slice(0,80);
  start();
};
el.btn1s.onclick = ()=>{ state.pollMs=1000; start(); };
el.btn2s.onclick = ()=>{ state.pollMs=2000; start(); };
el.btn5s.onclick = ()=>{ state.pollMs=5000; start(); };
el.btnStop.onclick = ()=>{ stop(); setStatus('일시정지'); };

// ===== 시작 =====
(async function init(){
  await loadMarkets();
  state.lastList = state.markets.slice(0,80);
  start();
})();
</script>
</body>
</html>
