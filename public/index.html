<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사토시의지갑 — 대시보드 (한방버전)</title>
  <style>
    :root{
      --bg:#0c0f14; --panel:#12161d; --card:#161b24; --muted:#778; --txt:#e8ecf1; --ok:#2bd576; --bad:#ff5d6c; --chip:#1f2531;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:18px;margin:0 0 16px}
    .bar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    input[type=text]{background:var(--panel);border:1px solid #222a36;border-radius:10px;color:var(--txt);padding:10px 12px;width:100%}
    .btn{background:#1e293b;border:0;color:#dbe4ee;padding:10px 14px;border-radius:10px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #1c2330;border-radius:14px;padding:12px}
    .title{display:flex;justify-content:space-between;font-weight:600;margin-bottom:10px}
    .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:540px;overflow:auto}
    .row{display:flex;justify-content:space-between;gap:8px;background:var(--chip);border:1px solid #263044;border-radius:10px;padding:10px;cursor:pointer}
    .row:hover{outline:1px solid #2a3a55}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;margin-top:6px}
    .chip{background:#0e1320;border:1px solid #2a3550;border-radius:10px;padding:8px 10px;margin-top:6px;display:inline-block}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>사토시의지갑 — 대시보드</h1>

    <div class="bar">
      <input id="api" type="text" placeholder="API 베이스 (예: https://satoshi-proxy.xxx.workers.dev/api)" />
      <button id="save" class="btn">저장</button>
      <input id="q" type="text" placeholder="KRW-SHIB, 에이다, 시바이누…" />
      <button id="find" class="btn">검색</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="title"><div>🔥 SPARK TOP10 — 급등 전 예열코인</div><div class="muted">자동 30초 새로고침</div></div>
        <div id="sparkErr" class="muted" style="display:none"></div>
        <div id="spark" class="list"></div>
      </div>

      <div class="card">
        <div class="title"><div>⚡ ULTRA 시그널 — 선택된 코인</div><div class="muted" id="sel"></div></div>
        <div id="ultraErr" class="muted" style="display:none"></div>
        <div class="kv">
          <div class="muted">현재가</div><div id="price" class="mono">-</div>
          <div class="muted">변동률</div><div id="chg" class="mono">-</div>
          <div class="muted">매수(BUY1)</div><div id="buy1" class="mono">-</div>
          <div class="muted">익절1 (TP1)</div><div id="tp1" class="mono">-</div>
          <div class="muted">익절2 (TP2)</div><div id="tp2" class="mono">-</div>
          <div class="muted">손절 (SL)</div><div id="sl" class="mono">-</div>
          <div class="muted">ATR / ATR%</div><div id="atr" class="mono">-</div>
        </div>
        <div id="mode" class="chip mono">mode: -</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = { base:"", sel:null, timer:null };

    function loadBase(){
      const v = localStorage.getItem("API_BASE") || "";
      $("api").value = v;
      state.base = v;
    }
    function saveBase(){
      const v = $("api").value.trim().replace(/\/+$/,""); // 끝 슬래시 제거
      localStorage.setItem("API_BASE", v);
      state.base = v;
    }
    $("save").onclick = ()=>{ saveBase(); boot(); };

    function fmtKRW(n){
      if(n==null || isNaN(n)) return "-";
      return Number(n).toLocaleString("ko-KR",{maximumFractionDigits:4});
    }
    function pct(n){ return (n>0? "+" : "") + n.toFixed(2) + "%"; }

    async function api(path){
      if(!state.base){ throw new Error("API_BASE 미설정"); }
      const url = state.base + (path.startsWith("/")?"":"/") + path;
      const res = await fetch(url, {mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const j = await res.json();
      if(!j.ok) throw new Error(j.msg || "API 오류");
      return j;
    }

    async function drawSpark(){
      try{
        $("sparkErr").style.display="none";
        const j = await api("/spark?limit=10");
        const box = $("spark");
        box.innerHTML = "";
        j.items.forEach((it)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div><b>${it.korean_name}</b> <span class="muted mono">${it.market}</span></div>
            <div class="mono">${it.score.toFixed(2)} · <span class="${it.changePct>=0?"ok":"bad"}">${pct(it.changePct)}</span> · RVOL ${it.rvol.toFixed(2)}</div>
          `;
          row.onclick = ()=>loadUltra(it.market);
          box.appendChild(row);
        });
      }catch(e){
        $("sparkErr").textContent = "SPARK 불러오기 실패: " + e.message;
        $("sparkErr").style.display="block";
      }
    }

    async function loadUltra(market){
      try{
        $("ultraErr").style.display="none";
        state.sel = market;
        $("sel").textContent = market;
        const t = await api("/ticker?market="+encodeURIComponent(market));
        const u = await api("/ultra?market="+encodeURIComponent(market)+"&limit=120");
        $("price").textContent = fmtKRW(t.priceTick) + "원";
        $("chg").innerHTML = `<span class="${t.changePct>=0?"ok":"bad"}">${pct(t.changePct)}</span>`;
        $("buy1").textContent = fmtKRW(u.buy1) + "원";
        $("tp1").textContent = fmtKRW(u.tp1) + "원";
        $("tp2").textContent = fmtKRW(u.tp2) + "원";
        $("sl").textContent  = fmtKRW(u.sl)  + "원";
        $("atr").textContent = `${fmtKRW(u.atr)} / ${(u.atrPct||0).toFixed(2)}%`;
        $("mode").textContent = `mode: ${u.mode}`;
      }catch(e){
        $("ultraErr").textContent = "ULTRA 로딩 실패: " + e.message;
        $("ultraErr").style.display="block";
      }
    }

    $("find").onclick = ()=>{
      const q = $("q").value.trim().toUpperCase();
      if(!q) return;
      const market = q.startsWith("KRW-") ? q : ("KRW-" + q.replace(/^KRW-/,""));
      loadUltra(market);
    };

    function boot(){
      if(!state.base) return;
      drawSpark();
      if(state.timer) clearInterval(state.timer);
      state.timer = setInterval(drawSpark, 30000);
    }

    // 처음 로드
    loadBase();
    if(!state.base){
      // 샘플: 워커 도메인만 적으면 뒤에 /api 자동
      // 사용자가 API 입력시 끝에 /api를 붙이지 않았다면 자동 추가
      $("api").value = (location.protocol + "//" + location.host + "/api");
      saveBase();
    }else if(!/\/api$/.test(state.base)){
      $("api").value = state.base + "/api";
      saveBase();
    }
    boot();
  </script>
</body>
</html>
