// ===== 설정 =====
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // 필요 시 변경
let currentRisk = 1;

function setRiskButtons(risk){
  document.querySelectorAll(".risk-btn").forEach(btn=>{
    const active = Number(btn.dataset.risk) === risk;
    btn.style.background = active ? "#1d4ed8" : "#111827";
    btn.style.color = active ? "#fff" : "#e5e7eb";
    btn.style.borderColor = active ? "#1d4ed8" : "#374151";
  });
}

// 숫자 포맷(호가틱 감안해 소수 8자리까지만)
const fmt = (v) => (v===null||v===undefined) ? "—" : (Math.abs(v) >= 1 ? v.toLocaleString() : v.toFixed(8));

// 상태 표시
function setStatus(msg, ok=true){
  const el = document.getElementById("ultra-status");
  if (!el) return;
  el.textContent = msg;
  el.style.color = ok ? "#9ca3af" : "#f87171";
}

// 렌더
function renderUltra(data){
  const card = document.getElementById("ultra-card");
  if (!card) return;

  const row = data.rows?.[0] || {};
  card.style.display = "block";

  const modeEl = document.getElementById("ultra-mode-badge");
  const accEl  = document.getElementById("ultra-acc-badge");
  const ntEl   = document.getElementById("ultra-nt-badge");
  const riskEl = document.getElementById("ultra-risk");

  const mode = row.mode || "NEUTRAL";
  modeEl.textContent = `MODE: ${mode}`;
  if (mode === "BULL"){ modeEl.style.background="#052e16"; modeEl.style.borderColor="#14532d"; }
  else if (mode === "BEAR"){ modeEl.style.background="#3f1d1d"; modeEl.style.borderColor="#7f1d1d"; }
  else { modeEl.style.background="#111827"; modeEl.style.borderColor="#374151"; }

  const accPct = Math.round((row.accuracy || 0)*100);
  accEl.textContent = `ACC: ${accPct}% (th ${Math.round((row.threshold||0)*100)}%)`;

  if (row.no_trade){ ntEl.style.display="inline-block"; ntEl.textContent="NO-TRADE"; }
  else { ntEl.style.display="none"; }

  document.getElementById("ultra-last").textContent = `last: ${fmt(row.last)} KRW`;
  document.getElementById("ultra-buy1").textContent = fmt(row.buy1);
  document.getElementById("ultra-buy2").textContent = fmt(row.buy2);
  document.getElementById("ultra-sell1").textContent = fmt(row.sell1);
  document.getElementById("ultra-sell2").textContent = fmt(row.sell2);
  document.getElementById("ultra-stop").textContent = fmt(row.stop);
  document.getElementById("ultra-tick").textContent = fmt(row.tick);
  riskEl.textContent = row.risk ?? currentRisk;
}

async function loadSignalUltra(){
  const market = (document.getElementById("ultra-market").value || "").trim();
  const th = Number(document.getElementById("ultra-th").value || 0.80);
  if (!market){ setStatus("마켓을 입력해주세요. 예: KRW-SHIB", false); return; }

  setStatus("불러오는 중…");
  try{
    const url = `${API_BASE}/signal_ultra?market=${encodeURIComponent(market)}&risk=${currentRisk}&threshold=${th.toFixed(2)}`;
    const res = await fetch(url);
    const json = await res.json();

    if (!res.ok || !json.ok){ throw new Error(json?.error || `HTTP ${res.status}`); }

    renderUltra(json);
    setStatus("완료.");
  }catch(err){
    setStatus(`오류: ${err.message || err}`, false);
  }
}

// 이벤트 바인딩
(function initUltraUI(){
  const runBtn = document.getElementById("ultra-run");
  const marketInput = document.getElementById("ultra-market");

  if (runBtn) runBtn.addEventListener("click", loadSignalUltra);
  if (marketInput){
    marketInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") loadSignalUltra();
    });
  }
  document.querySelectorAll(".risk-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentRisk = Number(btn.dataset.risk) || 1;
      setRiskButtons(currentRisk);
      loadSignalUltra();
    });
  });

  setRiskButtons(currentRisk);
})();
