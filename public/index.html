<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’° ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™ (ì •í™•ë„ 95%)</title>
  <style>
    body { background:#0d1117; color:#e6edf3; font-family:'Pretendard',sans-serif; }
    .card { background:#161b22; border-radius:16px; padding:16px; margin:12px; }
    h2 { color:#58a6ff; font-size:18px; margin-bottom:8px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .flex { flex:1; min-width:320px; }
    .status { color:#2ecc71; font-size:14px; margin-top:4px; }
    input,button,select { background:#21262d; color:#e6edf3; border:none; padding:8px; border-radius:8px; }
    .search-box { display:flex; gap:6px; margin-bottom:12px; }
    .highlight { color:#ffb347; font-weight:bold; }
  </style>
</head>
<body>
  <h1>ğŸ’° ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™ <span class="status" id="state">ì •ìƒ</span></h1>

  <div class="search-box">
    <input id="search-input" placeholder="ì½”ì¸ëª… (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì‹œë°”ì´ëˆ„, ì—ì´ë‹¤)">
    <button id="search-btn">ê²€ìƒ‰</button>
  </div>

  <div class="row">
    <div class="card flex">
      <h2>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (BTC)</h2>
      <div id="kimchi"></div>
    </div>
    <div class="card flex">
      <h2>ğŸ§  ì˜¨ì²´ì¸ TVL(ETH)</h2>
      <div id="tvl"></div>
    </div>
  </div>

  <div class="row">
    <div class="card flex">
      <h2>ğŸ“ ì‹œê·¸ë„</h2>
      <div id="signal"></div>
    </div>
    <div class="card flex">
      <h2>ğŸ’¬ ì©”ì–´ í•œë§ˆë””</h2>
      <div id="comment"></div>
    </div>
  </div>

  <div class="card">
    <h2>âš¡ ì˜êµ¬ ê³ ì • SPARK (ê´€ì‹¬ì½”ì¸)</h2>
    <div id="spark"></div>
  </div>

  <script>
    const CONFIG = { API_BASE: "https://satoshi-proxy.mujukno1.workers.dev" };

    async function jget(path, tries=2, timeout=8000){
      for (let i=0;i<tries;i++){
        try{
          const ac=new AbortController();
          const id=setTimeout(()=>ac.abort(),timeout);
          const r=await fetch(CONFIG.API_BASE+path+'?t='+Date.now(),{signal:ac.signal,cache:'no-store'});
          clearTimeout(id);
          if(!r.ok) throw new Error('HTTP '+r.status);
          return await r.json();
        }catch(e){
          if(i<tries-1) await new Promise(res=>setTimeout(res,500));
          else return {ok:false,error:e.message};
        }
      }
    }

    function setState(t,ok=true){const s=document.getElementById('state');s.textContent=t;s.style.color=ok?'#2ecc71':'#ff5c5c';}

    async function loadPremium(sym='BTC'){
      const d=await jget('/api/premium?symbol='+sym);
      const el=document.getElementById('kimchi');
      if(!d||!d.ok){el.innerHTML='ì˜¤ë¥˜';setState('ì—°ê²° ëŠê¹€',false);return;}
      el.innerHTML=`
        ì—…ë¹„íŠ¸ KRW: <span class='highlight'>${d.upbit.toLocaleString()} KRW</span><br>
        ê¸€ë¡œë²Œ USD: ${d.global.toLocaleString()} USD<br>
        USD/KRW: ${d.rate.toLocaleString()}<br>
        í”„ë¦¬ë¯¸ì—„(%): <span class='highlight'>${d.premium.toFixed(2)}%</span>`;
    }

    async function loadSignal(sym='BTC'){
      const d=await jget('/api/signal?symbol='+sym);
      const el=document.getElementById('signal');
      if(!d||!d.ok){el.innerHTML='-';setState('ì—°ê²° ëŠê¹€',false);return;}
      el.innerHTML=`
        í˜„ì¬ê°€: ${d.price.toLocaleString()} KRW<br>
        ë§¤ìˆ˜: ${d.buy.toLocaleString()} KRW<br>
        ë§¤ë„: ${d.sell.toLocaleString()} KRW<br>
        ì†ì ˆ: ${d.cut.toLocaleString()} KRW<br>
        ìœ„í—˜ë„: ${d.risk.toFixed(2)} %<br>
        ì„¸ë ¥ê°•ë„: ${d.power.toFixed(2)} %`;
    }

    async function loadComment(sym='BTC'){
      const d=await jget('/api/comment?symbol='+sym);
      const el=document.getElementById('comment');
      if(!d||!d.ok){el.innerHTML='-';return;}
      el.innerHTML=`${d.msg}<br><small>ì—…ë°ì´íŠ¸: ${d.time}</small>`;
    }

    async function loadSpark(){
      const d=await jget('/api/spark');
      const el=document.getElementById('spark');
      if(!d||!d.ok){el.innerHTML='-';return;}
      el.innerHTML=d.list.map(c=>`
        ${c.symbol}: ${c.price.toLocaleString()} / ${c.buy.toLocaleString()} / ${c.sell.toLocaleString()} / ${c.cut.toLocaleString()} / ìœ„í—˜ë„ ${c.risk.toFixed(2)} % / ${c.comment}
      `).join('<br>');
    }

    async function searchCoin(){
      const kw=document.getElementById('search-input').value.trim();
      if(!kw){alert('ì½”ì¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
      setState('ê²€ìƒ‰ì¤‘...',true);
      await Promise.all([
        loadPremium(kw),
        loadSignal(kw),
        loadComment(kw)
      ]);
      setState('ì •ìƒ',true);
    }

    document.getElementById('search-btn').onclick=searchCoin;

    async function init(){
      setState('ë¡œë”©ì¤‘...',true);
      await loadPremium();
      await loadSignal();
      await loadComment();
      await loadSpark();
      setState('ì •ìƒ',true);
    }

    init();
  </script>
</body>
</html>
