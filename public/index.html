<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRW 코인 검색 · 매수/매도 타점</title>
  <style>
    :root{
      --bg:#0e0f13; --panel:#16181f; --text:#e6e6e6; --muted:#a0a4ad;
      --pos:#1ec780; --neg:#ff5577; --warn:#f5a524; --ok:#2fb3ff;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial;}
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 14px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    input[type=text]{background:#0c0d11; color:var(--text); border:1px solid #232634; padding:10px 12px; border-radius:10px; width:240px; outline:none;}
    button{background:#23283b; color:var(--text); border:0; padding:10px 14px; border-radius:10px; cursor:pointer}
    button.primary{background:#3856ff}
    .badge{padding:6px 10px; border-radius:999px; font-size:12px; background:#1b1f2a; color:#d5d8df}
    .badge.ok{background:#0f2b3d; color:#7dd3fc}
    .badge.warn{background:#3a2b12; color:#f6d28b}
    .badge.danger{background:#3a1117; color:#ffb3c2}
    .panel{background:var(--panel); border:1px solid #232634; border-radius:12px; overflow:hidden}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:14px 16px; border-bottom:1px solid #222532; text-align:left; font-size:14px}
    th{color:#9aa0ab; width:140px; font-weight:600}
    td.val{width:180px; font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    .ticker{margin:10px 0 16px; color:#b6bbc6; font-size:13px}
    .one{margin-top:10px; padding:12px 14px; border-radius:10px; background:#10131a; border:1px dashed #2a2e3d; color:#dfe4ee; font-size:14px}
    .minh{min-height: 420px;} /* 데이터 로딩/오류 때 화면 덜 움직이도록 */
    .foot{margin-top:16px; color:#717786; font-size:12px}
    a{color:#7dd3fc; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KRW 코인 검색 · 매수/매도 타점</h1>

    <div class="row" style="margin-bottom:10px">
      <input id="q" type="text" placeholder="예: 비트코인, BTC, KRW-ETH" />
      <button id="btn" class="primary">검색</button>
      <span id="sys" class="badge">시스템: 대기</span>
      <span id="risk" class="badge">위험도: -</span>
      <span id="ts" class="muted" style="font-size:12px"></span>
    </div>

    <div id="ticker" class="ticker">-</div>

    <div class="panel minh">
      <table>
        <tbody id="rows">
          <tr><th>코인</th><td class="val" id="sym">-</td><td class="muted">현재가격/등락</td></tr>
          <tr><th>현재가</th><td class="val" id="price">-</td><td class="muted">매수/매도 타점 기준</td></tr>
          <tr><th>등락</th><td class="val" id="chg">-</td><td class="muted">전일 대비 등락률</td></tr>
          <tr><th>김치 프리미엄</th><td class="val" id="kimchi">-</td><td class="muted">업비트 KRW-BTC vs 코인베이스 BTC-USD</td></tr>
          <tr><th>온체인 자금흐름</th><td class="val" id="onchain">-</td><td class="muted">Stablecoin 24h 순유입/유출</td></tr>
          <tr><th>매수 타점</th><td class="val" id="buy">-</td><td class="muted">권장 매수가격</td></tr>
          <tr><th>매도 타점</th><td class="val" id="sell">-</td><td class="muted">권장 매도가격</td></tr>
          <tr><th>손절 라인</th><td class="val" id="stop">-</td><td class="muted">위험 관리 기준 손절가</td></tr>
        </tbody>
      </table>
    </div>

    <div id="one" class="one">검색해 주세요.</div>
    <div class="foot">API: <a href="/api/summary?market=KRW-ETH" target="_blank">/api/summary</a> · 레이아웃 안정화/호가단위 반영 완료</div>
  </div>

<script>
/* ---------- 유틸 ---------- */
const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('ko-KR');
const pct = v => `${(Number(v)||0).toFixed(2)}%`;

/* 업비트 KRW 호가단위 반올림 */
function tickKRW(p){
  p = Number(p)||0;
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 1;
  if(p>=100)     return 0.1;
  if(p>=10)      return 0.01;
  if(p>=1)       return 0.001;
  return 0.0001;
}
const roundTick=(v,dir='nearest')=>{
  const t=tickKRW(v);
  const n=v/t;
  if(dir==='up') return Math.ceil(n)*t;
  if(dir==='down') return Math.floor(n)*t;
  return Math.round(n)*t;
};
const KRW = v => (v<1? v.toFixed(4) : fmt.format(Math.round(v)));

/* ---------- 상태 표시 ---------- */
function setSys(status){
  const el=$('#sys');
  el.className='badge';
  if(status==='OK'){ el.classList.add('ok'); el.textContent='시스템: OK';}
  else if(status==='WARN'){ el.classList.add('warn'); el.textContent='시스템: 점검';}
  else { el.textContent='시스템: 대기';}
}
function setRisk(r){
  const el=$('#risk'); el.className='badge';
  if(r==='danger'){ el.classList.add('danger'); el.textContent='위험도: 주의';}
  else if(r==='caution'){ el.classList.add('warn'); el.textContent='위험도: 주의';}
  else { el.classList.add('ok'); el.textContent='위험도: 보통';}
}

/* ---------- 렌더 ---------- */
function render(data){
  const d = data||{};
  const up = d.upbit||{};
  const price = Number(up.trade_price)||0;
  const change = (Number(up.signed_change_price)/Math.max(1,Number(up.prev_closing_price)))*100 || 0;
  const kimchi = ((d.kimchi&&d.kimchi.kimchi)!=null) ? Number(d.kimchi.kimchi) : 0;
  const flowKRW = Number(d.onchain && d.onchain.total) || 0;

  const buy  = roundTick(price*0.994,'nearest');
  const sell = roundTick(price*1.006,'nearest');
  const stop = roundTick(price*0.978,'nearest');

  $('#sym').textContent = (d.market||'').toUpperCase() || (up.market||'-');
  $('#price').textContent = KRW(price);
  $('#chg').innerHTML = (change>=0? `<span class="pos">+${pct(change)}</span>` : `<span class="neg">${pct(change)}</span>`);
  $('#kimchi').innerHTML = (kimchi>=0? `<span class="pos">+${kimchi.toFixed(2)}%</span>`:`<span class="neg">${kimchi.toFixed(2)}%</span>`);
  $('#onchain').innerHTML = flowKRW===0 ? '-' : (flowKRW>0? `<span class="pos">+${KRW(flowKRW)}</span>`:`<span class="neg">${KRW(flowKRW)}</span>`);
  $('#buy').textContent  = KRW(buy);
  $('#sell').textContent = KRW(sell);
  $('#stop').textContent = KRW(stop);

  const head = `(${(d.market||up.market||'-')}) 상승: ${pct(change)} · 김프: ${kimchi.toFixed(2)}% · 매수: ${KRW(buy)} · 매도: ${KRW(sell)} · 손절: ${KRW(stop)}`;
  $('#ticker').textContent = head;
  $('#ts').textContent = d.ts ? new Date(d.ts).toLocaleTimeString() : '';

  // 위험도 배지
  setRisk(d.risk||'neutral');

  // 쩔어 한마디
  let line = '';
  if(d.risk==='danger') line = '변동성 ↑ : 급등락 위험. 분할매수·짧은 손절 권장.';
  else if(d.risk==='caution') line = '주의 구간: 거래량 확인하며 진입.';
  else line = '보통 구간: 추세 따라 분할 접근 권장.';
  if (kimchi>4) line += ' 김치프리미엄 과열 주의.';
  if (flowKRW>0) line += ' 스테이블 유입 → 단기 매수 우세.';
  if (flowKRW<0) line += ' 스테이블 유출 → 단기 매도 우세.';
  $('#one').textContent = line || '분석 대기.';
}

/* ---------- 통신 ---------- */
let pending=false;
async function load(){
  if(pending) return;
  pending=true; setSys('WARN');
  try{
    const q = ($('#q').value||'ETH').trim().toUpperCase();
    const market = q.includes('KRW-') ? q : (q.length<=5? `KRW-${q}` : q);
    const res = await fetch(`/api/summary?market=${encodeURIComponent(market)}`, {cache:'no-store'});
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||'API 오류');
    render({
      ok:true,
      market:data.symbol||market,
      upbit:{
        market:data.symbol||market,
        trade_price:data.price,
        signed_change_price: (data.price*data.change/100),
        prev_closing_price: data.price/(1+data.change/100)
      },
      kimchi:{kimchi:data.kimchi},
      onchain:{total:data.onchain?data.onchain.total:0},
      risk:data.risk||'neutral',
      ts: Date.now()
    });
    setSys('OK');
  }catch(e){
    $('#ticker').textContent='-';
    $('#one').textContent='데이터 로드 실패. 서버 점검 중일 수 있습니다.';
    // 값만 초기화
    ['sym','price','chg','kimchi','onchain','buy','sell','stop'].forEach(id=>{$('#'+id).textContent='-';});
  }finally{
    pending=false;
  }
}

/* ---------- 이벤트 ---------- */
$('#btn').addEventListener('click', load);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });

// 첫 진입 자동 조회(ETH)
window.addEventListener('load', ()=>{
  $('#q').value='ETH';
  load();
});
</script>
 <!-- ⚡ 스파크 코인 항상 표시 -->
<section id="spark-section" style="margin-top:18px">
  <h3 style="margin:0 0 10px 0; color:#1ec780;">⚡ 스파크 코인</h3>
  <div class="panel">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#20232b;">
          <th style="padding:10px;">코인</th>
          <th style="padding:10px;">현재가</th>
          <th style="padding:10px;">3분 상승률</th>
          <th style="padding:10px;">거래량/평균</th>
          <th style="padding:10px;">시간</th>
        </tr>
      </thead>
      <tbody id="spark-body">
        <tr><td colspan="5" style="padding:12px; color:#9aa0ab;">스파크 코인 로딩 중...</td></tr>
      </tbody>
    </table>
  </div>
</section> 
</body>
</html>
