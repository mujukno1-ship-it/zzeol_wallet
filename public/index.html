<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 v11 — No-Motion 한방버전</title>
<style>
  :root{
    --bg:#0d1117;--panel:#151b23;--muted:#7d8590;--text:#e6edf3;
    --accent:#2f81f7;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji}
  /* No-Motion */
  *,*:before,*:after{transition:none!important;animation:none!important}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 12px 0;font-weight:700}
  .sub{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  /* 검색 박스 + 결과(최대 5개) */
  .search-wrap{position:relative;margin:10px 0 22px}
  .search-input{
    width:100%;max-width:780px;height:44px;border-radius:10px;padding:0 14px;
    background:#0f141b;border:1px solid var(--border);color:var(--text);font-size:16px;outline:none;
  }
  .results{
    position:absolute;left:0;top:48px; width:100%; max-width:780px;
    background:var(--panel); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; z-index:10; box-shadow:none;
  }
  .result-item{
    padding:9px 12px; cursor:pointer; border-top:1px solid #131922; font-size:14px;
  }
  .result-item:hover{background:#0f141b}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted)}
  /* 카드 */
  .card{
    background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0;
  }
  .card h2{margin:0 0 10px 0;font-size:16px}
  /* SPARK 리스트 */
  .spark-list{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .spark-item{padding:10px;border:1px solid #1a2330;border-radius:10px;background:#0f141b;cursor:pointer}
  .spark-item:hover{background:#101722}
  .score{font-weight:700;margin-left:6px}
  .bar{height:6px;background:#0e1620;border-radius:6px;margin-top:8px;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#ff7a7a,#ffb36b)}
<script>
// ---------- 시그널 표시 ----------
elSpark.addEventListener("click",(e)=>{
  const item = e.target.closest(".spark-item");
  if(!item) return;
  openSignal(item.dataset.market);
});

async function openSignal(market){
  elHeader.textContent = `${market} 분석중…`;
  elSignal.classList.add("hidden");
  elTPWrap.classList.add("hidden");
  elCmt.classList.add("hidden");
  try{
    const s = await fetchJSON(`${API}/ultra/signal?market=${encodeURIComponent(market)}`);
    CUR = s;
    // ① ‘쩔어 판단’으로 상승/하락 % 추정
    const est = estimateMove(s);
    CUR.__est = est; // {upPct,downPct,mode,atrPct}
    renderSignal(s, est);
  }catch(e){
    console.error(e);
    elHeader.textContent = "시그널 불러오기 실패";
  }
}

function renderKV(title,val,cls=""){
  return `<div class="kv ${cls}"><b>${title}</b><div>${val ?? "-"}</div></div>`;
}

function renderSignal(s, est){
  elHeader.textContent = `${s.korean_name} (${s.market})`;

  const base = s.price ?? 0;
  // ② ‘쩔어 판단’ %로 BUY/TP/SL 산출 (업비트 호가틱)
  //    - TP: base * (1 + up%)
  //    - SL: base * (1 - down%)
  //    - BUY1: base에서 하락여지의 40%만 당겨서 대기 (너무 깊게 안 줌)
  const tpPct   = est.upPct;
  const slPct   = est.downPct;
  const buyPull = Math.min(slPct*0.4, Math.max(0.6, (est.atrPct||2.0)*0.3)); // %
  const tp1  = roundTick(base*(1+tpPct/100), "up");
  const sl   = roundTick(base*(1-slPct/100), "down");
  const buy1 = roundTick(base*(1-buyPull/100), "down");

  const risk = s.risk ?? (est.mode==="bear"?4: est.mode==="bull"?2:3);

  elSignal.innerHTML = `
    ${renderKV("현재가",       `${fmt(base)}원`)}
    ${renderKV("위험도",       risk)}
    ${renderKV("예상상승(쩔어)", `+${tpPct.toFixed(1)}%`)}
    ${renderKV("예상하락(쩔어)", `-${slPct.toFixed(1)}%`)}
    ${renderKV("매수(BUY1)",   `${fmt(buy1)}원`)}
    ${renderKV("매수(BUY2)",   s.buy2?`${fmt(s.buy2)}원`:"-")}
    ${renderKV("익절(TP1)",    `${fmt(tp1)}원`)}
    ${renderKV("익절(TP2)",    s.tp2?`${fmt(s.tp2)}원`:"-")}
    ${renderKV("손절(SL)",     `${fmt(sl)}원`, "danger")}
    ${renderKV("세력지수",     s.force_index ?? "-")}
  `;
  elSignal.classList.remove("hidden");
  elTPWrap.classList.remove("hidden");

  const cmt = makeComment({
    base,
    upProb:s.upProb, downProb:s.downProb,
    rvol:s.rvol, tbr:s.tbr, force:s.force_index,
    aboveVWAP:s.above_vwap, mode:est.mode
  });
  elCmt.textContent = cmt;
  elCmt.classList.remove("hidden");

  // 칩 동작 (‘쩔어 판단’ 기본값에서 추가로 보정하고 싶을 때)
  $$(".tp").forEach(b=>b.onclick=()=>applyTP(+b.dataset.p, base));
  $$(".sl").forEach(b=>b.onclick=()=>applySL(+b.dataset.p, base));
  $("#tpApply").onclick=()=>{const v=+$("#tpIn").value; if(v>0) applyTP(v, base);};
  $("#slApply").onclick=()=>{const v=+$("#slIn").value; if(v>0) applySL(v, base);};
}

// ③ ‘쩔어 판단’ — 예상 상승/하락% 계산기
function estimateMove(s){
  // 입력 신호들(없으면 합리적 기본치)
  const price = s.price ?? 0;
  const rvol  = s.rvol ?? 1.0;        // 1.0=보통
  const tbr   = s.tbr ?? 0.5;         // 0~1 (0.5 중립)
  const force = s.force_index ?? 50;  // 0~100 (50 중립)
  const obi   = s.obi ?? 0;           // -1~+1
  const kimpU = (s.kimp_up===true) ? 1 : 0; // 0/1
  const atrPct = s.atr_pct ?? Math.min(3.0, Math.max(1.2, (s.atr_rank??50)/50*1.6)); // % 대체값

  // 방향 점수(−1~+1 근사)
  const dir = 0
    + 0.35*((tbr-0.5)/0.5)          // 체결 매수 우위
    + 0.30*((force-50)/50)          // 세력 지수
    + 0.20*(obi)                    // 호가 불균형
    + 0.10*(kimpU?0.4: -0.1);       // 김프 상승 가점(소폭)
  const dirClamped = Math.max(-1, Math.min(1, dir));

  // 변동성 계수 (RVOL, ATR%)
  const volBoost = 1 + Math.max(0, (rvol-1)*0.8);   // 1.0 ~ 1.8+
  const baseAmp  = atrPct * volBoost;               // 기본 진폭 (%)

  // 최종 예상 상승/하락 % (1%~15% 제한)
  const upPct   = clamp( baseAmp * (1 + Math.max(0,  dirClamped)*0.8), 1, 15 );
  const downPct = clamp( baseAmp * (1 + Math.max(0, -dirClamped)*0.8), 1, 15 );

  // 시장 모드 추정
  const mode = (dirClamped> 0.35 && rvol>=1.4) ? "bull"
             : (dirClamped<-0.35 && rvol>=1.2) ? "bear"
             : "retr";

  return { upPct, downPct, mode, atrPct };
}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
</script>
