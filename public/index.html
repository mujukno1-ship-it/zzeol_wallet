<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 â€” KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</title>
<style>
  :root{--bg:#0d141c;--panel:#121b26;--line:#1e2a3a;--text:#d9e6f2;--sub:#9fb2c8;--pill:#253244;--good:#1da83a;--warn:#e6b800;--hot:#c73232;--bar:#2f8cff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{font-weight:700;background:#142031;border:1px solid var(--line);padding:8px 12px;border-radius:12px}
  .api{margin-left:auto;color:var(--sub);font-size:12px}
  .api b{color:#7fb0ff}
  .search{display:flex;align-items:center;gap:10px}
  #q{flex:1;min-width:260px;background:#0f1823;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;outline:0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .title{display:flex;align-items:center;gap:8px;margin-bottom:10px;color:#b9cbe0}
  .title .dot{width:8px;height:8px;border-radius:50%;background:#ff974a;display:inline-block}
  #spark .coin{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer}
  .row{display:flex;align-items:center}
  .row.space{justify-content:space-between}
  .sym{font-weight:700;color:#cfe5ff}
  .kname{color:var(--sub);font-size:12px;margin-top:2px}
  .price{font-weight:700}
  .bar{height:6px;border-radius:6px;background:#0f1823;margin-top:8px;overflow:hidden;border:1px solid var(--line)}
  .bar i{display:block;height:100%;width:0;background:var(--bar)}
  .pill{display:inline-block;background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:3px 8px;color:#cfe5ff;font-size:12px;margin-right:6px}
  .pill.hot{background:var(--hot);border-color:var(--hot);color:#fff}
  .kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .kv .box{border:1px solid var(--line);border-radius:12px;padding:10px}
  .kv .ttl{color:var(--sub);font-size:12px;margin-bottom:6px}
  .kv .val{font-weight:800}
  .pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
  .ment{margin-top:12px;padding:10px;border:1px dashed var(--line);border-radius:10px;color:#cfe5ff;background:#101a25}
  .muted{color:var(--sub)}
  footer{margin-top:14px;color:var(--sub);font-size:12px;text-align:center}
  #empty-msg{margin-top:8px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <span class="badge">ğŸ”</span>
    <div class="search"><input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰â€¦ (ì˜ˆ: ì—ì´ë‹¤ / ADA / KRW-ADA / ì‹œë°”ì´ëˆ„ / KRW-SHIB)" /></div>
    <div class="api">API: <b id="api-url"></b></div>
  </header>

  <div class="grid">
    <!-- SPARK -->
    <section class="card">
      <div class="title"><span class="dot"></span><b>SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸</b><span class="muted"> (ê³ ì •)</span></div>
      <div id="spark"></div>
      <div id="spark-cond" class="muted" style="margin-top:6px">ì˜ˆì—´ ì¡°ê±´: RVOLâ‰¥1.8 Â· TBRâ‰¥0.60 Â· OBIâ‰¥+0.15 Â· ìµœê·¼5ë¶„ ë³€ë™ë¥ â‰¥+1.5% (4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ í™•ì •)</div>
    </section>

    <!-- ULTRA -->
    <section class="card">
      <div class="title">
        <span class="dot" style="background:#67d38d"></span>
        <b>ULTRA ì‹œê·¸ë„ â€” <span id="ul-title-name">ì„ íƒëœ ì½”ì¸</span></b>
      </div>
      <div class="kv">
        <div class="box"><div class="ttl">í˜„ì¬ê°€</div><div id="ul-price" class="val">-</div></div>
        <div class="box"><div class="ttl">ë§¤ìˆ˜ (BUY1)</div><div id="ul-buy1" class="val">-</div></div>
        <div class="box"><div class="ttl">ì¶”ê°€ë§¤ìˆ˜ (BUY2)</div><div id="ul-buy2" class="val">-</div></div>
        <div class="box"><div class="ttl">ìµì ˆ 1 (TP1)</div><div id="ul-tp1" class="val">-</div></div>
        <div class="box"><div class="ttl">ìµì ˆ 2 (TP2)</div><div id="ul-tp2" class="val">-</div></div>
        <div class="box"><div class="ttl">ì†ì ˆ (SL)</div><div id="ul-sl" class="val">-</div></div>
      </div>
      <div class="pills" style="margin-top:8px">
        <span class="pill" id="pill-name">-</span>
        <span class="pill" id="pill-score">ì˜ˆì—´ê°•ë„ -</span>
        <span class="pill" id="pill-prob">ìƒìŠ¹í™•ë¥  -</span>
        <span class="pill" id="pill-rise">ì˜ˆìƒìƒìŠ¹ë¥  -</span>
        <span class="pill" id="pill-risk">ìœ„í—˜ë„ -</span>
        <span class="pill" id="pill-retr">ë˜ëŒë¦¼ 0%</span>
      </div>
      <div id="ment" class="ment">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </section>
  </div>

  <footer>ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 Â· Precision Boost Â· ForceIndex_AI Â· Bull/Bear Mode Â· Free Alpha Pack Â· ë˜ëŒë¦¼% Â· No-Motion</footer>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 â€” ë©”ëª¨ë¦¬ ìµœì‹ íŒ ë°˜ì˜ ë‹¨ì¼íŒŒì¼
   ê¸°ì¤€: KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion
   ê¸°ëŠ¥: SPARK TOP10, ê²€ìƒ‰â†’ULTRA ê°•ì œ ê°±ì‹ , íƒ€ì (BUY/TP/SL), ë˜ëŒë¦¼% ì¹©/ë©˜íŠ¸,
        ë¶ˆì¥/í•˜ë½ì¥ ëª¨ë“œ ê·œì¹™, Precision Boost ìš”ì•½ ì ìš©
   API_BASE: ì‚¬í† ì‹œ í”„ë¡ì‹œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CONFIG = {
  API_BASE: "https://satoshi-proxy.mujukno1.workers.dev/api",
  SPARK_WINDOW: "5m",
  SPARK_LIMIT: 10,
  REFRESH_MS: 5000,
  FETCH_TIMEOUT_MS: 6000,
  RETRIES: 2
};
document.getElementById("api-url").textContent = CONFIG.API_BASE;

/* â”€â”€ ì—…ë¹„íŠ¸ í˜¸ê°€í‹±(ì €ê°€ì½”ì¸ ì™„ë²½ ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function krwTickStep(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p â‰¥ 100000)   return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  if (p >= 0.1)     return 0.0001;
  return 0.00001;
}
function roundTick(p){
  const s = krwTickStep(p);
  const r = Math.round(p / s) * s;
  const d = (s.toString().split('.')[1] || '').length;
  return Number(r.toFixed(d));
}
function fmtKRW(v){
  if (!isFinite(v)) return "-";
  const s = krwTickStep(v);
  const d = (s.toString().split(".")[1] || "").length;
  if (v >= 1000) return Math.round(v).toLocaleString("ko-KR") + "ì›";
  return v.toFixed(d) + "ì›";
}

/* â”€â”€ ê³µìš© fetch(íƒ€ì„ì•„ì›ƒ+ì¬ì‹œë„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchJSON(url, {timeout=CONFIG.FETCH_TIMEOUT_MS, retries=CONFIG.RETRIES}={}){
  for (let i=0;i<=retries;i++){
    const ctrl = new AbortController(); const tm = setTimeout(()=>ctrl.abort(), timeout);
    try{
      const r = await fetch(url, {signal: ctrl.signal}); clearTimeout(tm);
      if (!r.ok) throw new Error("HTTP "+r.status);
      return await r.json();
    }catch(e){ clearTimeout(tm); if (i===retries) throw e; await new Promise(res=>setTimeout(res, 250)); }
  }
}

/* â”€â”€ í•œê¸€ëª… ì‚¬ì „/ë³„ì¹­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const NAME = {"KRW-SHIB":"ì‹œë°”ì´ëˆ„","KRW-BTC":"ë¹„íŠ¸ì½”ì¸","KRW-ETH":"ì´ë”ë¦¬ì›€","KRW-XRP":"ë¦¬í”Œ","KRW-SOL":"ì†”ë¼ë‚˜","KRW-ADA":"ì—ì´ë‹¤","KRW-DOGE":"ë„ì§€ì½”ì¸","KRW-CHZ":"ì¹ ë¦¬ì¦ˆ","KRW-ONDO":"ì˜¨ë„"};
const ALIAS = {"ì‹œë°”ì´ëˆ„":"KRW-SHIB","shib":"KRW-SHIB","ì—ì´ë‹¤":"KRW-ADA","ada":"KRW-ADA","ë¦¬í”Œ":"KRW-XRP","xrp":"KRW-XRP","ì´ë”ë¦¬ì›€":"KRW-ETH","eth":"KRW-ETH","ë¹„íŠ¸ì½”ì¸":"KRW-BTC","btc":"KRW-BTC","ì†”ë¼ë‚˜":"KRW-SOL","sol":"KRW-SOL"};
async function loadKoreanNames(){
  try{
    const arr = await fetchJSON("https://api.upbit.com/v1/market/all?isDetails=true",{timeout:8000,retries:1});
    arr.filter(x=>x.market?.startsWith("KRW-")).forEach(x=> NAME[x.market]=x.korean_name);
  }catch(_){}
}

/* â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let TICKERS = new Map();   // market -> {price}
let LAST_SPARK = [];       // ìµœê·¼ SPARK ì•„ì´í…œë“¤
let SPARK_CACHE = [];      // DOM ìºì‹œ(ê²€ìƒ‰ í•„í„°ìš©)

/* â”€â”€ ì‹¤ì‹œê°„ ê°€ê²© ë²„í¼(ë˜ëŒë¦¼% ê³„ì‚°ìš©, 15ë¶„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const PRICEBUF = new Map(); // market -> {arr:[], max:180}
function pushPrice(market, price){
  let slot = PRICEBUF.get(market);
  if(!slot){ slot = { arr: [], max: 180 }; PRICEBUF.set(market, slot); }
  if (price>0) { slot.arr.push(price); if (slot.arr.length>slot.max) slot.arr.shift(); }
}
function getRetrPct(market, fallbackPrice){
  const slot = PRICEBUF.get(market);
  const arr  = (slot && slot.arr.length>=5) ? slot.arr : null;
  const p    = Number(fallbackPrice||0);
  if(!arr) return { pct:0, band:"ë°ì´í„°ì ìŒ" };
  const H = Math.max(...arr), L = Math.min(...arr);
  if(!isFinite(H)||!isFinite(L)||H<=L) return { pct:0, band:"ë¬´ì˜ë¯¸" };
  const C = p>0 ? p : arr[arr.length-1];
  const pct = Math.max(0, Math.min(100, ((H - C) / (H - L)) * 100));
  let band="ì–•ìŒ"; if(pct>=35&&pct<65) band="ë³´í†µ"; else if(pct>=65) band="ê¹ŠìŒ";
  return { pct: Number(pct.toFixed(1)), band };
}

/* â”€â”€ ë°ì´í„° ë¡œë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchTickers(){
  const data = await fetchJSON(`${CONFIG.API_BASE}/upbit/tickers`);
  const m = new Map();
  for (const t of data){ const price = Number(t.tradePrice)||0; m.set(t.market,{price}); pushPrice(t.market, price); }
  TICKERS = m;
}
async function fetchSparkTop(){
  const urls = [
    `${CONFIG.API_BASE}/spark/top?window=${CONFIG.SPARK_WINDOW}&limit=${CONFIG.SPARK_LIMIT}`,
    `${CONFIG.API_BASE}/spark?window=${CONFIG.SPARK_WINDOW}&limit=${CONFIG.SPARK_LIMIT}`,
    `${CONFIG.API_BASE}/spark`
  ];
  for (const u of urls){
    try{
      const r = await fetchJSON(u);
      const arr = Array.isArray(r) ? r : (r.data||[]);
      if (Array.isArray(arr)) { LAST_SPARK = arr; return arr; }
    }catch(_){}
  }
  LAST_SPARK = []; return [];
}

/* â”€â”€ ì ìˆ˜â†’í™•ë¥ Â·ìƒìŠ¹ë¥ Â·ìœ„í—˜ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expectedRise(score){ if(score>=90) return 0.21; if(score>=80) return 0.10; if(score>=70) return 0.05; return 0.02; }
function riseProb(score){ if(score>=90) return 0.88; if(score>=80) return 0.72; if(score>=70) return 0.60; return 0.45; }
function riskLevel(score){ return (score>=80?2:(score>=70?3:4)); }

/* â”€â”€ ë¶ˆì¥/í•˜ë½ì¥ ëª¨ë“œ ê·œì¹™(ìš”ì•½ ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcTargetsByMode(cur, score, ctx){
  // ctx: {rvol,tbr,kimchi,force,vwapDistance,basis,funding}
  // ê¸°ë³¸ í¼ì„¼íŠ¸ (ë©”ëª¨ë¦¬ ê·œì¹™ ë°˜ì˜)
  let tp1P=(score>=90?0.016:score>=80?0.012:0.008);
  let tp2P=(score>=90?0.028:score>=80?0.020:0.014);
  let slP =(score>=90?-0.008:score>=80?-0.010:-0.012);

  const bull = (ctx.rvol>=2.0)+(ctx.tbr>=0.65)+(ctx.kimchi>=3)+(ctx.force>=80)+(ctx.vwapDistance>=1.5) >= 3;
  const bear = (ctx.rvol>=1.4 && ctx.vwapBelow) || (ctx.tbr<=0.45) || (ctx.obi<=-0.2) || (ctx.force<=35) || (ctx.basis<0)|| (ctx.funding<0&&ctx.oiUp);

  if (bull){ tp1P=0.016; tp2P=0.028; slP=-0.008; }              // ë¶ˆì¥ ë°©ì–´ ëª¨ë“œ
  if (bear){ tp1P=0.006; tp2P=0.010; slP=-0.013; }              // í•˜ë½ì¥ ë¹ ë¥¸ë§¤ë„

  return {
    buy1: roundTick(cur*(1-0.003)),
    buy2: roundTick(cur*(1-0.008)),
    tp1 : roundTick(cur*(1+tp1P)),
    tp2 : roundTick(cur*(1+tp2P)),
    sl  : roundTick(cur*(1+slP))
  };
}

/* â”€â”€ ì©”ì–´í•œë§ˆë”” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildMent(item, retr){
  const { score=75, rvol=0, tbr=0, obi=0, market="KRW-?" } = item;
  const name = NAME[market] || market.replace("KRW-","");
  const retrTxt = ` ï½œ ë˜ëŒë¦¼ ${retr.pct}% (${retr.band})`;

  // ë˜ëŒë¦¼ êµ¬ê°„ ë©˜íŠ¸ ìš°ì„  ë°˜ì˜
  if ((score>=60 && score<=69) || (rvol>=1.2 && rvol<=1.8 && tbr>=0.48 && tbr<=0.58)) {
    const guide = (retr.band==="ê¹ŠìŒ" ? "ë¶„í• ë§¤ìˆ˜ 1ì°¨/ë¦¬ìŠ¤í¬ í™•ì¸" : retr.band==="ë³´í†µ" ? "ëˆŒë¦¼ì§„ì… ìœ íš¨" : "ì¶”ê²©ì£¼ì˜, TP ë³´ìˆ˜í™”");
    return `ğŸ”µ ë˜ëŒë¦¼ ì‹ í˜¸ â€” ${name} ${guide}${retrTxt}`;
  }
  if (score>=90) return `ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ${name} ì˜ˆì—´ê°•ë„ ${score} / ìƒìŠ¹í™•ë¥  ${(riseProb(score)*100|0)}% / ì˜ˆìƒìƒìŠ¹ë¥  +${(expectedRise(score)*100).toFixed(1)}%${retrTxt}`;
  if (score>=80) return `âš¡ ê°•ë ¥ ì˜ˆì—´ â€” ${name} ëª¨ë©˜í…€ ìš°ì„¸(TBR ${(tbr*100).toFixed(0)}%) Â· RVOL ${rvol.toFixed(2)} Â· ì˜ˆì—´ê°•ë„ ${score}${retrTxt}`;
  if (score>=70) return `ğŸŸ¡ ì˜ˆì—´ ì§„í–‰ â€” ${name} ê´€ë§ ë˜ëŠ” ì†ŒëŸ‰ ë¶„í•  ì§„ì… ê¶Œì¥ (OBI ${(obi*100).toFixed(0)}%)${retrTxt}`;
  return `ğŸ”µ ëŒ€ê¸° â€” ì‹ í˜¸ ì•½í•¨. ì¡°ê±´ ì¶©ì¡± ëŒ€ê¸° ê¶Œì¥${retrTxt}`;
}

/* â”€â”€ ë Œë”(SPARK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $spark = document.getElementById("spark");
function cacheSparkCards(){
  const cards = $spark.querySelectorAll('.coin');
  SPARK_CACHE = Array.from(cards).map(el=>{
    const market = el.getAttribute('data-market');
    const kname = el.querySelector('.kname')?.textContent?.trim() || '';
    return { el, market, kname, text: `${market} ${kname}`.toLowerCase() };
  });
}
function renderSpark(list){
  if (!list.length){
    $spark.innerHTML = `<div id="empty-msg" class="muted" style="padding:12px;border:1px dashed var(--line);border-radius:10px">SPARK ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ìë™ ì¬ì‹œë„ë©ë‹ˆë‹¤.</div>`;
    return;
  }
  $spark.innerHTML = list.slice(0,CONFIG.SPARK_LIMIT).map(item=>{
    const price = TICKERS.get(item.market)?.price || 0;
    const kname = NAME[item.market] || item.market.split('-')[1];
    const score = item.score|0; const w = Math.min(100,Math.max(0,score));
    const hot = score>=90 ? 'hot' : '';
    return `
      <div class="coin" data-market="${item.market}">
        <div class="row space">
          <div>
            <div class="sym">${item.market}</div>
            <div class="kname">${kname}</div>
          </div>
          <div class="price">${price? fmtKRW(roundTick(price)) : '-'}</div>
        </div>
        <div class="bar"><i style="width:${w}%"></i></div>
        <div style="margin-top:6px">
          <span class="pill ${hot}">SPARK ${score}</span>
          <span class="pill">RVOL ${item.rvol?.toFixed(2) ?? '-'}</span>
          <span class="pill">TBR ${(item.tbr*100).toFixed(0)}%</span>
        </div>
      </div>`;
  }).join("");
  $spark.querySelectorAll(".coin").forEach(el=>{
    el.onclick = ()=>{
      const m = el.getAttribute("data-market");
      const item = LAST_SPARK.find(x=>x.market===m) || {market:m,score:75,rvol:1.8,tbr:0.5,obi:0.1};
      selectUltra(item);
    };
  });
  cacheSparkCards();
}

/* â”€â”€ ULTRA í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function selectUltra(item){
  if (!item) return;
  const mkt   = item.market;
  const t     = TICKERS.get(mkt) || {};
  const cur0  = Number(t.price||0);
  const cur   = roundTick(cur0);
  const kname = NAME[mkt] || mkt.split("-")[1];

  // ì œëª©Â·ì¹©
  const set = id=>document.getElementById(id);
  const $title = document.getElementById("ul-title-name");
  if ($title) $title.textContent = `${kname} (${mkt})`;
  set("pill-name").textContent  = `${kname} (${mkt})`;
  set("ul-price").textContent   = fmtKRW(cur);

  // ë˜ëŒë¦¼ %
  const retr = getRetrPct(mkt, cur0);
  set("pill-retr").textContent  = `ë˜ëŒë¦¼ ${retr.pct}%`;

  // ë¶ˆì¥/í•˜ë½ì¥ ì»¨í…ìŠ¤íŠ¸(ìš”ì•½: ì™¸ë¶€ ì‹ í˜¸ê°€ ì—†ì„ ë•Œ ë³´ìˆ˜ê°’)
  const ctx = {
    rvol: Number(item.rvol||1.6),
    tbr:  Number(item.tbr||0.52),
    obi:  Number(item.obi||0.10),
    kimchi: 0, force: Number(item.force||item.score||75),
    vwapDistance: 1.0, vwapBelow: false,
    basis: 0, funding: 0, oiUp: false
  };
  const tg = calcTargetsByMode(cur, item.score|0, ctx);
  set("ul-buy1").textContent = fmtKRW(tg.buy1);
  set("ul-buy2").textContent = fmtKRW(tg.buy2);
  set("ul-tp1").textContent  = fmtKRW(tg.tp1);
  set("ul-tp2").textContent  = fmtKRW(tg.tp2);
  set("ul-sl").textContent   = fmtKRW(tg.sl);

  // ì¹©: ì ìˆ˜/í™•ë¥ /ìƒìŠ¹ë¥ /ìœ„í—˜ë„
  const score = item.score|0;
  set("pill-score").textContent = `ì˜ˆì—´ê°•ë„ ${score}`;
  set("pill-prob").textContent  = `ìƒìŠ¹í™•ë¥  ${Math.round(riseProb(score)*100)}%`;
  set("pill-rise").textContent  = `ì˜ˆìƒìƒìŠ¹ë¥  +${(expectedRise(score)*100).toFixed(1)}%`;
  set("pill-risk").textContent  = `ìœ„í—˜ë„ ${riskLevel(score)}`;

  // ë©˜íŠ¸
  document.getElementById("ment").textContent = buildMent(item, retr);
}

/* â”€â”€ ê²€ìƒ‰ â†’ SPARK í•„í„° + ULTRA ê°•ì œ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $q = document.getElementById("q");
function showEmptyMsg(msg){
  let el = document.getElementById('empty-msg');
  if (!el){ el = document.createElement('div'); el.id='empty-msg'; el.className='muted'; el.style.cssText='padding:12px;border:1px dashed var(--line);border-radius:10px'; $spark.appendChild(el); }
  el.textContent = msg;
}
function hideEmptyMsg(){ const el = document.getElementById('empty-msg'); if (el) el.remove(); }
function debounce(fn,ms=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

async function resolveMarket(query){
  const q = (query||"").trim().toLowerCase();
  if (ALIAS[q]) return ALIAS[q];
  for (const it of SPARK_CACHE){ if (it.text.includes(q)) return it.market; }
  for (const [m,k] of Object.entries(NAME)){
    const sym = m.split('-')[1]?.toLowerCase();
    if (m.toLowerCase().includes(q) || sym?.includes(q) || (k||"").toLowerCase().includes(q)) return m;
  }
  try{
    const arr = await fetchJSON("https://api.upbit.com/v1/market/all?isDetails=true",{timeout:8000,retries:1});
    const krw = arr.filter(x=>x.market?.startsWith("KRW-"));
    let pick = krw.find(x=>x.market.toLowerCase()===q)
            || krw.find(x=>x.market.split('-')[1].toLowerCase()===q)
            || krw.find(x=>(x.korean_name||"").toLowerCase()===q)
            || krw.find(x=>(x.korean_name||"").toLowerCase().includes(q) || x.market.toLowerCase().includes(q));
    if (pick){ NAME[pick.market]=pick.korean_name; return pick.market; }
  }catch(_){}
  return null;
}
async function fetchUltraByMarket(market){
  const urls = [
    `${CONFIG.API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`,
    `${CONFIG.API_BASE}/ultra?market=${encodeURIComponent(market)}`,
    `${CONFIG.API_BASE}/v1/ultra/signal?market=${encodeURIComponent(market)}`
  ];
  for (const u of urls){
    try{
      const r = await fetchJSON(u,{timeout:CONFIG.FETCH_TIMEOUT_MS,retries:1});
      const obj = Array.isArray(r) ? r[0] : (r.data||r);
      if (obj && (obj.market || obj.symbol)){
        const mk = obj.market || obj.symbol;
        return {market:mk, score:Number(obj.score)||75, rvol:Number(obj.rvol)||1.8, tbr:Number(obj.tbr)||0.5, obi:Number(obj.obi)||0.1};
      }
    }catch(_){}
  }
  return {market, score:75, rvol:1.8, tbr:0.5, obi:0.1};
}
async function forceUltraWhenNoMatch(raw){
  const market = await resolveMarket(raw || $q.value);
  if (!market){ showEmptyMsg(`âŒ '${raw}' ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`); return; }
  hideEmptyMsg();
  if (!TICKERS.size){ try{ await fetchTickers(); }catch(_){ } }
  const ultra = await fetchUltraByMarket(market);
  selectUltra(ultra);
  // ì¢Œì¸¡ ì„ì‹œ ì¹´ë“œ(UX)
  if (!$spark.querySelector(`[data-market="${market}"]`)){
    const price = TICKERS.get(market)?.price || 0;
    const kname = NAME[market] || market.split('-')[1];
    const score = ultra.score|0; const w = Math.min(100,Math.max(0,score));
    const ghost = document.createElement('div');
    ghost.className='coin'; ghost.setAttribute('data-market',market);
    ghost.innerHTML = `<div class="row space"><div><div class="sym">${market}</div><div class="kname">${kname}</div></div><div class="price">${price?fmtKRW(roundTick(price)):'-'}</div></div><div class="bar"><i style="width:${w}%"></i></div><span class="pill">SPARK ${score}</span>`;
    ghost.onclick = ()=> selectUltra(ultra);
    $spark.prepend(ghost);
    cacheSparkCards();
  }
}
const onSearch = debounce(()=>{
  const q = $q.value.trim().toLowerCase();
  cacheSparkCards();
  if (!q){ hideEmptyMsg(); SPARK_CACHE.forEach(({el})=>el.style.display=''); if (LAST_SPARK[0]) selectUltra(LAST_SPARK[0]); return; }
  const matched=[];
  SPARK_CACHE.forEach(it=>{ const ok = it.text.includes(q); it.el.style.display = ok?'':'none'; if (ok) matched.push(it); });
  if (!matched.length){ forceUltraWhenNoMatch($q.value); }
  else { hideEmptyMsg(); const item = LAST_SPARK.find(x=>x.market===matched[0].market); if (item) selectUltra(item); }
}, 100);
$q.addEventListener("input", onSearch);
$q.addEventListener("keydown", e=>{ if (e.key==="Enter") forceUltraWhenNoMatch($q.value); });

/* â”€â”€ ë£¨í”„(No-Motion: DOM diffë§Œ ê°±ì‹ ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loop(){
  try{ await fetchTickers(); const s = await fetchSparkTop(); renderSpark(s); }
  catch(e){ /* ì¡°ìš©íˆ ì¬ì‹œë„ */ }
  finally{ setTimeout(loop, CONFIG.REFRESH_MS); }
}

/* â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async()=>{ await loadKoreanNames(); loop(); })();
</script>
</body>
</html>
