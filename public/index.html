<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ULTRA & SPARK</title>
<style>
  :root{color-scheme:dark;}
  body{margin:0;background:#0b0d10;color:#cfd6dd;font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
  .topbar{position:sticky;top:0;z-index:50;background:#0b0d10cc;border-bottom:1px solid #1a1e24;backdrop-filter:saturate(180%) blur(6px)}
  .topbar .wrap{display:flex;gap:8px;align-items:center;padding:10px 12px;max-width:1100px;margin:0 auto}
  .chip{font-size:12px;padding:6px 10px;border:1px solid #2a3038;border-radius:999px;background:#12161c}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  h2{margin:14px 0 10px;font-size:18px}
  .card-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .card{background:#0f1318;border:1px solid #1c222b;border-radius:12px;padding:12px}
  .k{font-size:12px;color:#95a1af}
  .big{font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #1a1e24;font-size:13px}
  th{color:#9fb0c4;text-align:left}
  .muted{color:#7f8a97}
  .up{color:#39d353}.down{color:#ff6b6b}
  .risk{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .r1{background:#073b2d;color:#4df3b5;border:1px solid #0f5}
  .r2{background:#0e2f52;color:#68c5ff;border:1px solid #2aa9ff}
  .r3{background:#2a2436;color:#c8a8ff;border:1px solid #8b5cf6}
  .r4{background:#3b2a2a;color:#ffc4c4;border:1px solid #ff8585}
  .r5{background:#3b2020;color:#ffd0a6;border:1px solid #ff9a3c}
  .api{margin-top:10px;font-size:12px;color:#6c7a88}
  .search{flex:1;display:flex;gap:8px}
  .search input{flex:1;background:#0f1318;border:1px solid #242b34;border-radius:10px;padding:9px 12px;color:#dbe6f2}
  .btn{background:#1b2230;border:1px solid #2c3442;border-radius:10px;padding:8px 12px;color:#cfe3ff;cursor:pointer}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
<script>
  // ===== API BASE =====
  // ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì—°ê²°í–ˆë‹¤ë©´ ì•„ë˜ í•œ ì¤„ë§Œ ë°”ê¾¸ë©´ ë!
  const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
  // const API_BASE = 'https://api.ë‚´ë„ë©”ì¸/api';

  // ===== ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼ (ê°„ëµ ë²„ì „) =====
  function upbitTick(price){
    if(price>=2_000_000) return 1000;
    if(price>=1_000_000) return 500;
    if(price>=500_000)  return 100;
    if(price>=100_000)  return 50;
    if(price>=10_000)   return 10;
    if(price>=5_000)    return 5;
    if(price>=1_000)    return 1;
    if(price>=100)      return 0.1;
    if(price>=10)       return 0.01;
    return 0.001;
  }
  function roundTick(p){
    const t=upbitTick(p); return Math.round(p/t)*t;
  }
  const fkrw = v => (v>=1000? Math.round(v).toLocaleString() : v.toFixed(3));

  // ===== fetch helper =====
  async function j(u){ const r=await fetch(u); if(!r.ok) throw new Error('fetch'); return r.json(); }

  // ATR/Keltner ê³„ì‚° (ë¶„ë´‰ ìº”ë“¤ ë°°ì—´: ìµœì‹ ì´ 0ë²ˆì§¸ì¼ ìˆ˜ë„ ìˆì–´ UpbitëŠ” ìµœê·¼ìˆœ)
  function calcATR_Keltner(candles){
    // Upbit ë¶„ë´‰: ê°€ì¥ ìµœê·¼ ìº”ë“¤ì´ [0]
    const arr = candles.slice().reverse(); // ì˜¤ë˜ëœ â†’ ìµœì‹ 
    const closes = arr.map(c=>c.trade_price);
    const highs  = arr.map(c=>c.high_price);
    const lows   = arr.map(c=>c.low_price);
    const nATR=14, nEMA=20;

    // TR ë°°ì—´
    const TR=[], len=closes.length;
    for(let i=0;i<len;i++){
      if(i===0){ TR.push(highs[i]-lows[i]); continue; }
      const hl=highs[i]-lows[i], hc=Math.abs(highs[i]-closes[i-1]), lc=Math.abs(lows[i]-closes[i-1]);
      TR.push(Math.max(hl,hc,lc));
    }
    const atr = TR.slice(-nATR).reduce((a,b)=>a+b,0)/Math.max(1,Math.min(nATR,TR.length));

    // EMA
    let ema = closes[0], alpha = 2/(nEMA+1);
    for(let i=1;i<len;i++) ema = alpha*closes[i] + (1-alpha)*ema;

    const last = closes[len-1];
    const center = ema;
    const band = 1.5*atr; // Keltner(1.5*ATR)
    return { last, atr, center, upper:center+band, lower:center-band };
  }

  function riskLevel(atrPct){
    // atrPct = ATR / Price * 100
    if(atrPct < 0.6) return 1;
    if(atrPct < 1.0) return 2;
    if(atrPct < 1.6) return 3;
    if(atrPct < 2.5) return 4;
    return 5;
  }

  function zzeolOneLiner(state){
    if(state==='bull') return 'ì„¸ë ¥ ëŒíŒŒ ì‹œì‘, ìµì ˆ ëŠ¦ì¶° í™€ë”© ê¶Œì¥.';
    if(state==='prep') return 'ì„¸ë ¥ ì˜ˆì—´ ì¤‘, ëˆŒë¦¼ ì§„ì… ì¤€ë¹„.';
    if(state==='bear') return 'ì´íƒˆ ê°ì§€, ì¶”ê°€ ì§„ì… ê¸ˆì§€.';
    return 'ê´€ë§ êµ¬ê°„.';
  }

  // íƒ€ì  ìƒì„± ë¡œì§(ê°„ëµ íœ´ë¦¬ìŠ¤í‹±)
  function makeSignals(k){
    const { last, atr, center, upper, lower } = k;
    const atrPct = atr/last*100;
    const nearUpper = last >= upper*0.997;
    const brokeUpper= last > upper;
    const bull = brokeUpper || nearUpper;
    const state = bull ? (brokeUpper?'bull':'prep') : (last<center?'bear':'neutral');

    // ë¶ˆì¥/í•˜ë½ì¥ ë³´ì •
    let TP = bull ? last + 1.6*atr : last + 0.8*atr;
    let SL = bull ? last - 0.8*atr : last - 1.3*atr;
    let BUY = bull ? Math.max(center, upper-0.3*atr) : center - 0.2*atr;

    BUY = roundTick(BUY);
    TP  = roundTick(TP);
    SL  = roundTick(SL);

    return {
      last: roundTick(last),
      buy: BUY, tp: TP, sl: SL,
      risk: riskLevel(atrPct),
      say: zzeolOneLiner(state)
    };
  }

  // ê²€ìƒ‰/ë¡œë”©
  let MARKET_MAP = new Map(); // market -> {name_kor}
  async function loadMarkets(){
    const r = await j(`${API_BASE}/markets`);
    for(const m of r.rows){ MARKET_MAP.set(m.market, { name_kor:m.name_kor, name_eng:m.name_eng }); }
  }

  async function loadRows(keyword=''){
    const all = Array.from(MARKET_MAP.keys());
    // í‚¤ì›Œë“œ í•„í„° (í•œê¸€/ì‹¬ë³¼ ëª¨ë‘)
    const list = all.filter(m=>{
      const info = MARKET_MAP.get(m);
      const key = (m+' '+(info?.name_kor||'')+' '+(info?.name_eng||'')).toLowerCase();
      return key.includes(keyword.toLowerCase());
    }).slice(0, 10); // ìƒìœ„ 10ê°œë§Œ ê³„ì‚°(ë¶€í•˜ ë°©ì§€)

    // ë¶„ë´‰/íƒ€ì  ê³„ì‚°
    const rows = [];
    for(const m of list){
      try{
        const c = await j(`${API_BASE}/candles?market=${encodeURIComponent(m)}&unit=1&count=60`);
        if(!c.rows?.length) continue;
        const k = calcATR_Keltner(c.rows);
        const s = makeSignals(k);
        rows.push({ market:m, name:MARKET_MAP.get(m)?.name_kor||m, ...s });
      }catch(e){/* ignore */}
    }
    return rows;
  }

  function riskBadge(n){
    return `<span class="risk r${n}">ìœ„í—˜ë„ ${n}</span>`;
  }

  function renderTable(el, rows){
    el.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ë§ˆì¼“</th><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td class="mono">${r.market}<div class="muted">${r.name}</div></td>
              <td class="${r.last>=r.buy?'up':'down'}">${fkrw(r.last)}</td>
              <td>${fkrw(r.buy)}</td>
              <td>${fkrw(r.tp)}</td>
              <td>${fkrw(r.sl)}</td>
              <td>${riskBadge(r.risk)}</td>
              <td class="muted">${r.say}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  async function boot(){
    // ìš”ì•½(ê¹€í”„/í™˜ìœ¨/TVL)
    try{
      const [p, u, o] = await Promise.all([
        j(`${API_BASE}/premium`),
        j(`${API_BASE}/usdkrw`),
        j(`${API_BASE}/onchain`),
        loadMarkets(),
      ]);
      document.querySelector('#premium').textContent = (p.rows?.premium_pct??'-') + '%';
      document.querySelector('#usdkrw').textContent  = Math.round(u.rows?.usd_krw??0).toLocaleString();
      document.querySelector('#tvl').textContent     = (o.rows?.tvl_usd? Math.round(o.rows.tvl_usd).toLocaleString() : '-');
    }catch(e){
      document.querySelectorAll('.stat .big').forEach(el=>el.textContent='ë¡œë”© ì‹¤íŒ¨');
    }

    // ì´ˆê¸° ë¡œë“œ (ì˜ˆì—´/ë‹¨íƒ€ ë™ì¼ í•„í„° í›„ ìƒìœ„ 5ê°œì”© ë¶„ë¦¬ ì˜ˆì‹œ)
    const rows = await loadRows('');
    const hot  = rows.filter(x=>x.tp - x.last >= x.last*0.01).slice(0,5);   // ë‹¨íƒ€(ìƒìŠ¹ì—¬ì§€)
    const prep = rows.filter(x=>x.last <= x.buy).slice(0,5);               // ì˜ˆì—´(ëˆŒë¦¼ ëŒ€ê¸°)

    renderTable(document.querySelector('#tbl-prep'), prep);
    renderTable(document.querySelector('#tbl-fast'), hot);

    // ê²€ìƒ‰
    const input = document.querySelector('#q');
    const btn   = document.querySelector('#btn');
    async function run(){
      const k = input.value.trim();
      const rr= await loadRows(k);
      renderTable(document.querySelector('#tbl-prep'), rr.slice(0,5));
      renderTable(document.querySelector('#tbl-fast'), rr.slice(0,5));
    }
    btn.addEventListener('click', run);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });
  }

  document.addEventListener('DOMContentLoaded', boot);
</script>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <span class="chip">/health</span>
      <span class="chip">/markets</span>
      <span class="chip">/premium</span>
      <span class="chip">/onchain</span>
      <div class="search">
        <input id="q" placeholder="ì½”ì¸ëª…(í•œê¸€) ë˜ëŠ” í‹°ì»¤(KRW-XXX) ì…ë ¥â€¦  (í˜„ì¬ê°€Â·ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””)"/>
        <button id="btn" class="btn">ì‹œê·¸ë„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h2>ì‹œì¥ ìš”ì•½ (ê¹€í”„Â·í™˜ìœ¨Â·ì˜¨ì²´ì¸)</h2>
    <div class="card-row">
      <div class="card stat">
        <div class="k">KR ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</div>
        <div class="big" id="premium">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <div class="card stat">
        <div class="k">USD/KRW í™˜ìœ¨</div>
        <div class="big" id="usdkrw">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <div class="card stat">
        <div class="k">ì˜¨ì²´ì¸ TVL (USD)</div>
        <div class="big" id="tvl">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
    </div>

    <h2>ğŸ§ª SPARK (ì˜ˆì—´ ì½”ì¸)</h2>
    <div id="tbl-prep" class="card"></div>

    <h2>ğŸ”¥ SPARK ë‹¨íƒ€ (ê¸‰ë“± ì½”ì¸)</h2>
    <div id="tbl-fast" class="card"></div>

    <div class="api">API: <span class="mono">${API_BASE.replace('/api','')}/api</span> Â· KRW/ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼ Â· ìœ„í—˜ë„(1~5) Â· ì©”ì–´í•œë§ˆë””</div>
  </div>
</body>
</html>
