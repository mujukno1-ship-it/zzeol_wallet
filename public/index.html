<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ v10 ì „ì„¤íŒ â€” ì‹¤ì‹œê°„ íƒ€ì </title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Apple SD Gothic Neo, Noto Sans KR, Segoe UI, Roboto, Helvetica, Arial; background:#0f141a; color:#e8eef5;}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px;}
    h1{font-size:22px;margin:0 0 16px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{height:36px;border-radius:10px;border:1px solid #223041;background:#0c1116;color:#e8eef5;padding:0 12px;width:260px}
    button{height:36px;border-radius:10px;border:1px solid #223041;background:#16202b;color:#e8eef5;padding:0 12px;cursor:pointer}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #223041;background:#111926;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:#121922;border:1px solid #1c2633;border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:16px}
    .pair{display:flex;justify-content:space-between;margin:6px 0}
    .metric{font-weight:700}
    .small{color:#97a8ba;font-size:12px}
    .ok{color:#49d596}.warn{color:#ffd66b}.err{color:#ff7b7b}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #2a3a4d;background:#0e151d}
    footer{margin-top:16px;color:#7f8ea3;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸª™ ì©”ì–´ì§€ê°‘ v10 ì „ì„¤íŒ â€” ì‹¤ì‹œê°„ íƒ€ì </h1>

    <div class="row">
      <input id="q" placeholder="ì½”ì¸/ì‹¬ë³¼ (ì˜ˆ: BTC, ETH, ìŠ¤íŒŒí¬, XRP)" />
      <button id="apply">ì ìš©</button>
      <span class="small">í”„ë¡ì‹œ ìƒíƒœ: <b id="health">ì ê²€ì¤‘â€¦</b></span>
      <span class="row" style="margin-left:auto;gap:6px">
        <span class="chip" data-sym="BTC">BTC</span>
        <span class="chip" data-sym="ETH">ETH</span>
        <span class="chip" data-sym="SPARK">SPARK</span>
      </span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ğŸ« ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ <span class="badge" id="kimp-sym">BTC</span></h3>
        <div class="pair"><span>ì—…ë¹„íŠ¸ KRW</span><span class="metric" id="krw">-</span></div>
        <div class="pair"><span>ê¸€ë¡œë²Œ USD</span><span class="metric" id="usd">-</span></div>
        <div class="pair"><span>USD/KRW</span><span class="metric" id="fx">-</span></div>
        <div class="pair"><span>í”„ë¦¬ë¯¸ì—„(%)</span><span class="metric" id="kimp">-</span></div>
        <div class="small">ì†ŒìŠ¤: <span id="kimp-src">-</span></div>
      </div>

      <div class="card">
        <h3>ğŸ”— ì˜¨ì²´ì¸ TVL <span class="badge" id="oc-sym">ETH</span></h3>
        <div class="pair"><span>TVL (USD)</span><span class="metric" id="tvl">-</span></div>
        <div class="small">ì†ŒìŠ¤: <span id="oc-src">-</span></div>
      </div>

      <div class="card">
        <h3>ğŸ’ ì‹¤ì‹œê°„ íƒ€ì  <span class="badge" id="sig-sym">BTC</span></h3>
        <div class="pair"><span>í˜„ì¬ê°€</span><span class="metric" id="p">-</span></div>
        <div class="pair"><span>ë§¤ìˆ˜</span><span class="metric" id="b">-</span></div>
        <div class="pair"><span>ë§¤ë„</span><span class="metric" id="s">-</span></div>
        <div class="pair"><span>ì†ì ˆ</span><span class="metric" id="st">-</span></div>
        <div class="pair"><span>ìœ„í—˜ë„</span><span class="metric" id="r">-</span></div>
        <div class="small">ì©”ì–´ í•œë§ˆë””: <span id="c">-</span></div>
        <div class="small">ì—…ë°ì´íŠ¸: <span id="ts">-</span></div>
      </div>

      <div class="card">
        <h3>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h3>
        <div class="pair"><span>í”„ë¡ì‹œ</span><span id="h2" class="metric">-</span></div>
        <div class="pair"><span>ë°ì´í„°</span><span id="d2" class="metric">-</span></div>
        <div class="small">ë¬¸ì œ ì‹œ ìƒˆë¡œê³ ì¹¨(Ctrl+F5) ë˜ëŠ” ì ì‹œ í›„ ì¬ì‹œë„</div>
      </div>
    </div>

    <footer>
      ì†ŒìŠ¤: Upbit / CoinGecko / open.er-api / DefiLlama Â· Asia/Seoul ê¸°ì¤€
    </footer>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev";
    const DEFAULT_KIMP = "BTC";
    const DEFAULT_ONCHAIN = "ETH";
    const FAVORITES = ["BTC", "ETH", "SPARK"];

    const $ = (id)=>document.getElementById(id);
    const nf0 = (n)=>Number(n||0).toLocaleString('ko-KR');
    const nf2 = (n)=>Number(n||0).toLocaleString('ko-KR',{maximumFractionDigits:2});

    let state = { sym: "BTC", oc: DEFAULT_ONCHAIN };

    function mapToSymbol(input){
      if(!input) return state.sym;
      const t = String(input).trim().toUpperCase();
      if (["ë¹„íŠ¸","ë¹„íŠ¸ì½”ì¸","BTC"].includes(t)) return "BTC";
      if (["ì´ë”","ì´ë”ë¦¬ì›€","ETH"].includes(t)) return "ETH";
      if (["ìŠ¤íŒŒí¬","SPARK","FLR","FLARE"].includes(t)) return "SPARK";
      return t;
    }

    // ===== í—¬ìŠ¤ì²´í¬ =====
    async function health(){
      try{
        const res = await fetch(API_BASE+"/api/health",{cache:"no-store"});
        const j = await res.json();
        const ok = j?.ok;
        $("health").textContent = ok?"ì •ìƒ":"ì˜¤í”„ë¼ì¸";
        $("health").className = ok?"ok":"err";
        $("h2").textContent = ok?"ì •ìƒ":"ì˜¤í”„ë¼ì¸";
        $("h2").className = "metric " + (ok?"ok":"err");
      }catch{
        $("health").textContent = "ì˜¤í”„ë¼ì¸";
        $("health").className = "err";
        $("h2").textContent = "ì˜¤í”„ë¼ì¸";
        $("h2").className = "metric err";
      }
    }

    // ===== ê¹€í”„/ì˜¨ì²´ì¸/ì‹œê·¸ë„ =====
    async function loadKimp(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/premium?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("premium");
        $("kimp-sym").textContent = j.symbol;
        $("krw").textContent = nf0(j.upbitPrice);
        $("usd").textContent = nf2(j.globalUsd);
        $("fx").textContent  = nf2(j.usdkrw);
        $("kimp").textContent = (Number(j.premiumPct)||0).toFixed(2)+"%";
        $("kimp-src").textContent = `${j?.src?.global||"CoinGecko"} / ${j?.src?.fx||"open.er-api"} / ${j?.src?.krw||"Upbit"}`;
        $("d2").textContent = "ê¹€í”„/ì˜¨ì²´ì¸/ì‹œê·¸ë„ ì •ìƒ";
        $("d2").className = "metric ok";
      }catch(e){
        $("kimp").textContent = "-";
        $("d2").textContent = "ë°ì´í„° ì¼ë¶€ ì§€ì—°";
        $("d2").className = "metric warn";
      }
    }

    async function loadOnchain(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/onchain?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("onchain");
        $("oc-sym").textContent = j.symbol;
        $("tvl").textContent = nf0(j.tvlusd);
        $("oc-src").textContent = j?.src || "DefiLlama";
      }catch(e){
        $("tvl").textContent = "-";
        $("oc-src").textContent = "â€”";
      }
    }

    async function loadSignal(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/signal?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("signal");
        $("sig-sym").textContent = j.symbol;
        $("p").textContent  = nf0(j.price);
        $("b").textContent  = j.buy? nf0(j.buy) : "-";
        $("s").textContent  = j.sell? nf0(j.sell): "-";
        $("st").textContent = j.stop? nf0(j.stop): "-";
        $("r").textContent  = (j.risk<=2? "ğŸŸ¢ " : j.risk==3? "ğŸŸ¡ " : "ğŸ”´ ") + (j.risk??"-");
        $("c").textContent  = j.comment || "-";
        $("ts").textContent = new Date(j.ts||Date.now()).toLocaleString("ko-KR");
      }catch(e){
        $("c").textContent = "ì ê²€ì¤‘â€¦";
      }
    }

    async function refreshAll(){
      await health();
      await Promise.all([
        loadKimp(state.sym),
        loadOnchain(state.oc),
        loadSignal(state.sym),
      ]);
    }

    // ì´ë²¤íŠ¸
    document.querySelectorAll(".chip").forEach(el=>{
      el.addEventListener("click", ()=>{
        const sym = el.getAttribute("data-sym");
        state.sym = sym;
        if (sym==="ETH") state.oc="ETH";
        if (sym==="BTC") state.oc="ETH";
        if (sym==="SPARK") state.oc="ETH"; // TVL ê¸°ë³¸ ETH
        $("kimp-sym").textContent = state.sym;
        $("sig-sym").textContent  = state.sym;
        $("oc-sym").textContent   = state.oc;
        refreshAll();
      });
    });

    $("apply").addEventListener("click", ()=>{
      const mapped = mapToSymbol($("q").value);
      state.sym = mapped;
      $("kimp-sym").textContent = state.sym;
      $("sig-sym").textContent  = state.sym;
      refreshAll();
    });

    // ê¸°ë³¸: SPARK ê³ ì • ë…¸ì¶œ ì„ í˜¸ ì‹œ ì•„ë˜ í•œ ì¤„ë§Œ ì¼¬
    // state.sym = "SPARK";

    // ë¶€íŒ…
    (async ()=>{
      $("kimp-sym").textContent = state.sym;
      $("sig-sym").textContent = state.sym;
      $("oc-sym").textContent = state.oc;
      await refreshAll();
      setInterval(refreshAll, 10_000);
    })();
  </script>
</body>
</html>
