<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>쩔어진갑 ∞ 전설판 10.1 (업비트 동일 검색 + SPARK 타점)</title>
<style>
  :root{--bg:#0f1117;--panel:#151a23;--text:#e8eef6;--muted:#9aa4b2;--ok:#2bdd8a;--warn:#ffb020;--bad:#ff6b6b;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:var(--panel);border:1px solid #223046;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .muted{color:var(--muted)} .btn{background:#1e2635;border:1px solid #2a3550;color:#dce9ff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .input{background:#0d131c;border:1px solid #27364a;border-radius:10px;padding:10px 12px;width:100%;color:var(--text)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #223046;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kv{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kv .box{background:#0e141d;border:1px solid #223046;border-radius:10px;padding:12px}
  .kv .k{font-size:12px;color:var(--muted)} .kv .v{font-size:18px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .risk1{background:#0f3521;color:#7bf0a5}.risk2{background:#102c36;color:#8ad9ff}
  .risk3{background:#362f10;color:#ffe08a}.risk4{background:#381c12;color:#ffb39b}.risk5{background:#351113;color:#ff8686}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <h1>💫 전설판 10.1 <span class="muted" id="apiState">API 연결 확인중…</span></h1>

  <div class="card">
    <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px">
      <input id="q" class="input" placeholder="업비트 동일: 심볼/한글/영문 검색 (예: BTC, 비트코인, shiba inu)"/>
      <button class="btn" id="btnSearch">검색</button>
      <button class="btn" id="btnReset">초기화</button>
    </div>
    <div id="searchResult" style="margin-top:12px"></div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>💎 김치 프리미엄 (BTC)</h3>
      <div class="kv">
        <div class="box"><div class="k">업비트 KRW</div><div class="v" id="kp_upbit">-</div></div>
        <div class="box"><div class="k">글로벌 USD</div><div class="v" id="kp_usd">-</div></div>
        <div class="box"><div class="k">USD/KRW</div><div class="v" id="kp_fx">-</div></div>
      </div>
      <div class="box" style="margin-top:12px"><div class="k">프리미엄(%)</div><div class="v" id="kp_prem">-</div></div>
      <div class="muted" id="kp_src" style="margin-top:8px">소스: -</div>
    </div>

    <div class="card">
      <h3>🧠 온체인 TVL (ETH)</h3>
      <div class="kv">
        <div class="box"><div class="k">TVL</div><div class="v" id="tvl_v">-</div></div>
        <div class="box"><div class="k">소스</div><div class="v" id="tvl_src">-</div></div>
        <div class="box"><div class="k">업데이트</div><div class="v" id="tvl_ts">-</div></div>
      </div>
      <div class="muted" style="margin-top:8px">DefiLlama 실패 시 자동 폴백</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>⚡ SPARK (급등 감지 · TOP 10)</h3>
    <div class="muted" style="margin:4px 0 8px">현재가·매수·매도·손절·위험도·쩔어결론 포함</div>
    <table>
      <thead>
        <tr>
          <th>코인</th><th>현재가</th><th>60m</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어결론</th>
        </tr>
      </thead>
      <tbody id="sparkRows"><tr><td colspan="8" class="muted">동기화 중…</td></tr></tbody>
    </table>
  </div>

  <div class="muted" style="text-align:center;margin:24px 0 36px">© 2025 쩔어진갑 ∞ | 업비트·온체인·김프 연동</div>
</div>

<script>
  // ===== 환경 =====
  const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev"; // ★★★ 네 워커 URL로 교체 ★★★

  // ===== 유틸 =====
  const $ = s=>document.querySelector(s);
  const fmtKRW = n => (n||n===0) ? Number(n).toLocaleString("ko-KR")+"원" : "-";
  const riskTag = r => `<span class="pill risk${Math.max(1,Math.min(5,r|0))}">${Math.max(1,Math.min(5,r|0))}</span>`;

  // 업비트 호가단위 근사
  function tickKRW(p){
    if (p >= 2_000_000) return 1000;
    if (p >= 100_000)  return 50;
    if (p >= 10_000)   return 10;
    if (p >= 1_000)    return 1;
    if (p >= 100)      return 0.1;
    if (p >= 10)       return 0.01;
    if (p >= 1)        return 0.001;
    return 0.0001;
  }
  const roundTick = p => Math.round(p / tickKRW(p)) * tickKRW(p);

  // 불장/하락 자동판별 포함 타점
  function decide(price, opts={}){
    const { premiumPct=0, vol=1.0 } = opts;
    const spread = premiumPct>2 || vol>1.05 ? 0.006 : premiumPct<-1 || vol<0.95 ? 0.003 : 0.004; // 공격/보수/기본
    const stopMul = premiumPct>2 || vol>1.05 ? 0.975 : premiumPct<-1 || vol<0.95 ? 0.99 : 0.985;

    const buy  = roundTick(price*(1-spread));
    const sell = roundTick(price*(1+spread));
    const stop = roundTick(price*stopMul);

    let risk = 3;
    if (premiumPct>3 || vol>1.08) risk = 5;
    else if (premiumPct>2 || vol>1.05) risk = 4;
    else if (premiumPct<-1 || vol<0.95) risk = 2;
    else risk = 3;

    let verdict = "중립, 관망 구간";
    if (premiumPct>2 || vol>1.05) verdict = "🔥 불장모드 — 단기 과열, 분할 매도 유리";
    else if (premiumPct<-1 || vol<0.95) verdict = "❄️ 하락장모드 — 약세, 손절·관망";
    else verdict = "⚖️ 중립, 스윙 대응";

    return { buy, sell, stop, risk, verdict };
  }

  async function j(path){ const r = await fetch(API_BASE+path, {cache:"no-store"}); return r.json(); }

  // API 상태
  (async ()=>{
    try{ const h = await j("/api/health"); $("#apiState").textContent = h.ok?"API 연결: 정상":"API 연결: 대기"; }
    catch{ $("#apiState").textContent = "API 연결: 오류"; }
  })();

  // 김치 프리미엄(BTC)
  async function loadPremium(sym="BTC"){
    try{
      const p = await j(`/api/premium?symbol=${sym}`);
      if (p.ok){
        $("#kp_upbit").textContent = fmtKRW(p.upbitKrw);
        $("#kp_usd").textContent   = p.globalUsd?("$"+p.globalUsd.toLocaleString("en-US")):"-";
        $("#kp_fx").textContent    = p.usdkrw?.toLocaleString("ko-KR")||"-";
        $("#kp_prem").textContent  = (p.premiumPct>=0?"+":"")+p.premiumPct.toFixed(2)+" %";
        $("#kp_src").textContent   = `소스: ${p.src.global} · ${p.src.fx} · ${p.src.krw} · ${new Date(p.updatedAt).toLocaleString()}`;
      }
    }catch{}
  }
  loadPremium("BTC");

  // 온체인 TVL(ETH)
  async function loadTVL(){
    try{
      const x = await j("/api/onchain?chain=Ethereum");
      $("#tvl_v").textContent = x.tvl ? "$"+x.tvl.toLocaleString("en-US") : "-";
      $("#tvl_src").textContent = x.src || "-";
      $("#tvl_ts").textContent = new Date(x.updatedAt||Date.now()).toLocaleString();
    }catch{
      $("#tvl_v").textContent="-"; $("#tvl_src").textContent="오류"; $("#tvl_ts").textContent="-";
    }
  }
  loadTVL();

  // 검색: 업비트 동일 리스트 기반
  async function doSearch(){
    const q = $("#q").value.trim();
    if (!q){ $("#searchResult").innerHTML=""; return; }
    const all = await j("/api/markets");
    const rows = all.filter(x =>
      x.symbol.toLowerCase().includes(q.toLowerCase()) ||
      x.name_kr.includes(q) ||
      x.name_en.toLowerCase().includes(q.toLowerCase())
    ).slice(0, 20);

    if (!rows.length){
      $("#searchResult").innerHTML = `<div class="muted">검색 실패: 일치 항목 없음</div>`;
      return;
    }

    let html = `<table><thead>
      <tr><th>코인</th><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어결론</th></tr>
    </thead><tbody>`;
    for (const r of rows){
      try{
        const qj = await j(`/api/quote?symbol=${r.symbol}`);
        const d  = decide(qj.price, { premiumPct: 0, vol: 1 + Math.abs(qj.change_rate||0) });
        html += `<tr>
          <td>${r.symbol}</td>
          <td>${fmtKRW(qj.price)}</td>
          <td>${fmtKRW(d.buy)}</td>
          <td>${fmtKRW(d.sell)}</td>
          <td>${fmtKRW(d.stop)}</td>
          <td>${riskTag(d.risk)}</td>
          <td>${d.verdict}</td>
        </tr>`;
      }catch{
        html += `<tr><td colspan="7">데이터 오류</td></tr>`;
      }
    }
    html += `</tbody></table>`;
    $("#searchResult").innerHTML = html;
  }
  $("#btnSearch").onclick = doSearch;
  $("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });
  $("#btnReset").onclick = ()=>{ $("#q").value=""; $("#searchResult").innerHTML=""; };

  // SPARK: TOP 10 (현재가/타점/위험도/결론)
  async function loadSpark(){
    try{
      const sp = await j("/api/spark?limit=10");
      const tb = $("#sparkRows");
      tb.innerHTML = "";
      for (const r of sp.items){
        const d = decide(r.price, { premiumPct: 0, vol: (100+Math.abs(r.chg60m))/100 });
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.symbol}</td>
          <td>${fmtKRW(r.price)}</td>
          <td class="${r.chg60m>=0?'ok':'bad'}">${(r.chg60m>=0?'+':'')}${r.chg60m.toFixed(2)}%</td>
          <td>${fmtKRW(d.buy)}</td>
          <td>${fmtKRW(d.sell)}</td>
          <td>${fmtKRW(d.stop)}</td>
          <td>${riskTag(d.risk)}</td>
          <td>${d.verdict}</td>
        `;
        tb.appendChild(tr);
      }
    }catch{
      $("#sparkRows").innerHTML = `<tr><td colspan="8" class="muted">SPARK 로딩 오류</td></tr>`;
    }
  }
  loadSpark();
  setInterval(()=>{ loadPremium("BTC"); loadTVL(); loadSpark(); }, 30_000); // 30초 주기
</script>
</body>
</html>
