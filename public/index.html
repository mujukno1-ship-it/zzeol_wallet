<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ v9.2.3 â€“ KRW ì‹¤ì‹œê°„(í•œë°© ë¶™ì—¬ë„£ê¸°)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#111823;--muted:#7c8aa5;--text:#e8eefc;--up:#22c55e;--down:#ef4444;--btn:#0f1b2e;--btnb:#2a3b57}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    .card{background:var(--panel);border:1px solid #1d2736;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
    h2{margin:0 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{border-radius:12px;border:1px solid var(--btnb);background:var(--btn);color:#dbe7ff}
    input{padding:12px 14px;flex:1;min-width:220px}
    button{padding:10px 12px;cursor:pointer}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
    thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
    tbody tr{background:#0e1520;border:1px solid #1d2a40}
    tbody td{padding:10px}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    .price{font-variant-numeric:tabular-nums}
    .up{color:var(--up)} .down{color:var(--down)}
    .tag{font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #2a3956;color:#9fb6db;background:#111a27}
    .flex{display:flex;align-items:center;gap:8px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .badge{padding:6px 10px;border-radius:999px;background:#151f2f;border:1px solid #25344f;font-size:12px}
    .status{margin-top:6px;font-size:12px;color:#9bb0d1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>ğŸ” ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©)</h2>
    <div class="row">
      <input id="q" placeholder="ì½”ì¸ëª…/í‹°ì»¤ (ì˜ˆ: ì´ë”ë¦¬ì›€, ETH, KRW-ETH)">
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnTop">ìƒìŠ¹ TOP10</button>
      <button id="btnHot">ê¸‰ë“±</button>
      <button id="btnFall">ê¸‰ë½</button>
      <button id="btnReset">ì´ˆê¸°í™”</button>
    </div>
    <div class="toolbar">
      <button id="btn1s">í´ë§ 1ì´ˆ</button>
      <button id="btn2s">2ì´ˆ</button>
      <button id="btn5s">5ì´ˆ</button>
      <button id="btnStop">ì •ì§€</button>
      <span class="badge" id="krwBadge">KRW ë§ˆì¼“ë§Œ</span>
    </div>
    <div class="status" id="status">ëŒ€ê¸°ì¤‘â€¦</div>

    <table>
      <thead>
        <tr>
          <th style="width:20%">ì½”ì¸</th>
          <th style="width:14%">í˜„ì¬ê°€</th>
          <th style="width:10%">ë“±ë½</th>
          <th style="width:14%">ë§¤ìˆ˜</th>
          <th style="width:14%">ë§¤ë„</th>
          <th style="width:10%">ì†ì ˆ</th>
          <th style="width:8%">ìœ„í—˜ë„</th>
          <th>ì©”ì–´í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div id="sys" class="hint">ì—…ë¹„íŠ¸ REST ì§ì ‘ ì—°ë™(CORS í—ˆìš©). í”„ë¡ì‹œ(/api/upbit) ì—†ì´ ë™ì‘.</div>
  </div>
</div>

<script>
// ===== ì „ì—­ =====
const el = {
  q: document.getElementById('q'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  btnSearch: document.getElementById('btnSearch'),
  btnTop: document.getElementById('btnTop'),
  btnHot: document.getElementById('btnHot'),
  btnFall: document.getElementById('btnFall'),
  btnReset: document.getElementById('btnReset'),
  btn1s: document.getElementById('btn1s'),
  btn2s: document.getElementById('btn2s'),
  btn5s: document.getElementById('btn5s'),
  btnStop: document.getElementById('btnStop'),
};

const UPBIT = {
  markets: 'https://api.upbit.com/v1/market/all?isDetails=true',
  ticker: (codes)=>`https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
};

const state = {
  markets: [],   // KRW-* only
  dict: {},      // ê²€ìƒ‰ ì¸ë±ìŠ¤
  pollMs: 1000,
  timer: null,
  lastList: [],
};

// ===== í˜¸ê°€/í‘œì‹œë‹¨ìœ„(ì—…ë¹„íŠ¸ KRW ê·¼ì‚¬) =====
function krwTick(p){
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 5;
  if(p>=100)     return 1;
  if(p>=10)      return 0.1;
  if(p>=1)       return 0.01;
  return 0.001;
}
function fmtKRW(p){
  const t=krwTick(p);
  const d=t>=1?0:t===0.1?1:t===0.01?2:3;
  return Number(p).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function levels(t){
  const p=Number(t.trade_price), tk=krwTick(p);
  const buy=p-tk*2, sell=p+tk*3, cut=p-tk*6;
  const r=Math.abs(t.signed_change_rate);
  const risk = r<0.01?1 : r<0.02?2 : r<0.035?3 : r<0.06?4 : 5;
  const say = risk<=2? "ë¬´ë‚œí•œ ëˆŒë¦¼ ëŒ€ê¸°" : "ë³€ë™ ì£¼ì˜. ì ˆëŒ€ ì¶”ê²© ê¸ˆì§€";
  return {buy,sell,cut,risk,say};
}
function setStatus(s){ el.status.textContent = s; }

// ===== ë¡œë”© =====
async function loadMarkets(){
  setStatus('ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ì¤‘â€¦');
  const res = await fetch(UPBIT.markets);
  const data = await res.json();
  const krw = data.filter(x=>x.market?.startsWith('KRW-'));
  state.markets = krw;

  // ê²€ìƒ‰ ì‚¬ì „(ì™„ì „ì¼ì¹˜ ìš°ì„ )
  state.dict = {};
  for(const m of krw){
    const keys = [
      m.market?.toLowerCase(),
      m.korean_name?.toLowerCase(),
      m.english_name?.toLowerCase(),
      m.korean_name?.replace(/\s+/g,'').toLowerCase(),
      m.english_name?.replace(/\s+/g,'').toLowerCase(),
    ].filter(Boolean);
    for(const k of keys){ (state.dict[k] ??= []).push(m); }
  }
  setStatus(`KRW ë§ˆì¼“ ${krw.length}ì¢… ë¡œë“œ ì™„ë£Œ`);
}

// ===== Upbit ticker(ë°°ì¹˜ í˜¸ì¶œ) =====
async function fetchTicker(list){
  if(!list.length) return [];
  const codes = list.map(x=>x.market);
  const chunkSize = 100;                 // â˜… í•µì‹¬: 100ê°œì”© ë°°ì¹˜
  const out = [];
  for(let i=0;i<codes.length;i+=chunkSize){
    const part = codes.slice(i, i+chunkSize);
    const url = UPBIT.ticker(part);
    const r = await fetch(url);
    if(!r.ok){
      console.warn('ticker batch failed', i, await r.text());
      continue;
    }
    const data = await r.json();
    out.push(...data);
  }
  return out;
}

function renderRows(tickers, baseList){
  const byMarket = new Map(tickers.map(t=>[t.market,t]));
  const list = baseList ?? state.lastList;
  el.tbody.innerHTML='';
  for(const m of list){
    const t = byMarket.get(m.market);
    if(!t) continue;
    const cls = t.signed_change_rate>=0?'up':'down';
    const lv = levels(t);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="flex"><span class="tag">${m.market.replace('KRW-','')}</span> ${m.korean_name||m.english_name}</td>
      <td class="price ${cls}">${fmtKRW(t.trade_price)}</td>
      <td class="${cls}">${(t.signed_change_rate*100).toFixed(2)}%</td>
      <td class="price">${fmtKRW(lv.buy)}</td>
      <td class="price">${fmtKRW(lv.sell)}</td>
      <td class="price down">${fmtKRW(lv.cut)}</td>
      <td>${lv.risk}</td>
      <td>${lv.say}</td>
    `;
    el.tbody.appendChild(tr);
  }
  if(!el.tbody.children.length){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td colspan="8" class="hint">ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
    el.tbody.appendChild(tr);
  }
}

// ===== í´ë§ =====
async function poll(){
  try{
    const base = state.lastList.length? state.lastList : state.markets.slice(0,10);
    const tks = await fetchTicker(base);
    renderRows(tks, base);
    setStatus(`ì‹¤ì‹œê°„ ê°±ì‹  ì¤‘â€¦ (ì£¼ê¸° ${state.pollMs/1000}s)`);
  }catch(e){
    setStatus('ì—°ê²° ì˜¤ë¥˜(CORS/ë„¤íŠ¸ì›Œí¬) â€” ìƒˆë¡œê³ ì¹¨(F5) ë˜ëŠ” ì ì‹œ í›„ ì¬ì‹œë„');
    console.error(e);
  }
}
function start(){ stop(); state.timer=setInterval(poll, state.pollMs); poll(); }
function stop(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

// ===== ê¸°ëŠ¥ ë²„íŠ¼ =====
el.btnSearch.onclick = ()=>{
  const list = searchLocal(el.q.value);
  state.lastList = list;
  start();
};
el.q.onkeydown = (e)=>{ if(e.key==='Enter') el.btnSearch.click(); };

el.btnTop.onclick = async ()=>{
  setStatus('ìƒìŠ¹ TOP10 ê³„ì‚° ì¤‘â€¦');
  const base = state.markets;                   // ëª¨ë“  KRW
  const tks = await fetchTicker(base);
  const top = [...tks].sort((a,b)=> b.signed_change_rate - a.signed_change_rate).slice(0,10);
  const markets = top.map(t=>t.market);
  state.lastList = state.markets.filter(m=>markets.includes(m.market));
  renderRows(top, state.lastList);
  setStatus('ìƒìŠ¹ TOP10');
};

// âœ… ê¸‰ë“±(>= +5%), ê¸‰ë½(<= âˆ’5%) â€” ì „ ì¢…ëª© ë°°ì¹˜ ê³„ì‚°
el.btnHot.onclick = async ()=>{
  setStatus('ê¸‰ë“± ê³„ì‚° ì¤‘â€¦');
  const tks = await fetchTicker(state.markets);
  const hot = tks.filter(x=> x.signed_change_rate >= 0.05)
                 .sort((a,b)=> b.signed_change_rate - a.signed_change_rate)
                 .slice(0, 20);
  const markets = hot.map(t=>t.market);
  state.lastList = state.markets.filter(m=>markets.includes(m.market));
  renderRows(hot, state.lastList);
  setStatus(`ê¸‰ë“± TOP${hot.length} (24h +5% ì´ìƒ)`);
};

el.btnFall.onclick = async ()=>{
  setStatus('ê¸‰ë½ ê³„ì‚° ì¤‘â€¦');
  const tks = await fetchTicker(state.markets);
  const fall = tks.filter(x=> x.signed_change_rate <= -0.05)
                  .sort((a,b)=> a.signed_change_rate - b.signed_change_rate)
                  .slice(0, 20);
  const markets = fall.map(t=>t.market);
  state.lastList = state.markets.filter(m=>markets.includes(m.market));
  renderRows(fall, state.lastList);
  setStatus(`ê¸‰ë½ TOP${fall.length} (24h -5% ì´í•˜)`);
};

el.btnReset.onclick = ()=>{
  el.q.value='';
  state.lastList = state.markets.slice(0,10);
  start();
};
el.btn1s.onclick = ()=>{ state.pollMs=1000; start(); };
el.btn2s.onclick = ()=>{ state.pollMs=2000; start(); };
el.btn5s.onclick = ()=>{ state.pollMs=5000; start(); };
el.btnStop.onclick = ()=>{ stop(); setStatus('ì¼ì‹œì •ì§€'); };

// ===== ê²€ìƒ‰ ë¡œì§ =====
function searchLocal(q){
  if(!q) return state.markets.slice(0,20);
  const key=q.trim().toLowerCase();
  let list = state.dict[key] ? [...state.dict[key]] : [];
  if(list.length===0){
    list = state.markets.filter(m=>
      m.market.toLowerCase().includes(key) ||
      m.korean_name.toLowerCase().includes(key) ||
      m.english_name.toLowerCase().includes(key)
    );
  }
  return list.slice(0,30);
}

// ===== ì‹œì‘ =====
(async function init(){
  await loadMarkets();
  state.lastList = state.markets.slice(0,10);
  start();
})();
</script>
</body>
</html>
