<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ëŒ€ì‹œë³´ë“œ (í•œë°© ë¶™ì—¬ë„£ê¸° v12.1+PB)</title>
  <style>
    :root{
      --bg:#0f1115; --card:#151922; --muted:#8b92a5; --text:#e9edf3; --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c; --chip:#1d2330;
      --accent:#6aa0ff; --line:#232a3a;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Roboto,Inter,sans-serif}
    .wrap{max-width:1180px;margin:36px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 14px 0;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .topbar{display:flex;gap:8px;align-items:center;margin:6px 0 16px}
    input.search{flex:1;background:#0c0f14;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    button{background:#1a2333;border:1px solid var(--line);color:#dbe6ff;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .list{display:flex;flex-direction:column;gap:8px;max-height:540px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;background:#0c0f14;border:1px solid var(--line);padding:10px 12px;border-radius:10px;cursor:pointer}
    .item:hover{border-color:#2a3853}
    .pill{background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:#cdd7f5}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kv{background:#0c0f14;border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-height:56px}
    .kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .kv strong{font-size:16px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .foot{margin-top:8px;font-size:12px;color:var(--muted)}
    .api-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#d35454;margin-left:6px;vertical-align:middle}
    .api-dot.ok{background:#2ecc71}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ëŒ€ì‹œë³´ë“œ</h1>

    <div class="topbar">
      <span class="muted">API</span>
      <span id="apiHost" class="pill" title="ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì˜ API_BASEë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."></span>
      <span id="apiDot" class="api-dot" title="í—¬ìŠ¤ì²´í¬"></span>
      <input id="q" class="search" placeholder="ê²€ìƒ‰: í•œê¸€ëª… / ì˜ë¬¸ì‹¬ë³¼ / ë§ˆì¼“ì½”ë“œ (ì˜ˆ: ì—ì´ë‹¤, ADA, KRW-ADA)" />
      <button id="btnFind">ê²€ìƒ‰</button>
    </div>

    <div class="row">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>ğŸ”¥ <b>SPARK TOP10</b> â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸ <span id="sparkMeta" class="muted">(ìë™ 30ì´ˆ ìƒˆë¡œê³ ì¹¨)</span></div>
          <div class="chips">
            <span id="btnRefresh" class="pill" style="cursor:pointer">ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨</span>
          </div>
        </div>
        <div id="sparkList" class="list">
          <div class="muted" style="padding:12px">ì˜ˆì—´ ì½”ì¸ì„ íƒìƒ‰ì¤‘â€¦</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>âš¡ <b>ULTRA ì‹œê·¸ë„</b> â€” <span id="selName" class="muted">ì„ íƒëœ ì½”ì¸</span></div>
          <div class="chips">
            <span id="modeChip" class="pill">mode: neutral</span>
            <span id="atrChip" class="pill">ATR: -</span>
            <span id="mktChip" class="pill">ë§ˆì¼“: -</span>
          </div>
        </div>

        <div class="grid2">
          <div class="kv"><b>í˜„ì¬ê°€</b><strong id="nowPrice">-</strong></div>
          <div class="kv"><b>ë³€ë™ë¥ </b><strong id="chgRate">-</strong></div>
          <div class="kv"><b>ë§¤ìˆ˜ (BUY1)</b><strong id="buy1">-</strong></div>
          <div class="kv"><b>ìµì ˆ 1 (TP1)</b><strong id="tp1">-</strong></div>
          <div class="kv"><b>ìµì ˆ 2 (TP2)</b><strong id="tp2">-</strong></div>
          <div class="kv"><b>ì†ì ˆ (SL)</b><strong id="sl">-</strong></div>
          <div class="kv"><b>ì˜ˆìƒ ê³ ì  1</b><strong id="hi1">-</strong></div>
          <div class="kv"><b>ì˜ˆìƒ ì €ì  1</b><strong id="lo1">-</strong></div>
        </div>

        <div class="chips" style="margin-top:12px">
          <span id="precChip" class="pill">Precision: auto</span>
          <span id="confChip" class="pill">Confidence: -</span>
          <span id="riskChip" class="pill">ìœ„í—˜ë„: -</span>
          <span id="msgChip" class="pill">ì©”ì–´í•œë§ˆë””: -</span>
        </div>

        <div class="foot">ì½”ì¸ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== ê¸°ë³¸ ì„¤ì • =====
    const DEFAULT_API = 'https://satoshi-proxy.mujukno1.workers.dev/api';
    const API = (localStorage.getItem('API_BASE') || DEFAULT_API).replace(/\/+$/,'');
    const apiHostEl = document.getElementById('apiHost');
    const apiDotEl  = document.getElementById('apiDot');
    apiHostEl.textContent = API;

    // ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼
    function tickRoundKRW(price){
      let p = Number(price||0);
      if (p >= 2000000) return Math.round(p/1000)*1000;
      if (p >= 1000000) return Math.round(p/500)*500;
      if (p >= 500000)  return Math.round(p/100)*100;
      if (p >= 100000)  return Math.round(p/50)*50;
      if (p >= 10000)   return Math.round(p/10)*10;
      if (p >= 1000)    return Math.round(p/5)*5;
      if (p >= 100)     return Math.round(p/1)*1;
      if (p >= 10)      return Math.round(p/0.1)*0.1;
      if (p >= 1)       return Math.round(p/0.01)*0.01;
      return Math.round(p/0.001)*0.001;
    }
    const fmtKRW = v => (v===null||v===undefined? '-' : `${tickRoundKRW(v).toLocaleString('ko-KR')}ì›`);
    const fmtPct = v => (v===null||v===undefined? '-' : `${(Number(v)).toFixed(2)}%`);

    // ===== ê³µìš© fetch =====
    async function jget(path){
      const res = await fetch(`${API}${path}`, {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // ===== í—¬ìŠ¤ì²´í¬ =====
    async function health(){
      try{
        const x = await jget('/ping');
        apiDotEl.classList.toggle('ok', !!x.ok);
      }catch(e){
        apiDotEl.classList.remove('ok');
      }
    }
    health(); setInterval(health, 15000);

    // ===== SPARK: ê¸‰ë“± ì „ ì˜ˆì—´ TOP10 =====
    const sparkListEl = document.getElementById('sparkList');
    const sparkMetaEl = document.getElementById('sparkMeta');
    const btnRefresh  = document.getElementById('btnRefresh');

    async function loadSpark(){
      try{
        const data = await jget('/spark?limit=10'); // Workerì—ì„œ ì œê³µ
        if (!data.ok) throw new Error('spark fail');
        const items = data.items || data.top || []; // í˜¸í™˜
        if (!items.length){
          sparkListEl.innerHTML = `<div class="muted" style="padding:12px">ì˜ˆì—´ ì½”ì¸ ì—†ìŒ</div>`;
          return;
        }
        sparkListEl.innerHTML = '';
        items.forEach((it)=>{
          const li = document.createElement('div');
          li.className = 'item';
          const name = (it.korean_name || it.kor || it.name || '').trim();
          const mkt  = (it.market || it.code || '').trim();
          const pct  = Number(it.changePct ?? it.changePct24h ?? it.change ?? 0).toFixed(2);
          li.innerHTML = `
            <div>
              <div><b>${name || mkt}</b></div>
              <div class="muted">${mkt}</div>
            </div>
            <div class="${pct>=0?'ok':'bad'}">${pct>=0?'+':''}${pct}%</div>
          `;
          li.onclick = ()=> selectMarket(mkt, name);
          sparkListEl.appendChild(li);
        });
      }catch(e){
        sparkListEl.innerHTML = `<div class="muted" style="padding:12px">SPARK ë¡œë“œ ì‹¤íŒ¨</div>`;
      }
    }
    btnRefresh.onclick = loadSpark;
    loadSpark();
    let sparkTimer = setInterval(loadSpark, 30000); // 30ì´ˆ ìë™ ìƒˆë¡œê³ ì¹¨

    // ===== ê²€ìƒ‰ ìë™ì—°ë™ =====
    const qEl = document.getElementById('q');
    const btnFind = document.getElementById('btnFind');

    async function findAndSelect(){
      const q = (qEl.value||'').trim().toUpperCase();
      if (!q) return;
      try{
        // ê°„ë‹¨í•œ ë§¤í•‘: KRW- ì ‘ë‘ê°€ ì—†ìœ¼ë©´ í›„ë³´êµ°ì—ì„œ ë§¤ì¹­
        // /upbit/markets ì—ì„œ ì „ì²´ ëª©ë¡ ë°›ì•„ íƒìƒ‰
        const all = await jget('/upbit/markets');
        const rows = all.items || all || [];
        // 1) ì •í™•í•œ ë§ˆì¼“ì½”ë“œ
        let hit = rows.find(r=> (r.market || '').toUpperCase() === q);
        // 2) ì‹¬ë³¼ ë§¤ì¹­
        if (!hit) hit = rows.find(r=> (r.market || '').toUpperCase().endsWith('-'+q));
        // 3) í•œê¸€ëª… í¬í•¨
        if (!hit) hit = rows.find(r=> (r.korean_name||'').includes(qEl.value.trim()));
        // 4) ê¸°ë³¸ KRW-ì‹¬ë³¼
        if (!hit) hit = rows.find(r=> (r.market||'').startsWith('KRW-') && (r.market||'').toUpperCase().endsWith('-'+q));
        if (hit){
          selectMarket(hit.market, hit.korean_name);
        }else{
          alert('ì¼ì¹˜í•˜ëŠ” ë§ˆì¼“ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      }catch(e){
        alert('ê²€ìƒ‰ ì‹¤íŒ¨: ' + e.message);
      }
    }
    btnFind.onclick = findAndSelect;
    qEl.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') findAndSelect(); });

    // ===== ULTRA ì‹œê·¸ë„ + Precision Boost =====
    const selNameEl = document.getElementById('selName');
    const mktChip   = document.getElementById('mktChip');
    const modeChip  = document.getElementById('modeChip');
    const atrChip   = document.getElementById('atrChip');
    const nowPrice  = document.getElementById('nowPrice');
    const chgRate   = document.getElementById('chgRate');
    const buy1      = document.getElementById('buy1');
    const tp1       = document.getElementById('tp1');
    const tp2       = document.getElementById('tp2');
    const sl        = document.getElementById('sl');
    const hi1       = document.getElementById('hi1');
    const lo1       = document.getElementById('lo1');
    const precChip  = document.getElementById('precChip');
    const confChip  = document.getElementById('confChip');
    const riskChip  = document.getElementById('riskChip');
    const msgChip   = document.getElementById('msgChip');

    let curMarket = null;
    let ultraTimer = null;

    // Precision Boost ê·œì¹™
    function applyPrecisionBoost(payload){
      // ì…ë ¥ ê°’
      const p    = Number(payload.price||0);
      let  buy   = Number(payload.buy1||payload.buy||p*0.996);
      let  t1    = Number(payload.tp1||p*1.02);
      let  t2    = Number(payload.tp2||p*1.04);
      let  s     = Number(payload.sl ||p*0.985);
      const atr  = Number(payload.atr||0);
      const mode = (payload.mode||'neutral'); // bull / bear / neutral
      const conf = Number(payload.confidence||payload.conf||0); // 0~100

      // 1) Â±0.3% ë¯¸ì„¸ë³´ì • ë£¨í”„ (3íšŒ)
      const micro = 0.003;
      for (let i=0;i<3;i++){
        t1 *= (1+micro/3); t2 *= (1+micro/3);
        s  *= (1-micro/3);
      }

      // 2) ë¶ˆì¥/í•˜ë½ì¥ ë³´ì •
      if (mode==='bull'){
        // ë¶ˆì¥: TP ìƒí–¥, SL ì™„í™”
        t1 = p + Math.max(1.6*atr, t1-p);
        t2 = p + Math.max(2.8*atr, t2-p);
        s  = p - Math.max(0.8*atr, p-s);
      }else if(mode==='bear'){
        // í•˜ë½ì¥: TP ë³´ìˆ˜í™”, SL ê°•í™”
        t1 = p + Math.min(0.6*atr, Math.max(0, t1-p));
        t2 = p + Math.min(1.0*atr, Math.max(0, t2-p));
        s  = p - Math.max(1.3*atr, p-s);
      }

      // 3) ì‹ ë¢°ë„ ê¸°ë°˜ ìœ„í—˜ë„ ì‚°ì¶œ(ë¼ì´íŠ¸)
      const risk = conf>=80? 1 : conf>=65? 2 : conf>=50? 3 : conf>=35? 4 : 5;

      return {
        price:p, buy1:buy, tp1:t1, tp2:t2, sl:s, atr, mode, risk,
        confidence: conf
      };
    }

    async function loadUltra(market){
      try{
        const data = await jget(`/ultra?market=${encodeURIComponent(market)}`);
        if (!data.ok) throw new Error('ultra fail');
        // Worker í‘œì¤€í™”: price, changePct, buy1,tp1,tp2,sl, hi1,lo1, atr, mode, confidence, message
        const x = data.item || data;

        // Precision Boost ì ìš©
        const boosted = applyPrecisionBoost(x);

        // í‘œê¸°
        nowPrice.textContent = fmtKRW(boosted.price);
        chgRate.innerHTML    = (x.changePct>=0? `<span class="ok">+${fmtPct(x.changePct)}</span>` : `<span class="bad">${fmtPct(x.changePct)}</span>`);
        buy1.textContent     = fmtKRW(boosted.buy1);
        tp1.textContent      = fmtKRW(boosted.tp1);
        tp2.textContent      = fmtKRW(boosted.tp2);
        sl.textContent       = fmtKRW(boosted.sl);
        hi1.textContent      = fmtKRW(x.hi1 ?? boosted.price*1.03);
        lo1.textContent      = fmtKRW(x.lo1 ?? boosted.price*0.97);

        atrChip.textContent  = `ATR: ${Number(boosted.atr||0).toFixed(2)}`;
        modeChip.textContent = `mode: ${boosted.mode||'neutral'}`;
        precChip.textContent = `Precision: Â±0.3% (3íšŒ)`;
        confChip.textContent = `Confidence: ${Number(boosted.confidence||0).toFixed(0)}`;
        riskChip.textContent = `ìœ„í—˜ë„: ${boosted.risk}`;
        msgChip.textContent  = `ì©”ì–´í•œë§ˆë””: ${x.message || 'ì‹ í˜¸ ë¶„ì„ ì™„ë£Œ'}`;
      }catch(e){
        nowPrice.textContent='-'; chgRate.textContent='-';
        buy1.textContent='-'; tp1.textContent='-'; tp2.textContent='-'; sl.textContent='-';
        hi1.textContent='-'; lo1.textContent='-';
        msgChip.textContent='ì©”ì–´í•œë§ˆë””: ë¡œë”© ì‹¤íŒ¨';
      }
    }

    function selectMarket(market, korName){
      if (!market) return;
      curMarket = market;
      selNameEl.textContent = (korName? `${korName} ` : '') + `(${market})`;
      mktChip.textContent   = `ë§ˆì¼“: ${market}`;
      // ì¦‰ì‹œ 1íšŒ ë¡œë“œ + 15ì´ˆë§ˆë‹¤ í‹± ê°±ì‹ 
      loadUltra(market);
      if (ultraTimer) clearInterval(ultraTimer);
      ultraTimer = setInterval(()=> loadUltra(market), 15000);
      // ê²€ìƒ‰ì°½ì— ìë™ ì±„ì›€
      qEl.value = market;
    }

    // ì´ˆê¸° ì§„ì…: URL ?m=KRW-XXX ì§€ì›
    (function initFromQuery(){
      const u = new URL(location.href);
      const m = u.searchParams.get('m');
      if (m) selectMarket(m);
    })();

  </script>
</body>
</html>
