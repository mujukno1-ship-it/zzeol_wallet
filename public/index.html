<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>사토시의지갑 — 대시보드 v12.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#0f1115; --panel:#171a21; --muted:#9aa4b2; --text:#e6edf3; --acc:#01d1a2; --chip:#222735; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 0 0 1px #101318 inset}
  h2{margin:0 0 12px 0;font-size:16px}
  .muted{color:var(--muted)}
  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input,button{background:#0d1016;border:1px solid #202636;color:var(--text);padding:10px 12px;border-radius:10px}
  button{cursor:pointer}
  .list{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto;padding-right:4px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;background:#10141c;cursor:pointer;border:1px solid #151a25}
  .item:hover{background:#121824}
  .col{display:flex;flex-direction:column}
  .name{font-weight:600}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{background:var(--chip);color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
  .ok{color:#16c784} .bad{color:#ff5252}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#10141c;padding:10px;border:1px solid #151a25;border-radius:10px;min-height:52px}
  .kv .k{font-size:12px;color:#9aa4b2}
  .kv .v{font-size:16px;margin-top:2px}
  .small{font-size:12px}
  .foot{margin-top:10px;color:#9aa4b2}
  .api{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .pill{background:#0e1320;border:1px solid #1b2232;border-radius:999px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="api">
    <span class="pill">API</span>
    <input id="apiBase" placeholder="https://satoshi-proxy.mujukno1.workers.dev/api" style="min-width:380px">
    <button id="save">저장</button>
    <span id="apiDot" class="pill" style="color:#aaa">•</span>
    <input id="search" placeholder="KRW-SHIB, 에이다, 시바이누…" style="flex:1">
    <button id="btnFind">검색</button>
  </div>

  <div class="row">
    <div class="card">
      <h2>🔥 SPARK TOP10 — 급등 전 예열코인 <span class="muted small">(자동 30초 새로고침)</span></h2>
      <div id="spark" class="list"></div>
    </div>

    <div class="card">
      <h2>⚡ ULTRA 시그널 — 선택된 코인</h2>
      <div class="chips" id="metaChips"></div>
      <div class="grid2" style="margin-top:8px">
        <div class="kv"><div class="k">현재가</div><div class="v" id="price">-</div></div>
        <div class="kv"><div class="k">변동률</div><div class="v" id="chg">-</div></div>
        <div class="kv"><div class="k">매수(BUY1)</div><div class="v" id="buy1">-</div></div>
        <div class="kv"><div class="k">익절 1 (TP1)</div><div class="v" id="tp1">-</div></div>
        <div class="kv"><div class="k">익절 2 (TP2)</div><div class="v" id="tp2">-</div></div>
        <div class="kv"><div class="k">손절 (SL)</div><div class="v" id="sl">-</div></div>
        <div class="kv"><div class="k">예상 저점 1</div><div class="v" id="low1">-</div></div>
        <div class="kv"><div class="k">예상 고점 1</div><div class="v" id="high1">-</div></div>
      </div>
      <div class="foot small" id="foot">코인을 선택하거나 검색하면 쩔어한마디가 표시됩니다.</div>
    </div>
  </div>
</div>

<script>
const ls = localStorage;
const $ = (q) => document.querySelector(q);
const apiInput = $('#apiBase');
const apiDot = $('#apiDot');
const sparkEl = $('#spark');
const searchEl = $('#search');

// --- 업비트 KRW 틱 반올림 (저가코인 완벽 대응) ---
function tickRoundKRW(p){
  p = Number(p||0);
  if (p >= 2000000) return Math.round(p/1000)*1000;
  if (p >= 1000000) return Math.round(p/500)*500;
  if (p >= 500000)  return Math.round(p/100)*100;
  if (p >= 100000)  return Math.round(p/50)*50;
  if (p >= 10000)   return Math.round(p/10)*10;
  if (p >= 1000)    return Math.round(p/5)*5;
  if (p >= 100)     return Math.round(p/1)*1;
  if (p >= 10)      return Math.round(p/0.1)*0.1;
  if (p >= 1)       return Math.round(p/0.01)*0.01;
  if (p >= 0.1)     return Math.round(p/0.001)*0.001; // SHIB 등
  return Math.round(p/0.0001)*0.0001;
}
const fmt = (n) => (typeof n === 'number' ? n.toLocaleString('ko-KR') : n);

// --- API BASE ---
function base() {
  return (ls.getItem('API_BASE') || apiInput.placeholder).replace(/\/+$/,'');
}
function setDot(ok){ apiDot.textContent = ok ? '●' : '●'; apiDot.style.color = ok ? '#19c37d' : '#ff6a6a'; }

$('#save').onclick = async () => {
  ls.setItem('API_BASE', apiInput.value.trim());
  await ping();
};
async function ping(){
  try{
    const r = await fetch(base().replace(/\/api$/,'/api') || base()+"/api");
    setDot(r.ok);
  }catch(e){ setDot(false); }
}
(function init(){
  apiInput.value = ls.getItem('API_BASE') || apiInput.placeholder;
  ping();
})();

// --- SPARK ---
async function fetchSpark(){
  try{
    const r = await fetch(`${base()}/spark?limit=10`, { cache: 'no-store' });
    const j = await r.json();
    if (!j.ok) throw 0;
    renderSpark(j.items || []);
  }catch(e){
    sparkEl.innerHTML = `<div class="muted">SPARK 불러오기 실패</div>`;
  }
}
function renderSpark(items){
  sparkEl.innerHTML = '';
  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="col">
        <div class="name">${it.korean_name || it.market.replace('KRW-','')}</div>
        <div class="muted small">${it.market}</div>
      </div>
      <div class="col" style="align-items:end">
        <div class="${it.changePct>=0?'ok':'bad'}">${(it.changePct>=0?'+':'')+it.changePct.toFixed(2)}%</div>
        <div class="chips">
          <span class="chip">RVOL ${fmt(it.rvol)}</span>
          <span class="chip">SCORE ${fmt(it.score.toFixed(2))}</span>
        </div>
      </div>`;
    el.onclick = ()=> loadUltra(it.market);
    sparkEl.appendChild(el);
  });
}

// --- 검색 ---
$('#btnFind').onclick = doFind;
searchEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doFind(); });
async function doFind(){
  let q = searchEl.value.trim();
  if (!q) return;
  // KRW-XXX 형태가 아니면 KRW- 접두 자동 보정 (영/한 모두 허용)
  if (!/^KRW-[A-Z0-9]+$/i.test(q)) {
    // 이미 KRW-한글은 업비트에 없음 → 단순히 KRW- 대문자 영문 심볼만 빠르게 처리
    q = q.toUpperCase().startsWith('KRW-') ? q.toUpperCase() : ('KRW-' + q.toUpperCase());
  }
  await loadUltra(q);
}

// --- ULTRA 표시 ---
async function loadUltra(market){
  setFoot('분석 중…');
  try{
    const r = await fetch(`${base()}/ultra?market=${encodeURIComponent(market)}&limit=120`, { cache:'no-store' });
    const j = await r.json();
    if (!j.ok) throw 0;

    $('#price').textContent = fmt(j.priceTick ?? tickRoundKRW(j.price));
    // 변화율은 ticker로 보강
    const t = await (await fetch(`${base()}/ticker?market=${encodeURIComponent(market)}`, { cache:'no-store' })).json();
    const cp = t?.changePct ?? 0;
    $('#chg').innerHTML = `<span class="${cp>=0?'ok':'bad'}">${(cp>=0?'+':'')+cp.toFixed(2)}%</span>`;

    $('#buy1').textContent = fmt(j.buy1);
    $('#tp1').textContent = fmt(j.tp1);
    $('#tp2').textContent = fmt(j.tp2);
    $('#sl').textContent  = fmt(j.sl);

    // 보조 표기
    $('#high1').textContent = fmt(tickRoundKRW((j.price||0) * 1.03));
    $('#low1').textContent  = fmt(tickRoundKRW((j.price||0) * 0.97));

    renderMeta(market, j.mode, j.atr, j.atrPct);
    setFoot(`쩔어한마디: 모드=${j.mode} · ATR=${j.atr?.toFixed?.(0)} · 정밀틱 적용`);
  }catch(e){
    setFoot('ULTRA 로딩 실패');
  }
}
function renderMeta(market, mode, atr, atrPct){
  const m = $('#metaChips'); m.innerHTML = '';
  [['마켓', market], ['mode', mode||'neutral'], ['ATR', (atr||0).toFixed(0)], ['ATR%', (atrPct||0).toFixed(2)]]
    .forEach(([k,v])=>{
      const s = document.createElement('span'); s.className='chip'; s.textContent=`${k}: ${v}`; m.appendChild(s);
    });
}
function setFoot(txt){ $('#foot').textContent = txt; }

// --- 주기 갱신 ---
fetchSpark();
setInterval(fetchSpark, 30000);

// 초기가능: 쿼리 ?m=KRW-XXX
(function initQuery(){
  const u = new URL(location.href);
  const m = u.searchParams.get('m');
  if (m) loadUltra(m);
})();
</script>
</body>
</html>
