<script>
/* ========== Cloudflare Worker API 연결/안정화 한방 패치 ========== */

/** 1) 여기에 너의 Worker URL을 넣어! (예: https://satoshi-proxy.mujukno1.workers.dev) */
const API_BASE = "https://satoshi-proxy.<너의-워커-서브도메인>.workers.dev";

/** 2) 화면 흔들림 방지: 리스트 영역 고정 높이 + 로딩 상태 처리 */
(() => {
  const css = `
    #listWrap { min-height: 520px; }
    .loading-dim { opacity: .6; pointer-events: none; }
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);
})();

/** 3) 공통 fetch 유틸 + 단일 진행(중복호출 방지) */
let inflight = new Map();
async function getJSON(path, params = {}) {
  const url = new URL(API_BASE + path);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const key = url.toString();
  if (inflight.has(key)) return inflight.get(key);

  const p = (async () => {
    const res = await fetch(url.toString(), { cache: "no-store" });
    if (!res.ok) throw new Error(`API ${res.status} ${res.statusText}`);
    return res.json();
  })().finally(() => inflight.delete(key));

  inflight.set(key, p);
  return p;
}

/** 4) API 래퍼 (기존 기능 이름 그대로 유지) */
function apiSummary(market)     { return getJSON("/summary",     { market }); }
function apiTop(kind="rising")  { return getJSON("/top",         { kind   }); }   // kind: rising|spike|dump
function apiSpike()             { return getJSON("/spike"); }
function apiDump()              { return getJSON("/dump"); }
function apiSpark()             { return getJSON("/spark"); }
function apiSparkHistory()      { return getJSON("/spark-history"); }

/** 5) DOM 헬퍼 */
const $  = (id) => document.getElementById(id);
const put = (id, html) => { const el = $(id); if (el) el.innerHTML = html; };

/** 6) 업비트 KRW 호가단위(검색 코인 저가/고가 호가 일치) */
function tickSizeKRW(p){
  p = Number(p)||0;
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000)  return 100;
  if(p>=100000)  return 50;
  if(p>=10000)   return 10;
  if(p>=1000)    return 5;
  if(p>=100)     return 1;
  if(p>=10)      return 0.1;
  if(p>=1)       return 0.01;
  if(p>=0.1)     return 0.001;
  return 0.0001;
}
function roundTick(v, dir='nearest'){
  const t = tickSizeKRW(v);
  const n = v / t;
  if(dir==='down')  return Math.floor(n)*t;
  if(dir==='up')    return Math.ceil(n)*t;
  return Math.round(n)*t;
}
const pct = (v)=>`${(Number(v)||0).toFixed(2)}%`;

/** 7) "쩔어 한마디" 계산 (요약 → 매수/매도/손절) */
function oneLinerFromSummary(s){
  try{
    // 예시 로직: 프리미엄, 등락률, 스테이블 유입/유출 등을 종합(가벼운 휴리스틱)
    const prem = Number(s?.kimchi?.premium ?? 0);            // %
    const chg  = Number(s?.change_rate ?? 0);                 // %
    const flow = Number(s?.stable_flow?.net_krw ?? 0);        // +유입 / -유출
    const risk = (flow<0?-1:1) * (Math.abs(prem)/3 + chg/2);
    if (risk > 2.5) return "매수 우세: 추세상승 + 유입";
    if (risk < -2.5) return "매도/관망: 유출 + 하락 압력";
    return "관망: 변동성 주의";
  }catch{ return "관망"; }
}

/** 8) 검색 핸들러(기존 버튼과 연결) */
async function handleSearch(){
  try{
    const kw = ($("query")?.value || $("search")?.value || "").trim();
    if(!kw) return;
    const market = kw.includes('-') ? kw : `KRW-${kw.toUpperCase()}`;
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.add("loading-dim");

    const s = await apiSummary(market);
    // === 여기서 화면 채우기 ===
    put("coin-name",      s?.symbol ?? market);
    put("price-now",      (s?.price ?? 0).toLocaleString());
    put("chg-rate",       pct(s?.change_rate ?? 0));
    put("kimchi-premium", pct(s?.kimchi?.premium ?? 0));
    put("stable-usd-flow", (s?.stable_flow?.desc ?? "-"));

    // 타점 계산(호가 단위 적용)
    const basis = Number(s?.price ?? 0);
    const buy  = roundTick(basis * 0.998, 'down'); // 살짝 눌림 매수
    const sell = roundTick(basis * 1.006, 'up');   // 단기 익절
    const stop = roundTick(basis * 0.985, 'down'); // 손절 라인
    put("buy-line",  buy.toLocaleString());
    put("sell-line", sell.toLocaleString());
    put("stop-line", stop.toLocaleString());

    // 쩔어 한마디
    const line = oneLinerFromSummary(s);
    put("oneliner", line);

  }catch(e){
    console.error(e);
    put("oneliner", "데이터 오류: 잠시 후 재시도");
  }finally{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.remove("loading-dim");
  }
}

/** 9) 상단 버튼: 상승TOP10/급등/급락/스파크/히스토리 (기존 이름 유지) */
async function loadList(kind="rising"){ // rising|spike|dump
  try{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.add("loading-dim");
    const data = await apiTop(kind);
    renderCoinList(data);
  }catch(e){ console.error(e); }
  finally{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.remove("loading-dim");
  }
}
async function loadSpike(){ return loadList("spike"); }
async function loadDump(){  return loadList("dump");  }

async function loadSpark(){
  try{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.add("loading-dim");
    const data = await apiSpark();
    renderCoinList(data);
  }catch(e){ console.error(e); }
  finally{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.remove("loading-dim");
  }
}
async function loadSparkHistory(){
  try{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.add("loading-dim");
    const data = await apiSparkHistory();
    renderCoinList(data);
  }catch(e){ console.error(e); }
  finally{
    const wrap = $("listWrap") || $("listTable")?.parentElement || document.body;
    wrap.classList.remove("loading-dim");
  }
}

/** 10) 리스트 렌더(네가 쓰던 테이블 구조에 맞춰 여기를 한번만 맞추면 모든 버튼 OK) */
function renderCoinList(items=[]){
  const tbody = $("listBody") || $("listTable")?.querySelector("tbody");
  if(!tbody) return;
  const rows = (items||[]).map(it=>{
    const sym = it.symbol || it.market || "-";
    const price = Number(it.price ?? it.trade_price ?? 0).toLocaleString();
    const chg = Number(it.change_rate ?? it.signed_change_rate*100 || 0).toFixed(2);
    return `<tr>
      <td>${sym}</td>
      <td class="right">${price}</td>
      <td class="right ${chg>=0?'up':'down'}">${chg}%</td>
    </tr>`;
  }).join("");
  tbody.innerHTML = rows || `<tr><td colspan="3">데이터 없음</td></tr>`;
}

/* ========== 끝 ========== */
</script>
