<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v12 â€” KRW ì‹¤ì‹œê°„</title>
<style>
  :root{
    --bg:#0e1116; --panel:#151a21; --muted:#8a94a6; --text:#e7edf5; --accent:#5ac8fa; --danger:#ff6b6b; --ok:#7ee081; --warn:#ffd166;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,apple-system,Segoe UI,Roboto,Pretendard,Helvetica,Arial}
  .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
  .row{display:grid;gap:16px}
  .panel{background:var(--panel);border-radius:var(--radius);border:1px solid #1e2530;padding:16px}
  .title{margin:0 0 10px;font-weight:700;font-size:16px}
  .sub{color:var(--muted);font-size:12px}
  .k-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){.k-row{grid-template-columns:1fr}}
  .search{display:flex;gap:8px;align-items:center}
  .search input{
    flex:1;height:44px;border-radius:12px;border:1px solid #222a35;background:#0f141b;color:var(--text);padding:0 14px;font-size:16px}
  .chip{height:28px;padding:0 10px;border-radius:999px;background:#101722;border:1px solid #1e2430;color:#bcd;display:inline-flex;align-items:center;gap:6px}
  .list{display:grid;gap:8px}
  .li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #1f2732;background:#0f141b}
  .btn{cursor:pointer;user-select:none;border:1px solid #2b3646;background:#131a24;color:#d6e3f5;border-radius:10px;height:32px;padding:0 10px}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #253243;background:#0f1721;color:#cbd6e6}
  .green{color:var(--ok)} .red{color:var(--danger)} .yellow{color:var(--warn)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:4px 0}
  .val{font-weight:700}
  hr{border:none;height:1px;background:#1b2330;margin:10px 0}
  .right{justify-self:end}
  .small{font-size:12px;color:#aab6c8}
  /* No-Motion: ì• ë‹ˆ/íŠ¸ëœì§€ì…˜ ì „ë¶€ ì œê±° */
  *, *:before, *:after {transition:none !important; animation:none !important}
</style>
</head>
<body>
<div class="wrap">
  <!-- ê²€ìƒ‰ (ìƒë‹¨ ê³ ì •, ê²°ê³¼ 5ê°œ ì œí•œ, No-Motion) -->
  <div class="panel">
    <div class="search">
      <input id="q" placeholder="ì½”ì¸ ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ì…ë ¥â€¦ (KRW ì „ìš©)" autocomplete="off" />
      <button id="btnKRW" class="btn chip">KRW ê¸°ì¤€</button>
      <button id="btnNoMotion" class="btn chip">No-Motion</button>
    </div>
    <div id="searchBox" class="list" style="margin-top:10px"></div>
    <div class="small">ê²€ìƒ‰ ê²°ê³¼ëŠ” ì…ë ¥ ì‹œ í‘œì‹œ (ìµœëŒ€ 5ê°œ). ê²°ê³¼/í™”ë©´ ê¹œë¹¡ì„ ì—†ì´ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
  </div>

  <div class="row">
    <!-- ULTRA: ì„ íƒ ì½”ì¸ íƒ€ì /ë©˜íŠ¸ -->
    <div class="panel">
      <h3 class="title">âš¡ ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸ <span id="ultraMarket" class="pill"></span></h3>
      <div id="ultraEmpty" class="small">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="ultra" style="display:none">
        <div class="k-row">
          <div>
            <div class="kv"><div>í˜„ì¬ê°€</div><div class="val" id="now"></div></div>
            <div class="kv"><div>ìœ„í—˜ë„</div><div id="risk"></div></div>
            <div class="kv"><div>ì˜ˆìƒìƒìŠ¹ë¥ </div><div id="rise"></div></div>
            <div class="kv"><div>ì˜ˆìƒí•˜ë½ë¥ </div><div id="fall"></div></div>
          </div>
          <div>
            <div class="kv"><div>ë§¤ìˆ˜(BUY1)</div><div class="val" id="buy1"></div></div>
            <div class="kv"><div>ë§¤ìˆ˜(BUY2)</div><div class="val" id="buy2"></div></div>
            <div class="kv"><div>ìµì ˆ(TP1 / TP2)</div><div class="val" id="tp"></div></div>
            <div class="kv"><div>ì†ì ˆ(SL)</div><div class="val red" id="sl"></div></div>
          </div>
        </div>
        <hr/>
        <div class="kv">
          <div>ì©”ì–´í•œë§ˆë””</div>
          <div id="ment" class="small"></div>
        </div>
      </div>
    </div>

    <!-- SPARK: ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€ (TOP10 ìƒì‹œë…¸ì¶œ) -->
    <div class="panel">
      <h3 class="title">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€</h3>
      <div class="small">í•„í„°: RVOLÂ·TBRÂ·OBIÂ·ForceIndex ì¢…í•©, 5ë¶„ë³€ë™ â‰¥ +1.5% (4ê°œâ†‘ ì˜ˆì—´ í™•ì •). í´ë¦­ ì‹œ ULTRAë¡œ ì—°ë™.</div>
      <div id="spark" class="list" style="margin-top:10px"></div>
      <div id="sparkEmpty" class="small">SPARK ë°ì´í„° ì—†ìŒ.</div>
    </div>
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // í—¬ìŠ¤: /health
const ENDPOINTS = {
  markets: API_BASE + "/upbit/markets",     // KRW ë§ˆì¼“ + í•œê¸€ëª…
  spark:   API_BASE + "/spark/top10",       // SPARK TOP10
  ultra:   API_BASE + "/ultra/signal"       // ?market=KRW-XXX
};

// KRW ê°€ê²© í˜¸ê°€í‹±(ì—…ë¹„íŠ¸ ê·œì¹™) ë°˜ì˜¬ë¦¼
function roundUpbitKRW(p){
  p = Number(p);
  const abs = Math.abs(p);
  let tick = 1;
  if (abs >= 2_000_000) tick = 1000;
  else if (abs >= 1_000_000) tick = 500;
  else if (abs >= 500_000) tick = 100;
  else if (abs >= 100_000) tick = 50;
  else if (abs >= 10_000) tick = 10;
  else if (abs >= 1_000) tick = 5;
  else if (abs >= 100) tick = 1;
  else if (abs >= 10) tick = 0.1;
  else tick = 0.01;
  return Math.round(p / tick) * tick;
}
function fmtKRW(n){
  // 0.01 ë‹¨ìœ„ê¹Œì§€ í‘œì‹œ
  const fixed = (n < 10 ? 2 : 0);
  const s = (fixed ? n.toFixed(2) : Math.round(n).toString());
  return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "ì›";
}
function pct(n, sign=true){ const v = (n===null||n===undefined)?0:n; return (sign&&v>0?"+":"") + v.toFixed(1) + "%"; }

// No-Motion: DOM êµì²´ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ê°±ì‹ 
function setText(el, v){ if(el && el.textContent !== v) el.textContent = v; }
function setHTML(el, v){ if(el && el.innerHTML !== v) el.innerHTML = v; }

// ìƒíƒœ
let KRW_MARKETS = []; // {market:"KRW-ETH", korean_name:"ì´ë”ë¦¬ì›€", ...}
let LAST_SPARK = [];
let currentMarket = null;

// ê³µí†µ fetch (CORS/ì—ëŸ¬ ì•ˆì „)
async function jget(url){
  const r = await fetch(url, {mode:'cors',cache:'no-cache'});
  if(!r.ok){ throw new Error("HTTP " + r.status); }
  return r.json();
}

/** ====== ì´ˆê¸° ë¡œë“œ ====== **/
init();
async function init(){
  try{
    await loadMarkets();
    wireSearch();
    await loadSpark();
  }catch(e){
    console.error(e);
    setHTML(document.getElementById('spark'), "");
    setText(document.getElementById('sparkEmpty'), "ì—°ë™ ì‹¤íŒ¨: " + (e?.message||e));
  }
}

/** ====== ë§ˆì¼“ ëª©ë¡ ====== **/
async function loadMarkets(){
  const js = await jget(ENDPOINTS.markets);
  // KRW ì „ìš© + í•œê¸€ëª… ë³´ìœ 
  KRW_MARKETS = (js || []).filter(x=> String(x.market||"").startsWith("KRW-"));
}

/** ====== SPARK ====== **/
async function loadSpark(){
  const box = document.getElementById('spark');
  const empty = document.getElementById('sparkEmpty');
  setHTML(box, ""); setText(empty, "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");

  let data;
  try{
    data = await jget(ENDPOINTS.spark);
  }catch(e){
    setText(empty, "SPARK ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (e?.message||e));
    return;
  }
  LAST_SPARK = Array.isArray(data)? data : (data.items || []);

  if(!LAST_SPARK.length){ setText(empty, "SPARK ë°ì´í„° ì—†ìŒ."); return; }
  setText(empty, "");

  // ë Œë” (TOP10)
  const frag = document.createDocumentFragment();
  LAST_SPARK.slice(0,10).forEach(item=>{
    const li = document.createElement('div'); li.className = 'li';
    const left = document.createElement('div');
    const right = document.createElement('div'); right.className='right small';

    const name = (item.korean_name || item.market || "").replace("KRW-","");
    const price = Number(item.price||0);
    const score = Number(item.spark_score||item.force_index||0);
    const prob = item.prob || item.prob_up || null; // ìˆì„ ë•Œë§Œ
    const badge = document.createElement('span'); badge.className='pill';
    const label = (score>=90 ? "í­ë°œ ì„ë°•" : score>=80 ? "ê°•ë ¥ ì˜ˆì—´" : score>=70 ? "ì˜ˆì—´" : "ê´€ë§");
    badge.textContent = `${label} â€¢ ${score|0}ì `;

    left.innerHTML = `<b>${name}</b> <span class="small">(${item.market})</span><br/><span class="small">${fmtKRW(price)}</span> `;
    left.appendChild(badge);

    const b = document.createElement('button'); b.className='btn'; b.textContent='ì„ íƒ';
    b.onclick = ()=>selectMarket(item.market);

    if (prob!=null){
      right.textContent = `ìƒìŠ¹í™•ë¥  ${pct(Number(prob),false)}`;
    }

    li.append(left,right,b);
    frag.append(li);
  });
  box.appendChild(frag);
}

/** ====== ULTRA ====== **/
async function selectMarket(market){
  currentMarket = market;
  setText(document.getElementById('ultraMarket'), market || "");
  setDisplay('ultraEmpty', false); setDisplay('ultra', true);

  try{
    const js = await jget(ENDPOINTS.ultra + "?market=" + encodeURIComponent(market));
    renderUltraFromAPI(js);
  }catch(e){
    // APIê°€ í¼ì„¼íŠ¸ ì œê³µ ì•ˆí•  ë•Œ: ê¸°ë³¸ ì•ˆì „ ê³„ì‚° (ì˜ˆì—´/ë¦¬ìŠ¤í¬ì— ë”°ë¼)
    console.warn("ULTRA ì—°ë™ ì‹¤íŒ¨, ì•ˆì „ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´:", e?.message||e);
    fallbackUltra(market);
  }
}
function setDisplay(id, show){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = show? '' : 'none';
}
function renderUltraFromAPI(js){
  const m = document.getElementById('ultraMarket');
  const now = Number(js?.price ?? js?.now ?? 0);
  const rUp = Number(js?.expected_rise ?? js?.rise ?? 0);     // %
  const rDn = Number(js?.expected_fall ?? js?.fall ?? 0);     // %
  const risk = Number(js?.risk ?? js?.risk_level ?? 3);

  // í˜¸ê°€í‹± ë°˜ì˜ ê³„ì‚°
  const BUY1 = roundUpbitKRW(js?.buy1 ?? now * (1 - Math.max(rDn,1)/100 * 0.5));
  const BUY2 = roundUpbitKRW(js?.buy2 ?? now * (1 - Math.max(rDn,1)/100));
  const TP1  = roundUpbitKRW(js?.tp1  ?? now * (1 + Math.max(rUp,1)/100 * 0.6));
  const TP2  = roundUpbitKRW(js?.tp2  ?? now * (1 + Math.max(rUp,1)/100));
  const SL   = roundUpbitKRW(js?.sl   ?? now * (1 - Math.max(rDn,1)/100 * 0.7));

  setText(document.getElementById('now'), fmtKRW(now));
  setText(document.getElementById('risk'), `ë ˆë²¨ ${risk}`);
  setText(document.getElementById('rise'), pct(rUp));
  setText(document.getElementById('fall'), pct(rDn,false).replace("-","") + "â†“");

  setText(document.getElementById('buy1'), fmtKRW(BUY1));
  setText(document.getElementById('buy2'), fmtKRW(BUY2));
  setText(document.getElementById('tp'),   `${fmtKRW(TP1)} / ${fmtKRW(TP2)}`);
  setText(document.getElementById('sl'),   fmtKRW(SL));

  // ì©”ì–´ë©˜íŠ¸ (ë¶„ì„í˜•)
  const mode = js?.mode || (rUp>=15? "ë¶ˆì¥" : (rDn>=8? "í•˜ë½" : "ì¡°ì •"));
  const spark = Number(js?.spark_score ?? 0);
  const fi = Number(js?.force_index ?? 0);
  const prob = Number(js?.prob_up ?? js?.prob ?? 0);
  const msg = buildMent(mode, spark, prob, rUp, rDn, fi);
  setText(document.getElementById('ment'), msg);
}
function fallbackUltra(market){
  // SPARK/ë§ˆì¼“ ê°€ê²©ì„ ì´ìš©í•œ ë³´ìˆ˜ì  ê³„ì‚°
  const s = LAST_SPARK.find(x=>x.market===market) || {};
  const now = Number(s.price||0);
  const score = Number(s.spark_score||0);

  const estUp = score>=90 ? 18 : score>=80 ? 11 : score>=70 ? 6 : 3;
  const estDn = score>=90 ? 6  : score>=80 ? 8  : score>=70 ? 7 : 5;
  const risk  = score>=90 ? 3  : score>=80 ? 2  : score>=70 ? 2 : 1;

  const BUY1 = roundUpbitKRW(now * (1 - estDn/100 * 0.5));
  const BUY2 = roundUpbitKRW(now * (1 - estDn/100));
  const TP1  = roundUpbitKRW(now * (1 + estUp/100 * 0.6));
  const TP2  = roundUpbitKRW(now * (1 + estUp/100));
  const SL   = roundUpbitKRW(now * (1 - estDn/100 * 0.7));

  setText(document.getElementById('now'), fmtKRW(now));
  setText(document.getElementById('risk'), `ë ˆë²¨ ${risk}`);
  setText(document.getElementById('rise'), pct(estUp));
  setText(document.getElementById('fall'), pct(estDn,false).replace("-","") + "â†“");
  setText(document.getElementById('buy1'), fmtKRW(BUY1));
  setText(document.getElementById('buy2'), fmtKRW(BUY2));
  setText(document.getElementById('tp'),   `${fmtKRW(TP1)} / ${fmtKRW(TP2)}`);
  setText(document.getElementById('sl'),   fmtKRW(SL));

  const ment = buildMent(score>=80?"ë¶ˆì¥":score>=70?"ì˜ˆì—´":"ì¡°ì •", score, (60+score/2), estUp, estDn, score);
  setText(document.getElementById('ment'), ment);
}

/** ====== ì©”ì–´ ë©˜íŠ¸ ìƒì„± (ë¶„ì„í˜•) ====== **/
function buildMent(mode, sparkScore, probUp, risePct, fallPct, forceIdx){
  const parts = [];
  const tag = (t)=>`ã€${t}ã€‘`;
  parts.push(mode==="ë¶ˆì¥" ? tag("ğŸ”¥ ë¶ˆì¥") : mode==="í•˜ë½" ? tag("âš  í•˜ë½") : tag("â†” ì¡°ì •"));
  if (sparkScore) parts.push(`ì˜ˆì—´ê°•ë„ ${sparkScore|0}`);
  if (probUp) parts.push(`ìƒìŠ¹í™•ë¥  ${pct(Number(probUp),false)}`);
  if (risePct) parts.push(`ì˜ˆìƒìƒìŠ¹ë¥  ${pct(Number(risePct),false)}`);
  if (fallPct) parts.push(`ì˜ˆìƒí•˜ë½ë¥  ${pct(Number(fallPct),false)}`);
  if (forceIdx) parts.push(`ì„¸ë ¥ì§€ìˆ˜ ${forceIdx|0}`);

  // í–‰ë™ ê¶Œê³ 
  let action = "";
  if(mode==="ë¶ˆì¥"){ action = "ìµì ˆ ì§€ì—°Â·ë¶„í• í™€ë”©, SL ì™„í™”. ëˆŒë¦¼ ì‹œ BUY2 ê³ ë ¤."; }
  else if(mode==="í•˜ë½"){ action = "ì¶”ê°€ì§„ì… ê¸ˆì§€, íƒ€ì„ì•„ì›ƒ ì²­ì‚°/íŠ¸ë ˆì¼ë§ ê°•í™”."; }
  else { action = "ë˜ëŒë¦¼ ì‹œ ë¶„í• ì§„ì…, POC/VWAP ì¬í…ŒìŠ¤íŠ¸ í™•ì¸ í›„ ëŒ€ì‘."; }

  return parts.join(" / ") + " â€” " + action;
}

/** ====== ê²€ìƒ‰: ì…ë ¥ ì‹œ 5ê°œ ì œí•œ, ê²°ê³¼ í­=ê²€ìƒ‰ë°•ìŠ¤ í­ ====== **/
function wireSearch(){
  const q = document.getElementById('q');
  const box = document.getElementById('searchBox');
  q.addEventListener('input', ()=>{
    const s = (q.value||"").trim();
    box.innerHTML = "";
    if(!s){ return; }
    const low = s.toLowerCase();
    const m = KRW_MARKETS.filter(x=>{
      return x.korean_name?.toLowerCase().includes(low) || x.market?.toLowerCase().includes(low);
    }).slice(0,5);
    m.forEach(row=>{
      const li = document.createElement('div'); li.className='li';
      const left = document.createElement('div');
      const right = document.createElement('div'); right.className='right small';
      left.innerHTML = `<b>${row.korean_name}</b> <span class="small">(${row.market})</span>`;
      right.textContent = "ì„ íƒ ì‹œ íƒ€ì  í‘œì‹œ";
      const b = document.createElement('button'); b.className='btn'; b.textContent='ì„ íƒ';
      b.onclick = ()=>{ selectMarket(row.market); q.blur(); };
      li.append(left,right,b); box.appendChild(li);
    });
  });
}

// ìœ í‹¸ ë²„íŠ¼(ë³´ê¸°ìš©)
document.getElementById('btnKRW').onclick = ()=>alert("KRW ê¸°ì¤€ / ì—…ë¹„íŠ¸ í˜¸ê°€í‹± / í•œê¸€ ì½”ì¸ëª… â€” ì´ë¯¸ ì ìš©ë¨");
document.getElementById('btnNoMotion').onclick = ()=>alert("No-Motion ëª¨ë“œ â€” ëª¨ë“  ì• ë‹ˆ/íŠ¸ëœì§€ì…˜ ë¹„í™œì„±í™”");

</script>
  <script>
/* â–¼â–¼ ì¶”ê°€: ì–´ë–¤ í˜•ì‹ì´ ì™€ë„ ë°°ì—´ë¡œ ë°”ê¿”ì£¼ëŠ” ìœ í‹¸ */
function asArr(x){
  if (Array.isArray(x)) return x;
  if (x && Array.isArray(x.items)) return x.items;      // {items:[...]}
  if (x && Array.isArray(x.data))  return x.data;       // {data:[...]}
  if (x && typeof x === 'object') {
    // { "KRW-BTC": {...}, "KRW-ETH": {...} } í˜•íƒœë„ ëŒ€ì‘
    const vals = Object.values(x).filter(v=>v!=null);
    // ê°’ë“¤ì´ ë°°ì—´ í•œ ê²¹ ë” ë“¤ì–´ìˆëŠ” ê²½ìš° [ [...], [...]]
    if (vals.length && Array.isArray(vals[0])) return vals.flat();
    return vals;
  }
  return [];
}

/* â–¼â–¼ ê³µí†µ fetch (ê·¸ëŒ€ë¡œ, ë‹¨ ok:false ì²˜ë¦¬ë§Œ ì¶”ê°€) */
async function jget(url){
  const r = await fetch(url, {mode:'cors',cache:'no-cache'});
  const js = await r.json().catch(()=>null);
  if (!r.ok) throw new Error("HTTP " + r.status);
  if (js && js.ok === false) throw new Error(js.error || "API ok:false");
  return js;
}

/* â–¼â–¼ ë§ˆì¼“ ëª©ë¡ ë¡œë” â€” ì‘ë‹µì„ ë°°ì—´ë¡œ ì •ê·œí™” */
async function loadMarkets(){
  const js = await jget(ENDPOINTS.markets);
  const arr = asArr(js);
  // ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ê°€ {market, korean_name}ê°€ ì•„ë‹Œ ê²½ìš° í‚¤ ë§ì¶¤
  KRW_MARKETS = arr
    .map(x=>{
      // í‘œì¤€í‚¤ ë³´ì •
      const market = x.market || x.code || x.ticker || "";
      const korean = x.korean_name || x.korName || x.name_kr || x.name || "";
      return { market, korean_name: korean };
    })
    .filter(x => String(x.market||"").startsWith("KRW-"));
}

/* â–¼â–¼ SPARK ë¡œë” â€” ì‘ë‹µì„ ë°°ì—´ë¡œ ì •ê·œí™” + ì—ëŸ¬ ì¶œë ¥ */
async function loadSpark(){
  const box = document.getElementById('spark');
  const empty = document.getElementById('sparkEmpty');
  setHTML(box, ""); setText(empty, "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
  let data;
  try{
    const js = await jget(ENDPOINTS.spark);
    data = asArr(js);
  }catch(e){
    setText(empty, "SPARK ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (e?.message||e));
    return;
  }
  LAST_SPARK = data.map(it=>{
    return {
      market: it.market || it.code || it.ticker || "",
      korean_name: it.korean_name || it.korName || it.name_kr || it.name || "",
      price: Number(it.price ?? it.now ?? it.last ?? 0),
      spark_score: Number(it.spark_score ?? it.score ?? it.force_index ?? 0),
      prob_up: it.prob_up ?? it.prob ?? null,
      force_index: Number(it.force_index ?? 0)
    };
  }).filter(x=>x.market.startsWith("KRW-"));

  if(!LAST_SPARK.length){ setText(empty, "SPARK ë°ì´í„° ì—†ìŒ."); return; }
  setText(empty, "");
  const frag = document.createDocumentFragment();
  LAST_SPARK.slice(0,10).forEach(item=>{
    const li = document.createElement('div'); li.className = 'li';
    const left = document.createElement('div');
    const right = document.createElement('div'); right.className='right small';

    const name = (item.korean_name || item.market || "").replace("KRW-","");
    const price = Number(item.price||0);
    const score = Number(item.spark_score||item.force_index||0);
    const prob = item.prob_up ?? null;

    const badge = document.createElement('span'); badge.className='pill';
    const label = (score>=90 ? "í­ë°œ ì„ë°•" : score>=80 ? "ê°•ë ¥ ì˜ˆì—´" : score>=70 ? "ì˜ˆì—´" : "ê´€ë§");
    badge.textContent = `${label} â€¢ ${score|0}ì `;

    left.innerHTML = `<b>${name}</b> <span class="small">(${item.market})</span><br/><span class="small">${fmtKRW(price)}</span> `;
    left.appendChild(badge);

    const b = document.createElement('button'); b.className='btn'; b.textContent='ì„ íƒ';
    b.onclick = ()=>selectMarket(item.market);

    if (prob!=null){ right.textContent = `ìƒìŠ¹í™•ë¥  ${pct(Number(prob),false)}`; }

    li.append(left,right,b);
    frag.append(li);
  });
  box.appendChild(frag);
}

/* â–¼â–¼ ULTRA ì„ íƒ â€” ok:false/ë¹„ì •í˜• ì‘ë‹µ ëŒ€ë¹„ */
async function selectMarket(market){
  currentMarket = market;
  setText(document.getElementById('ultraMarket'), market || "");
  setDisplay('ultraEmpty', false); setDisplay('ultra', true);
  try{
    const raw = await jget(ENDPOINTS.ultra + "?market=" + encodeURIComponent(market));
    // ì¼ë¶€ ì›Œì»¤ê°€ {data:{...}}ë¡œ ì¤„ ìˆ˜ë„ ìˆì–´ í’€ì–´ì£¼ê¸°
    const js = raw?.data || raw;
    renderUltraFromAPI(js);
  }catch(e){
    console.warn("ULTRA ì—°ë™ ì‹¤íŒ¨, ì•ˆì „ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´:", e?.message||e);
    fallbackUltra(market);
  }
}
</script>
<script>
/* ì‚¬í† ì‹œ í•«í”½ìŠ¤ v1 â€” API ë² ì´ìŠ¤ + ë°°ì—´ ê°€ë“œ + ì—ëŸ¬ ì•ˆì „í™” */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";

/* ì•ˆì „ íŒŒì„œ: API ì‘ë‹µì´ ë°°ì—´/ê°ì²´ ì–´ë–¤ í˜•íƒœì—¬ë„ í”„ë¡ íŠ¸ê°€ ì ˆëŒ€ ì•ˆí„°ì§€ë„ë¡ */
function toArray(x) {
  if (Array.isArray(x)) return x;
  if (x && Array.isArray(x.items)) return x.items;
  return [];
}

/* ì—…ë¹„íŠ¸ ë§ˆì¼“ ë¶ˆëŸ¬ì˜¤ê¸° (ê²€ìƒ‰ìš©) */
async function loadMarkets() {
  try {
    const r = await fetch(`${API_BASE}/upbit/markets`, { cache: "no-store" });
    const js = await r.json();
    const list = toArray(js);
    // TODO: ê¸°ì¡´ ê²€ìƒ‰ ë Œë” í•¨ìˆ˜ë¡œ ì—°ê²° (ì•„ë˜ ì˜ˆì‹œëŠ” ì´ë²¤íŠ¸ ë°œìƒìš© í›…)
    window.__UPBIT_MARKETS__ = list;
    document.dispatchEvent(new CustomEvent("markets:loaded", { detail: list }));
  } catch (e) {
    console.error("loadMarkets error", e);
    window.__UPBIT_MARKETS__ = [];
  }
}

/* SPARK TOP10 ë¡œë“œ (ì—†ìœ¼ë©´ ë¹ˆë°°ì—´) */
async function loadSpark() {
  try {
    const r = await fetch(`${API_BASE}/spark/top10`, { cache: "no-store" });
    const js = await r.json();
    const list = toArray(js);
    document.dispatchEvent(new CustomEvent("spark:loaded", { detail: list }));
  } catch (e) {
    console.error("loadSpark error", e);
    document.dispatchEvent(new CustomEvent("spark:loaded", { detail: [] }));
  }
}

/* íŠ¹ì • ì½”ì¸ ì„ íƒ ì‹œ ULTRA ì‹ í˜¸ ë¡œë“œ (ì‹œì¥ íŒŒë¼ë¯¸í„°ëŠ” KRW-XXX) */
async function loadUltra(market) {
  if (!market) return;
  try {
    const r = await fetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`, { cache: "no-store" });
    const js = await r.json();
    document.dispatchEvent(new CustomEvent("ultra:loaded", { detail: js }));
  } catch (e) {
    console.error("loadUltra error", e);
    document.dispatchEvent(new CustomEvent("ultra:loaded", { detail: { ok:false, error:String(e) } }));
  }
}

/* í˜ì´ì§€ ì´ˆê¸° êµ¬ë™ */
(async function initSatoshiHotfix(){
  // ê¸°ì¡´ init ì „ì— ë¨¼ì € ë¶ˆëŸ¬ì„œ ë°ì´í„° ë³´ì¥
  await Promise.all([loadMarkets(), loadSpark()]);
  // ê¸°ì¡´ ì½”ë“œì—ì„œ ì„ íƒ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ, ì•„ë˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œë§Œ í•´ì£¼ë©´ ë¨:
  // loadUltra("KRW-BTC")
})();
</script>
 window.API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";
<script>
(async function () {
  // --- ì—˜ë¦¬ë¨¼íŠ¸ í›… (IDëŠ” ì‹¤ì œ í˜ì´ì§€ì— ë§ê²Œ ì¡°ì •) ---
  const $input = document.querySelector('input[type="search"], #search, [data-id="search"]') 
              || document.querySelector('input'); // ì•ˆì „í›…
  const $resultBox = document.querySelector('#search-results') 
                  || createResultBox();
  const $ultraBox  = document.querySelector('#ultra-panel') 
                  || document.querySelector('[data-ultra]') 
                  || createUltraBox();

  // ê²€ìƒ‰ê²°ê³¼ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì„œ ë¶™ì¸ë‹¤
  function createResultBox(){
    const div = document.createElement('div');
    div.id = 'search-results';
    div.style.marginTop = '8px';
    div.style.background = 'rgba(255,255,255,0.03)';
    div.style.border = '1px solid rgba(255,255,255,0.08)';
    div.style.borderRadius = '10px';
    div.style.padding = '8px';
    div.style.maxHeight = '220px';
    div.style.overflowY = 'auto';
    $input.parentNode.insertAdjacentElement('afterend', div);
    return div;
  }

  // ULTRA íŒ¨ë„ì´ ì—†ìœ¼ë©´ ê°„ë‹¨ ë°•ìŠ¤ ìƒì„± (ê¸°ì¡´ íŒ¨ë„ ìˆìœ¼ë©´ ìƒëµë¨)
  function createUltraBox(){
    const div = document.createElement('div');
    div.id = 'ultra-panel';
    div.style.marginTop = '16px';
    div.style.padding = '12px';
    div.style.borderRadius = '12px';
    div.style.background = 'rgba(255,255,255,0.03)';
    div.style.border = '1px solid rgba(255,255,255,0.08)';
    $resultBox.insertAdjacentElement('afterend', div);
    div.innerHTML = `<b>ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</b><div style="opacity:.7">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜Â·ìµì ˆÂ·ì†ì ˆ(ìŠ¤ì¼ˆë ˆí†¤)ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
    return div;
  }

  // --- ë§ˆì¼“ ë¡œë”© (5ë¶„ ìºì‹œ) ---
  let markets = [];
  async function loadMarkets() {
    try {
      const r = await fetch(API_BASE + "/api/upbit/markets");
      const j = await r.json();
      if (j.ok) markets = j.items || [];
    } catch(e) { console.warn("markets load fail", e); }
  }
  await loadMarkets();

  // --- ê²€ìƒ‰ & ë Œë” (ìµœëŒ€ 5ê°œ) ---
  let last = "";
  $input && $input.addEventListener('input', () => {
    const q = ($input.value || "").trim();
    if (q === last) return;
    last = q;
    renderResults(q);
  });

  function renderResults(q){
    $resultBox.innerHTML = "";
    if (!q) return;
    const q2 = q.toLowerCase();
    const hits = markets.filter(m =>
      (m.korean_name && m.korean_name.includes(q)) ||
      (m.market && m.market.toLowerCase().includes(q2)) ||
      (m.english_name && m.english_name.toLowerCase().includes(q2))
    ).slice(0, 5); // ìµœëŒ€ 5ê°œ

    if (!hits.length){
      $resultBox.innerHTML = `<div style="opacity:.6">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
      return;
    }

    for (const m of hits){
      const btn = document.createElement('button');
      btn.textContent = `${m.korean_name} (${m.market})`;
      btn.style.display = 'block';
      btn.style.width = '100%';
      btn.style.textAlign = 'left';
      btn.style.margin = '6px 0';
      btn.style.padding = '10px 12px';
      btn.style.borderRadius = '10px';
      btn.style.border = '1px solid rgba(255,255,255,0.1)';
      btn.style.background = 'rgba(255,255,255,0.02)';
      btn.onmouseenter = () => btn.style.background = 'rgba(255,255,255,0.06)';
      btn.onmouseleave = () => btn.style.background = 'rgba(255,255,255,0.02)';
      btn.onclick = () => selectMarket(m.market, m.korean_name);
      $resultBox.appendChild(btn);
    }
  }

  // --- ì„ íƒ ì‹œ ULTRA ì‹œê·¸ë„ í˜¸ì¶œ & í‘œì‹œ ---
  async function selectMarket(market, kor){
    try{
      // ULTRA API
      const r = await fetch(API_BASE + "/api/ultra/signal?market=" + encodeURIComponent(market));
      const j = await r.json();
      if (!j.ok && !j.market) throw new Error(j.error || "signal fail");
      renderUltra(j, kor);
      // ìŠ¤í¬ë¡¤ í¬ì»¤ìŠ¤ (ëª¨ë°”ì¼ ë°°ë ¤)
      $ultraBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }catch(e){
      renderUltra({ ok:false, market, comment: "ì‹ í˜¸ í˜¸ì¶œ ì‹¤íŒ¨: " + e.message }, kor);
    }
  }

  function renderUltra(sig, korName){
    const m = sig.market || "";
    const title = korName ? `${korName} (${m})` : m;
    $ultraBox.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <b>ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</b>
        <span style="opacity:.7">${title}</span>
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
        <div>í˜„ì¬ê°€: <b>${fmt(sig.price)}</b></div>
        <div>ìœ„í—˜ë„: <b>${fmt(sig.risk)}</b></div>
        <div>ë§¤ìˆ˜(BUY1): <b>${fmt(sig.buy1)}</b></div>
        <div>ë§¤ìˆ˜(BUY2): <b>${fmt(sig.buy2)}</b></div>
        <div>ìµì ˆ(TP1/TP2): <b>${fmt(sig.tp1)} / ${fmt(sig.tp2)}</b></div>
        <div>ì†ì ˆ(SL): <b style="color:#ff6a6a">${fmt(sig.sl)}</b></div>
      </div>
      <div style="margin-top:10px;opacity:.9">ì©”ì–´í•œë§ˆë””: ${sig.comment || '-'}</div>
    `;
  }

  function fmt(v){ return (v===undefined || v===null) ? '-' : v; }

  // ì´ˆê¸° ìƒíƒœ ë©”ì‹œì§€
  if ($input && $input.value) renderResults($input.value);
})();
</script>

</body>
</html>
