<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>zzeol wallet — 매수/매도 타점</title>
  <style>
    :root{
      --bg:#0f131a;--card:#151a23;--muted:#8a94a7;--fg:#e9edf5;--accent:#86b9ff;
      --up:#18d07a;--down:#ff6b6b;--warn:#ffb020;--line:#222a36;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 Pretendard,Apple SD Gothic Neo,system-ui,Segoe UI,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type=text]{background:#0c1117;border:1px solid var(--line);border-radius:10px;color:var(--fg);padding:10px 12px;outline:none;width:240px}
    button{background:#1b2636;border:1px solid #253146;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:#203558;border-color:#27446f;color:#bcd8ff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#1a2432;border:1px solid #273144;color:#b9c6dc;font-size:12px}
    .ok{color:var(--up)} .bad{color:var(--down)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--line)}
    th,td{padding:12px 10px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{background:#121823;color:#b8c3d6;border-bottom:1px solid var(--line);position:sticky;top:0}
    tbody tr{border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#0f1622}
    .skeleton{position:relative;overflow:hidden}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:sh 1.6s infinite}
    @keyframes sh{0%{transform:translateX(-100%)} 100%{transform:translateX(100%)}}
    .pill{padding:4px 10px;border:1px solid #2a364b;border-radius:999px;background:#131b28;color:#c5d6f2;font-weight:600}
    .up{color:var(--up)} .down{color:var(--down)}
    .foot{margin-top:6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>코인 검색 (KRW 전용) · 매수/매도 타점</h1>

    <!-- 검색 카드 -->
    <div class="card">
      <div class="row">
        <input id="inp" type="text" placeholder="예: 비트코인/BTC, 이더리움/ETH, 시바이누/SHIB…" />
        <button id="btnSearch" class="primary">검색</button>
        <button id="btnTop">상승TOP10</button>
        <button id="btnUp">급등</button>
        <button id="btnDown">급락</button>
        <button id="btnReset">초기화</button>
        <div class="grow"></div>
        <span id="sysPing" class="tag">시스템: -</span>
        <span id="reqState" class="tag">대기</span>
      </div>
      <div class="foot muted">업비트 연결·틱 규칙 반영 / 지연 응답 보호</div>
    </div>

    <!-- 요약 -->
    <div class="card" id="sumCard" style="display:none">
      <div class="row">
        <div class="pill" id="sumSymbol">-</div>
        <div class="tag">현재가 <b id="sumPrice">-</b></div>
        <div class="tag">등락 <b id="sumChange">-</b></div>
        <div class="tag">Bid <b id="sumBid">-</b></div>
        <div class="tag">Ask <b id="sumAsk">-</b></div>
        <div class="tag">매수 <b id="sumBuy">-</b></div>
        <div class="tag">매도 <b id="sumSell">-</b></div>
        <div class="tag">손절 <b id="sumStop">-</b></div>
      </div>
      <div class="foot muted">손절율: <span id="cfgStopRate">1.0%</span> · 포맷/틱 자동</div>
    </div>

    <!-- 결과 테이블 -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>코인</th>
            <th>현재가</th>
            <th>등락</th>
            <th>매수호가</th>
            <th>매도호가</th>
            <th>매수 타점</th>
            <th>매도 타점</th>
            <th>손절</th>
            <th>AI 위험도</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" class="muted" style="text-align:center;padding:28px">검색 결과 없음</td></tr>
        </tbody>
      </table>
    </div>

    <!-- BTC 온체인 (옵션, 값 들어오면 표시) -->
    <div class="card" id="onchainBox" style="display:none">
      <div class="row">
        <b>BTC 온체인 상태</b>
        <div class="tag">MVRV Z-Score: <b id="mv">-</b></div>
        <div class="tag">거래소 순유입/순유출: <b id="flow">-</b></div>
        <div class="tag">펀딩비: <b id="fund">-</b></div>
        <div class="tag">스테이블 유입: <b id="stb">-</b></div>
        <div class="tag">OI: <b id="oi">-</b></div>
      </div>
    </div>

    <div class="muted foot">© zzeol wallet</div>
  </div>

  <script>
    // ====== 설정 ======
    const NAME2SYMBOL = {
      '비트코인':'BTC','BTC':'BTC',
      '이더리움':'ETH','ETH':'ETH',
      '에이다':'ADA','ADA':'ADA',
      '리플':'XRP','XRP':'XRP',
      '솔라나':'SOL','SOL':'SOL',
      '시바이누':'SHIB','SHIB':'SHIB'
    };
    const STOP_RATE = 0.01; // 손절율 1%
    const $ = sel => document.querySelector(sel);

    // ====== 요소 ======
    const elInput = $('#inp');
    const elBtn = $('#btnSearch');
    const elReset = $('#btnReset');
    const elReq = $('#reqState');
    const elBody = $('#tbody');
    const sumCard = $('#sumCard');
    const elSymbol = $('#sumSymbol');
    const elPrice = $('#sumPrice');
    const elChg = $('#sumChange');
    const elBid = $('#sumBid');
    const elAsk = $('#sumAsk');
    const elBuy = $('#sumBuy');
    const elSell = $('#sumSell');
    const elStop = $('#sumStop');
    const elPing = $('#sysPing');

    // ====== 요청 보호 ======
    let lastReqId = 0;
    let ctrl = null;

    function setReqState(s){ elReq.textContent = s; }

    // ====== 유틸 ======
    function mapSymbol(raw){
      const t = (raw||'').trim();
      if(!t) return null;
      return NAME2SYMBOL[t.toUpperCase()] || NAME2SYMBOL[t] || t.toUpperCase();
    }

    // 업비트 KRW 틱 규칙 (단순화 + 초저가 보정: 0.1 미만은 0.0001)
    function krwTick(p){
      if(p < 0.1) return 0.0001;
      if(p < 1)   return 0.001;
      if(p < 10)  return 0.01;
      if(p < 100) return 1;
      if(p < 1000) return 5;
      if(p < 10000) return 10;
      if(p < 100000) return 50;
      if(p < 500000) return 100;
      if(p < 1000000) return 500;
      return 1000;
    }

    function roundByTick(v, tick, dir='nearest'){
      if(!isFinite(v)||!isFinite(tick)||tick<=0) return v;
      const n = Math.round( Math.log10(1/tick) );
      let q = Math.round(v/tick)*tick;
      if(dir==='down') q = Math.floor(v/tick)*tick;
      if(dir==='up') q = Math.ceil(v/tick)*tick;
      return Number(q.toFixed(Math.max(0,n)));
    }

    function fmtPrice(v){
      if(v==null||!isFinite(v)) return '-';
      if(v < 0.1) return v.toFixed(4); // shib 같은 초저가
      if(v < 1)   return v.toFixed(3);
      if(v < 10)  return v.toFixed(2);
      if(v < 100) return v.toFixed(2);
      if(v < 1000) return v.toFixed(1);
      return v.toLocaleString('ko-KR');
    }

    function fmtPct(v){
      if(v==null||!isFinite(v)) return '-';
      const s = (v>=0?'+':'') + (v*100).toFixed(2) + '%';
      return v>=0 ? `<span class="up">${s}</span>` : `<span class="down">${s}</span>`;
    }

    function rowHTML(d){
      const risk = d.risk ?? '관망';
      return `<tr>
        <td><b>${d.symbol}</b></td>
        <td>${fmtPrice(d.price)}</td>
        <td>${fmtPct(d.change)}</td>
        <td>${fmtPrice(d.bid)}</td>
        <td>${fmtPrice(d.ask)}</td>
        <td><b>${fmtPrice(d.buy)}</b></td>
        <td><b>${fmtPrice(d.sell)}</b></td>
        <td>${fmtPrice(d.stop)}</td>
        <td class="muted">${risk}</td>
      </tr>`;
    }

    function setSummary(d){
      sumCard.style.display = 'block';
      elSymbol.textContent = d.symbol;
      elPrice.textContent = fmtPrice(d.price);
      elChg.innerHTML = fmtPct(d.change);
      elBid.textContent = fmtPrice(d.bid);
      elAsk.textContent = fmtPrice(d.ask);
      elBuy.textContent = fmtPrice(d.buy);
      elSell.textContent = fmtPrice(d.sell);
      elStop.textContent = fmtPrice(d.stop);
      $('#cfgStopRate').textContent = (STOP_RATE*100).toFixed(1)+'%';
    }

    async function ping(){
      try{
        const r = await fetch('/api/ping?t='+Date.now());
        const j = await r.json();
        elPing.textContent = '시스템: OK';
        elPing.className = 'tag ok';
      }catch(e){
        elPing.textContent = '시스템: 오류';
        elPing.className = 'tag bad';
      }
    }

    // ====== 핵심 검색 ======
    async function handleSearch(raw){
      const symbol = mapSymbol(raw);
      if(!symbol){ alert('코인명을 입력하세요 (예: 비트코인/BTC, 이더리움/ETH, 시바이누/SHIB)'); elInput.focus(); return; }

      // 이전 요청 취소
      if(ctrl) ctrl.abort();
      ctrl = new AbortController();
      const myId = ++lastReqId;

      setReqState('조회중…');

      try{
        // 업비트 데이터
        const u = await fetch(`/api/upbit?symbol=${encodeURIComponent(symbol)}`, {signal: ctrl.signal});
        if(!u.ok) throw new Error('Upbit API 오류');
        const uj = await u.json();
        if(myId !== lastReqId) return; // 늦게 온 응답 버림

        const price = Number(uj.price);         // 현재가
        const change = Number(uj.change ?? 0);  // 등락률 (소수 0.0132 = 1.32%)
        const bid = Number(uj.bestBid ?? price);
        const ask = Number(uj.bestAsk ?? price);

        // 틱 규칙 반영
        const tick = krwTick(price);
        const buy = roundByTick(bid, tick, 'down'); // 매수 타점 = 최우선 매수호가 (반올림 하향)
        const sell = roundByTick(ask, tick, 'up');  // 매도 타점 = 최우선 매도호가 (반올림 상향)
        const stop = roundByTick(buy * (1 - STOP_RATE), tick, 'down');

        const row = {
          symbol, price, change, bid, ask, buy, sell, stop, risk:'관망'
        };

        // 표/요약 반영
        elBody.innerHTML = rowHTML(row);
        setSummary(row);

        // 온체인(BTC만) 옵션
        try{
          if(symbol === 'BTC'){
            const oc = await fetch('/api/onchain?symbol=BTC', {signal:ctrl.signal});
            if(oc.ok){
              const j = await oc.json();
              $('#onchainBox').style.display = 'block';
              $('#mv').textContent = j.mvrv ?? '-';
              $('#flow').textContent = j.netflow ?? '-';
              $('#fund').textContent = j.funding ?? '-';
              $('#stb').textContent = j.stable ?? '-';
              $('#oi').textContent = j.oi ?? '-';
            }
          }
        }catch(e){ /* optional */ }

        setReqState('완료');
      }catch(e){
        if(e.name === 'AbortError') return;
        console.error(e);
        setReqState('오류');
        elBody.innerHTML = `<tr><td colspan="9" class="bad" style="text-align:center;padding:22px">오류: ${e.message||e}</td></tr>`;
      }
    }

    // ====== 이벤트 바인딩 ======
    elBtn.addEventListener('click', ()=>handleSearch(elInput.value));
    elInput.addEventListener('keydown', e=>{
      if(e.key==='Enter') handleSearch(elInput.value);
    });
    elReset.addEventListener('click', ()=>{
      elInput.value = ''; sumCard.style.display='none';
      elBody.innerHTML = `<tr><td colspan="9" class="muted" style="text-align:center;padding:28px">검색 결과 없음</td></tr>`;
      setReqState('대기');
    });

    // 더미 버튼 (원하면 로직 채우기)
    $('#btnTop').addEventListener('click', ()=>alert('상승TOP10은 추후 확장 가능합니다.'));
    $('#btnUp').addEventListener('click', ()=>alert('급등 필터는 추후 확장 가능합니다.'));
    $('#btnDown').addEventListener('click', ()=>alert('급락 필터는 추후 확장 가능합니다.'));

    // 부팅시 핑 체크
    ping();

    // 데모: 처음 로딩 시 SHIB 한 번 조회(원치 않으면 주석)
    // handleSearch('시바이누');
  </script>
</body>
</html>
