<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</title>
<style>
  :root{
    --bg:#0f1218; --panel:#161a23; --text:#e8eefc; --sub:#8ea3c0;
    --green:#2ecc71; --red:#ff5c5c; --amber:#ffb020; --blue:#4db2ff;
  }
  body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Apple Color Emoji,Segoe UI Emoji;background:var(--bg);color:var(--text)}
  .wrap{max-width:1120px;margin:20px auto;padding:0 16px}
  h1{font-size:20px;margin:8px 0 14px;display:flex;align-items:center;gap:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--panel);border-radius:12px;padding:16px;border:1px solid #1e2431}
  .muted{color:var(--sub);font-size:12px}
  .pill{font-size:11px;border:1px solid #283042;background:#141925;border-radius:999px;padding:2px 8px;color:#9cb5d1}
  .title{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .kpi div{background:#0f1420;border:1px solid #1e2431;border-radius:8px;padding:12px}
  .val{font-weight:700;font-size:18px}
  .ok{color:var(--green)} .bad{color:var(--red)} .warn{color:var(--amber)} .info{color:var(--blue)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .rowline{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #243047;padding:6px 0}
  .foot{margin-top:8px;font-size:12px;color:#97aac7}
  .bar{display:flex;gap:8px;align-items:center}
  select,button{background:#121827;border:1px solid #2b3243;border-radius:10px;color:#cfe0ff;padding:8px 10px}
  button{cursor:pointer}
  .sparklist{display:flex;flex-wrap:wrap;gap:10px}
  .sparkchip{background:#121827;border:1px solid #283042;border-radius:12px;padding:10px 12px;min-width:220px}
  .slab{font-size:12px;color:#9eb3d3}
  .slv{font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸª™ ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™ <span class="pill">ì „ì„¤íŒ 95%</span></h1>

  <!-- ìƒë‹¨ ê²€ìƒ‰/ì ìš© -->
  <div class="bar" style="margin:8px 0 14px">
    <select id="sym">
      <option>BTC</option>
      <option>ETH</option>
      <option>BCH</option>
      <option>SHIB</option>
      <option>XRP</option>
      <option>ADA</option>
      <option>SOL</option>
      <option>DOGE</option>
    </select>
    <button id="apply">ì ìš©</button>
    <span class="muted">í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: <b id="state">ì •ìƒ</b></span>
  </div>

  <!-- 1ì—´ -->
  <div class="row">
    <!-- ê¹€í”„ -->
    <div class="card" id="card-prem">
      <div class="title"><span>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</span><span class="pill" id="premSym">BTC</span></div>
      <div class="kpi">
        <div><div class="slab">ì—…ë¹„íŠ¸ KRW</div><div class="val" id="krw">-</div></div>
        <div><div class="slab">ê¸€ë¡œë²Œ USD</div><div class="val" id="usd">-</div></div>
        <div><div class="slab">USD/KRW</div><div class="val" id="fx">-</div></div>
        <div><div class="slab">í”„ë¦¬ë¯¸ì—„(%)</div><div class="val" id="ppm">-</div></div>
      </div>
      <div class="foot">ì†ŒìŠ¤: CoinGecko / open-er-api / Upbit</div>
    </div>

    <!-- ì˜¨ì²´ì¸ TVL -->
    <div class="card">
      <div class="title"><span>ğŸ§  ì˜¨ì²´ì¸ TVL(ETH)</span><span class="pill">ìë™ í´ë°±</span></div>
      <div class="kpi">
        <div><div class="slab">TVL</div><div class="val" id="tvl">-</div></div>
        <div><div class="slab">ì†ŒìŠ¤</div><div class="val" id="tvlSrc">-</div></div>
      </div>
      <div class="foot">DefiLlama ì¥ì•  ì‹œ /v2/chainsë¡œ ìë™ ì „í™˜</div>
    </div>
  </div>

  <!-- 2ì—´ : ì‹œê·¸ë„ / ì©”ì–´í•œë§ˆë”” -->
  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="title"><span>ğŸ“ ì‹œê·¸ë„</span><span class="pill" id="sigSym">BTC</span></div>
      <div class="grid4">
        <div><div class="slab">í˜„ì¬ê°€</div><div class="val" id="p">-</div></div>
        <div><div class="slab">ë§¤ìˆ˜</div><div class="val ok" id="b">-</div></div>
        <div><div class="slab">ë§¤ë„</div><div class="val bad" id="s">-</div></div>
        <div><div class="slab">ì†ì ˆ</div><div class="val warn" id="st">-</div></div>
      </div>
      <div class="kpi" style="margin-top:10px">
        <div><div class="slab">ìœ„í—˜ë„</div><div class="val" id="r">-</div></div>
        <div><div class="slab">ì„¸ë ¥ê°•ë„</div><div class="val" id="pow">-</div></div>
      </div>
      <div class="foot">â€» ë‹¨ìˆœ ê³„ì‚°ìš© ì°¸ê³ ì§€í‘œ(í…ŒìŠ¤íŠ¸). ì‹¤ì œ ë§¤ë§¤ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      <div class="title"><span>ğŸ’¬ ì©”ì–´ í•œë§ˆë””</span><span class="pill">ë² íƒ€</span></div>
      <div class="val" id="ment">-</div>
      <div class="foot">ì—…ë°ì´íŠ¸: <span id="up"></span></div>
    </div>
  </div>

  <!-- SPARK(ê´€ì‹¬ì½”ì¸) -->
  <div class="card" style="margin-top:14px">
    <div class="title"><span>ì˜êµ¬ ê³ ì •: âš¡ SPARK (ê´€ì‹¬ì½”ì¸ ê³ ì •í‘œì‹œ)</span></div>
    <div class="sparklist" id="spark"></div>
    <div class="foot">SPARK: ê´€ì‹¬ì½”ì¸ ê³ ì • â€“ ì‹œê·¸ë„/ì•Œë¦¼ ì—°ë™ ì˜ˆì •</div>
  </div>
</div>

<script>
const CONFIG = {
  API_BASE: 'https://satoshi-proxy.mujukno1.workers.dev', // â† í•„ìš” ì‹œ ë³¸ì¸ ì›Œì»¤ ì£¼ì†Œë¡œ ë³€ê²½
  SPARKS: JSON.parse(localStorage.getItem('SPARKS') || '["BTC","ETH","BCH","SHIB"]')
};

const $ = (id)=> document.getElementById(id);
const fmtKRW = (n)=> (n||0).toLocaleString('ko-KR',{maximumFractionDigits:6});
const setText = (id, v)=> $(id).textContent = v;

async function jget(path) {
  const r = await fetch(CONFIG.API_BASE + path, {cache:'no-store'});
  return r.json();
}

// ê¹€í”„
async function loadPremium(sym) {
  setText('premSym',sym);
  const j = await jget(`/api/premium?symbol=${sym}`);
  if (!j.ok) { setText('ppm','ì—ëŸ¬'); return; }
  setText('krw', fmtKRW(j.upbitPrice)+' KRW');
  setText('usd', (j.globalUsd||0).toLocaleString('en-US',{maximumFractionDigits:2})+' USD');
  setText('fx',  (j.usdk||0).toLocaleString('ko-KR',{maximumFractionDigits:2}));
  const pct = (j.premiumPct||0).toFixed(2);
  $('ppm').textContent = (pct>0?'+':'')+pct+' %';
  $('ppm').className = 'val '+(pct>0?'ok':(pct<0?'bad':''));
}

// ì˜¨ì²´ì¸
async function loadTVL() {
  const j = await jget('/api/onchain?symbol=ETH');
  if (!j.ok) { setText('tvl','-'); setText('tvlSrc','ì—ëŸ¬'); return; }
  setText('tvl', '$ '+(j.tvl||0).toLocaleString('en-US'));
  setText('tvlSrc', j.src||'-');
}

// ì‹œê·¸ë„
async function loadSignal(sym) {
  setText('sigSym', sym);
  const j = await jget(`/api/signal?symbol=${sym}`);
  if (!j.ok) { setText('p','-'); setText('b','-'); setText('s','-'); setText('st','-'); return; }
  setText('p',  fmtKRW(j.price));
  setText('b',  fmtKRW(j.buy));
  setText('s',  fmtKRW(j.sell));
  setText('st', fmtKRW(j.stop));
  setText('r',  (j.riskPct||0)+' %');
  setText('pow', (j.power||0)+' %');
  setText('ment', j.ment||'-');
  setText('up', j.updatedAt?.replace('T',' ').replace('Z','') || '-');
}

// SPARK ì¹© ë Œë”
async function renderSpark() {
  const box = $('spark'); box.innerHTML='';
  for (const sym of CONFIG.SPARKS) {
    const j = await jget(`/api/signal?symbol=${sym}`);
    const prem = await jget(`/api/premium?symbol=${sym}`);
    const el = document.createElement('div');
    el.className='sparkchip';
    const r = j.ok? (j.riskPct||0) : '-';
    const ment = j.ok? j.ment : 'ì—ëŸ¬';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="slv">${sym}</div>
        <button onclick="delSpark('${sym}')" style="font-size:11px;padding:4px 8px">ì œê±°</button>
      </div>
      <div class="slab">í˜„ì¬ê°€</div><div class="slv">${j.ok? fmtKRW(j.price):'-'}</div>
      <div class="slab">ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ</div>
      <div>${j.ok? `${fmtKRW(j.buy)} / ${fmtKRW(j.sell)} / ${fmtKRW(j.stop)}`:'-'}</div>
      <div class="slab">ìœ„í—˜ë„</div><div>${r}%</div>
      <div class="slab">í”„ë¦¬ë¯¸ì—„</div><div>${prem.ok? ((prem.premiumPct||0).toFixed(2)+' %'):'-'}</div>
      <div class="slab">ì©”ì–´ í•œë§ˆë””</div><div>${ment}</div>
    `;
    box.appendChild(el);
  }
}
function delSpark(sym){
  CONFIG.SPARKS = CONFIG.SPARKS.filter(s=>s!==sym);
  localStorage.setItem('SPARKS', JSON.stringify(CONFIG.SPARKS));
  renderSpark();
}

// ì´ˆê¸°í™” & ì´ë²¤íŠ¸
$('apply').onclick = async ()=>{
  const sym = $('sym').value;
  await Promise.all([ loadPremium(sym), loadSignal(sym) ]);
};
(async function boot(){
  const sym = $('sym').value;
  await Promise.all([ loadPremium(sym), loadTVL(), loadSignal(sym) ]);
  renderSpark();
  // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
  setInterval(()=> { loadSignal($('sym').value); }, 30000);
})();
</script>
</body>
</html>
