<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ v10.0 â€” ë‹¨ì¼íŒŒì¼</title>
  <style>
    /* =============================
       ì‚¬í† ì‹œì˜ì§€ê°‘ v10.0 â€” ê¸°ë³¸ ìŠ¤íƒ€ì¼
       - KRW ê¸°ì¤€, ì—…ë¹„íŠ¸ í˜¸ê°€í‹±, í•œê¸€ ì½”ì¸ëª…, Noâ€‘Motion(í™”ë©´ ê¹œë¹¡ì„ ì—†ìŒ)
       - ìƒë‹¨ ê³ ì • ê²€ìƒ‰ì°½ + SPARK TOP10 ê³ ì • ë…¸ì¶œ
       - ì¹´ë“œí˜• íŒ¨ë„(í˜„ì¬ê°€/ë§¤ìˆ˜/ìµì ˆ/ì†ì ˆ/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””)
       ============================= */
    :root {
      --bg: #0b0f14;
      --panel: #101722;
      --panel-2: #0f141c;
      --text: #e9eef7;
      --muted: #98a2b3;
      --up: #19c37d;
      --down: #ef4444;
      --accent: #60a5fa;
      --chip: #1b2432;
      --chip-border: #223049;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ok: #22c55e;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
    }
    header {
      position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(11,15,20,0.95), rgba(11,15,20,0.8));
      backdrop-filter:saturate(120%) blur(8px);
      border-bottom:1px solid #162131;
    }
    .wrap { max-width:1200px; margin:0 auto; padding:10px 16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .search {
      flex:1; display:flex; align-items:center; gap:10px; background:var(--panel);
      border:1px solid #1c2a41; padding:10px 12px; border-radius:12px;
    }
    .search input { flex:1; background:transparent; border:0; outline:none; color:var(--text); font-size:16px; }
    .api-badge { font-size:12px; color:var(--muted); }
    .hint { font-size:12px; color:var(--muted); }

    .grid { display:grid; grid-template-columns: 1.35fr 1fr; gap:16px; padding:16px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }

    .card {
      background:var(--panel); border:1px solid #1c2a41; border-radius:16px; padding:14px; 
      box-shadow: 0 0 0 1px rgba(20,34,56,0.2) inset;
    }
    .card h3 { margin:0 0 8px; font-size:16px; color:#c6d4ea; font-weight:600; }

    /* SPARK TOP10 (Noâ€‘Motion: ë†’ì´ ê³ ì • + diff íŒ¨ì¹˜) */
    #spark-list { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    @media (max-width: 700px){ #spark-list { grid-template-columns: 1fr; } }
    .spark-item { display:flex; align-items:center; gap:10px; background:var(--panel-2); border:1px solid #1c2a41; padding:10px; border-radius:12px; cursor:pointer; }
    .spark-item:hover { border-color:#2a3a56; }
    .spark-name { font-weight:700; }
    .spark-gauge { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .spark-bar { width:120px; height:8px; background:#111827; border-radius:999px; overflow:hidden; border:1px solid #1c2a41; }
    .spark-bar > span { display:block; height:100%; width:0%; background:linear-gradient(90deg, #f97316, #ef4444); }
    .spark-score { font-size:12px; color:#cbd5e1; }

    /* ì‹œê·¸ë„ íŒ¨ë„ */
    .signal { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 700px){ .signal { grid-template-columns: 1fr; } }
    .metric { background:var(--panel-2); border:1px solid #1c2a41; border-radius:12px; padding:10px; }
    .metric .label { color:var(--muted); font-size:12px; margin-bottom:6px; }
    .metric .value { font-size:18px; font-weight:800; }
    .value.up { color:var(--up); } .value.down { color:var(--down); }

    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { background:var(--chip); border:1px solid var(--chip-border); padding:6px 10px; border-radius:999px; font-size:12px; color:#cbd5e1; }

    .ment { margin-top:10px; background:#0e1420; border:1px dashed #25344f; padding:12px; border-radius:12px; color:#cfe5ff; line-height:1.35; }

    .muted { color:var(--muted); font-size:12px; }
    .hr { height:1px; background:#162131; margin:12px 0; }

    .footer { padding:14px 16px; color:#7c8aa5; font-size:12px; border-top:1px solid #162131; }
  </style>
</head>
<body>
  <!-- =============================
       ë©”ëª¨ë¦¬(ì‚¬í† ì‹œ v10.0) í•µì‹¬: KRW/ì—…ë¹„íŠ¸í˜¸ê°€í‹±/í•œê¸€/Noâ€‘Motion/ê²€ìƒ‰ê³ ì •/SPARKê³ ì •
       Precision Boost, SPARK, ForceIndex_AI, Bull/Bear Mode, Free Alpha Pack, AI Ment, ì •í™•ë„ ë³´ì • Â±0.3%
       ============================= -->
  <header>
    <div class="wrap">
      <div class="row">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="search-input" placeholder="ì½”ì¸ ê²€ìƒ‰ (í•œê¸€ëª…) â€” ì˜ˆ: ì‹œë°”ì´ëˆ„, ì¹ ë¦¬ì¦ˆ, ì˜¨ë„, ë„¤ì˜¤â€¦" />
          <span class="api-badge" id="api-badge">API: <span id="api-url"></span></span>
        </div>
        <div class="hint">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ ì½”ì¸ëª… Â· Noâ€‘Motion</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- ì¢Œì¸¡: SPARK TOP10 -->
      <section class="card" aria-label="SPARK TOP10">
        <h3>SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸ ğŸ”¥ (ê³ ì •)</h3>
        <div id="spark-list" aria-live="polite"></div>
        <div class="hr"></div>
        <div class="muted">ì˜ˆì—´ ì¡°ê±´: RVOLâ‰¥1.8 Â· TBRâ‰¥0.60 Â· OBIâ‰¥+0.15 Â· ìµœê·¼5ë¶„ ë³€ë™ë¥ â‰¥+1.5% (4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ ë“±ë¡)</div>
      </section>

      <!-- ìš°ì¸¡: ì„ íƒ ì½”ì¸ ì‹œê·¸ë„ -->
      <section class="card" aria-label="ULTRA ì‹œê·¸ë„">
        <h3 id="signal-title">ULTRA ì‹œê·¸ë„ â€” ì½”ì¸ ì„ íƒ ëŒ€ê¸°ì¤‘</h3>
        <div class="signal" id="signal-metrics">
          <div class="metric"><div class="label">í˜„ì¬ê°€</div><div class="value" id="v-price">â€”</div></div>
          <div class="metric"><div class="label">ë§¤ìˆ˜(BUY1)</div><div class="value" id="v-buy1">â€”</div></div>
          <div class="metric"><div class="label">ì¶”ê°€ë§¤ìˆ˜(BUY2)</div><div class="value" id="v-buy2">â€”</div></div>
          <div class="metric"><div class="label">ìµì ˆ 1 (TP1)</div><div class="value" id="v-tp1">â€”</div></div>
          <div class="metric"><div class="label">ìµì ˆ 2 (TP2)</div><div class="value" id="v-tp2">â€”</div></div>
          <div class="metric"><div class="label">ì†ì ˆ (SL)</div><div class="value" id="v-sl">â€”</div></div>
        </div>
        <div class="chips" id="chips"></div>
        <div class="ment" id="ment">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ì™€ ìœ„í—˜ë„Â·ì˜ˆì—´Â·ì„¸ë ¥ì§€ìˆ˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </section>
    </div>
  </main>

  <div class="footer wrap">
    ì‚¬í† ì‹œì˜ì§€ê°‘ v10.0 â€¢ Precision Boost â€¢ ForceIndex_AI â€¢ Bull/Bear Mode â€¢ Free Alpha Pack â€¢ Noâ€‘Motion DOM Patch
  </div>

  <script>
  /* ==========================================================
     ì‚¬í† ì‹œì˜ì§€ê°‘ v10.0 â€” ë‹¨ì¼ íŒŒì¼ ìŠ¤í¬ë¦½íŠ¸
     - API_BASE: satoshi-proxy (ë¬´ë£Œ ì—°ë™ ê¸°ë³¸)
     - KRW ê¸°ì¤€ Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼ Â· í•œê¸€ ì½”ì¸ëª… Â· Noâ€‘Motion
     - SPARK ì˜ˆì—´ ìŠ¤ì½”ì–´ Â· ForceIndex_AI Â· Precision Boost Â· Bull/Bear
     - íŒŒì´í”„ë¼ì¸: applySignalBoost â†’ Bull/Bear â†’ FreeAlpha â†’ adjustTP_SL â†’ roundToUpbitTick
     ========================================================== */

  // ====== 0) ì „ì—­ ì„¤ì • (ë©”ëª¨ë¦¬ ìµœì‹ íŒ) ======
  const CONFIG = {
    API_BASE: 'https://satoshi-proxy.mujukno1.workers.dev/api',
    NO_MOTION: true,
    LOOP_MS: 5000,          // 5ì´ˆ ê°±ì‹  ë£¨í”„ (Noâ€‘Motion: diff patch)
    SPARK_TOP_N: 10,        // SPARK TOP10 ê³ ì •
    PRECISION_EPS: 0.003,   // Â±0.3% ìë™ ë³´ì •(Precision Boost)
  };
  document.getElementById('api-url').textContent = CONFIG.API_BASE;

  // ====== 1) ìœ í‹¸ â€” ì—…ë¹„íŠ¸ í˜¸ê°€í‹±(í‹±) ê·œì¹™ & ë°˜ì˜¬ë¦¼ ======
  function getUpbitTick(price){
    if (price < 0.1) return 0.001;
    if (price < 1) return 0.01;
    if (price < 10) return 0.1;
    if (price < 100) return 1;
    if (price < 1000) return 5;
    if (price < 10000) return 10;
    if (price < 100000) return 50;
    if (price < 500000) return 100;
    return 500;
  }
  function roundToUpbitTick(price){
    const t = getUpbitTick(price);
    return Math.round(price / t) * t;
  }
  function fmtKRW(n){
    if (n == null || isNaN(n)) return 'â€”';
    const tick = getUpbitTick(Math.abs(n));
    const decimals = (tick < 1) ? (tick === 0.001 ? 3 : tick === 0.01 ? 2 : 1) : 0;
    return new Intl.NumberFormat('ko-KR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(n) + 'ì›';
  }

  // ====== 2) ì½”ì¸ í•œê¸€ëª… ë§¤í•‘ (ì˜ˆ: APIê°€ KRW-ETH â†’ ì´ë”ë¦¬ì›€ ìœ¼ë¡œ ì œê³µ or ë¡œì»¬ ë³´ì •) ======
  // í•„ìš” ì‹œ í™•ì¥: ì‹¤ì œ APIê°€ í•œê¸€ëª… ì œê³µí•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©. ì—†ìœ¼ë©´ ì•„ë˜ ë§µìœ¼ë¡œ ë³´ê°•.
  const KOREAN_NAME = {
    'KRW-SHIB': 'ì‹œë°”ì´ëˆ„', 'KRW-CHZ': 'ì¹ ë¦¬ì¦ˆ', 'KRW-DOGE': 'ë„ì§€ì½”ì¸', 'KRW-NEO': 'ë„¤ì˜¤', 'KRW-ONG': 'ì˜¨í†¨ë¡œì§€ê°€ìŠ¤',
    'KRW-ARB': 'ì•„ë¹„íŠ¸ëŸ¼', 'KRW-ENA': 'ì—í…Œë‚˜', 'KRW-ONDO':'ì˜¨ë„', 'KRW-ETH': 'ì´ë”ë¦¬ì›€', 'KRW-BTC': 'ë¹„íŠ¸ì½”ì¸'
  };
  function toKo(market){ return KOREAN_NAME[market] || market; }

  // ====== 3) ë°ì´í„° ì†ŒìŠ¤(Fetch) â€” ë¬´ë£Œ ì—°ë™ ì„¸íŠ¸(ì—…ë¹„íŠ¸/ê¹€í”„/í€ë”©/ì˜¨ì²´ì¸ ë“±) ë¼ìš°íŒ… ======
  async function fetchJSON(url){
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  // ì˜ˆì‹œ ì—”ë“œí¬ì¸íŠ¸(ì›Œì»¤ì—ì„œ ê°€ê³µë˜ì–´ ë‚˜ì˜¨ë‹¤ê³  ê°€ì •). ì‹¤ì œ ì›Œì»¤ ìŠ¤í™ì— ë§ì¶° ê²½ë¡œ ì¡°ì •í•´ë„ OK.
  const API = {
    tickers: () => fetchJSON(`${CONFIG.API_BASE}/upbit/tickers`), // [{market:"KRW-SHIB", tradePrice: 0.0375, changeRate: 0.012, ...}]
    orderStats: (market) => fetchJSON(`${CONFIG.API_BASE}/order/stats?market=${encodeURIComponent(market)}`), // {tbr:0.63, obi:0.18, microprice: ...}
    rvol: (market) => fetchJSON(`${CONFIG.API_BASE}/rvol?market=${encodeURIComponent(market)}&window=5m`), // {rvol:1.92}
    atr: (market) => fetchJSON(`${CONFIG.API_BASE}/atr?market=${encodeURIComponent(market)}&tf=1h`), // {atr:0.0012}
    spark5m: () => fetchJSON(`${CONFIG.API_BASE}/spark/top?window=5m&limit=${CONFIG.SPARK_TOP_N}`), // ìŠ¤íŒŒí¬ ì ìˆ˜ ê³„ì‚°ì„ ì›Œì»¤ê°€ ëŒ€ì‹  í•´ì¤„ ìˆ˜ë„ ìˆìŒ
    kimchi: () => fetchJSON(`${CONFIG.API_BASE}/kimchi`), // {premium:3.1}
    funding: (symbol) => fetchJSON(`${CONFIG.API_BASE}/deriv/funding?symbol=${encodeURIComponent(symbol)}`),
    stableflow: () => fetchJSON(`${CONFIG.API_BASE}/defillama/stableflow`),
    mempool: () => fetchJSON(`${CONFIG.API_BASE}/mempool`),
    fgi: () => fetchJSON(`${CONFIG.API_BASE}/feargreed`)
  };

  // ====== 4) ì½”ì–´: SPARK ìŠ¤ì½”ì–´ & ForceIndex_AI & ëª¨ë“œ íŒì • ======
  function computeSparkScore(v){
    // v = { rvol, tbr, obi, atrRank, force }
    const score = (v.rvol*0.30) + (v.tbr*0.25) + (v.obi*0.15) + (v.atrRank*0.15) + (v.force*0.15);
    return Math.max(0, Math.min(100, Math.round(score)));
  }
  function expectedRisePctBySpark(score){
    if (score >= 90) return [0.15, 0.25];
    if (score >= 80) return [0.08, 0.12];
    if (score >= 70) return [0.04, 0.06];
    return [0.0, 0.0];
  }
  function computeForceIndexAI(inp){
    // inp = { rvol, tbr, obi, micro, whale, stable, liqmap }
    // ê°„ë‹¨ ìŠ¤ì½”ì–´ëŸ¬ (0~100): ì…ë ¥ ì‹ í˜¸ë¥¼ 0~1 ì •ê·œí™” ê°€ì •
    const w = { rvol:0.25, tbr:0.20, obi:0.15, micro:0.15, whale:0.10, stable:0.10, liqmap:0.05 };
    let s = 0;
    for (const k in w){ s += (inp[k] ?? 0) * w[k]; }
    return Math.max(0, Math.min(100, Math.round(s*100)));
  }
  function detectMode({ rvol, tbr, obi, force, vwapDiffATR, kimchi, basis, fundingNeg, whaleIn, closeBelowVWAP }){
    // ë¶ˆì¥ ëª¨ë“œ ì¡°ê±´ (3ê°œ ì´ìƒ)
    const bullHits = [ rvol>=2.0, tbr>=0.65, kimchi>=3.0, force>=80, vwapDiffATR>=1.5 ].filter(Boolean).length;
    if (bullHits >= 3) return 'BULL';
    // í•˜ë½ì¥ ë¹ ë¥¸ë§¤ë„ ì¡°ê±´
    const bearHits = [ rvol>=1.4 && closeBelowVWAP, tbr<=0.45, obi<=-0.2, force<=35, (basis<0||fundingNeg), whaleIn ].filter(Boolean).length;
    if (bearHits >= 3) return 'BEAR';
    return 'NEUTRAL';
  }

  // ====== 5) Precision Boost (Â±0.3% ìë™ ë³´ì •, 3íšŒ ë£¨í”„) ======
  function precisionBoost(priceObj){
    // priceObj = { buy1, buy2, tp1, tp2, sl, current }
    const keys = ['buy1','buy2','tp1','tp2','sl'];
    for (let i=0;i<3;i++){
      for (const k of keys){
        const p = priceObj[k];
        const err = (p - roundToUpbitTick(p)) / (priceObj.current||1);
        if (Math.abs(err) > CONFIG.PRECISION_EPS){
          priceObj[k] = roundToUpbitTick(p);
        }
      }
    }
    return priceObj;
  }

  // ====== 6) íƒ€ì  ê³„ì‚° (ì—”ì§„ íŒŒì´í”„ë¼ì¸) ======
  function computeSignals({ C, VWAP, ATR, sparkScore, mode }){
    // BUY1/2 (ì„¸ë ¥ ë§¤ì§‘ êµ¬ê°„ ì¤‘ì‹¬)
    let BUY1 = VWAP - 0.8*ATR;
    let BUY2 = VWAP - 1.2*ATR;

    // SPARK ê¸°ë°˜ ê¸°ëŒ€ ìƒìŠ¹ë¥  â†’ TP í­ ì„¤ì • íŒíŠ¸
    const [rMin, rMax] = expectedRisePctBySpark(sparkScore);
    const midRise = (rMin + rMax)/2;
    // ê¸°ë³¸ TP/SL (ì¤‘ë¦½)
    let TP1 = C + 1.2*ATR;
    let TP2 = C + 2.2*ATR;
    let SL  = C - 1.0*ATR;

    // ëª¨ë“œ ë³´ì •
    if (mode === 'BULL'){
      TP1 = C + 1.6*ATR; TP2 = C + 2.8*ATR; SL = C - 0.8*ATR;
    } else if (mode === 'BEAR'){
      TP1 = C + 0.6*ATR; TP2 = C + 1.0*ATR; SL = C - 1.3*ATR; BUY2 = null; // ë¹ ë¥¸ë§¤ë„: ì¶”ê°€ë§¤ìˆ˜ ë¹„í™œì„±
    } else {
      // ì¤‘ë¦½: SPARK ê°•ë„ì— ë”°ë¼ ì™„ë§Œ ì¡°ì •
      TP1 = C + (1.0 + midRise*2.0)*ATR; // ì˜ˆ: 0.10 â†’ +1.2Ã—ATR
      TP2 = C + (1.8 + midRise*2.5)*ATR;
    }

    // Precision Boost â†’ ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼
    const out = precisionBoost({ current:C, buy1:BUY1, buy2:BUY2??undefined, tp1:TP1, tp2:TP2, sl:SL });
    out.buy1 = roundToUpbitTick(out.buy1);
    if (out.buy2!=null) out.buy2 = roundToUpbitTick(out.buy2);
    out.tp1  = roundToUpbitTick(out.tp1);
    out.tp2  = roundToUpbitTick(out.tp2);
    out.sl   = roundToUpbitTick(out.sl);

    return out;
  }

  // ====== 7) SPARK ë¦¬ìŠ¤íŠ¸ ë Œë” (Noâ€‘Motion diff patch) ======
  const sparkEl = document.getElementById('spark-list');
  function renderSparkList(items){
    // items: [{market, koName, price, rvol, tbr, obi, atrRank, force, score, expectedRisePct, risingProb}]
    // Noâ€‘Motion: key=market ê³ ì •, DOM êµì²´ ëŒ€ì‹  ë‚´ìš©ë§Œ íŒ¨ì¹˜
    const byKey = new Map();
    for (const child of sparkEl.children){ byKey.set(child.dataset.key, child); }

    const nextKeys = new Set(items.map(it => it.market));

    // ì‚­ì œ ëŒ€ìƒ ì œê±° (ìµœì†Œ DOM ë³€ê²½)
    for (const [key, node] of byKey.entries()){
      if (!nextKeys.has(key)) sparkEl.removeChild(node);
    }

    // ê°±ì‹ /ì‚½ì…
    for (const it of items){
      let node = byKey.get(it.market);
      const scoreColor = it.score>=90 ? '#ef4444' : it.score>=80 ? '#f97316' : '#9ca3af';
      const gauge = Math.max(0, Math.min(100, it.score));
      if (!node){
        node = document.createElement('div');
        node.className = 'spark-item';
        node.dataset.key = it.market;
        node.innerHTML = `
          <div class="spark-name"></div>
          <div class="spark-price muted"></div>
          <div class="spark-gauge">
            <div class="spark-bar"><span></span></div>
            <div class="spark-score"></div>
          </div>`;
        node.addEventListener('click', () => selectMarket(it.market));
        sparkEl.appendChild(node);
      }
      node.querySelector('.spark-name').textContent = `${toKo(it.market)} (${it.market.replace('KRW-','')})`;
      node.querySelector('.spark-price').textContent = fmtKRW(it.price);
      node.querySelector('.spark-bar > span').style.width = gauge + '%';
      node.querySelector('.spark-bar > span').style.background = gauge>=90? 'linear-gradient(90deg,#ef4444,#dc2626)': gauge>=80? 'linear-gradient(90deg,#f59e0b,#ef4444)' : 'linear-gradient(90deg,#6b7280,#9ca3af)';
      node.querySelector('.spark-score').textContent = `SPARK ${it.score}`;
      node.querySelector('.spark-score').style.color = scoreColor;
    }
  }

  // ====== 8) ì„ íƒ ì½”ì¸ ì‹œê·¸ë„ í‘œì‹œ ======
  async function selectMarket(market){
    try{
      currentMarket = market;
      document.getElementById('signal-title').textContent = `ULTRA ì‹œê·¸ë„ â€” ${toKo(market)} (${market.replace('KRW-','')})`;

      // ë³‘ë ¬ ì¡°íšŒ
      const [stats, rv, atr] = await Promise.all([
        API.orderStats(market).catch(()=>({ tbr:0.5, obi:0, micro:0.5 })),
        API.rvol(market).catch(()=>({ rvol:1 })),
        API.atr(market).catch(()=>({ atr: 0.01 }))
      ]);

      // í˜„ì¬ê°€ëŠ” ì „ì²´ í‹±ì»¤ì—ì„œ ì‚¬ìš© (ìºì‹œ)
      const C = (lastTickers.find(t => t.market===market)?.tradePrice) ?? null;
      const VWAP = (lastTickers.find(t => t.market===market)?.vwap) ?? C;
      const ATR = atr.atr || 0.01;

      // ForceIndex_AI ì¶”ì •ê°’ ê³„ì‚°
      const force = computeForceIndexAI({
        rvol: normalize(rv.rvol, 0, 3.0),
        tbr:  normalize(stats.tbr, 0, 1),
        obi:  normalize(stats.obi, -0.5, 0.5),
        micro:normalize(stats.micro, 0, 1),
        whale: 0.5, stable: 0.5, liqmap: 0.5 // ì™¸ë¶€ ì—°ë™ê°’ì€ ì›Œì»¤ì—ì„œ ë³´ê°•
      });

      const atrRank = 0.75; // ì˜ˆì‹œ: ìƒìœ„ 25%
      const sparkScore = computeSparkScore({ rvol:rv.rvol||1, tbr:stats.tbr||0.5, obi:stats.obi||0, atrRank, force:force/100 });
      // ëª¨ë“œ íŒì • (ê¹€í”„/í€ë”© ë“±ì€ ì›Œì»¤ì—ì„œ ì œê³µ ê°€ëŠ¥)
      const mode = detectMode({ rvol:rv.rvol||1, tbr:stats.tbr||0.5, obi:stats.obi||0, force:force, vwapDiffATR: (C&&VWAP&&ATR)? ((C - VWAP)/ATR) : 0, kimchi: 3.0, basis: 0, fundingNeg: false, whaleIn:false, closeBelowVWAP: C<VWAP });

      const out = computeSignals({ C, VWAP, ATR, sparkScore, mode });

      // ë Œë” (Noâ€‘Motion: í…ìŠ¤íŠ¸ë§Œ ê°±ì‹ )
      patchText('v-price', fmtKRW(roundToUpbitTick(C)));
      patchText('v-buy1', out.buy1!=null? fmtKRW(out.buy1): 'â€”');
      patchText('v-buy2', out.buy2!=null? fmtKRW(out.buy2): 'â€”');
      patchText('v-tp1', fmtKRW(out.tp1));
      patchText('v-tp2', fmtKRW(out.tp2));
      patchText('v-sl',  fmtKRW(out.sl));

      // ì¹© + ì©”ì–´í•œë§ˆë””
      renderChips({ sparkScore, force, mode, rv:rv.rvol||1, tbr:stats.tbr||0.5 });
      renderMent({ sparkScore, force, mode });
    } catch(e){ console.error(e); }
  }

  function renderChips({ sparkScore, force, mode, rv, tbr }){
    const el = document.getElementById('chips');
    el.innerHTML = '';
    const mk = (t)=>{ const s=document.createElement('div'); s.className='chip'; s.textContent=t; return s; };
    el.appendChild(mk(`ì˜ˆì—´ê°•ë„ ${sparkScore}`));
    el.appendChild(mk(`ì„¸ë ¥ì§€ìˆ˜ ${force}`));
    el.appendChild(mk(`ì²´ê²°ê°•ë„ ${Math.round((tbr||0)*100)}%`));
    el.appendChild(mk(mode==='BULL'?'ë¶ˆì¥ ëª¨ë“œğŸ”¥': mode==='BEAR'?'í•˜ë½ì¥ ë¹ ë¥¸ë§¤ë„âš ':'ì¤‘ë¦½ ëª¨ë“œ'));
  }

  function renderMent({ sparkScore, force, mode }){
    const m = document.getElementById('ment');
    let text = '';
    if (mode==='BULL'){
      text = `ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ì˜ˆì—´ê°•ë„ ${sparkScore} / ì„¸ë ¥ê°•ë„ ${force}% / ë¶ˆì¥ ëª¨ë“œ: ìµì ˆ ì§€ì—°, SL ì™„í™” (TP1=C+1.6Ã—ATR, TP2=C+2.8Ã—ATR, SL=Câˆ’0.8Ã—ATR)`;
    } else if (mode==='BEAR'){
      text = `âš  ì„¸ë ¥ ì´íƒˆ ê°ì§€ â€” ì˜ˆì—´ê°•ë„ ${sparkScore} / ì„¸ë ¥ê°•ë„ ${force}% / í•˜ë½ì¥ ë¹ ë¥¸ë§¤ë„: TP ì§§ê²Œ, SL ê°•í™” (TP1=C+0.6Ã—ATR, TP2=C+1.0Ã—ATR, SL=Câˆ’1.3Ã—ATR)`;
    } else {
      const prob = sparkScore>=90? 88: sparkScore>=80? 78: sparkScore>=70? 68: 50;
      const rise = sparkScore>=90? 21.6: sparkScore>=80? 10.2: sparkScore>=70? 5.3: 0.0;
      text = `ğŸ”µ ì¡°ì •/ëŒ€ê¸° â€” ì˜ˆì—´ê°•ë„ ${sparkScore} / ìƒìŠ¹í™•ë¥  ${prob}% / ì˜ˆìƒìƒìŠ¹ë¥  +${rise}%`;
    }
    patchText('ment', text);
  }

  function patchText(id, text){
    const el = document.getElementById(id);
    if (!el) return;
    if (el.textContent !== text){ el.textContent = text; }
  }
  function normalize(v, min, max){ if (v==null) return 0; return Math.max(0, Math.min(1, (v-min)/(max-min))); }

  // ====== 9) ë°ì´í„° ë£¨í”„ (SPARK TOP10) ======
  let currentMarket = null;
  let lastTickers = [];

  async function loop(){
    try{
      // 1) í‹±ì»¤ + SPARK ì†ŒìŠ¤
      const [tickers, spark] = await Promise.all([
        API.tickers().catch(()=>[]),
        API.spark5m().catch(()=>null)
      ]);
      lastTickers = tickers || [];

      let sparkItems = [];
      if (spark && Array.isArray(spark) && spark.length){
        // ì›Œì»¤ê°€ ì´ë¯¸ ê³„ì‚°í•´ì¤€ ê²½ìš°
        sparkItems = spark.slice(0, CONFIG.SPARK_TOP_N).map(s => ({
          market: s.market,
          koName: toKo(s.market),
          price: s.price,
          rvol: s.rvol, tbr: s.tbr, obi: s.obi, atrRank: s.atrRank, force: s.force,
          score: s.score,
        }));
      } else {
        // ë¡œì»¬ ê³„ì‚° (ì˜ˆ: í‹±ì»¤ ìƒìœ„ ê±°ë˜ëŒ€ê¸ˆ ì¢…ëª© ì¤‘ ìƒ˜í”Œ)
        const sample = (tickers||[]).filter(t => (t.market||'').startsWith('KRW-')).slice(0, 20);
        sparkItems = await Promise.all(sample.map(async t => {
          const [stats, rv] = await Promise.all([
            API.orderStats(t.market).catch(()=>({ tbr:0.5, obi:0 })),
            API.rvol(t.market).catch(()=>({ rvol:1 }))
          ]);
          const atrRank = Math.random()*0.5 + 0.5; // 0.5~1.0 ê°€ì •
          const force = computeForceIndexAI({
            rvol: normalize(rv.rvol, 0, 3.0), tbr: normalize(stats.tbr,0,1), obi: normalize(stats.obi,-0.5,0.5),
            micro:0.5, whale:0.5, stable:0.5, liqmap:0.5
          })/100;
          const score = computeSparkScore({ rvol:rv.rvol||1, tbr:stats.tbr||0.5, obi:stats.obi||0, atrRank, force });
          return { market:t.market, koName:toKo(t.market), price:t.tradePrice, rvol:rv.rvol, tbr:stats.tbr, obi:stats.obi, atrRank, force, score };
        }));
        sparkItems.sort((a,b)=> b.score - a.score);
        sparkItems = sparkItems.slice(0, CONFIG.SPARK_TOP_N);
      }

      renderSparkList(sparkItems);

      // ì„ íƒëœ ì½”ì¸ì´ ì—†ìœ¼ë©´ 1ìœ„ ìë™ ì„ íƒ (Noâ€‘Motion ìœ ì§€)
      if (!currentMarket && sparkItems[0]){
        selectMarket(sparkItems[0].market);
      }
    } catch(err){ console.error(err); }
  }

  // ê²€ìƒ‰ ì´ë²¤íŠ¸ (í•œê¸€ëª… í¬í•¨)
  document.getElementById('search-input').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const q = e.target.value.trim();
      if (!q) return;
      // ê°„ë‹¨ ê²€ìƒ‰: í•œê¸€ëª… ë§¤ì¹­ or ì‹¬ë³¼ ë§¤ì¹­
      // ì‹¤ì œë¡œëŠ” ì›Œì»¤ì— /search?query= ë¡œ ìœ„ì„ ê°€ëŠ¥
      const hit = lastTickers.find(t => toKo(t.market).includes(q) || (t.market||'').includes(q.toUpperCase()));
      if (hit){ selectMarket(hit.market); }
    }
  });

  // ì‹œì‘
  loop();
  setInterval(loop, CONFIG.LOOP_MS);

  </script>
</body>
</html>
