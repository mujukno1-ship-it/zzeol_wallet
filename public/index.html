<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>사토시의지갑 v11.2 — KRW 실시간</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b7; --text:#e6eef6; --accent:#66e0a3; --danger:#ff6b6b; --warn:#ffcd70;
      --chip:#1a2333; --chip2:#1c2a3f; --border:#1c2736; --good:#36d399; --bad:#f87272;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
    .row{display:flex;gap:12px;align-items:center}
    .topbar{justify-content:flex-start;margin-bottom:16px}
    .input{flex:1;background:#0e1522;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;outline:none}
    .btn{background:#0e1522;color:#cfe2ff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .h{font-weight:700;margin:2px 0 12px 0;font-size:15px;display:flex;gap:8px;align-items:center}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .spark-list{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .spark-item{background:var(--chip);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .spark-name{font-weight:700}
    .spark-price{color:#cfe2ff}
    .bar{width:48%;height:8px;border-radius:999px;background:#0e1724;position:relative;overflow:hidden}
    .bar>.fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#3b82f6,#22d3ee);transition:width .25s}
    .chip{background:var(--chip2);border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:11px;color:#bcd0e6}
    .ultra-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kv{background:#0e1522;border:1px solid var(--border);border-radius:12px;padding:10px}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-size:16px;margin-top:4px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .note{background:#0e1522;border:1px dashed var(--border);border-radius:12px;padding:10px;color:#c6d6ea}
    .small{font-size:12px;color:var(--muted)}
    .row-s{display:flex;gap:8px;flex-wrap:wrap}
    /* No-Motion: 레이아웃 점프 방지 */
    .spark-list, .ultra-grid{min-height:220px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- 검색 & 컨트롤 -->
  <div class="row topbar">
    <input id="q" class="input" placeholder="코인 이름 또는 심볼 입력… (KRW 전용)"/>
    <button id="btnKRW" class="btn">KRW 기준</button>
    <button id="btnNoMotion" class="btn">No-Motion</button>
  </div>

  <!-- 검색 결과 (최대 5개 / 입력시 표기) -->
  <div id="searchBox" class="card">
    <div class="h">검색 결과 — 입력 시 표시 <span class="sub">(업비트 KRW, 최대 5개)</span></div>
    <div id="searchList" class="spark-list"></div>
  </div>

  <!-- SPARK TOP10 -->
  <div class="card" style="margin-top:12px">
    <div class="h">🔥 SPARK TOP10 — 급등 사전 예열 감지
      <span class="sub">RVOL·TBR·OBI·ForceIndex 종합. 5분봉증+ 조건 충족 시 표기</span>
    </div>
    <div id="sparkList" class="spark-list"></div>
  </div>

  <!-- ULTRA (선택한 코인) -->
  <div class="card" style="margin-top:12px">
    <div class="h">ULTRA 시그널 — 선택한 코인 <span id="selName" class="sub"></span></div>

    <div class="ultra-grid">
      <div class="kv"><div class="k">현재가</div><div id="vPrice" class="v">-</div></div>
      <div class="kv"><div class="k">위험도</div><div id="vRisk" class="v">-</div></div>

      <div class="kv"><div class="k">매수(BUY1)</div><div id="vBuy1" class="v">-</div><div class="small" id="vBuy1p"></div></div>
      <div class="kv"><div class="k">매수(BUY2)</div><div id="vBuy2" class="v">-</div><div class="small" id="vBuy2p"></div></div>

      <div class="kv"><div class="k">익절(TP1)</div><div id="vTp1" class="v">-</div><div class="small" id="vTp1p"></div></div>
      <div class="kv"><div class="k">익절(TP2)</div><div id="vTp2" class="v">-</div><div class="small" id="vTp2p"></div></div>

      <div class="kv"><div class="k">손절(SL)</div><div id="vSl" class="v">-</div><div class="small" id="vSlp"></div></div>
      <div class="kv"><div class="k">세력지수</div><div id="vForce" class="v">-</div></div>
    </div>

    <div class="note" style="margin-top:12px">
      <div id="oneLiner">-</div>
      <div class="small" id="modeLine" style="margin-top:6px;color:#9fb7cf">불장/하락장/되돌림 모드 자동 인식</div>
    </div>
  </div>

</div>

<script>
/** ========= 설정 ========= */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
let NO_MOTION = true;

/** ========= 업비트 호가틱 (KRW) =========
 * 정확 보정: 초저가~고가 전체 커버
 * https://docs.upbit.com/reference/호가-단위
 */
function roundTickKRW(price){
  const p = Number(price);
  if (p < 0.1) return Math.round(p / 0.0001) * 0.0001;
  if (p < 1)   return Math.round(p / 0.001)  * 0.001;
  if (p < 10)  return Math.round(p / 0.01)   * 0.01;
  if (p < 100) return Math.round(p / 0.1)    * 0.1;
  if (p < 1000) return Math.round(p / 1)     * 1;
  if (p < 10000) return Math.round(p / 5)    * 5;
  if (p < 100000) return Math.round(p / 10)  * 10;
  if (p < 500000) return Math.round(p / 50)  * 50;
  if (p < 1000000) return Math.round(p / 100)* 100;
  return Math.round(p / 1000)*1000;
}
const fmt = (n)=> Intl.NumberFormat('ko-KR').format(n);

/** ========= 상태 ========= */
let markets = []; // 업비트 KRW 마켓 메타
let selected = null; // {market, korean_name, price...}

/** ========= DOM ========= */
const $ = (id)=> document.getElementById(id);

/** ========= 검색: 입력시 최대 5개 ========= */
$('q').addEventListener('input', e=>{
  const q = e.target.value.trim();
  renderSearch(q);
});

/** ========= 컨트롤 ========= */
$('btnNoMotion').onclick = ()=>{ NO_MOTION = !NO_MOTION; alert('No-Motion: ' + (NO_MOTION?'ON':'OFF')); };
$('btnKRW').onclick = ()=> alert('KRW 기준 고정입니다.');

/** ========= 초기 로드 ========= */
init();
async function init(){
  await loadMarkets();
  pollSpark();
  setInterval(pollSpark, 15000); // 15초
}

/** ========= API ========= */
async function loadMarkets(){
  const r = await fetch(API_BASE + '/upbit/markets');
  const j = await r.json();
  // KRW만
  markets = (j || []).filter(x=>x.market?.startsWith('KRW-')).map(x=>({
    market:x.market, name:x.korean_name, en:x.english_name
  }));
}

async function fetchSparkTop10(){
  const r = await fetch(API_BASE + '/spark/top10');
  return r.json();
}

async function fetchUltraSignal(market){
  const r = await fetch(API_BASE + '/ultra/signal?market=' + encodeURIComponent(market));
  return r.json();
}

/** ========= 렌더: 검색 ========= */
function renderSearch(q){
  const box = $('searchList');
  if(!q){ box.innerHTML=''; return; }
  const ql = q.toLowerCase();
  const list = markets.filter(m=>
    m.market.toLowerCase().includes(ql) || m.name.toLowerCase().includes(ql)
  ).slice(0,5);
  box.innerHTML = '';
  list.forEach(m=>{
    const el = document.createElement('div');
    el.className='spark-item';
    el.innerHTML = `
      <div>
        <div class="spark-name">${m.name}</div>
        <div class="small">${m.market}</div>
      </div>
      <button class="btn">선택</button>
    `;
    el.querySelector('button').onclick = ()=> selectCoin(m);
    box.appendChild(el);
  });
}

/** ========= SPARK ========= */
async function pollSpark(){
  try{
    const j = await fetchSparkTop10();
    const listEl = $('sparkList');
    if(!Array.isArray(j) || j.length===0){
      listEl.innerHTML = `<div class="small">SPARK 데이터 없음</div>`;
      return;
    }
    if(!NO_MOTION) listEl.innerHTML='';
    // 노모션 모드: DOM diff 최소화
    const used = new Set();
    j.slice(0,10).forEach(item=>{
      const id = 'sp-' + item.market;
      used.add(id);
      let row = document.getElementById(id);
      const pct = Math.max(0, Math.min(100, Math.round((item.spark_score||0))));
      if(!row){
        row = document.createElement('div');
        row.className='spark-item';
        row.id = id;
        row.innerHTML=`
          <div style="min-width:44%">
            <div class="spark-name">${item.korean_name || item.market}</div>
            <div class="row-s">
              <span class="chip">예열 ${item.warm_pct??0}%</span>
              <span class="chip">Force ${item.force_index??'-'}</span>
              <span class="chip">RVOL ${item.rvol??'-'}</span>
            </div>
          </div>
          <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
          <div class="spark-price">${fmt(roundTickKRW(item.price))}원</div>
        `;
        listEl.appendChild(row);
        row.onclick = ()=> {
          const m = {market:item.market, name:item.korean_name || item.market};
          selectCoin(m);
          // 검색창 하이라이트 제거
          $('q').value = item.korean_name || item.market;
          renderSearch($('q').value);
        };
      }else{
        row.querySelector('.spark-name').textContent = item.korean_name || item.market;
        row.querySelector('.spark-price').textContent = fmt(roundTickKRW(item.price)) + '원';
        row.querySelector('.fill').style.width = pct+'%';
        row.querySelectorAll('.chip')[0].textContent = `예열 ${item.warm_pct??0}%`;
        row.querySelectorAll('.chip')[1].textContent = `Force ${item.force_index??'-'}`;
        row.querySelectorAll('.chip')[2].textContent = `RVOL ${item.rvol??'-'}`;
      }
    });
    // 제거 대상 정리(노모션 유지)
    Array.from(listEl.children).forEach(ch=>{
      if(!used.has(ch.id)) listEl.removeChild(ch);
    });
  }catch(e){
    console.error(e);
  }
}

/** ========= 선택 & ULTRA ========= */
async function selectCoin(m){
  selected = m;
  $('selName').textContent = `(${m.name} · ${m.market})`;
  await loadUltra(m.market);
}

async function loadUltra(market){
  try{
    const j = await fetchUltraSignal(market);
    // j 예시 필드 가정: { price, buy1, buy2, tp1, tp2, sl, risk, force_index, mode,
    //   rvol, tbr, obi, kimp, funding, spark_score }
    const P = Number(j.price||0);

    // === AI 상승·하락률(%) 계산 — Precision Boost ===
    // 내부 feature 합성 (가벼운 휴리스틱)
    const spark = Number(j.spark_score||0);      // 0~100
    const rvol  = Number(j.rvol||1.0);           // 배수
    const tbr   = Number(j.tbr||0.5);            // 0~1
    const force = Number(j.force_index||50);     // 0~100
    const obi   = Number(j.obi||0);              // -1 ~ +1
    // 상승 기대(%) / 하락 기대(%) 산식 (보수적 캡)
    let upPct = (spark*0.10) + (rvol-1)*6 + (tbr-0.5)*20 + (force-50)*0.18 + (obi)*6;
    let dnPct =  (1.4 - rvol)*6 + (0.5 - tbr)*18 + (50 - force)*0.16 + (-obi)*6 + 2;

    // 경계/캡 & 3회 보정 루프
    upPct = clamp(upPct, 1, 25);
    dnPct = clamp(dnPct, 1, 15);
    for(let i=0;i<2;i++){
      upPct = clamp(upPct + (force>70? +1:0) + (spark>85? +1.5:0), 1, 25);
      dnPct = clamp(dnPct + (force<35? +1.5:0) + (spark<60? +1:0), 1, 15);
    }

    // 타점 계산 (업비트 호가틱 반올림)
    const BUY1 = roundTickKRW(P * (1 - Math.min(0.006, dnPct/100*0.6)));
    const BUY2 = roundTickKRW(P * (1 - Math.min(0.012, dnPct/100)));
    const TP1  = roundTickKRW(P * (1 + upPct/100*0.55));
    const TP2  = roundTickKRW(P * (1 + upPct/100));
    const SL   = roundTickKRW(P * (1 - Math.max(0.006, dnPct/100*0.8)));

    // 위험도 등급 1~5 (저위험 선호 반영)
    const risk = (force>=75 && rvol>=1.6 ? 1
                : force>=60 && rvol>=1.3 ? 2
                : 3);

    // 모드 & 쩔어한마디
    const mode = j.mode || detectMode({rvol,tbr,force,obi});
    const nugget = oneLiner({mode, upPct, dnPct, force, rvol, tbr});

    // === 렌더
    $('vPrice').textContent = fmt(P)+'원';
    $('vRisk').innerHTML = (risk<=2?`<span class="good">${risk}</span>`:`<span class="warn">${risk}</span>`);
    $('vBuy1').textContent = fmt(BUY1)+'원';
    $('vBuy2').textContent = fmt(BUY2)+'원';
    $('vTp1').textContent  = fmt(TP1)+'원';
    $('vTp2').textContent  = fmt(TP2)+'원';
    $('vSl').textContent   = fmt(SL)+'원';
    $('vForce').textContent= Math.round(force);

    // 새 기능: AI 상승/하락률(%) 표기
    $('vBuy1p').innerHTML = `AI 하락폭 예상 <b class="bad">-${dnPct.toFixed(1)}%</b> 기준 눌림 진입`;
    $('vBuy2p').innerHTML = `추가 눌림 시 <b class="bad">-${(dnPct*1.2).toFixed(1)}%</b> 영역`;
    $('vTp1p').innerHTML  = `AI 상승률 예상 <b class="good">+${(upPct*0.55).toFixed(1)}%</b>`;
    $('vTp2p').innerHTML  = `AI 상승률 최대 <b class="good">+${upPct.toFixed(1)}%</b>`;
    $('vSlp').innerHTML   = `리스크 방어 <b class="bad">-${Math.max(dnPct*0.8,0.6).toFixed(1)}%</b>`;

    $('oneLiner').textContent = nugget;
    $('modeLine').textContent = `현재 모드: ${modeLabel(mode)} · Precision Boost(±0.3% ×3) 적용`;

  }catch(e){
    console.error(e);
  }
}

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function modeLabel(m){ return m==='bull'?'불장':'bear'===m?'하락장':'되돌림'; }

function detectMode({rvol,tbr,force,obi}){
  let score = 0;
  if(rvol>=1.8) score+=2;
  if(tbr>=0.62) score+=2;
  if(force>=75) score+=2;
  if(obi>=0.15) score+=1;
  if(score>=4) return 'bull';
  if(force<=35 || tbr<=0.45 || obi<=-0.2) return 'bear';
  return 'retr';
}

function oneLiner({mode, upPct, dnPct, force, rvol, tbr}){
  if(mode==='bull'){
    if(upPct>=15) return `세력 분출 임박, 조기익절 금지. 최대 +${upPct.toFixed(1)}% 구간 노림.`;
    return `세력 매집 진행, 눌림 후 재상승. TP 분할로 +${(upPct*0.55).toFixed(1)}% → +${upPct.toFixed(1)}%.`;
  }
  if(mode==='bear'){
    return `하락장 빠른매도 모드: 본전 이동 빠르게, 손절 ${dnPct.toFixed(1)}% 내 방어 권장.`;
  }
  return `되돌림 구간: 1차 분할 진입, 반등 실패 시 청산. 상방 ${upPct.toFixed(1)}% / 하방 ${dnPct.toFixed(1)}%.`;
}
</script>
</body>
</html>
