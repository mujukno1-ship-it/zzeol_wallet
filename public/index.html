<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ì „ì„¤íŒ ê¶ê·¹í™•ì¥(âˆ)</title>
<style>
  :root{--bg:#0f1117;--panel:#161b22;--muted:#8b98a5;--txt:#e6edf3;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--acc:#4ea1ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1140px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--panel);border:1px solid #212a39;border-radius:14px;padding:14px}
  .muted{color:var(--muted)} .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3546;background:#0f1522;color:#a9c1ff;font-size:12px}
  .flex{display:flex;gap:8px;align-items:center}
  input,button,select{background:#111827;border:1px solid #273247;color:#dbe8ff;border-radius:10px;padding:10px}
  button{cursor:pointer}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .val{font-weight:700;font-size:18px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .acc{color:var(--acc)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .spark{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
  .chip{background:#0e1421;border:1px solid #24324a;border-radius:12px;padding:10px}
  .hint{font-size:12px;color:#9fb0c7}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸª™ ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ì „ì„¤íŒ ê¶ê·¹í™•ì¥(âˆ) <span class="pill" id="modeTag">ëª¨ë“œ: í™•ì¸ ì¤‘â€¦</span></h1>

  <!-- ê²€ìƒ‰ + ê´€ì‹¬ì½”ì¸ ì»¨íŠ¸ë¡¤ -->
  <div class="flex" style="margin-bottom:12px">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC, ì‹œë°”, SHIB)" style="flex:1">
    <button id="apply">ê²€ìƒ‰/ì ìš©</button>
    <select id="addFav"><option value="">ê´€ì‹¬ì½”ì¸ ì¶”ê°€</option></select>
    <span class="muted">ìƒíƒœ: <b id="state" class="ok">ì •ìƒ</b></span>
  </div>

  <div class="row">
    <!-- ê¹€í”„ -->
    <section class="card">
      <div class="flex"><b>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</b><span class="pill" id="premSym">BTC</span></div>
      <div class="kpi" style="margin-top:8px">
        <div><div class="muted">ì—…ë¹„íŠ¸ KRW</div><div class="val" id="krw">-</div></div>
        <div><div class="muted">ê¸€ë¡œë²Œ USD</div><div class="val" id="usd">-</div></div>
        <div><div class="muted">USD/KRW</div><div class="val" id="fx">-</div></div>
        <div><div class="muted">í”„ë¦¬ë¯¸ì—„(%)</div><div class="val" id="ppm">-</div></div>
      </div>
      <div class="hint">ì†ŒìŠ¤: Upbit / CoinGecko / ER-API</div>
    </section>

    <!-- ì˜¨ì²´ì¸ -->
    <section class="card">
      <div class="flex"><b>ğŸ§  ì˜¨ì²´ì¸ TVL(ETH)</b><span class="pill">ìë™ í´ë°±</span></div>
      <div class="kpi" style="margin-top:8px">
        <div><div class="muted">TVL</div><div class="val" id="tvl">-</div></div>
        <div><div class="muted">ì†ŒìŠ¤</div><div class="val" id="tvlSrc">-</div></div>
      </div>
      <div class="hint">DefiLlama summary ì¥ì•  ì‹œ v2/chains í´ë°± Â· 60s ìºì‹œ</div>
    </section>
  </div>

  <div class="row" style="margin-top:12px">
    <!-- ì‹œê·¸ë„ -->
    <section class="card">
      <div class="flex"><b>ğŸ“ ì‹œê·¸ë„</b><span class="pill" id="sigSym">BTC</span></div>
      <div class="grid3" style="margin-top:8px">
        <div><div class="muted">í˜„ì¬ê°€</div><div class="val" id="p">-</div></div>
        <div><div class="muted">ë§¤ìˆ˜</div><div class="val ok" id="b">-</div></div>
        <div><div class="muted">ë§¤ë„</div><div class="val bad" id="s">-</div></div>
      </div>
      <div class="grid3" style="margin-top:8px">
        <div><div class="muted">ì†ì ˆ</div><div class="val warn" id="st">-</div></div>
        <div><div class="muted">ìœ„í—˜ë„</div><div class="val" id="r">-</div></div>
        <div><div class="muted">ì„¸ë ¥ê°•ë„</div><div class="val" id="pow">-</div></div>
      </div>
    </section>

    <!-- í•œë§ˆë”” -->
    <section class="card">
      <div class="flex"><b>ğŸ’¬ ì©”ì–´ ê²°ë¡ </b><span class="pill">AI</span></div>
      <div class="val" id="ment">-</div>
      <div class="hint">ì—…ë°ì´íŠ¸: <span id="upd">-</span></div>
    </section>
  </div>

  <!-- SPARK ê¸‰ë“± ë ˆì´ë” -->
  <section class="card" style="margin-top:12px">
    <div class="flex"><b>ğŸ”¥ SPARK â€” ê¸‰ë“± í›„ë³´ ë ˆì´ë”</b><span class="pill">ì‹¤ì‹œê°„</span></div>
    <div id="sparkBox" class="spark" style="margin-top:10px"></div>
  </section>

  <!-- ê´€ì‹¬ì½”ì¸(ìµœëŒ€ 10) -->
  <section class="card" style="margin-top:12px">
    <div class="flex"><b>â­ ê´€ì‹¬ì½”ì¸ (ìµœëŒ€ 10)</b><span class="pill">ë™ì¼ í•­ëª© í‘œì‹œ</span></div>
    <div id="favBox" class="spark" style="margin-top:10px"></div>
  </section>
</div>

<script>
const API = 'https://satoshi-proxy.mujukno1.workers.dev'; // â† ë³¸ì¸ ì›Œì»¤ ì£¼ì†Œë©´ ìˆ˜ì •
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (Number(n)||0).toLocaleString('ko-KR',{maximumFractionDigits:6});
const SYMS = ["BTC","ETH","XRP","ADA","BCH","SOL","DOGE","MATIC","AVAX","LINK","TRX","ATOM","SHIB","LTC"];

let FAV = JSON.parse(localStorage.getItem('FAV.v1') || '["BTC","ETH","BCH","SHIB"]'); // ìµœëŒ€ 10

function saveFav(){ FAV = [...new Set(FAV)].slice(0,10); localStorage.setItem('FAV.v1', JSON.stringify(FAV)); renderFav(); }
function addFav(sym){ if(!sym) return; FAV.push(sym.toUpperCase()); saveFav(); }
function delFav(sym){ FAV = FAV.filter(x=>x!==sym); saveFav(); }

async function jget(p, tries=2, timeout=8000){
  for(let i=0;i<tries;i++){
    try{
      const ac = new AbortController(); const id = setTimeout(()=>ac.abort(), timeout);
      const r = await fetch(API+p+(p.includes('?')?'&':'?')+'t='+Date.now(), {signal:ac.signal, cache:'no-store'});
      clearTimeout(id);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ if(i<tries-1) await new Promise(r=>setTimeout(r,400)); else return { ok:false, error:e.message }; }
  }
}

function symFromQuery(q){
  q=(q||'').trim().toUpperCase();
  if(!q) return 'BTC';
  if(q.includes('ë¹„íŠ¸')) return 'BTC';
  if(q.includes('ì´ë”')) return 'ETH';
  if(q.includes('ì‹œë°”')) return 'SHIB';
  return q.length<=6?q:'BTC';
}

function setState(t, ok=true){ const el=$('state'); el.textContent=t; el.className=ok?'ok':'bad'; }

// ê¹€í”„
async function loadPremium(sym){
  $('premSym').textContent = sym;
  const d = await jget(`/api/premium?symbol=${sym}`);
  if(!d.ok){ setState('ì—°ê²° ì§€ì—°', false); return; }
  $('krw').textContent = fmt(d.upbitPrice)+' KRW';
  $('usd').textContent = (d.globalUsd||0).toLocaleString('en-US',{maximumFractionDigits:2})+' USD';
  $('fx').textContent  = (d.usdkrw||0).toLocaleString('ko-KR',{maximumFractionDigits:2});
  const pct = d.premiumPct||0; const el = $('ppm');
  el.textContent = (pct>0?'+':'')+pct.toFixed(2)+' %';
  el.className = 'val ' + (pct>0?'bad':(pct<0?'ok':''));
}

// ì˜¨ì²´ì¸
async function loadTVL(){
  const d = await jget('/api/onchain?symbol=ETH');
  if(!d.ok){ $('tvl').textContent='-'; $('tvlSrc').textContent='ì§€ì—°'; return; }
  $('tvl').textContent = '$ '+(d.tvl||0).toLocaleString('en-US');
  $('tvlSrc').textContent = d.src||'-';
}

// ì‹œê·¸ë„
async function loadSignal(sym){
  $('sigSym').textContent = sym;
  const d = await jget(`/api/signal?symbol=${sym}`);
  if(!d.ok){ setState('ì—°ê²° ì§€ì—°', false); return; }
  $('p').textContent = fmt(d.price);
  $('b').textContent = fmt(d.buy);
  $('s').textContent = fmt(d.sell);
  $('st').textContent= fmt(d.stop);
  $('r').textContent = (d.riskPct||0)+' %';
  $('pow').textContent= (d.power||0)+' %';
  $('ment').textContent= d.ment||'-';
  $('upd').textContent = (d.updatedAt||'').replace('T',' ').replace('Z','');
}

// SPARK
async function loadSpark(){
  const d = await jget('/api/spark');
  const box = $('sparkBox'); box.innerHTML='';
  if(!d.ok || !d.list || !d.list.length){ box.innerHTML='<div class="muted">í›„ë³´ ì—†ìŒ</div>'; return; }
  for(const x of d.list){
    const el = document.createElement('div');
    el.className = 'chip';
    el.innerHTML = `
      <div class="flex" style="justify-content:space-between">
        <b>${x.symbol}</b><span class="pill">Score ${x.score}</span>
      </div>
      <div class="muted">í˜„ì¬ê°€</div><div class="val">${fmt(x.price)} KRW</div>
      <div class="muted">ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ</div>
      <div>${fmt(x.buy)} / ${fmt(x.sell)} / ${fmt(x.cut)}</div>
      <div class="muted">ìœ„í—˜ë„</div><div>${(x.riskPct||0)} %</div>
      <div class="muted">ê²°ë¡ </div><div>${x.ment||'-'}</div>
      <div class="hint">ì—…ë°ì´íŠ¸: ${x.updatedAt?.replace('T',' ').replace('Z','')||'-'}</div>
    `;
    el.onclick = ()=>{ $('q').value=x.symbol; applySearch(); };
    box.appendChild(el);
  }
}

// ê´€ì‹¬ì½”ì¸(ìµœëŒ€ 10)
async function renderFav(){
  const box = $('favBox'); box.innerHTML='';
  for(const s of FAV.slice(0,10)){
    const [sg, pm] = await Promise.all([ jget(`/api/signal?symbol=${s}`), jget(`/api/premium?symbol=${s}`) ]);
    const el = document.createElement('div'); el.className='chip';
    el.innerHTML = `
      <div class="flex" style="justify-content:space-between">
        <b>${s}</b>
        <button style="background:#1a2335;border:1px solid #2a3953;border-radius:8px;padding:4px 8px;color:#cfe0ff;cursor:pointer" onclick="delFav('${s}')">ì œê±°</button>
      </div>
      <div class="muted">í˜„ì¬ê°€</div><div class="val">${sg.ok?fmt(sg.price):'-'} KRW</div>
      <div class="muted">ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ</div>
      <div>${sg.ok? `${fmt(sg.buy)} / ${fmt(sg.sell)} / ${fmt(sg.stop)}`:'-'}</div>
      <div class="muted">ìœ„í—˜ë„</div><div>${sg.ok? (sg.riskPct+' %'):'-'}</div>
      <div class="muted">ê¹€í”„</div><div>${pm.ok? ((pm.premiumPct||0).toFixed(2)+' %'):'-'}</div>
      <div class="muted">ê²°ë¡ </div><div>${sg.ok? sg.ment:'-'}</div>
    `;
    box.appendChild(el);
  }
}

// ë§ˆì¼“ ëª¨ë“œ
async function loadMarketMode(){
  const d = await jget('/api/market-mode');
  const el = $('modeTag');
  if(!d.ok){ el.textContent='ëª¨ë“œ: ì§€ì—°'; return; }
  const label = d.mode==='bull' ? 'ë¶ˆì¥(BULL)' : d.mode==='bear' ? 'í•˜ë½(BEAR)' : 'íš¡ë³´(RANGE)';
  el.textContent = `ëª¨ë“œ: ${label} Â· ì¶”ì„¸ ${d.trend}% Â· ê°•ë„ ${d.power}%`;
  el.style.borderColor = d.mode==='bull' ? '#22c55e' : d.mode==='bear' ? '#ef4444' : '#4ea1ff';
  el.style.color = d.mode==='bull' ? '#22c55e' : d.mode==='bear' ? '#ef4444' : '#4ea1ff';
}

async function applySearch(){
  setState('ê°±ì‹  ì¤‘...', true);
  const sym = symFromQuery($('q').value);
  await Promise.all([ loadPremium(sym), loadSignal(sym) ]);
  setState('ì •ìƒ', true);
  // ë“œë¡­ë‹¤ìš´ì— ì¦ê²¨ì°¾ê¸° ì¶”ê°€ìš© ì˜µì…˜ ì±„ì›€
  const sel = $('addFav');
  sel.innerHTML = '<option value="">ê´€ì‹¬ì½”ì¸ ì¶”ê°€</option>' + SYMS.map(s=>`<option value="${s}">${s}</option>`).join('');
}

$('apply').onclick = async ()=> applySearch();
$('addFav').onchange = (e)=>{ addFav(e.target.value); e.target.value=''; };

(async function boot(){
  // ì´ˆê¸° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì±„ìš°ê¸°
  $('addFav').innerHTML = '<option value="">ê´€ì‹¬ì½”ì¸ ì¶”ê°€</option>' + SYMS.map(s=>`<option value="${s}">${s}</option>`).join('');
  await Promise.all([ loadPremium('BTC'), loadTVL(), loadSignal('BTC'), loadMarketMode(), loadSpark() ]);
  renderFav();
  // ì£¼ê¸° ê°±ì‹ 
  setInterval(loadMarketMode, 15000);
  setInterval(()=>{ const sym=symFromQuery($('q').value||'BTC'); loadSignal(sym); }, 15000);
  setInterval(loadSpark, 20000);
  setInterval(renderFav, 30000);
})();
</script>
</body>
</html>
