<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>💰 사토시의지갑 – 실시간 업비트 연동 (정확도 95%)</title>
  <style>
    body { background:#0d1117; color:#e6edf3; font-family:'Pretendard',sans-serif; }
    .card { background:#161b22; border-radius:16px; padding:16px; margin:12px; }
    h2 { color:#58a6ff; font-size:18px; margin-bottom:8px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .flex { flex:1; min-width:320px; }
    .status { color:#2ecc71; font-size:14px; margin-top:4px; }
    input,button,select { background:#21262d; color:#e6edf3; border:none; padding:8px; border-radius:8px; }
    .search-box { display:flex; gap:6px; margin-bottom:12px; }
    .highlight { color:#ffb347; font-weight:bold; }
  </style>
</head>
<body>
  <h1>💰 사토시의지갑 – 실시간 업비트 연동 <span class="status" id="state">정상</span></h1>

  <div class="search-box">
    <input id="search-input" placeholder="코인명 (예: 비트코인, 시바이누, 에이다)">
    <button id="search-btn">검색</button>
  </div>

  <div class="row">
    <div class="card flex">
      <h2>💎 김치 프리미엄 (BTC)</h2>
      <div id="kimchi"></div>
    </div>
    <div class="card flex">
      <h2>🧠 온체인 TVL(ETH)</h2>
      <div id="tvl"></div>
    </div>
  </div>

  <div class="row">
    <div class="card flex">
      <h2>🍓 시그널</h2>
      <div id="signal"></div>
    </div>
    <div class="card flex">
      <h2>💬 쩔어 한마디</h2>
      <div id="comment"></div>
    </div>
  </div>

  <div class="card">
    <h2>⚡ 영구 고정 SPARK (관심코인)</h2>
    <div id="spark"></div>
  </div>

  <script>
    const CONFIG = { API_BASE: "https://satoshi-proxy.mujukno1.workers.dev" };

    async function jget(path, tries=2, timeout=8000){
      for (let i=0;i<tries;i++){
        try{
          const ac=new AbortController();
          const id=setTimeout(()=>ac.abort(),timeout);
          const r=await fetch(CONFIG.API_BASE+path+'?t='+Date.now(),{signal:ac.signal,cache:'no-store'});
          clearTimeout(id);
          if(!r.ok) throw new Error('HTTP '+r.status);
          return await r.json();
        }catch(e){
          if(i<tries-1) await new Promise(res=>setTimeout(res,500));
          else return {ok:false,error:e.message};
        }
      }
    }

    function setState(t,ok=true){const s=document.getElementById('state');s.textContent=t;s.style.color=ok?'#2ecc71':'#ff5c5c';}

    async function loadPremium(sym='BTC'){
      const d=await jget('/api/premium?symbol='+sym);
      const el=document.getElementById('kimchi');
      if(!d||!d.ok){el.innerHTML='오류';setState('연결 끊김',false);return;}
      el.innerHTML=`
        업비트 KRW: <span class='highlight'>${d.upbit.toLocaleString()} KRW</span><br>
        글로벌 USD: ${d.global.toLocaleString()} USD<br>
        USD/KRW: ${d.rate.toLocaleString()}<br>
        프리미엄(%): <span class='highlight'>${d.premium.toFixed(2)}%</span>`;
    }

    async function loadSignal(sym='BTC'){
      const d=await jget('/api/signal?symbol='+sym);
      const el=document.getElementById('signal');
      if(!d||!d.ok){el.innerHTML='-';setState('연결 끊김',false);return;}
      el.innerHTML=`
        현재가: ${d.price.toLocaleString()} KRW<br>
        매수: ${d.buy.toLocaleString()} KRW<br>
        매도: ${d.sell.toLocaleString()} KRW<br>
        손절: ${d.cut.toLocaleString()} KRW<br>
        위험도: ${d.risk.toFixed(2)} %<br>
        세력강도: ${d.power.toFixed(2)} %`;
    }

    async function loadComment(sym='BTC'){
      const d=await jget('/api/comment?symbol='+sym);
      const el=document.getElementById('comment');
      if(!d||!d.ok){el.innerHTML='-';return;}
      el.innerHTML=`${d.msg}<br><small>업데이트: ${d.time}</small>`;
    }

    async function loadSpark(){
      const d=await jget('/api/spark');
      const el=document.getElementById('spark');
      if(!d||!d.ok){el.innerHTML='-';return;}
      el.innerHTML=d.list.map(c=>`
        ${c.symbol}: ${c.price.toLocaleString()} / ${c.buy.toLocaleString()} / ${c.sell.toLocaleString()} / ${c.cut.toLocaleString()} / 위험도 ${c.risk.toFixed(2)} % / ${c.comment}
      `).join('<br>');
    }

    async function searchCoin(){
      const kw=document.getElementById('search-input').value.trim();
      if(!kw){alert('코인명을 입력하세요');return;}
      setState('검색중...',true);
      await Promise.all([
        loadPremium(kw),
        loadSignal(kw),
        loadComment(kw)
      ]);
      setState('정상',true);
    }

    document.getElementById('search-btn').onclick=searchCoin;

    async function init(){
      setState('로딩중...',true);
      await loadPremium();
      await loadSignal();
      await loadComment();
      await loadSpark();
      setState('정상',true);
    }

    init();
  </script>
</body>
</html>
