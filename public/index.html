<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>KRW 코인 검색 · 매수/매도 타점</title>
  <style>
    body { background:#0d1117; color:#e6edf3; font-family:sans-serif; margin:20px; }
    input,button { padding:8px 10px; border-radius:6px; }
    input { border:1px solid #30363d; background:#161b22; color:#e6edf3; }
    button { border:1px solid #238636; background:#238636; color:white; cursor:pointer; }
    button:hover { background:#2ea043; }
    .result { margin-top:20px; padding:15px; background:#161b22; border:1px solid #30363d; border-radius:8px; }
    .error { color:#ff7b72; }
  </style>
</head>
<body>
  <h2>KRW 코인 검색 · 매수/매도 타점</h2>
  <input id="coinInput" placeholder="예: BTC, ETH, 시바이누" />
  <button onclick="searchCoin()">검색</button>
  <div id="status"></div>
  <div id="result" class="result" style="display:none"></div>

<script>
/* ============================
   초보자용 — API 순차 시도 + 에러 표시
============================= */

// API 후보 주소 3개 (순서대로 시도)
const API_LIST = [
  '/api/summary', // Cloudflare Pages 함수
  '/functions/api/summary', // 예전 경로
  'https://satoshi-proxy.mujukno1.workers.dev/summary' // 워커 (선택)
];

// 상태 표시 함수
function setStatus(msg, color='#e6edf3') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = color;
}

// JSON이 아닌 HTML이면 에러라고 판단
function looksLikeHTML(text) {
  const t = text.trim().toLowerCase();
  return t.startsWith('<!doctype') || t.startsWith('<html');
}

// 실제 데이터 가져오기
async function getSummary(market) {
  let lastError = null;
  for (const base of API_LIST) {
    try {
      const url = `${base}?market=${encodeURIComponent(market)}`;
      setStatus(`🔄 시도 중: ${url}`);
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      if (looksLikeHTML(text)) throw new Error('HTML 응답 (404 페이지)');
      const json = JSON.parse(text);
      if (json.ok) return json;
      throw new Error(json.error || 'API 오류');
    } catch (err) {
      console.warn('실패:', err);
      lastError = err;
    }
  }
  throw lastError || new Error('모든 경로 실패');
}

// 업비트 마켓 형식 변환 (예: ETH → KRW-ETH)
function toMarketName(t) {
  t = t.trim().toUpperCase();
  if (t.startsWith('KRW-')) return t;
  const map = { '비트코인':'KRW-BTC', '이더리움':'KRW-ETH', '시바이누':'KRW-SHIB' };
  return map[t] || 'KRW-' + t;
}

// 메인 함수: 검색 버튼 눌렀을 때
async function searchCoin() {
  const coin = document.getElementById('coinInput').value.trim();
  if (!coin) { setStatus('❗ 코인명을 입력하세요', '#ff7b72'); return; }

  const market = toMarketName(coin);
  setStatus('데이터 불러오는 중...');
  document.getElementById('result').style.display = 'none';

  try {
    const data = await getSummary(market);
    showResult(data);
    setStatus('✅ 불러오기 성공!');
  } catch (err) {
    console.error(err);
    setStatus('❌ 데이터 로드 실패: ' + err.message, '#ff7b72');
  }
}

// 결과 표시
function showResult(d) {
  const box = document.getElementById('result');
  box.style.display = 'block';
  box.innerHTML = `
    <b>코인:</b> ${d.symbol}<br>
    <b>현재가:</b> ${d.price?.toLocaleString() || '-'} 원<br>
    <b>등락:</b> ${d.change?.toFixed(2) || 0}%<br>
    <b>김치 프리미엄:</b> ${d.kimchi?.toFixed(2) || 0}%<br>
    <b>매수 타점:</b> ${d.buy?.toLocaleString() || '-'} 원<br>
    <b>매도 타점:</b> ${d.sell?.toLocaleString() || '-'} 원<br>
    <b>손절 라인:</b> ${d.stop?.toLocaleString() || '-'} 원<br>
    <b>위험도:</b> ${d.risk || '-'}<br>
    <b>쩔어 한마디:</b> ${
      d.risk === 'danger' ? '🔥 과열 주의! 보수적 접근' :
      d.risk === 'caution' ? '⚠️ 변동성 구간! 분할매수 권장' :
      '✅ 안정 구간! 추세 유지 중'
    }
  `;
}
</script>
</body>
</html>
