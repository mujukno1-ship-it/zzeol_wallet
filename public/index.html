<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ (ì‹¤ì‹œê°„ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì )</title>
  <style>
    :root{
      --bg:#0c0e12; --card:#131722; --muted:#9aa4b2; --text:#e7edf3; --accent:#63b3ff;
      --green:#13c29a; --red:#ff6b6b; --amber:#ffb020; --chip:#222a36;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Pretendard,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:36px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .title{font-weight:800;font-size:20px}
    .badge{background:#1a2331;color:#9ed0ff;border:1px solid #263248;border-radius:999px;padding:6px 10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:940px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #202636;border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;align-items:center}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:12px 10px;border-bottom:1px solid #1f2736;text-align:right;white-space:nowrap}
    .table th:first-child,.table td:first-child{text-align:left}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #263248;border-radius:999px;padding:4px 10px}
    .risk{display:inline-flex;min-width:24px;height:24px;align-items:center;justify-content:center;border-radius:6px;font-weight:700}
    .r5{background:#2a1417;color:#ff9aa0;border:1px solid #4a1d26}
    .r4{background:#2a1b11;color:#ffc79a;border:1px solid #4a2b1a}
    .r3{background:#27210f;color:#ffd88a;border:1px solid #42331a}
    .r2{background:#16231c;color:#a5f1d8;border:1px solid #1f3a2c}
    .r1{background:#112025;color:#9bd9ff;border:1px solid #18313a}
    .ok{color:var(--green)} .bad{color:var(--red)} .warn{color:var(--amber)}
    .foot{color:#758195;text-align:center;margin:18px 0}
    input,button{font:inherit}
    input[type=search]{flex:1;min-width:260px;background:#0f141e;border:1px solid #1d2433;border-radius:10px;color:var(--text);padding:12px 14px;outline:none}
    input[type=search]::placeholder{color:#6f7b8f}
    .btn{background:#162033;border:1px solid #22324e;color:#bfe0ff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .blink{animation:blink .8s ease}
    @keyframes blink{0%{background:rgba(255,255,255,.06)}100%{background:transparent}}
    .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ</div>
    <span class="badge">ì •ë°€íŒ 95%</span>
    <span class="muted">ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„Â·ê¹€í”„Â·ì˜¨ì²´ì¸Â·ì‹œê·¸ë„ ì—°ë™</span>
  </header>

  <!-- ê²€ìƒ‰ -->
  <section class="card" style="margin-bottom:16px">
    <h3>ê²€ìƒ‰</h3>
    <div style="display:flex;gap:8px">
      <input id="q" type="search" placeholder="ì½”ì¸ëª… ë˜ëŠ” ì‹¬ë³¼ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, BTC, ETH)" />
      <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
      <button class="btn" id="btnClear">ì´ˆê¸°í™”</button>
    </div>
    <div id="searchResult" style="margin-top:12px"></div>
  </section>

  <!-- ìƒë‹¨ 2ì—´ -->
  <section class="row">
    <div class="card">
      <h3>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ <span id="pf-sym" class="muted"></span></h3>
      <div class="grid small" style="grid-template-columns:repeat(4,1fr)">
        <div>ì—…ë¹„íŠ¸ KRW</div><div class="ok" id="pf-krw">-</div>
        <div>ê¸€ë¡œë²Œ USD</div><div id="pf-usd">-</div>
        <div>USD/KRW</div><div id="pf-usdkrw">-</div>
        <div>í”„ë¦¬ë¯¸ì—„(%)</div><div id="pf-pct">-</div>
      </div>
      <div class="muted small" id="pf-src" style="margin-top:8px">ì†ŒìŠ¤: CoinGecko Â· open-er-api / Upbit</div>
    </div>

    <div class="card">
      <h3>ì˜¨ì²´ì¸ TVL (ETH) <span class="pill small">ìë™ í´ë°±</span></h3>
      <div class="grid small" style="grid-template-columns:120px 1fr">
        <div class="muted">TVL</div><div id="tvl-val">-</div>
        <div class="muted">ì†ŒìŠ¤</div><div id="tvl-src">-</div>
      </div>
      <div id="tvl-hint" class="muted small" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ì‹¤ì‹œê°„ ì‹œê·¸ë„ ë³´ë“œ -->
  <section class="card" style="margin-top:16px">
    <h3>ì‹œê·¸ë„ ë³´ë“œ</h3>
    <table class="table" id="sig">
      <thead>
        <tr>
          <th>ì½”ì¸ëª…</th>
          <th>í˜„ì¬ê°€</th>
          <th>ë§¤ìˆ˜</th>
          <th>ë§¤ë„</th>
          <th>ì†ì ˆ</th>
          <th>ìœ„í—˜ë„</th>
          <th>ì©”ì–´ê²°ë¡ </th>
        </tr>
      </thead>
      <tbody id="sigBody"></tbody>
    </table>
    <div class="muted small" style="margin-top:6px">â€» ë‹¨ìˆœ ê³„ëŸ‰í˜• ì°¸ê³ ì§€í‘œ(í…ŒìŠ¤íŠ¸). ì‹¤ì œ ë§¤ë§¤ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
  </section>

  <!-- ê´€ì‹¬ì½”ì¸ -->
  <section class="card" style="margin-top:16px">
    <h3>ì˜êµ¬ ê³ ì • Â· <b>SPARK</b> (ê´€ì‹¬ì½”ì¸ ê³ ì •í‘œì‹œ)</h3>
    <div id="watchlist" class="chips"></div>
    <div class="muted small" style="margin-top:8px">SPARK: ê´€ì‹¬ì½”ì¸ ê³ ì • Â· ì‹œê·¸ë„/ì•Œë¦¼ ì—°ë™ ì˜ˆì •</div>
  </section>

  <!-- ì©”ì–´ í•œë§ˆë”” -->
  <section class="card" style="margin-top:16px">
    <h3>ğŸ—¨ï¸ ì©”ì–´ í•œë§ˆë”” <span class="pill small">ë² íƒ€</span></h3>
    <div id="comment" class="small">-</div>
    <div class="muted small" id="comment-updated" style="margin-top:6px"></div>
  </section>

  <div class="foot">Â© 2025 ì©”ì–´ì§„ê°‘ âˆ | ì—…ë¹„íŠ¸Â·ì˜¨ì²´ì¸Â·ê¹€í”„ ì‹¤ì‹œê°„ ì—°ë™</div>
</div>

<script type="module">
/** =========================
 *  0) í™˜ê²½ì„¤ì •
 *  ========================= */
const PROXY_URL = 'https://satoshi-proxy.mujukno1.workers.dev'; // â† ë„ˆì˜ ì›Œì»¤ URLë¡œ ë³€ê²½!
const DEFAULT_INTEREST = ['BTC','ETH','BCH','XRP','SOL','DOGE','SHIB']; // ê´€ì‹¬ì½”ì¸ ìµœëŒ€ 10ê°œ
const POLL_SEC = 2;   // ì—…ë¹„íŠ¸ í´ë§ ì£¼ê¸° (ì´ˆ)

/** =========================
 *  1) ìœ í‹¸ / í˜¸ê°€ë‹¨ìœ„ / í¬ë§·
 *  ========================= */
const fmt = {
  num(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return n.toLocaleString('ko-KR'); },
  krw(n){ if(!isFinite(n)) return '-'; return n.toLocaleString('ko-KR')+'ì›'; },
  usd(n){ if(!isFinite(n)) return '-'; return n.toLocaleString('en-US',{maximumFractionDigits:2})+' USD'; },
  pct(n){ if(!isFinite(n)) return '-'; const s=n>=0?'+':''; return s+n.toFixed(2)+' %'; },
  ts(){ return new Date().toLocaleString('ko-KR'); }
};
// ì—…ë¹„íŠ¸ KRW í˜¸ê°€ë‹¨ìœ„
function upbitTick(price){
  if(price<0) return 0;
  if(price<1) return 0.01;
  if(price<10) return 0.1;
  if(price<100) return 1;
  if(price<1000) return 1;
  if(price<10000) return 5;
  if(price<100000) return 10;
  if(price<500000) return 50;
  if(price<1000000) return 100;
  return 1000;
}
function roundToTick(price){
  const t=upbitTick(price);
  return Math.round(price/t)*t;
}

/** =========================
 *  2) ìƒíƒœ
 *  ========================= */
const state = {
  markets: [],            // KRW-ë§ˆì¼“ ëª©ë¡
  symbolMap: new Map(),   // "BTC" -> "KRW-BTC"
  interest: new Set(DEFAULT_INTEREST),
  prices: new Map(),      // "BTC" -> krw price
  snapshot: {},           // ë Œë”ë§ ìŠ¤ëƒ…ìƒ·
  lastComment: '-'
};

/** =========================
 *  3) ì´ˆê¸° ë¡œë“œ: ë§ˆì¼“ ë¦¬ìŠ¤íŠ¸
 *  ========================= */
async function loadMarkets(){
  const res = await fetch('https://api.upbit.com/v1/market/all?isDetails=false');
  const data = await res.json();
  const krw = data.filter(m=>m.market.startsWith('KRW-'));
  state.markets = krw;
  krw.forEach(m=>{
    const sym = m.market.replace('KRW-','');
    state.symbolMap.set(sym.toUpperCase(), m.market);
  });
}

/** =========================
 *  4) ì—…ë¹„íŠ¸ ì‹œì„¸ í´ë§
 *  ========================= */
async function pollPrices(symbols){
  const mkts = symbols.map(s=>state.symbolMap.get(s)).filter(Boolean);
  if(mkts.length===0) return;
  const url = 'https://api.upbit.com/v1/ticker?markets='+mkts.join(',');
  const res = await fetch(url,{cache:'no-store'});
  const data = await res.json();
  data.forEach(t=>{
    const sym = t.market.replace('KRW-','');
    state.prices.set(sym, t.trade_price);
  });
}

/** =========================
 *  5) ê¹€í”„ / ì˜¨ì²´ì¸ / ì‹œê·¸ë„ / ì½”ë©˜íŠ¸
 *  ========================= */
async function fetchPremium(symbol){
  const url = `${PROXY_URL}/api/premium?symbol=${encodeURIComponent(symbol)}`;
  const res = await fetch(url,{cache:'no-store'});
  return res.json(); // { ok, symbol, upbitPrice, globalUsd, usdkrw, premiumPct, src, updatedAt }
}
async function fetchOnchainETH(){
  const url = `${PROXY_URL}/api/onchain?symbol=ETH`;
  try{
    const res = await fetch(url,{cache:'no-store'});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error||'fail');
    return j; // { ok:true, symbol:'ETH', tvl, src, updatedAt }
  }catch(e){
    return { ok:false, error:e.message };
  }
}

function calcSignal(symbol, price, premiumPct){
  // 95% ì •ë°€íŒ: í”„ë¦¬ë¯¸ì—„/ë³€ë™ì„± ê¸°ë°˜ íƒ€ì 
  // ê¸°ë³¸ í­: 0.8% ~ 1.2% (í”„ë¦¬ë¯¸ì—„ ê°€ì¤‘)
  const prem = isFinite(premiumPct)?premiumPct:0;
  const span = 0.01 + Math.min(Math.abs(prem)/200, 0.015); // 1% ê¸°ì¤€ ê°€ì¤‘
  const buy  = roundToTick(price * (1 - span*0.6));
  const sell = roundToTick(price * (1 + span));
  const stop = roundToTick(price * (1 - span*1.2));
  let risk = 3;
  if(prem>3) risk=5; else if(prem>1.5) risk=4; else if(prem>0.5) risk=3; else if(prem>-0.5) risk=2; else risk=1;

  let verdict = 'ì¤‘ë¦½, ê´€ë§ êµ¬ê°„';
  if(risk>=5) verdict='ë§¤ë„ ì£¼ì˜, ì„¸ë ¥ êµ¬ê°„';
  else if(risk===4) verdict='ë‹¨ê¸° ê³¼ì—´, ë§¤ë„ ìœ ë¦¬';
  else if(risk===3) verdict='ì¤‘ë¦½, ê´€ë§ êµ¬ê°„';
  else if(risk===2) verdict='ì•ˆì •ì , ë¶„í•  ë§¤ìˆ˜ ê°€ëŠ¥';
  else verdict='ì €ìœ„í—˜, ë¶„í• ë§¤ìˆ˜ êµ¬ê°„';

  return { buy, sell, stop, risk, verdict };
}

function renderRiskBadge(level){
  const cls='risk r'+Math.max(1,Math.min(5,level));
  return `<span class="${cls}">${level}</span>`;
}

/** =========================
 *  6) ë Œë”ë§
 *  ========================= */
function renderPremiumView(p){
  const set=(id,html)=>document.getElementById(id).innerHTML=html;
  document.getElementById('pf-sym').textContent = p?.symbol ? `(${p.symbol})` : '';
  set('pf-krw', fmt.krw(p?.upbitPrice));
  set('pf-usd', fmt.usd(p?.globalUsd));
  set('pf-usdkrw', fmt.num(p?.usdkrw));
  set('pf-pct', isFinite(p?.premiumPct) ? (p.premiumPct>=0?`<b class="ok">${fmt.pct(p.premiumPct)}</b>`:`<b class="bad">${fmt.pct(p.premiumPct)}</b>`) : '-');
  document.getElementById('pf-src').textContent = 'ì†ŒìŠ¤: '+(p?.src||'-');
}

function renderOnchain(v){
  document.getElementById('tvl-val').textContent = v?.tvl ? (v.tvl.toLocaleString('en-US')+' USD') : '-';
  document.getElementById('tvl-src').textContent = v?.src || '-';
  document.getElementById('tvl-hint').textContent = v?.ok ? `ì—…ë°ì´íŠ¸: ${new Date(v.updatedAt||Date.now()).toLocaleString('ko-KR')}` : (v?.error?'ì˜¤ë¥˜: '+v.error:'-');
}

function renderTable(symbols, premiumMap){
  const tbody = document.getElementById('sigBody');
  const rows = [];
  symbols.forEach(sym=>{
    const price = state.prices.get(sym);
    const prem = premiumMap.get(sym)?.premiumPct;
    const sig = (isFinite(price)) ? calcSignal(sym, price, prem) : null;
    const tr = `
      <tr class="blink">
        <td>${sym}</td>
        <td>${fmt.krw(price)}</td>
        <td>${fmt.krw(sig?.buy)}</td>
        <td>${fmt.krw(sig?.sell)}</td>
        <td class="bad">${fmt.krw(sig?.stop)}</td>
        <td>${renderRiskBadge(sig?.risk||3)}</td>
        <td class="muted">${sig?.verdict||'-'}</td>
      </tr>`;
    rows.push(tr);
  });
  tbody.innerHTML = rows.join('');
}

function setComment(text){
  state.lastComment = text;
  document.getElementById('comment').textContent = text;
  document.getElementById('comment-updated').textContent = 'ì—…ë°ì´íŠ¸: '+fmt.ts();
}

/** =========================
 *  7) ê´€ì‹¬ì½”ì¸ / ê²€ìƒ‰
 *  ========================= */
function renderWatchlist(){
  const el = document.getElementById('watchlist');
  const chips = [...state.interest].slice(0,10).map(sym=>`<span class="pill">${sym}<button data-rm="${sym}" class="small btn" style="margin-left:8px;border-radius:8px;padding:2px 8px">ì œê±°</button></span>`);
  el.innerHTML = chips.join('');
  el.querySelectorAll('button[data-rm]').forEach(b=>{
    b.onclick = ()=>{ state.interest.delete(b.dataset.rm); renderWatchlist(); };
  });
}

async function searchAndShow(q){
  // symbol ë§¤í•‘
  q = (q||'').trim();
  if(!q) return;
  let sym = q.toUpperCase().replace(/[^A-Z0-9]/g,'');
  // í•œêµ­ì–´/ì˜ë¬¸ëª… ë§¤í•‘ ë³´ì¡°
  const nameMap = {
    'ë¹„íŠ¸','ë¹„íŠ¸ì½”ì¸':'BTC',
    'ì´ë”','ì´ë”ë¦¬ì›€':'ETH',
    'ë„ì§€':'DOGE', 'ì†”ë¼ë‚˜':'SOL', 'ë¦¬í”Œ':'XRP', 'ì‹œë°”':'SHIB',
    'í´ë˜ì‹':'ETC','ë¼ì´íŠ¸ì½”ì¸':'LTC','ë¹„ìº':'BCH','í´ë¦¬ê³¤':'MATIC'
  };
  if(state.symbolMap.has(sym)===false){
    // ì´ë¦„ì— ë§¤ì¹­
    for(const [k,v] of Object.entries(nameMap)){
      if(q.includes(k)){ sym=v; break; }
    }
  }
  if(!state.symbolMap.get(sym)) {
    document.getElementById('searchResult').innerHTML = `<div class="muted">ê²€ìƒ‰ ì‹¤íŒ¨: ì§€ì›í•˜ì§€ ì•ŠëŠ” ì½”ì¸ì…ë‹ˆë‹¤.</div>`;
    return;
  }
  // ê´€ì‹¬ì½”ì¸ ìë™ ì¶”ê°€(ìµœëŒ€ 10)
  if(state.interest.size<10) { state.interest.add(sym); renderWatchlist(); }

  // ì‹¤ì‹œê°„ ê°’ ì±„ìš°ê¸° + ê¹€í”„ ê³„ì‚°
  await pollPrices([sym]);
  const price = state.prices.get(sym);
  let prem;
  try{ prem = await fetchPremium(sym); }catch{ prem=null; }

  const sig = isFinite(price) ? calcSignal(sym, price, prem?.premiumPct) : null;
  const html = `
    <div class="card" style="margin-top:12px">
      <div class="grid" style="grid-template-columns:repeat(6,1fr)">
        <div class="muted">ì‹¬ë³¼</div><div>${sym}</div>
        <div class="muted">í˜„ì¬ê°€</div><div>${fmt.krw(price)}</div>
        <div class="muted">í”„ë¦¬ë¯¸ì—„</div><div>${prem?fmt.pct(prem.premiumPct):'-'}</div>
        <div class="muted">ë§¤ìˆ˜</div><div class="ok">${fmt.krw(sig?.buy)}</div>
        <div class="muted">ë§¤ë„</div><div class="warn">${fmt.krw(sig?.sell)}</div>
        <div class="muted">ì†ì ˆ</div><div class="bad">${fmt.krw(sig?.stop)}</div>
      </div>
    </div>`;
  document.getElementById('searchResult').innerHTML = html;

  // ì½”ë©˜íŠ¸ ê°±ì‹ 
  if(sig){
    setComment(`[${sym}] í˜„ì¬ê°€ ${fmt.krw(price)} Â· í”„ë¦¬ë¯¸ì—„ ${prem?fmt.pct(prem.premiumPct):'-'} Â· ê²°ë¡ : ${sig.verdict}`);
  }
}

/** =========================
 *  8) ë©”ì¸ ë£¨í”„
 *  ========================= */
async function main(){
  await loadMarkets();
  renderWatchlist();

  // ì´ˆê¸° í”„ë¦¬ë¯¸ì—„(BTC) & ì˜¨ì²´ì¸(ETH)
  try{
    const [p,t] = await Promise.all([fetchPremium('BTC'), fetchOnchainETH()]);
    renderPremiumView(p.ok?p:null);
    renderOnchain(t);
  }catch(e){/* noop */}

  // ê´€ì‹¬ì½”ì¸ ë£¨í”„
  async function tick(){
    const symbols = [...state.interest].slice(0,10);
    await pollPrices(symbols);

    // ê° ì‹¬ë³¼ í”„ë¦¬ë¯¸ì—„ì€ ë¹„ì‹¼ í˜¸ì¶œì´ë¯€ë¡œ ìƒë‹¨ 3ê°œë§Œ ì¦‰ì‹œ, ë‚˜ë¨¸ì§€ëŠ” ê°„í— í˜¸ì¶œ
    const premMap = new Map();
    const head = symbols.slice(0,3);
    await Promise.all(head.map(async s=>{
      try{ premMap.set(s, await fetchPremium(s)); }catch{}
    }));

    // ë Œë”
    renderTable(symbols, premMap);
  }
  tick();
  setInterval(tick, POLL_SEC*1000);

  // ê²€ìƒ‰ ë°”ì¸ë”©
  document.getElementById('btnSearch').onclick = ()=>{
    const v = document.getElementById('q').value;
    searchAndShow(v);
  };
  document.getElementById('q').addEventListener('keydown',e=>{
    if(e.key==='Enter') document.getElementById('btnSearch').click();
  });
  document.getElementById('btnClear').onclick = ()=>{
    document.getElementById('q').value='';
    document.getElementById('searchResult').innerHTML='';
  };
}

main();
</script>
</body>
</html>
