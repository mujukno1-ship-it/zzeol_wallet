<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v11 â€” ì˜¨ì²´ì¸ ì—°ë™ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  ë³´ì •</title>
<style>
  :root{--bg:#0b0f14;--panel:#111823;--muted:#8fa4c7;--text:#e8eefc;--up:#22c55e;--down:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 "Noto Sans KR",system-ui}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border:1px solid #1b2738;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  h2{margin:0 0 8px} .status{font-size:12px;color:#9bb0d1}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border:1px solid #2a3b57;background:#0f1b2e;color:#dbe7ff;border-radius:10px;padding:10px 12px}
  button{cursor:pointer} button[disabled]{opacity:.55}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
  thead th{font-size:12px;color:#8fa4c7;text-align:left;padding:0 10px}
  tbody tr{background:#0e1520;border:1px solid #1d2a40} tbody td{padding:10px;vertical-align:middle}
  .price{font-variant-numeric:tabular-nums} .up{color:var(--up)} .down{color:var(--down)}
  .tag{font-size:11px;padding:3px 6px;border:1px solid #2a3956;border-radius:6px;background:#111a27;color:#9fb6db}
  .act{padding:4px 8px;border-radius:999px;border:1px solid #2a3956}
  .act.buy{color:#9ff4b1;border-color:#2b5b3a}.act.sell{color:#ffb4b4;border-color:#6b2b2b}.act.hold{color:#c9d4eb}
  .pin{cursor:pointer;font-size:16px;line-height:1} .pinned{color:#ffd54a}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .box{min-width:130px;background:#0e1420;border:1px solid #1d2940;border-radius:10px;padding:8px 10px}
  .k{font-size:12px;color:#9fb2d8}.v{font-size:16px}
  .good{color:#9ff4b1}.bad{color:#ffb4b4}.warn{color:#ffe08a}
</style>
</head>
<body>
<div class="wrap">

  <!-- ğŸ” ê²€ìƒ‰ -->
  <div class="card">
    <h2>ğŸ” ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©)</h2>
    <div class="row">
      <input id="q" placeholder="ì˜ˆ: ì´ë”ë¦¬ì›€/ETH, ì´ë”ë¦¬ì›€í´ë˜ì‹/ETC, ì—ì´ë‹¤/ADA, ì‹œë°”/SHIB">
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnTop">ìƒìŠ¹TOP10</button>
      <button id="btnHot">ê¸‰ë“±</button>
      <button id="btnFall">ê¸‰ë½</button>
      <button id="btnReset">ì´ˆê¸°í™”</button>
    </div>
    <div class="status" id="status">ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ì¤‘â€¦</div>
    <table>
      <thead><tr>
        <th style="width:6%">â˜…</th>
        <th style="width:22%">ì½”ì¸</th><th style="width:14%">í˜„ì¬ê°€</th><th style="width:12%">ë“±ë½</th>
        <th style="width:14%">ë§¤ìˆ˜</th><th style="width:14%">ë§¤ë„</th><th style="width:14%">ì†ì ˆ</th><th>AI ìœ„í—˜/í•œë§ˆë””</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- â‚¿ BTC ì˜¨ì²´ì¸ ìƒíƒœ (AI íƒ€ì  ë³´ì •ì— ì‚¬ìš©) -->
  <div class="card">
    <h2>â‚¿ BTC ì˜¨ì²´ì¸ ìƒíƒœ</h2>
    <div class="kpi" id="btcKpi">
      <div class="box"><div class="k">MVRV Z-Score</div><div class="v" id="k_mvrv">-</div></div>
      <div class="box"><div class="k">ê±°ë˜ì†Œ ìˆœìœ ì…(+) / ìˆœìœ ì¶œ(-)</div><div class="v" id="k_netflow">-</div></div>
      <div class="box"><div class="k">í€ë”©ë¹„</div><div class="v" id="k_funding">-</div></div>
      <div class="box"><div class="k">ìŠ¤í…Œì´ë¸” ìœ ì…</div><div class="v" id="k_stable">-</div></div>
      <div class="box"><div class="k">OI(ì„ ë¬¼ì”ê³ )</div><div class="v" id="k_oi">-</div></div>
    </div>
    <div class="status" id="btcSrc">ì—°ë™ ì†ŒìŠ¤: -</div>
  </div>

  <!-- ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ -->
  <div class="card">
    <h2>ğŸ”¥ ì˜ˆì—´ ìë™ì˜ˆì¸¡ (ìƒì‹œ ìœ ì§€ + ì‹ ê·œ ìƒë‹¨ ë°˜ì˜)</h2>
    <table>
      <thead><tr>
        <th style="width:6%">â˜…</th>
        <th style="width:14%">ì½”ì¸</th>
        <th style="width:12%">í˜„ì¬ê°€</th>
        <th style="width:10%">ë“±ë½</th>
        <th style="width:12%">ë§¤ìˆ˜</th>
        <th style="width:12%">ë§¤ë„</th>
        <th style="width:12%">ì†ì ˆ</th>
        <th style="width:10%">ìœ„í—˜ë„</th>
        <th>ì©”ì–´ í•œë§ˆë””</th>
      </tr></thead>
      <tbody id="preheatBody"><tr><td colspan="9" class="status">ì˜ˆì—´ ìŠ¤ìº” ì¤‘â€¦</td></tr></tbody>
    </table>
  </div>

  <!-- ğŸ§­ ì‚¬ëŒí˜• AI í‘œ -->
  <div class="card">
    <h2>ğŸ§­ ì‚¬ëŒí˜• AI â€” ì˜¨ì²´ì¸ ë³´ì • íƒ€ì </h2>
    <div class="status">BTC ì˜¨ì²´ì¸(ì €í‰ê°€/ìê¸ˆìœ ì…/ê³¼ì—´) ìƒíƒœë¥¼ ë°˜ì˜í•´ â€œë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/í•œë§ˆë””/ìœ„í—˜ë„â€ë¥¼ ë³´ì •í•©ë‹ˆë‹¤.</div>
    <table>
      <thead><tr>
        <th style="width:6%">â˜…</th>
        <th style="width:14%">ì½”ì¸</th>
        <th style="width:12%">í˜„ì¬ê°€</th>
        <th style="width:10%">ë“±ë½</th>
        <th style="width:12%">ë§¤ìˆ˜</th>
        <th style="width:12%">ë§¤ë„</th>
        <th style="width:12%">ì†ì ˆ</th>
        <th style="width:10%">ìœ„í—˜ë„</th>
        <th>ì©”ì–´ í•œë§ˆë””</th>
      </tr></thead>
      <tbody id="aiBody"><tr><td colspan="9" class="status">ë¶„ì„ ëŒ€ê¸°â€¦</td></tr></tbody>
    </table>
  </div>

  <!-- âš™ï¸ ìƒíƒœ -->
  <div class="card">
    <h2>âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div class="status" id="net">ì´ˆê¸°í™” ì¤‘â€¦</div>
  </div>

  <!-- â˜… ê³ ì • ì½”ì¸ (ë§¨ ì•„ë˜) -->
  <div class="card">
    <h2>â˜… ê³ ì • ì½”ì¸ (ì ‘ì† ì‹œ í•­ìƒ ìœ ì§€)</h2>
    <table>
      <thead><tr>
        <th style="width:6%">â˜…</th>
        <th style="width:14%">ì½”ì¸</th>
        <th style="width:12%">í˜„ì¬ê°€</th>
        <th style="width:10%">ë“±ë½</th>
        <th style="width:12%">ë§¤ìˆ˜</th>
        <th style="width:12%">ë§¤ë„</th>
        <th style="width:12%">ì†ì ˆ</th>
        <th style="width:10%">ìœ„í—˜ë„</th>
        <th>ì©”ì–´ í•œë§ˆë””</th>
      </tr></thead>
      <tbody id="pinnedBody"><tr><td colspan="9" class="status">ê³ ì •ì½”ì¸ ì—†ìŒ â€” í‘œì—ì„œ â˜…ì„ ëˆŒëŸ¬ ê³ ì •í•˜ì„¸ìš”.</td></tr></tbody>
    </table>
  </div>

</div>

<script>
/* ===== ìƒìˆ˜/ìƒíƒœ ===== */
const API={
  REST_MARKETS:'https://api.upbit.com/v1/market/all?isDetails=true',
  REST_TICKER:(codes)=>`https://api.upbit.com/v1/ticker?markets=${codes.join(',')}`,
  LOCAL:(url)=>`/api/upbit?url=${encodeURIComponent(url)}`,
  ONCHAIN:'/api/onchain?all=1'
};
const LS_PINNED='ZWL_PINNED_V1', LS_PREHEAT='ZWL_PREHEAT_V6', LS_ONCHAIN='ZWL_ONCHAIN_V1';
const DEFAULT_SEED=['KRW-BTC','KRW-ETH','KRW-ADA','KRW-SOL','KRW-XRP','KRW-SHIB'];
const TH={preNearHighPct:0.005, preMinMove:0.002, preMaxMove:0.020, preAccel:1.6, baselineMin:600};

const el={tbody:byId('tbody'),preheatBody:byId('preheatBody'),aiBody:byId('aiBody'),pinnedBody:byId('pinnedBody'),
          status:byId('status'),net:byId('net'),q:byId('q'),
          kmvrv:byId('k_mvrv'), knetflow:byId('k_netflow'), kfund:byId('k_funding'), kstable:byId('k_stable'), koi:byId('k_oi'), src:byId('btcSrc')};

const st={markets:[],tickers:new Map(),hist:new Map(),pinned:new Set(),rx:0,last:0, btc:{}};

function byId(id){return document.getElementById(id)}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function tick(p){if(p>=2e6)return 1e3;if(p>=1e6)return 500;if(p>=5e5)return 100;if(p>=1e5)return 50;if(p>=1e4)return 10;if(p>=1e3)return 5;if(p>=100)return 1;if(p>=10)return .1;if(p>=1)return .01;return .001;}
function fKRW(p){if(typeof p!=='number'||!isFinite(p)) return '-'; const t=tick(p);const d=t>=1?0:t===.1?1:t===.01?2:3;return Number(p||0).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d})}
function pct(v){return (Number(v||0)*100).toFixed(2)+'%'}
async function fetchUpbit(url){try{const r=await fetch(url,{cache:'no-store'});if(r.ok)return await r.json()}catch{} const r=await fetch(API.LOCAL(url));return await r.json()}
function levels(p){ const k=tick(p); return {buy:p-2*k, sell:p+3*k, cut:p-6*k}; }

/* ===== ë¡œì»¬ ===== */
function loadPinned(){ try{ st.pinned=new Set(JSON.parse(localStorage.getItem(LS_PINNED)||'[]')); }catch{ st.pinned=new Set(); } }
function savePinned(){ localStorage.setItem(LS_PINNED, JSON.stringify([...st.pinned])); }
function loadPreheat(){ try{ const a=JSON.parse(localStorage.getItem(LS_PREHEAT)||'[]'); return Array.isArray(a)?a:[]; }catch{return []} }
function savePreheat(arr){ localStorage.setItem(LS_PREHEAT, JSON.stringify(arr)); }
function loadOnchain(){ try{ return JSON.parse(localStorage.getItem(LS_ONCHAIN)||'{}'); }catch{return {}} }
function saveOnchain(o){ localStorage.setItem(LS_ONCHAIN, JSON.stringify(o)); }

/* ===== 1ë¶„ í†µê³„ ===== */
function oneMin(m){ const arr=st.hist.get(m)||[]; if(arr.length<2) return null; const now=Date.now(), pastTs=now-60*1000;
  let past=arr[0]; for(let i=arr.length-1;i>=0;i--){ if(arr[i].ts<=pastTs){ past=arr[i]; break; } }
  const cur=arr[arr.length-1], old=arr.find(x=>x.ts>=now-600*1000)||arr[0];
  const base=(Math.max(0,cur.acc-old.acc))/Math.max(1,(cur.ts-old.ts)/60000);
  const pct=(past.price>0?(cur.price-past.price)/past.price:0);
  const accel=base>0?(Math.max(0,cur.acc-past.acc)/base):0;
  const near=(cur.high>0)?Math.max(0,(cur.high-cur.price)/cur.high):1;
  return {pct,accel,near,price:cur.price,high:cur.high};
}

/* ===== ì˜¨ì²´ì¸ ë³´ì • ===== */
function applyOnchainAdjust(stat, btc, lv, chg){
  // stat: {pct, accel, near}, btc: {mvrv, exchangeNetflow, stablecoinNetflow, fundingRate}
  let msg = 'ê´€ë§';
  let act = 'hold';
  let risk = Math.max(0.9, Math.min(2.2, 1.1 + (1-Math.min(1,stat.near))*0.4 + Math.min(3,stat.accel)/3*0.3 + Math.max(0,stat.pct)/0.02*0.2 ));

  if (!btc) btc = {};

  const bullish =
    (btc.mvrv!==null && btc.mvrv < 1.5) &&
    (btc.exchangeNetflow!==null && btc.exchangeNetflow < 0) &&
    (btc.stablecoinNetflow!==null && btc.stablecoinNetflow > 0);

  const bearish =
    (btc.mvrv!==null && btc.mvrv > 3.0) ||
    (btc.fundingRate!==null && btc.fundingRate > 0.04);

  if (bullish) { act = 'buy'; msg = 'BTC ì˜¨ì²´ì¸ ì €í‰ê°€+ìê¸ˆìœ ì… â€” ì§„ì… ìš°ìœ„'; risk = Math.max(0.8, risk - 0.2); }
  if (bearish) { act = 'sell'; msg = 'BTC ê³¼ì—´/í€ë”© ê³¼ë„ â€” ìµì ˆ/ê°ì¶•'; risk = Math.min(2.2, risk + 0.3); }

  // ë‹¨ê¸° ê°€ê²©ì´ ê³¼ì—´ì´ë©´ ì¶”ê²© ê¸ˆì§€
  if (stat.pct > 0.02 && act==='buy') { act='hold'; msg='ë‹¨ê¸° ê³¼ì—´ â€” ëˆŒë¦¼ ëŒ€ê¸°'; }

  // ë ˆë²¨ ë³´ì • (ë§¤ìˆ˜ëŠ” ì•½ê°„ ë³´ìˆ˜, ë§¤ë„ëŠ” ì•½ê°„ ì•ë‹¹ê¹€)
  if (act==='buy') { const k = (lv ? (lv.sell - lv.buy) : 0);
    if (lv) lv.buy = lv.buy - (k*0.15); // ë” ì•ˆì „í•˜ê²Œ
  }
  if (act==='sell') {
    if (lv) lv.sell = lv.sell - (tick(lv.sell)*1.5); // ìµì ˆì„ ì•½ê°„ ë¹¨ë¦¬
  }

  return { act, msg, risk };
}

/* ===== ë Œë” ê³µí†µ ===== */
function rowHTML(market, name, t, stat, btc){
  if (!t || typeof t.trade_price!=='number') return '';
  const price=t.trade_price, chg=t.signed_change_rate||0, lv=levels(price);
  const adj = applyOnchainAdjust(stat||{pct:0,accel:1,near:0.5}, btc, lv, chg);
  const cls=chg>=0?'up':'down'; const pinned=st.pinned.has(market);
  return `
    <td><span class="pin ${pinned?'pinned':''}" data-m="${market}">${pinned?'â˜…':'â˜†'}</span></td>
    <td><span class="tag">${market.replace('KRW-','')}</span> ${name||''}</td>
    <td class="price ${cls}">${fKRW(price)}</td>
    <td class="${cls}">${pct(chg)}</td>
    <td class="price">${fKRW(lv.buy)}</td>
    <td class="price">${fKRW(lv.sell)}</td>
    <td class="price">${fKRW(lv.cut)}</td>
    <td>${adj.risk.toFixed(2)}</td>
    <td><span class="act ${adj.act}">${adj.act==='buy'?'ë§¤ìˆ˜':adj.act==='sell'?'ë§¤ë„':'ê´€ë§'}</span> Â· ${adj.msg}</td>`;
<!-- ğŸ”» ê²€ìƒ‰ ìš”ì•½ ë¸”ë¡ ì˜ˆì‹œ -->
<div class="search-summary" style="margin:10px 0;">
  <span>ì½”ì¸: <b id="search-symbol">-</b></span>
  <span>í˜„ì¬ê°€: <b id="search-price">-</b></span>
  <span>ë“±ë½: <b id="search-change">-</b></span>
  <span>ë§¤ìˆ˜í˜¸ê°€(Bid): <b id="search-bid">-</b></span>
  <span>ë§¤ë„í˜¸ê°€(Ask): <b id="search-ask">-</b></span>
  <span>ë§¤ìˆ˜ íƒ€ì : <b id="search-buy">-</b></span>
  <span>ë§¤ë„ íƒ€ì : <b id="search-sell">-</b></span>
  <span>ì†ì ˆ: <b id="search-stop">-</b></span>
</div>

}
function wirePins(tb){ tb.querySelectorAll('.pin').forEach(x=>x.onclick=()=>{const m=x.dataset.m; if(st.pinned.has(m)) st.pinned.delete(m); else st.pinned.add(m); savePinned(); renderPinned();}); }

/* ===== ì˜ˆì—´ ìŠ¤ìº”/ë Œë” ===== */
function mergeAndSortPreheat(newList){
  const mp=new Map(loadPreheat().map(x=>[x.market,x])); newList.forEach(n=>mp.set(n.market,n));
  const merged=[...mp.values()].sort((a,b)=>b.ts-a.ts).slice(0,48); savePreheat(merged); return merged;
}
const scanPreheat = debounce(function(){
  const found=[];
  for(const m of st.markets){
    const s=oneMin(m.market); if(!s) continue;
    if(s.near<=TH.preNearHighPct && s.pct>=TH.preMinMove && s.pct<=TH.preMaxMove && s.accel>=TH.preAccel){
      found.push({market:m.market, name:(st.markets.find(x=>x.market===m.market)?.korean_name)||m.market, ts:Date.now(), ...s});
    }
  }
  const list = found.length ? mergeAndSortPreheat(found) : loadPreheat();
  renderPreheat(list);
}, 250);

function renderPreheat(arr){
  const body=el.preheatBody; if(!arr||!arr.length){ body.innerHTML='<tr><td colspan="9" class="status">ì˜ˆì—´ í›„ë³´ ì—†ìŒ</td></tr>'; return; }
  body.innerHTML='';
  for(const it of arr){
    const t=st.tickers.get(it.market); if(!t) continue;
    const tr=document.createElement('tr'); tr.innerHTML=rowHTML(it.market, it.name, t, it, st.btc);
    body.appendChild(tr);
  }
  wirePins(body);
}

/* ===== ê³ ì •/ê²€ìƒ‰/AI ë Œë” ===== */
function renderPinned(){
  const body=el.pinnedBody; const codes=[...st.pinned];
  if(!codes.length){ body.innerHTML='<tr><td colspan="9" class="status">ê³ ì •ì½”ì¸ ì—†ìŒ â€” í‘œì—ì„œ â˜…ì„ ëˆŒëŸ¬ ê³ ì •í•˜ì„¸ìš”.</td></tr>'; return; }
  body.innerHTML='';
  for(const code of codes){
    const m=st.markets.find(x=>x.market===code)||{korean_name:code}; const t=st.tickers.get(code); if(!t) continue;
    const stat=oneMin(code)||{pct:0,accel:1,near:0.5};
    const tr=document.createElement('tr'); tr.innerHTML=rowHTML(code, m.korean_name, t, stat, st.btc);
    body.appendChild(tr);
  }
  wirePins(body);
}
function renderTable(list){
  const tb=el.tbody; tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="8" class="status">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>'; return; }
  for(const m of list){
    const t=st.tickers.get(m.market)||null; if(!t) continue;
    const stat=oneMin(m.market)||{pct:0,accel:1,near:0.5};
    const tr=document.createElement('tr'); tr.innerHTML=rowHTML(m.market, m.korean_name||m.english_name||'', t, stat, st.btc);
    tb.appendChild(tr);
  }
  wirePins(tb);
}
function initialTargets(){
  const pinned=[...st.pinned]; if(pinned.length) return pinned;
  const cached = loadPreheat().sort((a,b)=>b.ts-a.ts).map(x=>x.market); if(cached.length) return cached.slice(0,8);
  return DEFAULT_SEED;
}
function renderAI(useList){
  const body=el.aiBody; const targets=(Array.isArray(useList)&&useList.length?useList:initialTargets()).slice(0,12);
  if(!targets.length){ body.innerHTML='<tr><td colspan="9" class="status">ëŒ€ìƒ ì—†ìŒ</td></tr>'; return; }
  body.innerHTML=''; for(const mk of targets){
    const m=st.markets.find(x=>x.market===mk)||{korean_name:mk}; const t=st.tickers.get(mk); if(!t) continue;
    const stat=oneMin(mk)||{pct:0,accel:1,near:0.5}; const tr=document.createElement('tr'); tr.innerHTML=rowHTML(mk,m.korean_name,t,stat,st.btc); body.appendChild(tr);
  }
  wirePins(body);
}

/* ===== ê²€ìƒ‰ ì¸ë±ìŠ¤ ===== */
function norm(s){return (s||'').toString().toLowerCase().replace(/\s+/g,'')}
function buildSearchIndex(){ st.dict={}; const add=(k,m)=>{ if(!k) return; const key=norm(k); (st.dict[key]??=[]).push(m); };
  for(const m of st.markets){
    add(m.market,m); add(m.korean_name,m); add(m.english_name,m); add((m.korean_name||'').replace(/\s+/g,''),m);
    if(m.market==='KRW-ETH'){ ['ì´ë”ë¦¬ì›€','eth','ì´ë”'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-ETC'){ ['ì´ë”ë¦¬ì›€í´ë˜ì‹','ì´ë”ë¦¬ì›€ í´ë˜ì‹','í´ë˜ì‹','etc'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-ADA'){ ['ì—ì´ë‹¤','ada','ì¹´ë¥´ë‹¤ë…¸','cardano'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-SHIB'){ ['ì‹œë°”ì´ëˆ„','ì‹œë°”','shib','shiba'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-DOGE'){ ['ë„ì§€','ë„ì§€ì½”ì¸','doge','dogecoin'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-XRP'){ ['ë¦¬í”Œ','xrp'].forEach(a=>add(a,m)); }
    if(m.market==='KRW-SOL'){ ['ì†”ë¼ë‚˜','sol','solana'].forEach(a=>add(a,m)); }
  }
}
function searchAll(q){
  if(!q) return st.markets.slice(0,20);
  const key=norm(q); let list=(st.dict[key]??[]).slice(0);
  if(list.length<30){
    const extra=st.markets.filter(m=>{
      const n1=norm(m.korean_name), n2=(m.english_name||'').toLowerCase(), n3=m.market.toLowerCase();
      return n1.includes(key)||n2.includes(key)||n3.includes(key);
    });
    extra.forEach(m=>{ if(!list.find(x=>x.market===m.market)) list.push(m); });
  }
  if(/ì´ë”ë¦¬ì›€/.test(key)){ ['KRW-ETH','KRW-ETC'].forEach(code=>{ const m=st.markets.find(x=>x.market===code); if(m && !list.find(x=>x.market===m.market)) list.unshift(m); }); }
  return list.slice(0,30);
}

/* ===== ë°ì´í„° ë£¨í”„ ===== */
async function pollTickers(){
  const codes=st.markets.map(m=>m.market); const chunk=80; const now=Date.now();
  for(let i=0;i<codes.length;i+=chunk){
    try{
      const arr=await fetchUpbit(API.REST_TICKER(codes.slice(i,i+chunk)));
      for(const t of arr){
        const price=Number(t.trade_price), chg=Number(t.signed_change_rate);
        st.tickers.set(t.market,{market:t.market,trade_price:price, high_price:Number(t.high_price), signed_change_rate:isFinite(chg)?chg:0, acc_trade_price_24h:Number(t.acc_trade_price_24h||0), ts:now});
        const h=st.hist.get(t.market)||[]; h.push({ts:now,price:price,acc:Number(t.acc_trade_price_24h||0),high:Number(t.high_price||price)});
        const cut=now-TH.baselineMin*1000; while(h.length&&h[0].ts<cut)h.shift(); st.hist.set(t.market,h);
      }
    }catch{}
  }
  st.rx++; st.last=now; el.net.textContent=`ì—°ê²° OK Â· ìˆ˜ì‹  ${st.rx} Â· ë§ˆì§€ë§‰ ${new Date(st.last).toLocaleTimeString()}`;
}
async function pollOnchain(){
  try{
    const r=await fetch(API.ONCHAIN, {cache:'no-store'}); const js=await r.json(); st.btc=js||{}; saveOnchain(st.btc);
    // KPI ë Œë”
    el.kmvrv.textContent = (st.btc.mvrv??'-');
    el.knetflow.textContent = (st.btc.exchangeNetflow!=null ? (st.btc.exchangeNetflow>0?`+${st.btc.exchangeNetflow.toLocaleString()} BTC`:`${st.btc.exchangeNetflow.toLocaleString()} BTC`) : '-');
    el.kfund.textContent = (st.btc.fundingRate!=null? (st.btc.fundingRate*100).toFixed(3)+'%':'-');
    el.kstable.textContent = (st.btc.stablecoinNetflow!=null ? ('+'+Number(st.btc.stablecoinNetflow).toLocaleString()) : '-');
    el.koi.textContent = (st.btc.openInterest!=null ? Number(st.btc.openInterest).toLocaleString() : '-');
    el.src.textContent = `ì—°ë™ ì†ŒìŠ¤: ${Array.isArray(st.btc.source)?st.btc.source.join(', '):'fallback'}`;
  }catch{
    // ìºì‹œë¼ë„ í‘œì‹œ
    st.btc = loadOnchain();
  }
}

/* ===== ì´ë²¤íŠ¸ ===== */
function onSearch(){
  const key=el.q.value.trim(); const list=searchAll(key);
  renderTable(list); renderAI(list.slice(0,12).map(m=>m.market));
}
byId('btnSearch').onclick=onSearch;
el.q.onkeydown=(e)=>{ if(e.key==='Enter') onSearch(); };
byId('btnTop').onclick=()=>{ const arr=[...st.tickers.values()].filter(t=>typeof t.trade_price==='number').sort((a,b)=>(b.signed_change_rate||0)-(a.signed_change_rate||0)).slice(0,10).map(t=>st.markets.find(m=>m.market===t.market)); renderTable(arr); renderAI(arr.map(x=>x.market)); };
byId('btnHot').onclick=()=>{ const hot=st.markets.filter(m=>{const h=oneMin(m.market);return h && h.pct>=0.03 && h.accel>=1.8}); renderTable(hot.slice(0,20)); renderAI(hot.slice(0,12).map(x=>x.market)); };
byId('btnFall').onclick=()=>{ const fall=st.markets.filter(m=>{const h=oneMin(m.market);return h && h.pct<=-0.03 && h.accel>=1.8}); renderTable(fall.slice(0,20)); renderAI(fall.slice(0,12).map(x=>x.market)); };
byId('btnReset').onclick=()=>{ el.q.value=''; const base=st.markets.slice(0,20); renderTable(base); renderAI(); };

/* ===== ì‹œì‘ ===== */
(async function start(){
  // í•€/ì˜¨ì²´ì¸ ìºì‹œ ë¨¼ì €
  loadPinned();
  st.btc = loadOnchain();

  // ë§ˆì¼“ ë¡œë“œ
  try{
    const data=await fetchUpbit(API.REST_MARKETS);
    st.markets=data.filter(x=>x.market?.startsWith('KRW-'));
    el.status.textContent=`KRW ${st.markets.length}ì¢… ë¡œë“œ ì™„ë£Œ`;
  }catch{
    st.markets=DEFAULT_SEED.map(code=>({market:code,korean_name:code.replace('KRW-','')}));
    el.status.textContent='ì—…ë¹„íŠ¸ ì—°ê²° ì‹¤íŒ¨ â€” ê¸°ë³¸ ì‹œë“œë¡œ ê°€ë™';
  }
  buildSearchIndex();

  // ì´ˆê¸° ë Œë”
  renderPinned();
  renderPreheat(loadPreheat().sort((a,b)=>b.ts-a.ts));

  // ë°ì´í„° ë£¨í”„
  await pollTickers();
  await pollOnchain();
  renderTable(st.markets.slice(0,20));
  renderAI();                // ì˜¨ì²´ì¸ ë³´ì • ë°˜ì˜
  scanPreheat();             // ì˜ˆì—´ ìƒë‹¨ ë°˜ì˜
  setInterval(async()=>{ await pollTickers(); renderAI(); }, 2000);  // ì‹œì„¸ 2ì´ˆ
  setInterval(async()=>{ await pollOnchain(); renderAI(); }, 60000); // ì˜¨ì²´ì¸ 60ì´ˆ
})();
</script>
</body>
</html>
