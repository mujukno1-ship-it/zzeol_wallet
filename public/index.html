<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v13.2 â€” Full Precision Sniper Overdrive</title>
<link rel="icon" href="data:,">
<style>
  body{background:#0f1218;color:#e7eef8;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:0}
  .wrap{max-width:1200px;margin:auto;padding:16px}
  .search{position:sticky;top:0;background:#11161d;padding:10px;border-bottom:1px solid #1d2633;z-index:99}
  .badge{background:#1f2630;color:#9bc3ff;border-radius:8px;padding:4px 8px;font-size:12px;margin-right:6px}
  input{width:100%;padding:10px;border:1px solid #2a3340;border-radius:8px;background:#0f141c;color:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .card{background:#151a21;border:1px solid #202734;border-radius:12px;padding:12px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #1d2633}
  .bar{height:5px;background:#2a3340;border-radius:10px;overflow:hidden;margin-top:4px}
  .bar span{display:block;height:100%;background:#ffb020;width:0%}
  .up{color:#1ec996}.down{color:#ff5b6b}
  .note{margin-top:10px;padding:10px;border:1px dashed #2a3340;border-radius:10px;background:#10151c;color:#c8d3e2}
</style>
</head>
<body>
<div class="wrap">
  <div class="search">
    <span class="badge">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</span>
    <input id="q" placeholder="ì½”ì¸ëª…, ì‹¬ë³¼, ë§ˆì¼“ì½”ë“œ (ì˜ˆ: ì—ì´ë‹¤, ADA, KRW-ADA)"/>
  </div>

  <section class="card">
    <h3>ğŸ”¥ SPARK ì˜ˆì—´ TOP10</h3>
    <div id="sparkList"></div>
    <div id="sparkEmpty" style="color:#777;margin:12px 0;text-align:center;">ì˜ˆì—´ì½”ì¸ íƒìƒ‰ì¤‘...</div>
  </section>

  <section class="card">
    <h3>âš¡ ULTRA ì‹œê·¸ë„</h3>
    <div><b>í˜„ì¬ê°€:</b> <span id="v_price">-</span></div>
    <div><b>ë§¤ìˆ˜(BUY1):</b> <span id="v_buy1">-</span></div>
    <div><b>ìµì ˆ(TP1):</b> <span id="v_tp1">-</span></div>
    <div><b>ì†ì ˆ(SL):</b> <span id="v_sl">-</span></div>
    <div class="note" id="z_msg">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </section>

  <section class="card">
    <h3>ğŸ¯ AI ìŠ¤ë‚˜ì´í¼ ë°”ë‹¥Â·ì²œì¥</h3>
    <div>AI ì˜ˆìƒ ë°”ë‹¥: <span id="sn_low">-</span></div>
    <div>AI ì˜ˆìƒ ì²œì¥: <span id="sn_high">-</span></div>
    <div>ì‹ ë¢°ë„: <span id="sn_conf">-</span></div>
  </section>

  <section class="card">
    <h3>ğŸŒ ê¸€ë¡œë²Œ 4ëŒ€ ì§€í‘œ (ì›Œì»¤ â†’ Stooq â†’ Yahoo)</h3>
    <div id="globalPanel">
      <div class="item"><b>NASDAQ100</b><span id="g_ndx">-</span></div>
      <div class="item"><b>S&P500</b><span id="g_spx">-</span></div>
      <div class="item"><b>DXY</b><span id="g_dxy">-</span></div>
      <div class="item"><b>US10Y</b><span id="g_us10y">-</span></div>
    </div>
  </section>

  <footer class="note">ì‚¬í† ì‹œì˜ì§€ê°‘ v13.2 â€” ê¸°ì¡´ê¸°ëŠ¥ ìœ ì§€ + ê¸€ë¡œë²Œ ë°±ì—… + Precision Overdrive</footer>
</div>

<script>
const API_BASE="https://satoshi-proxy.mujukno1.workers.dev/api";
const $=s=>document.querySelector(s);
const fmt=n=>isNaN(n)?"-":Number(n).toLocaleString("ko-KR");
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

/* ---------------- ê³µí†µ API ---------------- */
async function jget(path,{retries=2,timeout=9000}={}) {
  let lastErr=null;
  for(let i=0;i<=retries;i++){
    const ctl=new AbortController();
    const to=setTimeout(()=>ctl.abort(),timeout);
    try{
      const url=`${API_BASE}${path}${path.includes('?')?'&':'?'}_ts=${Date.now()}`;
      const r=await fetch(url,{
        method:"GET",mode:"cors",cache:"no-store",
        headers:{
          "accept":"application/json",
          "cache-control":"no-cache, no-store, must-revalidate",
          "pragma":"no-cache","expires":"0"
        },
        signal:ctl.signal
      });
      clearTimeout(to);
      if(!r.ok) throw new Error(r.status);
      const d=await r.json();
      if(d.ok===false) throw new Error(d.error||"api");
      return d;
    }catch(e){clearTimeout(to);lastErr=e;await new Promise(r=>setTimeout(r,200+i*250));}
  }
  console.warn("API ì‹¤íŒ¨",path,lastErr);return null;
}

/* ---------------- SPARK ---------------- */
async function loadSpark(){
  const d=await jget("/spark/top?limit=10");
  const list=$("#sparkList");list.innerHTML="";
  if(!d?.list?.length){$("#sparkEmpty").style.display="block";return;}
  $("#sparkEmpty").style.display="none";
  d.list.forEach(it=>{
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`<div>${it.korean_name||it.market}
      <div class="bar"><span style="width:${clamp(it.spark,0,100)}%"></span></div></div>
      <div>${fmt(it.price)}ì›</div>`;
    row.onclick=()=>openUltra(it.market);
    list.append(row);
  });
}

/* ---------------- ULTRA ---------------- */
async function openUltra(m){
  const s=await jget("/ultra/signal?market="+encodeURIComponent(m));
  if(!s){alert("ì‹ í˜¸ ì—†ìŒ");return;}
  const p=Number(s.price||0);
  $("#v_price").textContent=fmt(p)+"ì›";
  $("#v_buy1").textContent=fmt(p*0.995)+"ì›";
  $("#v_tp1").textContent=fmt(p*1.02)+"ì›";
  $("#v_sl").textContent=fmt(p*0.985)+"ì›";
  $("#z_msg").textContent=`ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ì˜ˆì—´ê°•ë„ ${s.spark||80} / ìƒìŠ¹í™•ë¥  ${(s.prob_up||85)}%`;
  refreshSniper(m);
}

/* ---------------- SNIPER ---------------- */
async function refreshSniper(m){
  const d=await jget("/sniper/point?market="+encodeURIComponent(m));
  if(!d?.sniper)return;
  const s=d.sniper;
  $("#sn_low").textContent=fmt(s.ai_low)+"ì›";
  $("#sn_high").textContent=fmt(s.ai_high)+"ì›";
  $("#sn_conf").textContent=s.confidence? s.confidence+"%" : "-";
}

/* ---------------- ê¸€ë¡œë²Œì§€í‘œ ---------------- */
function paintGlobal(idBase,v){
  const num=$("#g_"+idBase);
  if(!num||!v)return;
  num.textContent=isFinite(v.close)?v.close.toLocaleString("en-US",{maximumFractionDigits:2}):"-";
}
async function loadGlobal(){
  let data=null;
  // 1) Worker
  try{
    const d=await fetch(`${API_BASE}/global?_ts=${Date.now()}`,{mode:"cors",cache:"no-store"})
      .then(r=>r.ok?r.json():null);
    if(d?.ok)data=d.data;
  }catch{}
  // 2) Stooq CSV
  if(!data){
    try{
      const text=await fetch("https://r.jina.ai/http://stooq.com/q/l/?s=%5Endx,%5Espx,dxy,us10y&f=sd2t2ohlcv&h&e=csv&_ts="+Date.now())
        .then(r=>r.text());
      const lines=text.trim().split(/\r?\n/).slice(1);
      data={};
      lines.forEach(l=>{
        const c=l.split(","),sym=c[0].toLowerCase(),close=parseFloat(c[6]);
        data[sym]={close};
      });
    }catch{}
  }
  // 3) Yahoo
  if(!data?.ndx){
    try{
      const y=await fetch("https://r.jina.ai/http://query1.finance.yahoo.com/v7/finance/quote?symbols=%5ENDX,%5EGSPC,DX-Y.NYB,%5ETNX&_ts="+Date.now())
        .then(r=>r.json());
      const q=y?.quoteResponse?.result||[];
      data={
        ndx:{close:q.find(x=>x.symbol=="^NDX")?.regularMarketPrice},
        spx:{close:q.find(x=>x.symbol=="^GSPC")?.regularMarketPrice},
        dxy:{close:q.find(x=>x.symbol=="DX-Y.NYB")?.regularMarketPrice},
        us10y:{close:q.find(x=>x.symbol=="^TNX")?.regularMarketPrice}
      };
    }catch{}
  }
  if(!data)return;
  paintGlobal("ndx",data.ndx);paintGlobal("spx",data.spx);
  paintGlobal("dxy",data.dxy);paintGlobal("us10y",data.us10y);
}

/* ---------------- ì‹¤í–‰ ---------------- */
(async()=>{
  await loadGlobal();
  await loadSpark();
})();
</script>
</body>
</html>
