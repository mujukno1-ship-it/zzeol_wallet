<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>KRW ì½”ì¸ ê²€ìƒ‰ Â· ë§¤ìˆ˜/ë§¤ë„ íƒ€ì </title>
  <style>
    body { background:#0d1117; color:#e6edf3; font-family:sans-serif; margin:20px; }
    input,button { padding:8px 10px; border-radius:6px; }
    input { border:1px solid #30363d; background:#161b22; color:#e6edf3; }
    button { border:1px solid #238636; background:#238636; color:white; cursor:pointer; }
    button:hover { background:#2ea043; }
    .result { margin-top:20px; padding:15px; background:#161b22; border:1px solid #30363d; border-radius:8px; }
    .error { color:#ff7b72; }
  </style>
</head>
<body>
  <h2>KRW ì½”ì¸ ê²€ìƒ‰ Â· ë§¤ìˆ˜/ë§¤ë„ íƒ€ì </h2>
  <input id="coinInput" placeholder="ì˜ˆ: BTC, ETH, ì‹œë°”ì´ëˆ„" />
  <button onclick="searchCoin()">ê²€ìƒ‰</button>
  <div id="status"></div>
  <div id="result" class="result" style="display:none"></div>

<script>
/* ============================
   ì´ˆë³´ììš© â€” API ìˆœì°¨ ì‹œë„ + ì—ëŸ¬ í‘œì‹œ
============================= */

// API í›„ë³´ ì£¼ì†Œ 3ê°œ (ìˆœì„œëŒ€ë¡œ ì‹œë„)
const API_LIST = [
  '/api/summary', // Cloudflare Pages í•¨ìˆ˜
  '/functions/api/summary', // ì˜ˆì „ ê²½ë¡œ
  'https://satoshi-proxy.mujukno1.workers.dev/summary' // ì›Œì»¤ (ì„ íƒ)
];

// ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
function setStatus(msg, color='#e6edf3') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = color;
}

// JSONì´ ì•„ë‹Œ HTMLì´ë©´ ì—ëŸ¬ë¼ê³  íŒë‹¨
function looksLikeHTML(text) {
  const t = text.trim().toLowerCase();
  return t.startsWith('<!doctype') || t.startsWith('<html');
}

// ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function getSummary(market) {
  let lastError = null;
  for (const base of API_LIST) {
    try {
      const url = `${base}?market=${encodeURIComponent(market)}`;
      setStatus(`ğŸ”„ ì‹œë„ ì¤‘: ${url}`);
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      if (looksLikeHTML(text)) throw new Error('HTML ì‘ë‹µ (404 í˜ì´ì§€)');
      const json = JSON.parse(text);
      if (json.ok) return json;
      throw new Error(json.error || 'API ì˜¤ë¥˜');
    } catch (err) {
      console.warn('ì‹¤íŒ¨:', err);
      lastError = err;
    }
  }
  throw lastError || new Error('ëª¨ë“  ê²½ë¡œ ì‹¤íŒ¨');
}

// ì—…ë¹„íŠ¸ ë§ˆì¼“ í˜•ì‹ ë³€í™˜ (ì˜ˆ: ETH â†’ KRW-ETH)
function toMarketName(t) {
  t = t.trim().toUpperCase();
  if (t.startsWith('KRW-')) return t;
  const map = { 'ë¹„íŠ¸ì½”ì¸':'KRW-BTC', 'ì´ë”ë¦¬ì›€':'KRW-ETH', 'ì‹œë°”ì´ëˆ„':'KRW-SHIB' };
  return map[t] || 'KRW-' + t;
}

// ë©”ì¸ í•¨ìˆ˜: ê²€ìƒ‰ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
async function searchCoin() {
  const coin = document.getElementById('coinInput').value.trim();
  if (!coin) { setStatus('â— ì½”ì¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', '#ff7b72'); return; }

  const market = toMarketName(coin);
  setStatus('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  document.getElementById('result').style.display = 'none';

  try {
    const data = await getSummary(market);
    showResult(data);
    setStatus('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ!');
  } catch (err) {
    console.error(err);
    setStatus('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message, '#ff7b72');
  }
}

// ê²°ê³¼ í‘œì‹œ
function showResult(d) {
  const box = document.getElementById('result');
  box.style.display = 'block';
  box.innerHTML = `
    <b>ì½”ì¸:</b> ${d.symbol}<br>
    <b>í˜„ì¬ê°€:</b> ${d.price?.toLocaleString() || '-'} ì›<br>
    <b>ë“±ë½:</b> ${d.change?.toFixed(2) || 0}%<br>
    <b>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„:</b> ${d.kimchi?.toFixed(2) || 0}%<br>
    <b>ë§¤ìˆ˜ íƒ€ì :</b> ${d.buy?.toLocaleString() || '-'} ì›<br>
    <b>ë§¤ë„ íƒ€ì :</b> ${d.sell?.toLocaleString() || '-'} ì›<br>
    <b>ì†ì ˆ ë¼ì¸:</b> ${d.stop?.toLocaleString() || '-'} ì›<br>
    <b>ìœ„í—˜ë„:</b> ${d.risk || '-'}<br>
    <b>ì©”ì–´ í•œë§ˆë””:</b> ${
      d.risk === 'danger' ? 'ğŸ”¥ ê³¼ì—´ ì£¼ì˜! ë³´ìˆ˜ì  ì ‘ê·¼' :
      d.risk === 'caution' ? 'âš ï¸ ë³€ë™ì„± êµ¬ê°„! ë¶„í• ë§¤ìˆ˜ ê¶Œì¥' :
      'âœ… ì•ˆì • êµ¬ê°„! ì¶”ì„¸ ìœ ì§€ ì¤‘'
    }
  `;
}
</script>
</body>
</html>
