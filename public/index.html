<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.3 ì•ˆì •íŒ</title>
<style>
  :root {
    --bg: #0d1116;
    --panel:#121820;
    --text:#e6f2ff;
    --muted:#89a0b5;
    --green:#22c55e;
    --red:#ef4444;
    --blue:#0ea5e9;
    --outline:#1f2937;
    --chip:#0b1220;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Apple SD Gothic Neo","Noto Sans KR",sans-serif}
  .wrap{max-width:1200px;margin:40px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:24px;letter-spacing:.5px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .searchbar{display:flex;gap:8px;align-items:center}
  .input{flex:1;min-width:280px;background:#0a0f16;border:1px solid var(--outline);color:var(--text);padding:12px 14px;border-radius:10px;outline:none}
  .btn{background:#1f2937;color:#cfe3ff;border:1px solid #243041;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1000px){.grid{grid-template-columns:1.2fr .8fr}}
  .panel{background:var(--panel);border:1px solid var(--outline);border-radius:14px;padding:16px}
  .title{display:flex;align-items:center;gap:8px;margin-bottom:12px}
  .chip{font-size:12px;background:var(--chip);padding:4px 8px;border-radius:999px;color:#aac4df;border:1px solid #182334}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #202938;text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  .muted{color:var(--muted)}
  .up{color:var(--green)} .down{color:var(--red)}
  .orderbook{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ob-table{border:1px solid #1a2230;border-radius:10px;overflow:hidden}
  .ob-table thead th{background:#101722}
  .ask{color:#ffa7a7} .bid{color:#88e5ff}
  .kval{font-weight:600}
  .rowstack{display:flex;flex-wrap:wrap;gap:10px}
  .kv{background:#0b1220;border:1px solid #172031;color:#cfe3ff;padding:8px 10px;border-radius:8px}
  .warn{margin-top:10px;color:#f59e0b}
  .list{margin-top:6px;border:1px solid #1b2432;border-radius:10px;overflow:hidden}
  .list .rowh{display:grid;grid-template-columns:28px 1fr 120px 96px 96px 96px 80px 120px;gap:10px;background:#101722;padding:10px;font-weight:600}
  .list .rowb{display:grid;grid-template-columns:28px 1fr 120px 96px 96px 96px 80px 120px;gap:10px;padding:10px;border-top:1px solid #172131}
  .results{position:relative}
  .dropdown{position:absolute;left:0;top:44px;z-index:30;width:100%;background:#0a0f16;border:1px solid #1c2635;border-radius:10px;overflow:hidden}
  .dropdown .item{padding:10px 12px;display:flex;gap:8px;align-items:center;cursor:pointer;border-top:1px solid #121a26}
  .dropdown .item:hover{background:#0f1622}
</style>
</head>
<body>
<div class="wrap">
  <h1>ì©”ì–´ì§€ê°‘ v7.3 ì•ˆì •íŒ ğŸ’ <span class="chip">ê²€ìƒ‰ê²°ê³¼ ì‹¤ì‹œê°„ í‘œì‹œ + ì—…ë¹„íŠ¸ í˜¸ê°€</span></h1>

  <!-- ê²€ìƒ‰ -->
  <div class="row results">
    <input id="q" class="input" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH / ethereum)" />
    <button id="btnSearch" class="btn">ê²€ìƒ‰</button>
    <button id="btnReset" class="btn">ì´ˆê¸°í™”</button>

    <div id="dropdown" class="dropdown" style="display:none"></div>
  </div>

  <!-- ì„ íƒ ì½”ì¸ + í˜¸ê°€ -->
  <div class="grid" style="margin-top:16px">
    <div class="panel">
      <div class="title">
        <strong id="selTitle">ì„ íƒëœ ì½”ì¸: ì—†ìŒ</strong>
        <span id="selMarket" class="chip"></span>
        <span id="selBase" class="chip"></span>
      </div>

      <div id="selWarn" class="warn" style="display:none"></div>

      <div class="rowstack" id="selKVs">
        <!-- í˜„ì¬ê°€/ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë”” -->
      </div>

      <div id="selInfo" class="muted" style="margin-top:10px">
        ê²€ìƒ‰ì°½ì— ì½”ì¸ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ ê²°ê³¼ì—ì„œ ì„ íƒí•˜ì„¸ìš”.
      </div>
    </div>

    <div class="panel">
      <div class="title"><strong>ì‹¤ì‹œê°„ í˜¸ê°€ (ì—…ë¹„íŠ¸ ë™ì¼)</strong><span class="chip">3ì´ˆ ê°±ì‹ </span></div>
      <div id="ob" class="orderbook">
        <table class="ob-table">
          <thead><tr><th colspan="3">ë§¤ë„í˜¸ê°€</th></tr></thead>
          <tbody id="asks"><tr><td class="muted">ì„ íƒëœ ì½”ì¸ ì—†ìŒ</td></tr></tbody>
        </table>
        <table class="ob-table">
          <thead><tr><th colspan="3">ë§¤ìˆ˜í˜¸ê°€</th></tr></thead>
          <tbody id="bids"><tr><td class="muted">ì„ íƒëœ ì½”ì¸ ì—†ìŒ</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ Top10 (í‹€ ìœ ì§€) -->
  <div class="panel" style="margin-top:16px">
    <div class="title"><strong>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</strong><span class="chip">ì¡°ê±´: ì‹¤ì‹œê°„ ë³€ë™ë¥ </span></div>
    <div class="list">
      <div class="rowh"><div>#</div><div>ì½”ì¸ëª…(í•œê¸€)</div><div>í˜„ì¬ê°€</div><div>ë³€ë™ë¥ </div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div></div>
      <div id="upList" class="rowb muted">ì‹¤ì‹œê°„ ë¡œë”© ì¤€ë¹„ì¤‘â€¦ (ê¸°ëŠ¥ ìœ ì§€ìš© í‹€)</div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px">
    <div class="title"><strong>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</strong><span class="chip">ì¡°ê±´: ì‹¤ì‹œê°„ ë³€ë™ë¥ </span></div>
    <div class="list">
      <div class="rowh"><div>#</div><div>ì½”ì¸ëª…(í•œê¸€)</div><div>í˜„ì¬ê°€</div><div>ë³€ë™ë¥ </div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div></div>
      <div id="dnList" class="rowb muted">ì‹¤ì‹œê°„ ë¡œë”© ì¤€ë¹„ì¤‘â€¦ (ê¸°ëŠ¥ ìœ ì§€ìš© í‹€)</div>
    </div>
  </div>
</div>

<script>
/* =============================== */
/*           ê³µí†µ ìœ í‹¸             */
/* =============================== */
const API = (p) => `/api/upbit?path=${encodeURIComponent(p)}`;
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const fmt = (n, f=0) => (n==null ? '-' : Number(n).toLocaleString(undefined, {maximumFractionDigits:f}));
const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

let MARKET_ALL = [];
let MARKET_IDX = new Map();  // ë¹ ë¥¸ ë§¤ì¹­ìš©

async function fetchJSON(url) {
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error(`${r.status}`);
  return r.json();
}

/* =============================== */
/*        ë§ˆì¼“ ëª©ë¡(1íšŒ ë¡œë”©)       */
/* =============================== */
async function loadMarkets() {
  MARKET_ALL = await fetchJSON(API('/v1/market/all?isDetails=true'));

  // ì¸ë±ìŠ¤: ì¹´/ì˜/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ
  MARKET_IDX.clear();
  for (const m of MARKET_ALL) {
    const keys = new Set([
      m.korean_name?.trim(),
      m.english_name?.trim(),
      m.market,                // KRW-ETH
      m.market?.split('-')[1], // ETH
      (m.market_event?.warning ? 'ê²½ê³ ' : ''), // ë¬´ì˜ë¯¸, ìŠ¬ë¡¯ í™•ë³´
    ].filter(Boolean));

    // ë™ì¼ í‚¤(í•œê¸€ê³¼ ì˜ë¬¸ ëŒ€/ì†Œë¬¸ì êµ¬ë¶„ X)
    for (const k of keys) {
      const key = k.toLowerCase();
      if (!MARKET_IDX.has(key)) MARKET_IDX.set(key, []);
      MARKET_IDX.get(key).push(m);
    }
  }
}

/* =============================== */
/*        ê²€ìƒ‰ â†’ ë§ˆì¼“ì½”ë“œ ë§¤ì¹­      */
/* =============================== */
function resolveMarket(query) {
  if (!query) return null;
  const q = query.trim().toLowerCase();

  // 1) ì™„ì „ ì¼ì¹˜(ë§ˆì¼“ì½”ë“œ KRW-XXX)
  const exact = MARKET_ALL.find(m => m.market.toLowerCase() === q);
  if (exact) return exact;

  // 2) ì¸ë±ìŠ¤ í‚¤ ì¼ì¹˜(í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼)
  let cand = MARKET_IDX.get(q) || [];

  // 3) ë¶€ë¶„ í¬í•¨(ëŠìŠ¨í•œ ë§¤ì¹­) â€” â€œì´ë”â€, â€œethâ€ ë“±
  if (!cand.length) {
    cand = MARKET_ALL.filter(m =>
      m.korean_name?.toLowerCase().includes(q) ||
      m.english_name?.toLowerCase().includes(q) ||
      m.market?.toLowerCase().includes(q) ||
      m.market?.split('-')[1]?.toLowerCase() === q
    );
  }

  if (!cand.length) return null;

  // âœ… KRW- ìš°ì„ , ê·¸ë‹¤ìŒ ì™„ì „ ì‹¬ë³¼(ETH), ê·¸ë‹¤ìŒ ì´ë¦„ í¬í•¨ ìˆœ
  cand.sort((a,b) => {
    const aKRW = a.market.startsWith('KRW-') ? 0 : 1;
    const bKRW = b.market.startsWith('KRW-') ? 0 : 1;
    if (aKRW !== bKRW) return aKRW - bKRW;

    const sym = q.toUpperCase();
    const aSym = a.market.split('-')[1] === sym ? 0 : 1;
    const bSym = b.market.split('-')[1] === sym ? 0 : 1;
    if (aSym !== bSym) return aSym - bSym;

    // ì´ë¦„ ê¸¸ì´ ê°€ê¹ê²Œ(â€œì´ë”ë¦¬ì›€â€ > â€œì´ë”ë¦¬ì›€í´ë˜ì‹â€)
    const aDist = Math.abs((a.korean_name||'').length - q.length);
    const bDist = Math.abs((b.korean_name||'').length - q.length);
    return aDist - bDist;
  });

  return cand[0];
}

/* =============================== */
/*     ì„ íƒ ì½”ì¸ íŒ¨ë„ + í˜¸ê°€       */
/* =============================== */
let CUR = { market:null, timer:null };

async function renderSelected(m) {
  if (!m) {
    $('#selTitle').textContent = 'ì„ íƒëœ ì½”ì¸: ì—†ìŒ';
    $('#selMarket').textContent = '';
    $('#selBase').textContent = '';
    $('#selInfo').textContent = 'ê²€ìƒ‰ì°½ì— ì½”ì¸ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ ê²°ê³¼ì—ì„œ ì„ íƒí•˜ì„¸ìš”.';
    $('#selWarn').style.display = 'none';
    $('#asks').innerHTML = `<tr><td class="muted">ì„ íƒëœ ì½”ì¸ ì—†ìŒ</td></tr>`;
    $('#bids').innerHTML = `<tr><td class="muted">ì„ íƒëœ ì½”ì¸ ì—†ìŒ</td></tr>`;
    return;
  }

  $('#selTitle').textContent = `${m.korean_name} (${m.english_name})`;
  $('#selMarket').textContent = m.market;
  $('#selBase').textContent = m.market.split('-')[0];

  // ê²½ê³  í‘œê¸°(ìˆìœ¼ë©´)
  if (m.market_event && m.market_event.warning) {
    $('#selWarn').style.display = 'block';
    $('#selWarn').textContent = 'âš ï¸ ì—…ë¹„íŠ¸ ê²½ê³ (ìœ ì˜) ì¢…ëª©ì…ë‹ˆë‹¤. ê±°ë˜ ì „ ìœ ì˜ ì‚¬í•­ í™•ì¸!';
  } else {
    $('#selWarn').style.display = 'none';
  }

  // í˜„ì¬ê°€(í‹°ì»¤)
  const ticker = await fetchJSON(API(`/v1/ticker?markets=${m.market}`));
  const t = ticker?.[0] || {};
  const price = t.trade_price;

  // ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë”” (ê°„ë‹¨ ë¡œì§ ìœ ì§€)
  const buy  = price ? price * 0.998 : null;  // ìŠ¤í”„ë ˆë“œ ê³ ë ¤í•œ ì§„ì…
  const sell = price ? price * 1.006 : null;  // ë‹¨ê¸° ìµì ˆ
  const stop = price ? price * 0.97  : null;  // 3% ì†ì ˆ
  const risk = t.signed_change_rate != null ? (Math.abs(t.signed_change_rate)*100).toFixed(2)+'%' : '-';
  const one  = t.signed_change_rate > 0 ? 'ìƒìŠ¹ì¤‘' : (t.signed_change_rate < 0 ? 'í•˜ë½ì¤‘' : 'ë³´í•©');

  $('#selKVs').innerHTML = [
    ['í˜„ì¬ê°€', price, 0],
    ['ë§¤ìˆ˜', buy, 0],
    ['ë§¤ë„', sell, 0],
    ['ì†ì ˆ', stop, 0],
    ['ìœ„í—˜ë„', risk, null],
    ['ì©”ì–´í•œë§ˆë””', one, null]
  ].map(([k,v,f]) => `
    <div class="kv"><span class="muted">${k}</span><br><span class="kval">${v==null?'-':fmt(v,f)}</span></div>
  `).join('');

  $('#selInfo').textContent = `ì—…ë°ì´íŠ¸: ${new Date(t.trade_timestamp||Date.now()).toLocaleTimeString()}`;

  // í˜¸ê°€ êµ¬ë…
  CUR.market = m.market;
  if (CUR.timer) clearInterval(CUR.timer);
  await renderOrderbook();
  CUR.timer = setInterval(renderOrderbook, 3000);
}

async function renderOrderbook() {
  if (!CUR.market) return;
  try {
    const data = await fetchJSON(API(`/v1/orderbook?markets=${CUR.market}`));
    const ob = data?.[0];
    if (!ob) throw new Error('no ob');

    const units = ob.orderbook_units || [];
    const asks = units.slice(0,10);      // ë§¤ë„
    const bids = units.slice(0,10);      // ë§¤ìˆ˜

    $('#asks').innerHTML = asks.map(u => `
      <tr>
        <td class="ask">${fmt(u.ask_price)}</td>
        <td class="muted">ì”ëŸ‰ ${fmt(u.ask_size, 4)}</td>
        <td class="muted">ì´í˜¸ê°€ ${fmt(u.ask_price*u.ask_size, 0)}</td>
      </tr>
    `).join('');

    $('#bids').innerHTML = bids.map(u => `
      <tr>
        <td class="bid">${fmt(u.bid_price)}</td>
        <td class="muted">ì”ëŸ‰ ${fmt(u.bid_size, 4)}</td>
        <td class="muted">ì´í˜¸ê°€ ${fmt(u.bid_price*u.bid_size, 0)}</td>
      </tr>
    `).join('');
  } catch (e) {
    $('#asks').innerHTML = `<tr><td class="muted">í˜¸ê°€ ë¡œë”© ì‹¤íŒ¨</td></tr>`;
    $('#bids').innerHTML = `<tr><td class="muted">í˜¸ê°€ ë¡œë”© ì‹¤íŒ¨</td></tr>`;
  }
}

/* =============================== */
/*        ê²€ìƒ‰ UI / ë“œë¡­ë‹¤ìš´       */
/* =============================== */
let DDOWN = [];
function renderDropdown(items) {
  const box = $('#dropdown');
  if (!items || !items.length) { box.style.display='none'; return; }
  box.innerHTML = items.slice(0,20).map(m => `
    <div class="item" data-market="${m.market}">
      <span class="chip">${m.market}</span>
      <span>${m.korean_name}</span>
      <span class="muted">(${m.english_name})</span>
    </div>
  `).join('');
  box.style.display = 'block';

  $$('#dropdown .item').forEach(el => {
    el.onclick = async () => {
      const code = el.getAttribute('data-market');
      const m = MARKET_ALL.find(x => x.market === code);
      box.style.display = 'none';
      $('#q').value = `${m.korean_name}`;
      await renderSelected(m);
    };
  });
}

function searchList(q) {
  if (!q) return [];
  const s = q.trim().toLowerCase();
  // KRW- ìš°ì„  ì •ë ¬
  let arr = MARKET_ALL.filter(m =>
    m.market.toLowerCase().includes(s) ||
    m.korean_name?.toLowerCase().includes(s) ||
    m.english_name?.toLowerCase().includes(s) ||
    m.market.split('-')[1]?.toLowerCase() === s
  );
  arr.sort((a,b) => (a.market.startsWith('KRW-')?0:1) - (b.market.startsWith('KRW-')?0:1));
  return arr;
}

/* =============================== */
/*             ë¶€íŠ¸ì—…               */
/* =============================== */
(async function init(){
  try {
    await loadMarkets();
  } catch (e) {
    alert('ë§ˆì¼“ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }

  // ì…ë ¥ ì¦‰ì‹œ ë“œë¡­ë‹¤ìš´
  let tmr=null;
  $('#q').addEventListener('input', (e) => {
    clearTimeout(tmr);
    const v = e.target.value;
    tmr = setTimeout(()=>{
      const items = searchList(v);
      renderDropdown(items);
    }, 120);
  });

  // ê²€ìƒ‰ ë²„íŠ¼
  $('#btnSearch').onclick = async () => {
    const q = $('#q').value;
    const m = resolveMarket(q);
    $('#dropdown').style.display='none';
    if (!m) { alert('ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }
    await renderSelected(m);
  };

  // ì´ˆê¸°í™”
  $('#btnReset').onclick = () => {
    $('#q').value = '';
    renderDropdown([]);
    renderSelected(null);
  };
})();
</script>
</body>
</html>
