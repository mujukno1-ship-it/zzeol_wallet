<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§„ê° âˆ ì „ì„¤íŒ 10.2 | ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</title>
<style>
  :root{
    --bg:#0d1116; --card:#131a22; --soft:#17202a; --text:#e6edf3; --dim:#94a3b8;
    --pri:#5b9cff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --mut:#334155;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Pretendard,Inter,system-ui,Apple SD Gothic Neo,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
  .row{display:grid;gap:16px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:12px;padding:16px}
  .title{display:flex;align-items:center;gap:10px;font-weight:700}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--mut);color:var(--dim)}
  .ok{color:#22c55e;border-color:#22c55e}
  .warn{color:#f59e0b;border-color:#f59e0b}
  .bad{color:#ef4444;border-color:#ef4444}
  .mut{color:var(--dim)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .hdr{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  input,button{height:40px;border-radius:10px;border:1px solid var(--mut);background:#0f1520;color:var(--text)}
  input{padding:0 12px;flex:1;min-width:220px}
  button{padding:0 14px;cursor:pointer}
  button.primary{background:var(--pri);border-color:transparent}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px dashed #243041}
  th{color:#aab4c3;text-align:left;font-weight:600;background:var(--soft)}
  tr:hover td{background:#0f1621}
  .tag{font-size:12px;padding:.2rem .5rem;border-radius:8px;border:1px solid var(--mut);display:inline-block}
  .tag.ok{border-color:#16a34a;color:#16a34a}
  .tag.bad{border-color:#ef4444;color:#ef4444}
  .tag.warn{border-color:#f59e0b;color:#f59e0b}
  .gridKVs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
  .kv{background:var(--soft);border:1px solid var(--mut);border-radius:10px;padding:10px}
  .kv .k{color:#93a6bf;font-size:12px}
  .kv .v{font-weight:700}
  .small{font-size:12px;color:#9fb0c6}
  .right{display:flex;gap:8px;align-items:center;margin-left:auto}
  .badge{font-size:11px;background:#0f1621;border:1px solid var(--mut);border-radius:999px;padding:2px 8px}
  footer{margin:28px 0 40px;color:#7e8ea1}
</style>
</head>
<body>
<div class="wrap">

  <div class="hdr">
    <div class="title">ğŸ’  ì©”ì–´ì§„ê° âˆ <span class="pill">ì „ì„¤íŒ 10.2</span></div>
    <span class="badge" id="apiStatus">API ì—°ê²°: í™•ì¸ì¤‘â€¦</span>
    <span class="badge" id="modeBadge">ì‹œì¥ëª¨ë“œ: -</span>
    <span class="badge">ì—…ë¹„íŠ¸ í˜¸ê°€Â·ê¹€í”„Â·ì˜¨ì²´ì¸Â·ì‹œê·¸ë„ ì—°ë™</span>
    <span class="right small">ì—…ë°ì´íŠ¸ <span id="updatedAt">-</span></span>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="card" id="searchCard">
    <div class="title">ğŸ” ê²€ìƒ‰</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="q" placeholder="ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, ì‹œë°”ì´ëˆ„â€¦ (í•œê¸€/ì˜ë¬¸ ì‹¬ë³¼ ëª¨ë‘ ê°€ëŠ¥)" />
      <button class="primary" id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnReset">ì´ˆê¸°í™”</button>
    </div>
    <div class="small" style="margin-top:8px">
      â€» ê²€ìƒ‰ ê²°ê³¼ì—ëŠ” <b>í˜„ì¬ê°€ / ë§¤ìˆ˜ / ë§¤ë„ / ì†ì ˆ / ìœ„í—˜ë„ / ì©”ì–´ê²°ë¡ </b>ì´ ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ì™€ ë™ì¼í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:14px">
      <table id="searchTable">
        <thead>
          <tr>
            <th style="width:160px">ì½”ì¸</th>
            <th>í˜„ì¬ê°€</th>
            <th>ë§¤ìˆ˜</th>
            <th>ë§¤ë„</th>
            <th>ì†ì ˆ</th>
            <th>ìœ„í—˜ë„</th>
            <th>ì©”ì–´ê²°ë¡ </th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7" class="small">ê²€ìƒ‰ í›„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ìƒë‹¨ ì¹´ë“œ 2ê°œ -->
  <div class="row g2">
    <div class="card">
      <div class="title">ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (BTC)</div>
      <div class="gridKVs">
        <div class="kv"><div class="k">ì—…ë¹„íŠ¸ KRW</div><div class="v mono" id="krw_btc">-</div></div>
        <div class="kv"><div class="k">ê¸€ë¡œë²Œ USD</div><div class="v mono" id="usd_btc">-</div></div>
        <div class="kv"><div class="k">USD/KRW</div><div class="v mono" id="usdkrw">-</div></div>
        <div class="kv"><div class="k">í”„ë¦¬ë¯¸ì—„(%)</div><div class="v mono" id="kimp">-</div></div>
      </div>
      <div class="small" style="margin-top:8px">ì†ŒìŠ¤: CoinGecko Â· open-erapi Â· Upbit</div>
    </div>

    <div class="card">
      <div class="title">ğŸ§  ì˜¨ì²´ì¸ TVL (ETH) <span class="pill" id="autoTVL">ìë™ ë¡¤ë°±</span></div>
      <div class="gridKVs">
        <div class="kv"><div class="k">TVL</div><div class="v mono" id="tvl">-</div></div>
        <div class="kv"><div class="k">ì†ŒìŠ¤</div><div class="v mono" id="tvl_src">-</div></div>
        <div class="kv"><div class="k">ì—…ë°ì´íŠ¸</div><div class="v mono" id="tvl_updated">-</div></div>
        <div class="kv"><div class="k">ìƒíƒœ</div><div class="v mono" id="tvl_status">-</div></div>
      </div>
    </div>
  </div>

  <!-- SPARK -->
  <div class="card" id="sparkCard">
    <div class="title">âš¡ SPARK (ê¸‰ë“± ê°ì§€ Â· ìƒë‹¨ ê³ ì • TOP 10) <span class="pill warn">í˜„ì¬ê°€Â·ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´ê²°ë¡  í¬í•¨</span></div>
    <div style="margin-top:12px">
      <table id="sparkTable">
        <thead>
          <tr>
            <th style="width:140px">ì½”ì¸</th>
            <th>í˜„ì¬ê°€</th>
            <th>60m</th>
            <th>ë§¤ìˆ˜</th>
            <th>ë§¤ë„</th>
            <th>ì†ì ˆ</th>
            <th>ìœ„í—˜ë„</th>
            <th>ì©”ì–´ê²°ë¡ </th>
          </tr>
        </thead>
        <tbody><tr><td colspan="8" class="small">SPARK ë¡œë”© ì¤‘â€¦</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ê´€ì‹¬ì½”ì¸ -->
  <div class="card">
    <div class="title">â­ ê´€ì‹¬ì½”ì¸ (ìµœëŒ€ 10ê°œ) <span class="pill">ê³ ì •í‘œì‹œ</span></div>
    <div class="small" style="margin:6px 0 10px">ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³ ì •/í•´ì œ. (ìƒˆë¡œê³ ì¹¨ ìœ ì§€)</div>
    <div id="favChips" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    <div style="margin-top:12px">
      <table id="favTable">
        <thead>
          <tr>
            <th style="width:140px">ì½”ì¸</th>
            <th>í˜„ì¬ê°€</th>
            <th>ë§¤ìˆ˜</th>
            <th>ë§¤ë„</th>
            <th>ì†ì ˆ</th>
            <th>ìœ„í—˜ë„</th>
            <th>ì©”ì–´ê²°ë¡ </th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7" class="small">ê´€ì‹¬ì½”ì¸ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸° ê³ ì • í‘œì‹œë©ë‹ˆë‹¤.</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ì½”ë©˜íŠ¸ -->
  <div class="card">
    <div class="title">ğŸ’¬ ì©”ì–´ í•œë§ˆë”” <span class="pill">ë² íƒ€</span></div>
    <div class="small" id="oneLiner">ìƒë‹¨ ì§€í–¥ êµ¬ê°„, ë¶„í•  ë§¤ë„ ìœ ë¦¬</div>
  </div>

  <footer class="small">Â© 2025 ì©”ì–´ì§„ê° âˆ | ì—…ë¹„íŠ¸Â·ì˜¨ì²´ì¸Â·ê¹€í”„ ì‹¤ì‹œê°„ ì—°ë™</footer>
</div>

<script>
/* =========================
   0) ì„¤ì •
========================= */
// ë°˜ë“œì‹œ ë³¸ì¸ ì›Œì»¤ ì£¼ì†Œë¡œ!
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev'; // <- í•„ìš” ì‹œ êµì²´
const VERSION  = 'Legend Ultimate 10.2';

/* =========================
   1) ìœ í‹¸
========================= */
const KR_NAMES = {
  BTC:'ë¹„íŠ¸ì½”ì¸', ETH:'ì´ë”ë¦¬ì›€', BCH:'ë¹„íŠ¸ì½”ì¸ìºì‹œ', XRP:'ë¦¬í”Œ', SOL:'ì†”ë¼ë‚˜', DOGE:'ë„ì§€ì½”ì¸',
  SHIB:'ì‹œë°”ì´ëˆ„', ADA:'ì—ì´ë‹¤', MATIC:'í´ë¦¬ê³¤', AVAX:'ì•„ë°œë€ì²´', ATOM:'ì½”ìŠ¤ëª¨ìŠ¤', LTC:'ë¼ì´íŠ¸ì½”ì¸',
  ETC:'ì´ë”ë¦¬ì›€í´ë˜ì‹', PEPE:'í˜í˜', SUI:'ìˆ˜ì´', APT:'ì•±í† ìŠ¤', ARB:'ì•„ë¹„íŠ¸ëŸ¼', OP:'ì˜µí‹°ë¯¸ì¦˜'
};
const ALIAS = {
  'ë¹„íŠ¸ì½”ì¸':'BTC','ë¹„ìº':'BCH','ë¦¬í”Œ':'XRP','ì†”ë¼ë‚˜':'SOL','ë„ì§€':'DOGE','ì‹œë°”ì´ëˆ„':'SHIB','ì—ì´ë‹¤':'ADA',
  'í´ë¦¬ê³¤':'MATIC','ì´ë”ë¦¬ì›€':'ETH','ë¹„íŠ¸ì½”ì¸ìºì‹œ':'BCH','ì•„ë°œë€ì²´':'AVAX','ì½”ìŠ¤ëª¨ìŠ¤':'ATOM','ë¼ì´íŠ¸ì½”ì¸':'LTC',
  'ì´ë”ë¦¬ì›€í´ë˜ì‹':'ETC','í˜í˜':'PEPE','ìˆ˜ì´':'SUI','ì•±í† ìŠ¤':'APT','ì•„ë¹„íŠ¸ëŸ¼':'ARB','ì˜µí‹°ë¯¸ì¦˜':'OP'
};
function toSymbol(input){
  if(!input) return null;
  const s = input.trim().toUpperCase();
  if (KR_NAMES[s]) return s;                            // KR key accidentally uppercase
  if (ALIAS[input.trim()]) return ALIAS[input.trim()];
  // try reverse: find key by korean name
  const byKR = Object.entries(KR_NAMES).find(([sym,kr])=>kr===input.trim());
  if (byKR) return byKR[0];
  // fallback: assume already symbol
  return s.replace(/[^\w]/g,'');
}
function krName(sym){ return KR_NAMES[sym] || sym; }
function fmtPercent(n){ if(n===null||n===undefined||isNaN(n)) return '-'; const s=(n>0?'+':'')+n.toFixed(2)+' %'; return s; }
function ts(){ const d=new Date(); return d.toLocaleString('ko-KR'); }

/* ì—…ë¹„íŠ¸ KRW í‹±(í˜¸ê°€) ê·œì¹™ */
function tickSize(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 5;
  if (p >= 100)     return 1;
  if (p >= 10)      return 0.1;
  if (p >= 1)       return 0.01;
  if (p >= 0.1)     return 0.001;
  if (p >= 0.01)    return 0.0001;
  return 0.0001;
}
function roundTick(val, refPrice){
  const t = tickSize(refPrice);
  return Math.round(val / t)*t;
}
function fmtKRW(v, ref){
  if(v===null||v===undefined||isNaN(v)) return '-';
  const t=tickSize(ref??v);
  const decimals = (t<1) ? String(t).split('.')[1].length : 0;
  return (roundTick(v, ref??v)).toLocaleString('ko-KR', {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
}

/* ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆ ì‚°ì¶œ (ì‹œì¥ëª¨ë“œ/ì €ê°€ë³´ì • ë°˜ì˜) */
function decideAccurate(price, symbol, marketMode='neutral'){
  if(!price||isNaN(price)) return {buy:0,sell:0,stop:0,spread:0};
  let spreadBase=0.004;                 // ê¸°ë³¸ ìŠ¤í”„ë ˆë“œ
  if (price<10) spreadBase=0.015;       // ì´ˆì €ê°€ ë³´ì •
  if (['PEPE','SHIB','DOGE'].includes(symbol)) spreadBase=Math.max(spreadBase,0.012);

  // ì‹œì¥ ëª¨ë“œ ë³´ì •
  if (marketMode==='bull')   spreadBase*=1.25;   // ë¶ˆì¥: ë” ë„“ê²Œ
  if (marketMode==='bear')   spreadBase*=0.8;    // í•˜ë½: ì¢ê²Œ

  const buy  = roundTick(price*(1-spreadBase), price);
  const sell = roundTick(price*(1+spreadBase), price);

  // ì†ì ˆì€ ì €ê°€ì¼ìˆ˜ë¡ ë” íƒ€ì´íŠ¸í•˜ê²Œ
  let stopMul = (price<10) ? 0.97 : 0.985;
  if (marketMode==='bear') stopMul = Math.min(stopMul, (price<10)?0.965:0.98);

  const stop = roundTick(price*stopMul, price);
  return {buy, sell, stop, spread:spreadBase};
}

/* ìœ„í—˜ë„ & ê²°ë¡  */
function riskAndVerdict({price, premiumPct=0, chg60m=0, marketMode='neutral'}){
  // 1~5 ì ìˆ˜
  let risk = 3;
  if (premiumPct>2)  risk++;
  if (premiumPct<-2) risk--;
  if (chg60m>1.0) risk++;
  if (chg60m<-1.0) risk--;
  if (marketMode==='bull') risk--;
  if (marketMode==='bear') risk++;

  risk = Math.max(1, Math.min(5, risk));

  let verdict = 'ì¤‘ë¦½, ìŠ¤ìœ™ ëŒ€ì‘';
  if (risk>=5) verdict='ë§¤ë„ ì£¼ì˜, ì„¸ë ¥ êµ¬ê°„';
  else if (risk===4) verdict='ì¤‘ë¦½, ê´€ë§ êµ¬ê°„';
  else if (risk===3) verdict='ì¤‘ë¦½, ê´€ë§ êµ¬ê°„';
  else if (risk===2) verdict='ì•ˆì •ì , ë§¤ìˆ˜ ê°€ëŠ¥';
  else verdict='ì €ìœ„í—˜, ë¶„í• ë§¤ìˆ˜ ìœ ë¦¬';

  // ë¶ˆì¥/í•˜ë½ ëª¨ë“œ ë³´ì • ë¬¸êµ¬
  if (marketMode==='bull' && risk<=3) verdict='ğŸ”¥ ë¶ˆì¥, ì¶”ì„¸ ë§¤ìˆ˜ ìš°ì„¸';
  if (marketMode==='bear' && risk>=3) verdict='â„ï¸ í•˜ë½ì¥, ê¸‰ë½ëŒ€ë¹„ / ì†ì ˆì—„ìˆ˜';

  return {risk, verdict};
}

/* =========================
   2) API
========================= */
async function safeGet(url){
  try{
    const res = await fetch(url, {cache:'no-store'});
    const j = await res.json();
    return j;
  }catch(e){ return {ok:false, error:String(e)} }
}
async function getHealth(){
  return safeGet(`${API_BASE}/api/health`);
}
async function getMarketMode(){
  const j = await safeGet(`${API_BASE}/api/market-mode`);
  // ê¸°ëŒ€: {mode:'bull'|'bear'|'neutral', updatedAt:'...'}
  if (j && j.mode) return j;
  return {mode:'neutral', updatedAt:null};
}
async function getPremium(symbol){
  return safeGet(`${API_BASE}/api/premium?symbol=${symbol}`);
}
async function getOnchainETH(){
  return safeGet(`${API_BASE}/api/onchain?symbol=ETH`);
}
async function getSpark(){
  // ê¸°ëŒ€: [{symbol, price, chg60m}, ...]
  return safeGet(`${API_BASE}/api/spark`);
}

/* =========================
   3) ë Œë”
========================= */
const $ = (sel)=>document.querySelector(sel);
const $$= (sel)=>document.querySelectorAll(sel);

function setText(id,val){ const el=$(id.startsWith('#')?id:('#'+id)); if(el) el.textContent=val; }

function renderPremiumCard(d){
  // d: { ok, upbitPrice, usdkrw, globalUsd, premiumPct, ...}
  setText('#krw_btc', d?.upbitPrice ? fmtKRW(d.upbitPrice) + 'ì›' : '-');
  setText('#usd_btc', d?.globalUsd ? d.globalUsd.toLocaleString('en-US',{maximumFractionDigits:2})+' USD' : '-');
  setText('#usdkrw', d?.usdkrw ? d.usdkrw.toLocaleString('ko-KR',{maximumFractionDigits:3}) : '-');
  setText('#kimp', (d?.premiumPct!==undefined) ? fmtPercent(d.premiumPct) : '-');
}

function renderOnchainCard(d){
  // d: { ok, tvl, src, updatedAt }
  setText('#tvl', (d?.tvl!==undefined) ? d.tvl.toLocaleString('en-US',{maximumFractionDigits:0})+' USD' : '-');
  setText('#tvl_src', d?.src || '-');
  setText('#tvl_updated', d?.updatedAt ? new Date(d.updatedAt).toLocaleString('ko-KR') : '-');
  setText('#tvl_status', d?.ok ? 'ì •ìƒ' : 'ì˜¤ë¥˜');
  $('#autoTVL').className = 'pill ' + (d?.ok?'ok':'bad');
}

function trCoinRow({symbol, price, buy, sell, stop, risk, verdict, chg60m}){
  const name = krName(symbol);
  const riskClass = risk>=5?'bad':(risk>=4?'warn':(risk<=2?'ok':''));  
  return `
    <tr data-sym="${symbol}">
      <td><b>${name}</b> <span class="mut mono">(${symbol})</span>
        <button class="badge" data-fav="${symbol}" style="margin-left:6px">ê´€ì‹¬+</button>
      </td>
      <td class="mono">${fmtKRW(price,price)}ì›</td>
      <td class="mono">${fmtKRW(buy,price)}ì›</td>
      <td class="mono">${fmtKRW(sell,price)}ì›</td>
      <td class="mono">${fmtKRW(stop,price)}ì›</td>
      <td><span class="tag ${riskClass}">${risk}</span>${chg60m!==undefined?` <span class="small mono">(${(chg60m>0?'+':'')+(chg60m||0).toFixed(2)}%)</span>`:''}</td>
      <td class="small">${verdict}</td>
    </tr>
  `;
}

function renderSearchTable(rows){
  const tb = $('#searchTable tbody');
  tb.innerHTML = rows && rows.length ? rows.join('') : `<tr><td colspan="7" class="small">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
}
function renderSparkTable(items){
  const tb = $('#sparkTable tbody');
  tb.innerHTML = (items && items.length) ? items.join('') : `<tr><td colspan="8" class="small">SPARK ë¡œë”© ì˜¤ë¥˜</td></tr>`;
}
function renderFav(listHTML){
  const tb = $('#favTable tbody');
  tb.innerHTML = listHTML && listHTML.length ? listHTML.join('') : `<tr><td colspan="7" class="small">ê´€ì‹¬ì½”ì¸ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸° ê³ ì • í‘œì‹œë©ë‹ˆë‹¤.</td></tr>`;
}

function renderFavChips(){
  const favs = getFavs();
  const box = $('#favChips');
  box.innerHTML = favs.map(s=>`<button class="badge" data-unfav="${s}">${krName(s)} (${s}) Ã—</button>`).join('') || `<span class="small">ê´€ì‹¬ì½”ì¸ ì—†ìŒ</span>`;
}

/* =========================
   4) ìƒíƒœ & ì €ì¥
========================= */
function setAPIStatus(ok){ const b = $('#apiStatus'); b.textContent = 'API ì—°ê²°: ' + (ok?'ì •ìƒ':'ì˜¤ë¥˜'); b.className='badge ' + (ok?'ok':'bad'); }
function setMarketBadge(mode){
  const map = {bull:'ë¶ˆì¥', bear:'í•˜ë½', neutral:'ì¤‘ë¦½'};
  const b = $('#modeBadge');
  b.textContent = 'ì‹œì¥ëª¨ë“œ: ' + (map[mode]||'-');
}

/* ê´€ì‹¬ì½”ì¸ (ìµœëŒ€ 10) */
const FAV_KEY = 'zzeol_favs_v2';
function getFavs(){
  try{
    const a = JSON.parse(localStorage.getItem(FAV_KEY)||'[]'); 
    return Array.isArray(a)?a.slice(0,10):[];
  }catch(_){ return [] }
}
function saveFavs(a){ localStorage.setItem(FAV_KEY, JSON.stringify(a.slice(0,10))); }
function toggleFav(sym){
  const a = getFavs();
  const i = a.indexOf(sym);
  if (i>=0) a.splice(i,1);
  else { if (a.length>=10) a.shift(); a.push(sym) }
  saveFavs(a); renderFavChips(); refreshFavTable();
}

/* =========================
   5) ë¡œì§
========================= */
let GLOBAL = {mode:'neutral'};

async function boot(){
  $('#updatedAt').textContent = ts();

  // API ìƒíƒœ
  const hc = await getHealth();
  setAPIStatus(hc?.ok);

  // ì‹œì¥ ëª¨ë“œ
  const mm = await getMarketMode();
  GLOBAL.mode = mm?.mode || 'neutral';
  setMarketBadge(GLOBAL.mode);

  // í”„ë¦¬ë¯¸ì—„ ì¹´ë“œ
  const p = await getPremium('BTC');
  renderPremiumCard(p);

  // ì˜¨ì²´ì¸ ì¹´ë“œ
  const oc = await getOnchainETH();
  renderOnchainCard(oc);

  // SPARK
  await refreshSpark();

  // ê´€ì‹¬ì½”ì¸
  renderFavChips();
  await refreshFavTable();

  // ì´ë²¤íŠ¸
  $('#btnSearch').addEventListener('click', onSearch);
  $('#btnReset').addEventListener('click', ()=>{ $('#q').value=''; renderSearchTable([]) });
  $('#searchTable').addEventListener('click',(e)=>{
    const b = e.target.closest('[data-fav]');
    if(b){ toggleFav(b.dataset.fav); }
  });
  $('#favChips').addEventListener('click',(e)=>{
    const b = e.target.closest('[data-unfav]');
    if(b){ toggleFav(b.dataset.unfav); }
  });

  // 60ì´ˆë§ˆë‹¤ ìë™ ë¦¬í”„ë ˆì‹œ
  setInterval(async ()=>{
    await refreshSpark();
    await refreshFavTable();
    $('#updatedAt').textContent = ts();
  }, 60000);
}

/* ê²€ìƒ‰ */
async function onSearch(){
  const txt = $('#q').value.trim();
  if(!txt) return renderSearchTable([]);
  const sym = toSymbol(txt);
  if(!sym) return renderSearchTable([]);

  // ê°€ê²©/í”„ë¦¬ë¯¸ì—„(Upbit KRW) â†’ premium API ì´ìš©
  const d = await getPremium(sym);
  if(!d?.ok || !d?.upbitPrice) return renderSearchTable([`<tr><td colspan="7" class="small">ê²€ìƒ‰ ì‹¤íŒ¨: ${d?.error||'ë°ì´í„° ì—†ìŒ'}</td></tr>`]);

  const price = d.upbitPrice;
  const ta = decideAccurate(price, sym, GLOBAL.mode);
  const risk = riskAndVerdict({price, premiumPct:d.premiumPct||0, chg60m:0, marketMode:GLOBAL.mode});

  const row = trCoinRow({symbol:sym, price, ...ta, ...risk});
  renderSearchTable([row]);
}

/* SPARK */
async function refreshSpark(){
  const j = await getSpark();
  if(!j || !j.ok || !Array.isArray(j.data||j)){
    return renderSparkTable([]);
  }
  const arr = j.data || j;   // í˜¸í™˜
  // ìƒìœ„ 10ê°œ (chg60m ë‚´ë¦¼ì°¨ìˆœ)
  const top = arr
    .filter(x=>x && x.symbol && x.price)
    .sort((a,b)=>(b.chg60m||0)-(a.chg60m||0))
    .slice(0,10)
    .map(x=>{
      const ta = decideAccurate(x.price, x.symbol, GLOBAL.mode);
      const rk = riskAndVerdict({price:x.price, premiumPct:x.premiumPct||0, chg60m:x.chg60m||0, marketMode:GLOBAL.mode});
      return trCoinRow({symbol:x.symbol, price:x.price, chg60m:x.chg60m||0, ...ta, ...rk});
    });
  renderSparkTable(top);
}

/* ê´€ì‹¬ì½”ì¸ í‘œ */
async function refreshFavTable(){
  const favs = getFavs();
  if(!favs.length) return renderFav([]);
  const rows = [];
  for (const s of favs){
    const d = await getPremium(s);
    if(!d?.ok || !d?.upbitPrice){ continue; }
    const price = d.upbitPrice;
    const ta = decideAccurate(price, s, GLOBAL.mode);
    const rk = riskAndVerdict({price, premiumPct:d.premiumPct||0, chg60m:0, marketMode:GLOBAL.mode});
    rows.push(trCoinRow({symbol:s, price, ...ta, ...rk}));
  }
  renderFav(rows);
}

/* ì‹œì‘ */
boot().catch(console.error);
</script>
</body>
</html>
