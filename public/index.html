<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 â€” KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</title>
<style>
  :root{--bg:#0b0f14;--panel:#141a22;--text:#e8eef6;--muted:#9fb2c8;--line:#213040;--accent:#f25f5c;--ok:#28c76f;--warn:#ffb020;}
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1180px;margin:34px auto 60px;padding:0 16px}
  .top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .top h1{font-size:18px;font-weight:700;margin:0;opacity:.9}
  .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .search input{flex:1;background:transparent;border:0;color:var(--text);outline:none;font-size:15px}
  .api-note{font-size:12px;color:var(--muted);text-align:right;margin:6px 2px 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h2{margin:0 0 10px;font-size:14px;letter-spacing:.1px;opacity:.9}
  .spark{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){.spark{grid-template-columns:1fr}}
  .coin{display:flex;flex-direction:column;gap:6px;border:1px solid var(--line);border-radius:12px;padding:12px;cursor:pointer;transition:transform .05s}
  .coin:hover{transform:translateY(-1px);border-color:#2a425a}
  .row{display:flex;justify-content:space-between;gap:10px;font-size:13px}
  .sym{font-weight:800}
  .kname{font-weight:600;opacity:.85}
  .price{font-weight:700}
  .bar{height:6px;background:#233447;border-radius:6px;overflow:hidden}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,#e96d6d,#f25f5c,#ff7a59);width:0%}
  .pill{font-size:11px;border:1px solid var(--line);padding:3px 7px;border-radius:999px;color:var(--muted)}
  .pill.ok{color:#dbe9ff;border-color:#2c4763}
  .pill.hot{color:#fff;background:#9b1c1c;border-color:#9b1c1c}
  .ultra-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0}
  @media (max-width:640px){.ultra-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .metric{border:1px solid var(--line);border-radius:12px;padding:10px}
  .metric b{display:block;font-size:12px;color:var(--muted);margin-bottom:2px}
  .metric span{font-size:16px;font-weight:800}
  .ment{border:1px dashed #2c3d52;border-radius:12px;padding:12px;color:#d8e8ff;background:#122030;margin-top:6px;font-size:13px}
  .foot{margin-top:14px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="search">
      <span>ğŸ”</span>
      <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ â€” ì˜ˆ: ì‹œë°”ì´ëˆ„, ì¹ ë¦¬ì¦ˆ, ì˜¨ë„â€¦" />
      <span class="pill ok">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</span>
    </div>
  </div>
  <div class="api-note">API: <span id="api-url"></span></div>

  <div class="grid">
    <div class="card">
      <h2>SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸ ğŸ”¥ (ê³ ì •)</h2>
      <div id="spark" class="spark"></div>
      <div class="foot">ì˜ˆì—´ ì¡°ê±´: RVOLâ‰¥1.8 Â· TBRâ‰¥0.60 Â· OBIâ‰¥+0.15 Â· ìµœê·¼5ë¶„ ë³€ë™ë¥ â‰¥+1.5% (4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ í™•ì •)</div>
    </div>

    <div class="card">
      <h2>ULTRA ì‹œê·¸ë„ â€” <span id="ul-name">ì„ íƒëœ ì½”ì¸</span></h2>
      <div class="ultra-grid">
        <div class="metric"><b>í˜„ì¬ê°€</b><span id="ul-price">-</span></div>
        <div class="metric"><b>ë§¤ìˆ˜ (BUY1)</b><span id="ul-buy1">-</span></div>
        <div class="metric"><b>ì¶”ê°€ë§¤ìˆ˜ (BUY2)</b><span id="ul-buy2">-</span></div>
        <div class="metric"><b>ìµì ˆ 1 (TP1)</b><span id="ul-tp1">-</span></div>
        <div class="metric"><b>ìµì ˆ 2 (TP2)</b><span id="ul-tp2">-</span></div>
        <div class="metric"><b>ì†ì ˆ (SL)</b><span id="ul-sl">-</span></div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:6px 0 0">
        <span id="pill-score" class="pill">ì˜ˆì—´ê°•ë„ 0</span>
        <span id="pill-prob" class="pill">ìƒìŠ¹í™•ë¥  0%</span>
        <span id="pill-rise" class="pill">ì˜ˆìƒìƒìŠ¹ë¥  +0%</span>
        <span id="pill-risk" class="pill">ìœ„í—˜ë„ 3</span>
      </div>
      <div id="ment" class="ment">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <div class="foot">ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 Â· Precision Boost Â· ForceIndex_AI Â· Bull/Bear Mode Â· Free Alpha Pack Â· No-Motion DOM Patch</div>
</div>

<script>
/* =========================
   ì„¤ì • â€” ë°˜ë“œì‹œ /api í¬í•¨
========================= */
const CONFIG = {
  API_BASE: "https://satoshi-proxy.mujukno1.workers.dev/api"
};
document.getElementById('api-url').textContent = CONFIG.API_BASE;

/* =========================
   í•œê¸€ ì½”ì¸ëª… (í•„ìš”ì‹œ í™•ì¥)
========================= */
const KNAME = {
  "KRW-SHIB": "ì‹œë°”ì´ëˆ„", "KRW-BTC": "ë¹„íŠ¸ì½”ì¸", "KRW-ETH": "ì´ë”ë¦¬ì›€",
  "KRW-XRP": "ë¦¬í”Œ", "KRW-DOGE": "ë„ì§€ì½”ì¸", "KRW-SOL":"ì†”ë¼ë‚˜",
  "KRW-CHZ":"ì¹ ë¦¬ì¦ˆ","KRW-ONDO":"ì˜¨ë„","KRW-FIL":"íŒŒì¼ì½”ì¸",
  "KRW-BAT":"ë² ì´ì§ì–´í…ì…˜í† í°","KRW-WAVES":"ì›¨ì´ë¸Œ"
};

/* ===========================================================
   ì—…ë¹„íŠ¸ KRW í˜¸ê°€ë‹¨ìœ„(í‹±) â€” ì €ê°€ì½”ì¸ ì™„ë²½ ëŒ€ì‘ (v10.5)
   í‘œì¤€ KRW ë§ˆì¼“ ê·œì¹™ì„ ë‹¨ì¼ í•¨ìˆ˜ë¡œ í†µí•©
=========================================================== */
function krwTickStep(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;     // ì‹œë°”ì´ëˆ„ ë“± ì €ê°€ì½”ì¸
  if (p >= 0.1)     return 0.0001;
  return 0.00001;
}
function roundTick(p){
  const step = krwTickStep(p);
  const r = Math.round(p / step) * step;
  // í‘œì‹œ ìë¦¬ìˆ˜ ê³ ì •
  const d = (step.toString().split('.')[1] || '').length;
  return Number(r.toFixed(d));
}

/* =========================
   ê³µìš© ìœ í‹¸
========================= */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const fmtKRW = (v)=> (v>=1000 ? Math.round(v).toLocaleString('ko-KR')+"ì›" : (v.toFixed(krwTickStep(v).toString().split('.')[1]?.length||0))+"ì›");
const pct = (v)=> (v>0? "+" : "") + (v*100).toFixed(1) + "%";

/* =========================
   í•µì‹¬ ë¡œì§: SPARK + ULTRA
========================= */
let TICKERS = new Map(); // market -> {price}
let LAST_SPARK = [];

async function fetchTickers(){
  const res = await fetch(`${CONFIG.API_BASE}/upbit/tickers`);
  const arr = await res.json();
  const m = new Map();
  for(const t of arr){ m.set(t.market, { price: Number(t.tradePrice)||0 }); }
  TICKERS = m;
}

function expectedRise(score){
  if (score>=90) return 0.21; // 15~25% ì¤‘ê°„ì¹˜
  if (score>=80) return 0.10; // 8~12%
  if (score>=70) return 0.05; // 4~6%
  return 0.02;
}
function riseProb(score){
  if (score>=90) return 0.88;
  if (score>=80) return 0.72;
  if (score>=70) return 0.60;
  return 0.45;
}
function riskLevel(score){
  if (score>=90) return 2;
  if (score>=80) return 2;
  if (score>=70) return 3;
  return 4;
}

function buildMent(item){
  const { score, rvol, tbr, obi, market } = item;
  const name = KNAME[market] || market.replace("KRW-","");
  if (score>=90) return `ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ${name} ì˜ˆì—´ê°•ë„ ${score} / ìƒìŠ¹í™•ë¥  ${(riseProb(score)*100)|0}% / ì˜ˆìƒìƒìŠ¹ë¥  +${(expectedRise(score)*100).toFixed(1)}%`;
  if (score>=80) return `âš¡ ê°•ë ¥ ì˜ˆì—´ â€” ${name} ëª¨ë©˜í…€ ìš°ì„¸(TBR ${(tbr*100).toFixed(0)}%) / RVOL ${rvol.toFixed(2)} / ì˜ˆì—´ê°•ë„ ${score}`;
  if (score>=70) return `ğŸŸ¡ ì˜ˆì—´ ì§„í–‰ â€” ${name} ê´€ë§ ë˜ëŠ” ì†ŒëŸ‰ ë¶„í•  ì§„ì… ê¶Œì¥ (OBI ${(obi*100).toFixed(0)}%)`;
  return `ğŸ”µ ëŒ€ê¸° â€” ì‹ í˜¸ ì•½í•¨. ì¡°ê±´ ì¶©ì¡± ëŒ€ê¸° ê¶Œì¥`;
}

function buildTargets(price, score){
  const exp = expectedRise(score); // +% ê¸°ëŒ€
  const step = krwTickStep(price);
  // ëª¨ë“œ ë³´ì • (ê°„ì´): ë†’ì€ ì˜ˆì—´ì¼ìˆ˜ë¡ ëŠê¸‹, ë‚®ì„ìˆ˜ë¡ ë³´ìˆ˜
  const tp1P = (score>=90? 0.016 : score>=80? 0.012 : 0.008);
  const tp2P = (score>=90? 0.028 : score>=80? 0.020 : 0.014);
  const slP  = (score>=90? -0.008 : score>=80? -0.010 : -0.012);

  const buy1 = roundTick(price * (1 - Math.min(0.003, exp*0.2)));
  const buy2 = roundTick(price * (1 - Math.min(0.008, exp*0.35)));
  const tp1  = roundTick(price * (1 + tp1P));
  const tp2  = roundTick(price * (1 + tp2P));
  const sl   = roundTick(price * (1 + slP));
  return { buy1, buy2, tp1, tp2, sl };
}

/* =========================
   ë Œë” â€” No-Motion (ë¶€ë¶„íŒ¨ì¹˜)
========================= */
function renderSpark(list){
  const box = document.getElementById('spark');
  // DOM diff ê°±ì‹ : ì „ì²´ ì¬ìƒì„± ëŒ€ì‹  innerHTML í•œ ë²ˆ (ê³ ì • ë†’ì´ ì¹´ë“œ)
  box.innerHTML = list.slice(0,10).map(item=>{
    const price = (TICKERS.get(item.market)?.price)||0;
    const kname = KNAME[item.market] || item.market.split('-')[1];
    const score = item.score|0;
    const barW = Math.min(100, Math.max(0, score));
    const hot = score>=90 ? 'hot':'';
    return `
      <div class="coin" data-market="${item.market}">
        <div class="row">
          <div>
            <div class="sym">${item.market}</div>
            <div class="kname">${kname}</div>
          </div>
          <div class="price">${price? fmtKRW(price):'-'}</div>
        </div>
        <div class="bar"><i style="width:${barW}%"></i></div>
        <div class="row" style="margin-top:4px">
          <span class="pill ${hot}">SPARK ${score}</span>
          <span class="pill">RVOL ${item.rvol?.toFixed(2)||'-'}</span>
          <span class="pill">TBR ${(item.tbr*100).toFixed(0)}%</span>
        </div>
      </div>`;
  }).join('');

  // í´ë¦­ â†’ ULTRA ì—°ê²°
  box.querySelectorAll('.coin').forEach(el=>{
    el.onclick = ()=>{
      const m = el.getAttribute('data-market');
      const item = list.find(x=>x.market===m);
      selectUltra(item);
    };
  });

  // ì´ˆê¸° ìë™ ì„ íƒ (ì²« í•­ëª©)
  if (list.length && !document.getElementById('ul-name').dataset.bound){
    document.getElementById('ul-name').dataset.bound = '1';
    selectUltra(list[0]);
  }
}

function selectUltra(item){
  if (!item) return;
  const price0 = (TICKERS.get(item.market)?.price)||0;
  const price = roundTick(price0);
  const kname = KNAME[item.market] || item.market.split('-')[1];

  document.getElementById('ul-name').textContent = `${kname} (${item.market})`;
  document.getElementById('ul-price').textContent = fmtKRW(price);

  // íƒ€ì  ê³„ì‚° (í˜¸ê°€í‹± ì ìš©)
  const { buy1, buy2, tp1, tp2, sl } = buildTargets(price, item.score|0);
  document.getElementById('ul-buy1').textContent = fmtKRW(buy1);
  document.getElementById('ul-buy2').textContent = fmtKRW(buy2);
  document.getElementById('ul-tp1').textContent  = fmtKRW(tp1);
  document.getElementById('ul-tp2').textContent  = fmtKRW(tp2);
  document.getElementById('ul-sl').textContent   = fmtKRW(sl);

  // ì •ë³´ ì¹©
  const prob = Math.round(riseProb(item.score)*100);
  const rise = Math.round(expectedRise(item.score)*1000)/10;
  document.getElementById('pill-score').textContent = `ì˜ˆì—´ê°•ë„ ${item.score|0}`;
  document.getElementById('pill-prob').textContent  = `ìƒìŠ¹í™•ë¥  ${prob}%`;
  document.getElementById('pill-rise').textContent  = `ì˜ˆìƒìƒìŠ¹ë¥  +${rise}%`;
  document.getElementById('pill-risk').textContent  = `ìœ„í—˜ë„ ${riskLevel(item.score)}`;

  // ì©”ì–´í•œë§ˆë””
  document.getElementById('ment').textContent = buildMent(item);
}

/* =========================
   ë£¨í”„ â€” 5ì´ˆë§ˆë‹¤ ê°±ì‹  (No-Motion)
========================= */
async function loop(){
  try{
    await fetchTickers();
    const s = await fetch(`${CONFIG.API_BASE}/spark/top?window=5m&limit=10`).then(r=>r.json());
    LAST_SPARK = Array.isArray(s) ? s : [];
    renderSpark(LAST_SPARK);
  }catch(e){
    console.warn('fetch error', e);
  }finally{
    setTimeout(loop, 5000);
  }
}

/* =========================
   ê²€ìƒ‰ â€” ê°„ë‹¨ í•„í„° (í•œê¸€/ì‹¬ë³¼)
========================= */
document.getElementById('q').addEventListener('input', (e)=>{
  const v = e.target.value.trim().toLowerCase();
  if (!v){ renderSpark(LAST_SPARK); return; }
  const f = LAST_SPARK.filter(x=>{
    const sym = x.market.toLowerCase();
    const kn  = (KNAME[x.market]||'').toLowerCase();
    return sym.includes(v) || kn.includes(v);
  });
  renderSpark(f);
});

/* ì‹œì‘ */
loop();
</script>
</body>
</html>
