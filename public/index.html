<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 — Stable API One-Shot</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0f1218;--panel:#151a21;--muted:#9aa4b2;--text:#e7eef8;--accent:#5ac8fa;
        --up:#1ec996;--down:#ff5b6b;--chip:#1f2630;--rail:#2a3340;--spark:#ffb020}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid #1f2530;border-radius:14px;padding:12px 14px}
  .title{font-weight:700;margin:0 0 8px}
  .muted{color:var(--muted)}
  .api{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-bottom:8px}
  .api .dot{width:8px;height:8px;border-radius:50%;background:#888}
  .api.ok .dot{background:var(--up)} .api.fail .dot{background:var(--down)}
  .chip{display:inline-flex;gap:6px;background:var(--chip);border-radius:999px;padding:4px 10px;font-size:12px;color:#b9c2d0}
  code{background:#0b0e13;border:1px solid #222939;border-radius:8px;padding:2px 6px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;align-items:center;justify-content:space-between;background:#121722;border:1px solid #1e2634;border-radius:10px;padding:10px}
  .item b{font-weight:700}
  .err{white-space:pre-wrap;color:#ffd5d8}
  input,button{background:#0e141d;border:1px solid #263244;border-radius:10px;color:var(--text);padding:10px 12px}
  button{cursor:pointer}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="api" id="apiStat"><span class="chip">API <span id="apiBaseTxt"></span></span><span class="dot"></span></div>
  <h1 style="margin:6px 0 18px">사토시의지갑 — 연결 확인판</h1>

  <div class="panel">
    <div class="grid2">
      <div>
        <div class="title">API 주소</div>
        <div class="list">
          <label>API_BASE
            <input id="apiBase" placeholder="예: https://satoshi-proxy.mujukno1.workers.dev" />
          </label>
          <div>
            <button id="btnSave">저장</button>
            <button id="btnPing">헬스체크</button>
            <span class="muted">저장하면 localStorage에 보관</span>
          </div>
        </div>
      </div>
      <div>
        <div class="title">빠른 테스트</div>
        <div class="list">
          <div class="item"><span>UPBIT/마켓</span><button id="btnMk">/api/upbit/markets</button></div>
          <div class="item"><span>캔들 KRW-SOL (m1)</span><button id="btnC">/api/upbit/candles</button></div>
          <div class="item"><span>티커 KRW-SOL</span><button id="btnT">/api/ticker</button></div>
          <div class="item"><span>SPARK TOP10</span><button id="btnS">/api/spark</button></div>
          <div class="item"><span>ULTRA KRW-SOL</span><button id="btnU">/api/ultra</button></div>
        </div>
      </div>
    </div>
    <div style="margin-top:12px">
      <div class="title">응답</div>
      <pre id="out" class="panel err" style="overflow:auto;max-height:320px"></pre>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="panel">
      <div class="title">SPARK 예열 TOP (샘플)</div>
      <div id="sparkBox" class="list"></div>
    </div>
    <div class="panel">
      <div class="title">ULTRA 시그널 (샘플)</div>
      <div id="ultraBox" class="list"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (s)=>document.querySelector(s);
  const out = $("#out");
  const apiStat = $("#apiStat");
  const apiBaseTxt = $("#apiBaseTxt");

  let API_BASE = localStorage.getItem("API_BASE") || autodetect();
  $("#apiBase").value = API_BASE;
  apiBaseTxt.textContent = API_BASE;

  function autodetect(){
    // 데모/로컬에서 바로 열면 상대경로 방지용
    // 실제 배포 시 명시 저장 권장
    return "https://satoshi-proxy.mujukno1.workers.dev";
  }
  function setOk(ok){
    apiStat.classList.toggle("ok", ok);
    apiStat.classList.toggle("fail", !ok);
  }
  function print(o){ out.textContent = typeof o==="string" ? o : JSON.stringify(o, null, 2); }

  async function jget(path){
    const u = API_BASE.replace(/\/+$/,'') + path + (path.includes("?")?"&":"?") + "_t=" + Date.now();
    const r = await fetch(u, { headers:{ "Accept":"application/json" } });
    const txt = await r.text().catch(()=> "");
    let data = null;
    try{ data = JSON.parse(txt); }catch{ data = { raw: txt }; }
    if (!r.ok) throw { status:r.status, data };
    return data;
  }

  // 저장/헬스체크
  $("#btnSave").onclick = () => {
    const v = $("#apiBase").value.trim();
    if (v) { API_BASE = v; localStorage.setItem("API_BASE", v); apiBaseTxt.textContent = v; print("저장됨: "+v); }
  };
  $("#btnPing").onclick = async () => {
    try{
      const a = await jget("/");
      setOk(!!a.ok);
      print(a);
    }catch(e){ setOk(false); print(e); }
  };

  // Quick buttons
  $("#btnMk").onclick = async()=>{ try{ print(await jget("/api/upbit/markets")); }catch(e){ print(e); } };
  $("#btnC").onclick = async()=>{ try{ print(await jget("/api/upbit/candles?market=KRW-SOL&tf=m1&limit=120")); }catch(e){ print(e); } };
  $("#btnT").onclick = async()=>{ try{ print(await jget("/api/ticker?market=KRW-SOL")); }catch(e){ print(e); } };
  $("#btnS").onclick = async()=>{ try{ const r=await jget("/api/spark?limit=10"); print(r); drawSpark(r.items||[]);}catch(e){ print(e);} };
  $("#btnU").onclick = async()=>{ try{ const r=await jget("/api/ultra?market=KRW-SOL&limit=180"); print(r); drawUltra(r);}catch(e){ print(e);} };

  function drawSpark(items){
    const box = $("#sparkBox"); box.innerHTML="";
    (items||[]).forEach(x=>{
      const el = document.createElement("div"); el.className="item";
      el.innerHTML = `<b>${x.korean_name || x.market}</b>
        <span class="chip">변동률 ${x.changePct}%</span>
        <span class="chip">RVOL ${x.rvol}</span>
        <span class="chip">Score ${x.score}</span>`;
      box.appendChild(el);
    });
  }
  function drawUltra(r){
    const box = $("#ultraBox"); box.innerHTML="";
    if (!r || !r.ok) { box.textContent="데이터 없음"; return; }
    const {market, price, confidence, rvol, tbr, atrPct, levels} = r;
    const el = document.createElement("div"); el.className="item";
    el.innerHTML = `<div>
      <b>${market}</b>
      <div class="muted">가격 ${fmt(price)} · Conf ${confidence} · RVOL ${rvol} · TBR ${tbr} · ATR% ${(atrPct*100).toFixed(2)}%</div>
    </div>
    <div>
      <span class="chip">BUY1 ${fmt(levels.BUY1)}</span>
      <span class="chip">TP1 ${fmt(levels.TP1)}</span>
      <span class="chip">TP2 ${fmt(levels.TP2)}</span>
      <span class="chip">SL ${fmt(levels.SL)}</span>
    </div>`;
    box.appendChild(el);
  }
  function fmt(n){ return (n==null ? "-" : new Intl.NumberFormat("ko-KR").format(n)); }

  // 첫 로드에 ping
  (async () => {
    try{ const a = await jget("/"); setOk(!!a.ok); }catch{ setOk(false); }
  })();
})();
</script>
</body>
</html>
