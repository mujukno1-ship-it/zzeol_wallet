<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ - ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, AppleSDGothicNeo, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0f141a; color:#e8eef5;}
    .wrap{max-width:1200px;margin:40px auto;padding:0 16px;}
    h1{font-size:24px;margin:0 0 20px;}
    .search{margin:0 0 16px;}
    input,button{font:inherit}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#121922;border:1px solid #1c2633;border-radius:12px;padding:16px;}
    .card h3{margin:0 0 12px;font-size:18px;}
    .row{display:flex;justify-content:space-between;margin:4px 0;color:#cbd6e2}
    .metric{font-weight:700;color:#fff}
    .small{color:#91a3b5;font-size:12px}
    .hint{margin-top:8px;color:#7f8ea3;font-size:12px}
    a{color:#7fb3ff;text-decoration:none}
    footer{margin-top:16px;color:#7f8ea3;font-size:12px}
    .ok{color:#48d597}
    .err{color:#ff7b7b}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸª™ ì‚¬í† ì‹œì˜ì§€ê°‘ - ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</h1>

    <div class="search">
      <input id="symbol-input" placeholder="ì½”ì¸/ì‹¬ë³¼ ê²€ìƒ‰â€¦ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, BTC, ETH)" style="width:280px;height:36px;border-radius:8px;border:1px solid #243244;background:#0c1116;color:#e8eef5;padding:0 10px;" />
      <button id="apply" style="height:36px;border-radius:8px;border:1px solid #243244;background:#16202b;color:#e8eef5;padding:0 12px;margin-left:8px;">ì ìš©</button>
      <span class="small" id="proxy-health">í”„ë¡ì‹œ ìƒíƒœ: <span id="proxy-health-badge">ì ê²€ì¤‘â€¦</span></span>
    </div>

    <div class="grid">
      <!-- ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ -->
      <div class="card">
        <h3>ğŸ« ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ <span class="small" id="sym-kimp">BTC</span></h3>
        <div class="row"><span>ì—…ë¹„íŠ¸ KRW:</span><span class="metric" id="upbit-krw">-</span></div>
        <div class="row"><span>ê¸€ë¡œë²Œ USD:</span><span class="metric" id="global-usd">-</span></div>
        <div class="row"><span>USD/KRW:</span><span class="metric" id="usd-krw">-</span></div>
        <div class="row"><span>í”„ë¦¬ë¯¸ì—„(%):</span><span class="metric" id="kimp-pct">-</span></div>
        <div class="small">ì†ŒìŠ¤: <span id="kimp-src">-</span></div>
      </div>

      <!-- ì˜¨ì²´ì¸ TVL -->
      <div class="card">
        <h3>ğŸ§  ì˜¨ì²´ì¸ TVL(<span id="sym-onchain">ETH</span>)</h3>
        <div class="row"><span>TVL:</span><span class="metric" id="onchain-tvl">-</span></div>
        <div class="small">ì†ŒìŠ¤: <span id="onchain-src">-</span></div>
      </div>

      <!-- ì‹œê·¸ë„ (ìë¦¬ ìœ ì§€, ê°’ì€ ëŒ€ì‹œë¡œ í‘œì‹œ) -->
      <div class="card">
        <h3>ğŸ¯ ì‹œê·¸ë„</h3>
        <div class="row"><span>í˜„ì¬ê°€:</span><span id="sig-price">-</span></div>
        <div class="row"><span>ë§¤ìˆ˜:</span><span id="sig-buy">-</span></div>
        <div class="row"><span>ë§¤ë„:</span><span id="sig-sell">-</span></div>
        <div class="row"><span>ì†ì ˆ:</span><span id="sig-stop">-</span></div>
        <div class="row"><span>ìœ„í—˜ë„:</span><span id="sig-risk">-</span></div>
        <div class="hint">â€» ë‹¨ìˆœ ê³„ì‚°í˜• ì°¸ê³ ì§€í‘œ(í…ŒìŠ¤íŠ¸). ì‹¤ì œ ë§¤ë§¤ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ì©”ì–´ í•œë§ˆë”” (ìë¦¬ ìœ ì§€) -->
      <div class="card">
        <h3>ğŸ’¬ ì©”ì–´ í•œë§ˆë”” <span class="small pill">ë² íƒ€</span></h3>
        <div class="small">ì—…ë°ì´íŠ¸: <span id="commentary">-</span></div>
        <div class="small" style="margin-top:8px">ì—…ë°ì´íŠ¸: <span id="updated">-</span></div>
      </div>
    </div>

    <footer>
      <a href="https://coingecko.com" target="_blank" rel="noreferrer">CoinGecko</a> /
      <a href="https://open.er-api.com/" target="_blank" rel="noreferrer">open.er-api.com</a> /
      <a href="https://upbit.com" target="_blank" rel="noreferrer">Upbit</a>
      Â· í”„ë¡œì íŠ¸
      <a href="https://zzeolwallet.vercel.app" target="_blank" rel="noreferrer">zzeolwallet.vercel.app</a>
    </footer>
  </div>

  <!-- ì˜¬ì¸ì› ìŠ¤í¬ë¦½íŠ¸: ì™¸ë¶€ ëª¨ë“ˆ import/ê¸°ì¡´ js íŒŒì¼ í•„ìš” ì—†ìŒ -->
  <script type="module">
    // ====== ì„¤ì • ======
    const CONFIG = {
      PROXY_BASE: 'https://satoshi-proxy.mujukno1.workers.dev',
      DEFAULT_SYMBOL_KIMP: 'BTC',
      DEFAULT_SYMBOL_ONCHAIN: 'ETH',
      FETCH_TIMEOUT_MS: 10_000
    };

    // ====== ìœ í‹¸ ======
    const $ = (id) => document.getElementById(id);
    const nf0 = (n) => Number(n).toLocaleString('ko-KR');
    const nf2 = (n) => Number(n).toLocaleString('ko-KR', { maximumFractionDigits: 2 });
    const pct2 = (n) => (Number(n).toFixed(2) + '%');

    const withTimeout = (p, ms, msg='ìš”ì²­ ì‹œê°„ì´ˆê³¼') => {
      const t = new Promise((_, rej)=>setTimeout(()=>rej(new Error(msg)), ms));
      return Promise.race([p, t]);
    };

    const getJson = async (url) => {
      const res = await withTimeout(fetch(url, { cache:'no-store' }), CONFIG.FETCH_TIMEOUT_MS);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    };

    // ====== í”„ë¡ì‹œ í—¬ìŠ¤ ======
    const pingHealth = async () => {
      try {
        const j = await getJson(CONFIG.PROXY_BASE + '/api/health');
        $('proxy-health-badge').textContent = j?.ok ? 'ì •ìƒ' : 'ì ê²€ì¤‘â€¦';
        $('proxy-health-badge').className = j?.ok ? 'ok' : 'err';
      } catch {
        $('proxy-health-badge').textContent = 'ì˜¤í”„ë¼ì¸';
        $('proxy-health-badge').className = 'err';
      }
    };

    // ====== ê¹€í”„ ======
    const fetchKimp = async (symbol) => {
      const j = await getJson(`${CONFIG.PROXY_BASE}/api/premium?symbol=${encodeURIComponent(symbol)}`);
      if (j?.ok !== true) throw new Error(j?.error || 'kimp error');

      // í‘œì‹œëŠ” ì†Œìˆ˜ì  0~2ìë¦¬ ì ì ˆíˆ
      $('upbit-krw').textContent = nf0(j.upbitPrice);
      $('global-usd').textContent = nf2(j.globalUsd);
      $('usd-krw').textContent  = nf2(j.usdkrw);
      $('kimp-pct').textContent = pct2(j.premiumPct);
      $('kimp-src').textContent = `${j?.src?.global || 'CoinGecko'} / ${j?.src?.fx || 'open.er-api.com'} / ${j?.src?.krw || 'Upbit'}`;
      $('updated').textContent = new Date(j.updatedAt || Date.now()).toLocaleString('ko-KR');
    };

    // ====== ì˜¨ì²´ì¸ TVL ======
    const fetchOnchain = async (symbol) => {
      const j = await getJson(`${CONFIG.PROXY_BASE}/api/onchain?symbol=${encodeURIComponent(symbol)}`);
      if (j?.ok !== true) throw new Error(j?.error || 'onchain error');

      $('onchain-tvl').textContent = nf0(j.tvlusd);
      $('onchain-src').textContent = j?.src || 'DefiLlama';
    };

    // ====== UI ë°”ì¸ë”© ======
    const state = {
      kimpSymbol: CONFIG.DEFAULT_SYMBOL_KIMP,
      onchainSymbol: CONFIG.DEFAULT_SYMBOL_ONCHAIN,
    };

    const applySymbolsFromInput = () => {
      const raw = ($('symbol-input').value || '').trim();
      if (!raw) return; // ì•„ë¬´ê²ƒë„ ì•ˆì¹˜ë©´ ìœ ì§€
      const t = raw.toUpperCase();
      // ê°„ë‹¨ì¹˜í™˜
      if (t.includes('ETH')) state.onchainSymbol = 'ETH';
      if (t.includes('BTC')) state.kimpSymbol = 'BTC';
      // ì¼ë°˜ì‹¬ë³¼(3~5ì)ë§Œ ì…ë ¥í•˜ë©´ BTC/ETHëŠ” ìœ ì§€
      $('sym-kimp').textContent = state.kimpSymbol;
      $('sym-onchain').textContent = state.onchainSymbol;
      refreshAll().catch(console.error);
    };

    const refreshAll = async () => {
      $('sym-kimp').textContent = state.kimpSymbol;
      $('sym-onchain').textContent = state.onchainSymbol;
      try { await fetchKimp(state.kimpSymbol); } catch(e){ console.error(e); setKimpFallback(); }
      try { await fetchOnchain(state.onchainSymbol); } catch(e){ console.error(e); setOnchainFallback(); }
    };

    const setKimpFallback = () => {
      $('upbit-krw').textContent = '-';
      $('global-usd').textContent = '-';
      $('usd-krw').textContent = '-';
      $('kimp-pct').textContent = '-';
      $('kimp-src').textContent = '-';
    };

    const setOnchainFallback = () => {
      $('onchain-tvl').textContent = '-';
      $('onchain-src').textContent = '-';
    };

    // ====== ë¶€íŒ… ======
    (async () => {
      await pingHealth();
      $('sym-kimp').textContent = state.kimpSymbol;
      $('sym-onchain').textContent = state.onchainSymbol;
      $('apply').addEventListener('click', applySymbolsFromInput);
      await refreshAll();
      // ì£¼ê¸° ë¦¬í”„ë ˆì‹œ(ì„ íƒ): 60ì´ˆ
      setInterval(refreshAll, 60_000);
    })();
  </script>
</body>
</html>
