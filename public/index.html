<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 â€” KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· No-Motion</title>
<style>
  :root{
    --bg:#0f1218;--panel:#151a21;--muted:#9aa4b2;--text:#e7eef8;--accent:#5ac8fa;
    --up:#1ec996;--down:#ff5b6b;--chip:#1f2630;--rail:#2a3340;--spark:#ffb020;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .badge{background:#19202a;color:#9bc3ff;border:1px solid #2a3950;border-radius:10px;padding:4px 8px;font-size:12px}
  .api{margin-left:auto;font-size:12px;color:var(--muted)}
  .search{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,24,.95),rgba(15,18,24,.75));
          padding:10px 0 12px;z-index:5;backdrop-filter:saturate(1.2) blur(2px)}
  .search .row{display:flex;gap:8px;align-items:center}
  .search input{flex:1;background:#11161d;border:1px solid #263246;color:var(--text);
                border-radius:10px;padding:12px 14px;outline:none}
  .search button{background:#1b2533;border:1px solid #2b3a52;color:#d7e6ff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #202734;border-radius:18px;padding:14px}
  .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .title small{margin-left:6px;color:var(--muted);font-weight:500}
  .list{display:grid;gap:10px;margin-top:12px}
  .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#11161d;border:1px solid #1d2633}
  .item .name{display:flex;flex-direction:column}
  .item .name b{font-size:13px}
  .bar{height:6px;background:var(--rail);border-radius:999px;overflow:hidden}
  .bar span{display:block;height:100%;background:var(--spark);width:0%}
  .pillrow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid #273041;font-size:12px;color:#c8d3e2}
  .pill.up{border-color:#184c3c;color:#b8f5df}
  .pill.dn{border-color:#4c1922;color:#ffdbe0}
  .pill.badge{background:#121820}
  .ultra{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
  .box{background:#11161d;border:1px solid #1d2633;border-radius:12px;padding:10px;min-height:58px}
  .k{color:var(--muted);font-size:12px}
  .v{font-weight:700;margin-top:2px}
  .note{margin-top:10px;background:#10151c;border:1px dashed #2a3340;border-radius:12px;padding:10px;font-size:13px;color:#dbe8ff}
  footer{margin:18px 0 10px;color:#8fa0b5;font-size:12px;text-align:center}
  /* No-Motion: height reservation for empty state */
  .reserve{min-height:320px;display:flex;align-items:center;justify-content:center;color:#6e7a8a}
</style>
</head>
<body>
<div class="wrap">
  <div class="search">
    <div class="row">
      <span class="badge">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</span>
      <div class="api">API: <span id="apiBaseTxt">https://satoshi-proxy.mujukno1.workers.dev/api</span></div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="q" placeholder="ê²€ìƒ‰: í•œê¸€ëª… / ì‹¬ë³¼ / ë§ˆì¼“ì½”ë“œ (ì˜ˆ: ì—ì´ë‹¤, ADA, KRW-ADA, ì‹œë°”ì´ëˆ„, SHIB, KRW-SHIB)" />
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
  </div>

  <div class="grid">
    <!-- SPARK -->
    <section class="card" id="sparkCard">
      <div class="title">SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸ ğŸ”¥ <small>(ê³ ì •)</small></div>
      <div class="pillrow" style="margin-top:8px">
        <span class="pill badge">ì˜ˆì—´ ì¡°ê±´: RVOLâ‰¥1.8 Â· TBRâ‰¥0.60 Â· OBIâ‰¥+0.15 Â· ìµœê·¼5ë¶„ ë³€ë™ë¥ â‰¥+1.5% (4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ í™•ì •)</span>
      </div>
      <div id="sparkList" class="list"></div>
      <div id="sparkEmpty" class="reserve" hidden>ì˜ˆì—´ ì½”ì¸ì„ íƒìƒ‰ì¤‘â€¦</div>
    </section>

    <!-- ULTRA -->
    <section class="card">
      <div class="title" id="ultraTitle">ULTRA ì‹œê·¸ë„ â€” ì„ íƒëœ ì½”ì¸</div>
      <div class="ultra">
        <div class="box"><div class="k">í˜„ì¬ê°€</div><div class="v" id="v_price">-</div></div>
        <div class="box"><div class="k">ë§¤ìˆ˜ (BUY1)</div><div class="v" id="v_buy1">-</div></div>
        <div class="box"><div class="k">ì¶”ê°€ë§¤ìˆ˜ (BUY2)</div><div class="v" id="v_buy2">-</div></div>
        <div class="box"><div class="k">ìµì ˆ 1 (TP1)</div><div class="v" id="v_tp1">-</div></div>
        <div class="box"><div class="k">ìµì ˆ 2 (TP2)</div><div class="v" id="v_tp2">-</div></div>
        <div class="box"><div class="k">ì†ì ˆ (SL)</div><div class="v" id="v_sl">-</div></div>
      </div>
      <div class="pillrow" style="margin-top:10px">
        <span class="pill badge">ì˜ˆì—´ê°•ë„ <b id="chip_heat">0</b></span>
        <span class="pill badge">ìƒìŠ¹í™•ë¥  <b id="chip_prob">0%</b></span>
        <span class="pill badge">ì˜ˆìƒìƒìŠ¹ë¥  <b id="chip_gain">+0%</b></span>
        <span class="pill badge">ìœ„í—˜ë„ <b id="chip_risk">-</b></span>
        <span class="pill badge">ë˜ëŒë¦¼ <b id="chip_pull">0%</b></span>
      </div>
      <div class="note" id="z_msg">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </section>
  </div>

  <footer>
    ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 Â· Precision Boost Â· ForceIndex_AI Â· Bull/Bear Mode Â· Free Alpha Pack Â· ë˜ëŒë¦¼% Â· No-Motion DOM Patch
  </footer>
</div>

<script>
/** =========================
 *  ì‚¬í† ì‹œì˜ì§€ê°‘ v10.5 â€” ë‹¨ì¼íŒŒì¼
 *  KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion
 *  ========================= */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
document.getElementById('apiBaseTxt').textContent = API_BASE;

/* ---------- ìœ í‹¸ (No-Motion: DOM ê°’ë§Œ ê°±ì‹ ) ---------- */
const $ = (sel)=>document.querySelector(sel);
function setTxt(el, v){ if(el && el.textContent!==v) el.textContent=v; }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
const fmtKRW = (n)=> {
  if(n==null || isNaN(n)) return '-';
  const abs = Math.abs(n);
  if (abs >= 1000) return Math.round(n).toLocaleString('ko-KR')+'ì›';
  if (abs >= 1)   return (Math.round(n*100)/100).toLocaleString('ko-KR')+'ì›';
  if (abs >= 0.1) return (Math.round(n*1000)/1000).toLocaleString('ko-KR')+'ì›';
  if (abs >= 0.01) return (Math.round(n*10000)/10000).toLocaleString('ko-KR')+'ì›';
  if (abs >= 0.001) return (Math.round(n*100000)/100000).toLocaleString('ko-KR')+'ì›';
  return (Math.round(n*1000000)/1000000).toLocaleString('ko-KR')+'ì›';
};
/* ì—…ë¹„íŠ¸ KRW í˜¸ê°€í‹± (ê°„ì´í…Œì´ë¸” â€” ì €ê°€ 0.0001 ê¹Œì§€ ì§€ì›) */
function upbitTick(price){
  if (price >= 2000000) return 1000;
  if (price >= 1000000) return 500;
  if (price >= 500000)  return 100;
  if (price >= 100000)  return 50;
  if (price >= 10000)   return 10;
  if (price >= 1000)    return 1;
  if (price >= 100)     return 0.1;
  if (price >= 10)      return 0.01;
  if (price >= 1)       return 0.001;
  return 0.0001; // ì´ˆì €ê°€
}
function roundTick(price){
  const t = upbitTick(price);
  return Math.round(price / t) * t;
}
/* í¼ì„¼íŠ¸ ê°€ê²© ê³„ì‚° í›„ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼ */
function pricePct(base, pct){ return roundTick(base * (1 + pct)); }

/* ---------- ë°ì´í„° ìš”ì²­ ---------- */
async function jget(path){
  try{
    const r = await fetch(API_BASE + path, { headers:{'accept':'application/json'} });
    if(!r.ok) throw new Error(r.statusText);
    const d = await r.json();
    if(d && d.ok===false && d.error) throw new Error(d.error);
    return d;
  }catch(e){
    console.error('API ERR', path, e);
    return null;
  }
}

/* ---------- ë§ˆì¼“ ëª©ë¡(í•œê¸€/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ë§¤í•‘) ---------- */
let MARKET_LIST = []; // [{market:'KRW-ADA', korean_name:'ì—ì´ë‹¤', english_name:'ADA'}]
async function loadMarkets(){
  if (MARKET_LIST.length) return MARKET_LIST;
  // ì›Œì»¤ì˜ ì—…ë¹„íŠ¸ ë¦¬ìŠ¤íŠ¸ í”„ë¡ì‹œ
  const d = await jget('/upbit/tickers');
  if (Array.isArray(d?.items)) {
    MARKET_LIST = d.items;
  }
  return MARKET_LIST;
}
function resolveMarket(input){
  if (!input) return null;
  const s = input.trim().toUpperCase();
  if (s.startsWith('KRW-')) return s; // ë§ˆì¼“ì½”ë“œ ì§ì ‘ì…ë ¥
  // ì˜ë¬¸ ì‹¬ë³¼ ìš°ì„ 
  const sym = MARKET_LIST.find(x => (x.english_name||'').toUpperCase() === s);
  if (sym) return sym.market;
  // í•œê¸€ëª… ë¶€ë¶„ì¼ì¹˜
  const kor = MARKET_LIST.find(x => (x.korean_name||'').includes(input.trim()));
  if (kor) return kor.market;
  return null;
}

/* ---------- SPARK TOP10 ---------- */
async function loadSpark(){
  const listEl = $('#sparkList'); const emptyEl = $('#sparkEmpty');
  const d = await jget('/spark/top?window=5m&limit=10');
  listEl.innerHTML = '';
  if(!Array.isArray(d?.list) || d.list.length===0){
    emptyEl.hidden = false; return;
  }
  emptyEl.hidden = true;
  d.list.forEach((it)=>{
    const row = document.createElement('div'); row.className = 'item';
    // ì´ë¦„
    const n = document.createElement('div'); n.className='name';
    n.innerHTML = `<b>${(it.korean_name||it.market||'').replace('KRW-','KRW-')}</b>
                   <small style="color:var(--muted)">${it.market||''}</small>`;
    // ì˜¤ë¥¸ìª½ ìˆ˜ì¹˜
    const r = document.createElement('div');
    const priceTxt = fmtKRW(Number(it.price||0));
    const pill = `<div class="pillrow" style="justify-content:flex-end">
        <span class="pill" title="SPARK ì ìˆ˜">${'SPARK ' + (it.spark||0)}</span>
        <span class="pill" title="RVOL">RVOL ${(it.rvol??0).toFixed?.(2) ?? it.rvol}</span>
        <span class="pill" title="TBR">${'TBR ' + (Math.round((it.tbr||0)*100))+'%'}</span>
      </div>`;
    r.innerHTML = `<div style="text-align:right">${priceTxt}</div>
                   <div class="bar" aria-hidden="true"><span style="width:${clamp(it.spark||0,0,100)}%"></span></div>
                   ${pill}`;
    row.appendChild(n); row.appendChild(r);
    row.addEventListener('click',()=> openUltra(it.market, it));
    listEl.appendChild(row);
  });
}

/* ---------- ë˜ëŒë¦¼(%) ê³„ì‚° (ì‹ í˜¸ì— ìº”ë“¤ ì œê³µì‹œ ê³„ì‚°, ì—†ìœ¼ë©´ ì¶”ì •ì¹˜/ë¹„ê³µê°œ) ---------- */
function computeRetracement(candles){
  if(!Array.isArray(candles) || candles.length===0) return null;
  // ìµœê·¼ 15ë¶„(ê°€ê¸‰ì  1ë¶„ë´‰ 15ê°œ) ê¸°ì¤€
  const L = candles.slice(-15);
  let H = -Infinity, Lw = Infinity, C = L[L.length-1]?.close ?? null;
  L.forEach(c=>{ if(c.high>H) H=c.high; if(c.low<Lw) Lw=c.low; });
  if (C==null || H===-Infinity || Lw===Infinity || H===Lw) return null;
  const R = ( (H - C) / (H - Lw) ) * 100; // (Hâˆ’C)/(Hâˆ’L)Ã—100
  const band = R<35 ? 'ì–•ìŒ' : R<65 ? 'ë³´í†µ' : 'ê¹ŠìŒ';
  return { R: Math.max(0, Math.min(100, R)), band };
}

/* ---------- ì©”ì–´í•œë§ˆë”” ìƒì„± (ë¶ˆì¥/í•˜ë½ì¥/ì¡°ì • + ì¹© ì„¸íŠ¸) ---------- */
function makeZMsg(sig){
  // ëª¨ë“œ ì¶”ì •: ForceIndex, RVOL, TBR, ê¹€í”„/í€ë”© ë“±ì´ ì˜¤ë©´ ë” ì •í™•; í•„ë“œëŠ” ì›Œì»¤ ì‹ í˜¸ë¥¼ ë”°ë¦„
  const force = Number(sig.forceIndex||sig.force||0); // 0~100
  const rvol  = Number(sig.rvol||0);
  const tbr   = Number(sig.tbr||0);
  const prob  = clamp(Math.round(Number(sig.prob_up||sig.winrate||0)),0,100);
  const gain  = Number(sig.expected_gain||sig.exp_gain||0); // %
  let mode = 'ì¡°ì •';
  if ( (rvol>=2.0 && tbr>=0.65) || force>=80) mode='ë¶ˆì¥';
  else if ( (tbr<=0.45 && (sig.vwapBelow||false)) || force<=35) mode='í•˜ë½ì¥';

  const heat = clamp(Math.round(Number(sig.spark||sig.heat||0)),0,100);
  const words = {
    'ë¶ˆì¥': `ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „ â€” ì˜ˆì—´ê°•ë„ ${heat} / ìƒìŠ¹í™•ë¥  ${prob}% / ì˜ˆìƒìƒìŠ¹ë¥  +${gain?.toFixed?.(1) ?? 0}%`,
    'í•˜ë½ì¥': `ğŸ§Š ì„¸ë ¥ ì´íƒˆ ê°ì§€ â€” ë¹ ë¥¸ ì²­ì‚° í•„ìš” / ì˜ˆì—´ê°•ë„ ${heat} / ë°©ì–´ëª¨ë“œ`,
    'ì¡°ì •': `ğŸ”µ ë˜ëŒë¦¼ ì‹ í˜¸ ê°ì§€ â€” ë¶„í• ë§¤ìˆ˜ 1ì°¨ í™•ì¸ / ì˜ˆì—´ê°•ë„ ${heat} / ì¤‘ë¦½`
  };
  return {mode, msg: words[mode], heat, prob, gain};
}

/* ---------- ULTRA ì‹œê·¸ë„ ì—´ê¸° ---------- */
async function openUltra(market, seed){
  if(!market) return;
  // ì‹ í˜¸ ë¶ˆëŸ¬ì˜¤ê¸° (ì›Œì»¤: /ultra/signal?market=KRW-XXX)
  const sig = await jget('/ultra/signal?market=' + encodeURIComponent(market)) || {};
  // ë…¸ì´ì¦ˆ ì—†ì´ seed ê°’ë„ ë³´ì™„
  const s = Object.assign({}, seed||{}, sig||{});
  const nameKor = s.korean_name || s.name_kr || s.name || market;
  setTxt($('#ultraTitle'), `ULTRA ì‹œê·¸ë„ â€” ${nameKor} (${market})`);

  // ê°€ê²© ë° íƒ€ì  (ì›Œì»¤ê°€ ì§ì ‘ ì£¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê·œì¹™ ê¸°ë°˜ ì‚°ì¶œ)
  const price = Number(s.price || s.last || s.close || 0) || 0;
  const buy1  = s.buy1!=null ? Number(s.buy1) : roundTick(price * (1 - 0.003)); // Câˆ’0.3%
  const buy2  = s.buy2!=null ? Number(s.buy2) : roundTick(price * (1 - 0.008)); // Câˆ’0.8%

  // ëª¨ë“œë³„ TP/SL ìë™í™”: ì›Œì»¤ ì‹ í˜¸ ìš°ì„  â†’ ì—†ìœ¼ë©´ ê·œì¹™
  let tp1 = s.tp1, tp2 = s.tp2, sl = s.sl;
  if (tp1==null || tp2==null || sl==null){
    // Precision Boost + Bull/Bear rule ê·¼ì‚¬ (ê°„ì´)
    const force = Number(s.forceIndex||s.force||0);
    const rvol  = Number(s.rvol||0);
    const tbr   = Number(s.tbr||0);
    const bull  = (rvol>=2 && tbr>=0.65) || force>=80;
    const bear  = (tbr<=0.45) || force<=35;
    if (bull){
      tp1 = pricePct(price, 0.016); // +1.6%
      tp2 = pricePct(price, 0.028); // +2.8%
      sl  = pricePct(price,-0.008); // -0.8%
    }else if (bear){
      tp1 = pricePct(price, 0.006);
      tp2 = pricePct(price, 0.010);
      sl  = pricePct(price,-0.013);
    }else{
      tp1 = pricePct(price, 0.012);
      tp2 = pricePct(price, 0.020);
      sl  = pricePct(price,-0.010);
    }
  }

  setTxt($('#v_price'), fmtKRW(price));
  setTxt($('#v_buy1'), fmtKRW(buy1));
  setTxt($('#v_buy2'), fmtKRW(buy2));
  setTxt($('#v_tp1'), fmtKRW(tp1));
  setTxt($('#v_tp2'), fmtKRW(tp2));
  setTxt($('#v_sl'),  fmtKRW(sl));

  // ì¹©/ë©˜íŠ¸
  const z = makeZMsg(s);
  setTxt($('#chip_heat'), z.heat);
  setTxt($('#chip_prob'), `${z.prob}%`);
  setTxt($('#chip_gain'), `+${(z.gain??0).toFixed?.(1) ?? 0}%`);
  setTxt($('#chip_risk'), s.risk_level!=null ? String(s.risk_level) : (z.mode==='ë¶ˆì¥'? '2' : z.mode==='í•˜ë½ì¥'?'4':'3'));

  let retr = null;
  if (Array.isArray(s.candles)) retr = computeRetracement(s.candles);
  // ì›Œì»¤ê°€ R% ì œê³µí•˜ë©´ ìš°ì„  ì‚¬ìš©
  if (s.retracement_percent!=null){ retr = { R:Number(s.retracement_percent), band:s.retr_band||''}; }
  if (retr){ setTxt($('#chip_pull'), `${retr.R.toFixed(0)}% ${retr.band||''}`); }
  else { setTxt($('#chip_pull'), `-`); }

  setTxt($('#z_msg'), z.msg);
}

/* ---------- ê²€ìƒ‰ â†’ ULTRA ìë™ ê°±ì‹  ---------- */
async function doSearch(){
  const q = $('#q').value.trim();
  if(!q) return;
  await loadMarkets();
  let market = resolveMarket(q);
  // SPARKì— ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê°•ì œ ULTRA ë¡œë“œ (fallback)
  if (!market){
    // ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±: KRW- ì ‘ë‘ ìë™ ë¶€ì—¬ ì‹œë„
    const u = q.toUpperCase();
    market = (u.length<=6 && !u.includes('-')) ? ('KRW-'+u) : null;
  }
  if (!market){ alert('ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í•œê¸€/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”)'); return; }
  // SPARK ì¢Œì¸¡ ëª©ë¡ì— ì„ì‹œ ì¹´ë“œ ìƒì„±(UX): ì¤‘ë³µ ìƒì„± ë°©ì§€
  ensureTempSparkCard(market);
  openUltra(market,null);
}
function ensureTempSparkCard(market){
  const listEl = $('#sparkList');
  if (![...listEl.querySelectorAll('.item')].some(x=>x.dataset.m===market)){
    const row = document.createElement('div'); row.className='item'; row.dataset.m=market;
    const n = document.createElement('div'); n.className='name';
    n.innerHTML = `<b>${market}</b><small style="color:var(--muted)">ê²€ìƒ‰ ì„ íƒ</small>`;
    const r = document.createElement('div'); r.innerHTML = `<div style="text-align:right">-</div>
        <div class="bar"><span style="width:0%"></span></div>
        <div class="pillrow" style="justify-content:flex-end"><span class="pill">SPARK 0</span></div>`;
    row.appendChild(n); row.appendChild(r); row.addEventListener('click',()=>openUltra(market,null));
    listEl.prepend(row);
  }
}

/* ---------- ì´ˆê¸° ë¡œë“œ ---------- */
$('#btnSearch').addEventListener('click', doSearch);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

(async function boot(){
  // pingìœ¼ë¡œ API ê°€ìš©ì„± ë¹ ë¥´ê²Œ ì²´í¬ (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
  jget('/ping').catch(()=>{});
  await loadMarkets();
  await loadSpark();
  // ì²« í‘œì‹œ: SPARK 1ìˆœìœ„ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
  const first = $('#sparkList .item');
  if (first){ first.click(); }
})();
<script>
/* ==== ì „ì—­ ì„¤ì • ==== */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';
let UPBIT_LIST = [];     // {market, korean_name, english_name}

/* ==== ì—…ë¹„íŠ¸ í˜¸ê°€í‹± + í¬ë§· ==== */
function upbitTick(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  return 0.0001; // ì €ê°€ì½”ì¸(ì‹œë°”ì´ëˆ„ ë“±)
}
function roundTick(price){
  const t = upbitTick(price);
  return Math.round(price / t) * t;
}
function fmtKRW(p){
  const t = upbitTick(p);
  const frac = t < 1 ? String(t).split('.')[1].length : 0;
  return roundTick(p).toLocaleString('ko-KR', { minimumFractionDigits: frac, maximumFractionDigits: frac }) + 'ì›';
}

/* ==== ê²€ìƒ‰ UI ë°”ì¸ë”© (í•œê¸€ ë¦¬ìŠ¤íŠ¸) ==== */
const $search = document.querySelector('#search-input') || document.querySelector('input[type="search"], .search input');
const $searchBtn = document.querySelector('#search-btn') || document.querySelector('button.search-btn, .search button');
const $dropdown = document.createElement('div');
$dropdown.style.position='absolute';
$dropdown.style.zIndex='9999';
$dropdown.style.background='#111';
$dropdown.style.border='1px solid #333';
$dropdown.style.borderRadius='8px';
$dropdown.style.padding='6px 0';
$dropdown.style.width='320px';
$dropdown.style.display='none';
document.body.appendChild($dropdown);

function placeDropdown(){
  const r = $search.getBoundingClientRect();
  $dropdown.style.left = (window.scrollX + r.left) + 'px';
  $dropdown.style.top  = (window.scrollY + r.bottom + 6) + 'px';
  $dropdown.style.width = r.width + 'px';
}
window.addEventListener('resize', placeDropdown);
window.addEventListener('scroll', placeDropdown);

/* ë¦¬ìŠ¤íŠ¸ ë¡œë“œ */
async function loadUpbitList(){
  try{
    const r = await fetch(`${API_BASE}/upbit/tickers`);
    const j = await r.json();
    if(j.ok) UPBIT_LIST = j.items || [];
  }catch(e){ console.warn('tickers load fail', e); }
}
loadUpbitList();

/* ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ í•œê¸€ ëª©ë¡ ë“œë¡­ë‹¤ìš´ */
function renderDropdown(q){
  if(!q){ $dropdown.style.display='none'; return; }
  const qq = q.trim().toLowerCase();
  const cand = UPBIT_LIST.filter(x=>{
    const kn = (x.korean_name||'').toLowerCase();
    const en = (x.english_name||'').toLowerCase();
    const mk = (x.market||'').toLowerCase();
    return kn.includes(qq) || en.includes(qq) || mk.includes(qq);
  }).slice(0,10);

  $dropdown.innerHTML = '';
  cand.forEach(x=>{
    const row = document.createElement('div');
    row.style.padding='8px 12px';
    row.style.cursor='pointer';
    row.onmouseenter=()=>row.style.background='#1f2937';
    row.onmouseleave=()=>row.style.background='transparent';
    row.innerHTML = `<b>${x.korean_name}</b> <span style="opacity:.7">(${x.market.replace('KRW-','')})</span>`;
    row.onclick = ()=>{ selectMarket(x); };
    $dropdown.appendChild(row);
  });
  placeDropdown();
  $dropdown.style.display = cand.length ? 'block' : 'none';
}
$search?.addEventListener('input', e=> renderDropdown(e.target.value));
document.addEventListener('click', e=>{
  if(e.target!==$search && !$dropdown.contains(e.target)) $dropdown.style.display='none';
});

/* ê²€ìƒ‰ ë²„íŠ¼(ì—”í„°) ë™ì‘ */
$search?.addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); submitSearch(); }
});
$searchBtn?.addEventListener('click', submitSearch);

function submitSearch(){
  const q = ($search?.value||'').trim();
  if(!q) return;
  // ìš°ì„  í•œê¸€ëª… ë§¤ì¹­ â†’ ë§ˆì¼“ì½”ë“œ/ì˜ë¬¸ ìˆœ
  let pick = UPBIT_LIST.find(x=> (x.korean_name||'').includes(q));
  if(!pick) pick = UPBIT_LIST.find(x=> (x.market||'').toUpperCase() === q.toUpperCase());
  if(!pick) pick = UPBIT_LIST.find(x=> (x.english_name||'').toUpperCase() === q.toUpperCase());
  if(!pick) pick = UPBIT_LIST.find(x=> (x.market||'').toUpperCase().includes(q.toUpperCase()));
  if(pick) selectMarket(pick);
}

/* ULTRA í˜¸ì¶œ + íŒ¨ë„ ì—…ë°ì´íŠ¸ */
async function selectMarket(item){
  try{
    $dropdown.style.display='none';
    if($search) $search.value = item.korean_name; // ì…ë ¥ì°½ì—ë„ í•œê¸€ëª… í‘œì‹œ

    // íŒ¨ë„ íƒ€ì´í‹€: "ULTRA ì‹œê·¸ë„ â€” {í•œê¸€ëª…} (KRW-XXX)"
    const $title = document.querySelector('.ultra-title') || document.querySelector('.ultra .title, .right .title');
    if($title){
      $title.textContent = `ULTRA ì‹œê·¸ë„ â€” ${item.korean_name} (${item.market})`;
    }

    const r = await fetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(item.market)}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'ultra fail');

    // ê°’(ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼) í‘œì‹œ
    setBox('#price-now' , fmtKRW(j.price));
    setBox('#price-buy1', fmtKRW(j.buy1));
    setBox('#price-buy2', fmtKRW(j.buy2));
    setBox('#price-tp1' , fmtKRW(j.tp1));
    setBox('#price-tp2' , fmtKRW(j.tp2));
    setBox('#price-sl'  , fmtKRW(j.sl));

    // ì¹©/ë©˜íŠ¸ ì—…ë°ì´íŠ¸(ì˜ˆ: ìœ„í—˜ë„, ë˜ëŒë¦¼%)
    setBox('#chip-risk' , `ìœ„í—˜ë„ ${j.risk_level||3}`);
    setBox('#chip-retr' , `ë˜ëŒë¦¼ ${j.retracement_percent||0}%`);
    const $ment = document.querySelector('#zzeol-ment') || document.querySelector('.ment, .comment');
    if($ment){
      const mode = j.risk_level<=2 ? 'ë¶ˆì¥' : (j.risk_level>=4 ? 'í•˜ë½' : 'ì¤‘ë¦½');
      $ment.textContent = (mode==='ë¶ˆì¥')
        ? 'ì„¸ë ¥ ì˜ˆì—´ ê°•í•¨ â€” ëˆŒë¦¼ë§¤ìˆ˜ 1ì°¨ ì§„ì…, TP ì§€ì—°'
        : (mode==='í•˜ë½')
          ? 'ì„¸ë ¥ ì´íƒˆ ê°ì§€ â€” ë¹ ë¥¸ ì²­ì‚°/ì†ì ˆ ê°•í™”'
          : 'ê´€ë§/ë˜ëŒë¦¼ ì¤‘ì‹¬ â€” ë¶„í•  ëŒ€ê¸°';
    }
  }catch(e){
    console.error(e);
    alert('ULTRA ì‹œê·¸ë„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  }
}
function setBox(sel, txt){
  const el = document.querySelector(sel);
  if(el) el.textContent = txt;
}
</script>
</body>
</html>
