<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ v12.1 ì™„ì „ì²´</title>
  <style>
    body {
      background: #0d0d0d;
      color: #fff;
      font-family: Pretendard, sans-serif;
      margin: 0;
      padding: 0;
    }
    #search {
      display: flex;
      justify-content: center;
      margin: 20px;
    }
    input {
      width: 400px;
      padding: 10px;
      border-radius: 10px;
      border: none;
      text-align: center;
    }
    section {
      background: #141414;
      border-radius: 16px;
      margin: 10px auto;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 0 8px rgba(255,255,255,0.1);
    }
    .spark-item, .ultra-box {
      background: #1c1c1c;
      border-radius: 10px;
      margin: 6px 0;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .spark-item:hover { background: #252525; }
    .price { color: #00ff9d; font-weight: 600; }
  </style>
</head>
<body>
  <div id="search">
    <input id="search-input" placeholder="ì½”ì¸ ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ì…ë ¥..." />
  </div>

  <!-- â‘  ULTRA ì‹œê·¸ë„ (ìœ„ë¡œ ì˜¬ë¦¼) -->
  <section id="ultra-section">
    <h3>âš¡ ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</h3>
    <div id="ultra-content">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜Â·ë§¤ë„Â·ì†ì ˆ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </section>

  <!-- â‘¡ SPARK TOP10 (ì•„ë˜ë¡œ ì´ë™) -->
  <section id="spark-section">
    <h3>ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€</h3>
    <div id="spark-content">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </section>

  <script>
    // ============ [ì—…ë¹„íŠ¸ í˜¸ê°€í‹± ë°˜ì˜¬ë¦¼] ============
    function roundPriceKRW(price) {
      if (price < 1) return Math.round(price * 1000) / 1000;
      if (price < 10) return Math.round(price * 100) / 100;
      if (price < 100) return Math.round(price * 10) / 10;
      if (price < 1000) return Math.round(price);
      if (price < 10000) return Math.round(price / 5) * 5;
      return Math.round(price / 10) * 10;
    }

    // ============ [SPARK ì˜ˆì—´ ë°ì´í„° ëª¨ì˜ ì˜ˆì‹œ] ============
    const sparkList = [
      { name: "ì‹œë°”ì´ëˆ„", symbol: "KRW-SHIB", price: 0.015, rvol: 4.7, force: 82, score: 91 },
      { name: "ì—í…Œë‚˜", symbol: "KRW-ENA", price: 732, rvol: 3.2, force: 74, score: 85 },
      { name: "ì•„ë¹„íŠ¸ëŸ¼", symbol: "KRW-ARB", price: 1420, rvol: 2.8, force: 88, score: 92 },
      { name: "ì²´ì¸ë§í¬", symbol: "KRW-LINK", price: 26610, rvol: 2.9, force: 69, score: 83 },
      { name: "ì˜¨ë„ì½”ì¸", symbol: "KRW-ONDO", price: 1250, rvol: 2.4, force: 80, score: 89 }
    ];

    const sparkDiv = document.getElementById("spark-content");
    sparkDiv.innerHTML = sparkList.map(c => `
      <div class="spark-item" onclick="showUltra('${c.name}','${c.symbol}',${c.price},${c.score})">
        <div>${c.name} <small>${c.symbol}</small></div>
        <div class="price">${roundPriceKRW(c.price)}ì›</div>
        <div>ì˜ˆì—´ê°•ë„ ${c.score}%</div>
      </div>
    `).join('');

    // ============ [ULTRA ì‹œê·¸ë„ â€” ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  ê³„ì‚°] ============
    function showUltra(name, symbol, current, score) {
      const ultraDiv = document.getElementById("ultra-content");

      // AI ìƒìŠ¹ë¥  ì˜ˆì¸¡ (SPARK ì˜ˆì—´ê°•ë„ ê¸°ë°˜)
      let rise = 0, fall = 0;
      if (score >= 90) { rise = 0.20; fall = 0.05; }     // í­ë°œ ì„ë°•
      else if (score >= 80) { rise = 0.10; fall = 0.06; } // ê°•ë ¥ ì˜ˆì—´
      else if (score >= 70) { rise = 0.06; fall = 0.08; } // ì˜ˆì—´
      else { rise = 0.03; fall = 0.10; }                  // ì•½ì„¸

      const buy1 = roundPriceKRW(current * (1 - fall));
      const tp1  = roundPriceKRW(current * (1 + rise));
      const tp2  = roundPriceKRW(current * (1 + rise * 1.5));
      const sl   = roundPriceKRW(current * (1 - fall * 1.2));

      let comment = "";
      if (score >= 90) comment = "ğŸ”¥ ì„¸ë ¥ ë¶„ì¶œ ì§ì „, ë‹¨ê¸° ê¸‰ë“± í™•ë¥  ë§¤ìš° ë†’ìŒ!";
      else if (score >= 80) comment = "âš¡ ê°•ë ¥ ì˜ˆì—´ êµ¬ê°„ â€” ë¶„í•  ì§„ì… ìœ íš¨.";
      else if (score >= 70) comment = "ğŸŸ¡ ì˜ˆì—´ ì‹œì‘ â€” ì¶”ì„¸ ì „í™˜ ê°€ëŠ¥ì„± ê´€ë§.";
      else comment = "âš« ê´€ë§ êµ¬ê°„ â€” ë§¤ìˆ˜ ì‹ í˜¸ ì•½í•¨.";

      ultraDiv.innerHTML = `
        <div class="ultra-box"><b>${name}</b> (${symbol})</div>
        <div class="ultra-box">í˜„ì¬ê°€: ${roundPriceKRW(current)}ì›</div>
        <div class="ultra-box">ë§¤ìˆ˜(BUY1): ${buy1}ì›</div>
        <div class="ultra-box">ìµì ˆ(TP1): ${tp1}ì› / TP2: ${tp2}ì›</div>
        <div class="ultra-box">ì†ì ˆ(SL): ${sl}ì›</div>
        <div class="ultra-box">ì˜ˆìƒìƒìŠ¹ë¥ : +${(rise*100).toFixed(1)}% / ì˜ˆìƒí•˜ë½ë¥ : âˆ’${(fall*100).toFixed(1)}%</div>
        <div class="ultra-box">ì©”ì–´í•œë§ˆë””: ${comment}</div>
      `;
    }
  </script>
  <!-- === Satoshi: Search + API wiring (ê¸°ì¡´ê¸°ëŠ¥ìœ ì§€) === -->
<style>
  .satoshi-search-wrap{display:flex;gap:8px;justify-content:center;align-items:center;margin:16px auto;max-width:720px}
  .satoshi-search{flex:1;padding:10px 14px;border-radius:10px;border:1px solid #333;background:#111;color:#eee}
  .satoshi-btn{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1f2937;color:#fff;cursor:pointer}
  .satoshi-results{max-width:720px;margin:8px auto 24px;display:grid;gap:8px}
  .satoshi-card{padding:10px 12px;border:1px solid #30363d;border-radius:12px;background:#0b0f14;color:#e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .satoshi-pill{font-size:12px;padding:3px 8px;border-radius:999px;background:#1f2937;border:1px solid #374151}
  .satoshi-msg{max-width:720px;margin:12px auto;color:#9CA3AF;font-size:14px;text-align:center}
</style>

<div id="satoshi-search-area" class="satoshi-search-wrap">
  <input id="satoshi-search-input" class="satoshi-search" placeholder="ì½”ì¸ ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ì…ë ¥â€¦ (ì˜ˆ: ì‹œë°”ì´ëˆ„, ETH, KRW-ETH)" />
  <button id="satoshi-search-btn" class="satoshi-btn">ê²€ìƒ‰</button>
</div>
<div id="satoshi-search-results" class="satoshi-results"></div>
<div id="satoshi-search-msg" class="satoshi-msg"></div>

<script>
(function(){
  // 0) API ë² ì´ìŠ¤ (ì›Œì»¤ ì£¼ì†Œ ì •í™•íˆ!)
  const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';

  // 1) í—¬ìŠ¤ì²´í¬ë¡œ ì—°ê²° í™•ì¸ í›„ ì•ˆë‚´
  async function ping(){
    try{
      const r = await fetch(`${API_BASE}/health`, {mode:'cors'});
      const j = await r.json();
      if(!j.ok) throw 0;
      msg('ì—°ê²° ì™„ë£Œ âœ…');
    }catch(e){
      msg('ì—°ê²° ì‹¤íŒ¨ âŒ (CORS ë˜ëŠ” ì›Œì»¤ ë°°í¬ í™•ì¸ í•„ìš”)');
    }
  }

  // 2) ì—…ë¹„íŠ¸ ë§ˆì¼“ ëª©ë¡ ë°›ì•„ì„œ ë¡œì»¬ ìºì‹œ
  let MARKET_CACHE = [];
  async function loadMarkets(){
    if (MARKET_CACHE.length) return MARKET_CACHE;
    const r = await fetch(`${API_BASE}/upbit/markets`);
    const j = await r.json();
    // KRW ë§ˆì¼“ë§Œ, í•œêµ­ì–´ëª… í¬í•¨
    MARKET_CACHE = (j.markets || j || [])
      .filter(m => (m.market||'').startsWith('KRW-'))
      .map(m => ({market:m.market, korean_name:m.korean_name || m.koreanName || '', english_name:m.english_name || ''}));
    return MARKET_CACHE;
  }

  // 3) ê²€ìƒ‰ ì‹¤í–‰ (ìµœëŒ€ 5ê°œ)
  async function doSearch(){
    const q = (inp.value || '').trim().toLowerCase();
    if (!q){ render([], 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    try{
      await loadMarkets();
      const matched = MARKET_CACHE.filter(m => 
        m.market.toLowerCase().includes(q) ||
        (m.korean_name||'').toLowerCase().includes(q) ||
        (m.english_name||'').toLowerCase().includes(q)
      ).slice(0,5); // 5ê°œ ì œí•œ
      if(!matched.length){ render([], 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      render(matched);
    }catch(e){
      render([], 'ê²€ìƒ‰ ì‹¤íŒ¨ (ì—°ê²° í™•ì¸ í•„ìš”)');
    }
  }

  // 4) ê²€ìƒ‰ ê²°ê³¼ ë Œë” & í´ë¦­ ì‹œ ULTRA ì‹œê·¸ë„ ë¶ˆëŸ¬ì˜¤ê¸°
  async function onPick(market){
    try{
      msg('ULTRA ì‹œê·¸ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
      const r = await fetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);
      const j = await r.json();
      msg(''); // ì•ˆë‚´ ì§€ì›€
      // í™”ë©´ ì–´ë”˜ê°€ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ULTRA ì˜ì—­ì´ ìˆë‹¤ë©´ ê°’ì„ ì±„ìš°ê³ , ì—†ìœ¼ë©´ ê°„ë‹¨íˆ ì•Œë¦¼.
      // ì—¬ê¸°ì„  ìµœì†Œ í‘œì‹œ(í˜„ì¬ê°€/BUY1/TP/SL/ì˜ˆìƒìƒìŠ¹Â·í•˜ë½ë¥ )ë§Œ ì•ˆë‚´:
      alert(
        `[${market}] ULTRA ì‹œê·¸ë„\n` +
        `í˜„ì¬ê°€: ${j.price ?? '-'}ì›\n` +
        `BUY1 : ${j.buy1 ?? '-'}ì›\n` +
        `TP1/TP2: ${j.tp1 ?? '-'} / ${j.tp2 ?? '-'}ì›\n` +
        `SL   : ${j.sl ?? '-'}ì›\n` +
        `ì˜ˆìƒìƒìŠ¹ë¥  / í•˜ë½ë¥ : ${j.exp_up ?? '-'}% / ${j.exp_down ?? '-'}%`
      );
    }catch(e){
      msg('ULTRA ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (CORS ë˜ëŠ” API ì˜¤ë¥˜)');
    }
  }

  // 5) DOM í—¬í¼
  const inp = document.getElementById('satoshi-search-input');
  const btn = document.getElementById('satoshi-search-btn');
  const box = document.getElementById('satoshi-search-results');
  const msgBox = document.getElementById('satoshi-search-msg');

  function render(list, hint=''){
    box.innerHTML = '';
    if (hint) msg(hint); else msg('');
    list.forEach(m=>{
      const row = document.createElement('div');
      row.className = 'satoshi-card';
      row.innerHTML = `
        <div>
          <div style="font-weight:600">${m.korean_name || '-'} <span class="satoshi-pill">${m.market}</span></div>
          <div style="font-size:12px;color:#9ca3af">${m.english_name || ''}</div>
        </div>
        <button class="satoshi-btn" data-market="${m.market}">ì„ íƒ</button>
      `;
      row.querySelector('button').onclick = () => onPick(m.market);
      box.appendChild(row);
    });
  }
  function msg(t){ msgBox.textContent = t || ''; }

  // 6) ì´ë²¤íŠ¸ (No-Motion: ì…ë ¥ì‹œ í™”ë©´ ì í”„ ì—†ìŒ)
  btn.addEventListener('click', doSearch);
  inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

  // ì‹œì‘ ì‹œ í—¬ìŠ¤í•‘
  ping();
})();
</script>
<!-- === /Satoshi: Search + API wiring === -->
</body>
</html>
