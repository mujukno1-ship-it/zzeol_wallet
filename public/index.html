<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사토시의지갑 — 완성판</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0b0f14;color:#dfe7ef;font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Apple Color Emoji,Segoe UI Emoji}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#111821;border:1px solid #1b2330;border-radius:12px;padding:16px}
  .title{font-weight:700;margin:0 0 12px;font-size:18px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#0e1620;border:1px solid #1c2836;border-radius:999px;padding:6px 10px;font-size:12px}
  .muted{opacity:.75}
  .grid{display:grid;gap:10px}
  .spark-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;border:1px solid #1b2330;background:#0e151d;cursor:pointer}
  .spark-item:hover{background:#101924}
  .k{font-weight:600}
  .v{opacity:.85}
  input,button{font:inherit}
  .search{display:flex;gap:8px}
  .search input{flex:1;border-radius:10px;border:1px solid #1b2330;background:#0e151d;color:#eaf2ff;padding:10px 12px;outline:none}
  .search button{border-radius:10px;border:1px solid #2a3a50;background:#132130;color:#eaf2ff;padding:10px 16px;cursor:pointer}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#0e151d;border:1px solid #1b2330;border-radius:10px;padding:12px}
  .kv .lab{font-size:12px;opacity:.7}
  .kv .val{font-weight:700;margin-top:6px}
  .ok{color:#8ef1a9}
  .bad{color:#f59e86}
  .badge{display:inline-block;border:1px solid #223246;background:#0e1620;border-radius:8px;padding:3px 8px;font-size:12px}
  .api-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;background:#f87171}
  .api-dot.on{background:#34d399}
</style>
</head>
<body>
<div class="wrap">
  <!-- 상단 헤더 / API 연결 -->
  <div class="card" style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
    <div>
      <div class="title" style="display:flex;align-items:center;gap:10px">사토시의지갑 — 대시보드
        <span id="apiDot" class="api-dot"></span>
      </div>
      <div class="muted" style="font-size:13px">KRW · 업비트 호가틱 · 한글명 · No-Motion</div>
    </div>
    <div class="search" style="max-width:520px;width:100%">
      <input id="q" placeholder="검색: 한글명/심볼 (예: 에이다, KRW-ADA, 솔라나, SHIB)" />
      <button id="btnSearch">검색</button>
    </div>
  </div>

  <!-- 중앙 2단 -->
  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="title">🔥 SPARK TOP10 — 급등 전 예열코인</div>
      <div id="sparkList" class="grid"></div>
    </div>

    <div class="card">
      <div class="title">⚡ ULTRA 시그널 — 선택된 코인</div>
      <div id="ultra">
        <div class="kvs">
          <div class="kv"><div class="lab">현재가</div><div class="val" id="v_price">-</div></div>
          <div class="kv"><div class="lab">변동률</div><div class="val" id="v_change">-</div></div>
          <div class="kv"><div class="lab">매수(BUY1)</div><div class="val" id="v_buy">-</div></div>
          <div class="kv"><div class="lab">익절 1 (TP1)</div><div class="val" id="v_tp1">-</div></div>
          <div class="kv"><div class="lab">익절 2 (TP2)</div><div class="val" id="v_tp2">-</div></div>
          <div class="kv"><div class="lab">손절 (SL)</div><div class="val" id="v_sl">-</div></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge">모드: <span id="v_mode">-</span></span>
          <span class="badge">ATR: <span id="v_atr">-</span></span>
          <span class="badge">마켓: <span id="v_market">-</span></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const LS_KEY = "API_BASE_V1";
const DEFAULT_API = "https://satoshi-proxy.mujukno1.workers.dev/api";

const API_BASE = (localStorage.getItem(LS_KEY) || DEFAULT_API).replace(/\/+$/,'');
localStorage.setItem(LS_KEY, API_BASE);

const $ = (id)=>document.getElementById(id);
const apiDot = $("apiDot");

async function apiGet(path) {
  const url = API_BASE + path;
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("API 오류: " + r.status);
  return await r.json();
}

function setDot(on){ apiDot.classList.toggle("on", !!on); }

// 초기 연결 체크
apiGet("").then(()=>setDot(true)).catch(()=>setDot(false));

// -------- SPARK --------
async function loadSpark() {
  const box = $("sparkList");
  box.innerHTML = `<div class="muted">예열 코인을 탐색중…</div>`;
  try {
    const { top } = await apiGet("/spark?limit=10");
    box.innerHTML = "";
    top.forEach(row=>{
      const li = document.createElement("div");
      li.className = "spark-item";
      li.innerHTML = `
        <div>
          <div class="k">${row.korean_name || row.market}</div>
          <div class="muted" style="font-size:12px">${row.market}</div>
        </div>
        <div style="text-align:right">
          <div class="v">${fmtPct(row.changePct)}</div>
          <div class="muted" style="font-size:12px">score ${row.score.toFixed(2)}</div>
        </div>`;
      li.onclick = ()=> showUltra(row.market);
      box.appendChild(li);
    });
  } catch(e){
    box.innerHTML = `<div class="bad">SPARK 로드 실패: ${e.message}</div>`;
  }
}

// -------- ULTRA --------
async function showUltra(market){
  try{
    const r = await apiGet(`/ultra?market=${encodeURIComponent(market)}`);
    $("v_price").textContent = fmtKRW(r.price);
    $("v_change").textContent = fmtPct(r.changePct);
    $("v_buy").textContent = fmtKRW(r.buy1);
    $("v_tp1").textContent = fmtKRW(r.tp1);
    $("v_tp2").textContent = fmtKRW(r.tp2);
    $("v_sl").textContent = fmtKRW(r.sl);
    $("v_mode").textContent = r.mode;
    $("v_atr").textContent = r.atr?.toLocaleString();
    $("v_market").textContent = r.market;
  }catch(e){
    alert("ULTRA 오류: " + e.message);
  }
}

// -------- 검색 --------
$("btnSearch").onclick = async ()=>{
  const q = $("q").value.trim();
  if(!q) return;
  // KRW- 접두가 없으면 한글/심볼을 KRW-로 추정 매핑
  let market = q.toUpperCase();
  if(!market.startsWith("KRW-")){
    // 간단 매핑: 마켓 전체에서 한글/영문/심볼 포함 일치 우선 탐색
    try{
      const res = await apiGet("/upbit/markets");
      const it = res.items || [];
      let hit = it.find(m=> m.korean_name === q) ||
                it.find(m=> m.korean_name.includes(q)) ||
                it.find(m=> m.english_name?.toUpperCase() === q) ||
                it.find(m=> m.market.endsWith("-"+q));
      market = hit?.market || ("KRW-" + q.replace(/^KRW-/i,""));
    }catch{}
  }
  showUltra(market);
};

// 유틸
function fmtPct(v){
  const n = +v;
  const s = (n>=0? "+":"") + n.toFixed(2) + "%";
  return `<span class="${n>=0?"ok":"bad"}">${s}</span>`;
}
function fmtKRW(n){
  if(n==null || isNaN(n)) return "-";
  return Math.round(n).toLocaleString() + "원";
}

// 최초 로드
loadSpark();
</script>
</body>
</html>
