<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사토시의지갑 — ULTRA & SPARK</title>
  <style>
    /* No-Motion(화면 움직임 없음) 기본 적용 */
    * { animation: none !important; transition: none !important; }
    body { margin:0; background:#0b0f14; color:#e8eef5; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; }
    .wrap { max-width:1100px; margin:56px auto 24px; padding:0 16px; }
.topbar { padding:8px 12px; }
    /* 상단 고정 검색바 */
    .topbar {
      position:fixed; top:0; left:0; right:0; z-index:9999;
      background:#0b0f14; border-bottom:1px solid #1b2430;
      padding:10px 16px; display:flex; gap:8px; align-items:center;
    }
    .badge { padding:6px 10px; border:1px solid #253044; border-radius:10px; font-size:12px; opacity:.9; }
    .search { flex:1; display:flex; gap:8px; }
    .search input {
      flex:1; background:#0e131b; color:#e8eef5; border:1px solid #253044; border-radius:10px;
      padding:10px 12px; outline:none;
    }
    .btn { background:#132033; border:1px solid #2b3a52; color:#cfe2ff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:900px){ .grid{ grid-template-columns:repeat(3,1fr); } }
    .card { background:#0e131b; border:1px solid #253044; border-radius:14px; padding:14px; min-height:84px; }
    .title { font-size:14px; color:#a6b6d1; margin-bottom:6px; }
    .val { font-size:20px; font-weight:700; }
    .sub { font-size:12px; color:#8ea3c1; margin-top:2px; }
    .sectionTitle { font-weight:800; margin:18px 0 8px; color:#dfe9f8; }
    .hint { color:#8ea3c1; font-size:12px; margin-top:12px; }
    /* SPARK 리스트 자리(기능 유지) */
    table { width:100%; border-collapse:collapse; }
    th,td { padding:8px 6px; border-bottom:1px solid #1b2430; font-size:13px; }
    th { text-align:left; color:#9db2cf; }
  </style>
</head>
<body>
  <!-- 상단 고정 바 -->
  <div class="topbar">
    <span class="badge">/health</span>
    <span class="badge">/markets</span>
    <span class="badge">/premium</span>
    <span class="badge">/onchain</span>
    <div class="search">
      <input id="q" placeholder="코인명(한글) 또는 티커(KRW-BTC) — 현재가·매수·매도·손절·위험도·쩔어한마디" />
      <button id="searchBtn" class="btn">시그널 불러오기</button>
    </div>
  </div>

  <div class="wrap">
    <!-- 시장 요약 -->
    <div class="sectionTitle">시장 요약 (김프·환율·온체인)</div>
    <div class="grid">
      <div class="card"><div class="title">KR 김치 프리미엄</div><div id="kimchi" class="val">불러오는 중…</div><div id="kimchiSub" class="sub"></div></div>
      <div class="card"><div class="title">USD/KRW 환율</div><div id="fx" class="val">불러오는 중…</div><div id="fxSub" class="sub"></div></div>
      <div class="card"><div class="title">온체인 TVL (Ethereum)</div><div id="tvl" class="val">불러오는 중…</div><div id="tvlSub" class="sub"></div></div>
    </div>

    <div class="sectionTitle" style="margin-top:22px;">⚡ SPARK (예열 코인)</div>
    <div class="card">
      <table>
        <thead><tr><th>마켓</th><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th></tr></thead>
        <tbody id="sparkWarm"><tr><td colspan="6">불러오는 중…</td></tr></tbody>
      </table>
    </div>

    <div class="sectionTitle">🔥 SPARK 단타 (급등 코인)</div>
    <div class="card">
      <table>
        <thead><tr><th>마켓</th><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th></tr></thead>
        <tbody id="sparkHot"><tr><td colspan="6">불러오는 중…</td></tr></tbody>
      </table>
    </div>

    <div class="hint">API: https://satoshi-proxy.mujukno1.workers.dev/api · KRW/업비트 호가틱 반올림 · 위험도(1~5) · 쩔어한마디</div>
  </div>

  <script>
    // ===== 프록시 베이스 =====
    const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev/api';

    async function getJSON(path){
      const r = await fetch(`${API_BASE}${path}`, { method:'GET' });
      if(!r.ok) throw new Error(`${path} -> ${r.status}`);
      return r.json();
    }

    // ===== 요약 박스 로딩 =====
    async function loadSummary(){
      try{
        const prem = await getJSON('/premium');   // 김프/환율
        const onch = await getJSON('/onchain');   // TVL

        // 김프
        const kp = prem?.premium?.kimchi_pct ?? null;
        const upbit = prem?.premium?.upbit_krw_btc ?? null;
        const ref = prem?.premium?.krw_from_usdt ?? null;
        document.getElementById('kimchi').textContent =
          kp === null ? '—' : `${kp.toFixed(2)}%`;
        document.getElementById('kimchiSub').textContent =
          (upbit && ref) ? `Upbit KRW-BTC: ${Math.round(upbit).toLocaleString()}원 · 참고환산: ${Math.round(ref).toLocaleString()}원` : '';

        // 환율
        const usdkrw = prem?.premium?.usdkrw ?? null;
        document.getElementById('fx').textContent =
          usdkrw ? `${usdkrw.toLocaleString()} KRW` : '—';
        document.getElementById('fxSub').textContent = prem?.fear_greed
          ? `Fear&Greed: ${prem.fear_greed.value} (${prem.fear_greed.classification})`
          : '';

        // TVL
        const tvl = onch?.rows?.tvl_usd ?? null;
        document.getElementById('tvl').textContent =
          tvl ? `$ ${Math.round(tvl).toLocaleString()}` : '—';
        document.getElementById('tvlSub').textContent = 'DefiLlama 기준';
      }catch(e){
        document.getElementById('kimchi').textContent = '로딩 실패';
        document.getElementById('fx').textContent = '로딩 실패';
        document.getElementById('tvl').textContent = '로딩 실패';
        console.error(e);
      }
    }

    // ===== SPARK 자리 — 기존 기능 유지(데이터는 추후 정확 신호 연동) =====
    function renderSparkPlaceholders(){
      const rowsWarm = [
        {m:'KRW-WAXP', p:'—', buy:'—', sell:'—', sl:'—', r:'3'},
        {m:'KRW-PUNDIX', p:'—', buy:'—', sell:'—', sl:'—', r:'3'},
      ];
      const rowsHot = [
        {m:'KRW-BEAM', p:'—', buy:'—', sell:'—', sl:'—', r:'4'},
        {m:'KRW-FIL', p:'—', buy:'—', sell:'—', sl:'—', r:'4'},
      ];
      const warm = document.getElementById('sparkWarm');
      const hot  = document.getElementById('sparkHot');
      warm.innerHTML = rowsWarm.map(x=>`<tr><td>${x.m}</td><td>${x.p}</td><td>${x.buy}</td><td>${x.sell}</td><td>${x.sl}</td><td>${x.r}</td></tr>`).join('');
      hot.innerHTML  = rowsHot .map(x=>`<tr><td>${x.m}</td><td>${x.p}</td><td>${x.buy}</td><td>${x.sell}</td><td>${x.sl}</td><td>${x.r}</td></tr>`).join('');
    }

    // ===== 검색(상단 고정) — 현재가·매수·매도·손절·위험도·쩔어한마디 표시 자리 유지 =====
    document.getElementById('searchBtn').addEventListener('click', async ()=>{
      const q = document.getElementById('q').value.trim();
      if(!q) return;
      // 다음 단계: /api/markets에서 KRW-티커 매칭 → 시세/타점 계산 호출
      alert(`검색: ${q}\n(다음 단계에서 현재가/매수/매도/손절/위험도/쩔어한마디 연동)`);
    });

    // 최초 렌더
    renderSparkPlaceholders();
    loadSummary();
    // 새로고침 버튼을 상단/기존 버튼과 연결해두었다면 주기적 호출도 가능 (화면깜빡임 없음)
  </script>
</body>
</html>
