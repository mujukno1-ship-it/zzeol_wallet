<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§„ê°‘ âˆ ì „ì„¤íŒ (ì‹¤ì‹œê°„ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì )</title>
<style>
  :root{
    --bg:#0d1016;--panel:#151923;--text:#e8eefc;--muted:#9aa7bd;--green:#19d18f;--red:#ff5d73;
    --amber:#ffb020;--blue:#56a8ff;--chip:#23293a;--chip-border:#2c3446;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--blue);text-decoration:none}  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:grid;gap:16px}
  .grid-2{grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid #1b2130;border-radius:14px;padding:14px 16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  h1{font-size:18px;margin:0 0 12px;display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted)}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:8px}
  .k{background:var(--chip);border:1px solid var(--chip-border);border-radius:12px;padding:12px}
  .k .t{font-size:12px;color:var(--muted)}
  .k .v{font-size:18px;margin-top:4px}
  .flex{display:flex;gap:8px;align-items:center}
  .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:#1e2636;border:1px solid #2a3346;color:#b9c6dc;font-size:12px}
  .ok{background:#0f2d27;border-color:#17443a;color:#9ce6c7}
  .warn{background:#2d260f;border-color:#4a4022;color:#ffe4a3}
  .bad{background:#2d1416;border-color:#4a2227;color:#ffb9c2}
  .searchbar{display:flex;gap:8px}
  .searchbar input{flex:1;background:#0f1420;border:1px solid #252d3f;border-radius:12px;padding:12px 14px;color:var(--text);outline:none}
  .btn{background:#1a2335;border:1px solid #2a3550;color:#cfe1ff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid #20283a;text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  th{color:#9fb0cc;font-weight:600}
  .up{color:var(--green)} .dn{color:var(--red)}
  .risk{display:inline-block;min-width:22px;text-align:center;border-radius:6px;padding:2px 6px;font-weight:700}
  .r1{background:#10361f;color:#9cf0b8}.r2{background:#103036;color:#9ce1f0}.r3{background:#362f10;color:#ffe3a1}.r4{background:#3a2010;color:#ffc0a1}.r5{background:#3a1010;color:#ffb3ba}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .small{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipbtn{padding:6px 10px;border-radius:999px;background:#1a2030;border:1px solid #293247;color:#aecdff;cursor:pointer}
  .chipbtn.active{background:#19314f;border-color:#23507e}
  .hint{font-size:12px;color:#93a3bd;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">

  <div class="row">
    <div class="card">
      <div class="section-title">
        <h1>ğŸ” ê²€ìƒ‰</h1>
        <div class="small">API ì—°ê²°: <span id="apiStatus" class="pill">ì²´í¬ì¤‘â€¦</span></div>
      </div>
      <div class="searchbar">
        <input id="q" placeholder="ì˜ˆ: BTC, ETH, ì´ë”ë¦¬ì›€, ë¹„íŠ¸ì½”ì¸ìºì‹œ, ì‹œë°”ì´ëˆ„â€¦" />
        <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
        <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
      </div>
      <div id="searchArea" class="card" style="margin-top:12px;display:none">
        <div class="section-title"><h1>ê²€ìƒ‰ ê²°ê³¼</h1><div class="small" id="searchTime"></div></div>
        <div id="searchTableWrap"></div>
      </div>
    </div>
  </div>

  <div class="row grid-2" style="margin-top:16px">
    <div class="card" id="kimchiCard">
      <h1>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</h1>
      <div class="kpi">
        <div class="k"><div class="t">ì—…ë¹„íŠ¸ KRW</div><div class="v" id="k_upbit">-</div></div>
        <div class="k"><div class="t">ê¸€ë¡œë²Œ USD</div><div class="v" id="k_global">-</div></div>
        <div class="k"><div class="t">USD/KRW</div><div class="v" id="k_fx">-</div></div>
        <div class="k"><div class="t">í”„ë¦¬ë¯¸ì—„(%)</div><div class="v" id="k_premium">-</div></div>
      </div>
      <div class="hint">ì†ŒìŠ¤: CoinGecko Â· open.er-api Â· Upbit</div>
    </div>

    <div class="card" id="tvlCard">
      <div class="section-title">
        <h1>ğŸ§  ì˜¨ì²´ì¸ TVL (ETH)</h1>
        <button class="btn" id="btnSwitchTvl">ìë™ ë¡¤ë§</button>
      </div>
      <div class="kpi">
        <div class="k"><div class="t">TVL</div><div class="v" id="tvl_val">-</div></div>
        <div class="k"><div class="t">ì†ŒìŠ¤</div><div class="v" id="tvl_src">-</div></div>
        <div class="k"><div class="t">ì—…ë°ì´íŠ¸</div><div class="v" id="tvl_ts">-</div></div>
        <div class="k"><div class="t">ìƒíƒœ</div><div class="v" id="tvl_state">-</div></div>
      </div>
      <div class="hint">DefiLlama ì¥ì•  ì‹œ /v2/chainsë¡œ ìë™ ì „í™˜</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="section-title">
        <h1>âš¡ SPARK (ê¸‰ë“± ê°ì§€ Â· ìƒë‹¨ ê³ ì • TOP 10)</h1>
        <div class="small">ìµœê·¼ 60ì´ˆ ëŒ€ë¹„ ìƒìŠ¹ë¥  ê¸°ì¤€</div>
      </div>
      <div id="sparkTableWrap"></div>
    </div>
  </div>

  <div class="row grid-2" style="margin-top:16px">
    <div class="card">
      <div class="section-title">
        <h1>â­ ê´€ì‹¬ì½”ì¸ (ìµœëŒ€ 10ê°œ)</h1>
        <div class="chips" id="favChips"></div>
      </div>
      <div id="favTableWrap"></div>
      <div class="hint">ê´€ì‹¬ì½”ì¸ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. (ê¹œë¹¡ì„ ë°©ì§€ ì ìš©)</div>
    </div>

    <div class="card">
      <div class="section-title"><h1>ğŸ—£ï¸ ì©”ì–´ í•œë§ˆë””</h1><div class="small" id="oneLineTs">-</div></div>
      <div id="oneLineBox" class="k" style="font-size:16px">-</div>
    </div>
  </div>

  <div class="small" style="text-align:center;margin:24px 0 12px;">Â© 2025 ì©”ì–´ì§„ê°‘ âˆ | ì—…ë¹„íŠ¸Â·ì˜¨ì²´ì¸Â·ê¹€í”„ ì‹¤ì‹œê°„ ì—°ë™</div>
</div>

<script>
/* === 1) í™˜ê²½ === */
const API_BASE = 'https://satoshi-proxy.mujukno1.workers.dev'; // â† â† â† ë„ˆì˜ Cloudflare Worker ì£¼ì†Œë¡œ êµì²´
const POLL_SEC  = 10;       // ì£¼ê¸°(ì´ˆ)
const SPARK_WINDOW_SEC = 60; // ìµœê·¼ nì´ˆ ëŒ€ë¹„ ê¸‰ë“± ê°ì§€ ì°½
const SPARK_LIMIT = 10;
const FAV_LIMIT = 10;

/* ì‹¬ë³¼ ì‚¬ì „(ê°„ë‹¨ ë§¤í•‘) â€” í•„ìš”ì‹œ í™•ì¥ */
const COIN_UNIVERSE = [
  {symbol:'BTC', name:'ë¹„íŠ¸ì½”ì¸'},
  {symbol:'ETH', name:'ì´ë”ë¦¬ì›€'},
  {symbol:'ETC', name:'ì´ë”ë¦¬ì›€ í´ë˜ì‹'},
  {symbol:'BCH', name:'ë¹„íŠ¸ì½”ì¸ìºì‹œ'},
  {symbol:'XRP', name:'ë¦¬í”Œ'},
  {symbol:'SOL', name:'ì†”ë¼ë‚˜'},
  {symbol:'DOGE',name:'ë„ì§€ì½”ì¸'},
  {symbol:'SHIB',name:'ì‹œë°”ì´ëˆ„'},
  {symbol:'ADA', name:'ì¹´ë¥´ë‹¤ë…¸'},
  {symbol:'LINK',name:'ì²´ì¸ë§í¬'},
  {symbol:'AVAX',name:'ì•„ë°œë€ì²´'},
  {symbol:'MATIC',name:'í´ë¦¬ê³¤'},
  {symbol:'ATOM',name:'ì½”ìŠ¤ëª¨ìŠ¤'},
  {symbol:'SUI', name:'ìˆ˜ì´'},
  {symbol:'ARB', name:'ì•„ë¹„íŠ¸ëŸ¼'}
];

/* ë¡œì»¬ ìƒíƒœ */
const priceCache = new Map(); // {symbol:{krw, ts}}
const sparkHist  = new Map(); // symbol -> array of {ts, krw}
let lastOneLine = '';

/* === 2) ìœ í‹¸ === */
const fmt = n => (n===undefined||n===null||isNaN(n))?'-':n.toLocaleString('ko-KR');
const fmtKRW = n => (n===undefined||n===null||isNaN(n))?'-':`${Math.round(n).toLocaleString('ko-KR')}ì›`;
const nowStr = () => new Date().toLocaleString('ko-KR');

function upbitTickSize(krw){
  // ì—…ë¹„íŠ¸ KRW í˜¸ê°€ë‹¨ìœ„ ê°„ì´ ê·œì¹™
  if (krw >= 2_000_000) return 1000;
  if (krw >=   200_000) return 500;
  if (krw >=    10_000) return 10;
  if (krw >=     1_000) return 1;
  if (krw >=       100) return 0.1;
  if (krw >=        10) return 0.01;
  return 0.001;
}
function roundTick(krw){
  const t=upbitTickSize(krw);
  return Math.round(krw/t)*t;
}

/* ë¦¬ìŠ¤í¬/ê²°ë¡  ê³„ì‚°(ê°„ë‹¨ ë²„ì „) */
function calcSignal(krw, usd, premiumPct){
  // ë³€ë™ì„±(í‹± ê¸°ë°˜)ê³¼ ê¹€í”„ ê¸°ë°˜ìœ¼ë¡œ ìœ„í—˜ë„ 1~5 ì‚°ì¶œ
  const tick = upbitTickSize(krw);
  const vol  = Math.min(5, Math.max(1, Math.floor((tick/Math.max(1,krw))*10000)));
  const prem = Math.abs(premiumPct||0);
  const premRisk = prem>6?5: prem>3?4: prem>1.5?3: prem>0.5?2:1;
  const risk = Math.min(5, Math.max(1, Math.round((vol+premRisk)/2)));

  // íƒ€ì (ê·¸ë¦¬ë“œ ê¸°ë°˜)
  const buy  = roundTick(krw * (risk>=4 ? 0.994 : 0.996));
  const sell = roundTick(krw * (risk>=4 ? 1.006 : 1.004));
  const stop = roundTick(krw * (risk>=4 ? 0.985 : 0.990));

  let verdict = 'ì¤‘ë¦½, ê´€ë§ êµ¬ê°„';
  if (risk<=2) verdict = 'ì•ˆì •ì , ë§¤ìˆ˜ ê°€ëŠ¥';
  if (risk>=4) verdict = 'ë§¤ë„ ì£¼ì˜, ì„¸ë ¥ êµ¬ê°„';
  return {buy,sell,stop,risk,verdict};
}

/* í…Œì´ë¸” ë Œë” (ê¹œë¹¡ì„ ë°©ì§€: í–‰ ì¬ì‚¬ìš©) */
function ensureTable(containerId){
  const el = document.getElementById(containerId);
  if (!el.dataset.ready){
    el.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ì½”ì¸</th><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´ê²°ë¡ </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>`;
    el.dataset.ready='1';
  }
  return el.querySelector('tbody');
}
function upsertRow(tbody, rowId, cells){
  let tr = tbody.querySelector(`tr[data-id="${rowId}"]`);
  if (!tr){
    tr = document.createElement('tr');
    tr.dataset.id = rowId;
    for (let i=0;i<cells.length;i++){
      tr.appendChild(document.createElement('td'));
    }
    tbody.appendChild(tr);
  }
  const tds = tr.querySelectorAll('td');
  cells.forEach((v,i)=>{ tds[i].innerHTML = v; });
}

/* === 3) API í˜¸ì¶œ === */
async function callPremium(symbol){
  const url = `${API_BASE}/api/premium?symbol=${encodeURIComponent(symbol)}`;
  const res = await fetch(url, {cache:'no-store'});
  return res.json();
}
async function callOnchain(symbol='ETH'){
  const url = `${API_BASE}/api/onchain?symbol=${encodeURIComponent(symbol)}`;
  const res = await fetch(url, {cache:'no-store'});
  return res.json();
}
async function callHealth(){
  try{
    const r = await fetch(`${API_BASE}/api/health`,{cache:'no-store'}).then(r=>r.json());
    return r.ok;
  }catch{ return false; }
}

/* === 4) ìƒë‹¨ ì¹´ë“œ === */
async function refreshKimchi(baseSymbol='BTC'){
  try{
    const j = await callPremium(baseSymbol);
    if (!j.ok) throw new Error(j.error||'premium error');
    document.getElementById('k_upbit').textContent   = fmtKRW(j.upbitPrice);
    document.getElementById('k_global').textContent  = j.global?.coingecko ? '$'+fmt(j.global.coingecko) : '-';
    document.getElementById('k_fx').textContent      = fmt(j.usdkrw);
    const pct = (j.premiumPct||0).toFixed(2);
    document.getElementById('k_premium').innerHTML   = (pct>=0?`<span class="up">+${pct}%</span>`:`<span class="dn">${pct}%</span>`);
  }catch(e){
    document.getElementById('k_upbit').textContent='-';
    document.getElementById('k_global').textContent='-';
    document.getElementById('k_fx').textContent='-';
    document.getElementById('k_premium').textContent='-';
  }
}

let tvlAuto = true;
async function refreshTVL(symbol='ETH'){
  const vEl = id('tvl_val'), sEl=id('tvl_src'), tEl=id('tvl_ts'), st=id('tvl_state');
  try{
    const j = await callOnchain(symbol);
    if (!j.ok) throw new Error(j.error||'onchain error');
    vEl.textContent = '$'+fmt(j.tvl||0);
    sEl.textContent = j.src||'-';
    tEl.textContent = j.updatedAt ? new Date(j.updatedAt).toLocaleString('ko-KR'): nowStr();
    st.innerHTML    = `<span class="pill ok">ì •ìƒ</span>`;
  }catch(e){
    vEl.textContent='-'; sEl.textContent='ì˜¤ë¥˜'; tEl.textContent=nowStr();
    st.innerHTML = `<span class="pill bad">ì˜¤ë¥˜</span>`;
  }
}
function id(x){return document.getElementById(x);}

/* === 5) ê´€ì‹¬ì½”ì¸ === */
function loadFav(){ try{ return JSON.parse(localStorage.getItem('favCoins')||'[]'); }catch{return []}}
function saveFav(arr){ localStorage.setItem('favCoins', JSON.stringify(arr.slice(0,FAV_LIMIT))); drawFavChips(); }
function addFav(sym){ const f=loadFav(); if (!f.includes(sym)){ f.unshift(sym); saveFav(f); } }
function removeFav(sym){ saveFav(loadFav().filter(s=>s!==sym)); }
function drawFavChips(){
  const box = id('favChips'); box.innerHTML='';
  const f = loadFav();
  if (f.length===0){ box.innerHTML='<span class="small">ì•„ì§ ê´€ì‹¬ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</span>'; return; }
  f.forEach(s=>{
    const b = document.createElement('button'); b.className='chipbtn active'; b.textContent=s;
    b.onclick=()=>{ removeFav(s); };
    box.appendChild(b);
  });
}

/* ê´€ì‹¬ì½”ì¸ í‘œ ê°±ì‹  */
async function refreshFav(){
  const tbody = ensureTable('favTableWrap');
  const fav = loadFav();
  for (const s of fav){
    const row = await calcRow(s);
    upsertRow(tbody, 'fav-'+s, row);
  }
}

/* === 6) SPARK (ê¸‰ë“± ê°ì§€) === */
function updateSparkHistory(symbol, krw){
  const arr = sparkHist.get(symbol) || [];
  const now = Date.now();
  const cutoff = now - SPARK_WINDOW_SEC*1000;
  const arr2 = arr.filter(x=>x.ts>=cutoff);
  arr2.push({ts:now, krw});
  sparkHist.set(symbol, arr2);
  const first = arr2[0]?.krw ?? krw;
  const pct = (krw-first)/first*100;
  return pct;
}
async function refreshSpark(){
  const tbody = ensureTable('sparkTableWrap');
  const picks = COIN_UNIVERSE.slice(0,30); // ê°„ë‹¨íˆ ìƒìœ„ 30 ì¢…ëª© ìŠ¤ìº”
  const rows = [];
  for (const c of picks){
    try{
      const j = await callPremium(c.symbol);
      if (!j.ok) continue;
      const krw = j.upbitPrice||0;
      const pct1m = updateSparkHistory(c.symbol, krw);
      if (pct1m>=0.8){ // ê¸‰ë“± ê¸°ì¤€ (ì¡°ì • ê°€ëŠ¥)
        const cells = await calcRowWith(j, c.symbol, krw, j.global?.coingecko, j.premiumPct);
        rows.push({symbol:c.symbol, pct:pct1m, cells});
      }
    }catch{}
  }
  rows.sort((a,b)=>b.pct-a.pct);
  const top = rows.slice(0,SPARK_LIMIT);
  top.forEach(r=> upsertRow(tbody, 'spark-'+r.symbol, r.cells));
}

/* === 7) ê²€ìƒ‰ === */
function findSymbols(q){
  const s = q.trim().toUpperCase();
  if (!s) return [];
  return COIN_UNIVERSE.filter(c=> c.symbol.includes(s) || c.name.includes(q));
}
async function onSearch(){
  const q = id('q').value;
  const res = findSymbols(q);
  const area = id('searchArea'); area.style.display='block';
  id('searchTime').textContent = nowStr();
  const tbody = ensureTable('searchTableWrap');
  if (res.length===0){
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#9fb0cc">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    return;
  }
  for (const c of res.slice(0,20)){
    const row = await calcRow(c.symbol, true);
    upsertRow(tbody, 'search-'+c.symbol, row);
  }
}

/* === 8) í–‰ ê³„ì‚° & ë Œë” ê³µí†µ === */
async function calcRow(symbol, showAddBtn=false){
  try{
    const j = await callPremium(symbol);
    if (!j.ok) throw new Error(j.error||'premium');
    const krw = j.upbitPrice||0;
    return await calcRowWith(j, symbol, krw, j.global?.coingecko, j.premiumPct, showAddBtn);
  }catch(e){
    const err = `<span class="pill bad">ì˜¤ë¥˜</span>`;
    const add = showAddBtn? `<button class="chipbtn" onclick="addFav('${symbol}')">ê´€ì‹¬+</button>`:'';
    return [symbol+add, '-', '-', '-', '-', `<span class="risk r5">5</span>`, err];
  }
}
async function calcRowWith(j, symbol, krw, usd, premiumPct, showAddBtn=false){
  priceCache.set(symbol,{krw,ts:Date.now()});
  const s = calcSignal(krw, usd, premiumPct);
  const add = showAddBtn? `<button class="chipbtn" onclick="addFav('${symbol}')">ê´€ì‹¬+</button>`:'';
  const riskTag = `<span class="risk r${s.risk}">${s.risk}</span>`;
  return [
    `${symbol} ${add}`,
    fmtKRW(krw),
    fmtKRW(s.buy),
    fmtKRW(s.sell),
    fmtKRW(s.stop),
    riskTag,
    s.verdict
  ];
}

/* === 9) í•œë§ˆë”” === */
function refreshOneLine(){
  // ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë©”ì‹œì§€
  const btc = priceCache.get('BTC')?.krw;
  if (!btc){ id('oneLineBox').textContent='ë°ì´í„° ìˆ˜ì§‘ì¤‘â€¦'; id('oneLineTs').textContent=nowStr(); return; }
  let msg = 'ì¤‘ë¦½ ëŒ€ê¸°';
  if (btc>170_000_000) msg = 'ìƒë‹¨ ì €í•­ êµ¬ê°„, ë¶„í•  ë§¤ë„ ìœ ë¦¬';
  else if (btc<160_000_000) msg = 'ì €ì  íƒìƒ‰, ë¶„í•  ë§¤ìˆ˜ ê´€ì ';
  lastOneLine = msg;
  id('oneLineBox').textContent = msg;
  id('oneLineTs').textContent = nowStr();
}

/* === 10) ì£¼ê¸° ê°±ì‹  === */
async function tick(){
  // API í—¬ìŠ¤
  const ok = await callHealth();
  id('apiStatus').className = 'pill ' + (ok?'ok':'bad');
  id('apiStatus').textContent = ok?'ì—°ê²° ì •ìƒ':'ì˜¤ë¥˜';

  // ìƒë‹¨ ì¹´ë“œ
  await refreshKimchi('BTC');
  await refreshTVL('ETH');

  // ê´€ì‹¬ì½”ì¸
  await refreshFav();

  // SPARK
  await refreshSpark();

  // í•œë§ˆë””
  refreshOneLine();
}

/* === 11) ì´ë²¤íŠ¸ === */
id('btnSearch').onclick = onSearch;
id('btnReset').onclick  = ()=>{ id('q').value=''; id('searchArea').style.display='none'; };
id('btnSwitchTvl').onclick = ()=>{ tvlAuto=!tvlAuto; id('btnSwitchTvl').textContent = tvlAuto?'ìë™ ë¡¤ë§':'ìˆ˜ë™'; };

/* ì´ˆê¸° ê´€ì‹¬ ìƒ˜í”Œ */
if (loadFav().length===0){ saveFav(['BTC','ETH','XRP']); } else { drawFavChips(); }

/* ë¶€íŒ… */
tick();
setInterval(tick, POLL_SEC*1000);
</script>
</body>
</html>
