<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì©”ì–´ì§€ê°‘ | ì‚¬í† ì‹œì˜ì§€ê°‘</title>
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
    h1 { color: #60a5fa; text-align: center; margin-bottom: 20px; }
    #coin-table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 8px; overflow: hidden; }
    #coin-table th, #coin-table td { padding: 10px; text-align: center; border-bottom: 1px solid #334155; }
    #coin-table th { background: #0f172a; color: #93c5fd; }
    #coin-table tr:hover { background: #334155; }
    #market-insights { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ’° ì‚¬í† ì‹œì˜ì§€ê°‘ - ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</h1>

  <table id="coin-table">
    <thead>
      <tr>
        <th>ì½”ì¸ëª…</th>
        <th>í˜„ì¬ê°€ (KRW)</th>
        <th>ë³€ë™ë¥ </th>
        <th>ê±°ë˜ëŸ‰</th>
      </tr>
    </thead>
    <tbody id="coin-body">
      <tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
    </tbody>
  </table>

  <!-- === ê¹€í”„ + ì˜¨ì²´ì¸ ì¹´ë“œ =================================== -->
  <section id="market-insights" style="margin-top:16px;">
    <div style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
      <!-- ê¹€í”„ ì¹´ë“œ -->
      <div id="kimchi-card" style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px;">
        <div style="font-weight:700; font-size:16px; margin-bottom:8px;">ğŸ‡°ğŸ‡· ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <div style="font-size:28px; font-weight:800;" id="premium-pct">--%</div>
          <span id="premium-label" style="padding:2px 8px; border-radius:999px; font-size:12px; background:#374151;">ê³„ì‚°ì¤‘</span>
        </div>
        <div style="font-size:12px; line-height:1.6;">
          <div>ì—…ë¹„íŠ¸ KRW: <b id="premium-upbit">-</b></div>
          <div>ê¸€ë¡œë²Œ KRW: <b id="premium-global">-</b></div>
          <div>Binance: <b id="premium-binance">-</b></div>
          <div>USD/KRW: <b id="premium-usdkrw">-</b></div>
          <div style="opacity:.6;" id="premium-ts">-</div>
        </div>
      </div>

      <!-- ì˜¨ì²´ì¸ ì¹´ë“œ -->
      <div id="onchain-card" style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <div style="font-weight:700; font-size:16px;">â›“ ì˜¨ì²´ì¸ ì§€í‘œ</div>
          <select id="onchain-symbol" style="background:#111827;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:4px 8px;">
            <option>ETH</option>
            <option>BTC</option>
            <option>SOL</option>
          </select>
        </div>
        <div style="font-size:12px; line-height:1.6;">
          <div>TVL: <b id="onchain-tvl">-</b></div>
          <div>í™œì„± ì£¼ì†Œìˆ˜: <b id="onchain-active">-</b></div>
          <div style="opacity:.6;" id="onchain-note">-</div>
          <div style="opacity:.6;" id="onchain-ts">-</div>
        </div>
      </div>
    </div>
  </section>
  <!-- ========================================================== -->

  <script>
    const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api";

    // === ì—…ë¹„íŠ¸ ì‹¤ì‹œê°„ ===========================================
    async function loadCoins() {
      const markets = ["KRW-BTC","KRW-ETH","KRW-XRP","KRW-SOL","KRW-ADA","KRW-DOGE","KRW-SHIB"];
      const res = await fetch(`${API_BASE}/upbit?markets=${markets.join(",")}`);
      const data = await res.json();
      const body = document.getElementById("coin-body");
      body.innerHTML = data.map(c => `
        <tr>
          <td>${c.market.replace("KRW-","")}</td>
          <td>${Number(c.trade_price).toLocaleString()} ì›</td>
          <td style="color:${c.change === "RISE" ? "#22c55e" : (c.change === "FALL" ? "#ef4444" : "#e5e7eb")}">
            ${c.change === "RISE" ? "â–²" : (c.change === "FALL" ? "â–¼" : "-")} ${(c.signed_change_rate*100).toFixed(2)}%
          </td>
          <td>${Number(c.acc_trade_volume_24h).toLocaleString()}</td>
        </tr>
      `).join("");
    }
    setInterval(loadCoins, 3000);
    loadCoins();
    // =============================================================

    // === ê¹€í”„ + ì˜¨ì²´ì¸ ============================================
    const fmtNum = (n) => (n == null || isNaN(n) ? "-" : n.toLocaleString());
    const tsToStr = (ts) => new Date(Number(ts)).toLocaleString();

    function renderPremium(d){
      const pct=document.getElementById("premium-pct"),label=document.getElementById("premium-label"),
            up=document.getElementById("premium-upbit"),gl=document.getElementById("premium-global"),
            bin=document.getElementById("premium-binance"),usd=document.getElementById("premium-usdkrw"),
            ts=document.getElementById("premium-ts");
      if(!d){ pct.textContent="--%"; label.textContent="ì˜¤ë¥˜"; return; }
      pct.textContent=`${d.premium_pct>0?"+":""}${d.premium_pct.toFixed(2)}%`;
      up.textContent=`${fmtNum(d.upbit_krw)} ì›`; gl.textContent=`${fmtNum(d.global_krw)} ì›`;
      bin.textContent=`${fmtNum(d.binance_usd)} $`; usd.textContent=`${fmtNum(d.usdkrw)} ì›/$`;
      ts.textContent=`ì—…ë°ì´íŠ¸: ${tsToStr(d.ts)}`;
      label.textContent=d.premium_pct>=0?"ê¹€í”„":"ì—­í”„";
      label.style.background=d.premium_pct>=0?"#166534":"#7f1d1d";
    }

    function renderOnchain(d){
      document.getElementById("onchain-tvl").textContent=fmtNum(d?.tvl);
      document.getElementById("onchain-active").textContent=fmtNum(d?.active_addresses);
      document.getElementById("onchain-note").textContent=d?.note||"";
      document.getElementById("onchain-ts").textContent=d?.ts?`ì—…ë°ì´íŠ¸: ${tsToStr(d.ts)}`:"";
    }

    async function updatePremium(){
      try{ const r=await fetch(`${API_BASE}/premium`); renderPremium(await r.json()); }
      catch{ renderPremium(null); }
    }

    async function updateOnchain(){
      const sym=document.getElementById("onchain-symbol").value;
      try{ const r=await fetch(`${API_BASE}/onchain?symbol=${sym}`); renderOnchain(await r.json()); }
      catch{ renderOnchain(null); }
    }

    setInterval(updatePremium,3000);
    setInterval(updateOnchain,5000);
    updatePremium(); updateOnchain();
  </script>
</body>
</html>
