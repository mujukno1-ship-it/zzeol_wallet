<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™ (ì „ì„¤íŒ)</title>
  <style>
    :root{--bg:#0f1115;--card:#161a22;--muted:#9aa4b2;--txt:#e7ecf3;--acc:#7dd3fc;--good:#22c55e;--bad:#ef4444}
    html,body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.6 system-ui,apple sd gothic neo,Segoe UI}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #242c3a;border-radius:12px;padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #23324a;color:#a9c1ff;font-size:12px}
    .sec h3{margin:0 0 8px}
    .flex{display:flex;gap:8px;align-items:center}
    input{background:#0c1220;border:1px solid #273247;border-radius:10px;color:#e8f0ff;padding:10px 12px;outline:none;width:220px}
    button{background:#193253;border:1px solid #2b537f;color:#e8f0ff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kimp{font-size:28px;font-weight:700}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hint{font-size:12px;color:#8fa1b7}
    .tag{font-size:12px;color:#9fb3c8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ’° ì‚¬í† ì‹œì˜ì§€ê°‘ â€“ ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™ <span class="tag">ì „ì„¤íŒ</span></h1>

    <div class="flex" style="gap:10px;margin:10px 0 18px">
      <input id="q" placeholder="ì½”ì¸/ì‹¬ë³¼ ê²€ìƒ‰â€¦ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC, ETH)"/>
      <button id="apply">ì ìš©</button>
      <div class="muted" id="status">í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: <b class="mono" id="health">í™•ì¸ì¤‘â€¦</b></div>
    </div>

    <div class="row">
      <section class="card sec" id="sec-kimp">
        <h3>ğŸ’ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ <span class="pill mono" id="coin-pill">BTC</span></h3>
        <div class="grid" style="grid-template-columns: 160px 1fr;">
          <div class="muted">ì—…ë¹„íŠ¸ KRW:</div> <div class="mono" id="upbit">-</div>
          <div class="muted">ê¸€ë¡œë²Œ USD:</div> <div class="mono" id="g-usd">-</div>
          <div class="muted">USD/KRW:</div> <div class="mono" id="fx">-</div>
          <div class="muted">í”„ë¦¬ë¯¸ì—„(%):</div> <div class="kimp" id="kimp">-</div>
          <div class="muted">ì†ŒìŠ¤:</div> <div id="kimp-src" class="muted">-</div>
        </div>
        <div class="hint" style="margin-top:6px">CoinGecko / open.er-api.com / Upbit</div>
      </section>

      <section class="card sec" id="sec-onchain">
        <h3>ğŸ§  ì˜¨ì²´ì¸ TVL(ETH) <span class="pill">ìë™ í´ë°±</span></h3>
        <div class="grid" style="grid-template-columns: 120px 1fr;">
          <div class="muted">TVL:</div> <div class="mono" id="tvl">-</div>
          <div class="muted">ì†ŒìŠ¤:</div> <div class="muted" id="tvl-src">-</div>
        </div>
        <div class="hint" style="margin-top:6px">DefiLlama ì¥ì•  ì‹œ /v2/chainsë¡œ ìë™ ì „í™˜</div>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card sec">
        <h3>ğŸ“ ì‹œê·¸ë„</h3>
        <div class="grid" style="grid-template-columns: 120px 1fr;">
          <div class="muted">í˜„ì¬ê°€:</div> <div class="mono" id="sig-price">-</div>
          <div class="muted">ë§¤ìˆ˜:</div>   <div class="mono" id="sig-buy">-</div>
          <div class="muted">ë§¤ë„:</div>   <div class="mono" id="sig-sell">-</div>
          <div class="muted">ì†ì ˆ:</div>   <div class="mono" id="sig-stop">-</div>
          <div class="muted">ìœ„í—˜ë„:</div> <div class="mono" id="sig-risk">-</div>
        </div>
        <div class="hint" style="margin-top:6px">â€» ë‹¨ìˆœ ê³„ì‚°í˜• ì°¸ê³ ì§€í‘œ(í…ŒìŠ¤íŠ¸). ì‹¤ì œ ë§¤ë§¤ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
      </section>

      <section class="card sec">
        <h3>ğŸ’¬ ì©”ì–´ í•œë§ˆë”” <span class="pill">ë² íƒ€</span></h3>
        <div class="mono" id="one-liner">-</div>
        <div class="hint" style="margin-top:6px">ì—…ë°ì´íŠ¸: <span id="updated">-</span></div>
      </section>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="muted">ì˜êµ¬ ê³ ì •: <b>âš¡ SPARK</b> (ê´€ì‹¬ì½”ì¸ ê³ ì •í‘œì‹œ)</div>
      <div id="spark" class="mono" style="margin-top:8px">SPARK: -</div>
    </div>
  </div>

<script>
const API_BASE = (location.origin.includes("pages.dev") || location.hostname.endsWith(".pages.dev"))
  ? "https://satoshi-proxy.mujukno1.workers.dev"
  : "https://satoshi-proxy.mujukno1.workers.dev"; // í•„ìš”í•˜ë©´ ë°”ê¿”ë„ ë¨.

const $ = (id)=>document.getElementById(id);
const fmt = (n)=> Number(n).toLocaleString("ko-KR");

async function getJSON(u){ const r=await fetch(u); return r.json(); }

function symbolFromQuery(q){
  q = (q||"").trim().toUpperCase();
  if (!q) return "BTC";
  if (q.includes("ë¹„íŠ¸")) return "BTC";
  if (q.includes("ì´ë”")) return "ETH";
  if (q.includes("ì†”ë¼") || q==="SOL") return "SOL";
  return q.length<=5 ? q : "BTC";
}

function buildSignal(up, usd, fx){
  const usdk = usd*fx;
  const prem = (up/usdk - 1)*100;
  const buy  = up * (prem<-1 ? 0.992 : 0.996);
  const sell = up * (prem> 1 ? 1.008 : 1.004);
  const stop = up * 0.985;
  const risk = Math.min(99, Math.abs(prem).toFixed(1));
  return { price: up, buy, sell, stop, risk, prem };
}

async function refresh(symbol="BTC"){
  $("coin-pill").textContent = symbol;

  // health
  try {
    const h = await getJSON(`${API_BASE}/api/health`);
    $("health").textContent = h.ok? "ì •ìƒ":"ì˜¤ë¥˜";
  } catch { $("health").textContent = "ì˜¤ë¥˜"; }

  // premium
  const prem = await getJSON(`${API_BASE}/api/premium?symbol=${symbol}`);
  if (prem.ok){
    $("upbit").textContent = fmt(prem.upbitPrice)+" KRW";
    $("g-usd").textContent = fmt(prem.globalUsd)+" USD";
    $("fx").textContent   = fmt(prem.usdkrw);
    $("kimp").textContent = (prem.premiumPct>0?"+":"") + prem.premiumPct + " %";
    $("kimp").className = "kimp " + (prem.premiumPct>=0 ? "bad" : "good");
    $("kimp-src").textContent = `${prem.global} / ${prem.fx} / ${prem.krw}`;

    const s = buildSignal(prem.upbitPrice, prem.globalUsd, prem.usdkrw);
    $("sig-price").textContent = fmt(s.price)+" KRW";
    $("sig-buy").textContent   = fmt(s.buy.toFixed(0))+" KRW";
    $("sig-sell").textContent  = fmt(s.sell.toFixed(0))+" KRW";
    $("sig-stop").textContent  = fmt(s.stop.toFixed(0))+" KRW";
    $("sig-risk").textContent  = s.risk+" %";

    $("one-liner").textContent =
      s.prem>1 ? "í”„ë¦¬ë¯¸ì—„ ê³¼ì—´, ë¶„í•  ë§¤ë„ êµ¬ê°„ íƒìƒ‰"
               : s.prem<-1 ? "ì—­í”„ë¦¬ë¯¸ì—„, ë¶„í•  ë§¤ìˆ˜ êµ¬ê°„ íƒìƒ‰"
                           : "ì¤‘ë¦½ êµ¬ê°„, ê´€ë§ ë˜ëŠ” ë°•ìŠ¤ íŠ¸ë ˆì´ë”©";
    $("updated").textContent = (prem.updatedAt||"").replace("T"," ").replace("Z","");
  } else {
    $("kimp").textContent = "-"; $("kimp-src").textContent="ì˜¤ë¥˜";
  }

  // onchain (ETH ê³ ì • í‘œì‹œ, ì…ë ¥ ì‹¬ë³¼ì´ ETHë©´ ë™ì¼)
  const on = await getJSON(`${API_BASE}/api/onchain?symbol=ETH`);
  if (on.ok){
    $("tvl").textContent = fmt(on.tvl)+" USD";
    $("tvl-src").textContent = `${on.src} @ ${on.chain}`;
  } else {
    $("tvl").textContent = "-";
    $("tvl-src").textContent = "ì˜¤ë¥˜";
  }

  // SPARK ê³ ì • ë¼ë²¨(í‘œì‹œìš©, ë°ì´í„° ë” ë¶™ì´ë©´ ì´ ë¸”ë¡ í™•ì¥ ê°€ëŠ¥)
  $("spark").textContent = "SPARK: ê´€ì‹¬ì½”ì¸ ê³ ì • â€“ ì‹œê·¸ë„/ì•Œë¦¼ ì—°ë™ ì˜ˆì •";
}

$("apply").onclick = ()=>{
  const sym = symbolFromQuery($("q").value);
  refresh(sym);
};
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("apply").click(); });

refresh("BTC");
</script>
</body>
</html>
