<script>
/* ========== 유틸 ========== */
const $ = (sel) => document.querySelector(sel);
function norm(s){
  return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[-_.\/()]/g,'');
}
function symbolFromMarket(m){ const i=(m||'').indexOf('-'); return i>-1?m.slice(i+1):m; }

let MARKET_LIST = [];
let NAME_TO_MARKET = new Map();

function addAlias(key, market){
  const k = norm(key);
  if(!k) return;
  if(!NAME_TO_MARKET.has(k)) NAME_TO_MARKET.set(k, market);
}

function buildNameIndex(list){
  NAME_TO_MARKET.clear();
  list.forEach(m=>{
    if(!m.market?.startsWith('KRW-')) return;
    const sym = symbolFromMarket(m.market);
    addAlias(m.korean_name, m.market);
    addAlias(m.english_name, m.market);
    addAlias(sym, m.market);
    addAlias(m.market, m.market);
    addAlias(norm(m.korean_name), m.market);
    addAlias(norm(m.english_name), m.market);

    // 축약/별칭
    if(sym==='BTC') ['비트','비트코인','btc','bitcoin'].forEach(a=>addAlias(a,m.market));
    if(sym==='ETH') ['이더','이더리움','eth','ethereum'].forEach(a=>addAlias(a,m.market));
    if(sym==='ETC') ['이더리움클래식','클래식','etc','ethereumclassic'].forEach(a=>addAlias(a,m.market));
  });

  // 안전핀
  addAlias('이더리움','KRW-ETH'); addAlias('eth','KRW-ETH'); addAlias('ethereum','KRW-ETH'); addAlias('krweth','KRW-ETH');
  addAlias('이더리움클래식','KRW-ETC'); addAlias('etc','KRW-ETC'); addAlias('ethereumclassic','KRW-ETC'); addAlias('krwetc','KRW-ETC');
}

async function loadMarketsOnce(){
  if(MARKET_LIST.length) return MARKET_LIST;
  const r = await fetch('/api/upbit?path=/v1/market/all?isDetails=true',{cache:'no-store'});
  const data = await r.json();
  MARKET_LIST = Array.isArray(data) ? data : [];
  const krw = MARKET_LIST.filter(m=>m.market?.startsWith('KRW-'));
  buildNameIndex(krw);
  return MARKET_LIST;
}

/* ========== DOM 선택자 호환 ========== */
// 입력창/버튼이 프로젝트마다 id가 다를 수 있어서, 여러 후보를 순회합니다.
function getSearchInput(){
  return $('#searchInput') ||
         $('input[type=search]') ||
         $('input[placeholder*="코인"]') ||
         $('input[placeholder*="ETH"]') ||
         $('input[placeholder*="비트"]') ||
         $('input'); // 최후
}
function getSearchBtn(){
  return $('#searchBtn') ||
         $('button#search') ||
         $('button:contains("검색")') || // 일부 브라우저는 지원X → 아래로 대체
         Array.from(document.querySelectorAll('button')).find(b=>/검색/.test(b.textContent));
}

/* ========== 검색 실행 ========== */
async function runSearch(){
  const input = getSearchInput();
  if(!input){ alert('검색 입력창을 찾지 못했습니다.'); return; }
  const qRaw = input.value||'';
  const q = norm(qRaw);
  if(!q){ return; }

  await loadMarketsOnce();

  let market = NAME_TO_MARKET.get(q);

  if(!market){
    // 부분일치
    const list = MARKET_LIST.filter(m=>m.market?.startsWith('KRW-'));
    for(const m of list){
      const kn = norm(m.korean_name), en = norm(m.english_name), mk = norm(m.market);
      if(kn.includes(q) || en.includes(q) || mk.includes(q)){ market = m.market; break; }
    }
  }

  if(!market){
    // 축약 예외
    if(['이더','eth','ethereum','krweth'].includes(q)) market='KRW-ETH';
    else if(['클래식','etc','ethereumclassic','krwetc'].includes(q)) market='KRW-ETC';
  }

  if(!market){
    // 화면 토스트용 문구를 쓰는 프로젝트도 있어서 alert + 콘솔 같이 표시
    console.warn('[검색실패] 입력:', qRaw, '정규화:', q, '인덱스크기:', NAME_TO_MARKET.size);
    alert('코인을 찾을 수 없습니다. (한글/영문/심볼/마켓코드로 검색 가능)');
    return;
  }

  // ← 여기서 기존 코드의 “선택 코인 표시/지표갱신” 함수를 그대로 호출하세요.
  // 예) showSelectedCoin(market)
  if(typeof showSelectedCoin === 'function') showSelectedCoin(market);
  else console.log('[디버그] 선택된 마켓:', market);
}

/* ========== 초기화 ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadMarketsOnce().catch(console.error);

  const input = getSearchInput();
  const btn   = getSearchBtn();

  if(btn) btn.addEventListener('click', runSearch);
  if(input) input.addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });
});
</script>
