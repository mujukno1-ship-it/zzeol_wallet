<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ v12.0 â€” KRW Â· ì—…ë¹„íŠ¸í‹± ì™„ì „ì¼ì¹˜ Â· No-Motion</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --muted:#93a0ae; --text:#e8eef5; --line:#1a2230;
  }
  *{box-sizing:border-box; transition:none!important; animation:none!important}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Apple SD Gothic Neo,Segoe UI,Roboto}
  .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
  .title{font-weight:800;margin:0 0 12px 0}
  .sub{color:var(--muted);font-size:12px}

  /* ê²€ìƒ‰ */
  .search-bar{display:flex;gap:8px}
  .search-input{flex:1;height:44px;border-radius:12px;border:1px solid var(--line);background:#0c1219;color:var(--text);padding:0 14px;font-size:15px;outline:none}
  .chip{height:32px;border-radius:999px;border:1px solid var(--line);background:#0c1219;color:#9fb0bf;padding:0 10px;font-size:12px}
  .search-results{margin-top:10px;border:1px solid var(--line);border-radius:12px;background:#0c1219;max-height:260px;overflow:auto;width:100%}
  .sr-empty{color:var(--muted);padding:14px}
  .sr-item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-top:1px solid #0f1a26;cursor:pointer}
  .sr-item:first-child{border-top:0}
  .sr-item:hover{background:#0f1620}
  .tag{color:#8ea2b3;font-size:12px}

  /* SPARK */
  .spark-item{display:grid;grid-template-columns:1fr 90px;gap:14px;padding:10px 0;border-top:1px solid #0f1a26}
  .spark-item:first-child{border-top:0}
  .spark-name{display:flex;gap:10px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#142033;border:1px solid #1d2a3f;color:#9ec7ff;font-size:12px}
  .bar{position:relative;height:8px;border-radius:8px;background:#101926;border:1px solid #122033;overflow:hidden}
  .fill{position:absolute;inset:0;width:0%}
  .fill.orange{background:#ff9d4d} .fill.red{background:#ff6b6b} .fill.yellow{background:#ffd166}
  .price{color:#cfe6ff;text-align:right}

  /* ULTRA */
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1219;min-height:64px}
  .k{color:#8ea2b3;font-size:12px;margin-bottom:4px}
  .v{font-size:16px;font-weight:800}
  .risk-1{color:#7ddf9a}.risk-2{color:#b2f2bb}.risk-3{color:#ffd166}.risk-4{color:#ff9d4d}.risk-5{color:#ff6b6b}
  .comment{min-height:86px;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0c1219}
  .mt6{margin-top:6px}.mt10{margin-top:10px}.mt12{margin-top:12px}.mt16{margin-top:16px}

  @media (max-width:980px){.grid3{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.grid3,.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- ê²€ìƒ‰ -->
    <div class="card">
      <div class="title">ì½”ì¸ ê²€ìƒ‰ (KRW ì „ìš©) â€” í•œê¸€ëª…/ì‹¬ë³¼ ì…ë ¥</div>
      <div class="search-bar">
        <input id="search" class="search-input" placeholder="ì˜ˆ: ì‹œë°”ì´ëˆ„ / SHIB / KRW-SHIB" />
        <button class="chip">KRW ê¸°ì¤€</button>
        <button class="chip">ì—…ë¹„íŠ¸ í˜¸ê°€í‹±</button>
        <button class="chip">No-Motion</button>
      </div>
      <div id="sr" class="search-results" hidden></div>
      <div class="sub">ëª¨ë“  ì‹œì„¸/íƒ€ì ì€ <b>KRW</b>, <b>ì—…ë¹„íŠ¸ í˜¸ê°€í‹±</b> ë°˜ì˜, ì½”ì¸ëª…ì€ <b>í•œê¸€</b>. ê²€ìƒ‰ ê²°ê³¼ëŠ” ìµœëŒ€ 5ê°œ.</div>
    </div>

    <!-- ULTRA ì‹œê·¸ë„ (ê²€ìƒ‰ ë°”ë¡œ ì•„ë˜ ê³ ì •) -->
    <div class="card">
      <div class="title">ULTRA ì‹œê·¸ë„ â€” ì„ íƒí•œ ì½”ì¸</div>
      <div id="sparkMeta" class="sub"></div>
      <div id="ultraTarget" class="sub">ì½”ì¸ì„ ì„ íƒí•˜ë©´ ë§¤ìˆ˜/ìµì ˆ/ì†ì ˆ, ìœ„í—˜ë„, ì„¸ë ¥ì§€ìˆ˜, ì©”ì–´í•œë§ˆë””ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <!-- í˜„ì¬/ìœ„í—˜/ì„¸ë ¥ -->
      <div class="grid3 mt10">
        <div class="kv"><div class="k">í˜„ì¬ê°€</div><div id="v-price" class="v">-</div></div>
        <div class="kv"><div class="k">ìœ„í—˜ë„(1~5)</div><div id="v-risk" class="v">-</div></div>
        <div class="kv"><div class="k">ì„¸ë ¥ì§€ìˆ˜(ForceIndex)</div><div id="v-force" class="v">-</div></div>
      </div>

      <!-- ë‹¨ê¸° íƒ€ì  -->
      <div class="sub mt12">ë‹¨ê¸°(1~5%)</div>
      <div class="grid3 mt6">
        <div class="kv"><div class="k">ë§¤ìˆ˜(BUY1)</div><div id="v-buy1" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ(TP1)</div><div id="v-tp1" class="v">-</div></div>
        <div class="kv"><div class="k">ì†ì ˆ(SL)</div><div id="v-sl" class="v">-</div></div>
      </div>

      <!-- ì¤‘ê¸° íƒ€ì  -->
      <div class="sub mt12">ì¤‘ê¸°(8~20%)</div>
      <div class="grid2 mt6">
        <div class="kv"><div class="k">ì¶”ê°€ë§¤ìˆ˜(BUY2, ëˆŒë¦¼)</div><div id="v-buy2" class="v">-</div></div>
        <div class="kv"><div class="k">ìµì ˆ2(TP2)</div><div id="v-tp2" class="v">-</div></div>
      </div>

      <div class="comment mt16">
        <div class="k">ì©”ì–´í•œë§ˆë””</div>
        <div id="v-comment" class="v" style="font-size:14px;line-height:1.55">-</div>
      </div>
    </div>

    <!-- SPARK TOP10 -->
    <div class="card">
      <div class="title">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì‚¬ì „ ì˜ˆì—´ ê°ì§€</div>
      <div class="sub">RVOLÂ·TBRÂ·OBIÂ·ATRÂ·ForceIndex ì¢…í•©. ì˜ˆì—´â‰¥ì¡°ê±´ ì¶©ì¡± ì‹œ í‘œì‹œ. í´ë¦­í•˜ë©´ ULTRAë¡œ ì—°ë™.</div>
      <div id="spark"></div>
    </div>
  </div>

<script>
/* ========= ê¸°ë³¸ ì„¤ì • ========= */
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // ì‚¬í† ì‹œ proxy
let MARKETS = []; // KRW ë§ˆì¼“ ëª©ë¡

async function safeFetch(url, opt={}){
  const res = await fetch(url, {mode:"cors", cache:"no-store", ...opt});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ========= ì—…ë¹„íŠ¸ KRW í˜¸ê°€í‹± í…Œì´ë¸”(ì •ì‹) =========
   ì´ˆì €ê°€(ì‹œë°”ì´ëˆ„ ë“±)ê¹Œì§€ 100% ì¼ì¹˜ */
function getTickSizeKRW(p){
  const x = Number(p)||0;
  if(x >= 2000000) return 1000;
  if(x >= 1000000) return 500;
  if(x >= 500000)  return 100;
  if(x >= 100000)  return 50;
  if(x >= 10000)   return 10;
  if(x >= 1000)    return 5;
  if(x >= 100)     return 1;
  if(x >= 10)      return 0.1;
  if(x >= 1)       return 0.01;
  if(x >= 0.1)     return 0.001;
  if(x >= 0.01)    return 0.0001;
  return 0.00001;
}
function roundToTickKRW(p, dir="nearest"){
  const tick = getTickSizeKRW(p);
  const n = Number(p)||0, q = n/tick;
  let r;
  if(dir==="up") r = Math.ceil(q)*tick;
  else if(dir==="down") r = Math.floor(q)*tick;
  else r = Math.round(q)*tick;
  const dp = (tick<1) ? (tick.toString().split(".")[1]||"").length : 0;
  return Number(r.toFixed(dp));
}
function fmtKRWByTick(p){
  const tick = getTickSizeKRW(p);
  const dp = (tick<1) ? (tick.toString().split(".")[1]||"").length : 0;
  return `${Number(p).toFixed(dp)}ì›`;
}

/* ========= ë§ˆì¼“(í•œê¸€ëª… í¬í•¨) ========= */
async function loadMarkets(){
  try{
    const data = await safeFetch(`${API_BASE}/upbit/markets`);
    MARKETS = data.filter(x => x.market?.startsWith("KRW-"));
  }catch(e){ console.error("loadMarkets", e); }
}

/* ========= ê²€ìƒ‰(ìµœëŒ€ 5ê°œ, ë°•ìŠ¤í­ ë™ì¼, No-Motion) ========= */
const $search = document.getElementById('search');
const $sr = document.getElementById('sr');

$search.addEventListener('input', () => {
  const q = $search.value.trim().toLowerCase();
  if(!q){ $sr.hidden=true; $sr.innerHTML=""; return; }

  const m = MARKETS.filter(x=>{
    const s1=(x.korean_name||"").toLowerCase();
    const s2=(x.english_name||"").toLowerCase();
    const s3=(x.market||"").toLowerCase();
    return s1.includes(q)||s2.includes(q)||s3.includes(q);
  }).slice(0,5);

  if(m.length===0){ $sr.hidden=false; $sr.innerHTML=`<div class="sr-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

  $sr.hidden=false;
  $sr.innerHTML = m.map(x=>`
    <div class="sr-item" data-market="${x.market}">
      <div><b>${x.korean_name}</b> <span class="tag">(${x.market})</span></div>
      <button class="chip">ì„ íƒ</button>
    </div>
  `).join('');
});
$sr.addEventListener('click',(e)=>{
  const host = e.target.closest('.sr-item'); if(!host) return;
  selectMarket(host.getAttribute('data-market'));
});

/* ========= SPARK ì ìˆ˜ â†’ ì˜ˆìƒìƒìŠ¹ë¥ (%) & ë¼ë²¨ =========
   (ì‚¬í† ì‹œ ë©”ëª¨ë¦¬ 80Â·84 í•­ëª© ë°˜ì˜ + Precision Boost ê·¼ì‚¬) */
function expectedRiseFromScore(score,{rvol=1.0,tbr=0.5,force=50}={}){
  let base = score>=90?20:score>=80?10:score>=70?5:3;
  if(rvol>1.8) base += (rvol-1.8)*3;       // ê±°ë˜ëŸ‰ ê¸‰ì¦ ë³´ì •
  if(tbr>0.60) base += (tbr-0.60)*10;      // ì²´ê²°ê°•ë„ ë³´ì •
  if(force>70) base += (force-70)*0.10;    // ì„¸ë ¥ì§€ìˆ˜ ë³´ì •
  base = Math.max(4, Math.min(25, base));  // 4~25% ë²”ìœ„
  return Math.round(base*10)/10;
}
function sparkLabel(score){
  if(score>=90) return "í­ë°œ ì„ë°•ğŸ”¥";
  if(score>=80) return "ê°•ë ¥ ì˜ˆì—´";
  if(score>=70) return "ì˜ˆì—´";
  return "ê´€ë§";
}

/* ========= SPARK TOP10 ========= */
async function loadSpark(){
  try{
    const data = await safeFetch(`${API_BASE}/spark/top10`);
    const list = (Array.isArray(data)?data:[]).slice(0,10);

    const html = list.map(row=>{
      const price = (row.price!=null)?fmtKRWByTick(row.price):"-";
      const score = Math.max(0, Math.min(100, Math.round(Number(row.score ?? row.force_index ?? 0))));
      const w = Math.max(6, Math.min(100, score));
      const color = score>=85?"red":(score>=70?"orange":"yellow");

      const risePct = expectedRiseFromScore(score,{
        rvol:Number(row.rvol ?? 1.0),
        tbr:Number(row.tbr ?? 0.5),
        force:Number(row.force_index ?? 50)
      });
      const label = sparkLabel(score);

      return `
        <div class="spark-item" data-market="${row.market}">
          <div class="spark-name">
            <span class="badge">SPARK ${score}%</span>
            <div>
              <div><b>${row.korean_name||row.market}</b> <span class="tag">${row.market||""}</span></div>
              <div class="bar mt6"><span class="fill ${color}" style="width:${w}%"></span></div>
              <div class="sub">ì˜ˆìƒìƒìŠ¹ë¥ : <b>+${risePct}%</b> Â· AI: ${label}</div>
            </div>
          </div>
          <div class="price">${price}</div>
        </div>
      `;
    }).join('');

    const $wrap = document.getElementById('spark');
    $wrap.innerHTML = html || `<div class="sub">SPARK ë°ì´í„° ì—†ìŒ</div>`;
    $wrap.onclick = (e)=>{
      const host = e.target.closest('.spark-item'); if(!host) return;
      selectMarket(host.getAttribute('data-market'));
    };
  }catch(e){
    console.error("loadSpark", e);
    document.getElementById('spark').innerHTML = `<div class="sub">ì—°ë™ ì‹¤íŒ¨</div>`;
  }
}

/* ========= ëª¨ë“œíŒì • (ë¶ˆì¥/í•˜ë½/ë˜ëŒë¦¼) ========= */
function detectMode({rvol=0,tbr=0,force=0,aboveVWAP=false}={}){
  if(rvol>=2.0 && tbr>=0.65 && force>=80) return "bull";
  if(tbr<=0.45 || force<=35) return "bear";
  return "retrace";
}

/* ========= ì©”ì–´í•œë§ˆë””(ë¶ˆì¥Â·í•˜ë½Â·ë˜ëŒë¦¼ ìë™) ========= */
function makeComment({base,upProb,downProb,rvol,tbr,force,aboveVWAP,mode}){
  if(mode==='bull'){
    return `ë¶ˆì¥ ì‹ í˜¸ğŸ”¥ â€” RVOL ${rvol.toFixed(2)}, ì²´ê²°ê°•ë„ ${tbr.toFixed(2)}, ì„¸ë ¥ì§€ìˆ˜ ${force}.
TP2 ìš°ì„ , ì¡°ê¸°ìµì ˆ ì§€ì—°. ê³¼ì—´ êµ¬ê°„ ì£¼ì˜.`;
  }
  if(mode==='bear'){
    return `í•˜ë½ì¥ ê²½ê³„âš ï¸ â€” ì²´ê²° ì•½ì„¸(TBR ${tbr.toFixed(2)}), ì„¸ë ¥ì§€ìˆ˜ ${force}.
ì¶”ê°€ ì§„ì… ê¸ˆì§€, SL ê°•í™”, ì‹œê°„ì œí•œ ì²­ì‚° ê¶Œì¥.`;
  }
  const bias = aboveVWAP ? "VWAP ìƒë‹¨" : "VWAP í•˜ë‹¨";
  return `ë˜ëŒë¦¼ ê´€ì°°â†”ï¸ â€” ${bias}, RVOL ${rvol.toFixed(2)}.
ì˜ˆìƒ ìƒìŠ¹ +${(+upProb).toFixed(1)}%, í•˜ë½ âˆ’${(+downProb).toFixed(1)}% ê¸°ì¤€ ë¶„í• ì§„ì…/ë¶„í• ìµì ˆ.`;
}

/* ========= ULTRA ì‹œê·¸ë„ =========
   - AI ìƒìŠ¹/í•˜ë½ë¥  í¼ì„¼íŠ¸ ê¸°ë°˜ íƒ€ì 
   - ì—…ë¹„íŠ¸ í˜¸ê°€í‹±(ì €ê°€ í¬í•¨) ì •í™• ë°˜ì˜
   - ë‹¨ê¸°/ì¤‘ê¸° ë™ì‹œ í‘œì‹œ */
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=(v ?? '-'); }
function clamp(a,b,x){ return Math.max(a, Math.min(b, x)); }

async function selectMarket(market){
  try{
    document.getElementById('ultraTarget').textContent = `${market} ë¶„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`;
    const data = await safeFetch(`${API_BASE}/ultra/signal?market=${encodeURIComponent(market)}`);

    const P = Number(data.price||0);
    const force = Number(data.force_index ?? data.force ?? 0);
    const rvol  = Number(data.rvol ?? 0);
    const tbr   = Number(data.tbr ?? 0);
    const above = !!data.above_vwap;

    // SPARK_SCORE ê·¼ì‚¬
    const scoreApprox = (data.score!=null)?Number(data.score)
                       :(data.force_index!=null)?clamp(0,100,Math.round(Number(data.force_index))):0;
    // ì˜ˆì—´ ê¸°ë°˜ ì˜ˆìƒìƒìŠ¹ë¥ (%) â€” ì‚¬í† ì‹œ ë©”ëª¨ë¦¬(80Â·84) ê·œì¹™
    const risePct = expectedRiseFromScore(scoreApprox,{rvol,tbr,force});
    const label = sparkLabel(scoreApprox);

    // UI ìƒë‹¨ ë©”íƒ€
    document.getElementById('sparkMeta').textContent =
      `SPARK_SCORE: ${scoreApprox}% (${label}) Â· ì˜ˆìƒìƒìŠ¹ë¥ : +${risePct}% Â· AI íŒë‹¨ ë°˜ì˜`;

    // AI ì œê³µ up/down í¼ì„¼íŠ¸ê°€ ìˆìœ¼ë©´ ìš°ì„ , ì—†ìœ¼ë©´ ì˜ˆì—´ê¸°ë°˜
    const upP = Number((data.up_pct ?? data.upProb ?? risePct) || 0);       // ë‹¨ê¸° ê¸°ì¤€
    const dnP = Number((data.down_pct ?? data.downProb) || Math.max(3, risePct*0.4));

    // ëª¨ë“œ íŒì •
    const mode = detectMode({rvol,tbr,force,aboveVWAP:above});

    // ===== ë‹¨ê¸°(1~5%) íƒ€ì  =====
    const buy1 = roundToTickKRW(P * (1 - Math.min(0.004, dnP/100/2)), "down"); // ìµœëŒ€ 0.4% ë‹¹ê¹€
    const tp1  = roundToTickKRW(P * (1 + Math.max(0.005, upP/100*0.6)), "up"); // ìµœì†Œ 0.5% ë³´ì¥
    const sl   = roundToTickKRW(P * (1 - Math.max(0.006, dnP/100)), "down");   // ìµœì†Œ 0.6% ë°©ì–´

    // ===== ì¤‘ê¸°(8~20%) íƒ€ì  =====
    const buy2 = roundToTickKRW(P * (1 - Math.min(0.010, dnP/100)), "down");   // ëˆŒë¦¼ ì¶”ê°€ì§„ì…
    const tp2  = roundToTickKRW(P * (1 + Math.max(0.010, Math.min(0.20, upP/100*1.0))), "up");

    // ìœ„í—˜ë„(1~5): í•˜ë½í¼ì„¼íŠ¸ ê¸°ë°˜ ê·¼ì‚¬
    const risk = clamp(1,5, Math.round((Number(data.risk)||0) || (dnP/4) || 3));

    // UI ì„¸íŒ…
    document.getElementById('ultraTarget').textContent = `${(data.korean_name || market)} (${market})`;
    setText('v-price', fmtKRWByTick(P));
    const $risk = document.getElementById('v-risk'); $risk.className='v risk-'+risk; $risk.textContent=risk;
    setText('v-force', force ? force.toFixed(0) : '-');

    setText('v-buy1', fmtKRWByTick(buy1));
    setText('v-tp1',  fmtKRWByTick(tp1));
    setText('v-sl',   fmtKRWByTick(sl));

    setText('v-buy2', fmtKRWByTick(buy2));
    setText('v-tp2',  fmtKRWByTick(tp2));

    // ì©”ì–´í•œë§ˆë””
    document.getElementById('v-comment').textContent = makeComment({
      base:P, upProb:upP, downProb:dnP, rvol, tbr, force, aboveVWAP:above, mode
    });

  }catch(e){
    console.error("selectMarket", e);
    document.getElementById('ultraTarget').textContent = `ì—°ë™ ì‹¤íŒ¨ â€” ${market}`;
    document.getElementById('sparkMeta').textContent = "";
  }
}

/* ========= ì´ˆê¸° êµ¬ë™ ========= */
(async function init(){
  await loadMarkets();
  loadSpark();
  setInterval(loadSpark, 30000); // 30ì´ˆë§ˆë‹¤ SPARK ê°±ì‹  (No-Motion)
})();
</script>
</body>
</html>
