<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ âš¡ SPARK ë‹¨íƒ€ ì™„ì „ì²´</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, Apple SD Gothic Neo, Pretendard, sans-serif; background:#0d1117; color:#f0f6fc; margin:0; }
  #search-bar { position:fixed; top:0; left:0; right:0; background:#161b22; padding:10px 12px; z-index:1000; }
  #search { width:100%; padding:12px 14px; border:none; border-radius:8px; background:#21262d; color:#fff; font-size:16px; }
  .section { margin:78px 12px 16px; }
  h2 { margin:16px 0 10px; color:#58a6ff; font-size:18px; }
  .grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); }
  .card { background:#161b22; border:1px solid #30363d; border-radius:10px; padding:12px; }
  .name { font-weight:700; color:#58a6ff; }
  .row { margin-top:6px; font-size:14px; }
  .muted { color:#9da7b3; }
  .ok { color:#3fb950; } .warn { color:#d29922; } .bad { color:#f85149; } .mid{ color:#e3b341; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; border:1px solid #30363d; }
  #err { margin:6px 12px; color:#f85149; font-size:13px; display:none; }
</style>
</head>
<body>
  <div id="search-bar">
    <input id="search" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼ ê²€ìƒ‰ (ì˜ˆ: ì˜¨ë„, ì•„ì¹´ì‹œì•„, ì‹œë°”ì´ëˆ„, KRW-ACX)" />
  </div>

  <div id="err"></div>

  <div class="section">
    <h2>ğŸŒ‹ SPARK (ì˜ˆì—´ ì½”ì¸)</h2>
    <div id="spark" class="grid"><div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
  </div>

  <div class="section">
    <h2>ğŸ”¥ SPARK ë‹¨íƒ€ (ê¸‰ë“± ì½”ì¸)</h2>
    <div id="sparkHot" class="grid"><div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
  </div>

<script>
const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev/api"; // ì‚¬í† ì‹œ í”„ë¡ì‹œ
const errBox = document.getElementById('err');

const KRWround = (p) => {
  if (p >= 1000000) return (Math.round(p/100) * 100).toLocaleString();
  if (p >= 100000)  return (Math.round(p/10) * 10).toLocaleString();
  if (p >= 10000)   return Math.round(p).toLocaleString();
  if (p >= 1000)    return Math.round(p).toLocaleString();
  if (p >= 100)     return Math.round(p).toLocaleString();
  if (p >= 10)      return (Math.round(p*10)/10).toFixed(1);
  if (p >= 1)       return (Math.round(p*100)/100).toFixed(2);
  return (Math.round(p*1000)/1000).toFixed(3);
};

async function fetchFromProxy() {
  const r = await fetch(`${API_BASE}/markets`, { headers:{ accept:'application/json' } });
  if (!r.ok) throw new Error(`proxy ${r.status}`);
  const data = await r.json();
  // ê¸°ëŒ€ í¬ë§·: [{market:"KRW-XXX", korean_name:"...", trade_price:123, prev_closing_price:120}, ...]
  if (!Array.isArray(data)) throw new Error('proxy-shape');
  return data.filter(x => x.market?.startsWith('KRW-'));
}

// í´ë°±: ì—…ë¹„íŠ¸ ê³µê°œ API (CORS í—ˆìš©)
async function fetchFromUpbit() {
  // 1) ëª¨ë“  ë§ˆì¼“ ëª©ë¡(í•œê¸€ëª… í¬í•¨)
  const mres = await fetch('https://api.upbit.com/v1/market/all?isDetails=true');
  const markets = await mres.json();
  const krw = markets.filter(m => m.market.startsWith('KRW-'));
  // 2) í‹°ì»¤ ì¼ê´„ ì¡°íšŒ (200ê°œ ë‹¨ìœ„ë¡œ ë¶„í• )
  const chunk = (arr, n) => arr.reduce((a,_,i)=> (i%n? a[a.length-1].push(arr[i]):a.push([arr[i]]), a),[]);
  const chunks = chunk(krw.map(m=>m.market), 100);
  let tickers = [];
  for (const ch of chunks) {
    const tres = await fetch('https://api.upbit.com/v1/ticker?markets='+ch.join(','));
    tickers = tickers.concat(await tres.json());
  }
  // ì¡°ì¸
  const mapName = Object.fromEntries(krw.map(m=>[m.market, m.korean_name]));
  return tickers.map(t => ({
    market: t.market,
    korean_name: mapName[t.market] || t.market,
    trade_price: t.trade_price,
    prev_closing_price: t.prev_closing_price
  }));
}

async function loadData() {
  errBox.style.display='none';
  try {
    try {
      return await fetchFromProxy();
    } catch (e) {
      // í´ë°±ìœ¼ë¡œ ìë™ ì „í™˜
      const data = await fetchFromUpbit();
      errBox.textContent = 'í”„ë¡ì‹œ ì—°ê²° ë¶ˆê°€ â†’ ì—…ë¹„íŠ¸ ê³µê°œ APIë¡œ í´ë°± ì¤‘ (ì •ìƒ ë™ì‘)';
      errBox.style.display='block';
      return data;
    }
  } catch (e) {
    errBox.textContent = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + e.message;
    errBox.style.display='block';
    return [];
  }
}

function riskBadge(r){ // 1~5
  const colors = ['ğŸŸ¢','ğŸŸ¢ğŸŸ¡','ğŸŸ¡','ğŸŸ ','ğŸ”´'];
  const txt = ['ë§¤ìš° ì•ˆì •','ì•ˆì •','ë³´í†µ','ìœ„í—˜','ë§¤ìš° ìœ„í—˜'];
  return `${colors[r-1]} ${r}ë‹¨ê³„ (${txt[r-1]})`;
}

function card(item, isHot=false){
  const price = item.trade_price ?? 0;
  const prev  = item.prev_closing_price ?? price;
  const chg = ((price - prev)/prev)*100;
  // ê°„ì´ íƒ€ì (Precision Boost Mode ìë¦¬) â€” í”„ë¡ì‹œê°€ ì„¸ë¶€ì§€í‘œ ì¤„ ë•Œ ìë™ ëŒ€ì²´ ê°€ëŠ¥
  const buy = KRWround(price * (isHot ? 0.988 : 0.985));
  const sell = KRWround(price * (isHot ? 1.018 : 1.015));
  const stop = KRWround(price * (isHot ? 0.980 : 0.975));
  const risk = Math.min(5, Math.max(1,
      (isHot ? 3 + (chg>15?2:1) : (chg>5?3:2))
  ));
  const msg = isHot
    ? "í­ë“± ê°ì§€, ë¶„í• ìµì ˆ ê¶Œì¥ Â· ì¶”ê²©ë§¤ìˆ˜ ì£¼ì˜."
    : (risk<=2 ? "ì„¸ë ¥ ì˜ˆì—´ ì¤‘, ëˆŒë¦¼ ì§„ì… ì¤€ë¹„."
               : risk==3 ? "ë³€ë™ì„± í™•ëŒ€, ë¶„í• ìµì ˆ ë³‘í–‰."
                         : "ì„¸ë ¥ ì´íƒˆ ì‹ í˜¸ ê°€ëŠ¥, ë¦¬ìŠ¤í¬ ê´€ë¦¬.");

  return `
    <div class="card">
      <div class="name">${isHot?'ğŸ”¥':'ğŸŒ‹'} ${item.korean_name} <span class="badge">${item.market}</span></div>
      <div class="row">í˜„ì¬ê°€: <b>${KRWround(price)}ì›</b> <span class="muted">(${chg>=0?'+':''}${chg.toFixed(2)}%)</span></div>
      <div class="row">ë§¤ìˆ˜: ${buy}ì› / ë§¤ë„: ${sell}ì› / ì†ì ˆ: ${stop}ì›</div>
      <div class="row">ìœ„í—˜ë„: ${riskBadge(risk)}</div>
      <div class="row muted">ğŸ’¬ ì©”ì–´í•œë§ˆë””: ${msg}</div>
    </div>
  `;
}

function render(list){
  // í•„í„°: ì…ë ¥ì–´
  const q = (document.getElementById('search').value||'').trim().toLowerCase();
  const filtered = q ? list.filter(x =>
      x.korean_name?.toLowerCase().includes(q) ||
      x.market?.toLowerCase().includes(q)
  ) : list;

  // ê·¸ë£¹: ê¸‰ë“±(ë‹¨íƒ€) / ì˜ˆì—´
  const hot = filtered.filter(x=>{
    const price = x.trade_price??0, prev=x.prev_closing_price??price;
    return ((price-prev)/prev)*100 >= 10;
  });
  const warm = filtered.filter(x=>{
    const price = x.trade_price??0, prev=x.prev_closing_price??price;
    const r = ((price-prev)/prev)*100;
    return r >= 3 && r < 10;
  });

  document.getElementById('spark').innerHTML =
    warm.length ? warm.slice(0,50).map(x=>card(x,false)).join('') :
    '<div class="muted">ì˜ˆì—´ ì½”ì¸ ì—†ìŒ</div>';

  document.getElementById('sparkHot').innerHTML =
    hot.length ? hot.slice(0,50).map(x=>card(x,true)).join('') :
    '<div class="muted">ê¸‰ë“± ì½”ì¸ ì—†ìŒ</div>';
}

async function tick(){
  const data = await loadData();
  render(data);
}

document.getElementById('search').addEventListener('input', tick);

tick();
setInterval(tick, 10000); // 10ì´ˆ ì£¼ê¸° ê°±ì‹ 
</script>
</body>
</html>
