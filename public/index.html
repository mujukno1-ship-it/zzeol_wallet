<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 v10 전설판 — 실시간 타점</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Apple SD Gothic Neo, Noto Sans KR, Segoe UI, Roboto, Helvetica, Arial; background:#0f141a; color:#e8eef5;}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px;}
    h1{font-size:22px;margin:0 0 16px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{height:36px;border-radius:10px;border:1px solid #223041;background:#0c1116;color:#e8eef5;padding:0 12px;width:260px}
    button{height:36px;border-radius:10px;border:1px solid #223041;background:#16202b;color:#e8eef5;padding:0 12px;cursor:pointer}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #223041;background:#111926;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:#121922;border:1px solid #1c2633;border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:16px}
    .pair{display:flex;justify-content:space-between;margin:6px 0}
    .metric{font-weight:700}
    .small{color:#97a8ba;font-size:12px}
    .ok{color:#49d596}.warn{color:#ffd66b}.err{color:#ff7b7b}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #2a3a4d;background:#0e151d}
    footer{margin-top:16px;color:#7f8ea3;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🪙 쩔어지갑 v10 전설판 — 실시간 타점</h1>

    <div class="row">
      <input id="q" placeholder="코인/심볼 (예: BTC, ETH, 스파크, XRP)" />
      <button id="apply">적용</button>
      <span class="small">프록시 상태: <b id="health">점검중…</b></span>
      <span class="row" style="margin-left:auto;gap:6px">
        <span class="chip" data-sym="BTC">BTC</span>
        <span class="chip" data-sym="ETH">ETH</span>
        <span class="chip" data-sym="SPARK">SPARK</span>
      </span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>🍫 김치 프리미엄 <span class="badge" id="kimp-sym">BTC</span></h3>
        <div class="pair"><span>업비트 KRW</span><span class="metric" id="krw">-</span></div>
        <div class="pair"><span>글로벌 USD</span><span class="metric" id="usd">-</span></div>
        <div class="pair"><span>USD/KRW</span><span class="metric" id="fx">-</span></div>
        <div class="pair"><span>프리미엄(%)</span><span class="metric" id="kimp">-</span></div>
        <div class="small">소스: <span id="kimp-src">-</span></div>
      </div>

      <div class="card">
        <h3>🔗 온체인 TVL <span class="badge" id="oc-sym">ETH</span></h3>
        <div class="pair"><span>TVL (USD)</span><span class="metric" id="tvl">-</span></div>
        <div class="small">소스: <span id="oc-src">-</span></div>
      </div>

      <div class="card">
        <h3>💎 실시간 타점 <span class="badge" id="sig-sym">BTC</span></h3>
        <div class="pair"><span>현재가</span><span class="metric" id="p">-</span></div>
        <div class="pair"><span>매수</span><span class="metric" id="b">-</span></div>
        <div class="pair"><span>매도</span><span class="metric" id="s">-</span></div>
        <div class="pair"><span>손절</span><span class="metric" id="st">-</span></div>
        <div class="pair"><span>위험도</span><span class="metric" id="r">-</span></div>
        <div class="small">쩔어 한마디: <span id="c">-</span></div>
        <div class="small">업데이트: <span id="ts">-</span></div>
      </div>

      <div class="card">
        <h3>⚙️ 시스템 상태</h3>
        <div class="pair"><span>프록시</span><span id="h2" class="metric">-</span></div>
        <div class="pair"><span>데이터</span><span id="d2" class="metric">-</span></div>
        <div class="small">문제 시 새로고침(Ctrl+F5) 또는 잠시 후 재시도</div>
      </div>
    </div>

    <footer>
      소스: Upbit / CoinGecko / open.er-api / DefiLlama · Asia/Seoul 기준
    </footer>
  </div>

  <script>
    // ===== 설정 =====
    const API_BASE = "https://satoshi-proxy.mujukno1.workers.dev";
    const DEFAULT_KIMP = "BTC";
    const DEFAULT_ONCHAIN = "ETH";
    const FAVORITES = ["BTC", "ETH", "SPARK"];

    const $ = (id)=>document.getElementById(id);
    const nf0 = (n)=>Number(n||0).toLocaleString('ko-KR');
    const nf2 = (n)=>Number(n||0).toLocaleString('ko-KR',{maximumFractionDigits:2});

    let state = { sym: "BTC", oc: DEFAULT_ONCHAIN };

    function mapToSymbol(input){
      if(!input) return state.sym;
      const t = String(input).trim().toUpperCase();
      if (["비트","비트코인","BTC"].includes(t)) return "BTC";
      if (["이더","이더리움","ETH"].includes(t)) return "ETH";
      if (["스파크","SPARK","FLR","FLARE"].includes(t)) return "SPARK";
      return t;
    }

    // ===== 헬스체크 =====
    async function health(){
      try{
        const res = await fetch(API_BASE+"/api/health",{cache:"no-store"});
        const j = await res.json();
        const ok = j?.ok;
        $("health").textContent = ok?"정상":"오프라인";
        $("health").className = ok?"ok":"err";
        $("h2").textContent = ok?"정상":"오프라인";
        $("h2").className = "metric " + (ok?"ok":"err");
      }catch{
        $("health").textContent = "오프라인";
        $("health").className = "err";
        $("h2").textContent = "오프라인";
        $("h2").className = "metric err";
      }
    }

    // ===== 김프/온체인/시그널 =====
    async function loadKimp(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/premium?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("premium");
        $("kimp-sym").textContent = j.symbol;
        $("krw").textContent = nf0(j.upbitPrice);
        $("usd").textContent = nf2(j.globalUsd);
        $("fx").textContent  = nf2(j.usdkrw);
        $("kimp").textContent = (Number(j.premiumPct)||0).toFixed(2)+"%";
        $("kimp-src").textContent = `${j?.src?.global||"CoinGecko"} / ${j?.src?.fx||"open.er-api"} / ${j?.src?.krw||"Upbit"}`;
        $("d2").textContent = "김프/온체인/시그널 정상";
        $("d2").className = "metric ok";
      }catch(e){
        $("kimp").textContent = "-";
        $("d2").textContent = "데이터 일부 지연";
        $("d2").className = "metric warn";
      }
    }

    async function loadOnchain(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/onchain?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("onchain");
        $("oc-sym").textContent = j.symbol;
        $("tvl").textContent = nf0(j.tvlusd);
        $("oc-src").textContent = j?.src || "DefiLlama";
      }catch(e){
        $("tvl").textContent = "-";
        $("oc-src").textContent = "—";
      }
    }

    async function loadSignal(sym){
      try{
        const j = await (await fetch(`${API_BASE}/api/signal?symbol=${encodeURIComponent(sym)}`,{cache:"no-store"})).json();
        if(!j?.ok) throw new Error("signal");
        $("sig-sym").textContent = j.symbol;
        $("p").textContent  = nf0(j.price);
        $("b").textContent  = j.buy? nf0(j.buy) : "-";
        $("s").textContent  = j.sell? nf0(j.sell): "-";
        $("st").textContent = j.stop? nf0(j.stop): "-";
        $("r").textContent  = (j.risk<=2? "🟢 " : j.risk==3? "🟡 " : "🔴 ") + (j.risk??"-");
        $("c").textContent  = j.comment || "-";
        $("ts").textContent = new Date(j.ts||Date.now()).toLocaleString("ko-KR");
      }catch(e){
        $("c").textContent = "점검중…";
      }
    }

    async function refreshAll(){
      await health();
      await Promise.all([
        loadKimp(state.sym),
        loadOnchain(state.oc),
        loadSignal(state.sym),
      ]);
    }

    // 이벤트
    document.querySelectorAll(".chip").forEach(el=>{
      el.addEventListener("click", ()=>{
        const sym = el.getAttribute("data-sym");
        state.sym = sym;
        if (sym==="ETH") state.oc="ETH";
        if (sym==="BTC") state.oc="ETH";
        if (sym==="SPARK") state.oc="ETH"; // TVL 기본 ETH
        $("kimp-sym").textContent = state.sym;
        $("sig-sym").textContent  = state.sym;
        $("oc-sym").textContent   = state.oc;
        refreshAll();
      });
    });

    $("apply").addEventListener("click", ()=>{
      const mapped = mapToSymbol($("q").value);
      state.sym = mapped;
      $("kimp-sym").textContent = state.sym;
      $("sig-sym").textContent  = state.sym;
      refreshAll();
    });

    // 기본: SPARK 고정 노출 선호 시 아래 한 줄만 켬
    // state.sym = "SPARK";

    // 부팅
    (async ()=>{
      $("kimp-sym").textContent = state.sym;
      $("sig-sym").textContent = state.sym;
      $("oc-sym").textContent = state.oc;
      await refreshAll();
      setInterval(refreshAll, 10_000);
    })();
  </script>
</body>
</html>
