<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ì™„ì„±íŒ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0b0f14;color:#dfe7ef;font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Apple Color Emoji,Segoe UI Emoji}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#111821;border:1px solid #1b2330;border-radius:12px;padding:16px}
  .title{font-weight:700;margin:0 0 12px;font-size:18px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#0e1620;border:1px solid #1c2836;border-radius:999px;padding:6px 10px;font-size:12px}
  .muted{opacity:.75}
  .grid{display:grid;gap:10px}
  .spark-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;border:1px solid #1b2330;background:#0e151d;cursor:pointer}
  .spark-item:hover{background:#101924}
  .k{font-weight:600}
  .v{opacity:.85}
  input,button{font:inherit}
  .search{display:flex;gap:8px}
  .search input{flex:1;border-radius:10px;border:1px solid #1b2330;background:#0e151d;color:#eaf2ff;padding:10px 12px;outline:none}
  .search button{border-radius:10px;border:1px solid #2a3a50;background:#132130;color:#eaf2ff;padding:10px 16px;cursor:pointer}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#0e151d;border:1px solid #1b2330;border-radius:10px;padding:12px}
  .kv .lab{font-size:12px;opacity:.7}
  .kv .val{font-weight:700;margin-top:6px}
  .ok{color:#8ef1a9}
  .bad{color:#f59e86}
  .badge{display:inline-block;border:1px solid #223246;background:#0e1620;border-radius:8px;padding:3px 8px;font-size:12px}
  .api-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;background:#f87171}
  .api-dot.on{background:#34d399}
</style>
</head>
<body>
<div class="wrap">
  <!-- ìƒë‹¨ í—¤ë” / API ì—°ê²° -->
  <div class="card" style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
    <div>
      <div class="title" style="display:flex;align-items:center;gap:10px">ì‚¬í† ì‹œì˜ì§€ê°‘ â€” ëŒ€ì‹œë³´ë“œ
        <span id="apiDot" class="api-dot"></span>
      </div>
      <div class="muted" style="font-size:13px">KRW Â· ì—…ë¹„íŠ¸ í˜¸ê°€í‹± Â· í•œê¸€ëª… Â· No-Motion</div>
    </div>
    <div class="search" style="max-width:520px;width:100%">
      <input id="q" placeholder="ê²€ìƒ‰: í•œê¸€ëª…/ì‹¬ë³¼ (ì˜ˆ: ì—ì´ë‹¤, KRW-ADA, ì†”ë¼ë‚˜, SHIB)" />
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
  </div>

  <!-- ì¤‘ì•™ 2ë‹¨ -->
  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="title">ğŸ”¥ SPARK TOP10 â€” ê¸‰ë“± ì „ ì˜ˆì—´ì½”ì¸</div>
      <div id="sparkList" class="grid"></div>
    </div>

    <div class="card">
      <div class="title">âš¡ ULTRA ì‹œê·¸ë„ â€” ì„ íƒëœ ì½”ì¸</div>
      <div id="ultra">
        <div class="kvs">
          <div class="kv"><div class="lab">í˜„ì¬ê°€</div><div class="val" id="v_price">-</div></div>
          <div class="kv"><div class="lab">ë³€ë™ë¥ </div><div class="val" id="v_change">-</div></div>
          <div class="kv"><div class="lab">ë§¤ìˆ˜(BUY1)</div><div class="val" id="v_buy">-</div></div>
          <div class="kv"><div class="lab">ìµì ˆ 1 (TP1)</div><div class="val" id="v_tp1">-</div></div>
          <div class="kv"><div class="lab">ìµì ˆ 2 (TP2)</div><div class="val" id="v_tp2">-</div></div>
          <div class="kv"><div class="lab">ì†ì ˆ (SL)</div><div class="val" id="v_sl">-</div></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge">ëª¨ë“œ: <span id="v_mode">-</span></span>
          <span class="badge">ATR: <span id="v_atr">-</span></span>
          <span class="badge">ë§ˆì¼“: <span id="v_market">-</span></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const LS_KEY = "API_BASE_V1";
const DEFAULT_API = "https://satoshi-proxy.mujukno1.workers.dev/api";

const API_BASE = (localStorage.getItem(LS_KEY) || DEFAULT_API).replace(/\/+$/,'');
localStorage.setItem(LS_KEY, API_BASE);

const $ = (id)=>document.getElementById(id);
const apiDot = $("apiDot");

async function apiGet(path) {
  const url = API_BASE + path;
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("API ì˜¤ë¥˜: " + r.status);
  return await r.json();
}

function setDot(on){ apiDot.classList.toggle("on", !!on); }

// ì´ˆê¸° ì—°ê²° ì²´í¬
apiGet("").then(()=>setDot(true)).catch(()=>setDot(false));

// -------- SPARK --------
async function loadSpark() {
  const box = $("sparkList");
  box.innerHTML = `<div class="muted">ì˜ˆì—´ ì½”ì¸ì„ íƒìƒ‰ì¤‘â€¦</div>`;
  try {
    const { top } = await apiGet("/spark?limit=10");
    box.innerHTML = "";
    top.forEach(row=>{
      const li = document.createElement("div");
      li.className = "spark-item";
      li.innerHTML = `
        <div>
          <div class="k">${row.korean_name || row.market}</div>
          <div class="muted" style="font-size:12px">${row.market}</div>
        </div>
        <div style="text-align:right">
          <div class="v">${fmtPct(row.changePct)}</div>
          <div class="muted" style="font-size:12px">score ${row.score.toFixed(2)}</div>
        </div>`;
      li.onclick = ()=> showUltra(row.market);
      box.appendChild(li);
    });
  } catch(e){
    box.innerHTML = `<div class="bad">SPARK ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
  }
}

// -------- ULTRA --------
async function showUltra(market){
  try{
    const r = await apiGet(`/ultra?market=${encodeURIComponent(market)}`);
    $("v_price").textContent = fmtKRW(r.price);
    $("v_change").textContent = fmtPct(r.changePct);
    $("v_buy").textContent = fmtKRW(r.buy1);
    $("v_tp1").textContent = fmtKRW(r.tp1);
    $("v_tp2").textContent = fmtKRW(r.tp2);
    $("v_sl").textContent = fmtKRW(r.sl);
    $("v_mode").textContent = r.mode;
    $("v_atr").textContent = r.atr?.toLocaleString();
    $("v_market").textContent = r.market;
  }catch(e){
    alert("ULTRA ì˜¤ë¥˜: " + e.message);
  }
}

// -------- ê²€ìƒ‰ --------
$("btnSearch").onclick = async ()=>{
  const q = $("q").value.trim();
  if(!q) return;
  // KRW- ì ‘ë‘ê°€ ì—†ìœ¼ë©´ í•œê¸€/ì‹¬ë³¼ì„ KRW-ë¡œ ì¶”ì • ë§¤í•‘
  let market = q.toUpperCase();
  if(!market.startsWith("KRW-")){
    // ê°„ë‹¨ ë§¤í•‘: ë§ˆì¼“ ì „ì²´ì—ì„œ í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ í¬í•¨ ì¼ì¹˜ ìš°ì„  íƒìƒ‰
    try{
      const res = await apiGet("/upbit/markets");
      const it = res.items || [];
      let hit = it.find(m=> m.korean_name === q) ||
                it.find(m=> m.korean_name.includes(q)) ||
                it.find(m=> m.english_name?.toUpperCase() === q) ||
                it.find(m=> m.market.endsWith("-"+q));
      market = hit?.market || ("KRW-" + q.replace(/^KRW-/i,""));
    }catch{}
  }
  showUltra(market);
};

// ìœ í‹¸
function fmtPct(v){
  const n = +v;
  const s = (n>=0? "+":"") + n.toFixed(2) + "%";
  return `<span class="${n>=0?"ok":"bad"}">${s}</span>`;
}
function fmtKRW(n){
  if(n==null || isNaN(n)) return "-";
  return Math.round(n).toLocaleString() + "ì›";
}

// ìµœì´ˆ ë¡œë“œ
loadSpark();
</script>
</body>
</html>
