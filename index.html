<script>
const $=(id)=>document.getElementById(id);
let marketList=[]; // âœ… ì „ì—­ ë³€ìˆ˜
let currentMarket=null, stopPoll=null;

// âœ… ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„
function getTickSize(price){if(price>=2000000)return 1000;if(price>=1000000)return 500;if(price>=500000)return 100;if(price>=100000)return 50;if(price>=10000)return 10;if(price>=1000)return 5;if(price>=100)return 1;if(price>=10)return 0.1;if(price>=1)return 0.01;if(price>=0.1)return 0.001;if(price>=0.01)return 0.0001;if(price>=0.001)return 0.00001;if(price>=0.0001)return 0.000001;if(price>=0.00001)return 0.0000001;if(price>=0.000001)return 0.00000001;return 0.000000001;}

const Upbit={
  async getMarkets(){
    const res=await fetch('https://api.upbit.com/v1/market/all?isDetails=false');
    return (await res.json()).filter(x=>x.market.startsWith('KRW-'));
  },
  async getTicker(m){
    const t=await fetch(`https://api.upbit.com/v1/ticker?markets=${m}`).then(r=>r.json());
    return t[0];
  },
  format(p){
    if(!p)return 'â€”';
    const tick=getTickSize(p);
    const rounded=Math.round(p/tick)*tick;
    const dec=(tick.toString().split('.')[1]||'').length;
    return rounded.toLocaleString('ko-KR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
  }
};

// âœ… ì‹¤ì‹œê°„ ì‹œê³„
function tick(){
  const now=new Date(),utc=now.getTime()+now.getTimezoneOffset()*60000;
  const kst=new Date(utc+9*3600000);
  $('clock').textContent='KST â€” '+kst.toLocaleTimeString('ko-KR',{hour12:false});
  $('net').textContent=navigator.onLine?'ONLINE':'OFFLINE';
  $('net').style.background=navigator.onLine?'#123922':'#3a1a1a';
}
setInterval(tick,1000); tick();

// âœ… íŒ¨ë„ ì´ˆê¸°í™”
function clearPanel(){['price','change','v_price','v_buy','v_sell','v_stop','v_risk','v_comment'].forEach(id=>$(id).textContent='â€”');}

function aiComment(rate){
  if(rate>0.05)return'ğŸ”¥ ë¶ˆì¥ ì´ˆì…, ê¸‰ë“± ì£¼ì˜!';
  if(rate>0.02)return'ğŸ“ˆ ìƒìŠ¹ íƒ„ë ¥, ì¶”ì„¸ ìœ ì§€';
  if(rate>-0.02)return'âš–ï¸ íš¡ë³´ êµ¬ê°„ â€” ê´€ë§ ê¶Œì¥';
  if(rate<-0.02&&rate>-0.05)return'ğŸ“‰ ë‹¨ê¸° ì¡°ì • êµ¬ê°„, ë§¤ìˆ˜ ë¶„í•  ìœ íš¨';
  return'ğŸ’€ ê¸‰ë½ ë¦¬ìŠ¤í¬ êµ¬ê°„ â€” ì² ì €í•œ ì†ì ˆ í•„ìš”';
}

// âœ… ê°€ê²© íŒ¨ë„ ì—…ë°ì´íŠ¸
function updatePanel(t){
  if(!t)return;
  const p=t.trade_price,rate=t.signed_change_rate;
  $('price').textContent=Upbit.format(p)+' ì›';
  $('change').className='diff '+(t.change==='RISE'?'up':t.change==='FALL'?'down':'');
  $('change').textContent=`${t.change==='RISE'?'+':''}${(rate*100).toFixed(2)}%`;
  $('v_price').textContent=Upbit.format(p)+' ì›';
  const buy=p*0.988,sell=p*1.012,stop=p*0.975;
  $('v_buy').textContent=Upbit.format(buy)+' ì›';
  $('v_sell').textContent=Upbit.format(sell)+' ì›';
  $('v_stop').textContent=Upbit.format(stop)+' ì›';
  $('v_risk').textContent=Math.abs(rate*100)<1?'1(ì•ˆì •)':Math.abs(rate*100)<2?'2(ë³´í†µ)':'3(ì£¼ì˜)';
  $('v_comment').textContent=aiComment(rate);
}

// âœ… ì½”ì¸ ì„ íƒ í›„ ì‹¤ì‹œê°„ ê°±ì‹ 
async function select(market,metaName){
  currentMarket=market; clearPanel();
  const t=await Upbit.getTicker(market);
  updatePanel(t);
  const now=new Date().toLocaleString('ko-KR');
  const record=`[${now}] ${metaName} (${market}) â€” í˜„ì¬ê°€: ${Upbit.format(t.trade_price)}ì›\n`;
  const prev=localStorage.getItem('zzeol_memo')||'';
  localStorage.setItem('zzeol_memo',record+prev);
  $('memoText').value=localStorage.getItem('zzeol_memo');
  if(stopPoll)clearInterval(stopPoll);
  stopPoll=setInterval(async()=>{
    const t=await Upbit.getTicker(market);
    if(currentMarket!==market)return;
    updatePanel(t);
  },1000);
}

// âœ… í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰
window.addEventListener('DOMContentLoaded',async()=>{
  try{
    marketList=await Upbit.getMarkets();
    const input=$('search'),box=$('list');
    input.placeholder='ì½”ì¸ëª… ì…ë ¥ (ì˜ˆ: ì‹œë°”ì´ëˆ„, ë¹„íŠ¸ì½”ì¸)';
    input.addEventListener('input',()=>{
      const s=input.value.toLowerCase().trim();
      if(!s){box.innerHTML='';box.classList.remove('show');return;}
      const items=marketList.filter(x=>x.korean_name.toLowerCase().includes(s)||x.market.toLowerCase().includes(s));
      box.innerHTML=items.map(x=>`<div class="item" data-m="${x.market}" data-n="${x.korean_name}">${x.korean_name} <span style="color:#8aa0b6">(${x.market.replace('KRW-','')})</span></div>`).join('');
      box.classList.add('show');
    });
    box.addEventListener('click',e=>{
      const el=e.target.closest('.item'); if(!el)return;
      const m=el.dataset.m,n=el.dataset.n;
      input.value='';box.classList.remove('show');
      $('coin-name').innerHTML=`${n} <span style="color:#8aa0b6">(${m.replace('KRW-','')})</span>`;
      $('market').textContent=m;
      select(m,n);
    });
  }catch(err){
    console.error('ì—…ë¹„íŠ¸ ì—°ê²° ì‹¤íŒ¨:',err);
    $('search').placeholder='ğŸš« ì—…ë¹„íŠ¸ ì—°ê²° ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨)';
  }
});
</script>
