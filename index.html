<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì©”ì–´ì§€ê°‘ v7.1 â€” ì‹¤ì‹œê°„ ê¸‰ë“±í˜•</title>
<style>
:root{
  --bg:#0f141a;--panel:#121821;--text:#d7e2f2;--muted:#9fb0c3;--line:#1c2733;
  --green:#2bd093;--red:#ff5a6f;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
.wrap{max-width:1180px;margin:24px auto;padding:0 16px}
.title{display:flex;gap:10px;margin-bottom:12px}
.badge{background:#0e1724;padding:5px 10px;border-radius:12px;border:1px solid var(--line);color:var(--muted);font-size:13px}
.bar{display:flex;gap:8px;margin-bottom:10px}
.ipt{flex:1;padding:10px;border:1px solid var(--line);border-radius:8px;background:#0c1219;color:var(--text)}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:8px;background:#0c1219;color:var(--text);cursor:pointer}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin-top:10px;overflow:hidden}
.panel h3{margin:0;padding:10px 14px;background:#0f1722;color:#bcd0e6;display:flex;justify-content:space-between;align-items:center}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);white-space:nowrap;text-align:right}
th:nth-child(2),td:nth-child(2){text-align:left}
.green{color:var(--green)}.red{color:var(--red)}
.tag{background:#0f1722;border:1px solid var(--line);border-radius:8px;padding:2px 6px;font-size:12px}
.stack{display:flex;flex-direction:column;gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <span class="badge">ì©”ì–´ì§€ê°‘ v7.1</span>
    <span class="badge" id="net">ONLINE</span>
    <span class="badge" id="clock"></span>
    <span class="badge">ì‹¤ì‹œê°„ ê¸‰ë“±í˜• + ìë™ë³µêµ¬</span>
  </div>

  <div class="bar">
    <input id="q" class="ipt" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" list="list">
    <datalist id="list"></datalist>
    <button id="search" class="btn">ê²€ìƒ‰</button>
  </div>

  <div class="stack">
    <div class="panel">
      <h3>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top10</h3>
      <table id="rise"><thead><tr><th>#</th><th>ì½”ì¸ëª…</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="panel">
      <h3>ğŸ’§ ê¸‰ë½ì½”ì¸ Top10</h3>
      <table id="fall"><thead><tr><th>#</th><th>ì½”ì¸ëª…</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
const API = (p)=>`/api/upbit?path=${encodeURIComponent(p)}`;
let markets=[], tickers=new Map();

function clock(){
  const now=new Date();
  document.getElementById("clock").textContent=now.toLocaleTimeString('ko-KR',{hour12:false});
}
setInterval(clock,1000);clock();

async function loadMarkets(){
  const res=await fetch(API("/v1/market/all?isDetails=true"));
  const arr=await res.json();
  markets=arr.filter(m=>m.market.startsWith("KRW-"));
  const dl=document.getElementById("list");
  dl.innerHTML=markets.map(m=>`<option value="${m.korean_name} (${m.market})">`).join("");
}

function priceUnit(p){if(p>=2e6)return 1000;if(p>=1e6)return 500;if(p>=5e5)return 100;if(p>=1e5)return 50;if(p>=1e4)return 10;if(p>=1e3)return 1;if(p>=100)return 0.1;if(p>=10)return 0.01;if(p>=1)return 0.001;if(p>=.1)return .0001;if(p>=.01)return .00001;return .000001}
function roundHoga(x){const u=priceUnit(x),f=1/u;return Math.round(x*f)/f}
function fmt(x){const u=priceUnit(Math.abs(x));const d=(u<1)?String(u).split('.')[1].length:0;return x.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d})}
function fmtR(r){const p=(r*100).toFixed(2)+'%';return r>=0?`<span class="green">${p}</span>`:`<span class="red">${p}</span>`}

function analyze(t){
  const ch=t.signed_change_rate||0,p=t.trade_price||0;
  const buy=roundHoga(p*(ch>0?0.996:0.992));
  const sell=roundHoga(p*(ch>0?1.004:1.006));
  const stop=roundHoga(p*(ch>0?0.985:0.975));
  let risk='1(ì•ˆì •)',note='ê´€ë§';
  if(Math.abs(ch)>0.05)risk='3(ì£¼ì˜)';else if(Math.abs(ch)>0.02)risk='2(ë³´í†µ)';
  if(ch>0.06)note='ğŸš€ í­ë“±';else if(ch<-0.06)note='ğŸ“‰ ë‚™í­ê²½ê³„';else if(ch>0.02)note='ğŸ”¥ ìƒìŠ¹ì¤‘';
  return {...t,buy,sell,stop,risk,note};
}

function render(id,rows){
  const tb=document.querySelector(`#${id} tbody`);
  tb.innerHTML=rows.map((r,i)=>`
  <tr><td>${i+1}</td><td>${r.korean_name}</td>
  <td>${fmt(r.trade_price)}</td><td>${fmtR(r.signed_change_rate)}</td>
  <td>${fmt(r.buy)}</td><td>${fmt(r.sell)}</td><td>${fmt(r.stop)}</td>
  <td>${r.risk}</td><td><span class="tag">${r.note}</span></td></tr>`).join("");
}

async function refresh(){
  const mk=markets.map(m=>m.market).join(",");
  try{
    const res=await fetch(API(`/v1/ticker?markets=${encodeURIComponent(mk)}`));
    const data=await res.json();
    data.forEach(t=>tickers.set(t.market,analyze({...t,korean_name:markets.find(m=>m.market===t.market)?.korean_name||t.market})));
    updateTables();
  }catch(e){console.warn("fetch fail",e);setTimeout(refresh,3000);}
}

function updateTables(){
  const arr=[...tickers.values()];
  const rising=arr.filter(a=>a.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const falling=arr.filter(a=>a.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
  render("rise",rising);render("fall",falling);
}

/* --- ì‹¤ì‹œê°„ ì›¹ì†Œì¼“ --- */
function wsConnect(){
  try{
    const ws=new WebSocket("wss://api.upbit.com/websocket/v1");
    ws.binaryType="arraybuffer";
    ws.onopen=()=>{document.getElementById("net").textContent="LIVE";
      ws.send(JSON.stringify([{ticket:"zzeol"}, {type:"ticker", codes:markets.map(m=>m.market)}]));
    };
    ws.onmessage=e=>{
      const d=new TextDecoder("utf-8").decode(e.data);
      try{const t=JSON.parse(d);if(!t.market)return;
        tickers.set(t.market,analyze({...t,korean_name:markets.find(m=>m.market===t.market)?.korean_name||t.market}));
        updateTables();
      }catch{}
    };
    ws.onclose=()=>{document.getElementById("net").textContent="ì¬ì—°ê²°ì¤‘...";setTimeout(wsConnect,2000);}
  }catch(e){console.warn("WS error",e);setTimeout(wsConnect,4000);}
}

/* --- ê²€ìƒ‰ --- */
document.getElementById("search").onclick=()=>{
  const q=document.getElementById("q").value.trim();
  const found=markets.find(m=>m.korean_name.includes(q)||m.market===q||m.market.includes(q)||m.english_name.toUpperCase().includes(q.toUpperCase()));
  if(!found)return alert("ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");
  const t=tickers.get(found.market);
  if(t)alert(`${found.korean_name}\ní˜„ì¬ê°€ ${fmt(t.trade_price)}\në§¤ìˆ˜ ${fmt(t.buy)} / ë§¤ë„ ${fmt(t.sell)} / ì†ì ˆ ${fmt(t.stop)}\nìœ„í—˜ë„ ${t.risk}\nì©”ì–´í•œë§ˆë””: ${t.note}`);
};

loadMarkets().then(()=>{refresh();wsConnect();setInterval(refresh,15000);});
</script>
</body>
</html>
