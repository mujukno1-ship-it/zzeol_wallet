<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.0 ì•ˆì •íŒ</title>
<style>
  :root{
    --bg:#0f141a;--panel:#121821;--muted:#9fb0c3;--text:#d7e2f2;--green:#2bd093;--red:#ff5a6f;--orange:#ffb74d;--line:#1c2733;--badge:#1a2330;--chip:#0f1722
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Pretendard,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
  .title{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{background:var(--badge);color:#bcd0e6;border:1px solid var(--line);padding:3px 8px;border-radius:8px;font-size:12px}
  .bar{display:flex;gap:8px;margin-bottom:10px}
  .bar .grow{flex:1}
  .ipt{width:100%;background:#0c1219;border:1px solid var(--line);color:var(--text);padding:12px 12px;border-radius:10px;outline:none}
  .btn{background:#0c1219;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#2a3a4d}
  .row{display:flex;gap:12px}
  .panel{flex:1;background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);background:#0f1722;font-size:14px;color:#bcd0e6;display:flex;align-items:center;justify-content:space-between}
  .summary{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .summary .cell{background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .summary .ttl{color:#9fb0c3;font-size:12px;margin-bottom:6px}
  .summary .val{font-weight:700}
  .green{color:var(--green)} .red{color:var(--red)} .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:right;white-space:nowrap}
  th{background:#0f1722;color:#9fb0c3;font-weight:600}
  td:first-child,th:first-child{text-align:center}
  td:nth-child(2),th:nth-child(2){text-align:left}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:var(--chip);color:#cfe2ff;font-size:12px}
  .note{display:flex;align-items:center;gap:6px}
  .tag{padding:2px 8px;border-radius:8px;border:1px solid var(--line);background:#0f1722;color:#cfe2ff;font-size:12px}
  .footer{margin-top:12px;color:#8597ab}
  .right{display:flex;gap:6px;align-items:center}
  .inline{display:inline-flex;gap:8px;align-items:center}
  @media(max-width:1100px){.summary{grid-template-columns:repeat(4,1fr)}}
  @media(max-width:720px){.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="badge">ì©”ì–´ì§€ê°‘ v7.0 ì•ˆì •íŒ</div>
      <div class="badge">ONLINE</div>
      <div class="badge" id="clock">KST â€” --:--:--</div>
      <div class="badge">ì—…ë¹„íŠ¸ í”„ë¡ì‹œ ê³ ì •</div>
    </div>

    <!-- ê²€ìƒ‰ ë°” (ê¸°ì¡´ ìœ„ì¹˜ ìœ ì§€) -->
    <div class="bar">
      <input id="q" class="ipt grow" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
      <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
      <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
    </div>

    <!-- ì„ íƒëœ ì½”ì¸ 1ì¤„ ìš”ì•½ (í˜„ì¬ê°€/ë³€ë™ë¥ /ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””/ë³€ë™ë¥ ) -->
    <div class="panel">
      <div class="summary" id="selectedSummary">
        <!-- JSê°€ ì±„ì›€ -->
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <!-- ê¸‰ë“±ì½”ì¸ -->
      <div class="panel">
        <h3>
          <span>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <span class="muted">(ì¡°ê±´: ì‹¤ì‹œê°„ ë³€ë™ë¥  ê¸°ì¤€)</span></span>
          <div class="right">
            <button class="btn" id="btnRiseRefresh">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </h3>
        <div id="riseTableWrap">
          <table id="riseTable">
            <thead>
              <tr>
                <th>#</th>
                <th>ì½”ì¸ëª…(í•œê¸€)</th>
                <th>í˜„ì¬ê°€</th>
                <th>ë³€ë™ë¥ </th>
                <th>ë§¤ìˆ˜</th>
                <th>ë§¤ë„</th>
                <th>ì†ì ˆ</th>
                <th>ìœ„í—˜ë„</th>
                <th>ì©”ì–´í•œë§ˆë””</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ê¸‰ë½ì½”ì¸ -->
      <div class="panel">
        <h3>
          <span>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</span>
          <div class="right">
            <button class="btn" id="btnFallRefresh">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </h3>
        <div id="fallTableWrap">
          <table id="fallTable">
            <thead>
              <tr>
                <th>#</th>
                <th>ì½”ì¸ëª…(í•œê¸€)</th>
                <th>í˜„ì¬ê°€</th>
                <th>ë³€ë™ë¥ </th>
                <th>ë§¤ìˆ˜</th>
                <th>ë§¤ë„</th>
                <th>ì†ì ˆ</th>
                <th>ìœ„í—˜ë„</th>
                <th>ì©”ì–´í•œë§ˆë””</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      â“˜ ì‹¤ì‹œê°„ ìë™ ì •ë ¬ Â· 429 ë°±ì˜¤í”„ ì²˜ë¦¬ Â· í˜¸ê°€ë‹¨ìœ„ ë§¤í•‘ ê³ ì • Â· ê²€ìƒ‰(í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ)  
    </div>
  </div>

<script>
/* =========================
   ìœ í‹¸ & ìƒìˆ˜
========================= */
const API = (path) => `/api/upbit?path=${encodeURIComponent(path)}`;

// KRW í˜¸ê°€ ë‹¨ìœ„ (ì—…ë¹„íŠ¸ì™€ ë™ì¼ ê·œì¹™)
function priceUnit(p){
  if (p >= 2_000_000) return 1_000;
  if (p >= 1_000_000) return 500;
  if (p >= 500_000)  return 100;
  if (p >= 100_000)  return 50;
  if (p >= 10_000)   return 10;
  if (p >= 1_000)    return 5;
  if (p >= 100)      return 1;
  if (p >= 10)       return 0.1;
  if (p >= 1)        return 0.01;
  if (p >= 0.1)      return 0.001;
  if (p >= 0.01)     return 0.0001;
  if (p >= 0.001)    return 0.00001;
  return 0.000001;
}
function roundToHoga(p){
  const u = priceUnit(p);
  return Math.round(p/u)*u;
}
const fmtKRW = (x) => {
  if (x==null || Number.isNaN(x)) return '-';
  const unit = priceUnit(Math.abs(x));
  return x.toLocaleString('ko-KR', {
    minimumFractionDigits: (unit<1)? String(unit).split('.')[1].length : 0,
    maximumFractionDigits: (unit<1)? String(unit).split('.')[1].length : 0
  });
};
const pct = (x) => (x>0?`<span class="green">${(x*100).toFixed(2)}%</span>`:
                          `<span class="red">${(x*100).toFixed(2)}%</span>`);

function clockTick(){
  const c = document.getElementById('clock');
  const now = new Date();
  c.textContent = 'KST â€” ' + now.toLocaleTimeString('ko-KR',{hour12:false});
}
setInterval(clockTick, 1000); clockTick();

/* =========================
   ë§ˆì¼“/ê²€ìƒ‰ ì¸ë±ìŠ¤ ë¡œë“œ
========================= */
let MARKETS = [];                 // KRW-XXX Markets
let NAME_TO_MARKET = new Map();   // í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ -> market

async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'));
  if (!r.ok){ throw new Error('ì‹œì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ '+r.status); }
  const all = await r.json();
  MARKETS = all.filter(m => m.market.startsWith('KRW-'));
  NAME_TO_MARKET.clear();
  for (const m of MARKETS){
    NAME_TO_MARKET.set(m.korean_name, m.market);
    NAME_TO_MARKET.set(m.english_name?.toUpperCase?.(), m.market);
    const sym = m.market.replace('KRW-',''); // ì‹¬ë³¼
    NAME_TO_MARKET.set(sym, m.market);
    NAME_TO_MARKET.set(m.market, m.market);
  }
}
function resolveMarket(query){
  if(!query) return null;
  const q = String(query).trim();
  // ì™„ì „ì¼ì¹˜ ìš°ì„ 
  if (NAME_TO_MARKET.has(q)) return NAME_TO_MARKET.get(q);
  if (NAME_TO_MARKET.has(q.toUpperCase())) return NAME_TO_MARKET.get(q.toUpperCase());
  // ë¶€ë¶„ í¬í•¨(í•œê¸€)
  for (const [k,v] of NAME_TO_MARKET){
    if (!k) continue;
    if (k.includes && k.includes(q)) return v;
  }
  return null;
}

/* =========================
   ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ (í‹°ì»¤/í˜¸ê°€)
========================= */
async function fetchTickers(mkts){
  if (!mkts.length) return [];
  // 200ê°œ ì œí•œ ìš°íšŒ: 100ê°œ ë‹¨ìœ„ fetch í›„ í•©ì¹˜ê¸°
  const batch = 100;
  const out = [];
  for (let i=0;i<mkts.length;i+=batch){
    const part = mkts.slice(i, i+batch).join(',');
    const url = API(`/v1/ticker?markets=${encodeURIComponent(part)}`);
    const r = await fetch(url);
    if (!r.ok) throw new Error('ticker fail '+r.status);
    out.push(...await r.json());
  }
  return out;
}
async function fetchOrderbook(mkts){
  if (!mkts.length) return [];
  const batch = 50;
  const out = [];
  for (let i=0;i<mkts.length;i+=batch){
    const part = mkts.slice(i, i+batch).join(',');
    const url = API(`/v1/orderbook?markets=${encodeURIComponent(part)}`);
    const r = await fetch(url);
    if (!r.ok) throw new Error('orderbook fail '+r.status);
    out.push(...await r.json());
  }
  return out;
}

/* =========================
   ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””/íƒ€ì  ê³„ì‚°
========================= */
// ì•„ì£¼ ë‹¨ìˆœí•œ ì‹¤ì‹œê°„ íŒíŠ¸ ë¡œì§: ë³€ë™ë¥  + í˜¸ê°€ë¶ˆê· í˜• ê¸°ë°˜
function analyzeRow(ticker, obMap){
  const change = ticker.signed_change_rate;  // -1~+1
  const price  = ticker.trade_price;
  const ob     = obMap.get(ticker.market);
  let bestBid=null,bestAsk=null,bidSum=0,askSum=0;
  if (ob){
    bestBid = ob.orderbook_units[0]?.bid_price;
    bestAsk = ob.orderbook_units[0]?.ask_price;
    for (const u of ob.orderbook_units.slice(0,10)){
      bidSum += u.bid_size;
      askSum += u.ask_size;
    }
  }
  const imbalance = bidSum/(askSum||1); // >1.0 ì´ë©´ ë§¤ìˆ˜ ìš°ìœ„
  // ì†ì ˆ/ë§¤ìˆ˜/ë§¤ë„ íƒ€ì (í˜¸ê°€ë‹¨ìœ„ ë°˜ì˜¬ë¦¼)
  const buy  = roundToHoga(price * (change>0 ? 0.996 : 0.992));
  const sell = roundToHoga(price * (change>0 ? 1.004 : 1.006));
  const stop = roundToHoga(price * (change>0 ? 0.985 : 0.975));

  let risk='1(ì•ˆì •)'; // 1~3
  if (Math.abs(change)>0.05 || imbalance>1.6 || imbalance<0.65) risk='3(ì£¼ì˜)';
  else if (Math.abs(change)>0.02 || imbalance>1.25 || imbalance<0.8) risk='2(ë³´í†µ)';

  let comment='ê´€ë§';
  if (change>0.04 && imbalance>1.3) comment='ğŸš€ í­ë“± ëª¨ë“œ!';
  else if (change>0.02 && imbalance>1.2) comment='ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  else if (change<-0.04 && imbalance<0.8) comment='ğŸ“‰ ë‚™í­ê²½ê³„';

  return {
    buy, sell, stop, risk, comment,
    bestBid, bestAsk, imbalance
  };
}

/* =========================
   ë Œë”ëŸ¬
========================= */
function fillSelectedSummary(row){
  // 8ì…€: ì½”ì¸ëª…/í˜„ì¬ê°€/ë³€ë™ë¥ /ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””
  const el = document.getElementById('selectedSummary');
  if (!row){
    el.innerHTML = Array.from({length:8}).map(()=>`
      <div class="cell"><div class="ttl">-</div><div class="val muted">--</div></div>`).join('');
    return;
  }
  el.innerHTML = `
    <div class="cell"><div class="ttl">ì„ íƒëœ ì½”ì¸</div><div class="val">${row.korean_name} <span class="muted">(${row.market})</span></div></div>
    <div class="cell"><div class="ttl">í˜„ì¬ê°€</div><div class="val">${fmtKRW(row.trade_price)}</div></div>
    <div class="cell"><div class="ttl">ë³€ë™ë¥ </div><div class="val">${pct(row.signed_change_rate)}</div></div>
    <div class="cell"><div class="ttl">ë§¤ìˆ˜</div><div class="val">${fmtKRW(row.buy)}</div></div>
    <div class="cell"><div class="ttl">ë§¤ë„</div><div class="val">${fmtKRW(row.sell)}</div></div>
    <div class="cell"><div class="ttl">ì†ì ˆ</div><div class="val">${fmtKRW(row.stop)}</div></div>
    <div class="cell"><div class="ttl">ìœ„í—˜ë„</div><div class="val">${row.risk}</div></div>
    <div class="cell"><div class="ttl">ì©”ì–´í•œë§ˆë””</div><div class="val">${row.comment}</div></div>
  `;
}
function renderTable(tbody, rows){
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.korean_name} <span class="muted">(${r.market})</span></td>
      <td>${fmtKRW(r.trade_price)}</td>
      <td>${pct(r.signed_change_rate)}</td>
      <td>${fmtKRW(r.buy)}</td>
      <td>${fmtKRW(r.sell)}</td>
      <td>${fmtKRW(r.stop)}</td>
      <td>${r.risk}</td>
      <td class="note"><span class="tag">${r.comment}</span></td>
    </tr>
  `).join('');
}

/* =========================
   ë©”ì¸ ë¡œì§
========================= */
let LAST_MARKET = null;

async function refreshAll(selectMarket=null){
  try{
    await loadMarkets();

    const mkts = MARKETS.map(m=>m.market);
    const [ticks, books] = await Promise.all([
      fetchTickers(mkts),
      fetchOrderbook(mkts)
    ]);
    const obMap = new Map(books.map(b=>[b.market,b]));
    const info = new Map(MARKETS.map(m=>[m.market,m]));

    // ë¶„ì„ ê²°ê³¼ í•©ì„±
    const rows = ticks.map(t=>{
      const z = analyzeRow(t, obMap);
      const meta = info.get(t.market) || {};
      return {
        ...t,
        korean_name: meta.korean_name || t.market,
        ...z
      };
    });

    // ì •ë ¬
    const rising = [...rows].sort((a,b)=> b.signed_change_rate - a.signed_change_rate).slice(0,10);
    const falling= [...rows].sort((a,b)=> a.signed_change_rate - b.signed_change_rate).slice(0,10);

    renderTable(document.querySelector('#riseTable tbody'), rising);
    renderTable(document.querySelector('#fallTable tbody'), falling);

    // ì„ íƒì½”ì¸ ì²˜ë¦¬
    let selectedRow = null;
    const m = selectMarket || LAST_MARKET;
    if (m){
      selectedRow = rows.find(r=>r.market===m) || null;
    }
    fillSelectedSummary(selectedRow);
  }catch(e){
    console.error(e);
    alert('ë°ì´í„° ê°±ì‹  ì¤‘ ì˜¤ë¥˜: '+e.message);
  }
}

function doSearch(){
  const q = document.getElementById('q').value.trim();
  if (!q){ LAST_MARKET = null; fillSelectedSummary(null); return; }
  const m = resolveMarket(q);
  if (!m){
    alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)');
    return;
  }
  LAST_MARKET = m;
  // ì„ íƒì½”ì¸ë§Œ ë¶€ë¶„ ìƒˆë¡œê³ ì¹¨
  refreshAll(m);
}

/* =========================
   ì´ë²¤íŠ¸
========================= */
document.getElementById('btnSearch').onclick = doSearch;
document.getElementById('btnReset').onclick  = ()=>{ document.getElementById('q').value=''; LAST_MARKET=null; fillSelectedSummary(null); };
document.getElementById('btnRiseRefresh').onclick = ()=>refreshAll(LAST_MARKET);
document.getElementById('btnFallRefresh').onclick = ()=>refreshAll(LAST_MARKET);
// ì—”í„° ê²€ìƒ‰
document.getElementById('q').addEventListener('keydown',e=>{
  if (e.key==='Enter') doSearch();
});

/* ì´ˆê¸° êµ¬ë™ */
refreshAll();

</script>
</body>
</html>
