<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3 ì•ˆì •í˜• â€” í•œì¤„(ê°€ë¡œ)</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0c0f14;
    --card:#121722;
    --muted:#6b7280;
    --text:#e5e7eb;
    --accent:#7c3aed;
    --good:#10b981;
    --warn:#f59e0b;
    --bad:#ef4444;
    --line:#1f2937;
    --chip:#111827;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,AppleSDGothicNeo,Roboto,"Noto Sans KR","Apple Color Emoji","Segoe UI Emoji"}
  a{color:inherit;text-decoration:none}
  .app{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;align-items:center;gap:10px}
  .space{flex:1}

  /* í—¤ë” */
  .header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;height:22px;padding:0 10px;border-radius:20px;background:#0b1220;border:1px solid #132033;color:#c9d2e1;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.online{background:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,.15)}
  .dot.offline{background:#9ca3af}
  .ver{background:#101a2b}
  .clock{font-variant-numeric: tabular-nums}

  /* ê²€ìƒ‰ë°” */
  .searchbar{display:flex;gap:8px;margin:12px 0}
  .searchbar input{flex:1;height:40px;padding:0 12px;border-radius:10px;border:1px solid #1f2a3d;background:#0e1524;color:var(--text)}
  .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid #22314a;background:#101a2b;color:#dbe5ff;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  /* ì„ íƒ ì½”ì¸ ì¹´ë“œ */
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
  .card .head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
  .card .body{padding:10px 10px 4px 10px}

  /* í•œì¤„(ê°€ë¡œ) ì •ë³´ ë¼ì¸ */
  .coin-info-row{
    display:flex;align-items:center;
    gap:8px;
    padding:10px 10px;
    background:#0e1420;border:1px solid #1b2435;border-radius:10px;
    margin-bottom:8px
  }
  .coin-info-row .name{min-width:140px;font-weight:700}
  .chip{padding:4px 8px;border-radius:8px;background:var(--chip);border:1px solid #222b3b}
  .val{font-variant-numeric: tabular-nums}

  .risk{font-weight:700}
  .risk.safe{color:var(--good)}
  .risk.warn{color:var(--warn)}
  .risk.danger{color:var(--bad)}

  .pep{margin-left:auto;font-weight:700}
  .pep.up{color:#60a5fa}
  .pep.down{color:#fca5a5}
  .pep.flat{color:#c4b5fd}

  /* í…Œì´ë¸”í˜• ì„¹ì…˜ */
  .section{margin-top:16px}
  .section .title{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:10px}
  .tr{display:flex;gap:8px;align-items:center;background:#0f1523;border:1px solid #1b2435;border-radius:10px;padding:10px}
  .tr .idx{width:26px;text-align:center;color:var(--muted)}
  .tr .kname{min-width:150px;font-weight:700}
  .tr .col{flex:1}
  .pill{padding:4px 8px;border-radius:20px;background:#0d1628;border:1px solid #1f2a3e;font-size:12px}
  .ghost{color:#9aa6bd}

  /* ì‘ì€ ë²„íŠ¼ë“¤ */
  .ghostbtn{height:30px;padding:0 10px;border-radius:8px;border:1px solid #23324b;background:#0f172a;color:#cbd5e1;cursor:pointer}
  .ghostbtn:active{transform:translateY(1px)}

  /* ë°˜ì‘í˜• */
  @media (max-width:820px){
    .coin-info-row .name{min-width:110px}
    .tr .kname{min-width:120px}
    .tr .idx{display:none}
  }
</style>
</head>
<body>
<div class="app">

  <!-- í—¤ë” -->
  <div class="header">
    <span class="badge ver">ì©”ì–´ì§€ê°‘ v6.3 ì•ˆì •í˜•</span>
    <span class="badge"><span class="dot online" id="netdot"></span><span id="netlbl">ONLINE</span></span>
    <span class="badge clock" id="clock">KST â€” --:--:--</span>
    <span class="space"></span>
    <button class="ghostbtn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="searchbar">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒ ì½”ì¸ ì¹´ë“œ -->
  <div class="card">
    <div class="head">
      <div class="row" style="gap:6px">
        <strong>ì„ íƒëœ ì½”ì¸:</strong>
        <span id="selName" class="ghost">ì—†ìŒ</span>
        <span id="selMarket" class="pill ghost"></span>
      </div>
      <span class="space"></span>
      <span class="ghost">ë³€ë™ë¥  â€” <span id="selChange" class="val">â€”</span></span>
    </div>
    <div class="body">
      <!-- í•œì¤„(ê°€ë¡œ) ë¼ì¸ -->
      <div class="coin-info-row" id="lineSelected">
        <div class="name val" id="lineName">â€”</div>
        <div class="chip"><small>í˜„ì¬ê°€</small> <b class="val" id="linePrice">â€”</b></div>
        <div class="chip"><small>ë§¤ìˆ˜</small> <b class="val" id="lineBid">â€”</b></div>
        <div class="chip"><small>ë§¤ë„</small> <b class="val" id="lineAsk">â€”</b></div>
        <div class="chip"><small>ì†ì ˆ</small> <b class="val" id="lineCut">â€”</b></div>
        <div class="risk val" id="lineRisk">â€”</div>
        <div class="pep flat" id="linePep">â€”</div>
      </div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ ì„¹ì…˜ -->
  <div class="card section" id="secUp">
    <div class="title">
      ğŸ”¥ <strong>ê¸‰ë“±ì½”ì¸ Top 10</strong> <span class="ghost"> (ì¡°ê±´: <span id="condUp"></span>)</span>
      <span class="space"></span>
      <button class="ghostbtn" id="btnPinUp">í”¼ë“œ ë¹„ìš°ê¸°</button>
    </div>
    <div class="table" id="listUp"></div>
  </div>

  <div class="card section" id="secDown">
    <div class="title">
      ğŸ’§ <strong>ê¸‰ë½ì½”ì¸ Top 10</strong> <span class="ghost"> (ì¡°ê±´: <span id="condDown"></span>)</span>
      <span class="space"></span>
      <button class="ghostbtn" id="btnPinDown">í”¼ë“œ ë¹„ìš°ê¸°</button>
    </div>
    <div class="table" id="listDown"></div>
  </div>

</div>

<script>
/* ========== ê¸°ë³¸ ìœ í‹¸ ========== */
const $ = sel => document.querySelector(sel);
const fmtKRW = x => x==null ? 'â€”' :
  Number(x).toLocaleString('ko-KR',{maximumFractionDigits: x<100?2:0});

function tickKST(){
  const kst = new Date(Date.now()+9*3600*1000);
  $('#clock').textContent = 'KST â€” ' + kst.toISOString().substring(11,19);
}
setInterval(tickKST,1000); tickKST();

function setOnline(ok){
  $('#netlbl').textContent = ok ? 'ONLINE' : 'OFFLINE';
  $('#netdot').classList.toggle('online',ok);
  $('#netdot').classList.toggle('offline',!ok);
}
setOnline(true);

/* ========== API í”„ë¡ì‹œ (Upbit) ========== */
/* pages/api/upbit.js ë˜ëŠ” api/upbit.js ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. */
const PROXY = (path)=> `/api/upbit?path=${encodeURIComponent(path)}`;
async function getJSON(path){
  try{
    const r = await fetch(PROXY(path),{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    setOnline(true);
    return await r.json();
  }catch(e){
    setOnline(false);
    throw e;
  }
}

/* ========== ë§ˆì¼“ ëª©ë¡ ë¡œë“œ ========== */
let MARKETS = []; // {market, korean_name, english_name}
let MAP_KR = new Map(); // market -> korean_name
let MAP_BY_NAME = new Map(); // ì´ë¦„/ì‹¬ë³¼ -> market (ê²€ìƒ‰ìš©)

async function loadMarkets(){
  const arr = await getJSON('/v1/market/all?isDetails=true');
  MARKETS = arr.filter(m=>m.market.startsWith('KRW-'));
  MAP_KR.clear(); MAP_BY_NAME.clear();
  for(const m of MARKETS){
    MAP_KR.set(m.market,m.korean_name);
    // ê²€ìƒ‰ í‚¤ ì—¬ëŸ¬ê°œ ì§€ì›
    [m.market, m.korean_name, m.english_name, m.market.replace('KRW-','')].forEach(k=>{
      if(!k) return;
      MAP_BY_NAME.set(k.toUpperCase(), m.market);
    });
  }
}
function findMarket(q){
  if(!q) return null;
  const t = q.trim().toUpperCase();
  return MAP_BY_NAME.get(t) || null;
}

/* ========== ì‹œê·¸ë„ ê³„ì‚° ========== */
function priceUnit(p){
  if(p>=2000000) return 1000;
  if(p>=1000000) return 500;
  if(p>=500000) return 100;
  if(p>=100000) return 50;
  if(p>=10000) return 10;
  if(p>=1000) return 5;
  if(p>=100) return 1;
  if(p>=10) return 0.1;
  return 0.01;
}
function calcCut(price){ // ë‹¨ìˆœ ì†ì ˆì„  = -2.0% (í‹± ë°˜ì˜¬ë¦¼)
  const cut = price*0.98;
  const u = priceUnit(price);
  return Math.round(cut/u)*u;
}
function classifyRisk(chg){
  if(chg>=8) return {cls:'danger', txt:'3(ì£¼ì˜)'};
  if(chg>=3) return {cls:'warn', txt:'2(ë³´í†µ)'};
  return {cls:'safe', txt:'1(ì•ˆì •)'};
}
function pepTalk(chg){
  if(chg>6) return {cls:'up', msg:'ğŸš€ í­ë“± ëª¨ë“œ!'}
  if(chg>2) return {cls:'up', msg:'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!'}
  if(chg<-6) return {cls:'down', msg:'ğŸ§Š í­ë½ ìœ„í—˜!'}
  if(chg<-2) return {cls:'down', msg:'âš ï¸ ì¡°ì‹¬ ëª¨ë“œ!'}
  return {cls:'flat', msg:'ğŸ‘€ ê´€ë§'}
}

/* ========== ì„ íƒ ì½”ì¸ í‘œì‹œ (í•œì¤„ ê°€ë¡œ) ========== */
function renderSelected(tk){
  const kname = MAP_KR.get(tk.market)||tk.market;
  $('#selName').textContent = kname;
  $('#selMarket').textContent = tk.market;
  const chg = +(tk.signed_change_rate*100).toFixed(2);
  $('#selChange').textContent = (chg>0?'+':'')+chg+'%';

  $('#lineName').textContent = kname;
  $('#linePrice').textContent = fmtKRW(tk.trade_price);
  $('#lineBid').textContent = fmtKRW(tk.bid_price);
  $('#lineAsk').textContent = fmtKRW(tk.ask_price);
  const cut=calcCut(tk.trade_price);
  $('#lineCut').textContent = fmtKRW(cut);

  const rk=classifyRisk(chg);
  const pep=pepTalk(chg);
  const riskEl = $('#lineRisk');
  riskEl.className='risk '+rk.cls; riskEl.textContent=rk.txt;

  const pepEl = $('#linePep');
  pepEl.className='pep '+pep.cls; pepEl.textContent=pep.msg;
}

/* ========== ê¸‰ë“±/ê¸‰ë½ ë¦¬ìŠ¤íŠ¸ ========== */
const COND = {
  up: { pct: 5, minKRW: 1_000_000_000 },      // 5% ì´ìƒ, 24h ê±°ë˜ëŒ€ê¸ˆ 10ì–µâ†‘
  down: { pct: -5, minKRW: 1_000_000_000 }    // -5% ì´í•˜, 24h ê±°ë˜ëŒ€ê¸ˆ 10ì–µâ†‘
};
$('#condUp').textContent = `${COND.up.pct}% â†‘, 10ì–µ â†‘`;
$('#condDown').textContent = `${Math.abs(COND.down.pct)}% â†“, 10ì–µ â†‘`;

function rowItem(idx, tk){
  const chg = +(tk.signed_change_rate*100).toFixed(2);
  const rk=classifyRisk(chg);
  const pep=pepTalk(chg);
  const el = document.createElement('div');
  el.className='tr';
  el.innerHTML = `
    <div class="idx">${idx}</div>
    <div class="kname">${MAP_KR.get(tk.market)||tk.market}</div>
    <div class="col"><span class="chip">í˜„ì¬ê°€ <b class="val">${fmtKRW(tk.trade_price)}</b></span></div>
    <div class="col"><span class="chip">ë§¤ìˆ˜ <b class="val">${fmtKRW(tk.bid_price)}</b></span></div>
    <div class="col"><span class="chip">ë§¤ë„ <b class="val">${fmtKRW(tk.ask_price)}</b></span></div>
    <div class="col"><span class="chip">ì†ì ˆ <b class="val">${fmtKRW(calcCut(tk.trade_price))}</b></span></div>
    <div class="col risk ${rk.cls}">${rk.txt}</div>
    <div class="col ghost">${chg>0?'+':''}${chg}%</div>
    <div class="col pep ${pep.cls}">${pep.msg}</div>
  `;
  el.addEventListener('click', ()=>{
    renderSelected(tk);
    $('#selName').scrollIntoView({behavior:'smooth',block:'center'});
  });
  return el;
}

function renderLists(tickers){
  // ì¡°ê±´ í•„í„°
  const up = tickers
    .filter(t=>{
      const chg = t.signed_change_rate*100;
      return chg>=COND.up.pct && t.acc_trade_price_24h>=COND.up.minKRW;
    })
    .sort((a,b)=> (b.signed_change_rate)-(a.signed_change_rate))
    .slice(0,10);

  const down = tickers
    .filter(t=>{
      const chg = t.signed_change_rate*100;
      return chg<=COND.down.pct && t.acc_trade_price_24h>=COND.down.minKRW;
    })
    .sort((a,b)=> (a.signed_change_rate)-(b.signed_change_rate))
    .slice(0,10);

  const upBox = $('#listUp'); upBox.innerHTML='';
  const downBox = $('#listDown'); downBox.innerHTML='';
  if(up.length===0){
    const d=document.createElement('div');d.className='ghost';d.style.padding='8px 10px';d.textContent='ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.'; upBox.appendChild(d);
  }else{
    up.forEach((t,i)=> upBox.appendChild(rowItem(i+1,t)));
  }
  if(down.length===0){
    const d=document.createElement('div');d.className='ghost';d.style.padding='8px 10px';d.textContent='ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.'; downBox.appendChild(d);
  }else{
    down.forEach((t,i)=> downBox.appendChild(rowItem(i+1,t)));
  }
}

/* ========== í´ë§(WS ëŒ€ì²´, ë ˆì´íŠ¸ë¦¬ë°‹ íšŒí”¼) ========== */
let POLL=null;
async function pollTickers(){
  try{
    // KRW ë§ˆì¼“ë“¤ ì „ì²´ë¥¼ í•œ ë²ˆì—
    const mks = MARKETS.map(m=>m.market).join(',');
    const arr = await getJSON('/v1/ticker?markets='+encodeURIComponent(mks));
    renderLists(arr);
    if(SELECTED){
      const hit = arr.find(x=>x.market===SELECTED);
      if(hit) renderSelected(hit);
    }
  }catch(e){
    console.warn('poll error',e);
  }
}
function startPolling(){
  if(POLL) clearInterval(POLL);
  pollTickers();
  POLL = setInterval(pollTickers, 5000); // 5ì´ˆ í´ë§ (WS ì´ìŠˆ/429 ëŒ€ë¹„ ì•ˆì „)
}

/* ========== ê²€ìƒ‰/ì„ íƒ ========== */
let SELECTED=null;
async function search(){
  const q = $('#q').value.trim();
  const mk = findMarket(q);
  if(!mk){
    $('#selName').textContent='ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ';
    SELECTED=null;
    return;
  }
  SELECTED=mk;
  const arr = await getJSON('/v1/ticker?markets='+mk);
  if(arr && arr[0]) renderSelected(arr[0]);
  $('#selMarket').textContent = mk;
}
$('#btnSearch').onclick = search;
$('#q').addEventListener('keydown',e=>{ if(e.key==='Enter') search(); });
$('#btnReset').onclick = ()=>{ $('#q').value=''; SELECTED=null; $('#selName').textContent='ì—†ìŒ'; }

/* ========== ë²„íŠ¼ë“¤ ========== */
$('#btnReload').onclick = ()=>{ pollTickers(); } ;
$('#btnPinUp').onclick = ()=>{ $('#listUp').innerHTML=''; };
$('#btnPinDown').onclick = ()=>{ $('#listDown').innerHTML=''; };

/* ========== ë¶€íŒ… ========== */
(async function boot(){
  try{
    await loadMarkets();
    startPolling();
    // ìµœì´ˆ ê¸°ë³¸ ì½”ì¸(ì´ë”ë¦¬ì›€) ë³´ì—¬ì£¼ê¸°
    $('#q').value = 'ì´ë”ë¦¬ì›€';
    await search();
  }catch(e){
    console.error(e);
    alert('ì´ˆê¸°í™” ì‹¤íŒ¨: API í”„ë¡ì‹œ(/api/upbit) í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nVercel > Functions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  }
})();
</script>
</body>
</html>
