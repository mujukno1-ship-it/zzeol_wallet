<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3 ë¼ì´íŠ¸</title>
<style>
  :root {
    --bg:#0f141a; --panel:#121a21; --card:#151e27; --muted:#8492a6; --acc:#0ea5e9; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
    --line:#1f2a36; --txt:#dbe5f1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b1117;color:var(--txt);font:14px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
  header{display:flex;gap:10px;align-items:center;padding:14px 16px;background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  .badge{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;background:#0b1117}
  .pill{padding:8px 10px;border:1px solid var(--line);border-radius:10px;flex:1;background:var(--bg);color:#cbd5e1}
  .btn{padding:9px 12px;border:1px solid var(--line);background:#0b1117;color:#e2e8f0;border-radius:10px;cursor:pointer}
  .btn:hover{background:#101827}
  main{max-width:1100px;margin:22px auto;padding:0 12px}
  .grid{display:grid;gap:14px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:15px}
  .row{display:grid;grid-template-columns:130px repeat(6,1fr);gap:0;border-bottom:1px solid var(--line)}
  .row>div{padding:10px 12px}
  .row.head{background:#0f1620;color:#9fb3c8;font-weight:600}
  .muted{color:var(--muted)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .k{font-variant-numeric:tabular-nums}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#0d1620}
  .table{max-height:420px;overflow:auto}
  .right{justify-self:end}
  .flex{display:flex;gap:8px;align-items:center}
  .sp{flex:1}
</style>
</head>
<body>
<header>
  <div class="badge">ì©”ì–´ì§€ê°‘ v6.3</div>
  <div class="badge" id="net">OFFLINE</div>
  <div class="sp"></div>
  <div class="muted" id="clock">â€”</div>
</header>

<main class="grid">
  <!-- ê²€ìƒ‰ -->
  <section class="flex">
    <input id="q" class="pill" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
    <button class="btn" id="btnFind">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </section>

  <!-- ì„ íƒ ì½”ì¸ -->
  <section class="panel">
    <h3>ì„ íƒëœ ì½”ì¸: <span id="selName" class="muted">ì—†ìŒ</span> <span class="muted" id="selMarket">â€”</span></h3>
    <div class="row head">
      <div>í˜„ì¬ê°€</div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ìœ„í—˜ë„</div><div>ì©”ì–´í•œë§ˆë””</div><div class="right">ë³€ë™ë¥ </div>
    </div>
    <div class="row">
      <div id="p_now" class="k">â€”</div>
      <div id="p_buy" class="k">â€”</div>
      <div id="p_sell" class="k">â€”</div>
      <div id="p_cut" class="k">â€”</div>
      <div id="p_risk" class="muted">â€”</div>
      <div id="p_zzeol" class="muted">â€”</div>
      <div id="p_chg" class="k right">â€”</div>
    </div>
  </section>

  <!-- ê¸‰ë“±/ê¸‰ë½ -->
  <section class="panel">
    <div class="flex" style="padding:10px 12px;border-bottom:1px solid var(--line)">
      <h3 class="sp" style="border:0;padding:0">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 (ì¡°ê±´: 5%â†‘, 24h 10ì–µâ†‘)</h3>
      <button class="btn" id="btnNewTop">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn" id="btnFeedTop">í”¼ë“œ ë¹„ìš°ê¸°</button>
    </div>
    <div class="row head"><div>#</div><div>ì½”ì¸ëª…(í•œê¸€)</div><div>í˜„ì¬ê°€</div><div>ë³€ë™ë¥ </div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ìœ„í—˜ë„</div><div>ì©”ì–´í•œë§ˆë””</div></div>
    <div class="table" id="topTable"></div>
  </section>

  <section class="panel">
    <div class="flex" style="padding:10px 12px;border-bottom:1px solid var(--line)">
      <h3 class="sp" style="border:0;padding:0">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 (ì¡°ê±´: -5%â†“, 24h 10ì–µâ†‘)</h3>
      <button class="btn" id="btnNewDrop">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn" id="btnFeedDrop">í”¼ë“œ ë¹„ìš°ê¸°</button>
    </div>
    <div class="row head"><div>#</div><div>ì½”ì¸ëª…(í•œê¸€)</div><div>í˜„ì¬ê°€</div><div>ë³€ë™ë¥ </div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ìœ„í—˜ë„</div><div>ì©”ì–´í•œë§ˆë””</div></div>
    <div class="table" id="dropTable"></div>
  </section>
</main>

<script>
/* ---------- ìœ í‹¸ ---------- */
const KR = new Intl.NumberFormat('ko-KR');
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const $ = (q)=>document.querySelector(q);
const api = (p)=>`/api/upbit?path=${encodeURIComponent(p)}`;
const state = { markets:[], byMarket:{}, nameByMarket:{}, marketByName:{}, krw:[] };

function priceUnit(p){ // ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ê·¼ì‚¬
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 5;
  if (p >= 100)     return 1;
  if (p >= 10)      return 0.1;
  return 0.01;
}
function fmtKRW(x){
  if (x==null||isNaN(x)) return 'â€”';
  const unit = priceUnit(x);
  const dec = Math.max(0, unit.toString().split('.')[1]?.length || 0);
  return x.toLocaleString('ko-KR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
}

/* ---------- API ---------- */
async function upbit(p){
  const r = await fetch(api(p), { cache:'no-store' });
  if (!r.ok) throw new Error(`UPBIT ${r.status}`);
  return r.json();
}
async function loadMarkets(){
  const arr = await upbit('/v1/market/all?isDetails=true');
  state.markets = arr.filter(x=>x.market.startsWith('KRW-'));
  state.krw = state.markets.map(x=>x.market);
  state.byMarket = {};
  state.nameByMarket = {};
  state.marketByName = {};
  for (const m of state.markets){
    state.byMarket[m.market] = m;
    state.nameByMarket[m.market] = m.korean_name;
    state.marketByName[m.korean_name] = m.market;
    state.marketByName[m.market.split('-')[1]] = m.market; // ì‹¬ë³¼ë¡œë„ ì¡°íšŒ
  }
}

/* ---------- ì„ íƒì½”ì¸ ê³„ì‚° ---------- */
function levels(price){
  const u = priceUnit(price);
  const buy = price - 2*u, sell = price + 2*u, cut = price - 6*u;
  return { buy, sell, cut };
}
function riskTag(chg){
  if (chg>=10) return {t:'3(ì£¼ì˜)', c:'bad'};
  if (chg>=5)  return {t:'2(ë³´í†µ)', c:'warn'};
  return {t:'1(ì•ˆì •)', c:'ok'};
}
function zzeolWord(chg){
  if (chg>=12) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
  if (chg>=5)  return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  if (chg<=-8) return 'ğŸ§¯ ê¸‰ë½ ì£¼ì˜!';
  if (chg<=-3) return 'âš ï¸ ì¡°ì • êµ¬ê°„';
  return 'ğŸ‘€ ê´€ë§';
}

async function showSelected(market){
  try{
    const t = (await upbit('/v1/ticker?markets='+encodeURIComponent(market)))[0];
    const name = state.nameByMarket[market] || market;
    const chg = Math.round((t.signed_change_rate||0)*1000)/10; // %
    const lv = levels(t.trade_price);
    $('#selName').textContent = name;
    $('#selMarket').textContent = market;
    $('#p_now').textContent = fmtKRW(t.trade_price);
    $('#p_buy').textContent = fmtKRW(lv.buy);
    $('#p_sell').textContent = fmtKRW(lv.sell);
    $('#p_cut').textContent = fmtKRW(lv.cut);
    $('#p_chg').textContent = (chg>0?'+':'')+chg+'%';
    const rk = riskTag(chg);
    $('#p_risk').textContent = rk.t; $('#p_risk').className = rk.c;
    $('#p_zzeol').textContent = zzeolWord(chg); $('#p_zzeol').className = (chg>=5?'warn':chg<=-5?'bad':'muted');
  }catch(e){
    console.error(e);
  }
}

/* ---------- ê¸‰ë“±/ê¸‰ë½ ìŠ¤ìºë„ˆ ---------- */
async function scanTop(kind='top'){ // top: +5% / drop: -5%
  if (!state.krw.length) return [];
  const chunks = [];
  const res = [];
  const ms = state.krw.slice();
  // 40ê°œ ë‹¨ìœ„ë¡œ API ë¶€í•˜ ë¶„í• 
  while(ms.length) chunks.push(ms.splice(0,40));
  for (const c of chunks){
    const t = await upbit('/v1/ticker?markets='+encodeURIComponent(c.join(',')));
    for (const x of t){
      const chg = (x.signed_change_rate||0)*100;
      const vol = x.acc_trade_price_24h || 0; // KRW
      const pass = kind==='top' ? (chg>=5 && vol>=1e9) : (chg<=-5 && vol>=1e9);
      if (pass){
        const lv = levels(x.trade_price);
        res.push({
          market:x.market,
          name:state.nameByMarket[x.market]||x.market,
          price:x.trade_price,
          chg:Math.round(chg*10)/10,
          buy:lv.buy, sell:lv.sell, cut:lv.cut,
          risk:riskTag(chg).t,
          word:zzeolWord(chg)
        });
      }
    }
    await sleep(120); // ì‚´ì§ ì‰¬ì–´ì£¼ê¸°(429 ë°©ì§€)
  }
  // ë³€ë™ë¥  ë‚´ë¦¼ì°¨ìˆœ / ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  res.sort((a,b)=>kind==='top' ? b.chg-a.chg : a.chg-b.chg);
  return res.slice(0,10);
}

function renderList(targetId, list){
  const host = $(targetId);
  host.innerHTML = '';
  if (!list.length){
    const d = document.createElement('div');
    d.className='row'; d.innerHTML = `<div class="muted" style="grid-column:1/-1;padding:16px">ì¡°ê±´ì— ë§ëŠ” ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.</div>`;
    host.appendChild(d); return;
  }
  list.forEach((it,i)=>{
    const r = document.createElement('div');
    r.className='row';
    r.innerHTML = `
      <div>${i+1}</div>
      <div><span class="chip">${it.name}</span></div>
      <div class="k">${fmtKRW(it.price)}</div>
      <div class="k ${it.chg>=0?'ok':'bad'}">${it.chg>0?'+':''}${it.chg}%</div>
      <div class="k">${fmtKRW(it.buy)}</div>
      <div class="k">${fmtKRW(it.sell)}</div>
      <div class="k">${fmtKRW(it.cut)}</div>
      <div>${it.risk}</div>
      <div>${it.word}</div>
    `;
    r.style.cursor='pointer';
    r.onclick=()=>showSelected(it.market);
    host.appendChild(r);
  });
}

/* ---------- ì´ë²¤íŠ¸ & ì´ˆê¸°í™” ---------- */
async function doSearch(){
  const q = $('#q').value.trim();
  if (!q) return;
  // ìš°ì„ ìˆœìœ„: ì •í™•í•œ í•œê¸€ëª… > ì‹¬ë³¼ > KRW-ë§ˆì¼“
  let mkt = state.marketByName[q];
  if (!mkt && state.marketByName[q.toUpperCase()]) mkt = state.marketByName[q.toUpperCase()];
  if (!mkt && /^KRW-/.test(q.toUpperCase())) mkt = q.toUpperCase();
  if (!mkt){
    alert('í•´ë‹¹ ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)');
    return;
  }
  await showSelected(mkt);
}
async function refreshTop(){ renderList('#topTable', await scanTop('top')); }
async function refreshDrop(){ renderList('#dropTable', await scanTop('drop')); }

function tick(){
  const n = navigator.onLine;
  $('#net').textContent = n?'ONLINE':'OFFLINE';
  $('#net').style.background = n?'#062a1f':'#2a0d0d';
  const now = new Date(); $('#clock').textContent =
    'KST â€” ' + now.toLocaleTimeString('ko-KR',{hour12:false});
}

(async function init(){
  tick(); setInterval(tick,1000);
  $('#btnFind').onclick = doSearch;
  $('#btnReset').onclick = ()=>{ $('#q').value=''; $('#selName').textContent='ì—†ìŒ'; $('#selMarket').textContent='â€”';
    ['#p_now','#p_buy','#p_sell','#p_cut','#p_risk','#p_zzeol','#p_chg'].forEach(id=>$(id).textContent='â€”'); };
  $('#btnNewTop').onclick = refreshTop;
  $('#btnFeedTop').onclick = ()=>$('#topTable').innerHTML='';
  $('#btnNewDrop').onclick = refreshDrop;
  $('#btnFeedDrop').onclick = ()=>$('#dropTable').innerHTML='';

  try{
    await loadMarkets();
    // ì²« ë¡œë”© ì‹œ ê¸‰ë“±/ê¸‰ë½ ìë™ í•œ ë²ˆ
    refreshTop(); refreshDrop();
  }catch(e){
    console.error(e);
  }
})();
</script>
</body>
</html>
