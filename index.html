<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v6.3</title>
<style>
  :root{
    --bg:#0b1218; --panel:#0e1722; --line:#1f2a37; --txt:#e5e7eb; --sub:#9aa4b2;
    --up:#2dd4bf; --down:#fb7185; --accent:#60a5fa; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 ui-sans-serif,system-ui,AppleSDGothicNeo,"맑은 고딕",Segoe UI,Roboto}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{padding:3px 8px;border-radius:999px;background:#132033;color:#9fb7d5;font-weight:600;font-size:12px}
  .badge.online{background:#0d2b1c;color:#7be6b0}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px}
  .panel.hdr{padding:12px 14px}
  .clock{margin-left:auto;color:var(--sub)}
  .searchbar{display:flex;gap:8px;margin:12px 0}
  .searchbar input{flex:1;background:#0b131d;border:1px solid var(--line);color:var(--txt);
                   border-radius:10px;padding:12px 14px;outline:none}
  .btn{background:#0d2236;color:#b9d1ff;border:1px solid #213247;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .grid{display:grid;gap:10px}
  .card{padding:10px 12px}
  .pill{padding:2px 8px;border-radius:999px;font-weight:700}
  .pill.up{background:rgba(45,212,191,.1); color:var(--up);border:1px solid rgba(45,212,191,.25)}
  .pill.down{background:rgba(251,113,133,.1); color:var(--down);border:1px solid rgba(251,113,133,.25)}
  .warning{background:rgba(245,158,11,.12);color:#ffcc7a;border:1px solid rgba(245,158,11,.25)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:12px 10px;border-bottom:1px solid var(--line);white-space:nowrap}
  th{position:sticky;top:0;background:var(--panel);z-index:1}
  .tbl-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--line)}
  .num{text-align:right}
  .ko{color:var(--sub)}
  .msg{display:inline-flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .zzac-wrap{position:relative;display:block}
  .zzac-list{position:absolute;top:100%;left:0;right:0;background:#0b131d;border:1px solid var(--line);
             border-radius:10px;overflow:auto;max-height:260px;z-index:20;display:none}
  .zzac-item{padding:10px 12px;display:flex;justify-content:space-between;cursor:pointer}
  .zzac-item:hover{background:#0f1823}
  .zzac-sym{font-weight:700}
  .zzac-ko{color:var(--sub)}
  .muted{color:var(--sub)}
  .section{padding:14px}
  .split{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.split{grid-template-columns:1fr 1fr}}
  .one-line{display:grid;grid-template-columns:120px repeat(7,1fr);gap:8px;align-items:center}
  .cell{padding:10px 12px;background:#0b131d;border:1px solid var(--line);border-radius:10px;text-align:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- 헤더 -->
  <div class="panel hdr row">
    <div class="row" style="gap:8px">
      <span class="badge">v6.3</span>
      <span id="net" class="badge">OFFLINE</span>
    </div>
    <div class="clock" id="clock">KST — --시 --분 --초</div>
  </div>

  <!-- 검색 -->
  <div class="searchbar zzac-wrap">
    <input id="q" placeholder="코인 검색 (예: 비트코인 / BTC / KRW-BTC / 제로지)" autocomplete="off" />
    <button class="btn" id="btnSearch">검색</button>
    <button class="btn" id="btnReset">초기화</button>
    <div class="zzac-list" id="acList"></div>
  </div>

  <!-- 선택 코인: 한 줄 헤더 (현재가, 변동률, 매수, 매도, 손절, 위험도, 쩔어한마디) -->
  <div class="panel section">
    <div class="one-line muted" style="margin-bottom:8px">
      <div class="cell">선택된 코인</div>
      <div class="cell">현재가</div>
      <div class="cell">변동률</div>
      <div class="cell">매수</div>
      <div class="cell">매도</div>
      <div class="cell">손절</div>
      <div class="cell">위험도</div>
      <div class="cell">쩔어한마디</div>
    </div>
    <div class="one-line" id="selectedRow">
      <div class="cell">없음 —</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
      <div class="cell">—</div>
    </div>
  </div>

  <!-- 급등/급락 -->
  <div class="split">

    <div class="panel section">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>🔥 급등코인 Top 10</span><span class="muted">(조건: 24h 변동률 상위)</span></div>
        <button class="btn" id="btnRefreshUp">새로고침</button>
      </div>
      <div class="tbl-wrap" id="wrapUp">
        <table>
          <thead>
          <tr>
            <th class="muted">#</th>
            <th>코인명(한글)</th>
            <th class="num">현재가</th>
            <th class="num">변동률</th>
            <th class="num">매수</th>
            <th class="num">매도</th>
            <th class="num">손절</th>
            <th class="num">위험도</th>
            <th>쩔어한마디</th>
          </tr>
          </thead>
          <tbody id="tblUp"></tbody>
        </table>
      </div>
    </div>

    <div class="panel section">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>💧 급락코인 Top 10</span><span class="muted">(조건: 24h 변동률 하위)</span></div>
        <button class="btn" id="btnRefreshDown">새로고침</button>
      </div>
      <div class="tbl-wrap" id="wrapDown">
        <table>
          <thead>
          <tr>
            <th class="muted">#</th>
            <th>코인명(한글)</th>
            <th class="num">현재가</th>
            <th class="num">변동률</th>
            <th class="num">매수</th>
            <th class="num">매도</th>
            <th class="num">손절</th>
            <th class="num">위험도</th>
            <th>쩔어한마디</th>
          </tr>
          </thead>
          <tbody id="tblDown"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/** ===============================
 *  Upbit proxy endpoint (Vercel)
 *  /api/upbit?path=/v1/market/all?isDetails=true
 *  /api/upbit?path=/v1/ticker?markets=KRW-BTC,KRW-ETH...
 *  =============================== */
const API = (p) => `/api/upbit?path=${encodeURIComponent(p)}`;

/** ---- 전역 상태 ---- */
const state = {
  online: false,
  markets: [],        // KRW-* only
  nameMap: {},        // { "BTC": "비트코인", ... }
  tickers: [],        // ticker array
  selected: null,     // 선택한 ticker
};

const $ = (s)=>document.querySelector(s);
const clock = $('#clock');
const net   = $('#net');

/** ---- KST Clock & Online ---- */
function tickClock(){
  const now = new Date();
  // 한국시간 (=UTC+9)
  const kst = new Date(now.getTime() + (9 - now.getTimezoneOffset()/60)*3600*1000);
  const hh = String(kst.getUTCHours()).padStart(2,'0');
  const mm = String(kst.getUTCMinutes()).padStart(2,'0');
  const ss = String(kst.getUTCSeconds()).padStart(2,'0');
  clock.textContent = `KST — ${hh}시 ${mm}분 ${ss}초`;
  net.textContent = state.online ? 'ONLINE' : 'OFFLINE';
  net.classList.toggle('online', state.online);
}
setInterval(tickClock, 1000); tickClock();

/** ---- 유틸 ---- */
const fmt = (n)=> (n==null || isNaN(n)) ? '—' :
  n>=1000 ? n.toLocaleString('ko-KR') : (''+(+n).toFixed(2)).replace(/\.00$/,'');

const fmtRate = (r)=> {
  if (r==null || isNaN(r)) return '—';
  const p = (r*100).toFixed(2) + '%';
  return r>=0 ? `<span class="pill up">${p}</span>` : `<span class="pill down">${p}</span>`;
};

// 업비트 호가단위 추정(간단)
function priceUnit(p){
  if      (p>=2_000_000) return 1000;
  else if (p>=1_000_000) return 500;
  else if (p>=500_000)   return 100;
  else if (p>=100_000)   return 50;
  else if (p>=10_000)    return 10;
  else if (p>=1000)      return 1;
  else if (p>=100)       return 0.1;
  else if (p>=10)        return 0.01;
  else if (p>=1)         return 0.001;
  else if (p>=0.1)       return 0.0001;
  else                   return 0.00001;
}

function msgFromRate(rate){
  if (rate>=0.08) return {txt:'🚀 폭등 모드!', cls:''};
  if (rate>=0.05) return {txt:'🔥 불장 신호!', cls:''};
  if (rate<=-0.08) return {txt:'⚠️ 급락 주의', cls:'warning'};
  return {txt:'👀 관망', cls:'muted'};
}

function riskFromRate(rate){
  if(rate==null) return '—';
  const lv = Math.min(3, Math.max(1, Math.ceil(Math.abs(rate*100)/3)));
  return `${lv}(주의)`;
}

/** ---- 마켓 로드 ---- */
async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'), {cache:'no-store'});
  const arr = await r.json();
  const krw = arr.filter(m => m.market?.startsWith('KRW-'));
  state.markets = krw.map(m=>({ market:m.market, korean_name:m.korean_name }));
  state.nameMap = Object.fromEntries(krw.map(m=>[m.market.split('-')[1], m.korean_name]));
  // 비트코인 가독성 보정
  if (state.nameMap['BTC'] === undefined) state.nameMap['BTC']='비트코인';
}

/** ---- 티커 배치 폴링 (429 회피) ---- */
async function loadTickers(){
  if (!state.markets.length) return;
  const batch = 30;
  const mkts = state.markets.map(m=>m.market);
  const chunks = [];
  for (let i=0;i<mkts.length;i+=batch) chunks.push(mkts.slice(i,i+batch));
  const out = [];
  for (const c of chunks){
    const url = API('/v1/ticker?markets='+c.join(','));
    const r = await fetch(url, {cache:'no-store'});
    const arr = await r.json();
    out.push(...arr);
    await new Promise(r=>setTimeout(r, 180)); // 살짝 텀
  }
  state.tickers = out;
  state.online = true;
}

/** ---- 렌더: 선택코인 한 줄 ---- */
function renderSelected(tk){
  state.selected = tk;
  const row = $('#selectedRow');
  if(!tk){ row.innerHTML = `
    <div class="cell">없음 —</div><div class="cell">—</div><div class="cell">—</div>
    <div class="cell">—</div><div class="cell">—</div><div class="cell">—</div>
    <div class="cell">—</div><div class="cell">—</div>`; return;
  }
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym]||sym;
  const price = tk.trade_price;
  const rate = tk.signed_change_rate; // upbit -1..+1
  const u = priceUnit(price);
  const buy = Math.max(0, price - 3*u);
  const sell= price + 3*u;
  const stop= Math.max(0, price - 8*u);
  const risk= riskFromRate(rate);
  const msg = msgFromRate(rate);

  row.innerHTML = `
    <div class="cell"><b>${name}</b> <span class="muted">(${tk.market})</span></div>
    <div class="cell">${fmt(price)}</div>
    <div class="cell">${fmtRate(rate)}</div>
    <div class="cell">${fmt(buy)}</div>
    <div class="cell">${fmt(sell)}</div>
    <div class="cell">${fmt(stop)}</div>
    <div class="cell">${risk}</div>
    <div class="cell ${msg.cls}">${msg.txt}</div>`;
}

/** ---- 렌더: 급등/급락 테이블 ---- */
function renderTables(){
  const upB = $('#tblUp'), dnB = $('#tblDown');
  upB.innerHTML = ''; dnB.innerHTML = '';
  if (!state.tickers.length) return;

  // map으로 ko 이름 부여
  const enrich = t => {
    const sym = t.market.split('-')[1];
    t._ko = state.nameMap[sym] || sym;
    return t;
  };

  const arr = state.tickers.map(enrich);

  const ups = arr
    .filter(t=>t.signed_change_rate>0)
    .sort((a,b)=>b.signed_change_rate - a.signed_change_rate)
    .slice(0,10);

  const dns = arr
    .filter(t=>t.signed_change_rate<0)
    .sort((a,b)=>a.signed_change_rate - b.signed_change_rate)
    .slice(0,10);

  function rowHTML(t, i){
    const price = t.trade_price;
    const rate = t.signed_change_rate;
    const u = priceUnit(price);
    const buy = Math.max(0, price - 3*u);
    const sell= price + 3*u;
    const stop= Math.max(0, price - 8*u);
    const msg = msgFromRate(rate);
    const risk = riskFromRate(rate);

    return `<tr data-m="${t.market}">
      <td class="muted">${i+1}</td>
      <td><b>${t._ko}</b> <span class="ko">(${t.market})</span></td>
      <td class="num">${fmt(price)}</td>
      <td class="num">${fmtRate(rate)}</td>
      <td class="num">${fmt(buy)}</td>
      <td class="num">${fmt(sell)}</td>
      <td class="num">${fmt(stop)}</td>
      <td class="num"><span class="pill warning">${risk}</span></td>
      <td><span class="msg ${msg.cls}">${msg.txt}</span></td>
    </tr>`;
  }

  ups.forEach((t,i)=> upB.insertAdjacentHTML('beforeend', rowHTML(t,i)));
  dns.forEach((t,i)=> dnB.insertAdjacentHTML('beforeend', rowHTML(t,i)));

  // 행 클릭 = 선택코인 갱신
  upB.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if(tk) renderSelected(tk);
    });
  });
  dnB.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if(tk) renderSelected(tk);
    });
  });
}

/** ---- 자동완성 + 검색 ---- */
(function searchModule(){
  const q = $('#q'), btn = $('#btnSearch'), reset = $('#btnReset');
  const ac = $('#acList');

  let idx = [];  // {market,symbol,ko}

  function buildIndex(){
    idx = state.markets.map(m=>{
      const sym = m.market.split('-')[1];
      return {market:m.market, symbol:sym, ko: state.nameMap[sym]||m.korean_name||sym};
    });
  }

  function showList(v){
    ac.innerHTML = '';
    const Q = (v||'').trim().toUpperCase();
    if(!Q){ ac.style.display='none'; return; }
    const list = idx.filter(x =>
      x.market.includes(Q) || x.symbol.includes(Q) || (x.ko||'').toUpperCase().includes(Q)
    ).slice(0,20);
    if(!list.length){ ac.style.display='none'; return; }
    list.forEach(it=>{
      const d = document.createElement('div');
      d.className='zzac-item';
      d.innerHTML = `<div class="zzac-sym">${it.symbol}</div><div class="zzac-ko">${it.ko}</div>`;
      d.onclick = () => { ac.style.display='none'; choose(it.market); };
      ac.appendChild(d);
    });
    ac.style.display='block';
  }

  function choose(market){
    const tk = state.tickers.find(t=>t.market===market);
    if(!tk){ alert('데이터 준비 중입니다. 잠시 후 다시 시도해주세요.'); return; }
    renderSelected(tk);
  }

  q.addEventListener('input', ()=>showList(q.value));
  q.addEventListener('focus', ()=>showList(q.value));
  q.addEventListener('blur', ()=>setTimeout(()=>ac.style.display='none',120));

  q.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const v = (q.value||'').trim().toUpperCase();
      if(!v) return;
      const hit = idx.find(x=> x.market===v || x.symbol===v ||
        (x.ko||'').toUpperCase().includes(v));
      if(hit) choose(hit.market);
      else alert('검색 결과가 없습니다.');
    }
  });

  btn.addEventListener('click', ()=>{
    const v = (q.value||'').trim().toUpperCase();
    if(!v) return;
    const hit = idx.find(x=> x.market===v || x.symbol===v ||
      (x.ko||'').toUpperCase().includes(v));
    if(hit) choose(hit.market);
    else alert('검색 결과가 없습니다.');
  });

  reset.addEventListener('click', ()=>{
    q.value=''; ac.style.display='none'; renderSelected(null);
  });

  // 인덱스 유지 업데이트
  setInterval(()=>{ if(state.markets.length) buildIndex(); }, 1000);
})();

/** ---- 화면 흔들림 방지: 스크롤 보존 ---- */
const preserveScroll = (fn)=>{
  try{
    const up=$('#wrapUp'), dn=$('#wrapDown');
    const ut=up.scrollTop, dt=dn.scrollTop;
    fn();
    up.scrollTop=ut; dn.scrollTop=dt;
  }catch(e){ fn(); }
};

/** ---- 주기적 업데이트 ---- */
async function loop(){
  try{
    if(!state.markets.length) await loadMarkets();
    await loadTickers();
    preserveScroll(renderTables);
    if(state.selected){
      const cur = state.tickers.find(t=>t.market===state.selected.market);
      if(cur) renderSelected(cur);
    }
  }catch(e){
    console.error(e);
    state.online=false;
  }finally{
    setTimeout(loop, 4000); // 4초 주기
  }
}
loop();

$('#btnRefreshUp').onclick = ()=>preserveScroll(renderTables);
$('#btnRefreshDown').onclick = ()=>preserveScroll(renderTables);

</script>
</body>
</html>
