<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v7.0 (복원 안정판)</title>
<style>
  :root{
    --bg:#0f1318; --panel:#141a21; --muted:#9aa4af; --txt:#e8eef5; --accent:#3aa3ff;
    --up:#20c997; --down:#ff6b6b; --warn:#ffb020; --chip:#1b2330; --line:#1b2330;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 Pretendard,Apple SD Gothic Neo,Segoe UI,Roboto,sans-serif}
  header{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:5}
  .badge{padding:2px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-weight:600}
  .ok{color:#9cff77}
  .clock{margin-left:auto;color:var(--muted)}
  .wrap{max-width:1140px;margin:0 auto;padding:16px}
  .searchbar{display:flex;gap:8px}
  .searchbar input{flex:1;background:var(--panel);border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:12px 14px}
  .btn{background:var(--chip);border:1px solid var(--line);color:var(--txt);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .row{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
  .kpis{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px;text-align:center}
  .kpis h6{margin:0 0 6px;font-size:12px;color:var(--muted)}
  .kpis .v{font-weight:700}
  .up{color:var(--up)} .down{color:var(--down)}
  section{margin-top:22px}
  h2{margin:10px 0 8px;font-size:16px}
  .table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:right}
  .table th:first-child,.table td:first-child{text-align:center;width:40px}
  .table th:nth-child(2),.table td:nth-child(2){text-align:left}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-weight:600}
  .hint{color:var(--muted);font-size:12px}
  .tag{padding:2px 8px;border-radius:999px;background:#0f2130}
  .tag.up{background:#0e2a22;color:#75f0c8}
  .tag.down{background:#2a1414;color:#ff9b9b}
  .tag.warn{background:#2a1f0e;color:#ffd684}
  .right{float:right}
  .notice{margin-top:8px;color:var(--muted);font-size:12px}
  @media (max-width:920px){
    .row{grid-template-columns:repeat(2,1fr)}
    .table{font-size:13px}
    .table th:nth-child(6),.table td:nth-child(6){display:none} /* 위험도 칼럼 모바일에서 접기 */
  }
</style>
</head>
<body>
<header>
  <span class="badge">쩔어지갑 v7.0</span>
  <span class="badge ok">ONLINE</span>
  <span class="badge">KST — <span id="kst">--:--:--</span></span>
  <span class="clock" id="clockMsg">실시간 급등형(REST 폴링 안정화)</span>
</header>

<div class="wrap">
  <!-- 검색 -->
  <div class="searchbar">
    <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH)" />
    <button class="btn" id="btnSearch">검색</button>
    <button class="btn" id="btnReset">초기화</button>
  </div>

  <!-- 선택한 코인 요약 -->
  <div class="row" id="summaryRow" style="display:none">
    <div class="kpis"><h6>현재가</h6><div class="v" id="s_price">-</div></div>
    <div class="kpis"><h6>변동률</h6><div class="v" id="s_change">-</div></div>
    <div class="kpis"><h6>매수</h6><div class="v" id="s_bid">-</div></div>
    <div class="kpis"><h6>매도</h6><div class="v" id="s_ask">-</div></div>
    <div class="kpis"><h6>손절</h6><div class="v" id="s_cut">-</div></div>
    <div class="kpis"><h6>위험도</h6><div class="v" id="s_risk">-</div></div>
    <div class="kpis"><h6>쩔어한마디</h6><div class="v" id="s_ment">-</div></div>
  </div>
  <div id="selName" class="notice"></div>

  <!-- 급등 -->
  <section>
    <h2>🔥 급등코인 Top 10 <span class="hint">(조건: 24h 변동률 상위)</span></h2>
    <table class="table" id="tblUp">
      <thead>
        <tr>
          <th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 급락 -->
  <section>
    <h2>💧 급락코인 Top 10 <span class="hint">(조건: 24h 변동률 하위)</span></h2>
    <table class="table" id="tblDown">
      <thead>
        <tr>
          <th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div class="notice">
    ※ 본 서비스는 투자 참고용으로, 모든 책임은 이용자 본인에게 있습니다. 데이터: Upbit Public API / 3~5초 폴링 안정화.
  </div>
</div>

<script>
const api = (p)=>fetch('/api/upbit?path='+encodeURIComponent(p),{cache:'no-store'}).then(r=>r.json());
const KRW_ONLY = true;          // 원화마켓만
const POLL_MS   = 4000;          // 4초 폴링
let MARKETS = [];                // [{market, korean_name, english_name}]
let MAP = {};                    // market -> {korean_name, english_name}
let lastSummaryMarket = null;
let pollTimer = null;

// 시계
setInterval(()=>{
  const d = new Date();
  document.getElementById('kst').textContent =
    new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Seoul'}).format(d);
}, 500);

// 마켓 목록 로드
async function loadMarkets(){
  const list = await api('/v1/market/all?isDetails=true');
  MARKETS = (KRW_ONLY ? list.filter(x=>x.market.startsWith('KRW-')) : list);
  MARKETS.forEach(m=>MAP[m.market]=m);
}

function fmt(n){ if(n==null||isNaN(n)) return '-'; return Number(n).toLocaleString('ko-KR'); }
function pct(v){
  if(v==null||isNaN(v)) return '-';
  const p = (Number(v)*100).toFixed(2)+'%';
  return (v>=0?`<span class="up">${p}</span>`:`<span class="down">${p}</span>`);
}

function riskTag(spread, vol){
  // 스프레드(매도-매수 비율) + 24h 변동률 절대값 기준
  const sp = spread;   // %
  const abv = Math.abs(vol)*100;
  if (abv>12 || sp>0.45) return `<span class="tag down">3(주의)</span>`;
  if (abv>6  || sp>0.25) return `<span class="tag warn">2(보통)</span>`;
  return `<span class="tag up">1(안정)</span>`;
}
function zMsg(rate){
  const r=rate*100;
  if (r>20) return '🚀 폭등 모드!';
  if (r>8)  return '📈 상승중';
  if (r<-12) return '🔻 낙폭경계';
  if (r<-6)  return '⚠️ 하락중';
  return '👀 관망';
}

async function pollBoards(){
  // ① KRW 전체 티커
  const codes = MARKETS.map(m=>m.market).join(',');
  const tks = await api('/v1/ticker?markets='+codes);
  // ② 일부 마켓의 호가(매수/매도) — 상위 30개만 요청(트래픽 절감)
  const topByAbs = [...tks].sort((a,b)=>Math.abs(b.signed_change_rate)-Math.abs(a.signed_change_rate)).slice(0,30);
  const obCodes = topByAbs.map(x=>x.market).join(',');
  const obs = obCodes ? await api('/v1/orderbook?markets='+obCodes) : [];

  const best = {};
  obs.forEach(x=>{
    const unit = x.orderbook_units?.[0];
    if (!unit) return;
    best[x.market] = { bid: unit.bid_price, ask: unit.ask_price };
  });

  // 급등/급락 분리
  const ups   = [...tks].sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const downs = [...tks].sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);

  renderBoard('tblUp', ups, best);
  renderBoard('tblDown', downs, best);

  // 선택 코인 요약 갱신
  if (lastSummaryMarket){
    const one = tks.find(x=>x.market===lastSummaryMarket);
    const ob  = best[lastSummaryMarket];
    if (one) renderSummary(one, ob);
  }
}

function renderBoard(tblId, list, best){
  const tb = document.querySelector('#'+tblId+' tbody');
  tb.innerHTML = '';
  list.forEach((x,i)=>{
    const m = MAP[x.market];
    const prices = best[x.market] || {};
    const bid = prices.bid ?? x.trade_price;   // 없으면 현재가
    const ask = prices.ask ?? x.trade_price;
    const spread = (ask-bid)/x.trade_price;    // 비율
    const cut = Math.max(0, x.trade_price*0.97); // 단순 손절 3%

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td style="text-align:left;cursor:pointer" data-market="${x.market}">
        ${m?.korean_name || x.market} <span class="hint">(${x.market})</span>
      </td>
      <td>${fmt(x.trade_price)}</td>
      <td>${pct(x.signed_change_rate)}</td>
      <td>${fmt(bid)}</td>
      <td>${fmt(ask)}</td>
      <td>${fmt(cut)}</td>
      <td>${riskTag(spread, x.signed_change_rate)}</td>
      <td class="hint">${zMsg(x.signed_change_rate)}</td>
    `;
    // 클릭 시 요약 상단 고정
    tr.querySelector('[data-market]').addEventListener('click', ()=>{
      lastSummaryMarket = x.market;
      renderSummary(x, best[x.market]);
      document.getElementById('summaryRow').style.display='grid';
      const name = `${m?.korean_name || x.market} (${x.market})`;
      document.getElementById('selName').innerHTML = `선택된 코인: <b>${name}</b>`;
      window.scrollTo({top:0,behavior:'smooth'});
    });
    tb.appendChild(tr);
  });
}

function renderSummary(x, ob){
  const bid = ob?.bid ?? x.trade_price;
  const ask = ob?.ask ?? x.trade_price;
  const cut = Math.max(0, x.trade_price*0.97);
  const spread = (ask-bid)/x.trade_price;

  document.getElementById('s_price').innerHTML  = fmt(x.trade_price);
  document.getElementById('s_change').innerHTML = pct(x.signed_change_rate);
  document.getElementById('s_bid').innerHTML    = fmt(bid);
  document.getElementById('s_ask').innerHTML    = fmt(ask);
  document.getElementById('s_cut').innerHTML    = fmt(cut);
  document.getElementById('s_risk').innerHTML   = riskTag(spread, x.signed_change_rate);
  document.getElementById('s_ment').textContent = zMsg(x.signed_change_rate);
}

// 검색
function norm(s){return s.replace(/\s+/g,'').toLowerCase();}
function findMarket(q){
  const s = norm(q);
  // market code
  let hit = MARKETS.find(m=>norm(m.market)===s);
  if (hit) return hit.market;
  // KRW-ETH 처럼 앞 생략 입력 시
  hit = MARKETS.find(m=>norm(m.market.split('-')[1])===s);
  if (hit) return hit.market;
  // 한글명
  hit = MARKETS.find(m=>norm(m.korean_name).includes(s));
  if (hit) return hit.market;
  // 영문명
  hit = MARKETS.find(m=>norm(m.english_name).includes(s));
  if (hit) return hit.market;
  return null;
}

async function doSearch(){
  const q = document.getElementById('q').value.trim();
  const code = findMarket(q);
  if (!code){
    alert('코인을 찾지 못했습니다.');
    return;
  }
  // 해당 티커 + 호가 취득 후 요약
  const [t] = await api('/v1/ticker?markets='+code);
  const [o] = await api('/v1/orderbook?markets='+code);
  lastSummaryMarket = code;
  renderSummary(t, o?.orderbook_units?.[0] ? {bid:o.orderbook_units[0].bid_price, ask:o.orderbook_units[0].ask_price} : null);
  document.getElementById('summaryRow').style.display='grid';
  const m = MAP[code];
  document.getElementById('selName').innerHTML = `선택된 코인: <b>${m?.korean_name || code} (${code})</b>`;
  window.scrollTo({top:0,behavior:'smooth'});
}

document.getElementById('btnSearch').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  lastSummaryMarket = null;
  document.getElementById('summaryRow').style.display='none';
  document.getElementById('selName').textContent='';
  document.getElementById('q').value='';
});

// 시작
(async function init(){
  await loadMarkets();
  await pollBoards();
  clearInterval(pollTimer);
  pollTimer = setInterval(pollBoards, POLL_MS);
})();
</script>
</body>
</html>
