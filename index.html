<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 — 즉시 갱신 버전</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121923;--text:#e6edf3;--muted:#8aa0b6;--up:#16c784;--down:#ea3943;--chip:#1a2330}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Helvetica,Arial}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
    .badge{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .search{display:flex;gap:8px;align-items:center;position:relative;flex:1;min-width:280px}
    .search input{flex:1;padding:12px;border-radius:10px;border:1px solid #243142;outline:none;background:#0e141d;color:var(--text)}
    .list{position:absolute;top:44px;left:0;right:0;max-height:280px;overflow:auto;background:#0e141d;border:1px solid #243142;border-radius:10px;opacity:0;transition:opacity .08s linear;z-index:10}
    .list.show{opacity:1;}
    .item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #17202b}
    .item:hover{background:#101926}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .cell{background:#0e141d;border:1px solid #243142;border-radius:10px;padding:12px;text-align:center}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .value{font-size:17px;font-weight:700}
    .price{font-size:28px;font-weight:800}
    .diff.up{color:var(--up)}.diff.down{color:var(--down)}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>쩔어지갑 <span class="badge">즉시 갱신</span> <span class="badge" id="net">OFFLINE</span></h1>
      <div class="badge" id="clock">KST — --:--:--</div>
    </header>

    <div class="row" style="margin-bottom:10px">
      <div class="search card">
        <input id="search" placeholder="코인 검색 (예: 비트코인, 시바이누)" autocomplete="off" />
        <div class="list" id="list"></div>
      </div>
      <button class="card" id="reset">초기화</button>
    </div>

    <div class="card" id="panel">
      <div style="display:flex;justify-content:space-between;align-items:end;gap:10px;flex-wrap:wrap">
        <div>
          <div id="coin-name" style="font-size:18px;font-weight:700">선택된 코인: <span style="color:var(--muted)">없음</span></div>
          <div id="market" class="badge" style="margin-top:6px">—</div>
        </div>
        <div style="text-align:right">
          <div id="price" class="price">—</div>
          <div id="change" class="diff">—</div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="cell"><div class="label">현재가</div><div class="value" id="v_price">—</div></div>
        <div class="cell"><div class="label">매수 타점</div><div class="value" id="v_buy">—</div></div>
        <div class="cell"><div class="label">매도 타점</div><div class="value" id="v_sell">—</div></div>
        <div class="cell"><div class="label">손절</div><div class="value" id="v_stop">—</div></div>
        <div class="cell"><div class="label">위험도</div><div class="value" id="v_risk">—</div></div>
        <div class="cell"><div class="label">쩔어 한마디</div><div class="value" id="v_comment">—</div></div>
      </div>
    </div>
  </div>

  <script src="net_upbit.js"></script>
  <script>
    const $=(id)=>document.getElementById(id);
    let currentMarket=null, stopSub=null;

    function tick(){
      const now=new Date(),utc=now.getTime()+now.getTimezoneOffset()*60000;
      const kst=new Date(utc+9*3600000);
      $('clock').textContent='KST — '+kst.toLocaleTimeString('ko-KR',{hour12:false});
      $('net').textContent=navigator.onLine?'ONLINE':'OFFLINE';
      $('net').style.background=navigator.onLine?'#123922':'#3a1a1a';
    }
    setInterval(tick,1000); tick();

    function clearPanel(){
      ['price','change','v_price','v_buy','v_sell','v_stop','v_risk','v_comment'].forEach(id=>$(id).textContent='—');
      $('coin-name').innerHTML='선택된 코인: <span style="color:#8aa0b6">없음</span>';
      $('market').textContent='—';
    }

    function compute(price, rate){
      const buy=price*0.988, sell=price*1.012, stop=price*0.975;
      const r=Math.abs(rate*100);
      const risk=r<1?'1(안정)':r<2?'2(보통)':r<4?'3(주의)':'4(높음)';
      const comment=rate>0.02?'단기 급등 주의!':rate<-0.02?'급락 리스크 — 관망!':'무난';
      return {buy,sell,stop,risk,comment};
    }

    function updatePanel(t){
      if(!t)return;
      const fmt=Upbit.formatKRW, p=t.trade_price, rate=t.signed_change_rate||0;
      $('price').textContent=fmt(p)+' 원';
      $('change').className='diff '+(t.change==='RISE'?'up':t.change==='FALL'?'down':'');
      $('change').textContent=`${t.change==='RISE'?'+':''}${(rate*100).toFixed(2)}%`;
      $('v_price').textContent=fmt(p)+' 원';
      const c=compute(p,rate);
      $('v_buy').textContent=fmt(c.buy)+' 원';
      $('v_sell').textContent=fmt(c.sell)+' 원';
      $('v_stop').textContent=fmt(c.stop)+' 원';
      $('v_risk').textContent=c.risk;
      $('v_comment').textContent=c.comment;
    }

    function select(market){
      if(stopSub){try{stopSub();}catch{}stopSub=null;}
      currentMarket=market;
      clearPanel();

      const meta=(window.__krwList||[]).find(x=>x.market===market);
      $('market').textContent=market;
      $('coin-name').innerHTML=`${meta?meta.korean_name:''} <span style="color:#8aa0b6">(${market.replace('KRW-','')})</span>`;

      // ✅ 선택 즉시 현재가/매수/매도/손절/위험도/쩔어한마디 갱신
      Upbit.getTickerOnce(market).then(t=>{ if(currentMarket!==market)return; updatePanel(t); });
      stopSub=Upbit.subscribeTicker(market,t=>{ if(currentMarket!==market)return; updatePanel(t); });
    }

    Upbit.initKRWMarkets().then(list=>{
      window.__krwList=list;
      const box=$('list'),input=$('search');
      const render=(q)=>{
        const s=(q||'').toLowerCase();
        const items=list.filter(m=>(m.korean_name+m.market).toLowerCase().includes(s)).slice(0,50);
        box.innerHTML=items.map(m=>`<div class="item" data-m="${m.market}"><b>${m.korean_name}</b> <span style="color:#8aa0b6">(${m.market.replace('KRW-','')})</span></div>`).join('');
        box.classList.add('show');
      };

      input.addEventListener('input',()=>render(input.value));
      input.addEventListener('focus',()=>render(input.value));
      document.addEventListener('click',e=>{if(!e.target.closest('.search'))box.classList.remove('show');});

      // ✅ 선택 즉시 패널 업데이트
      box.addEventListener('click',e=>{
        const el=e.target.closest('.item'); if(!el)return;
        const market=el.dataset.m;
        input.value=''; box.classList.remove('show');
        select(market);
      });

      input.addEventListener('keydown',e=>{
        if(e.key==='Enter'){const first=box.querySelector('.item');if(first)first.click();}
      });
    });

    $('reset').onclick=()=>location.reload();
  </script>
</body>
</html>
