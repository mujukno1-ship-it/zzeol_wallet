<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3+</title>
<style>
  :root{
    --bg:#0f1419;--panel:#141a20;--line:#1e2630;--text:#e9eef5;--muted:#93a0b4;
    --pos:#00d17a;--neg:#ff5370;--chip:#1f2833;--chip-line:#2b3643;--brand:#5ac8fa;
    --warn:#ffb020;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Apple SD Gothic Neo,Pretendard,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0b1118;border:1px solid var(--chip-line);color:var(--muted)}
  .ok{color:#9fe4ff}
  .online{color:#53ffa8}
  .muted{color:var(--muted)}
  .btn{cursor:pointer;background:var(--chip);border:1px solid var(--chip-line);color:var(--text);padding:8px 12px;border-radius:8px}
  .btn:hover{filter:brightness(1.1)}
  .btn-lite{padding:6px 10px}
  .input{flex:1;min-width:260px;background:#0b1118;border:1px solid var(--chip-line);color:var(--text);padding:10px 12px;border-radius:8px;outline:none}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px}
  .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .body{padding:12px 14px}
  .grid{display:grid;gap:10px}
  .grid.cols-7{grid-template-columns:repeat(7,1fr)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--chip-line);border-radius:999px;background:var(--chip);font-weight:600}
  .pill.pos{color:var(--pos)} .pill.neg{color:var(--neg)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:right;white-space:nowrap}
  th:first-child,td:first-child{text-align:center}
  th:nth-child(2),td:nth-child(2){text-align:left}
  thead th{position:sticky;top:0;background:var(--panel);z-index:1}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--chip-line);border-radius:999px;background:var(--chip);color:var(--muted)}
  .chip.warn{color:#ffc46b;border-color:#4b3a17;background:#1e1609}
  .chip.risk{color:#ffd1d9;border-color:#3a2126;background:#160c0e}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .right{margin-left:auto}
  .hint{font-size:12px;color:var(--muted)}
  .divider{height:1px;background:var(--line);margin:12px 0}
</style>
</head>
<body>
<div class="wrap">

  <!-- ìƒë‹¨ë°” -->
  <div class="row" style="justify-content:space-between;margin-bottom:12px">
    <div class="row">
      <span class="badge">ì©”ì–´ì§€ê°‘ <b>v6.3+</b></span>
      <span class="badge online">ONLINE</span>
      <span id="clock" class="badge"></span>
    </div>
    <div class="row">
      <span class="hint">ì—…ë¹„íŠ¸ í”„ë¡ì‹œ: <b class="ok">/api/upbit</b></span>
    </div>
  </div>

  <!-- ê²€ìƒ‰/ëª…ë ¹ì¤„ -->
  <div class="row" style="margin-bottom:14px">
    <input id="q" class="input" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
    <button id="btnSearch" class="btn">ê²€ìƒ‰</button>
    <button id="btnReset" class="btn btn-lite">ì´ˆê¸°í™”</button>
    <button id="btnRefresh" class="btn btn-lite">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <!-- ì„ íƒëœ ì½”ì¸ ìš”ì•½ (ê°€ë¡œ í•œì¤„) -->
  <div class="panel" id="selectedPanel">
    <div class="head">
      <div class="title">
        <span class="badge">ì„ íƒëœ ì½”ì¸</span>
        <span id="selName" class="muted">ì—†ìŒ â€”</span>
      </div>
      <div class="row">
        <label class="row muted"><input id="optStrong" type="checkbox" style="margin-right:6px">ìƒìŠ¹ íƒìƒ‰</label>
      </div>
    </div>
    <div class="body">
      <div class="grid cols-7 muted" style="margin-bottom:6px">
        <div>í˜„ì¬ê°€</div><div>ë§¤ìˆ˜</div><div>ë§¤ë„</div><div>ì†ì ˆ</div><div>ë³€ë™ë¥ </div><div>ìœ„í—˜ë„</div><div>ì©”ì–´í•œë§ˆë””</div>
      </div>
      <div class="grid cols-7" id="selGrid">
        <div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div>
      </div>
      <div class="divider"></div>
      <div class="hint">â€» í•œ ì¤„ ìš”ì•½: <b>í˜„ì¬ê°€ Â· ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ Â· ë³€ë™ë¥  Â· ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</b></div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ Top10 -->
  <div class="panel" style="margin-top:16px">
    <div class="head">
      <div class="title">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <span class="muted" id="condUp"> (ì¡°ê±´: 5% â†‘, 24h 10ì–µ â†‘)</span></div>
      <div class="row">
        <button id="btnUpPurge" class="btn btn-lite">ë¹„ìš°ê¸°</button>
      </div>
    </div>
    <div class="body">
      <div style="overflow:auto;max-height:420px">
        <table id="tblUp">
          <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
            <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px">
    <div class="head">
      <div class="title">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 <span class="muted" id="condDown"> (ì¡°ê±´: -5% â†“, 24h 10ì–µ â†‘)</span></div>
      <div class="row">
        <button id="btnDownPurge" class="btn btn-lite">ë¹„ìš°ê¸°</button>
      </div>
    </div>
    <div class="body">
      <div style="overflow:auto;max-height:420px">
        <table id="tblDown">
          <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
            <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
/** ===== ìœ í‹¸ ===== */
const $ = sel => document.querySelector(sel);
const fmt = n => (n===null||n===undefined) ? 'â€”' :
  n>=1000 ? n.toLocaleString('ko-KR') : (''+n);

function priceUnit(krw){
  if (krw >= 2_000_000) return 1000;
  if (krw >= 1_000_000) return 500;
  if (krw >= 500_000) return 100;
  if (krw >= 100_000) return 50;
  if (krw >= 10_000) return 10;
  if (krw >= 1_000) return 5;
  if (krw >= 100) return 1;
  if (krw >= 10) return 0.1;
  if (krw >= 1) return 0.01;
  return 0.001;
}
const riskBadge = (pct)=>{
  const p = Math.abs(pct);
  if (p >= 0.15) return `<span class="chip risk">3(ì£¼ì˜)</span>`;
  if (p >= 0.07) return `<span class="chip risk">2(ë³´í†µ)</span>`;
  return `<span class="chip">1(ì•ˆì •)</span>`;
}
const oneLine = (pct)=>{
  if (pct >= 0.25) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
  if (pct >= 0.07) return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  if (pct <= -0.12) return 'âš ï¸ ë‚™í­ì£¼ì˜';
  if (pct <= -0.05) return 'ğŸ˜¬ ì¡°ì •ê¶Œ';
  return 'ğŸ‘€ ê´€ë§';
}
function toKRName(mkt, mapKo){
  const sym = mkt.split('-')[1];
  return mapKo[sym] ? mapKo[sym] : sym;
}

/** ===== í”„ë¡ì‹œ ê²½ìœ  ì—…ë¹„íŠ¸ ===== */
const API = p => `/api/upbit?path=${encodeURIComponent(p)}`;
async function getAllKrwMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'), {cache:'no-store'});
  const arr = await r.json();
  return arr.filter(x=>x.market.startsWith('KRW-'));
}
async function getTickers(markets){
  const chunks = [];
  const size = 90;
  for (let i=0;i<markets.length;i+=size) chunks.push(markets.slice(i,i+size));
  const out=[];
  for (const c of chunks){
    const url = API('/v1/ticker?markets='+c.join(','));
    const r = await fetch(url,{cache:'no-store'});
    const j = await r.json();
    out.push(...j);
  }
  return out;
}

/** ===== ìƒíƒœ/ë Œë” ===== */
const state = { markets:[], nameMap:{}, tickers:[], selected:null };

function buildNameMap(list){
  const m={}; for (const it of list){ const s=it.market.split('-')[1]; if(it.korean_name) m[s]=it.korean_name; }
  return m;
}
function calcLines(px){
  const u = priceUnit(px);
  return { buy:Math.max(px-u,0), sell:px+u, stop:Math.max(px-u*5,0) };
}
function renderSelected(tk){
  const nm = toKRName(tk.market, state.nameMap);
  $('#selName').textContent = `${nm}  ${tk.market}`;
  const pct = tk.signed_change_rate;
  const {buy,sell,stop} = calcLines(tk.trade_price);
  $('#selGrid').innerHTML = `
    <div>${fmt(Math.round(tk.trade_price))}</div>
    <div>${fmt(Math.round(buy))}</div>
    <div>${fmt(Math.round(sell))}</div>
    <div>${fmt(Math.round(stop))}</div>
    <div class="${pct>=0?'pos':'neg'}">${(pct*100).toFixed(2)}%</div>
    <div>${riskBadge(pct)}</div>
    <div>${oneLine(pct)}</div>`;
}
function rowHtml(i, tk){
  const nm = toKRName(tk.market, state.nameMap);
  const pct = tk.signed_change_rate;
  const {buy,sell,stop} = calcLines(tk.trade_price);
  return `<tr data-m="${tk.market}">
    <td>${i}</td>
    <td style="text-align:left;cursor:pointer" title="${tk.market}">${nm}</td>
    <td>${fmt(Math.round(tk.trade_price))}</td>
    <td class="${pct>=0?'pos':'neg'}">${(pct*100).toFixed(2)}%</td>
    <td>${fmt(Math.round(buy))}</td>
    <td>${fmt(Math.round(sell))}</td>
    <td>${fmt(Math.round(stop))}</td>
    <td>${riskBadge(pct)}</td>
    <td>${oneLine(pct)}</td>
  </tr>`;
}
function renderTables(){
  const upT = document.querySelector('#tblUp tbody');
  const dnT = document.querySelector('#tblDown tbody');
  upT.innerHTML=''; dnT.innerHTML='';
  const okV = 10_000_000_000; // 24h ê±°ë˜ëŒ€ê¸ˆ ì¡°ê±´
  const ups = state.tickers.filter(t=>t.signed_change_rate>=0.05 && t.acc_trade_price_24h>=okV)
    .sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const dns = state.tickers.filter(t=>t.signed_change_rate<=-0.05 && t.acc_trade_price_24h>=okV)
    .sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
  ups.forEach((t,i)=> upT.insertAdjacentHTML('beforeend',rowHtml(i+1,t)));
  dns.forEach((t,i)=> dnT.insertAdjacentHTML('beforeend',rowHtml(i+1,t)));
  [...upT.querySelectorAll('tr'),...dnT.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m=tr.getAttribute('data-m'); const tk=state.tickers.find(x=>x.market===m);
      if(tk){state.selected=tk;renderSelected(tk);}
    });
  });
}

/** ===== êµ¬ë™ ===== */
async function refreshTickers(){
  try{
    const list = state.markets.map(x=>x.market);
    const tks = await getTickers(list);
    for (const t of tks){
      if (typeof t.signed_change_rate !== 'number') {
        const open = t.opening_price || t.prev_closing_price || t.trade_price;
        t.signed_change_rate = (t.trade_price - open) / open;
      }
    }
    state.tickers=tks;
    renderTables();
    if(state.selected){
      const tk=state.tickers.find(x=>x.market===state.selected.market);
      if(tk) renderSelected(tk);
    }
  }catch(e){ console.error(e); alert('ë°ì´í„° ê°±ì‹  ì˜¤ë¥˜. /api/upbit í™•ì¸!'); }
}
async function bootstrap(){
  // ì‹œê³„
  setInterval(()=>{
    const now=new Date();
    const k=new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(now);
    document.querySelector('#clock').textContent='KST â€” '+k;
  },1000);

  state.markets = await getAllKrwMarkets();
  state.nameMap = buildNameMap(state.markets);

  await refreshTickers();

  document.querySelector('#btnRefresh').onclick=refreshTickers;
  document.querySelector('#btnUpPurge').onclick=()=>{document.querySelector('#tblUp tbody').innerHTML='';};
  document.querySelector('#btnDownPurge').onclick=()=>{document.querySelector('#tblDown tbody').innerHTML='';};
  document.querySelector('#btnReset').onclick=()=>{
    document.querySelector('#q').value=''; state.selected=null;
    document.querySelector('#selName').textContent='ì—†ìŒ â€”';
    document.querySelector('#selGrid').innerHTML='<div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div>';
  };
  document.querySelector('#btnSearch').onclick=()=>{
    const q=document.querySelector('#q').value.trim().toUpperCase();
    if(!q) return;
    let m=null;
    if(q.startsWith('KRW-')) m=q;
    else{
      const bySym=state.markets.find(x=>x.market.split('-')[1]===q);
      const byKo=state.markets.find(x=>(x.korean_name||'').replace(/\s/g,'')===q.replace(/\s/g,''));
      m=bySym?.market||byKo?.market||null;
    }
    if(!m){ alert('í•´ë‹¹ ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (KRWë§Œ ì§€ì›)'); return; }
    const tk=state.tickers.find(x=>x.market===m);
    if(!tk){ alert('ë°ì´í„° ì¤€ë¹„ì¤‘. ì ì‹œ í›„ ë‹¤ì‹œ!'); return; }
    state.selected=tk; renderSelected(tk);
  };

  // ìë™ ìƒˆë¡œê³ ì¹¨(1ë¶„)
  setInterval(refreshTickers,60_000);
}
bootstrap();
</script>
</body>
</html>
