<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.3 ì•ˆì •íŒ (ì‹¤ì‹œê°„ ê¸‰ë“±í˜•)</title>
<style>
  :root{
    --bg:#0f1218; --panel:#141925; --ink:#e6ecff; --muted:#99a3c2; --pos:#38d98a; --neg:#f66; --chip:#1b2336; --accent:#7aa2ff;
    --row:#0f1421; --danger:#ff7a7a; --warn:#ffcc66; --safe:#38d98a;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui, AppleSDGothicNeo, Segoe UI, Roboto}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--muted)}
  .searchbar{display:flex;gap:8px;width:100%;max-width:720px;margin-top:8px}
  .searchbar input{flex:1;padding:12px;border-radius:10px;border:1px solid #22304d;background:var(--panel);color:var(--ink)}
  .btn{padding:12px 14px;border-radius:10px;border:1px solid #22304d;background:#1a2336;color:#dce6ff;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:14px 0}
  .kpi{padding:14px;border-radius:12px;background:var(--panel);text-align:center}
  .kpi .h{color:var(--muted);font-size:12px;margin-bottom:8px}
  .kpi .v{font-size:18px}
  .green{color:var(--pos)} .red{color:var(--neg)}
  h3{margin:18px 0 10px}
  .card{background:var(--panel);border-radius:14px;padding:8px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{font-weight:600;color:#aab7da;text-align:left;padding:12px}
  tbody td{padding:10px;border-top:1px solid #232d46}
  tbody tr:nth-child(odd){background:var(--row)}
  .chip{font-size:12px;padding:3px 8px;border-radius:999px;background:#1d2741;color:#aab7da;display:inline-block}
  .risk-1{background:#15312a;color:#8cf3c0} .risk-2{background:#31290f;color:#ffd27a} .risk-3{background:#361a1a;color:#ff9d9d}
  .note{font-size:12px;color:var(--muted);margin-top:4px}
  .right{float:right;font-size:12px;color:var(--muted)}
  .link{color:#bcd4ff}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <span class="badge">ì©”ì–´ì§€ê°‘ v7.3</span>
    <span class="badge">ONLINE</span>
    <span class="badge" id="clock">KST â€¦</span>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="searchbar">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)  Â·  ë˜ëŠ” 'ê¸‰ë“±' / 'ê¸‰ë½'" />
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒëœ ì½”ì¸ KPI -->
  <div class="grid" id="kpi">
    <div class="kpi"><div class="h">ì½”ì¸ëª…</div><div class="v" id="kName">-</div></div>
    <div class="kpi"><div class="h">í˜„ì¬ê°€</div><div class="v" id="kPrice">-</div></div>
    <div class="kpi"><div class="h">ë³€ë™ë¥ </div><div class="v" id="kChange">-</div></div>
    <div class="kpi"><div class="h">ë§¤ìˆ˜</div><div class="v" id="kBid">-</div></div>
    <div class="kpi"><div class="h">ë§¤ë„</div><div class="v" id="kAsk">-</div></div>
    <div class="kpi"><div class="h">ì†ì ˆ</div><div class="v" id="kStop">-</div></div>
    <div class="kpi"><div class="h">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div><div class="v"><span id="kRisk" class="chip">-</span> <span id="kOne" class="chip">-</span></div></div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ í‘œ -->
  <div class="flex">
    <h3>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <span class="right">ì‹¤ì‹œê°„ ìë™ ì •ë ¬</span></h3>
    <div class="card"><table id="tblUp">
      <thead><tr>
        <th style="width:28px;">#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
      </tr></thead><tbody></tbody>
    </table></div>

    <h3>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</h3>
    <div class="card"><table id="tblDown">
      <thead><tr>
        <th style="width:28px;">#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
      </tr></thead><tbody></tbody>
    </table></div>
  </div>

  <div class="note">ë°ì´í„°: Upbit Â· í”„ë¡ì‹œ: <span class="link">/api/upbit</span> Â· ê°±ì‹ ì£¼ê¸°: 1.5ì´ˆ Â· í˜¸ê°€ë‹¨ìœ„ ì—…ë¹„íŠ¸ì™€ 1:1 ë§¤ì¹­</div>
</div>

<script>
/* --------------------------- ê³µí†µ ìœ í‹¸ --------------------------- */
const API = (p) => `/api/upbit?path=${encodeURIComponent(p)}`;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function priceUnit(p){ // ì—…ë¹„íŠ¸ KRW í˜¸ê°€ë‹¨ìœ„ ë§¤ì¹­
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  return 0.0001;
}
function fmtKRW(x){ return Number(x).toLocaleString('ko-KR'); }
function fmtPct(x){ const s = Number(x).toFixed(2)+'%'; return (x>=0?`<span class="green">${s}</span>`:`<span class="red">${s}</span>`); }
function riskClass(score){ return score>=3?'risk-3':score>=2?'risk-2':'risk-1'; }
function oneLiner(chg){ // ì©”ì–´í•œë§ˆë””
  if (chg > 8) return 'í­ë“± ëª¨ë“œ!';
  if (chg > 2) return 'ìƒìŠ¹ì¤‘';
  if (chg > -2) return 'ê´€ë§';
  if (chg > -8) return 'ë‚™í­ê²½ê³„';
  return 'íŒ¨ë‹‰ì£¼ì˜';
}

/* --------------------------- ë°ì´í„° ë¡œë”© --------------------------- */
let markets = [];        // [{market, korean_name, english_name}]
let marketByKey = {};    // KRW-ETH ë“± â†’ ê°ì²´
let selected = null;     // ì„ íƒëœ ë§ˆì¼“ ì½”ë“œ

async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'));
  if (!r.ok) throw new Error('ë§ˆì¼“ëª©ë¡ ì‹¤íŒ¨');
  markets = await r.json();
  markets = markets.filter(m => m.market.startsWith('KRW-'));
  marketByKey = Object.fromEntries(markets.map(m => [m.market, m]));
}

async function fetchTickers(codes){
  if (!codes.length) return [];
  const r = await fetch(API('/v1/ticker?markets='+codes.join(',')));
  if (!r.ok) throw new Error('í‹°ì»¤ ì‹¤íŒ¨');
  return await r.json(); // [{market, trade_price, signed_change_rate, ...}]
}
async function fetchOrderbook(code){
  const r = await fetch(API('/v1/orderbook?markets='+code));
  if (!r.ok) throw new Error('í˜¸ê°€ ì‹¤íŒ¨');
  const [ob] = await r.json();
  // ìµœìš°ì„  í˜¸ê°€
  const bid = ob.orderbook_units[0].bid_price;
  const ask = ob.orderbook_units[0].ask_price;
  return { bid, ask };
}

/* --------------------------- ê²€ìƒ‰/ì„ íƒ --------------------------- */
function findMarket(keyword){
  if (!keyword) return null;
  const q = keyword.trim().toLowerCase();
  // ë°”ë¡œ 'ê¸‰ë“±' / 'ê¸‰ë½'
  if (q === 'ê¸‰ë“±' || q === 'ìƒìŠ¹') return '__UP__';
  if (q === 'ê¸‰ë½' || q === 'í•˜ë½') return '__DOWN__';
  // ì‹¬ë³¼ / ë§ˆì¼“ / í•œê¸€ / ì˜ë¬¸
  return markets.find(m =>
    m.market.toLowerCase() === q ||
    m.market.toLowerCase().split('-')[1] === q ||
    m.korean_name.toLowerCase().includes(q) ||
    m.english_name.toLowerCase().includes(q)
  );
}

async function selectMarket(market){ // market: 'KRW-ETH'
  try{
    selected = market;
    const [tkr] = await fetchTickers([market]); if(!tkr) return;
    const { bid, ask } = await fetchOrderbook(market);
    const price = tkr.trade_price;
    const chg = tkr.signed_change_rate*100;

    // ì†ì ˆ: ìµœê·¼ê°€ì—ì„œ -1.5% (í˜¸ê°€ë‹¨ìœ„ ë§ì¶¤ ë°˜ì˜¬ë¦¼)
    const unit = priceUnit(price);
    const stop = Math.max(0, Math.round((price * 0.985) / unit) * unit);

    // ìœ„í—˜ë„: ë³€ë™ë¥  ì ˆëŒ€ê°’ ê¸°ë°˜ (1~3)
    const risk = Math.abs(chg) > 7 ? 3 : Math.abs(chg) > 3 ? 2 : 1;

    // KPI ë Œë”
    const meta = marketByKey[market];
    document.getElementById('kName').textContent = `${meta.korean_name} (${market})`;
    document.getElementById('kPrice').textContent = fmtKRW(price);
    document.getElementById('kChange').innerHTML  = fmtPct(chg);
    document.getElementById('kBid').textContent   = fmtKRW(bid);
    document.getElementById('kAsk').textContent   = fmtKRW(ask);
    document.getElementById('kStop').textContent  = fmtKRW(stop);

    const riskEl = document.getElementById('kRisk');
    riskEl.className = `chip ${riskClass(risk)}`;
    riskEl.textContent = (risk===1?'1(ì•ˆì •)':risk===2?'2(ë³´í†µ)':'3(ì£¼ì˜)');

    const one = document.getElementById('kOne');
    one.className = 'chip';
    one.textContent = oneLiner(chg);
  }catch(e){
    alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  }
}

/* --------------------------- ê¸‰ë“±/ê¸‰ë½ í‘œ ë Œë” --------------------------- */
function renderTable(el, rows){
  const tb = el.querySelector('tbody'); tb.innerHTML = '';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.name} <span class="chip">${r.market}</span></td>
      <td>${fmtKRW(r.price)}</td>
      <td>${fmtPct(r.chg)}</td>
      <td>${fmtKRW(r.bid)}</td>
      <td>${fmtKRW(r.ask)}</td>
      <td>${fmtKRW(r.stop)}</td>
      <td><span class="chip ${riskClass(r.risk)}">${r.risk===1?'1(ì•ˆì •)':r.risk===2?'2(ë³´í†µ)':'3(ì£¼ì˜)'}</span></td>
      <td><span class="chip">${oneLiner(r.chg)}</span></td>`;
    tr.style.cursor='pointer';
    tr.onclick = ()=> selectMarket(r.market);
    tb.appendChild(tr);
  });
}

async function refreshLists(){
  try{
    const codes = markets.slice(0, 1800).map(m=>m.market); // KRW ì „ë¶€
    const tks = await fetchTickers(codes);
    // ì •ë ¬
    const enriched = await Promise.all(tks.map(async t=>{
      const market = t.market;
      const meta = marketByKey[market];
      const price = t.trade_price;
      const chg = t.signed_change_rate*100;
      let bid=price, ask=price;
      try{
        const ob = await fetchOrderbook(market);
        bid = ob.bid; ask = ob.ask;
      }catch(_){}
      const unit = priceUnit(price);
      const stop = Math.round((price * 0.985)/unit)*unit;
      const risk = Math.abs(chg) > 7 ? 3 : Math.abs(chg) > 3 ? 2 : 1;
      return { market, name: meta.korean_name, price, chg, bid, ask, stop, risk };
    }));

    const up = enriched.filter(x=>x.chg>0).sort((a,b)=>b.chg-a.chg).slice(0,10);
    const down = enriched.filter(x=>x.chg<0).sort((a,b)=>a.chg-b.chg).slice(0,10);

    renderTable(document.getElementById('tblUp'), up);
    renderTable(document.getElementById('tblDown'), down);

    // ê¸°ë³¸ ì„ íƒ ì—†ìœ¼ë©´ 1ìœ„ ìë™ ì„ íƒ
    if (!selected && up[0]) selectMarket(up[0].market);
  }catch(e){
    // ì¡°ìš©íˆ ì¬ì‹œë„ (í”„ë¡ì‹œ ì¼ì‹œ ì˜¤ë¥˜ ëŒ€ë¹„)
  }
}

/* --------------------------- ì´ë²¤íŠ¸/ë£¨í”„ --------------------------- */
document.getElementById('btnSearch').onclick = ()=>{
  const q = document.getElementById('q').value;
  const found = findMarket(q);
  if (!found) { alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); return; }
  if (found === '__UP__') { // ê¸‰ë“± ëª¨ë“œ ë³´ê¸°
    window.scrollTo({top: document.getElementById('tblUp').offsetTop-60, behavior:'smooth'});
    return;
  }
  if (found === '__DOWN__') {
    window.scrollTo({top: document.getElementById('tblDown').offsetTop-60, behavior:'smooth'});
    return;
  }
  selectMarket(found.market);
};
document.getElementById('btnReset').onclick = ()=>{
  document.getElementById('q').value = '';
  selected = null;
};

(async function boot(){
  // ì‹œê³„
  setInterval(()=>{
    const d = new Date();
    const k = new Date(d.getTime()+9*3600*1000 - (new Date().getTimezoneOffset()*60000));
    document.getElementById('clock').textContent = 'KST â€” ' + k.toISOString().slice(11,19);
  }, 1000);

  await loadMarkets();
  await refreshLists();
  // ì‹¤ì‹œê°„ ë£¨í”„ (1.5ì´ˆ)
  setInterval(refreshLists, 1500);
})();
</script>
</body>
</html>
