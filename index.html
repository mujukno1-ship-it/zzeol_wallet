<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v6.3+</title>
<style>
  :root{
    --bg:#0f141a;--panel:#111a24;--line:#1b2633;--txt:#d6e0ea;--mut:#8ca1b3;
    --pos:#32d296;--neg:#ff5670;--chip:#233140;--chipTxt:#cfe7ff;--accent:#67b8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,"Noto Sans KR",sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#16202b;color:#a5c4de;font-weight:600}
  .pill{padding:3px 10px;border-radius:8px;background:var(--chip);color:var(--chipTxt);font-weight:600}
  .btn{padding:8px 12px;border:1px solid var(--line);background:var(--panel);color:var(--txt);border-radius:8px;cursor:pointer}
  .btn:hover{border-color:#2c3b4e}
  .mut{color:var(--mut)}
  .h1{font-size:18px;font-weight:800}
  .clock{margin-left:auto}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel+.panel{margin-top:12px}
  .grid{display:grid;gap:8px}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1218;color:var(--txt);outline:none}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2c3a;color:#bfe1ff;font-weight:700}
  .chip.risk{background:#2a1c1c;color:#ffbfc8}
  .pos{color:var(--pos);font-weight:700}
  .neg{color:var(--neg);font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:12px;color:#9fb1c3;text-align:center;font-weight:700}
  tbody td{background:#0e1620;border-top:1px solid #0d1a24;border-bottom:1px solid #0d1a24;padding:8px 10px;text-align:center}
  tbody tr td:first-child{border-left:1px solid #0d1a24;border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-right:1px solid #0d1a24;border-top-right-radius:10px;border-bottom-right-radius:10px}
  tbody tr:hover td{background:#121c27}
  .left{text-align:left}
  .mono{font-variant-numeric:tabular-nums}
  .card{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:8px}
  .kpi{background:#0e1620;border:1px solid #0d1a24;border-radius:10px;padding:10px;text-align:center}
  .kpi .label{font-size:12px;color:#9fb1c3}
  .kpi .val{margin-top:2px;font-weight:800}
  .toolbar{display:flex;gap:6px;align-items:center}
  .section-title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .legend{font-size:12px;color:#9fb1c3}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">

  <!-- 헤더 -->
  <div class="row">
    <div class="badge">쩔어지갑 <span class="mut">v6.3+</span></div>
    <div class="pill">ONLINE</div>
    <div class="spacer"></div>
    <div class="mut clock" id="clock">KST — --:--:--</div>
  </div>

  <!-- 검색 -->
  <div class="panel">
    <div class="search">
      <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH)" />
      <button class="btn" id="btnSearch">검색</button>
      <button class="btn" id="btnReset">초기화</button>
    </div>
    <!-- 선택된 코인 카드 -->
    <div class="panel" style="margin-top:10px">
      <div class="row section-title">
        <div class="h1">선택된 코인: <span id="selName" class="mut">없음</span></div>
        <div class="spacer"></div>
        <div class="legend">변동률은 실시간 추정, <span class="mut">매수/매도/손절은 호가단위 기준</span></div>
      </div>
      <div class="card">
        <div class="kpi"><div class="label">현재가</div><div class="val mono" id="k_now">—</div></div>
        <div class="kpi"><div class="label">매수</div><div class="val mono" id="k_buy">—</div></div>
        <div class="kpi"><div class="label">매도</div><div class="val mono" id="k_sell">—</div></div>
        <div class="kpi"><div class="label">손절</div><div class="val mono" id="k_stop">—</div></div>
        <div class="kpi"><div class="label">위험도</div><div class="val" id="k_risk">—</div></div>
        <div class="kpi"><div class="label">쩔어한마디</div><div class="val" id="k_say">—</div></div>
        <div class="kpi"><div class="label">변동률</div><div class="val" id="k_pct">—</div></div>
        <div class="kpi"><div class="label">연결</div><div class="val" id="k_net" title="업데이트 상태">관망</div></div>
      </div>
    </div>
  </div>

  <!-- 급등/급락 표 -->
  <div class="panel">
    <div class="row section-title">
      <div class="h1">🔥 급등코인 Top 10 <span class="mut">(조건: 5%↑, 24h 10억↑)</span></div>
      <div class="spacer"></div>
      <div class="toolbar">
        <button class="btn" id="btnUpRefresh">새로고침</button>
        <button class="btn" id="btnUpClear">비우기</button>
      </div>
    </div>
    <table id="tblUp">
      <thead>
        <tr>
          <th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th>
          <th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel">
    <div class="row section-title">
      <div class="h1">💧 급락코인 Top 10 <span class="mut">(조건: -5%↓, 24h 10억↑)</span></div>
      <div class="spacer"></div>
      <div class="toolbar">
        <button class="btn" id="btnDownRefresh">새로고침</button>
      <button class="btn" id="btnDownClear">비우기</button>
      </div>
    </div>
    <table id="tblDown">
      <thead>
        <tr>
          <th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th>
          <th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ===== 기본 상태 ===== */
const state = {
  markets: [],         // KRW-* 전체
  nameMap: {},         // 티커심볼 -> 한글명
  tickers: [],         // 최신 시세
  selected: null,      // 선택된 티커
  alive: true,
  backoff: 0
};

const API = (path)=> `/api/upbit?path=${encodeURIComponent(path)}`;

/* ===== 유틸 ===== */
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const fmt = n => (n==null? '—' : Number(n).toLocaleString('ko-KR'));
const pctStr = p => `${(p*100).toFixed(2)}%`;

function priceUnit(p){
  if (p >= 2_000_000) return 1000;
  if (p >= 1_000_000) return 500;
  if (p >= 500_000)  return 100;
  if (p >= 100_000)  return 50;
  if (p >= 10_000)   return 10;
  if (p >= 1_000)    return 5;
  if (p >= 100)      return 1;
  if (p >= 10)       return 0.1;
  if (p >= 1)        return 0.01;
  return 0.001;
}

function riskBadge(p){
  const ap = Math.abs(p);
  if (ap >= 0.15) return `<span class="chip risk">3(주의)</span>`;
  if (ap >= 0.07) return `<span class="chip">2(보통)</span>`;
  return `<span class="chip">1(안정)</span>`;
}

function sayByPct(p){
  if (p >= 0.25) return '🚀 폭등 모드!';
  if (p >= 0.07) return '🔥 불장 신호!';
  if (p <= -0.12) return '⚠️ 낙폭주의';
  if (p <= -0.05) return '😬 조정권';
  return '👀 관망';
}

function kstClock(){
  const el = document.getElementById('clock');
  setInterval(()=>{
    const t = new Date(new Date().getTime()+9*3600000);
    el.textContent = 'KST — ' + new Date().toLocaleTimeString('ko-KR', {hour12:false});
  },1000);
}

/* ===== 데이터 ===== */
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function loadMarkets(){
  // 전체 마켓 + 한글명
  const arr = await fetchJSON(API('/v1/market/all?isDetails=true'));
  state.markets = arr.filter(x=>x.market.startsWith('KRW-')).map(x=>x.market);
  state.nameMap = {};
  for (const it of arr){
    const sym = it.market.split('-')[1];
    state.nameMap[sym] = it.korean_name || sym;
  }
}

async function loadTickers(markets){
  if (!markets.length) return [];
  const url = API('/v1/ticker?markets=' + encodeURIComponent(markets.join(',')));
  return await fetchJSON(url);
}

/* ===== 렌더 ===== */
function renderSelected(tk){
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym] || sym;
  const unit = priceUnit(tk.trade_price);
  const buy  = Math.max(tk.trade_price - unit, 0);
  const sell = tk.trade_price + unit;
  const stop = Math.max(tk.trade_price - unit*5, 0);

  document.getElementById('selName').textContent = name;
  document.getElementById('k_now').textContent  = fmt(tk.trade_price);
  const p = tk.signed_change_rate;
  document.getElementById('k_pct').innerHTML = `<span class="${p>=0?'pos':'neg'}">${pctStr(p)}</span>`;
  document.getElementById('k_buy').textContent  = fmt(buy);
  document.getElementById('k_sell').textContent = fmt(sell);
  document.getElementById('k_stop').textContent = fmt(stop);
  document.getElementById('k_risk').innerHTML  = riskBadge(p);
  document.getElementById('k_say').textContent = sayByPct(p);
  document.getElementById('k_net').textContent = '연결됨';
}

function makeRowHtml(i, tk){
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym] || sym;
  const unit = priceUnit(tk.trade_price);
  const buy  = Math.max(tk.trade_price - unit, 0);
  const sell = tk.trade_price + unit;
  const stop = Math.max(tk.trade_price - unit*5, 0);
  const p = tk.signed_change_rate;

  return `<tr data-m="${tk.market}">
    <td>${i}</td>
    <td class="left" title="${tk.market}" style="cursor:pointer">${name}</td>
    <td class="mono">${fmt(tk.trade_price)}</td>
    <td class="${p>=0?'pos':'neg'} mono">${pctStr(p)}</td>
    <td class="mono">${fmt(buy)}</td>
    <td class="mono">${fmt(sell)}</td>
    <td class="mono">${fmt(stop)}</td>
    <td>${riskBadge(p)}</td>
    <td>${sayByPct(p)}</td>
  </tr>`;
}

function renderList(tbody, list){
  tbody.innerHTML = '';
  list.forEach((tk,i)=>{
    tbody.insertAdjacentHTML('beforeend', makeRowHtml(i+1, tk));
  });
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if (!tk) return;
      state.selected = tk;
      renderSelected(tk);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

function renderTables(){
  const upBody = document.querySelector('#tblUp tbody');
  const dnBody = document.querySelector('#tblDown tbody');
  const V = 1_000_000_000; // 10억

  const ups = state.tickers
    .filter(t=> t.signed_change_rate >= 0.05 && t.acc_trade_price_24h >= V)
    .sort((a,b)=> b.signed_change_rate - a.signed_change_rate)
    .slice(0,10);

  const dns = state.tickers
    .filter(t=> t.signed_change_rate <= -0.05 && t.acc_trade_price_24h >= V)
    .sort((a,b)=> a.signed_change_rate - b.signed_change_rate)
    .slice(0,10);

  renderList(upBody, ups);
  renderList(dnBody, dns);
}

/* ===== 동작 ===== */
async function boot(){
  kstClock();

  // UI
  document.getElementById('btnUpClear').onclick   =
  document.getElementById('btnDownClear').onclick = ()=>{
    document.querySelector('#tblUp tbody').innerHTML='';
    document.querySelector('#tblDown tbody').innerHTML='';
  };
  document.getElementById('btnUpRefresh').onclick   =
  document.getElementById('btnDownRefresh').onclick = ()=> renderTables();

  // 검색
  const runSearch = ()=>{
    const q = document.getElementById('q').value.trim().toUpperCase();
    if(!q) return;
    // 심볼 or 한글명 or KRW-*
    const hit = state.tickers.find(t=>{
      const sym = t.market.split('-')[1];
      const ko  = state.nameMap[sym]||'';
      return t.market===q || sym===q || ko.includes(q) || q.includes(sym);
    }) || state.tickers.find(t=> t.market.includes(q));
    if(hit){ state.selected = hit; renderSelected(hit); }
  };
  document.getElementById('btnSearch').onclick = runSearch;
  document.getElementById('btnReset').onclick  = ()=>{
    document.getElementById('q').value='';
    state.selected = null;
    document.getElementById('selName').textContent='없음';
    ['k_now','k_buy','k_sell','k_stop','k_risk','k_say','k_pct','k_net'].forEach(id=>document.getElementById(id).textContent='—');
  };

  // 데이터 루프(폴링 + 백오프)
  try{
    await loadMarkets();
  }catch(e){
    console.error('시장 목록 로드 실패',e);
  }

  // 한번에 너무 많이 요청하지 않게 분할
  const chunks = [];
  for (let i=0;i<state.markets.length;i+=100) chunks.push(state.markets.slice(i,i+100));

  while(true){
    try{
      const all = [];
      for(const c of chunks){
        const arr = await loadTickers(c);
        all.push(...arr);
        await sleep(200); // 살짝 텀
      }
      state.tickers = all;

      // 선택 유지
      if(state.selected){
        const cur = all.find(x=>x.market===state.selected.market);
        if(cur) renderSelected(cur);
      }
      renderTables();

      state.backoff = 0; // 정상화
      await sleep(5_000); // 5초 폴링
    }catch(e){
      console.warn('티커 로드 실패', e.message);
      const wait = Math.min(60_000, 2_000 * Math.pow(2, state.backoff++));
      document.getElementById('k_net').textContent = `재시도 대기 ${Math.round(wait/1000)}초`;
      await sleep(wait);
    }
  }
}

boot();
</script>
</body>
</html>
