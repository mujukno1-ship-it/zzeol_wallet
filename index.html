<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>쩔어지갑 v6.3 — 지속형 저장(캐시) + 위로정렬 + 프록시자동대체</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
:root{--bg:#0d1117;--panel:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#9fb1c1;--up:#16c784;--down:#ea3943;--chip:#223045}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR}
.wrap{max-width:1150px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
.badge{background:var(--chip);border:1px solid #283752;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25);margin-top:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button{background:#0e141b;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
input{flex:1;min-width:260px}button{cursor:pointer}button:hover{background:#1a2330}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--line);text-align:center}
.muted{color:var(--muted)}.chg.up{color:var(--up);font-weight:700}.chg.down{color:var(--down);font-weight:700}
.risk{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-weight:700}
.r1{background:#0f2b12;color:#88f36b}.r2{background:#2b230f;color:#ffd75e}.r3{background:#2b0f0f;color:#ff6b6b}
.title{display:flex;align-items:center;gap:8px}.title .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0e141b}
.err{color:#ff6b6b;font-size:12px;margin-top:6px;display:none}
.flash{animation:flash .9s ease-out 1}@keyframes flash{0%{background:rgba(255,255,0,.18)}100%{background:transparent}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>쩔어지갑 <span class="badge">v6.3</span> <span class="badge" id="net">OFFLINE</span></h1>
    <div class="badge" id="clock">KST — --:--:--</div>
  </header>

  <!-- 검색 -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="코인 검색 (예: 비트코인/비트코인캐시/이더리움/이더리움클래식/ETH/BTC/KRW-ETH)" autocomplete="off"/>
      <button id="btnSearch">검색</button>
      <button id="btnClear">초기화</button>
    </div>
    <div id="searchError" class="err"></div>
  </div>

  <!-- 검색 결과 -->
  <div class="card" id="result" style="display:none">
    <div class="title"><b>선택된 코인:</b> <span id="selName">-</span> <span class="tag" id="selMarket">—</span></div>
    <table style="margin-top:10px">
      <thead><tr class="muted"><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>변동률</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody><tr>
        <td id="s_price">—</td><td id="s_buy">—</td><td id="s_sell">—</td><td id="s_stop">—</td>
        <td id="s_rate">—</td><td id="s_risk">—</td><td id="s_comment">—</td>
      </tr></tbody>
    </table>
  </div>

  <!-- 급등 Top 10 -->
  <div class="card">
    <div class="title">
      <b>🔥 급등코인 Top 10</b>
      <span class="tag" id="tagUp">조건: 5%↑ · 24h 10억↑</span>
      <span class="tag" id="upSource" style="display:none">캐시</span>
    </div>
    <table>
      <thead><tr class="muted"><th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody id="feedUp"></tbody>
    </table>
  </div>

  <!-- 급락 Top 10 -->
  <div class="card">
    <div class="title">
      <b>💧 급락코인 Top 10</b>
      <span class="tag" id="tagDown">조건: -5%↓ · 24h 10억↑</span>
      <span class="tag" id="downSource" style="display:none">캐시</span>
    </div>
    <table>
      <thead><tr class="muted"><th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody id="feedDown"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== 시계/상태 ===== */
<script>
/* ===== Upbit 실시간 동기화 v2 (무효코드 필터 + 하트비트 + 폴백) ===== */
(function(){
  const WS_URL = 'wss://api.upbit.com/websocket/v1';
  let ws=null, alive=false, reconnectTimer=null, pollTimer=null;

  const isMarket = (m)=> /^KRW-[A-Z0-9]{2,}$/.test(m||'');

  function collectMarkets(){
    const set = new Set();
    const selMkt = document.getElementById('selMarket');
    if (selMkt) {
      const m = (selMkt.textContent||'').trim();
      if (isMarket(m)) set.add(m);
    }
    document.querySelectorAll('#feedUp tr[data-market], #feedDown tr[data-market]').forEach(tr=>{
      const m = tr.getAttribute('data-market');
      if (isMarket(m)) set.add(m);
    });
    const list = Array.from(set).filter(isMarket);
    if (list.length === 0) list.push('KRW-BTC');
    return list.slice(0,80);
  }

  function applyTicker(t){
    const market = t.code || t.market;
    const price  = t.trade_price;
    const rate   = (t.signed_change_rate ?? 0);

    const selMkt = document.getElementById('selMarket');
    if (selMkt && (selMkt.textContent||'').trim() === market) {
      const priceEl = document.getElementById('s_price');
      const rateEl  = document.getElementById('s_rate');
      if (priceEl) priceEl.textContent = (typeof fmtKRW==='function') ? fmtKRW(price) : price.toLocaleString('ko-KR');
      if (rateEl)  rateEl.innerHTML = `<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
      const calc = (window.calcTradeLevels || ((p)=>({buy:p*0.988,sell:p*1.012,stop:p*0.975})));
      const L = calc(price, rate);
      const asKRW = (x)=> (typeof fmtKRW==='function') ? fmtKRW(x) : Math.floor(x).toLocaleString('ko-KR');
      const ids = ['s_buy','s_sell','s_stop'];
      const vals= [L.buy, L.sell, L.stop];
      ids.forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.textContent = asKRW(vals[i]); });
    }

    document.querySelectorAll(`tr[data-market="${market}"]`).forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if (tds.length >= 9) {
        const asKRW = (x)=> (typeof fmtKRW==='function') ? fmtKRW(x) : Math.floor(x).toLocaleString('ko-KR');
        tds[2].textContent = asKRW(price);
        tds[3].innerHTML   = `<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
        const calc = (window.calcTradeLevels || ((p)=>({buy:p*0.988,sell:p*1.012,stop:p*0.975})));
        const L = calc(price, rate);
        tds[4].textContent = asKRW(L.buy);
        tds[5].textContent = asKRW(L.sell);
        tds[6].textContent = asKRW(L.stop);
      }
    });
  }

  function mark(status){
    const n=document.getElementById('net');
    if(!n) return;
    if(status==='ONLINE'){ n.textContent='ONLINE'; n.style.background='#123922'; }
    else { n.textContent='OFFLINE (재시도)'; n.style.background='#3a1a1a'; }
  }

  function connect(){
    const codes = collectMarkets();
    console.log('[WS] subscribe', codes);
    if (!codes.length){ startPolling(); return; }

    try{
      stopPolling();
      if (ws){ try{ws.close();}catch(_){} ws=null; }
      ws = new WebSocket(WS_URL);
      ws.binaryType='blob';

      ws.onopen = () => {
        alive = true; mark('ONLINE');
        const msg = [
          { ticket:'zzeol-wallet' },
          { type:'ticker', codes, isOnlyRealtime:true }
        ];
        ws.send(JSON.stringify(msg));
        console.log('[WS] opened');
      };

      ws.onmessage = async (e) => {
        try{
          const text = await e.data.text();
          const data = JSON.parse(text);
          applyTicker(data);
        }catch(err){}
      };

      ws.onclose = () => { console.warn('[WS] closed'); alive=false; scheduleReconnect(); };
      ws.onerror = () => { console.warn('[WS] error');  alive=false; scheduleReconnect(); };
    }catch(err){
      console.warn('[WS] connect fail', err); scheduleReconnect();
    }
  }

  function scheduleReconnect(){
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connect(); }, 1500);
    startPolling();
    mark('OFFLINE');
  }

  function startPolling(){
    if (pollTimer) return;
    console.log('[POLL] start');
    const api='https://api.upbit.com/v1/ticker?markets=';
    pollTimer = setInterval(async ()=>{
      const mkts = collectMarkets();
      if (!mkts.length) return;
      try{
        const r = await fetch(api + encodeURIComponent(mkts.join(',')), { cache:'no-store' });
        if(!r.ok) throw 0;
        const arr = await r.json();
        arr.forEach(applyTicker);
      }catch(_){}
    }, 1000);
  }
  function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; console.log('[POLL] stop'); } }

  connect();
  setInterval(()=>{ if(alive){ try{ws.close();}catch(_){} } connect(); }, 60000);
})();
</script>
</script>
</body>
</html>





