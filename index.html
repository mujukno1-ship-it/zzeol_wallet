<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.4 (ê²€ìƒ‰ê²°ê³¼ í•˜ë‹¨í‘œì‹œ ì•ˆì •íŒ)</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#15161a; --muted:#9aa4ad; --line:#22252b;
    --txt:#e9edf2; --up:#17c964; --down:#f31260; --chip:#1f2227; --accent:#5eb6ff;
    --warn:#f5a524;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif}
  a{color:inherit}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  .badge{background:#21242a;border:1px solid var(--line);color:#cfd6dd;padding:4px 8px;border-radius:999px;font-weight:600}
  .badge.green{color:#9cffce;background:#14221a;border-color:#1e3a25}
  .row{display:flex;gap:14px;align-items:stretch}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .panel h3{margin:0 0 10px 0;font-size:16px}
  .grow{flex:1}
  input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0c0f;color:var(--txt);outline:none}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0c0f;color:var(--txt);cursor:pointer}
  .btn:hover{border-color:#2d3340}
  .btn.primary{background:#0b2239;border-color:#0e2f56;color:#d3e9ff}
  .btn.ghost{background:transparent}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;align-items:center}
  .th{color:var(--muted);font-weight:600;border-bottom:1px solid var(--line);padding:8px}
  .td{padding:8px;border-bottom:1px solid var(--line)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);padding:5px 8px;border-radius:999px;font-size:12px;color:#c8d0d7}
  .chip.up{color:#a6ffd5;background:#0f2019;border-color:#1d3328}
  .chip.down{color:#ffc2cf;background:#221117;border-color:#3a1a25}
  .chip.warn{color:#fff7d1;background:#251d0a;border-color:#3d2e10}
  .mono{font-variant-numeric:tabular-nums}
  small{color:var(--muted)}
  .result-box{margin-top:12px}
  .card{background:#0f1115;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h4{margin:0 0 8px 0}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .toolbar{display:flex;gap:8px;align-items:center}
  .toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;cursor:pointer}
  .toggle input{accent-color:#3ea6ff}
  .skeleton{background:linear-gradient(90deg,#111319 0%,#181b22 50%,#111319 100%);background-size:200% 100%;animation:s 1.1s linear infinite;border-radius:6px;height:14px}
  @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .err{color:#ffb4c1}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  .table-scroll{max-height:520px;overflow:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="badge">ì©”ì–´ì§€ê°‘ v7.4</span>
      <span class="badge green">ONLINE</span>
      <span class="badge">KST â€” <span id="clock">--:--:--</span></span>
      <span class="right"></span>
      <label class="toggle"><input type="checkbox" id="autoRefresh" checked> ìë™ ìƒˆë¡œê³ ì¹¨(30s)</label>
    </header>

    <!-- ê²€ìƒ‰ íŒ¨ë„ -->
    <div class="panel">
      <div class="row">
        <div class="grow">
          <input id="q" type="text" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / Ethereum / ETH / KRW-ETH)" />
          <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸° ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          <div class="result-box" id="searchResult"></div>
        </div>
        <div class="toolbar">
          <button class="btn primary" id="btnSearch">ê²€ìƒ‰</button>
          <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <!-- ì„ íƒëœ ì½”ì¸ ìš”ì•½(ê¸°ì¡´ í—¤ë” ìœ ì§€) -->
    <div class="panel mt12">
      <h3>ì„ íƒëœ ì½”ì¸: <span id="pickedName" class="muted">ì—†ìŒ</span> â€” <small>ë³€ë™ë¥ </small> <span id="pickedChange" class="chip">â€”</span></h3>
      <div class="grid mono">
        <div class="th">í˜„ì¬ê°€</div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„</div><div class="th">ì©”ì–´í•œë§ˆë””</div><div class="th">í˜¸ê°€ë‹¨ìœ„</div><div class="th">ë§ˆì¼“</div>
        <div class="td" id="cur">â€”</div>
        <div class="td" id="buy">â€”</div>
        <div class="td" id="sell">â€”</div>
        <div class="td" id="stop">â€”</div>
        <div class="td" id="risk">â€”</div>
        <div class="td" id="comment">â€”</div>
        <div class="td" id="tick">â€”</div>
        <div class="td" id="market">â€”</div>
      </div>
    </div>

    <div class="row mt12">
      <!-- ê¸‰ë“± Top10 -->
      <div class="panel grow">
        <div class="row" style="align-items:center;margin-bottom:8px">
          <h3 style="margin:0">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <small class="muted">(ì¡°ê±´: ì‹¤ì‹œê°„)</small></h3>
          <span class="right"></span>
          <button id="reloadUp" class="btn ghost">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="grid mono">
          <div class="th">#</div><div class="th">ì½”ì¸ëª…(í•œê¸€)</div><div class="th">í˜„ì¬ê°€</div><div class="th">ë³€ë™ë¥ </div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
        </div>
        <div class="table-scroll mono" id="upTable"></div>
      </div>

      <!-- ê¸‰ë½ Top10 -->
      <div class="panel grow">
        <div class="row" style="align-items:center;margin-bottom:8px">
          <h3 style="margin:0">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 <small class="muted">(ì¡°ê±´: ì‹¤ì‹œê°„)</small></h3>
          <span class="right"></span>
          <button id="reloadDown" class="btn ghost">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="grid mono">
          <div class="th">#</div><div class="th">ì½”ì¸ëª…(í•œê¸€)</div><div class="th">í˜„ì¬ê°€</div><div class="th">ë³€ë™ë¥ </div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
        </div>
        <div class="table-scroll mono" id="downTable"></div>
      </div>
    </div>

    <div class="mt12 muted">â“˜ ë°ì´í„° ì¶œì²˜: ì—…ë¹„íŠ¸. í”„ë¡ì‹œ: <code>/api/upbit?path=â€¦</code> (Vercel Serverless)</div>
  </div>

<script>
/* ------------------------------- ê³µí†µ ìœ í‹¸ ------------------------------- */
const $ = sel => document.querySelector(sel);
const API = path => `/api/upbit?path=${encodeURIComponent(path)}`;
const sleep = ms => new Promise(r=>setTimeout(r,ms));
let MARKET_CACHE = [];  // /v1/market/all ìºì‹œ
let TICKER_CACHE = new Map();
let autoTimer = null;

/* ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„(í‹±) */
function tickSize(price){
  // KRW ë§ˆì¼“ ê¸°ì¤€ (ì—…ë¹„íŠ¸ ê·œì¹™)
  if (price >= 2000000) return 1000;
  if (price >= 1000000) return 500;
  if (price >= 500000)  return 100;
  if (price >= 100000)  return 50;
  if (price >= 10000)   return 10;
  if (price >= 1000)    return 5;
  if (price >= 100)     return 1;
  if (price >= 10)      return 0.1;
  if (price >= 1)       return 0.01;
  if (price >= 0.1)     return 0.001;
  if (price >= 0.01)    return 0.0001;
  return 0.00001;
}
function roundToTick(p){
  const t=tickSize(p);
  return Math.round(p/t)*t;
}
const fmt = n => (typeof n==='number') ? n.toLocaleString('ko-KR') : n;

/* ê²€ìƒ‰ì–´ ì •ê·œí™”: ê³µë°±/ëŒ€ì†Œë¬¸ì/í•˜ì´í”ˆ/ê´„í˜¸ ì œê±° */
function norm(s){ return (s||'').toString().trim().toLowerCase().replace(/[\s\-\(\)]/g,''); }

/* ----------------------------- ë°ì´í„° ë¡œë“œ ------------------------------ */
async function fetchJSON(url, retry=1){
  try{
    const r = await fetch(url, {headers:{'accept':'application/json'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(e){
    if(retry>0){ await sleep(500); return fetchJSON(url, retry-1); }
    throw e;
  }
}

async function loadMarkets(){
  if(MARKET_CACHE.length) return MARKET_CACHE;
  const arr = await fetchJSON(API('/v1/market/all?isDetails=true'));
  // KRW ë§ˆì¼“ë§Œ ìš°ì„ 
  MARKET_CACHE = arr.filter(m=>m.market?.startsWith('KRW-'));
  // ìƒ‰ì¸ ìƒì„±
  MARKET_CACHE.forEach(m=>{
    m._k = norm(m.korean_name);
    m._e = norm(m.english_name);
    m._m = norm(m.market);
    m._s = norm(m.market.replace('KRW-',''));
  });
  return MARKET_CACHE;
}

async function loadTicker(markets){
  const key = markets.join(',');
  // ìºì‹œ 3ì´ˆ ì‚¬ìš©
  if(TICKER_CACHE.has(key)){
    const {at, data} = TICKER_CACHE.get(key);
    if(Date.now()-at < 3000) return data;
  }
  const data = await fetchJSON(API('/v1/ticker?markets='+markets.join(',')));
  TICKER_CACHE.set(key,{at:Date.now(),data});
  return data;
}

/* ------------------------------ ê²€ìƒ‰ ì²˜ë¦¬ ------------------------------ */
function renderSearchResult(coin, ticker){
  const box = $('#searchResult');
  box.innerHTML = '';
  if(!coin){
    box.innerHTML = `<div class="card err">âŒ ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)</div>`;
    return;
  }
  const p = ticker.trade_price;
  const t = tickSize(p);
  const buy = roundToTick(p * 0.996); // ë³´ìˆ˜ì  ë§¤ìˆ˜ íƒ€ì (0.4% í•˜ë½ì‹œ)
  const sell= roundToTick(p * 1.006); // ë³´ìˆ˜ì  ë§¤ë„ íƒ€ì (0.6% ìƒìŠ¹ì‹œ)
  const stop= roundToTick(p * 0.985); // ì†ì ˆ 1.5%
  const risk = Math.abs(t/p) < 0.002 ? '1(ì•ˆì •)' : Math.abs(t/p) < 0.006 ? '2(ë³´í†µ)' : '3(ì£¼ì˜)';
  const comment = (ticker.signed_change_rate>=0.07) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' :
                  (ticker.signed_change_rate<=-0.07) ? 'ğŸ”» ë‚™í­ê²½ê³„' :
                  (ticker.signed_change_rate>0) ? 'â†— ìƒìŠ¹ì¤‘' : 'â†˜ í•˜ë½ì¤‘';

  // ì„ íƒ íŒ¨ë„ ê°±ì‹  (ê¸°ì¡´ê¸°ëŠ¥ ìœ ì§€)
  $('#pickedName').textContent = `${coin.korean_name} (${coin.market})`;
  $('#pickedChange').textContent = (ticker.signed_change_rate*100).toFixed(2)+'%';
  $('#pickedChange').className = 'chip '+(ticker.signed_change_rate>=0?'up':'down');
  $('#cur').textContent  = fmt(p);
  $('#buy').textContent  = fmt(buy);
  $('#sell').textContent = fmt(sell);
  $('#stop').textContent = fmt(stop);
  $('#risk').innerHTML   = `<span class="chip ${risk.startsWith('3')?'warn':''}">${risk}</span>`;
  $('#comment').textContent = comment;
  $('#tick').textContent = t;
  $('#market').textContent = coin.market;

  // ì¹´ë“œ í‘œì‹œ
  box.innerHTML = `
    <div class="card">
      <h4>${coin.korean_name} <small class="muted">(${coin.english_name} Â· ${coin.market})</small></h4>
      <div class="flex mono">
        <span class="chip">í˜„ì¬ê°€ ${fmt(p)}ì›</span>
        <span class="chip up">ë§¤ìˆ˜ ${fmt(buy)}</span>
        <span class="chip down">ë§¤ë„ ${fmt(sell)}</span>
        <span class="chip warn">ì†ì ˆ ${fmt(stop)}</span>
        <span class="chip">í˜¸ê°€ë‹¨ìœ„ ${t}</span>
        <span class="chip">${risk}</span>
        <span class="chip">${comment}</span>
      </div>
    </div>`;
}

async function doSearch(){
  const q = $('#q').value;
  const nq = norm(q);
  const markets = await loadMarkets();

  let coin = markets.find(m => m._k.includes(nq) || m._e.includes(nq) || m._s===nq || m._m===nq);
  if(!coin){
    // ì•/ë’¤ ê³µë°±, í•˜ì´í”ˆ ì—†ëŠ” ë§ˆì¼“ì½”ë“œë„ ì§€ì›
    coin = markets.find(m => norm(m.market.replace('KRW-',''))===nq);
  }
  if(!coin){ renderSearchResult(null); return; }

  const [ticker] = await loadTicker([coin.market]);
  renderSearchResult(coin, ticker);
}

/* ----------------------------- ê¸‰ë“±/ê¸‰ë½ í‘œ ----------------------------- */
function rowTemplate(i, m, t){
  const p = t.trade_price;
  const ch = t.signed_change_rate*100;
  const tsize = tickSize(p);
  const buy = roundToTick(p*0.996);
  const sell= roundToTick(p*1.006);
  const stop= roundToTick(p*0.985);
  const risk = Math.abs(tsize/p) < 0.002 ? '1(ì•ˆì •)' : Math.abs(tsize/p) < 0.006 ? '2(ë³´í†µ)' : '3(ì£¼ì˜)';
  const comment = (t.signed_change_rate>=0.07) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' :
                  (t.signed_change_rate<=-0.07) ? 'ğŸ”» ë‚™í­ê²½ê³„' :
                  (t.signed_change_rate>0) ? 'â†— ìƒìŠ¹ì¤‘' : 'â†˜ í•˜ë½ì¤‘';
  const chClass = ch>=0 ? 'up' : 'down';
  return `
    <div class="grid">
      <div class="td">${i}</div>
      <div class="td"><b>${m.korean_name}</b> <small class="muted">(${m.market.replace('KRW-','')})</small></div>
      <div class="td mono">${fmt(p)}</div>
      <div class="td"><span class="chip ${chClass}">${ch.toFixed(2)}%</span></div>
      <div class="td mono">${fmt(buy)}</div>
      <div class="td mono">${fmt(sell)}</div>
      <div class="td mono">${fmt(stop)}</div>
      <div class="td"><span class="chip">${risk}</span> Â· <span class="chip">${comment}</span></div>
    </div>
  `;
}
async function buildTables(){
  try{
    const markets = await loadMarkets();
    const tickers = await loadTicker(markets.map(m=>m.market));
    const map = new Map(tickers.map(t=>[t.market,t]));

    // ë³€ë™ë¥  ê¸°ì¤€ ì •ë ¬
    const sorted = markets
      .map(m => [m, map.get(m.market)])
      .filter(([m,t]) => t && isFinite(t.signed_change_rate))
      .sort((a,b) => b[1].signed_change_rate - a[1].signed_change_rate);

    const up = sorted.slice(0, 10);
    const down = sorted.slice(-10).reverse();

    $('#upTable').innerHTML   = up.map(([m,t],i)=>rowTemplate(i+1,m,t)).join('');
    $('#downTable').innerHTML = down.map(([m,t],i)=>rowTemplate(i+1,m,t)).join('');
  }catch(e){
    $('#upTable').innerHTML = `<div class="td err">ê¸‰ë“± ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
    $('#downTable').innerHTML = `<div class="td err">ê¸‰ë½ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
  }
}

/* ------------------------------ ì´ë²¤íŠ¸ ------------------------------- */
$('#btnSearch').addEventListener('click', doSearch);
$('#btnReset').addEventListener('click', ()=>{
  $('#q').value=''; $('#searchResult').innerHTML='';
  $('#pickedName').textContent='ì—†ìŒ';
  ['cur','buy','sell','stop','risk','comment','tick','market'].forEach(id=>$('#'+id).textContent='â€”');
});
$('#reloadUp').addEventListener('click', buildTables);
$('#reloadDown').addEventListener('click', buildTables);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

// ë””ë°”ìš´ìŠ¤ ê²€ìƒ‰ (ì…ë ¥ 300ms ë©ˆì¶”ë©´)
let typing;
$('#q').addEventListener('input', ()=>{
  clearTimeout(typing);
  typing = setTimeout(()=>{ if($('#q').value.trim()) doSearch(); }, 300);
});

// ìë™ ìƒˆë¡œê³ ì¹¨
function setAuto(flag){
  clearInterval(autoTimer);
  if(flag){ autoTimer = setInterval(buildTables, 30000); }
}
$('#autoRefresh').addEventListener('change', e=> setAuto(e.target.checked));

/* ------------------------------- ì‹œì‘ -------------------------------- */
(async function init(){
  // ì‹œê³„
  setInterval(()=>{
    const d=new Date();
    const z=n=>String(n).padStart(2,'0');
    $('#clock').textContent = `${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
  },1000);

  try{
    await loadMarkets(); // ì„  ë¡œë“œ
    await buildTables();
  }catch(e){
    $('#searchResult').innerHTML = `<div class="card err">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message} <button class="btn" onclick="location.reload()">ë‹¤ì‹œì‹œë„</button></div>`;
  }
  setAuto(true);

  // URL í•´ì‹œë¡œ ë”¥ë§í¬ ê²€ìƒ‰ ì§€ì› (#eth, #ì´ë”ë¦¬ì›€, #KRW-ETH)
  const hash = decodeURIComponent(location.hash.replace('#','')).trim();
  if(hash){ $('#q').value = hash; doSearch(); }
})();
</script>
</body>
</html>
