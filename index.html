<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v6.5</title>
<style>
  :root{
    --bg:#0b1218;--panel:#0e1722;--line:#1f2a37;--txt:#e5e7eb;--sub:#9aa4b2;
    --up:#2dd4bf;--down:#fb7185;--warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 ui-sans-serif,system-ui,Apple SD Gothic Neo,"맑은 고딕",Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{padding:3px 8px;border-radius:999px;background:#132033;color:#9fb7d5;font-weight:700;font-size:12px}
  .badge.online{background:#0d2b1c;color:#7be6b0}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px}
  .panel.hdr{padding:12px 14px}
  .clock{margin-left:auto;color:var(--sub)}
  .btn{background:#0d2236;color:#b9d1ff;border:1px solid #213247;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .searchbar{display:flex;gap:8px;margin:12px 0}
  .searchbar input{flex:1;background:#0b131d;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:11px 13px;outline:none}
  .one-line{display:grid;grid-template-columns:160px repeat(7,1fr);gap:8px;align-items:center}
  .cell{padding:10px 12px;background:#0b131d;border:1px solid var(--line);border-radius:10px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .split{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.split{grid-template-columns:1fr 1fr}}
  .tbl-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--line)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:12px 10px;border-bottom:1px solid var(--line);white-space:nowrap}
  th{position:sticky;top:0;background:var(--panel);z-index:1}
  .num{text-align:right}
  .pill{padding:2px 8px;border-radius:999px;font-weight:800}
  .pill.up{background:rgba(45,212,191,.12); color:var(--up);border:1px solid rgba(45,212,191,.25)}
  .pill.down{background:rgba(251,113,133,.12); color:var(--down);border:1px solid rgba(251,113,133,.25)}
  .muted{color:var(--sub)}
  .hint{font-size:12px;color:#8aa0b2}
</style>
</head>
<body>
<div class="wrap">

  <!-- 헤더 -->
  <div class="panel hdr row">
    <div class="row" style="gap:8px">
      <span class="badge">쩔어지갑 v6.5</span>
      <span id="net" class="badge">OFFLINE</span>
    </div>
    <div class="clock" id="clock">KST — --:--:--</div>
  </div>

  <!-- 검색 -->
  <div class="searchbar">
    <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH / 시바이누 / SHIB ...)" autocomplete="off" />
    <button class="btn" id="btnSearch">검색</button>
    <button class="btn" id="btnReset">초기화</button>
  </div>

  <!-- 선택 코인: 한 줄 요약 (열 순서 고정) -->
  <div class="panel" style="padding:14px">
    <div class="one-line muted" style="margin-bottom:8px">
      <div class="cell">코인명</div>
      <div class="cell">현재가</div>
      <div class="cell">변동률</div>
      <div class="cell">매수</div>
      <div class="cell">매도</div>
      <div class="cell">손절</div>
      <div class="cell">위험도</div>
      <div class="cell">쩔어한마디</div>
    </div>
    <div class="one-line" id="selectedRow">
      <div class="cell">없음 —</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div>
    </div>
  </div>

  <!-- 급등/급락 -->
  <div class="split">
    <div class="panel" style="padding:14px">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>🔥 급등코인 Top 10</span></div>
        <span class="hint">실시간 자동 정렬</span>
      </div>
      <div class="tbl-wrap"><table>
        <thead>
          <tr>
            <th class="muted">#</th><th>코인명(한글)</th><th class="num">현재가</th>
            <th class="num">변동률</th><th class="num">매수</th><th class="num">매도</th>
            <th class="num">손절</th><th class="num">위험도</th><th>쩔어한마디</th>
          </tr>
        </thead>
        <tbody id="tblUp"></tbody>
      </table></div>
    </div>

    <div class="panel" style="padding:14px">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>💧 급락코인 Top 10</span></div>
        <span class="hint">급등과 동일 포맷</span>
      </div>
      <div class="tbl-wrap"><table>
        <thead>
          <tr>
            <th class="muted">#</th><th>코인명(한글)</th><th class="num">현재가</th>
            <th class="num">변동률</th><th class="num">매수</th><th class="num">매도</th>
            <th class="num">손절</th><th class="num">위험도</th><th>쩔어한마디</th>
          </tr>
        </thead>
        <tbody id="tblDown"></tbody>
      </table></div>
    </div>
  </div>
</div>

<script>
/* ===== 공통 유틸 ===== */
const $ = (s)=>document.querySelector(s);
const fmt = (n)=> (n==null||isNaN(n)) ? '—' : (n>=1000? Math.round(n).toLocaleString('ko-KR') : (''+(+n).toFixed(6)).replace(/\.0+$/,''));
const rateSpan = (r)=>{
  if (r==null || isNaN(r)) return '—';
  const p = (r*100).toFixed(2)+'%';
  return r>=0? `<span class="pill up">${p}</span>` : `<span class="pill down">${p}</span>`;
};
const API = (p)=>`/api/upbit?path=${encodeURIComponent(p)}&ts=${Date.now()}`;
const upbit = (p)=> fetch(API(p), {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('Upbit '+r.status); return r.json(); });

/* ===== 상태/시계 ===== */
const state={online:false,markets:[],krw:[],nameMap:{},tickers:[],selected:null};
(function clock(){
  const el=$('#clock'), net=$('#net');
  setInterval(()=>{
    const n=new Date();
    el.textContent=`KST — ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
    net.textContent = state.online? 'ONLINE':'OFFLINE';
    net.classList.toggle('online', state.online);
  },1000);
})();

/* ===== 검색어 → 마켓코드 ===== */
const COIN_ALIASES={
  '비트코인':'KRW-BTC','btc':'KRW-BTC','krwbtc':'KRW-BTC',
  '이더리움':'KRW-ETH','eth':'KRW-ETH','krweth':'KRW-ETH',
  '이더리움클래식':'KRW-ETC','etc':'KRW-ETC','krwetc':'KRW-ETC',
  '리플':'KRW-XRP','xrp':'KRW-XRP','krwxrp':'KRW-XRP',
  '도지':'KRW-DOGE','도지코인':'KRW-DOGE','doge':'KRW-DOGE','krwdoge':'KRW-DOGE',
  '시바이누':'KRW-SHIB','shib':'KRW-SHIB','krwshib':'KRW-SHIB',
};
const _norm=s=>(s||'').toString().trim().toLowerCase().replace(/\s+/g,'');
function resolveMarket(input){
  const q=_norm(input);
  if(!q) return null;
  if (COIN_ALIASES[q]) return COIN_ALIASES[q];
  if (/^[a-z]{3,4}-[a-z0-9]{2,10}$/i.test(input)) return input.toUpperCase();
  if (/^[a-z]{3,4}[a-z0-9]{2,10}$/i.test(q)) return (q.slice(0,3)+'-'+q.slice(3)).toUpperCase();
  // 한글/영문/심볼 부분일치 (KRW 우선)
  const cand=state.markets.filter(m=>m.market.startsWith('KRW-'));
  const score=(m)=>{const ko=_norm(m.korean_name), en=_norm(m.english_name), sym=m.market.split('-')[1].toLowerCase();
    if(ko===q||en===q||sym===q) return 3;
    if(ko.startsWith(q)||en.startsWith(q)||sym.startsWith(q)) return 2;
    if(ko.includes(q)||en.includes(q)) return 1;
    return 0;};
  let best=null,bs=0; for(const m of cand){const s=score(m); if(s>bs){best=m; bs=s;}}
  return best? best.market : null;
}

/* ===== 호가단위/라운딩 ===== */
function priceUnit(p){
  if(p>=2_000_000) return 1000;
  if(p>=1_000_000) return 500;
  if(p>=500_000)  return 100;
  if(p>=100_000)  return 50;
  if(p>=10_000)   return 10;
  if(p>=1_000)    return 1;
  if(p>=100)      return 0.1;
  if(p>=10)       return 0.01;
  if(p>=1)        return 0.001;
  if(p>=0.1)      return 0.0001;
  return 0.00001;
}
const roundToUnit=(x,u)=> Math.round(x/u)*u;

/* ===== 저가코인 타점 보정 (항상 매수/매도 분리) ===== */
function calcSpreadPct(t){
  const price=t.trade_price;
  const range=Math.max((t.high_price - t.low_price)/Math.max(price,1e-9),0); // 24h 폭
  return Math.min(0.02, Math.max(0.003, range*0.25)); // 0.30% ~ 2.00%
}
function computeTapPoints(t){
  const price=t.trade_price, unit=priceUnit(price);
  let spreadPct=calcSpreadPct(t);
  let buy=price*(1-spreadPct), sell=price*(1+spreadPct);
  buy=roundToUnit(buy,unit); sell=roundToUnit(sell,unit);
  const minSep=Math.max(unit*2, price*0.002); // 최소 0.2% 또는 호가×2
  if (sell - buy < minSep){
    const c=price;
    buy = roundToUnit(c - minSep/2, unit);
    sell= roundToUnit(c + minSep/2, unit);
    if (sell<=buy) sell=buy+unit*2;
  }
  const stopPct=Math.min(0.04, Math.max(0.01, spreadPct*1.5));
  let stop=roundToUnit(buy*(1-stopPct), unit);
  if (stop>=buy) stop=buy-unit*2;
  // 위험도/멘트(간단)
  const ch=t.signed_change_rate||0;
  const risk = Math.min(0.5, Math.abs(ch) + (t.high_price&&t.low_price ? (t.high_price - t.low_price)/price : 0));
  let pep='👀 관망';
  if (ch>0.08 && risk<0.12) pep='🚀 폭등 모드!';
  else if (ch>0.03) pep='🔥 불장 신호!';
  else if (ch<-0.06) pep='🧯 낙폭경계';
  else if (risk>0.25) pep='⚠️ 변동 주의';
  return {buy,sell,stop,risk,pep};
}

/* ===== 데이터 로드 ===== */
async function loadMarkets(){
  const arr = await upbit('/v1/market/all?isDetails=true');
  state.markets = arr;
  state.krw = arr.filter(m=>m.market.startsWith('KRW-'));
  state.nameMap = Object.fromEntries(state.krw.map(m=>[m.market.split('-')[1], m.korean_name]));
}
async function loadTickers(){
  if (!state.krw.length) return;
  const mk = state.krw.map(m=>m.market);
  const batch=90; const out=[];
  for(let i=0;i<mk.length;i+=batch){
    const slice=mk.slice(i,i+batch);
    const d=await upbit('/v1/ticker?markets='+slice.join(','));
    out.push(...d);
    await new Promise(r=>setTimeout(r,220)); // 과호출 완화
  }
  state.tickers=out; state.online=true;
}

/* ===== 렌더링 ===== */
function renderSelected(tk){
  const row=$('#selectedRow');
  if(!tk){ row.innerHTML=`<div class="cell">없음 —</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div><div class="cell">—</div>`; return; }
  const sym=tk.market.split('-')[1];
  const name=state.nameMap[sym]||sym;
  const p=computeTapPoints(tk);
  row.innerHTML = `
    <div class="cell"><b>${name}</b> <span class="muted">(${tk.market})</span></div>
    <div class="cell">${fmt(tk.trade_price)}</div>
    <div class="cell">${rateSpan(tk.signed_change_rate)}</div>
    <div class="cell">${fmt(p.buy)}</div>
    <div class="cell">${fmt(p.sell)}</div>
    <div class="cell">${fmt(p.stop)}</div>
    <div class="cell">${p.risk>0.25? '3(주의)': p.risk>0.12? '2(보통)': '1(안정)'}</div>
    <div class="cell">${p.pep}</div>
  `;
}
function renderTables(){
  const up=$('#tblUp'), dn=$('#tblDown');
  up.innerHTML=''; dn.innerHTML='';
  if (!state.tickers.length) return;
  const arr = state.krw.map(m=> state.tickers.find(t=>t.market===m.market)).filter(Boolean)
                       .map(t=>({...t, _ko: state.nameMap[t.market.split('-')[1]] || t.market}));
  const ups = [...arr].filter(t=>t.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const dns = [...arr].filter(t=>t.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
  function rowHTML(t,i){
    const P=computeTapPoints(t);
    return `<tr data-m="${t.market}">
      <td class="muted">${i+1}</td>
      <td><b>${t._ko}</b> <span class="muted">(${t.market})</span></td>
      <td class="num">${fmt(t.trade_price)}</td>
      <td class="num">${rateSpan(t.signed_change_rate)}</td>
      <td class="num">${fmt(P.buy)}</td>
      <td class="num">${fmt(P.sell)}</td>
      <td class="num">${fmt(P.stop)}</td>
      <td class="num">${P.risk>0.25? '3(주의)': P.risk>0.12? '2(보통)': '1(안정)'}</td>
      <td>${P.pep}</td>
    </tr>`;
  }
  ups.forEach((t,i)=>up.insertAdjacentHTML('beforeend', rowHTML(t,i)));
  dns.forEach((t,i)=>dn.insertAdjacentHTML('beforeend', rowHTML(t,i)));
  // 클릭 선택
  [...up.querySelectorAll('tr'), ...dn.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m=tr.getAttribute('data-m');
      const tk=state.tickers.find(x=>x.market===m);
      if(tk) renderSelected(tk);
    });
  });
}

/* ===== 검색 ===== */
let searchTimer=null;
function doSearch(){
  const q=$('#q').value;
  const m = resolveMarket(q);
  if(!m){ alert('코인을 찾지 못했습니다. (한글/영문/심볼/마켓코드 지원)'); return; }
  const tk = state.tickers.find(t=>t.market===m);
  if(!tk){ alert('데이터 준비 중입니다. 잠시 후 다시 시도해주세요.'); return; }
  renderSelected(tk);
}
$('#btnSearch').onclick = ()=>doSearch();
$('#btnReset').onclick  = ()=>{ $('#q').value=''; renderSelected(null); };
$('#q').addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer=setTimeout(doSearch, 600); // 디바운스
});

/* ===== 루프 ===== */
function preserveScroll(fn){
  try{
    const u=document.querySelector('.tbl-wrap:nth-of-type(1)'); const d=document.querySelector('.tbl-wrap:nth-of-type(2)');
    const ut=u?.scrollTop||0, dt=d?.scrollTop||0; fn(); if(u)u.scrollTop=ut; if(d)d.scrollTop=dt;
  }catch(e){ fn(); }
}
async function loop(){
  try{
    if(!state.markets.length) await loadMarkets();
    await loadTickers();
    preserveScroll(()=>{ renderTables(); });
    state.online=true;
  }catch(e){
    console.warn('loop error',e);
    state.online=false;
  }finally{
    setTimeout(loop, 5000); // 5초 갱신(429 완화)
  }
}
loop();
</script>
</body>
</html>
