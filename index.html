<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쩔어지갑 v4.3 — 업비트 실시간 + 급등 피드(저장/알림)</title>
  <style>
    :root{--bg:#0d1117;--panel:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#9fb1c1;--up:#16c784;--down:#ea3943;--chip:#223045}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    .badge{background:var(--chip);border:1px solid #283752;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25);margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    input,button{background:#0e141b;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
    input{flex:1;min-width:260px}
    button{cursor:pointer}
    button:hover{background:#1a2330}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:center}
    .price{font-weight:800;font-size:28px}
    .diff.up{color:var(--up)}.diff.down{color:var(--down)}
    .muted{color:var(--muted)}
    .error{color:#ff6b6b;font-size:12px;margin-top:6px}
    /* 새 급등 하이라이트 */
    @keyframes flash {
      0%{background:rgba(255,255,0,.18)}
      100%{background:transparent}
    }
    .flash { animation: flash 1s ease-out 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>쩔어지갑 <span class="badge">v4.3</span> <span class="badge" id="net">OFFLINE</span></h1>
      <div class="badge" id="clock">KST — --:--:--</div>
    </header>

    <!-- 검색 영역 -->
    <div class="card">
      <div class="row">
        <div class="search">
          <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH)" autocomplete="off" />
          <button id="btnSearch">검색</button>
          <button id="btnClear">초기화</button>
        </div>
      </div>
      <div id="searchError" class="error" style="display:none;"></div>
    </div>

    <!-- 선택 코인 결과 -->
    <div class="card" id="result" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:end">
        <div>
          <div style="font-weight:700;font-size:18px">선택된 코인: <span id="selName" class="muted">-</span></div>
          <div id="selMarket" class="badge" style="margin-top:6px">—</div>
        </div>
        <div style="text-align:right">
          <div id="nowPrice" class="price">—</div>
          <div id="nowChange" class="diff">—</div>
        </div>
      </div>
      <table style="margin-top:10px">
        <thead>
          <tr class="muted"><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr>
        </thead>
        <tbody>
          <tr>
            <td id="c_price">—</td>
            <td id="c_buy">—</td>
            <td id="c_sell">—</td>
            <td id="c_stop">—</td>
            <td id="c_risk">—</td>
            <td id="c_comment">—</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 🔥 급등코인 실시간 피드 (누적형 + 저장/복원 + 알림/하이라이트) -->
    <div class="card" id="hotCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">🔥 급등코인 실시간 피드 (5%↑, 10억↑)</h3>
        <div class="row" style="gap:8px">
          <button id="btnFeedClear" title="저장된 급등 피드 비우기">피드 비우기</button>
          <button id="btnTestBeep" title="알림음 테스트">🔔 테스트</button>
        </div>
      </div>
      <table>
        <thead>
          <tr class="muted"><th>코인명</th><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr>
        </thead>
        <tbody id="hotFeed"></tbody>
      </table>
      <div class="muted" style="font-size:12px;margin-top:6px">※ 새로 감지된 급등코인은 위로 추가, 기존 항목은 아래로 이동. (최대 100개, 24시간 보관)</div>
    </div>
  </div>

  <script>
    // ===== 유틸/안정성 =====
    const $=(id)=>document.getElementById(id);

    function safeJSON(url, timeout=9000){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), timeout);
      return fetch(url, {signal: ctrl.signal})
        .then(res=>{ if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); })
        .finally(()=>clearTimeout(timer));
    }

    // 시계/온라인 뱃지
    function tick(){
      const clock=$('clock'), net=$('net');
      if(!clock||!net) return;
      const now=new Date(), utc=now.getTime()+now.getTimezoneOffset()*60000;
      const kst=new Date(utc+9*3600000);
      clock.textContent='KST — '+kst.toLocaleTimeString('ko-KR',{hour12:false});
      net.textContent=navigator.onLine?'ONLINE':'OFFLINE';
      net.style.background=navigator.onLine?'#123922':'#3a1a1a';
    }
    window.addEventListener('DOMContentLoaded',()=>{ tick(); setInterval(tick,1000); });

    // 업비트 호가단위 포맷
    function getTick(price){
      if(price>=2000000) return 1000;
      if(price>=1000000) return 500;
      if(price>=500000)  return 100;
      if(price>=100000)  return 50;
      if(price>=10000)   return 10;
      if(price>=1000)    return 5;
      if(price>=100)     return 1;
      if(price>=10)      return 0.1;
      if(price>=1)       return 0.01;
      if(price>=0.1)     return 0.001;
      if(price>=0.01)    return 0.0001;
      if(price>=0.001)   return 0.00001;
      if(price>=0.0001)  return 0.000001;
      if(price>=0.00001) return 0.0000001;
      if(price>=0.000001)return 0.00000001;
      return 0.000000001;
    }
    function fmtKRW(x){
      const t=getTick(x);
      const d=(t.toString().split('.')[1]||'').length;
      const r=Math.round(x/t)*t;
      return r.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
    }

    // 알림음 (WebAudio, 외부파일 불필요)
    let audioCtx;
    function beep(ms=180, freq=880){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0.001,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.02); o.stop(); }, ms);
      }catch(e){ /* 음소거 환경일 수 있음 */ }
    }
    $('btnTestBeep').addEventListener('click', ()=>beep());

    // 업비트 마켓/티커
    let MARKETS=[];
    async function ensureMarkets(){
      if(MARKETS.length) return MARKETS;
      const all = await safeJSON('https://api.upbit.com/v1/market/all?isDetails=false');
      MARKETS = all.filter(m=>m.market.startsWith('KRW-'));
      return MARKETS;
    }
    async function getTicker(market){
      return (await safeJSON(`https://api.upbit.com/v1/ticker?markets=${market}`))[0];
    }

    // 분석 텍스트
    function riskText(rate){
      const r=Math.abs(rate*100);
      if(r<1) return '1(안정)';
      if(r<3) return '2(보통)';
      return '3(주의)';
    }
    function zzeolComment(rate){
      if(rate>0.08) return '🚀 폭등 모드!';
      if(rate>0.05) return '🔥 불장 신호!';
      if(rate>0.02) return '📈 상승 탄력';
      if(rate>-0.02) return '⚖️ 관망';
      return '💀 하락 리스크';
    }

    // 검색 (부분일치/엔터/오류표시)
    async function doSearch(){
      const err=$('searchError'); err.style.display='none';
      const q=($('q').value||'').trim();
      if(!q){ $('q').focus(); return; }

      try{
        const list=await ensureMarkets();
        const s=q.toLowerCase();

        const exact=list.find(x =>
          x.korean_name.toLowerCase()===s ||
          (x.english_name||'').toLowerCase()===s ||
          x.market.toLowerCase()===s ||
          x.market.replace('KRW-','').toLowerCase()===s
        );
        const coin=exact || list.find(x =>
          x.korean_name.toLowerCase().includes(s) ||
          (x.english_name||'').toLowerCase().includes(s) ||
          x.market.toLowerCase().includes(s) ||
          x.market.replace('KRW-','').toLowerCase().includes(s)
        );
        if(!coin){ err.textContent='일치하는 코인을 못 찾았어. (예: 이더리움 / ETH / KRW-ETH)'; err.style.display='block'; return; }

        const t=await getTicker(coin.market);
        const p=t.trade_price, rate=t.signed_change_rate;

        $('result').style.display='block';
        $('selName').textContent=coin.korean_name;
        $('selMarket').textContent=coin.market;
        $('nowPrice').textContent=fmtKRW(p)+' 원';
        $('nowChange').className='diff '+(t.change==='RISE'?'up':t.change==='FALL'?'down':'');
        $('nowChange').textContent=`${t.change==='RISE'?'+':''}${(rate*100).toFixed(2)}%`;

        $('c_price').textContent=fmtKRW(p);
        $('c_buy').textContent  =fmtKRW(p*0.988);
        $('c_sell').textContent =fmtKRW(p*1.012);
        $('c_stop').textContent =fmtKRW(p*0.975);
        $('c_risk').textContent =riskText(rate);
        $('c_comment').textContent=zzeolComment(rate);
      }catch(e){
        console.error(e);
        err.textContent='업비트 연결에 문제가 있어. 잠시 후 다시 시도해줘!';
        err.style.display='block';
      }
    }
    $('btnSearch').addEventListener('click', doSearch);
    $('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    $('btnClear').addEventListener('click', ()=>{
      $('q').value=''; $('result').style.display='none'; $('searchError').style.display='none';
    });

    // 급등 피드 저장/복원
    const FEED_KEY='zzeol_hot_feed_v1';
    const FEED_TTL_HOURS=24;

    function loadFeedFromStore(){
      try{
        const raw=localStorage.getItem(FEED_KEY);
        if(!raw) return [];
        const arr=JSON.parse(raw);
        const now=Date.now();
        return arr.filter(x=> now - x.ts < FEED_TTL_HOURS*3600*1000).slice(0,100);
      }catch{return [];}
    }
    function saveFeedToStore(items){
      try{ localStorage.setItem(FEED_KEY, JSON.stringify(items.slice(0,100))); }
      catch(e){ console.warn('feed save failed', e); }
    }
    function renderFeed(items){
      const feed=$('hotFeed'); feed.innerHTML='';
      for(const it of items){
        const tr=document.createElement('tr'); tr.style.textAlign='center';
        tr.innerHTML=`
          <td>💥 ${it.sym}</td>
          <td>${it.price}</td>
          <td>${it.buy}</td>
          <td>${it.sell}</td>
          <td>${it.stop}</td>
          <td>${it.risk}</td>
          <td>${it.comment}</td>`;
        feed.appendChild(tr);
      }
    }
    $('btnFeedClear').addEventListener('click', ()=>{
      localStorage.removeItem(FEED_KEY);
      renderFeed([]);
      alert('급등 피드를 비웠습니다.');
    });

    // 급등 피드 (신규 위로, 저장/복원, 알림/하이라이트)
    const shown={}; // 이미 화면에 있는 심볼
    async function loadHot(){
      try{
        const list=await ensureMarkets();
        const tickers=await safeJSON('https://api.upbit.com/v1/ticker?markets='+list.map(x=>x.market).join(','), 12000);

        const hot=tickers
          .filter(t=> t.signed_change_rate>0.05 && t.acc_trade_price_24h>10_000_000_000)
          .sort((a,b)=> b.signed_change_rate-a.signed_change_rate);

        const feedEl=$('hotFeed');
        let store=loadFeedFromStore();

        for(const t of hot){
          const sym=t.market.replace('KRW-','');
          if (shown[sym]) continue;

          shown[sym]=true;
          const p=t.trade_price, rate=t.signed_change_rate;

          // 새 행 생성 + 하이라이트
          const tr=document.createElement('tr'); tr.style.textAlign='center'; tr.classList.add('flash');
          tr.innerHTML=`
            <td>💥 ${sym}</td>
            <td>${fmtKRW(p)}</td>
            <td>${fmtKRW(p*0.988)}</td>
            <td>${fmtKRW(p*1.012)}</td>
            <td>${fmtKRW(p*0.975)}</td>
            <td>${riskText(rate)}</td>
            <td>${zzeolComment(rate)}</td>`;
          feedEl.prepend(tr);
          setTimeout(()=>tr.classList.remove('flash'), 1000);

          // 알림음
          beep(160, 920);

          // 저장소 갱신(최신 맨 앞, 중복 제거)
          const entry={
            ts:Date.now(),
            sym,
            price:fmtKRW(p),
            buy:fmtKRW(p*0.988),
            sell:fmtKRW(p*1.012),
            stop:fmtKRW(p*0.975),
            risk:riskText(rate),
            comment:zzeolComment(rate)
          };
          store=[entry, ...store.filter(x=>x.sym!==sym)];
          saveFeedToStore(store);
        }
      }catch(e){ console.error('급등 피드 오류:', e); }
    }

    // 부팅 시 저장된 피드 복원 → 이후 1분마다 업데이트
    window.addEventListener('DOMContentLoaded', ()=>{
      const boot=loadFeedFromStore();
      if(boot.length) renderFeed(boot);
      loadHot();
      setInterval(loadHot, 60000);
    });
  </script>
</body>
</html>
