<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3+</title>
<style>
  :root{
    --bg:#0f141a;--panel:#111a24;--line:#1b2633;--txt:#d6e0ea;--mut:#8ca1b3;
    --pos:#32d296;--neg:#ff5670;--chip:#233140;--chipTxt:#cfe7ff;--accent:#67b8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,"Noto Sans KR",sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#16202b;color:#a5c4de;font-weight:600}
  .pill{padding:3px 10px;border-radius:8px;background:var(--chip);color:var(--chipTxt);font-weight:600}
  .btn{padding:8px 12px;border:1px solid var(--line);background:var(--panel);color:var(--txt);border-radius:8px;cursor:pointer}
  .btn:hover{border-color:#2c3b4e}
  .mut{color:var(--mut)}
  .h1{font-size:18px;font-weight:800}
  .clock{margin-left:auto}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel+.panel{margin-top:12px}
  .grid{display:grid;gap:8px}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1218;color:var(--txt);outline:none}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2c3a;color:#bfe1ff;font-weight:700}
  .chip.risk{background:#2a1c1c;color:#ffbfc8}
  .pos{color:var(--pos);font-weight:700}
  .neg{color:var(--neg);font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:12px;color:#9fb1c3;text-align:center;font-weight:700}
  tbody td{background:#0e1620;border-top:1px solid #0d1a24;border-bottom:1px solid #0d1a24;padding:8px 10px;text-align:center}
  tbody tr td:first-child{border-left:1px solid #0d1a24;border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-right:1px solid #0d1a24;border-top-right-radius:10px;border-bottom-right-radius:10px}
  tbody tr:hover td{background:#121c27}
  .left{text-align:left}
  .mono{font-variant-numeric:tabular-nums}
  .card{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:8px}
  .kpi{background:#0e1620;border:1px solid #0d1a24;border-radius:10px;padding:10px;text-align:center}
  .kpi .label{font-size:12px;color:#9fb1c3}
  .kpi .val{margin-top:2px;font-weight:800}
  .toolbar{display:flex;gap:6px;align-items:center}
  .section-title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .legend{font-size:12px;color:#9fb1c3}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">

  <!-- í—¤ë” -->
  <div class="row">
    <div class="badge">ì©”ì–´ì§€ê°‘ <span class="mut">v6.3+</span></div>
    <div class="pill">ONLINE</div>
    <div class="spacer"></div>
    <div class="mut clock" id="clock">KST â€” --:--:--</div>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="panel">
    <div class="search">
      <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
      <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
      <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
    </div>
    <!-- ì„ íƒëœ ì½”ì¸ ì¹´ë“œ -->
    <div class="panel" style="margin-top:10px">
      <div class="row section-title">
        <div class="h1">ì„ íƒëœ ì½”ì¸: <span id="selName" class="mut">ì—†ìŒ</span></div>
        <div class="spacer"></div>
        <div class="legend">ë³€ë™ë¥ ì€ ì‹¤ì‹œê°„ ì¶”ì •, <span class="mut">ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆì€ í˜¸ê°€ë‹¨ìœ„ ê¸°ì¤€</span></div>
      </div>
      <div class="card">
        <div class="kpi"><div class="label">í˜„ì¬ê°€</div><div class="val mono" id="k_now">â€”</div></div>
        <div class="kpi"><div class="label">ë§¤ìˆ˜</div><div class="val mono" id="k_buy">â€”</div></div>
        <div class="kpi"><div class="label">ë§¤ë„</div><div class="val mono" id="k_sell">â€”</div></div>
        <div class="kpi"><div class="label">ì†ì ˆ</div><div class="val mono" id="k_stop">â€”</div></div>
        <div class="kpi"><div class="label">ìœ„í—˜ë„</div><div class="val" id="k_risk">â€”</div></div>
        <div class="kpi"><div class="label">ì©”ì–´í•œë§ˆë””</div><div class="val" id="k_say">â€”</div></div>
        <div class="kpi"><div class="label">ë³€ë™ë¥ </div><div class="val" id="k_pct">â€”</div></div>
        <div class="kpi"><div class="label">ì—°ê²°</div><div class="val" id="k_net" title="ì—…ë°ì´íŠ¸ ìƒíƒœ">ê´€ë§</div></div>
      </div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ í‘œ -->
  <div class="panel">
    <div class="row section-title">
    <div class="h1">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</div>
      <div class="spacer"></div>
      <div class="toolbar">
        <button class="btn" id="btnUpRefresh">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn" id="btnUpClear">ë¹„ìš°ê¸°</button>
      </div>
    </div>
    <table id="tblUp">
      <thead>
        <tr>
          <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
          <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel">
    <div class="row section-title">
      <div class="h1">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</div>
      <div class="spacer"></div>
      <div class="toolbar">
        <button class="btn" id="btnDownRefresh">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn" id="btnDownClear">ë¹„ìš°ê¸°</button>
      </div>
    </div>
    <table id="tblDown">
      <thead>
        <tr>
          <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
          <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ===== ê¸°ë³¸ ìƒíƒœ ===== */
const state = {
  markets: [],         // KRW-* ì „ì²´
  nameMap: {},         // í‹°ì»¤ì‹¬ë³¼ -> í•œê¸€ëª…
  tickers: [],         // ìµœì‹  ì‹œì„¸
  selected: null,      // ì„ íƒëœ í‹°ì»¤
  alive: true,
  backoff: 0
};

const API = (path)=> `/api/upbit?path=${encodeURIComponent(path)}`;

/* ===== ìœ í‹¸ ===== */
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const fmt = n => (n==null? 'â€”' : Number(n).toLocaleString('ko-KR'));
const pctStr = p => `${(p*100).toFixed(2)}%`;

function priceUnit(p){
  if (p >= 2_000_000) return 1000;
  if (p >= 1_000_000) return 500;
  if (p >= 500_000)  return 100;
  if (p >= 100_000)  return 50;
  if (p >= 10_000)   return 10;
  if (p >= 1_000)    return 5;
  if (p >= 100)      return 1;
  if (p >= 10)       return 0.1;
  if (p >= 1)        return 0.01;
  return 0.001;
}

function riskBadge(p){
  const ap = Math.abs(p);
  if (ap >= 0.15) return `<span class="chip risk">3(ì£¼ì˜)</span>`;
  if (ap >= 0.07) return `<span class="chip">2(ë³´í†µ)</span>`;
  return `<span class="chip">1(ì•ˆì •)</span>`;
}

function sayByPct(p){
  if (p >= 0.25) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
  if (p >= 0.07) return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  if (p <= -0.12) return 'âš ï¸ ë‚™í­ì£¼ì˜';
  if (p <= -0.05) return 'ğŸ˜¬ ì¡°ì •ê¶Œ';
  return 'ğŸ‘€ ê´€ë§';
}

function kstClock(){
  const el = document.getElementById('clock');
  setInterval(()=>{
    const t = new Date(new Date().getTime()+9*3600000);
    el.textContent = 'KST â€” ' + new Date().toLocaleTimeString('ko-KR', {hour12:false});
  },1000);
}

/* ===== ë°ì´í„° ===== */
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function loadMarkets(){
  // ì „ì²´ ë§ˆì¼“ + í•œê¸€ëª…
  const arr = await fetchJSON(API('/v1/market/all?isDetails=true'));
  state.markets = arr.filter(x=>x.market.startsWith('KRW-')).map(x=>x.market);
  state.nameMap = {};
  for (const it of arr){
    const sym = it.market.split('-')[1];
    state.nameMap[sym] = it.korean_name || sym;
  }
}

async function loadTickers(markets){
  if (!markets.length) return [];
  const url = API('/v1/ticker?markets=' + encodeURIComponent(markets.join(',')));
  return await fetchJSON(url);
}

/* ===== ë Œë” ===== */
function renderSelected(tk){
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym] || sym;
  const unit = priceUnit(tk.trade_price);
  const buy  = Math.max(tk.trade_price - unit, 0);
  const sell = tk.trade_price + unit;
  const stop = Math.max(tk.trade_price - unit*5, 0);

  document.getElementById('selName').textContent = name;
  document.getElementById('k_now').textContent  = fmt(tk.trade_price);
  const p = tk.signed_change_rate;
  document.getElementById('k_pct').innerHTML = `<span class="${p>=0?'pos':'neg'}">${pctStr(p)}</span>`;
  document.getElementById('k_buy').textContent  = fmt(buy);
  document.getElementById('k_sell').textContent = fmt(sell);
  document.getElementById('k_stop').textContent = fmt(stop);
  document.getElementById('k_risk').innerHTML  = riskBadge(p);
  document.getElementById('k_say').textContent = sayByPct(p);
  document.getElementById('k_net').textContent = 'ì—°ê²°ë¨';
}

function makeRowHtml(i, tk){
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym] || sym;
  const unit = priceUnit(tk.trade_price);
  const buy  = Math.max(tk.trade_price - unit, 0);
  const sell = tk.trade_price + unit;
  const stop = Math.max(tk.trade_price - unit*5, 0);
  const p = tk.signed_change_rate;

  return `<tr data-m="${tk.market}">
    <td>${i}</td>
    <td class="left" title="${tk.market}" style="cursor:pointer">${name}</td>
    <td class="mono">${fmt(tk.trade_price)}</td>
    <td class="${p>=0?'pos':'neg'} mono">${pctStr(p)}</td>
    <td class="mono">${fmt(buy)}</td>
    <td class="mono">${fmt(sell)}</td>
    <td class="mono">${fmt(stop)}</td>
    <td>${riskBadge(p)}</td>
    <td>${sayByPct(p)}</td>
  </tr>`;
}

function renderList(tbody, list){
  tbody.innerHTML = '';
  list.forEach((tk,i)=>{
    tbody.insertAdjacentHTML('beforeend', makeRowHtml(i+1, tk));
  });
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if (!tk) return;
      state.selected = tk;
      renderSelected(tk);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

function renderTables(){
  const upBody = document.querySelector('#tblUp tbody');
  const dnBody = document.querySelector('#tblDown tbody');
  const V = 1_000_000_000; // 10ì–µ

  const ups = state.tickers
    .filter(t=> t.signed_change_rate >= 0.05 && t.acc_trade_price_24h >= V)
    .sort((a,b)=> b.signed_change_rate - a.signed_change_rate)
    .slice(0,10);

  const dns = state.tickers
    .filter(t=> t.signed_change_rate <= -0.05 && t.acc_trade_price_24h >= V)
    .sort((a,b)=> a.signed_change_rate - b.signed_change_rate)
    .slice(0,10);

  renderList(upBody, ups);
  renderList(dnBody, dns);
}

/* ===== ë™ì‘ ===== */
async function boot(){
  kstClock();

  // UI
  document.getElementById('btnUpClear').onclick   =
  document.getElementById('btnDownClear').onclick = ()=>{
    document.querySelector('#tblUp tbody').innerHTML='';
    document.querySelector('#tblDown tbody').innerHTML='';
  };
  document.getElementById('btnUpRefresh').onclick   =
  document.getElementById('btnDownRefresh').onclick = ()=> renderTables();

  // ê²€ìƒ‰
  const runSearch = ()=>{
    const q = document.getElementById('q').value.trim().toUpperCase();
    if(!q) return;
    // ì‹¬ë³¼ or í•œê¸€ëª… or KRW-*
    const hit = state.tickers.find(t=>{
      const sym = t.market.split('-')[1];
      const ko  = state.nameMap[sym]||'';
      return t.market===q || sym===q || ko.includes(q) || q.includes(sym);
    }) || state.tickers.find(t=> t.market.includes(q));
    if(hit){ state.selected = hit; renderSelected(hit); }
  };
  document.getElementById('btnSearch').onclick = runSearch;
  document.getElementById('btnReset').onclick  = ()=>{
    document.getElementById('q').value='';
    state.selected = null;
    document.getElementById('selName').textContent='ì—†ìŒ';
    ['k_now','k_buy','k_sell','k_stop','k_risk','k_say','k_pct','k_net'].forEach(id=>document.getElementById(id).textContent='â€”');
  };

  // ë°ì´í„° ë£¨í”„(í´ë§ + ë°±ì˜¤í”„)
  try{
    await loadMarkets();
  }catch(e){
    console.error('ì‹œì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨',e);
  }

  // í•œë²ˆì— ë„ˆë¬´ ë§ì´ ìš”ì²­í•˜ì§€ ì•Šê²Œ ë¶„í• 
  const chunks = [];
  for (let i=0;i<state.markets.length;i+=100) chunks.push(state.markets.slice(i,i+100));

  while(true){
    try{
      const all = [];
      for(const c of chunks){
        const arr = await loadTickers(c);
        all.push(...arr);
        await sleep(200); // ì‚´ì§ í…€
      }
      state.tickers = all;

      // ì„ íƒ ìœ ì§€
      if(state.selected){
        const cur = all.find(x=>x.market===state.selected.market);
        if(cur) renderSelected(cur);
      }
      renderTables();

      state.backoff = 0; // ì •ìƒí™”
      await sleep(5_000); // 5ì´ˆ í´ë§
    }catch(e){
      console.warn('í‹°ì»¤ ë¡œë“œ ì‹¤íŒ¨', e.message);
      const wait = Math.min(60_000, 2_000 * Math.pow(2, state.backoff++));
      document.getElementById('k_net').textContent = `ì¬ì‹œë„ ëŒ€ê¸° ${Math.round(wait/1000)}ì´ˆ`;
      await sleep(wait);
    }
  }
}

boot();
</script>
<script src="strategies/exploder.js"></script>  
<!-- ===== BEGIN: Upbit ë¶„ì„(ìº”ë“¤) + íƒ€ì  ì—°ê²° íŒ¨ì¹˜ ===== -->
<script>
/* 0) ì•ˆì „ ìœ í‹¸ */
const zzSleep = (ms)=>new Promise(r=>setTimeout(r,ms));
async function zzFetchJSON(url, tries=4){
  for(let i=0;i<tries;i++){
    try{
      const r = await fetch(url, {cache:'no-store'});
      if (r.status===429) { await zzSleep(600*(i+1)); continue; }
      if (!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ if(i===tries-1) throw e; }
  }
}

/* 1) ìº”ë“¤ ë¶ˆëŸ¬ì˜¤ê¸° (Upbit â†’ ë¶„ë´‰ 1m ê¸°ì¤€ 120ê°œ) */
async function getCandles(market, minutes=1, count=120){
  const path = `/v1/candles/minutes/${minutes}?market=${encodeURIComponent(market)}&count=${count}`;
  return await zzFetchJSON(`/api/upbit?path=${encodeURIComponent(path)}&ts=${Date.now()}`);
}

/* 2) íƒ€ì  ê³„ì‚°ê¸° (EMA21/55 + VWAP + ATR)  â€” UI/ê¸°ëŠ¥ ì•ˆê±´ë“œë¦¼ */
function zzComputeSignals(candles){
  if (!Array.isArray(candles) || candles.length<60) return null;
  // upbit ë¶„ë´‰ í¬ë§· â†’ í†µì¼
  const cs = candles.slice().reverse().map(c=>({
    t: new Date(c.timestamp||c.candle_date_time_kst).getTime(),
    o: c.opening_price, h: c.high_price, l: c.low_price, c: c.trade_price, v: c.candle_acc_trade_volume
  }));
  const C = cs.map(x=>x.c), H=cs.map(x=>x.h), L=cs.map(x=>x.l), V=cs.map(x=>x.v);
  const i = C.length-1;

  // EMA
  const ema=(arr,n)=>{ const k=2/(n+1); let e=arr[0]; for(let j=1;j<arr.length;j++) e=arr[j]*k+e*(1-k); return e; };
  const EMA21 = ema(C,21), EMA55 = ema(C,55);

  // ATR(14)
  const tr=[]; for(let j=0;j<cs.length;j++){ if(j===0){tr.push(H[j]-L[j]); continue;}
    tr.push(Math.max(H[j]-L[j], Math.abs(H[j]-C[j-1]), Math.abs(L[j]-C[j-1]))); }
  const n=14; let ATR = tr.slice(-n).reduce((a,b)=>a+b,0)/n;

  // ë‹¹ì¼ VWAP(ê°„ë‹¨)
  const day = cs.slice(-360);
  const pv = day.reduce((s,x)=>s + ((x.h+x.l+x.c)/3)*(x.v||0),0);
  const vv = day.reduce((s,x)=>s + (x.v||0),0);
  const VWAP = vv ? pv/vv : C[i];

  const up   = (C[i]>EMA21 && EMA21>EMA55 && C[i]>VWAP);
  const down = (C[i]<EMA21 && EMA21<EMA55 && C[i]<VWAP);
  const R = ATR; // ë¦¬ìŠ¤í¬ ë‹¨ìœ„

  const high60 = Math.max(...H.slice(-60));
  const low60  = Math.min(...L.slice(-60));
  const swingLow  = Math.min(...L.slice(-10));
  const swingHigh = Math.max(...H.slice(-10));

  // ë ˆë²¨
  let buy=null, sell=null, stop=null, risk='1(ì•ˆì •)', zmsg='ğŸ‘€ ê´€ë§';
  const atrPct = (R/(C[i]||1))*100;
  if (atrPct>7) risk='3(ì£¼ì˜)'; else if (atrPct>3.5) risk='2(ë³´í†µ)';

  if (up){
    // ì¡°ì •ë§¤ìˆ˜(EMA21-0.5R~EMA21), ëŒíŒŒë§¤ìˆ˜(high60+0.25R)
    buy  = Math.round(EMA21); // ìš”ì•½ í‘œì‹œëŠ” ì¤‘ì•™ê°’ í•˜ë‚˜ë¡œ
    sell = null;
    stop = Math.max(swingLow - 1*R, 0);
    zmsg = (C[i] > high60+0.25*R) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' : 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  } else if (down){
    buy  = null;
    sell = Math.round(EMA21);
    stop = Math.round(swingHigh + 1*R);
    zmsg = (C[i] < low60-0.25*R) ? 'âš ï¸ ë‚™í­ì£¼ì˜' : 'ğŸ˜¬ ì¡°ì •ê¶Œ';
  }

  return { price:C[i], ema21:EMA21, ema55:EMA55, vwap:VWAP, atr:R, buy, sell, stop, risk, zmsg };
}

/* 3) ì„ íƒ ì½”ì¸ì— ë¶„ì„ ë°”ì¸ë”© (ìƒë‹¨ ì¹´ë“œì— ê°’ ê½‚ê¸°) */
async function zzAnalyzeSelected(ticker){
  try{
    const mkt = ticker.market;                 // KRW-ETH ë“±
    const candles = await getCandles(mkt, 1, 120);
    const sig = zzComputeSignals(candles);
    if(!sig) return;

    // ìƒë‹¨ ì¹´ë“œ idëŠ” v6.3 ê¸°ì¤€ (ì—†ìœ¼ë©´ ë¬´ì‹œ)
    const $id = (x)=>document.getElementById(x);
    if ($id('k_now'))  $id('k_now').textContent  = sig.price?.toLocaleString('ko-KR') ?? 'â€”';
    if ($id('k_buy'))  $id('k_buy').textContent  = sig.buy  ? Math.round(sig.buy).toLocaleString('ko-KR')  : 'â€”';
    if ($id('k_sell')) $id('k_sell').textContent = sig.sell ? Math.round(sig.sell).toLocaleString('ko-KR') : 'â€”';
    if ($id('k_stop')) $id('k_stop').textContent = sig.stop ? Math.round(sig.stop).toLocaleString('ko-KR') : 'â€”';
    if ($id('k_risk')) $id('k_risk').textContent = sig.risk;
    if ($id('k_say'))  $id('k_say').textContent  = sig.zmsg;
    if ($id('k_pct') && typeof ticker.signed_change_rate==='number'){
      $id('k_pct').innerHTML = `<span class="${ticker.signed_change_rate>=0?'pos':'neg'}">${(ticker.signed_change_rate*100).toFixed(2)}%</span>`;
    }
    if ($id('k_net'))  $id('k_net').textContent  = 'ì—°ê²°ë¨(ë¶„ì„)';
  }catch(e){
    console.warn('ë¶„ì„ ì‹¤íŒ¨:', e);
    const k = document.getElementById('k_net');
    if (k) k.textContent = 'ë¶„ì„ ì¬ì‹œë„ ëŒ€ê¸°';
  }
}

/* 4) ê¸°ì¡´ ì„ íƒ ë¡œì§ì— â€œí›„í‚¹â€ (renderSelectedê°€ ìˆìœ¼ë©´ ëë‚˜ê³  ë¶„ì„ í˜¸ì¶œ) */
(function(){
  if (typeof window.renderSelected === 'function'){
    const _orig = window.renderSelected;
    window.renderSelected = function(tk, ...rest){
      const r = _orig.call(this, tk, ...rest);
      try{ zzAnalyzeSelected(tk); }catch(_){}
      return r;
    };
  } else {
    // renderSelectedê°€ ì—†ë‹¤ë©´, ì „ì—­ ì„ íƒ ë°”ë€” ë•Œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ê³µê°œ
    window.zzAnalyzeSelected = zzAnalyzeSelected;
  }
})();

/* 5) ê²€ìƒ‰/í–‰í´ë¦­ìœ¼ë¡œ ì„ íƒëœ ê²½ìš°ë„ 15ì´ˆë§ˆë‹¤ ìë™ ì¬ë¶„ì„ */
setInterval(()=>{
  if (window.state && window.state.selected){
    zzAnalyzeSelected(window.state.selected);
  }
}, 15000);
</script>
<!-- ===== END: ë¶„ì„(ìº”ë“¤) + íƒ€ì  ì—°ê²° íŒ¨ì¹˜ ===== -->
<!-- ===== BEGIN: íƒ€ì  í”„ë¡œ(EMA/RSI/VWAP/ATR/Volume) ì˜¤ë²„ë ˆì´ v6.3 ===== -->
<script>
/* ============ 0) ì„¤ì •(ì—¬ê¸° ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¯¼ê°ë„ íŠœë‹ ë©ë‹ˆë‹¤) ============ */
const ZCFG = {
  emaFast: 12,            // ë¹ ë¥¸ EMA
  emaSlow: 26,            // ëŠë¦° EMA
  rsiPeriod: 14,          // RSI ê¸°ê°„
  rsiBuyMin: 52,          // ë§¤ìˆ˜ RSI í•˜í•œ (ë‚®ì¶œìˆ˜ë¡ ê³µê²©ì )
  rsiSellMax: 48,         // ë§¤ë„ RSI ìƒí•œ (ë†’ì¼ìˆ˜ë¡ ê³µê²©ì )
  atrPeriod: 14,          // ATR ê¸°ê°„
  stopATR: 1.5,           // ì†ì ˆí­ = ATR * ì´ ê°’
  pbATR: 0.5,             // í’€ë°± ì§„ì… í­ = ATR * ì´ ê°’
  boATR: 0.25,            // ëŒíŒŒ ì—¬ìœ  = ATR * ì´ ê°’
  volLookback: 30,        // ê±°ë˜ëŸ‰ í‰ê·  êµ¬ê°„
  volSpike: 1.8,          // ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ ì„ê³„(= ìµœê·¼/í‰ê· ). ë†’ì´ë©´ ë³´ìˆ˜ì 
  minCandles: 80,         // ìµœì†Œ ìº”ë“¤ ìˆ˜
  minutes: 1,             // ë¶„ë´‰(1,3,5 ê¶Œì¥)
  fetchCount: 160,        // ê°€ì ¸ì˜¬ ìº”ë“¤ ìˆ˜
  refreshMs: 15000        // ìë™ ì¬ë¶„ì„ ì£¼ê¸°(ms)
};

/* ============ 1) ìœ í‹¸ ============ */
const zzSleep = (ms)=>new Promise(r=>setTimeout(r,ms));
async function zzFetchJSON(url, tries=4){
  for(let i=0;i<tries;i++){
    try{
      const r = await fetch(url,{cache:'no-store'});
      if(r.status===429){ await zzSleep(500*(i+1)); continue; }
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ if(i===tries-1) throw e; }
  }
}
async function getCandles(market, minutes=ZCFG.minutes, count=ZCFG.fetchCount){
  const path = `/v1/candles/minutes/${minutes}?market=${encodeURIComponent(market)}&count=${count}`;
  return await zzFetchJSON(`/api/upbit?path=${encodeURIComponent(path)}&ts=${Date.now()}`);
}
const emaArr=(arr,n)=>{ const k=2/(n+1); const out=[arr[0]]; for(let i=1;i<arr.length;i++){ out[i]=arr[i]*k+out[i-1]*(1-k);} return out; };
function rsiArr(closes, period=14){
  const out=new Array(closes.length).fill(null);
  let g=0,l=0;
  for(let i=1;i<=period;i++){ const d=closes[i]-closes[i-1]; if(d>=0) g+=d; else l-=d; }
  let ag=g/period, al=l/period;
  out[period]=100-(100/(1+(ag/(al||1e-9))));
  for(let i=period+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1], G=Math.max(d,0), L=Math.max(-d,0);
    ag=(ag*(period-1)+G)/period; al=(al*(period-1)+L)/period;
    out[i]=100-(100/(1+(ag/(al||1e-9))));
  }
  return out;
}
function atrLast(H,L,C,period=14){
  const tr=[]; for(let i=0;i<C.length;i++){
    if(i===0){ tr.push(H[0]-L[0]); continue; }
    tr.push(Math.max(H[i]-L[i], Math.abs(H[i]-C[i-1]), Math.abs(L[i]-C[i-1])));
  }
  if(tr.length<period) return tr.at(-1)??0;
  let a=tr.slice(0,period).reduce((x,y)=>x+y,0)/period;
  for(let i=period;i<tr.length;i++) a=(a*(period-1)+tr[i])/period;
  return a;
}
function smaLast(arr,n){ if(arr.length<n) return null; let s=0; for(let i=arr.length-n;i<arr.length;i++) s+=arr[i]; return s/n; }
function vwapDaySimple(H,L,C,V){
  const N=Math.min(360,C.length); let pv=0, vol=0;
  for(let i=C.length-N;i<C.length;i++){ const tp=(H[i]+L[i]+C[i])/3; pv+=tp*(V[i]||0); vol+=(V[i]||0); }
  return vol? pv/vol : C.at(-1);
}
function fmtKR(n){ return (n==null || isNaN(n)) ? 'â€”' : Math.round(n).toLocaleString('ko-KR'); }

/* ============ 2) íƒ€ì  í”„ë¡œ ë¡œì§ ============ */
function computeProSignals(candlesUpbit){
  if(!Array.isArray(candlesUpbit) || candlesUpbit.length<ZCFG.minCandles) return null;

  // Upbit ë¶„ë´‰ì„ ì˜¤ë˜ëœâ†’ìµœì‹  ìˆœìœ¼ë¡œ ë³€í™˜
  const cs = candlesUpbit.slice().reverse().map(c=>({
    o:c.opening_price, h:c.high_price, l:c.low_price, c:c.trade_price, v:c.candle_acc_trade_volume
  }));
  const C=cs.map(x=>x.c), H=cs.map(x=>x.h), L=cs.map(x=>x.l), V=cs.map(x=>x.v);
  const i=C.length-1, last=C[i];

  // ì§€í‘œ
  const emaF = emaArr(C, ZCFG.emaFast).at(-1);
  const emaS = emaArr(C, ZCFG.emaSlow).at(-1);
  const rsi   = rsiArr(C, ZCFG.rsiPeriod).at(-1);
  const atr   = atrLast(H,L,C, ZCFG.atrPeriod);
  const vwap  = vwapDaySimple(H,L,C,V);

  // ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬
  const vAvg = smaLast(V, Math.min(ZCFG.volLookback,V.length)) || 0.000001;
  const vSpike = (V.at(-1)||0) / vAvg;

  // ì¶”ì„¸/ë ˆì§
  const up   = (last>emaF && emaF>emaS && last>=vwap);
  const down = (last<emaF && emaF<emaS && last<=vwap);

  // ë ˆë²¨ ê³„ì‚°(í˜¸ê°€ë‹¨ìœ„ ëŒ€ì‹  ATR ê¸°ë°˜)
  const pbWidth = ZCFG.pbATR * atr;     // í’€ë°± í­
  const boPad   = ZCFG.boATR * atr;     // ëŒíŒŒ ì—¬ìœ 
  const stopMul = ZCFG.stopATR * atr;   // ì†ì ˆí­

  const high60 = Math.max(...H.slice(-60));
  const low60  = Math.min(...L.slice(-60));
  const swingLow  = Math.min(...L.slice(-12));
  const swingHigh = Math.max(...H.slice(-12));

  let buy=null, sell=null, stop=null, riskLabel='1(ì•ˆì •)', pep='ğŸ‘€ ê´€ë§';

  // ë¦¬ìŠ¤í¬ ë¼ë²¨(ATR%)
  const atrPct = (atr/(last||1))*100;
  if (atrPct>7) riskLabel='3(ì£¼ì˜)'; else if (atrPct>3.5) riskLabel='2(ë³´í†µ)';

  if (up && rsi>=ZCFG.rsiBuyMin && vSpike>=ZCFG.volSpike){
    // ìƒìŠ¹ + RSI ì–‘í˜¸ + ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ â†’ ê³µê²©ì  ë§¤ìˆ˜ í—ˆìš©
    const pbMid = Math.max(emaF - pbWidth*0.5, 0);
    buy  = pbMid;                     // í’€ë°± ì¤‘ì•™ê°’ (ë³´ìˆ˜ì ì´ë©´ emaF- pbWidth ì‚¬ìš©)
    stop = Math.max(swingLow - stopMul, 0);
    pep  = (last > high60 + boPad) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' : 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  } else if (down && rsi<=ZCFG.rsiSellMax && vSpike>=ZCFG.volSpike){
    // í•˜ë½ + RSI ì•½ì„¸ + ìŠ¤íŒŒì´í¬ â†’ ë§¤ë„(ë˜ëŠ” ë¡± íšŒí”¼)
    sell = emaF + pbWidth*0.5;
    stop = swingHigh + stopMul;
    pep  = (last < low60 - boPad) ? 'âš ï¸ ë‚™í­ì£¼ì˜' : 'ğŸ˜¬ ì¡°ì •ê¶Œ';
  } else {
    // ì¡°ê±´ ë¶ˆì¶©ì¡±: ê´€ë§
    if (up) pep='ìƒìŠ¹ ê´€ë§'; else if (down) pep='í•˜ë½ ê´€ë§';
  }

  return { price:last, emaFast:emaF, emaSlow:emaS, vwap, rsi, atr,
           vSpike, buy, sell, stop, risk:riskLabel, pep };
}

/* ============ 3) í™”ë©´ ë°”ì¸ë”©: ê¸°ì¡´ UI ê·¸ëŒ€ë¡œ, ê°’ë§Œ êµì²´ ============ */
async function analyzeSelectedPro(ticker){
  try{
    const mkt = ticker.market;
    const candles = await getCandles(mkt);
    const sig = computeProSignals(candles);
    if(!sig) return;

    const set = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    const setHTML = (id, html)=>{ const el=document.getElementById(id); if(el) el.innerHTML=html; };

    set('k_now',  fmtKR(sig.price));
    set('k_buy',  sig.buy  != null ? fmtKR(sig.buy)  : 'â€”');
    set('k_sell', sig.sell != null ? fmtKR(sig.sell) : 'â€”');
    set('k_stop', sig.stop != null ? fmtKR(sig.stop) : 'â€”');
    set('k_risk', sig.risk);
    set('k_say',  sig.pep);

    if (typeof ticker.signed_change_rate==='number'){
      const p = ticker.signed_change_rate*100;
      setHTML('k_pct', `<span class="${p>=0?'pos':'neg'}">${p.toFixed(2)}%</span>`);
    }
    const net = document.getElementById('k_net'); if(net) net.textContent='ì—°ê²°ë¨(ë¶„ì„PRO)';
  }catch(e){
    console.warn('íƒ€ì  í”„ë¡œ ë¶„ì„ ì‹¤íŒ¨:', e);
    const net = document.getElementById('k_net'); if(net) net.textContent='ë¶„ì„ ëŒ€ê¸°';
  }
}

/* ============ 4) ê¸°ì¡´ ì„ íƒ íë¦„ì— â€œí›„í‚¹â€ (UI/ê¸°ëŠ¥ ë³€ê²½ ì—†ìŒ) ============ */
(function(){
  if(typeof window.renderSelected==='function'){
    const _orig = window.renderSelected;
    window.renderSelected = function(tk, ...rest){
      const r = _orig.call(this, tk, ...rest);
      try{ analyzeSelectedPro(tk); }catch(_){}
      return r;
    };
  } else {
    // renderSelectedê°€ ì—†ëŠ” êµ¬ì¡°ë©´ ì „ì—­ì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥
    window.analyzeSelectedPro = analyzeSelectedPro;
  }
})();

/* ============ 5) ìë™ ì¬ë¶„ì„ íƒ€ì´ë¨¸ ============ */
setInterval(()=>{
  if (window.state && window.state.selected){
    analyzeSelectedPro(window.state.selected);
  }
}, ZCFG.refreshMs);
</script>
<!-- ===== END: íƒ€ì  í”„ë¡œ ì˜¤ë²„ë ˆì´ v6.3 ===== -->

</body>
</html>




