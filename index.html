<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3</title>
<style>
  :root{
    --bg:#0b1218; --panel:#0e1722; --line:#1f2a37; --txt:#e5e7eb; --sub:#9aa4b2;
    --up:#2dd4bf; --down:#fb7185; --accent:#60a5fa; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 ui-sans-serif,system-ui,AppleSDGothicNeo,"ë§‘ì€ ê³ ë”•",Segoe UI,Roboto}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{padding:3px 8px;border-radius:999px;background:#132033;color:#9fb7d5;font-weight:600;font-size:12px}
  .badge.online{background:#0d2b1c;color:#7be6b0}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px}
  .panel.hdr{padding:12px 14px}
  .clock{margin-left:auto;color:var(--sub)}
  .searchbar{display:flex;gap:8px;margin:12px 0}
  .searchbar input{flex:1;background:#0b131d;border:1px solid var(--line);color:var(--txt);
                   border-radius:10px;padding:12px 14px;outline:none}
  .btn{background:#0d2236;color:#b9d1ff;border:1px solid #213247;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .grid{display:grid;gap:10px}
  .card{padding:10px 12px}
  .pill{padding:2px 8px;border-radius:999px;font-weight:700}
  .pill.up{background:rgba(45,212,191,.1); color:var(--up);border:1px solid rgba(45,212,191,.25)}
  .pill.down{background:rgba(251,113,133,.1); color:var(--down);border:1px solid rgba(251,113,133,.25)}
  .warning{background:rgba(245,158,11,.12);color:#ffcc7a;border:1px solid rgba(245,158,11,.25)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:12px 10px;border-bottom:1px solid var(--line);white-space:nowrap}
  th{position:sticky;top:0;background:var(--panel);z-index:1}
  .tbl-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--line)}
  .num{text-align:right}
  .ko{color:var(--sub)}
  .msg{display:inline-flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.up{background:var(--up)} .dot.down{background:var(--down)}
  .zzac-wrap{position:relative;display:block}
  .zzac-list{position:absolute;top:100%;left:0;right:0;background:#0b131d;border:1px solid var(--line);
             border-radius:10px;overflow:auto;max-height:260px;z-index:20;display:none}
  .zzac-item{padding:10px 12px;display:flex;justify-content:space-between;cursor:pointer}
  .zzac-item:hover{background:#0f1823}
  .zzac-sym{font-weight:700}
  .zzac-ko{color:var(--sub)}
  .muted{color:var(--sub)}
  .section{padding:14px}
  .split{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.split{grid-template-columns:1fr 1fr}}
  .one-line{display:grid;grid-template-columns:120px repeat(7,1fr);gap:8px;align-items:center}
  .cell{padding:10px 12px;background:#0b131d;border:1px solid var(--line);border-radius:10px;text-align:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- í—¤ë” -->
  <div class="panel hdr row">
    <div class="row" style="gap:8px">
      <span class="badge">v6.3</span>
      <span id="net" class="badge">OFFLINE</span>
    </div>
    <div class="clock" id="clock">KST â€” --ì‹œ --ë¶„ --ì´ˆ</div>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="searchbar zzac-wrap">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸ / BTC / KRW-BTC / ì œë¡œì§€)" autocomplete="off" />
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
    <div class="zzac-list" id="acList"></div>
  </div>

  <!-- ì„ íƒ ì½”ì¸: í•œ ì¤„ í—¤ë” (í˜„ì¬ê°€, ë³€ë™ë¥ , ë§¤ìˆ˜, ë§¤ë„, ì†ì ˆ, ìœ„í—˜ë„, ì©”ì–´í•œë§ˆë””) -->
  <div class="panel section">
    <div class="one-line muted" style="margin-bottom:8px">
      <div class="cell">ì„ íƒëœ ì½”ì¸</div>
      <div class="cell">í˜„ì¬ê°€</div>
      <div class="cell">ë³€ë™ë¥ </div>
      <div class="cell">ë§¤ìˆ˜</div>
      <div class="cell">ë§¤ë„</div>
      <div class="cell">ì†ì ˆ</div>
      <div class="cell">ìœ„í—˜ë„</div>
      <div class="cell">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div class="one-line" id="selectedRow">
      <div class="cell">ì—†ìŒ â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
      <div class="cell">â€”</div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ -->
  <div class="split">

    <div class="panel section">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</span><span class="muted">(ì¡°ê±´: 24h ë³€ë™ë¥  ìƒìœ„)</span></div>
        <button class="btn" id="btnRefreshUp">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="tbl-wrap" id="wrapUp">
        <table>
          <thead>
          <tr>
            <th class="muted">#</th>
            <th>ì½”ì¸ëª…(í•œê¸€)</th>
            <th class="num">í˜„ì¬ê°€</th>
            <th class="num">ë³€ë™ë¥ </th>
            <th class="num">ë§¤ìˆ˜</th>
            <th class="num">ë§¤ë„</th>
            <th class="num">ì†ì ˆ</th>
            <th class="num">ìœ„í—˜ë„</th>
            <th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
          </thead>
          <tbody id="tblUp"></tbody>
        </table>
      </div>
    </div>

    <div class="panel section">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:8px"><span>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</span><span class="muted">(ì¡°ê±´: 24h ë³€ë™ë¥  í•˜ìœ„)</span></div>
        <button class="btn" id="btnRefreshDown">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="tbl-wrap" id="wrapDown">
        <table>
          <thead>
          <tr>
            <th class="muted">#</th>
            <th>ì½”ì¸ëª…(í•œê¸€)</th>
            <th class="num">í˜„ì¬ê°€</th>
            <th class="num">ë³€ë™ë¥ </th>
            <th class="num">ë§¤ìˆ˜</th>
            <th class="num">ë§¤ë„</th>
            <th class="num">ì†ì ˆ</th>
            <th class="num">ìœ„í—˜ë„</th>
            <th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
          </thead>
          <tbody id="tblDown"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/** ===============================
 *  Upbit proxy endpoint (Vercel)
 *  /api/upbit?path=/v1/market/all?isDetails=true
 *  /api/upbit?path=/v1/ticker?markets=KRW-BTC,KRW-ETH...
 *  =============================== */
const API = (p) => `/api/upbit?path=${encodeURIComponent(p)}`;

/** ---- ì „ì—­ ìƒíƒœ ---- */
const state = {
  online: false,
  markets: [],        // KRW-* only
  nameMap: {},        // { "BTC": "ë¹„íŠ¸ì½”ì¸", ... }
  tickers: [],        // ticker array
  selected: null,     // ì„ íƒí•œ ticker
};

const $ = (s)=>document.querySelector(s);
const clock = $('#clock');
const net   = $('#net');

/** ---- KST Clock & Online ---- */
function tickClock(){
  const now = new Date();
  // í•œêµ­ì‹œê°„ (=UTC+9)
  const kst = new Date(now.getTime() + (9 - now.getTimezoneOffset()/60)*3600*1000);
  const hh = String(kst.getUTCHours()).padStart(2,'0');
  const mm = String(kst.getUTCMinutes()).padStart(2,'0');
  const ss = String(kst.getUTCSeconds()).padStart(2,'0');
  clock.textContent = `KST â€” ${hh}ì‹œ ${mm}ë¶„ ${ss}ì´ˆ`;
  net.textContent = state.online ? 'ONLINE' : 'OFFLINE';
  net.classList.toggle('online', state.online);
}
setInterval(tickClock, 1000); tickClock();

/** ---- ìœ í‹¸ ---- */
const fmt = (n)=> (n==null || isNaN(n)) ? 'â€”' :
  n>=1000 ? n.toLocaleString('ko-KR') : (''+(+n).toFixed(2)).replace(/\.00$/,'');

const fmtRate = (r)=> {
  if (r==null || isNaN(r)) return 'â€”';
  const p = (r*100).toFixed(2) + '%';
  return r>=0 ? `<span class="pill up">${p}</span>` : `<span class="pill down">${p}</span>`;
};

// ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ì¶”ì •(ê°„ë‹¨)
function priceUnit(p){
  if      (p>=2_000_000) return 1000;
  else if (p>=1_000_000) return 500;
  else if (p>=500_000)   return 100;
  else if (p>=100_000)   return 50;
  else if (p>=10_000)    return 10;
  else if (p>=1000)      return 1;
  else if (p>=100)       return 0.1;
  else if (p>=10)        return 0.01;
  else if (p>=1)         return 0.001;
  else if (p>=0.1)       return 0.0001;
  else                   return 0.00001;
}

function msgFromRate(rate){
  if (rate>=0.08) return {txt:'ğŸš€ í­ë“± ëª¨ë“œ!', cls:''};
  if (rate>=0.05) return {txt:'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!', cls:''};
  if (rate<=-0.08) return {txt:'âš ï¸ ê¸‰ë½ ì£¼ì˜', cls:'warning'};
  return {txt:'ğŸ‘€ ê´€ë§', cls:'muted'};
}

function riskFromRate(rate){
  if(rate==null) return 'â€”';
  const lv = Math.min(3, Math.max(1, Math.ceil(Math.abs(rate*100)/3)));
  return `${lv}(ì£¼ì˜)`;
}

/** ---- ë§ˆì¼“ ë¡œë“œ ---- */
async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'), {cache:'no-store'});
  const arr = await r.json();
  const krw = arr.filter(m => m.market?.startsWith('KRW-'));
  state.markets = krw.map(m=>({ market:m.market, korean_name:m.korean_name }));
  state.nameMap = Object.fromEntries(krw.map(m=>[m.market.split('-')[1], m.korean_name]));
  // ë¹„íŠ¸ì½”ì¸ ê°€ë…ì„± ë³´ì •
  if (state.nameMap['BTC'] === undefined) state.nameMap['BTC']='ë¹„íŠ¸ì½”ì¸';
}

/** ---- í‹°ì»¤ ë°°ì¹˜ í´ë§ (429 íšŒí”¼) ---- */
async function loadTickers(){
  if (!state.markets.length) return;
  const batch = 30;
  const mkts = state.markets.map(m=>m.market);
  const chunks = [];
  for (let i=0;i<mkts.length;i+=batch) chunks.push(mkts.slice(i,i+batch));
  const out = [];
  for (const c of chunks){
    const url = API('/v1/ticker?markets='+c.join(','));
    const r = await fetch(url, {cache:'no-store'});
    const arr = await r.json();
    out.push(...arr);
    await new Promise(r=>setTimeout(r, 180)); // ì‚´ì§ í…€
  }
  state.tickers = out;
  state.online = true;
}

/** ---- ë Œë”: ì„ íƒì½”ì¸ í•œ ì¤„ ---- */
function renderSelected(tk){
  state.selected = tk;
  const row = $('#selectedRow');
  if(!tk){ row.innerHTML = `
    <div class="cell">ì—†ìŒ â€”</div><div class="cell">â€”</div><div class="cell">â€”</div>
    <div class="cell">â€”</div><div class="cell">â€”</div><div class="cell">â€”</div>
    <div class="cell">â€”</div><div class="cell">â€”</div>`; return;
  }
  const sym = tk.market.split('-')[1];
  const name = state.nameMap[sym]||sym;
  const price = tk.trade_price;
  const rate = tk.signed_change_rate; // upbit -1..+1
  const u = priceUnit(price);
  const buy = Math.max(0, price - 3*u);
  const sell= price + 3*u;
  const stop= Math.max(0, price - 8*u);
  const risk= riskFromRate(rate);
  const msg = msgFromRate(rate);

  row.innerHTML = `
    <div class="cell"><b>${name}</b> <span class="muted">(${tk.market})</span></div>
    <div class="cell">${fmt(price)}</div>
    <div class="cell">${fmtRate(rate)}</div>
    <div class="cell">${fmt(buy)}</div>
    <div class="cell">${fmt(sell)}</div>
    <div class="cell">${fmt(stop)}</div>
    <div class="cell">${risk}</div>
    <div class="cell ${msg.cls}">${msg.txt}</div>`;
}

/** ---- ë Œë”: ê¸‰ë“±/ê¸‰ë½ í…Œì´ë¸” ---- */
function renderTables(){
  const upB = $('#tblUp'), dnB = $('#tblDown');
  upB.innerHTML = ''; dnB.innerHTML = '';
  if (!state.tickers.length) return;

  // mapìœ¼ë¡œ ko ì´ë¦„ ë¶€ì—¬
  const enrich = t => {
    const sym = t.market.split('-')[1];
    t._ko = state.nameMap[sym] || sym;
    return t;
  };

  const arr = state.tickers.map(enrich);

  const ups = arr
    .filter(t=>t.signed_change_rate>0)
    .sort((a,b)=>b.signed_change_rate - a.signed_change_rate)
    .slice(0,10);

  const dns = arr
    .filter(t=>t.signed_change_rate<0)
    .sort((a,b)=>a.signed_change_rate - b.signed_change_rate)
    .slice(0,10);

  function rowHTML(t, i){
    const price = t.trade_price;
    const rate = t.signed_change_rate;
    const u = priceUnit(price);
    const buy = Math.max(0, price - 3*u);
    const sell= price + 3*u;
    const stop= Math.max(0, price - 8*u);
    const msg = msgFromRate(rate);
    const risk = riskFromRate(rate);

    return `<tr data-m="${t.market}">
      <td class="muted">${i+1}</td>
      <td><b>${t._ko}</b> <span class="ko">(${t.market})</span></td>
      <td class="num">${fmt(price)}</td>
      <td class="num">${fmtRate(rate)}</td>
      <td class="num">${fmt(buy)}</td>
      <td class="num">${fmt(sell)}</td>
      <td class="num">${fmt(stop)}</td>
      <td class="num"><span class="pill warning">${risk}</span></td>
      <td><span class="msg ${msg.cls}">${msg.txt}</span></td>
    </tr>`;
  }

  ups.forEach((t,i)=> upB.insertAdjacentHTML('beforeend', rowHTML(t,i)));
  dns.forEach((t,i)=> dnB.insertAdjacentHTML('beforeend', rowHTML(t,i)));

  // í–‰ í´ë¦­ = ì„ íƒì½”ì¸ ê°±ì‹ 
  upB.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if(tk) renderSelected(tk);
    });
  });
  dnB.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click',()=>{
      const m = tr.getAttribute('data-m');
      const tk = state.tickers.find(x=>x.market===m);
      if(tk) renderSelected(tk);
    });
  });
}

/** ---- ìë™ì™„ì„± + ê²€ìƒ‰ ---- */
(function searchModule(){
  const q = $('#q'), btn = $('#btnSearch'), reset = $('#btnReset');
  const ac = $('#acList');

  let idx = [];  // {market,symbol,ko}

  function buildIndex(){
    idx = state.markets.map(m=>{
      const sym = m.market.split('-')[1];
      return {market:m.market, symbol:sym, ko: state.nameMap[sym]||m.korean_name||sym};
    });
  }

  function showList(v){
    ac.innerHTML = '';
    const Q = (v||'').trim().toUpperCase();
    if(!Q){ ac.style.display='none'; return; }
    const list = idx.filter(x =>
      x.market.includes(Q) || x.symbol.includes(Q) || (x.ko||'').toUpperCase().includes(Q)
    ).slice(0,20);
    if(!list.length){ ac.style.display='none'; return; }
    list.forEach(it=>{
      const d = document.createElement('div');
      d.className='zzac-item';
      d.innerHTML = `<div class="zzac-sym">${it.symbol}</div><div class="zzac-ko">${it.ko}</div>`;
      d.onclick = () => { ac.style.display='none'; choose(it.market); };
      ac.appendChild(d);
    });
    ac.style.display='block';
  }

  function choose(market){
    const tk = state.tickers.find(t=>t.market===market);
    if(!tk){ alert('ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
    renderSelected(tk);
  }

  q.addEventListener('input', ()=>showList(q.value));
  q.addEventListener('focus', ()=>showList(q.value));
  q.addEventListener('blur', ()=>setTimeout(()=>ac.style.display='none',120));

  q.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const v = (q.value||'').trim().toUpperCase();
      if(!v) return;
      const hit = idx.find(x=> x.market===v || x.symbol===v ||
        (x.ko||'').toUpperCase().includes(v));
      if(hit) choose(hit.market);
      else alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
  });

  btn.addEventListener('click', ()=>{
    const v = (q.value||'').trim().toUpperCase();
    if(!v) return;
    const hit = idx.find(x=> x.market===v || x.symbol===v ||
      (x.ko||'').toUpperCase().includes(v));
    if(hit) choose(hit.market);
    else alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
  });

  reset.addEventListener('click', ()=>{
    q.value=''; ac.style.display='none'; renderSelected(null);
  });

  // ì¸ë±ìŠ¤ ìœ ì§€ ì—…ë°ì´íŠ¸
  setInterval(()=>{ if(state.markets.length) buildIndex(); }, 1000);
})();

/** ---- í™”ë©´ í”ë“¤ë¦¼ ë°©ì§€: ìŠ¤í¬ë¡¤ ë³´ì¡´ ---- */
const preserveScroll = (fn)=>{
  try{
    const up=$('#wrapUp'), dn=$('#wrapDown');
    const ut=up.scrollTop, dt=dn.scrollTop;
    fn();
    up.scrollTop=ut; dn.scrollTop=dt;
  }catch(e){ fn(); }
};

/** ---- ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ---- */
async function loop(){
  try{
    if(!state.markets.length) await loadMarkets();
    await loadTickers();
    preserveScroll(renderTables);
    if(state.selected){
      const cur = state.tickers.find(t=>t.market===state.selected.market);
      if(cur) renderSelected(cur);
    }
  }catch(e){
    console.error(e);
    state.online=false;
  }finally{
    setTimeout(loop, 4000); // 4ì´ˆ ì£¼ê¸°
  }
}
loop();

$('#btnRefreshUp').onclick = ()=>preserveScroll(renderTables);
$('#btnRefreshDown').onclick = ()=>preserveScroll(renderTables);

</script>
</body>
</html>
