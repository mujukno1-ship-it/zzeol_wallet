<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.0 (ë³µì› ì•ˆì •íŒ)</title>
<style>
  :root{
    --bg:#0f1318; --panel:#141a21; --muted:#9aa4af; --txt:#e8eef5; --accent:#3aa3ff;
    --up:#20c997; --down:#ff6b6b; --warn:#ffb020; --chip:#1b2330; --line:#1b2330;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 Pretendard,Apple SD Gothic Neo,Segoe UI,Roboto,sans-serif}
  header{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:5}
  .badge{padding:2px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-weight:600}
  .ok{color:#9cff77}
  .clock{margin-left:auto;color:var(--muted)}
  .wrap{max-width:1140px;margin:0 auto;padding:16px}
  .searchbar{display:flex;gap:8px}
  .searchbar input{flex:1;background:var(--panel);border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:12px 14px}
  .btn{background:var(--chip);border:1px solid var(--line);color:var(--txt);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .row{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
  .kpis{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px;text-align:center}
  .kpis h6{margin:0 0 6px;font-size:12px;color:var(--muted)}
  .kpis .v{font-weight:700}
  .up{color:var(--up)} .down{color:var(--down)}
  section{margin-top:22px}
  h2{margin:10px 0 8px;font-size:16px}
  .table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:right}
  .table th:first-child,.table td:first-child{text-align:center;width:40px}
  .table th:nth-child(2),.table td:nth-child(2){text-align:left}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:var(--muted);font-weight:600}
  .hint{color:var(--muted);font-size:12px}
  .tag{padding:2px 8px;border-radius:999px;background:#0f2130}
  .tag.up{background:#0e2a22;color:#75f0c8}
  .tag.down{background:#2a1414;color:#ff9b9b}
  .tag.warn{background:#2a1f0e;color:#ffd684}
  .right{float:right}
  .notice{margin-top:8px;color:var(--muted);font-size:12px}
  @media (max-width:920px){
    .row{grid-template-columns:repeat(2,1fr)}
    .table{font-size:13px}
    .table th:nth-child(6),.table td:nth-child(6){display:none} /* ìœ„í—˜ë„ ì¹¼ëŸ¼ ëª¨ë°”ì¼ì—ì„œ ì ‘ê¸° */
  }
</style>
</head>
<body>
<header>
  <span class="badge">ì©”ì–´ì§€ê°‘ v7.0</span>
  <span class="badge ok">ONLINE</span>
  <span class="badge">KST â€” <span id="kst">--:--:--</span></span>
  <span class="clock" id="clockMsg">ì‹¤ì‹œê°„ ê¸‰ë“±í˜•(REST í´ë§ ì•ˆì •í™”)</span>
</header>

<div class="wrap">
  <!-- ê²€ìƒ‰ -->
  <div class="searchbar">
    <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒí•œ ì½”ì¸ ìš”ì•½ -->
  <div class="row" id="summaryRow" style="display:none">
    <div class="kpis"><h6>í˜„ì¬ê°€</h6><div class="v" id="s_price">-</div></div>
    <div class="kpis"><h6>ë³€ë™ë¥ </h6><div class="v" id="s_change">-</div></div>
    <div class="kpis"><h6>ë§¤ìˆ˜</h6><div class="v" id="s_bid">-</div></div>
    <div class="kpis"><h6>ë§¤ë„</h6><div class="v" id="s_ask">-</div></div>
    <div class="kpis"><h6>ì†ì ˆ</h6><div class="v" id="s_cut">-</div></div>
    <div class="kpis"><h6>ìœ„í—˜ë„</h6><div class="v" id="s_risk">-</div></div>
    <div class="kpis"><h6>ì©”ì–´í•œë§ˆë””</h6><div class="v" id="s_ment">-</div></div>
  </div>
  <div id="selName" class="notice"></div>

  <!-- ê¸‰ë“± -->
  <section>
    <h2>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <span class="hint">(ì¡°ê±´: 24h ë³€ë™ë¥  ìƒìœ„)</span></h2>
    <table class="table" id="tblUp">
      <thead>
        <tr>
          <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ê¸‰ë½ -->
  <section>
    <h2>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 <span class="hint">(ì¡°ê±´: 24h ë³€ë™ë¥  í•˜ìœ„)</span></h2>
    <table class="table" id="tblDown">
      <thead>
        <tr>
          <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div class="notice">
    â€» ë³¸ ì„œë¹„ìŠ¤ëŠ” íˆ¬ì ì°¸ê³ ìš©ìœ¼ë¡œ, ëª¨ë“  ì±…ì„ì€ ì´ìš©ì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤. ë°ì´í„°: Upbit Public API / 3~5ì´ˆ í´ë§ ì•ˆì •í™”.
  </div>
</div>

<script>
const api = (p)=>fetch('/api/upbit?path='+encodeURIComponent(p),{cache:'no-store'}).then(r=>r.json());
const KRW_ONLY = true;          // ì›í™”ë§ˆì¼“ë§Œ
const POLL_MS   = 4000;          // 4ì´ˆ í´ë§
let MARKETS = [];                // [{market, korean_name, english_name}]
let MAP = {};                    // market -> {korean_name, english_name}
let lastSummaryMarket = null;
let pollTimer = null;

// ì‹œê³„
setInterval(()=>{
  const d = new Date();
  document.getElementById('kst').textContent =
    new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Seoul'}).format(d);
}, 500);

// ë§ˆì¼“ ëª©ë¡ ë¡œë“œ
async function loadMarkets(){
  const list = await api('/v1/market/all?isDetails=true');
  MARKETS = (KRW_ONLY ? list.filter(x=>x.market.startsWith('KRW-')) : list);
  MARKETS.forEach(m=>MAP[m.market]=m);
}

function fmt(n){ if(n==null||isNaN(n)) return '-'; return Number(n).toLocaleString('ko-KR'); }
function pct(v){
  if(v==null||isNaN(v)) return '-';
  const p = (Number(v)*100).toFixed(2)+'%';
  return (v>=0?`<span class="up">${p}</span>`:`<span class="down">${p}</span>`);
}

function riskTag(spread, vol){
  // ìŠ¤í”„ë ˆë“œ(ë§¤ë„-ë§¤ìˆ˜ ë¹„ìœ¨) + 24h ë³€ë™ë¥  ì ˆëŒ€ê°’ ê¸°ì¤€
  const sp = spread;   // %
  const abv = Math.abs(vol)*100;
  if (abv>12 || sp>0.45) return `<span class="tag down">3(ì£¼ì˜)</span>`;
  if (abv>6  || sp>0.25) return `<span class="tag warn">2(ë³´í†µ)</span>`;
  return `<span class="tag up">1(ì•ˆì •)</span>`;
}
function zMsg(rate){
  const r=rate*100;
  if (r>20) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
  if (r>8)  return 'ğŸ“ˆ ìƒìŠ¹ì¤‘';
  if (r<-12) return 'ğŸ”» ë‚™í­ê²½ê³„';
  if (r<-6)  return 'âš ï¸ í•˜ë½ì¤‘';
  return 'ğŸ‘€ ê´€ë§';
}

async function pollBoards(){
  // â‘  KRW ì „ì²´ í‹°ì»¤
  const codes = MARKETS.map(m=>m.market).join(',');
  const tks = await api('/v1/ticker?markets='+codes);
  // â‘¡ ì¼ë¶€ ë§ˆì¼“ì˜ í˜¸ê°€(ë§¤ìˆ˜/ë§¤ë„) â€” ìƒìœ„ 30ê°œë§Œ ìš”ì²­(íŠ¸ë˜í”½ ì ˆê°)
  const topByAbs = [...tks].sort((a,b)=>Math.abs(b.signed_change_rate)-Math.abs(a.signed_change_rate)).slice(0,30);
  const obCodes = topByAbs.map(x=>x.market).join(',');
  const obs = obCodes ? await api('/v1/orderbook?markets='+obCodes) : [];

  const best = {};
  obs.forEach(x=>{
    const unit = x.orderbook_units?.[0];
    if (!unit) return;
    best[x.market] = { bid: unit.bid_price, ask: unit.ask_price };
  });

  // ê¸‰ë“±/ê¸‰ë½ ë¶„ë¦¬
  const ups   = [...tks].sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const downs = [...tks].sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);

  renderBoard('tblUp', ups, best);
  renderBoard('tblDown', downs, best);

  // ì„ íƒ ì½”ì¸ ìš”ì•½ ê°±ì‹ 
  if (lastSummaryMarket){
    const one = tks.find(x=>x.market===lastSummaryMarket);
    const ob  = best[lastSummaryMarket];
    if (one) renderSummary(one, ob);
  }
}

function renderBoard(tblId, list, best){
  const tb = document.querySelector('#'+tblId+' tbody');
  tb.innerHTML = '';
  list.forEach((x,i)=>{
    const m = MAP[x.market];
    const prices = best[x.market] || {};
    const bid = prices.bid ?? x.trade_price;   // ì—†ìœ¼ë©´ í˜„ì¬ê°€
    const ask = prices.ask ?? x.trade_price;
    const spread = (ask-bid)/x.trade_price;    // ë¹„ìœ¨
    const cut = Math.max(0, x.trade_price*0.97); // ë‹¨ìˆœ ì†ì ˆ 3%

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td style="text-align:left;cursor:pointer" data-market="${x.market}">
        ${m?.korean_name || x.market} <span class="hint">(${x.market})</span>
      </td>
      <td>${fmt(x.trade_price)}</td>
      <td>${pct(x.signed_change_rate)}</td>
      <td>${fmt(bid)}</td>
      <td>${fmt(ask)}</td>
      <td>${fmt(cut)}</td>
      <td>${riskTag(spread, x.signed_change_rate)}</td>
      <td class="hint">${zMsg(x.signed_change_rate)}</td>
    `;
    // í´ë¦­ ì‹œ ìš”ì•½ ìƒë‹¨ ê³ ì •
    tr.querySelector('[data-market]').addEventListener('click', ()=>{
      lastSummaryMarket = x.market;
      renderSummary(x, best[x.market]);
      document.getElementById('summaryRow').style.display='grid';
      const name = `${m?.korean_name || x.market} (${x.market})`;
      document.getElementById('selName').innerHTML = `ì„ íƒëœ ì½”ì¸: <b>${name}</b>`;
      window.scrollTo({top:0,behavior:'smooth'});
    });
    tb.appendChild(tr);
  });
}

function renderSummary(x, ob){
  const bid = ob?.bid ?? x.trade_price;
  const ask = ob?.ask ?? x.trade_price;
  const cut = Math.max(0, x.trade_price*0.97);
  const spread = (ask-bid)/x.trade_price;

  document.getElementById('s_price').innerHTML  = fmt(x.trade_price);
  document.getElementById('s_change').innerHTML = pct(x.signed_change_rate);
  document.getElementById('s_bid').innerHTML    = fmt(bid);
  document.getElementById('s_ask').innerHTML    = fmt(ask);
  document.getElementById('s_cut').innerHTML    = fmt(cut);
  document.getElementById('s_risk').innerHTML   = riskTag(spread, x.signed_change_rate);
  document.getElementById('s_ment').textContent = zMsg(x.signed_change_rate);
}

// ê²€ìƒ‰
function norm(s){return s.replace(/\s+/g,'').toLowerCase();}
function findMarket(q){
  const s = norm(q);
  // market code
  let hit = MARKETS.find(m=>norm(m.market)===s);
  if (hit) return hit.market;
  // KRW-ETH ì²˜ëŸ¼ ì• ìƒëµ ì…ë ¥ ì‹œ
  hit = MARKETS.find(m=>norm(m.market.split('-')[1])===s);
  if (hit) return hit.market;
  // í•œê¸€ëª…
  hit = MARKETS.find(m=>norm(m.korean_name).includes(s));
  if (hit) return hit.market;
  // ì˜ë¬¸ëª…
  hit = MARKETS.find(m=>norm(m.english_name).includes(s));
  if (hit) return hit.market;
  return null;
}

async function doSearch(){
  const q = document.getElementById('q').value.trim();
  const code = findMarket(q);
  if (!code){
    alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    return;
  }
  // í•´ë‹¹ í‹°ì»¤ + í˜¸ê°€ ì·¨ë“ í›„ ìš”ì•½
  const [t] = await api('/v1/ticker?markets='+code);
  const [o] = await api('/v1/orderbook?markets='+code);
  lastSummaryMarket = code;
  renderSummary(t, o?.orderbook_units?.[0] ? {bid:o.orderbook_units[0].bid_price, ask:o.orderbook_units[0].ask_price} : null);
  document.getElementById('summaryRow').style.display='grid';
  const m = MAP[code];
  document.getElementById('selName').innerHTML = `ì„ íƒëœ ì½”ì¸: <b>${m?.korean_name || code} (${code})</b>`;
  window.scrollTo({top:0,behavior:'smooth'});
}

document.getElementById('btnSearch').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  lastSummaryMarket = null;
  document.getElementById('summaryRow').style.display='none';
  document.getElementById('selName').textContent='';
  document.getElementById('q').value='';
});

// ì‹œì‘
(async function init(){
  await loadMarkets();
  await pollBoards();
  clearInterval(pollTimer);
  pollTimer = setInterval(pollBoards, POLL_MS);
})();
</script>
</body>
</html>
