<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3</title>
<style>
  :root{
    --bg:#0f141a;--card:#141b23;--text:#e6edf3;--muted:#97a3af;--green:#14cc8a;--red:#ff5c62;--amber:#fbbf24;--blue:#60a5fa;
    --chip:#1f2937;--chip-b:#263241;--accent:#2b3340;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .badge{font-size:12px;color:#b6c2cf;background:#1c2330;border:1px solid #273142;padding:2px 8px;border-radius:999px}
  .pill{padding:6px 10px;background:#1a2330;border:1px solid #2a3547;border-radius:10px;color:var(--text)}
  .pill input{all:unset;color:inherit}
  .btn{border:1px solid #2c394c;background:#17202b;color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
  .btn:hover{background:#1d2836}
  .box{background:var(--card);border:1px solid #253246;border-radius:12px;padding:12px;margin-top:10px}
  .box-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .box-title{font-weight:700}
  .grid{display:grid;grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1.1fr;gap:6px;padding:10px;border-top:1px dashed #283246}
  .grid.head{color:#9fb0c3;background:#16202a;border-top:none;border-radius:8px}
  .grid .c{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;color:#b9c6d6}
  .muted{color:var(--muted)}
  .green{color:var(--green)} .red{color:var(--red)} .amber{color:var(--amber)}
  .hint{font-size:12px;color:#8aa0b2}
  .right{display:flex;gap:6px;align-items:center}
  .sticky{position:sticky;top:0;z-index:10;background:var(--bg);padding-top:6px}
  a.link{color:#84c5ff;text-decoration:none}
  .w120{min-width:120px}
  .center{text-align:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- ìƒë‹¨ ë°” -->
  <div class="topbar">
    <span class="badge">v6.3</span>
    <span class="badge" id="net">ONLINE</span>
    <span class="badge" id="clock">KST â€”</span>
  </div>

  <!-- ê²€ìƒ‰ / ì»¨íŠ¸ë¡¤ -->
  <div class="row sticky">
    <div class="pill" style="flex:1">
      <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸ / ë¹„íŠ¸ì½”ì¸ìºì‹œ / ì´ë”ë¦¬ì›€ / ì´ë”ë¦¬ì›€í´ë˜ì‹ / KRW-BTC â€¦)" />
    </div>
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒëœ ì½”ì¸ ìƒíƒœ -->
  <div class="box" id="selectedBox">
    <div class="box-header">
      <div class="box-title">ì„ íƒëœ ì½”ì¸: <span id="selName" class="muted">ì—†ìŒ</span></div>
      <div class="right">
        <label class="hint"><input type="checkbox" id="chkMomentum" /> ìƒìŠ¹ íƒ„ë ¥</label>
        <button class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div class="grid head">
      <div class="c">í˜„ì¬ê°€</div><div class="c">ë§¤ìˆ˜</div><div class="c">ë§¤ë„</div>
      <div class="c">ì†ì ˆ</div><div class="c">ë³€ë™ë¥ </div><div class="c">ìœ„í—˜ë„</div><div class="c">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div class="grid" id="selectedGrid"><div class="c muted">â€”</div><div class="c muted">â€”</div><div class="c muted">â€”</div><div class="c muted">â€”</div><div class="c muted">â€”</div><div class="c muted">â€”</div><div class="c muted">â€”</div></div>
  </div>

  <!-- ê¸‰ë“±ì½”ì¸ -->
  <div class="box">
    <div class="box-header">
      <div class="box-title">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</div>
      <div class="right hint">ì‹¤ì‹œê°„ ìë™ ì •ë ¬ (ì¡°ê±´ í‘œì‹œëŠ” ì œê±°ë¨)</div>
    </div>
    <div class="grid head">
      <div class="c">#</div><div class="c">ì½”ì¸ëª…(í•œê¸€)</div><div class="c">í˜„ì¬ê°€</div>
      <div class="c">ë³€ë™ë¥ </div><div class="c">ë§¤ìˆ˜</div><div class="c">ë§¤ë„</div>
      <div class="c">ì†ì ˆ</div><div class="c">ìœ„í—˜ë„</div><div class="c">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div id="upList"></div>
  </div>

  <!-- ê¸‰ë½ì½”ì¸ -->
  <div class="box">
    <div class="box-header">
      <div class="box-title">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</div>
      <div class="right hint">ê¸‰ë“±ê³¼ ê°™ì€ í¬ë§·ìœ¼ë¡œ í‘œê¸°</div>
    </div>
    <div class="grid head">
      <div class="c">#</div><div class="c">ì½”ì¸ëª…(í•œê¸€)</div><div class="c">í˜„ì¬ê°€</div>
      <div class="c">ë³€ë™ë¥ </div><div class="c">ë§¤ìˆ˜</div><div class="c">ë§¤ë„</div>
      <div class="c">ì†ì ˆ</div><div class="c">ìœ„í—˜ë„</div><div class="c">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div id="downList"></div>
  </div>

</div>

<script>
/* ========= ìœ í‹¸ ========= */
const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => [...p.querySelectorAll(s)];
const fmt = n => (n==null||isNaN(n)) ? 'â€”' : n.toLocaleString('ko-KR');
const pct = v => (v>0?`<span class="green">${(v*100).toFixed(2)}%</span>`:
                  v<0?`<span class="red">${(v*100).toFixed(2)}%</span>`:`0.00%`);

const upbit = (p) =>
  fetch(`/api/upbit?path=${encodeURIComponent(p)}`, { cache:'no-store' })
  .then(r => { if (!r.ok) throw new Error(`Upbit ${r.status}`); return r.json(); });

const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ========= ì‹œê³„/ë„¤íŠ¸ì›Œí¬ ========= */
function tickClock(){
  const kst = new Date();
  $('#clock').textContent = `KST â€” ${kst.getHours()}ì‹œ ${kst.getMinutes()}ë¶„ ${kst.getSeconds()}ì´ˆ`;
}
setInterval(tickClock, 1000); tickClock();
window.addEventListener('online', ()=>$('#net').textContent='ONLINE');
window.addEventListener('offline', ()=>$('#net').textContent='OFFLINE');

/* ========= ì „ì—­ ìƒíƒœ ========= */
let MARKETS = [];        // [{market, korean_name, english_name}]
let KRW = [];            // KRW-* ë§Œ
let TICKERS = new Map(); // market -> ticker
let LAST_SELECTED = null;
let pollingTimer = null;

/* ========= ë°ì´í„° ë¡œë“œ ========= */
async function loadMarkets(){
  const arr = await upbit('/v1/market/all?isDetails=true');
  MARKETS = arr;
  KRW = arr.filter(m => m.market.startsWith('KRW-'));
}

async function loadTickers(markets){
  const SIZE = 90; // ì—…ë¹„íŠ¸ URL ê¸¸ì´ ì œí•œ ëŒ€ë¹„
  for (let i=0;i<markets.length;i+=SIZE){
    const slice = markets.slice(i,i+SIZE).map(m=>m.market||m);
    const tick = await upbit('/v1/ticker?markets='+slice.join(','));
    tick.forEach(t => TICKERS.set(t.market, t));
    await sleep(120);
  }
}

/* ========= íƒ€ì  ê³„ì‚° =========
   - ë§¤ìˆ˜/ë§¤ë„: í˜„ì¬ê°€ Â± ìŠ¤í”„ë ˆë“œ(ê°€ìƒ 0.2%)
   - ì†ì ˆ: ì „ì¼ì¢…ê°€ ëŒ€ë¹„ -3% (ë˜ëŠ” ë³€ë™ë¥  í•˜ë½ì´ë©´ ë” íƒ€ì´íŠ¸)
   - ìœ„í—˜ë„: (ê³ ê°€-ì €ê°€)/í˜„ì¬ê°€ (ìµœê·¼ 24h ë³€ë™ í­ ì—†ìœ¼ë©´ ë³€ë™ë¥  ì ˆëŒ€ê°’ ì‚¬ìš©)
   - ì©”ì–´í•œë§ˆë””: ë³€ë™/ëª¨ë©˜í…€/ìœ„í—˜ë„ ê¸°ë°˜ ê°„ë‹¨ ë©˜ì…˜
*/
function calcPoints(t){
  const price = t.trade_price;
  const spread = Math.max(0.002*price, 1); // 0.2% ë˜ëŠ” ìµœì†Œ 1ì›
  const bid = price - spread;
  const ask = price + spread;
  const change = t.signed_change_rate || 0;
  const stop = Math.max(1, Math.round(price * (change<0 ? 0.965 : 0.97))); // -3~3.5%
  const risk = Math.min(0.5, Math.abs(change) + (t.high_price&&t.low_price ? (t.high_price - t.low_price)/price : 0));
  let msg = 'ê´€ë§';
  if (change > 0.08 && risk < 0.12) msg = 'ğŸš€ í­ë“± ëª¨ë“œ!';
  else if (change > 0.03) msg = 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  else if (change < -0.06) msg = 'ğŸ§¯ ë‚™í­ê²½ê³„';
  else if (risk > 0.25) msg = 'âš ï¸ ë³€ë™ ì£¼ì˜';
  return {
    buy: Math.round(bid),
    sell: Math.round(ask),
    stop,
    risk,
    msg
  };
}

/* ========= ë Œë” ========= */
function marketName(market){
  const m = MARKETS.find(x => x.market === market);
  return m ? m.korean_name : market;
}

function rowHTML(idx, t){
  const p = calcPoints(t);
  return `
  <div class="grid">
    <div class="c muted">${idx}</div>
    <div class="c"><a class="link" href="javascript:void(0)" data-market="${t.market}">${marketName(t.market)}</a></div>
    <div class="c">${fmt(t.trade_price)}</div>
    <div class="c">${pct(t.signed_change_rate)}</div>
    <div class="c">${fmt(p.buy)}</div>
    <div class="c">${fmt(p.sell)}</div>
    <div class="c">${fmt(p.stop)}</div>
    <div class="c">${(p.risk>0.25?'<span class="amber">ë†’ìŒ</span>':p.risk>0.12?'<span class="muted">ë³´í†µ</span>':'<span class="green">ë‚®ìŒ</span>')}</div>
    <div class="c">${p.msg}</div>
  </div>`;
}

function renderLists(){
  // ë°°ì—´ë¡œ ë³€í™˜
  const arr = KRW.map(m => TICKERS.get(m.market)).filter(Boolean);

  // ê¸‰ë“±/ê¸‰ë½ ì •ë ¬
  const ups = [...arr].sort((a,b)=> (b.signed_change_rate||0)-(a.signed_change_rate||0)).slice(0,10);
  const downs = [...arr].sort((a,b)=> (a.signed_change_rate||0)-(b.signed_change_rate||0)).slice(0,10);

  $('#upList').innerHTML = ups.map((t,i)=>rowHTML(i+1,t)).join('');
  $('#downList').innerHTML = downs.map((t,i)=>rowHTML(i+1,t)).join('');

  // í´ë¦­ ì„ íƒ
  $$('#upList a.link, #downList a.link').forEach(a=>{
    a.onclick = ()=> selectMarket(a.dataset.market);
  });
}

function renderSelected(){
  const m = LAST_SELECTED;
  if (!m){ $('#selName').textContent = 'ì—†ìŒ'; return; }

  $('#selName').textContent = `${marketName(m)} (${m})`;
  const t = TICKERS.get(m);
  if (!t){
    $('#selectedGrid').innerHTML = '<div class="c muted">â€”</div>'.repeat(7);
    return;
  }
  const p = calcPoints(t);
  $('#selectedGrid').innerHTML = `
    <div class="c">${fmt(t.trade_price)}</div>
    <div class="c">${fmt(p.buy)}</div>
    <div class="c">${fmt(p.sell)}</div>
    <div class="c">${fmt(p.stop)}</div>
    <div class="c">${pct(t.signed_change_rate)}</div>
    <div class="c">${(p.risk>0.25?'<span class="amber">ë†’ìŒ</span>':p.risk>0.12?'<span class="muted">ë³´í†µ</span>':'<span class="green">ë‚®ìŒ</span>')}</div>
    <div class="c">${p.msg}</div>
  `;
}

/* ========= ì„ íƒ/ê²€ìƒ‰ ========= */
const saveState = () => localStorage.setItem('zzeol_state', JSON.stringify({
  last: LAST_SELECTED, mom: $('#chkMomentum').checked
}));
const loadState = () => {
  try{
    const s = JSON.parse(localStorage.getItem('zzeol_state')||'{}');
    LAST_SELECTED = s.last || null;
    $('#chkMomentum').checked = !!s.mom;
  }catch{}
};

function findMarketByQuery(q){
  if (!q) return null;
  const Q = q.trim().toUpperCase();

  // ë§ˆì¼“ì½”ë“œ ì§ì ‘ ì…ë ¥
  let m = MARKETS.find(x => x.market.toUpperCase() === Q);
  if (m) return m.market;

  // í•œê¸€ëª… ì™„ì „/ë¶€ë¶„
  m = MARKETS.find(x => x.korean_name.replace(/\s/g,'').includes(q.replace(/\s/g,'')));
  if (m) return m.market;

  // ëŒ€í‘œ í† í° (ë¹„íŠ¸ì½”ì¸/ì´ë”ë¦¬ì›€ ì •í™•íˆ ë§¤ì¹­ë˜ë„ë¡ ìš°ì„ ìˆœìœ„)
  const aliases = {
    'ë¹„íŠ¸ì½”ì¸':'KRW-BTC','BTC':'KRW-BTC',
    'ì´ë”ë¦¬ì›€':'KRW-ETH','ETH':'KRW-ETH',
    'ì´ë”ë¦¬ì›€í´ë˜ì‹':'KRW-ETC','ETC':'KRW-ETC',
    'ë¹„íŠ¸ì½”ì¸ìºì‹œ':'KRW-BCH','BCH':'KRW-BCH'
  };
  if (aliases[Q]) return aliases[Q];
  const kq = q.replace(/\s/g,'');
  for (const k in aliases){
    if (k.includes(kq)) return aliases[k];
  }
  return null;
}

function selectMarket(market){
  LAST_SELECTED = market;
  renderSelected();
  saveState();
}

let searchTimer=null;
function doSearch(){
  const q = $('#q').value;
  const market = findMarketByQuery(q);
  if (market){
    selectMarket(market);
  }else{
    alert('ì¼ì¹˜í•˜ëŠ” ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  }
}

$('#btnSearch').onclick = doSearch;
$('#q').addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(doSearch, 600); // ë””ë°”ìš´ìŠ¤
});
$('#btnReset').onclick = ()=>{
  $('#q').value='';
  LAST_SELECTED=null; renderSelected(); saveState();
};

/* ========= ê°±ì‹  ========= */
async function refreshAll(showToast=true){
  try{
    await loadTickers(KRW);
    renderLists();
    renderSelected();
    if (showToast) console.log('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  }catch(e){
    console.error(e);
  }
}
$('#btnRefresh').onclick = ()=>refreshAll(true);

/* ========= ì´ˆê¸° êµ¬ë™ ========= */
(async function init(){
  loadState();
  await loadMarkets();
  await refreshAll(false);

  // ë§ˆì§€ë§‰ ì„ íƒ ë³µì›
  if (LAST_SELECTED) renderSelected();

  // í´ë§
  if (pollingTimer) clearInterval(pollingTimer);
  pollingTimer = setInterval(refreshAll, 60000);
})();
</script>
<script>
// =========================
// 1) ê²€ìƒ‰ì–´ â†’ ë§ˆì¼“ì½”ë“œ í•´ì„ê¸°
// =========================

// ìì£¼ ì“°ëŠ” ë³„ì¹­/ë™ì˜ì–´ ë§¤í•‘ (ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€ ê°€ëŠ¥)
const COIN_ALIASES = {
  // í•œê¸€ëª…
  'ë¹„íŠ¸ì½”ì¸': 'KRW-BTC',
  'ì´ë”ë¦¬ì›€': 'KRW-ETH',
  'ì´ë”ë¦¬ì›€í´ë˜ì‹': 'KRW-ETC',
  'ë¦¬í”Œ': 'KRW-XRP',
  'ë„ì§€': 'KRW-DOGE',
  'ë„ì§€ì½”ì¸': 'KRW-DOGE',
  'ì‹œë°”ì´ëˆ„': 'KRW-SHIB',
  'í´ë¦¬ê³¤': 'KRW-MATIC',
  'ì¹´ë¥´ë‹¤ë…¸': 'KRW-ADA',
  'ì†”ë¼ë‚˜': 'KRW-SOL',

  // ì˜ë¬¸ ì‹¬ë³¼
  'btc': 'KRW-BTC',
  'eth': 'KRW-ETH',
  'etc': 'KRW-ETC',
  'xrp': 'KRW-XRP',
  'doge': 'KRW-DOGE',
  'shib': 'KRW-SHIB',
  'matic': 'KRW-MATIC',
  'ada': 'KRW-ADA',
  'sol': 'KRW-SOL',

  // ë§ˆì¼“ì½”ë“œ ì¶•ì•½í˜• (í•˜ì´í”ˆ ì—†ëŠ” ì…ë ¥ë„ í—ˆìš©)
  'krwbtc': 'KRW-BTC',
  'krweth': 'KRW-ETH',
  'krwetc': 'KRW-ETC',
  'krwxrp': 'KRW-XRP',
  'krwdoge': 'KRW-DOGE',
  'krwshib': 'KRW-SHIB',
  'krwmatic': 'KRW-MATIC',
  'krwada': 'KRW-ADA',
  'krwsol': 'KRW-SOL',
};

// ì—…ë¹„íŠ¸ ë§ˆì¼“ ëª©ë¡(ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ë¶ˆëŸ¬ì˜¤ê³  ìˆë‹¤ë©´ ê·¸ ë°°ì—´ì„ ì‚¬ìš©í•˜ì„¸ìš”)
let ALL_MARKETS = []; // ì˜ˆ: [{market:'KRW-ETH', korean_name:'ì´ë”ë¦¬ì›€', english_name:'Ethereum'}, ...]

// ê²€ìƒ‰ì–´ ì „ì²˜ë¦¬
function _norm(s) {
  return (s || '').toString().trim().toLowerCase().replace(/\s+/g, '');
}

// ê²€ìƒ‰ì–´ â†’ ë§ˆì¼“ì½”ë“œ í•´ì„
function resolveMarket(input) {
  const q = _norm(input);
  if (!q) return null;

  // 0) ë³„ì¹­ í…Œì´ë¸” ìš°ì„ 
  if (COIN_ALIASES[q]) return COIN_ALIASES[q];

  // 1) â€œKRW-ETHâ€ / â€œBTC-ETHâ€ ê°™ì€ ì •ì‹ ë§ˆì¼“ì½”ë“œ ê·¸ëŒ€ë¡œ ì…ë ¥í•œ ê²½ìš°
  if (/^[a-z]{3,4}-[a-z0-9]{2,10}$/i.test(input)) return input.toUpperCase();

  // 2) í•˜ì´í”ˆ ì—†ëŠ” "krweth" í˜•íƒœ
  if (/^[a-z]{3,4}[a-z0-9]{2,10}$/i.test(q)) {
    const base = q.slice(0,3).toUpperCase();
    const sym  = q.slice(3).toUpperCase();
    return `${base}-${sym}`;
  }

  // 3) ë§ˆì¼“ ëª©ë¡ì—ì„œ í•œê¸€ëª…/ì˜ë¬¸ëª…/ì‹¬ë³¼ ì¼ë¶€ ì¼ì¹˜ ê²€ìƒ‰ (KRW ìš°ì„ )
  const cand = ALL_MARKETS.filter(m => m.market.startsWith('KRW-'));
  // ìš°ì„ ìˆœìœ„: ì •í™• ì¼ì¹˜ â†’ ì ‘ë‘ì‚¬ â†’ í¬í•¨
  const score = (m) => {
    const nameKo = _norm(m.korean_name);
    const nameEn = _norm(m.english_name);
    const sym = m.market.split('-')[1].toLowerCase();

    if (nameKo === q || nameEn === q || sym === q) return 3;
    if (nameKo.startsWith(q) || nameEn.startsWith(q) || sym.startsWith(q)) return 2;
    if (nameKo.includes(q) || nameEn.includes(q)) return 1;
    return 0;
  };
  let best = null, bestScore = 0;
  for (const m of cand) {
    const s = score(m);
    if (s > bestScore) { best = m; bestScore = s; }
  }
  return best ? best.market : null;
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹œ ë§ˆì¼“ë¦¬ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆ ë¶ˆëŸ¬ì™€ ì €ì¥ (ì´ë¯¸ ìˆë‹¤ë©´ ìƒëµ)
async function loadAllMarketsOnce() {
  if (ALL_MARKETS.length) return;
  try {
    const r = await fetch('/api/upbit?path=/v1/market/all?isDetails=true', { cache:'no-store' });
    if (!r.ok) throw new Error(r.status);
    ALL_MARKETS = await r.json();
  } catch(e) {
    console.warn('ë§ˆì¼“ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', e);
  }
}

// ì˜ˆ: ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©
async function onSearchClick() {
  await loadAllMarketsOnce();
  const q = document.querySelector('#searchInput').value; // ì‹¤ì œ ê²€ìƒ‰ inputì˜ selectorë¡œ ë°”ê¿”ì£¼ì„¸ìš”
  const market = resolveMarket(q);
  if (!market) {
    alert('í•´ë‹¹ ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. (í•œê¸€ëª…/ì˜ë¬¸ëª…/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)');
    return;
  }
  selectCoin(market); // ğŸ‘‰ ê¸°ì¡´ì˜ â€œì½”ì¸ ì„ íƒâ€ í•¨ìˆ˜ í˜¸ì¶œ (ë‹¹ì‹ ì˜ í•¨ìˆ˜ ì´ë¦„ìœ¼ë¡œ êµì²´)
}
</script>
  
</body>
</html>

