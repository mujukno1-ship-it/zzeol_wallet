<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v6.7a</title>
<style>
  :root{
    --bg:#0e1116; --panel:#121923; --panel2:#0f151e; --muted:#9aa9bb; --text:#e6edf3;
    --br:#1e2a39; --chip:#152131; --chip2:#0f1a28;
    --pos:#2ecb70; --neg:#ff6377; --warn:#ffb84d; --accent:#5ec8ff;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  a{color:inherit}
  .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
  .row{display:flex;align-items:center;gap:10px}
  .sp{flex:1}
  .badge{font-size:12px;padding:5px 10px;border:1px solid var(--br);background:#0b1522;border-radius:999px}
  .hud{gap:8px;margin-bottom:12px}
  .clock{color:var(--muted);font-size:12px}

  .panel{background:var(--panel);border:1px solid var(--br);border-radius:14px;padding:14px}
  .panel + .panel{margin-top:12px}

  /* 검색줄 */
  .searchbar{background:var(--panel2);border:1px solid var(--br);border-radius:12px;padding:10px}
  .input{height:40px;background:var(--chip2);border:1px solid var(--br);border-radius:10px;color:var(--text);padding:0 12px;outline:none;flex:1}
  .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid var(--br);background:#102033;color:var(--text);cursor:pointer}
  .btn:hover{filter:brightness(1.12)}

  /* 선택코인 1줄 */
  .bar{display:grid;grid-template-columns:1.4fr repeat(7,1fr);gap:8px}
  .cell,.th{height:46px;display:flex;align-items:center;justify-content:center;border:1px solid var(--br);border-radius:10px;background:var(--chip2)}
  .th{background:#0e1623;color:var(--muted);height:34px;border-radius:8px;font-size:12px}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 9px;border:1px solid var(--br);background:var(--chip);border-radius:999px;font-size:12px;color:#a9b8c9}

  /* 표 */
  .table{border:1px solid var(--br);border-radius:12px;overflow:auto;max-height:520px}
  .head{position:sticky;top:0;background:linear-gradient(180deg,rgba(18,25,35,.95),rgba(18,25,35,.86));backdrop-filter:blur(6px);z-index:3}
  .grid{display:grid;gap:8px;padding:8px}
  .cols{grid-template-columns: 56px 1.4fr repeat(6,1fr)}
  .th2{padding:8px 6px;border-bottom:1px solid #182232;color:var(--muted);font-size:12px;white-space:nowrap}
  .row2{padding:10px 6px;border-bottom:1px solid #182232;display:grid;grid-template-columns:inherit;align-items:center}
  .right{justify-self:end}
  .center{text-align:center}
  .tag{font-size:12px;padding:3px 8px;border:1px solid var(--br);background:#0f1826;border-radius:999px}
  .tag.warn{color:#ffc56b;border-color:#3a2b12;background:#2a1d08}
  .tag.ok{color:#9ecbff;border-color:#263a57;background:#0f213a}

  /* 타이틀 */
  .title-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .ttl{font-weight:700}
</style>
</head>
<body>
<div class="wrap">

  <!-- HUD -->
  <div class="row hud">
    <span class="badge">쩔어지갑 v6.7a</span>
    <span class="badge" id="net">ONLINE</span>
    <div class="sp"></div>
    <span class="clock" id="clock">KST —</span>
  </div>

  <!-- 검색/초기화 -->
  <div class="searchbar row">
    <input id="q" class="input" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH / 아발란체 / AVAX)" />
    <button class="btn" id="btnSearch">검색</button>
    <button class="btn" id="btnReset">초기화</button>
  </div>

  <!-- 선택 코인 요약 -->
  <div class="panel">
    <div class="bar" style="margin-bottom:8px">
      <div class="th">코인명</div><div class="th">현재가</div><div class="th">변동률</div>
      <div class="th">매수</div><div class="th">매도</div><div class="th">손절</div><div class="th">위험도</div><div class="th">쩔어한마디</div>
    </div>
    <div class="bar">
      <div class="cell" id="sel-name">없음</div>
      <div class="cell" id="sel-price">—</div>
      <div class="cell" id="sel-rate">—</div>
      <div class="cell" id="sel-bid">—</div>
      <div class="cell" id="sel-ask">—</div>
      <div class="cell" id="sel-cut">—</div>
      <div class="cell" id="sel-risk">—</div>
      <div class="cell" id="sel-note">—</div>
    </div>
  </div>

  <!-- 급등 -->
  <div class="panel">
    <div class="title-row">
      <span class="ttl">🔥 급등코인 Top 10</span>
      <span class="small muted">실시간 자동 정렬</span>
    </div>
    <div class="table">
      <div class="grid cols head">
        <div class="th2">#</div><div class="th2">코인명(한글)</div>
        <div class="th2 right">현재가</div><div class="th2 right">변동률</div>
        <div class="th2 right">매수</div><div class="th2 right">매도</div>
        <div class="th2 right">손절</div><div class="th2 center">위험도 · 쩔어한마디</div>
      </div>
      <div id="upList"></div>
    </div>
  </div>

  <!-- 급락 -->
  <div class="panel">
    <div class="title-row">
      <span class="ttl">💧 급락코인 Top 10</span>
      <span class="small muted">급등과 동일 포맷</span>
    </div>
    <div class="table">
      <div class="grid cols head">
        <div class="th2">#</div><div class="th2">코인명(한글)</div>
        <div class="th2 right">현재가</div><div class="th2 right">변동률</div>
        <div class="th2 right">매수</div><div class="th2 right">매도</div>
        <div class="th2 right">손절</div><div class="th2 center">위험도 · 쩔어한마디</div>
      </div>
      <div id="dnList"></div>
    </div>
  </div>

</div>

<script>
/* ========== 공통 ========== */
const API = p => `/api/upbit?path=${encodeURIComponent(p)}`;
function nowKST(){
  const d=new Date(),z=d.getTimezoneOffset();
  return new Date(d.getTime()-z*60000+9*3600000).toISOString().substring(11,19);
}
setInterval(()=>{document.getElementById('clock').textContent='KST — '+nowKST();},1000);

/* 업비트 호가단위(틱사이즈) */
function priceStep(p){
  if(p>=2_000_000) return 1000;
  if(p>=1_000_000) return 500;
  if(p>=500_000)  return 100;
  if(p>=100_000)  return 50;
  if(p>=10_000)   return 10;
  if(p>=1_000)    return 1;
  if(p>=100)      return 0.1;
  if(p>=10)       return 0.01;
  if(p>=1)        return 0.001;
  if(p>=0.1)      return 0.0001;
  if(p>=0.01)     return 0.00001;
  return 0.000001;
}
function roundStep(x,s,dir=0){const f=1/s; if(dir<0) return Math.floor(x*f)/f; if(dir>0) return Math.ceil(x*f)/f; return Math.round(x*f)/f;}
function fmt(p){
  if(p>=1_000) return p.toLocaleString('ko-KR',{maximumFractionDigits:0});
  if(p>=100)   return p.toFixed(1);
  if(p>=10)    return p.toFixed(2);
  if(p>=1)     return p.toFixed(3);
  if(p>=0.1)   return p.toFixed(4);
  if(p>=0.01)  return p.toFixed(5);
  return p.toFixed(6);
}
function taps(t){
  const p=t.trade_price||0, s=priceStep(p);
  return {
    bid: roundStep(p*0.998,s,-1),
    ask: roundStep(p*1.002,s,+1),
    cut: roundStep(p*0.980,s, 0)
  };
}
function riskBadge(t){
  const r=Math.abs(t.signed_change_rate||0);
  if(r>0.08) return '<span class="tag warn">3(주의)</span>';
  if(r>0.04) return '<span class="tag">2(보통)</span>';
  return '<span class="tag ok">1(안정)</span>';
}
function noteWord(t){
  const r=t.signed_change_rate||0;
  if(r>0.06) return '🚀 폭등 신호!';
  if(r>0.02) return '🔥 불장 신호!';
  if(r<-0.06) return '🧊 급락 위험';
  if(r<-0.02) return '⚠️ 약세';
  return '👀 관망';
}

/* ========== 데이터 ========== */
let MARKETS=[], KNAME=new Map(), TICK=new Map();
async function loadMarkets(){
  try{
    const r=await fetch(API('/v1/market/all?isDetails=true'));
    const a=await r.json();
    MARKETS = a.filter(m=>m.market.startsWith('KRW-'));
    MARKETS.forEach(m=>KNAME.set(m.market, m.korean_name));
  }catch(e){ alert('마켓 목록을 불러오지 못했습니다.'); }
}
async function loadTickers(list){
  const r=await fetch(API('/v1/ticker?markets='+list.join(',')),{cache:'no-store'});
  if(!r.ok) return;
  const a=await r.json();
  a.forEach(t=>TICK.set(t.market,t));
}
async function refreshAll(){
  const batch=80;
  for(let i=0;i<MARKETS.length;i+=batch){
    await loadTickers(MARKETS.slice(i,i+batch).map(m=>m.market));
    await new Promise(res=>setTimeout(res,120));
  }
}

/* ========== 렌더링 ========== */
function coinRow(t, idx){
  const r=(t.signed_change_rate||0)*100;
  const cls=r>=0?'pos':'neg';
  const tv=taps(t);
  return `
    <div class="row2 cols">
      <div>${idx}</div>
      <div>${KNAME.get(t.market)||t.market}</div>
      <div class="right">${fmt(t.trade_price)}</div>
      <div class="right ${cls}">${r.toFixed(2)}%</div>
      <div class="right">${fmt(tv.bid)}</div>
      <div class="right">${fmt(tv.ask)}</div>
      <div class="right">${fmt(tv.cut)}</div>
      <div class="center">${riskBadge(t)} &nbsp; <span class="small">${noteWord(t)}</span></div>
    </div>`;
}
function renderTop(){
  const arr=[...TICK.values()];
  const ups=arr.filter(t=>t.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const dns=arr.filter(t=>t.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
  document.getElementById('upList').innerHTML = ups.map((t,i)=>coinRow(t,i+1)).join('')||'';
  document.getElementById('dnList').innerHTML = dns.map((t,i)=>coinRow(t,i+1)).join('')||'';
}
function renderSelected(mkt){
  const t=TICK.get(mkt);
  if(!t){
    document.getElementById('sel-name').textContent='없음';
    ['price','rate','bid','ask','cut','risk','note'].forEach(id=>document.getElementById('sel-'+id).textContent='—');
    return;
  }
  const tv=taps(t), r=(t.signed_change_rate||0)*100, cls=r>=0?'pos':'neg';
  document.getElementById('sel-name').textContent = `${KNAME.get(t.market)||t.market} (${t.market})`;
  document.getElementById('sel-price').textContent = fmt(t.trade_price);
  document.getElementById('sel-rate').innerHTML = `<span class="${cls}">${r.toFixed(2)}%</span>`;
  document.getElementById('sel-bid').textContent = fmt(tv.bid);
  document.getElementById('sel-ask').textContent = fmt(tv.ask);
  document.getElementById('sel-cut').textContent = fmt(tv.cut);
  document.getElementById('sel-risk').innerHTML = riskBadge(t);
  document.getElementById('sel-note').textContent = noteWord(t);
}

/* ========== 검색 ========== */
function findMarket(q){
  q=q.trim().toLowerCase();
  if(!q) return null;
  return MARKETS.find(m=>
     m.market.toLowerCase()===q ||
     m.market.toLowerCase().includes(q) ||
     (m.korean_name||'').toLowerCase().includes(q) ||
     (m.english_name||'').toLowerCase().includes(q)
  ) || null;
}
document.getElementById('btnSearch').onclick=()=>{
  const q=document.getElementById('q').value;
  const m=findMarket(q);
  if(!m){ alert('코인을 찾지 못했습니다. (한글/영문/심볼/마켓코드 지원)'); return; }
  window.__sel=m.market; renderSelected(window.__sel);
};
document.getElementById('btnReset').onclick=()=>{
  document.getElementById('q').value=''; window.__sel=null; renderSelected(null);
};

/* ========== 부팅 ========== */
async function boot(){
  await loadMarkets();
  await refreshAll();
  renderTop();
  // 기본 선택: 첫 급등 항목이 있으면 표시
  const firstUp=[...TICK.values()].sort((a,b)=>b.signed_change_rate-a.signed_change_rate)[0];
  if(firstUp){ window.__sel=firstUp.market; renderSelected(window.__sel); }

  setInterval(async()=>{
    await refreshAll();
    renderTop();
    if(window.__sel) renderSelected(window.__sel);
  }, 15000);
}
boot();
</script>
</body>
</html>
