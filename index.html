<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>쩔어지갑 v6.2 — 급등/급락 위로정렬+검색강화+정확호가</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
:root{--bg:#0d1117;--panel:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#9fb1c1;--up:#16c784;--down:#ea3943;--chip:#223045}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR}
.wrap{max-width:1150px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
.badge{background:var(--chip);border:1px solid #283752;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25);margin-top:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button{background:#0e141b;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
input{flex:1;min-width:260px}button{cursor:pointer}button:hover{background:#1a2330}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--line);text-align:center}
.muted{color:var(--muted)}.chg.up{color:var(--up);font-weight:700}.chg.down{color:var(--down);font-weight:700}
.risk{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-weight:700}
.r1{background:#0f2b12;color:#88f36b}.r2{background:#2b230f;color:#ffd75e}.r3{background:#2b0f0f;color:#ff6b6b}
.title{display:flex;align-items:center;gap:8px}.title .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0e141b}
.err{color:#ff6b6b;font-size:12px;margin-top:6px;display:none}
.flash{animation:flash 0.9s ease-out 1}@keyframes flash{0%{background:rgba(255,255,0,.18)}100%{background:transparent}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>쩔어지갑 <span class="badge">v6.2</span> <span class="badge" id="net">OFFLINE</span></h1>
    <div class="badge" id="clock">KST — --:--:--</div>
  </header>

  <!-- 검색 -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="코인 검색 (예: 비트코인/비트코인캐시/이더리움/이더리움클래식/ETH/BTC/KRW-ETH)" autocomplete="off"/>
      <button id="btnSearch">검색</button>
      <button id="btnClear">초기화</button>
    </div>
    <div id="searchError" class="err"></div>
  </div>

  <!-- 검색 결과 -->
  <div class="card" id="result" style="display:none">
    <div class="title"><b>선택된 코인:</b> <span id="selName">-</span> <span class="tag" id="selMarket">—</span></div>
    <table style="margin-top:10px">
      <thead><tr class="muted"><th>현재가</th><th>매수</th><th>매도</th><th>손절</th><th>변동률</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody><tr>
        <td id="s_price">—</td><td id="s_buy">—</td><td id="s_sell">—</td><td id="s_stop">—</td>
        <td id="s_rate">—</td><td id="s_risk">—</td><td id="s_comment">—</td>
      </tr></tbody>
    </table>
  </div>

  <!-- 급등 Top 10 -->
  <div class="card">
    <div class="title"><b>🔥 급등코인 Top 10</b> <span class="tag" id="tagUp">기본: 5%↑ · 24h 1000억↑</span></div>
    <table>
      <thead><tr class="muted"><th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody id="feedUp"></tbody>
    </table>
  </div>

  <!-- 급락 Top 10 (급등 아래) -->
  <div class="card">
    <div class="title"><b>💧 급락코인 Top 10</b> <span class="tag" id="tagDown">기본: -5%↓ · 24h 1000억↑</span></div>
    <table>
      <thead><tr class="muted"><th>#</th><th>코인명(한글)</th><th>현재가</th><th>변동률</th><th>매수</th><th>매도</th><th>손절</th><th>위험도</th><th>쩔어한마디</th></tr></thead>
      <tbody id="feedDown"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== 시계/상태 ===== */
(function(){
  function tick(){
    var c=document.getElementById('clock'), n=document.getElementById('net'); if(!c||!n) return;
    var now=new Date(), utc=now.getTime()+now.getTimezoneOffset()*60000, kst=new Date(utc+9*3600000);
    c.textContent='KST — '+kst.toLocaleTimeString('ko-KR',{hour12:false});
    var on=navigator.onLine; n.textContent=on?'ONLINE':'OFFLINE'; n.style.background=on?'#123922':'#3a1a1a';
  }
  setInterval(tick,1000); tick();
})();

/* ===== 프록시/API ===== */
var PROXIES=['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
var API='https://api.upbit.com/v1/';
function withProxy(url){ return PROXIES[0]+url; }
function fetchJSON(url,timeout){
  timeout=timeout||9000;
  return new Promise(function(resolve,reject){
    var ctrl=new AbortController(); var t=setTimeout(function(){ctrl.abort();},timeout);
    fetch(url,{signal:ctrl.signal,cache:'no-store'}).then(function(r){clearTimeout(t); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();})
    .then(resolve).catch(reject);
  });
}

/* ===== 이름 맵/캐시 + 별명(알리아스) ===== */
var NAME_CACHE_KEY='upbit_names_cache_v3';
var NAME_BY_MARKET={}, NAME_BY_SYM={}, ALIAS_TO_MARKET={
  '비트코인':'KRW-BTC','비트':'KRW-BTC','BTC':'KRW-BTC','BITCOIN':'KRW-BTC',
  '비트코인캐시':'KRW-BCH','비트코인캐쉬':'KRW-BCH','비캐':'KRW-BCH','BCH':'KRW-BCH','BITCOINCASH':'KRW-BCH',
  '이더리움':'KRW-ETH','ETH':'KRW-ETH','ETHEREUM':'KRW-ETH',
  '이더리움클래식':'KRW-ETC','이클':'KRW-ETC','ETC':'KRW-ETC','ETHEREUMCLASSIC':'KRW-ETC',
};
function saveNameCache(o){ try{localStorage.setItem(NAME_CACHE_KEY,JSON.stringify(o));}catch(e){} }
function loadNameCache(){ try{return JSON.parse(localStorage.getItem(NAME_CACHE_KEY)||'{}');}catch(e){return {}} }
function normalize(s){ return (s||'').toString().normalize('NFC').replace(/\s+/g,'').toUpperCase(); }
function SYM(m){ return m.replace('KRW-',''); }
function ko(mOrS){
  if(!mOrS) return '이름미정';
  if(mOrS.indexOf && mOrS.indexOf('KRW-')===0) return NAME_BY_MARKET[mOrS]||'이름미정';
  return NAME_BY_SYM[mOrS]||'이름미정';
}
(function hydrate(){
  var c=loadNameCache(); var bm=c.byMarket||{}, bs=c.bySym||{};
  for(var k in bm) NAME_BY_MARKET[k]=bm[k];
  for(var s in bs) NAME_BY_SYM[s]=bs[s];
})();
function ensureMarkets(){
  if(Object.keys(NAME_BY_MARKET).length) return Promise.resolve();
  var url=withProxy(API+'market/all?isDetails=false');
  return fetchJSON(url,9000).then(function(all){
    var list=all.filter(function(x){return x.market.indexOf('KRW-')===0;});
    for(var i=0;i<list.length;i++){
      var m=list[i], sym=SYM(m.market), k=(m.korean_name||'').trim()||sym;
      NAME_BY_MARKET[m.market]=k; NAME_BY_SYM[sym]=k;
    }
    saveNameCache({byMarket:NAME_BY_MARKET, bySym:NAME_BY_SYM});
    var n=document.getElementById('net'); n.textContent='ONLINE'; n.style.background='#123922';
  }).catch(function(){});
}

/* ===== 호가단위/표시 ===== */
function getTick(p){
  if(p>=2000000) return 1000; if(p>=1000000) return 500; if(p>=500000) return 100;
  if(p>=100000) return 50; if(p>=10000) return 10; if(p>=1000) return 5; if(p>=100) return 1;
  if(p>=10) return 0.1; if(p>=1) return 0.01; if(p>=0.1) return 0.001; if(p>=0.01) return 0.0001;
  if(p>=0.001) return 0.00001; if(p>=0.0001) return 0.000001; if(p>=0.00001) return 0.0000001;
  if(p>=0.000001) return 0.00000001; return 0.000000001;
}
function fmtKRW(x){
  var t=getTick(x); var d=(t.toString().split('.')[1]||'').length;
  var r=Math.floor(x/t)*t; // 정확 호가: 절사
  return r.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function riskText(r){var v=Math.abs(r*100); return v<1?'1(안정)':(v<3?'2(보통)':'3(주의)');}
function riskClass(r){var v=Math.abs(r*100); return v<1?'r1':(v<3?'r2':'r3');}
function zzeolComment(r){return r>0.1?'🚀 폭등 모드!':(r>0.05?'🔥 불장 신호!':(r>0.02?'📈 상승 탄력':(r<-0.1?'💣 급락 경고':(r<-0.05?'⚠️ 약세 전환':'⚖️ 관망'))));}

/* ===== 검색 ===== */
function findMarketByQuery(qRaw){
  var q=normalize(qRaw);
  if(ALIAS_TO_MARKET[q]) return ALIAS_TO_MARKET[q];                      // 별명/한글/심볼 즉시 매핑
  if(/^KRW-[A-Z0-9]+$/.test(qRaw.toUpperCase())) return qRaw.toUpperCase(); // 직접 코드
  var keys=Object.keys(NAME_BY_MARKET), found=null;
  for(var i=0;i<keys.length;i++){ // 정확
    var k=keys[i]; var sym=normalize(SYM(k)); var koName=normalize(NAME_BY_MARKET[k]||'');
    if(normalize(k)===q || sym===q || koName===q){ found=k; break; }
  }
  if(!found){ // 부분
    for(var j=0;j<keys.length;j++){
      var kk=keys[j]; var sym2=normalize(SYM(kk)); var ko2=normalize(NAME_BY_MARKET[kk]||'');
      if(normalize(kk).indexOf(q)>-1 || sym2.indexOf(q)>-1 || ko2.indexOf(q)>-1){ found=kk; break; }
    }
  }
  return found;
}
function doSearch(){
  var err=document.getElementById('searchError'); if(err) err.style.display='none';
  var q=document.getElementById('q').value; if(!q){document.getElementById('q').focus();return;}
  ensureMarkets().then(function(){
    var market=findMarketByQuery(q);
    if(!market){ err.textContent="일치 코인 없음 (예: 비트코인/비트코인캐시/이더리움/이더리움클래식/ETH/BTC/KRW-ETH)"; err.style.display='block'; return; }
    var url=withProxy(API+'ticker?markets='+market);
    return fetchJSON(url,9000).then(function(d){
      var t=d[0], p=t.trade_price, r=t.signed_change_rate;
      document.getElementById('result').style.display='block';
      document.getElementById('selName').textContent=ko(market); document.getElementById('selMarket').textContent=market;
      document.getElementById('s_price').textContent=fmtKRW(p);
      document.getElementById('s_buy').textContent=fmtKRW(p*0.988);
      document.getElementById('s_sell').textContent=fmtKRW(p*1.012);
      document.getElementById('s_stop').textContent=fmtKRW(p*0.975);
      document.getElementById('s_rate').innerHTML='<span class="chg '+(r>=0?'up':'down')+'">'+(r*100).toFixed(2)+'%</span>';
      document.getElementById('s_risk').innerHTML='<span class="risk '+riskClass(r)+'">'+riskText(r)+'</span>';
      document.getElementById('s_comment').textContent=zzeolComment(r);
    });
  }).catch(function(){
    err.textContent='데이터 불러오기 실패'; err.style.display='block';
  });
}
document.getElementById('btnSearch').addEventListener('click',doSearch);
document.getElementById('q').addEventListener('keydown',function(e){ if(e.key==='Enter') doSearch(); });
document.getElementById('btnClear').addEventListener('click',function(){ document.getElementById('q').value=''; document.getElementById('result').style.display='none'; document.getElementById('searchError').style.display='none'; });

/* ===== 급등/급락 스캔 ===== */
function chunk(a,s){var o=[]; for(var i=0;i<a.length;i+=s) o.push(a.slice(i,i+s)); return o;}
function scanOnce(){
  return ensureMarkets().then(function(){
    var markets=Object.keys(NAME_BY_MARKET); var parts=chunk(markets,60); var all=[];
    function seq(i){ if(i>=parts.length) return Promise.resolve();
      var url=withProxy(API+'ticker?markets='+parts[i].join(','));
      return fetchJSON(url,9000).then(function(js){ all=all.concat(js||[]); }).then(function(){return seq(i+1);});
    }
    return seq(0).then(function(){
      var volMin=1000*100000000; // 1000억
      var ups=all.filter(function(t){return t.signed_change_rate> 0.05 && (t.acc_trade_price_24h||0)>=volMin;})
                 .sort(function(a,b){return b.signed_change_rate-a.signed_change_rate;}).slice(0,10);
      var downs=all.filter(function(t){return t.signed_change_rate<-0.05 && (t.acc_trade_price_24h||0)>=volMin;})
                   .sort(function(a,b){return a.signed_change_rate-b.signed_change_rate;}).slice(0,10);
      renderList('feedUp',ups,true);
      renderList('feedDown',downs,true);
      var n=document.getElementById('net'); n.textContent='ONLINE'; n.style.background='#123922';
    }).catch(function(){ var n=document.getElementById('net'); n.textContent='OFFLINE (재시도중)'; n.style.background='#3a1a1a'; });
  });
}

/* ✅ 새/재감지 시 맨 위로 올리는 렌더러 */
function renderList(tbodyId, arr, reorder){
  var el=document.getElementById(tbodyId);
  if(!reorder){ el.innerHTML=''; } // (옵션) 처음부터 그릴 때만 비움

  // arr는 정렬된 상태라 뒤에서부터 prepend하면 화면에는 올바른 순서가 됨
  for(var i=arr.length-1;i>=0;i--){
    var t=arr[i], p=t.trade_price, r=t.signed_change_rate, market=t.market;
    var row=el.querySelector('tr[data-market="'+market+'"]');
    var html='<td class="rank"></td>'
      +'<td>'+ko(market)+'</td>'
      +'<td>'+fmtKRW(p)+'</td>'
      +'<td class="chg '+(r>=0?'up':'down')+'">'+(r*100).toFixed(2)+'%</td>'
      +'<td>'+fmtKRW(p*0.988)+'</td>'
      +'<td>'+fmtKRW(p*1.012)+'</td>'
      +'<td>'+fmtKRW(p*0.975)+'</td>'
      +'<td><span class="risk '+riskClass(r)+'">'+riskText(r)+'</span></td>'
      +'<td>'+zzeolComment(r)+'</td>';

    if(row){
      row.innerHTML=html;
      row.classList.add('flash');
      el.prepend(row); // ✅ 재감지 → 맨 위로 이동
      setTimeout(function(rr){ return function(){ rr.classList.remove('flash'); }; }(row),800);
    }else{
      var tr=document.createElement('tr');
      tr.dataset.market=market;
      tr.classList.add('flash');
      tr.innerHTML=html;
      el.prepend(tr); // ✅ 신규 감지 → 맨 위로 추가
      setTimeout(function(rr){ return function(){ rr.classList.remove('flash'); }; }(tr),800);
    }
  }

  // Top10 유지
  while(el.children.length>10) el.removeChild(el.lastChild);

  // 순위 번호 다시 매기기
  var rows=el.querySelectorAll('tr');
  for(var j=0;j<rows.length;j++){
    var rnkCell=rows[j].querySelector('.rank'); if(rnkCell) rnkCell.textContent=(j+1);
  }
}

/* ===== 부팅: 접속 즉시 실행 + 주기적 갱신 ===== */
(async function boot(){
  await scanOnce();            // 접속 직후 바로 표시
  setInterval(scanOnce,60000); // 1분마다 갱신
})();
</script>
</body>
</html>
