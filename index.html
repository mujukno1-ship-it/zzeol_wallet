<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.4.1 (ê²€ìƒ‰ ë³µêµ¬ ì•ˆì •íŒ)</title>
<style>
  :root{--bg:#0e0f12;--panel:#15161a;--muted:#9aa4ad;--line:#22252b;--txt:#e9edf2;--up:#17c964;--down:#f31260;--chip:#1f2227;--warn:#f5a524}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  .badge{background:#21242a;border:1px solid var(--line);color:#cfd6dd;padding:4px 8px;border-radius:999px;font-weight:600}
  .online{color:#9cffce;background:#13231a;border-color:#1e3a25}
  .row{display:flex;gap:14px;align-items:stretch}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .panel h3{margin:0 0 10px 0;font-size:16px}
  .grow{flex:1}
  input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0c0f;color:var(--txt);outline:none}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0c0f;color:var(--txt);cursor:pointer}
  .btn.primary{background:#0b2239;border-color:#0e2f56;color:#d3e9ff}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;align-items:center}
  .th{color:var(--muted);font-weight:600;border-bottom:1px solid var(--line);padding:8px}
  .td{padding:8px;border-bottom:1px solid var(--line)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);padding:5px 8px;border-radius:999px;font-size:12px;color:#c8d0d7}
  .up{color:#a6ffd5;background:#0f2019;border-color:#1d3328}
  .down{color:#ffc2cf;background:#221117;border-color:#3a1a25}
  .warn{color:#fff7d1;background:#251d0a;border-color:#3d2e10}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .note{color:var(--muted);margin-top:8px}
  .result-box{margin-top:12px}
  .card{background:#0f1115;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h4{margin:0 0 8px 0}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .table-scroll{max-height:520px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <span class="badge">ì©”ì–´ì§€ê°‘ v7.4.1</span>
    <span class="badge online">ONLINE</span>
    <span class="badge">KST â€” <span id="clock">--:--:--</span></span>
    <span class="right"></span>
    <span class="note">ê²€ìƒ‰ê²°ê³¼ëŠ” ê²€ìƒ‰ì°½ <b>ë°”ë¡œ ì•„ë˜</b>ì— í‘œì‹œë©ë‹ˆë‹¤</span>
  </header>

  <!-- ê²€ìƒ‰ íŒ¨ë„ -->
  <div class="panel">
    <div class="row">
      <div class="grow">
        <input id="q" type="text" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / Ethereum / ETH / KRW-ETH)" />
        <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ -->
        <div class="result-box" id="searchResult"></div>
      </div>
      <div>
        <button class="btn primary" id="btnSearch">ê²€ìƒ‰</button><br/>
        <button class="btn" style="margin-top:8px" id="btnReset">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- ì„ íƒëœ ì½”ì¸ ìš”ì•½ -->
  <div class="panel" style="margin-top:12px">
    <h3>ì„ íƒëœ ì½”ì¸: <span id="pickedName" class="muted">ì—†ìŒ</span> â€” <small>ë³€ë™ë¥ </small> <span id="pickedChange" class="chip">â€”</span></h3>
    <div class="grid mono">
      <div class="th">í˜„ì¬ê°€</div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„</div><div class="th">ì©”ì–´í•œë§ˆë””</div><div class="th">í˜¸ê°€ë‹¨ìœ„</div><div class="th">ë§ˆì¼“</div>
      <div class="td" id="cur">â€”</div>
      <div class="td" id="buy">â€”</div>
      <div class="td" id="sell">â€”</div>
      <div class="td" id="stop">â€”</div>
      <div class="td" id="risk">â€”</div>
      <div class="td" id="comment">â€”</div>
      <div class="td" id="tick">â€”</div>
      <div class="td" id="market">â€”</div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <!-- ê¸‰ë“± Top10 -->
    <div class="panel grow">
      <div class="row" style="align-items:center;margin-bottom:8px">
        <h3 style="margin:0">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <small class="muted">(ì‹¤ì‹œê°„)</small></h3>
        <span class="right"></span>
        <button id="reloadUp" class="btn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="grid mono">
        <div class="th">#</div><div class="th">ì½”ì¸ëª…(í•œê¸€)</div><div class="th">í˜„ì¬ê°€</div><div class="th">ë³€ë™ë¥ </div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      </div>
      <div class="table-scroll mono" id="upTable"></div>
    </div>

    <!-- ê¸‰ë½ Top10 -->
    <div class="panel grow">
      <div class="row" style="align-items:center;margin-bottom:8px">
        <h3 style="margin:0">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 <small class="muted">(ì‹¤ì‹œê°„)</small></h3>
        <span class="right"></span>
        <button id="reloadDown" class="btn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="grid mono">
        <div class="th">#</div><div class="th">ì½”ì¸ëª…(í•œê¸€)</div><div class="th">í˜„ì¬ê°€</div><div class="th">ë³€ë™ë¥ </div><div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      </div>
      <div class="table-scroll mono" id="downTable"></div>
    </div>
  </div>

  <div class="note">â“˜ ë°ì´í„°: ì—…ë¹„íŠ¸ Â· í”„ë¡ì‹œ: <code>/api/upbit?path=â€¦</code> Â· ê°±ì‹ : 30ì´ˆ</div>
</div>

<script>
/* ---------- ê³µí†µ ---------- */
const $ = s => document.querySelector(s);
const API = p => `/api/upbit?path=${encodeURIComponent(p)}`;
const sleep = ms => new Promise(r=>setTimeout(r,ms));
let MARKET_CACHE = [];
let TICKER_CACHE = new Map();

function tickSize(price){
  if (price >= 2000000) return 1000;
  if (price >= 1000000) return 500;
  if (price >= 500000)  return 100;
  if (price >= 100000)  return 50;
  if (price >= 10000)   return 10;
  if (price >= 1000)    return 5;
  if (price >= 100)     return 1;
  if (price >= 10)      return 0.1;
  if (price >= 1)       return 0.01;
  if (price >= 0.1)     return 0.001;
  if (price >= 0.01)    return 0.0001;
  return 0.00001;
}
const roundToTick = p => { const t=tickSize(p); return Math.round(p/t)*t; };
const fmt = n => (typeof n==='number') ? n.toLocaleString('ko-KR') : n;
const norm = s => (s||'').toString().trim().toLowerCase().replace(/[\s\-\(\)]/g,'');

async function fetchJSON(url,retry=1){
  try{
    const r = await fetch(url,{headers:{accept:'application/json'}});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){
    if(retry>0){ await sleep(500); return fetchJSON(url,retry-1); }
    throw e;
  }
}

/* ---------- ë°ì´í„° ---------- */
async function loadMarkets(){
  if (MARKET_CACHE.length) return MARKET_CACHE;
  const arr = await fetchJSON(API('/v1/market/all?isDetails=true'));
  if (!Array.isArray(arr) || !arr.length) throw new Error('ë§ˆì¼“ ëª©ë¡ ì—†ìŒ');

  MARKET_CACHE = arr.filter(m => m.market?.startsWith('KRW-'));
  MARKET_CACHE.forEach(m=>{
    m._k = norm(m.korean_name);
    m._e = norm(m.english_name);
    m._m = norm(m.market);
    m._s = norm(m.market.replace('KRW-',''));
  });
  return MARKET_CACHE;
}

async function loadTicker(markets){
  const key = markets.join(',');
  if (TICKER_CACHE.has(key)){
    const {at,data} = TICKER_CACHE.get(key);
    if (Date.now()-at < 3000) return data; // 3ì´ˆ ìºì‹œ
  }
  const data = await fetchJSON(API('/v1/ticker?markets='+markets.join(',')));
  TICKER_CACHE.set(key,{at:Date.now(),data});
  return data;
}

/* ---------- ê²€ìƒ‰ & í‘œì‹œ ---------- */
function renderSearchResult(coin, ticker){
  const box = $('#searchResult');
  if (!coin){ box.innerHTML = `<div class="card" style="color:#ffb4c1">âŒ ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`; return; }

  const p = ticker.trade_price;
  const t = tickSize(p);
  const buy = roundToTick(p * 0.996);
  const sell= roundToTick(p * 1.006);
  const stop= roundToTick(p * 0.985);
  const risk = Math.abs(t/p) < 0.002 ? '1(ì•ˆì •)' : Math.abs(t/p) < 0.006 ? '2(ë³´í†µ)' : '3(ì£¼ì˜)';
  const comment = (ticker.signed_change_rate>=0.07) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' :
                  (ticker.signed_change_rate<=-0.07) ? 'ğŸ”» ë‚™í­ê²½ê³„' :
                  (ticker.signed_change_rate>0) ? 'â†— ìƒìŠ¹ì¤‘' : 'â†˜ í•˜ë½ì¤‘';

  // ì„ íƒ íŒ¨ë„ ë™ê¸°í™”(ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
  $('#pickedName').textContent = `${coin.korean_name} (${coin.market})`;
  $('#pickedChange').textContent = (ticker.signed_change_rate*100).toFixed(2)+'%';
  $('#pickedChange').className = 'chip ' + (ticker.signed_change_rate>=0?'up':'down');
  $('#cur').textContent = fmt(p);
  $('#buy').textContent = fmt(buy);
  $('#sell').textContent = fmt(sell);
  $('#stop').textContent = fmt(stop);
  $('#risk').innerHTML = `<span class="chip ${risk.startsWith('3')?'warn':''}">${risk}</span>`;
  $('#comment').textContent = comment;
  $('#tick').textContent = t;
  $('#market').textContent = coin.market;

  // ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ ì¹´ë“œ í‘œì‹œ
  box.innerHTML = `
    <div class="card">
      <h4>${coin.korean_name} <span class="muted">(${coin.english_name} Â· ${coin.market})</span></h4>
      <div class="flex mono">
        <span class="chip">í˜„ì¬ê°€ ${fmt(p)}ì›</span>
        <span class="chip up">ë§¤ìˆ˜ ${fmt(buy)}</span>
        <span class="chip down">ë§¤ë„ ${fmt(sell)}</span>
        <span class="chip warn">ì†ì ˆ ${fmt(stop)}</span>
        <span class="chip">í˜¸ê°€ ${t}</span>
        <span class="chip">${risk}</span>
        <span class="chip">${comment}</span>
      </div>
    </div>`;
}

async function doSearch(){
  const q = $('#q').value.trim();
  const nq = norm(q);
  const box = $('#searchResult');
  box.innerHTML = '';

  if (!q){ box.innerHTML = `<div class="card">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>`; return; }

  let markets;
  try { markets = await loadMarkets(); }
  catch(e){ box.innerHTML = `<div class="card" style="color:#ffb4c1">ë§ˆì¼“ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`; return; }

  // ê°•í•œ ì¼ì¹˜ â†’ ë¶€ë¶„ ì¼ì¹˜
  let coin = markets.find(m => m._m===nq || m._s===nq);
  if (!coin) coin = markets.find(m => m._k.includes(nq) || m._e.includes(nq) || m._s.includes(nq));

  if (!coin){ renderSearchResult(null); return; }

  let t;
  try { [t] = await loadTicker([coin.market]); }
  catch(e){ box.innerHTML = `<div class="card" style="color:#ffb4c1">ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨: ${e.message}</div>`; return; }

  renderSearchResult(coin, t);
}

/* ---------- ê¸‰ë“±/ê¸‰ë½ ---------- */
function rowTemplate(i, m, t){
  const p=t.trade_price, ch=t.signed_change_rate*100, cls=ch>=0?'up':'down';
  const ts=tickSize(p), buy=roundToTick(p*0.996), sell=roundToTick(p*1.006), stop=roundToTick(p*0.985);
  const risk = Math.abs(ts/p) < 0.002 ? '1(ì•ˆì •)' : Math.abs(ts/p) < 0.006 ? '2(ë³´í†µ)' : '3(ì£¼ì˜)';
  const comment = (t.signed_change_rate>=0.07) ? 'ğŸš€ í­ë“± ëª¨ë“œ!' :
                  (t.signed_change_rate<=-0.07) ? 'ğŸ”» ë‚™í­ê²½ê³„' :
                  (t.signed_change_rate>0) ? 'â†— ìƒìŠ¹ì¤‘' : 'â†˜ í•˜ë½ì¤‘';
  return `
    <div class="grid">
      <div class="td">${i}</div>
      <div class="td"><b>${m.korean_name}</b> <span class="muted">(${m.market.replace('KRW-','')})</span></div>
      <div class="td mono">${fmt(p)}</div>
      <div class="td"><span class="chip ${cls}">${ch.toFixed(2)}%</span></div>
      <div class="td mono">${fmt(buy)}</div>
      <div class="td mono">${fmt(sell)}</div>
      <div class="td mono">${fmt(stop)}</div>
      <div class="td"><span class="chip">${risk}</span> Â· <span class="chip">${comment}</span></div>
    </div>`;
}
async function buildTables(){
  try{
    const markets = await loadMarkets();
    const tickers = await loadTicker(markets.map(m=>m.market));
    const map = new Map(tickers.map(t=>[t.market,t]));
    const sorted = markets.map(m=>[m,map.get(m.market)]).filter(([m,t])=>t).sort((a,b)=>b[1].signed_change_rate - a[1].signed_change_rate);
    const up = sorted.slice(0,10), down = sorted.slice(-10).reverse();
    $('#upTable').innerHTML = up.map(([m,t],i)=>rowTemplate(i+1,m,t)).join('');
    $('#downTable').innerHTML = down.map(([m,t],i)=>rowTemplate(i+1,m,t)).join('');
  }catch(e){
    $('#upTable').innerHTML = `<div class="td" style="color:#ffb4c1">ê¸‰ë“± ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
    $('#downTable').innerHTML = `<div class="td" style="color:#ffb4c1">ê¸‰ë½ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
  }
}

/* ---------- ì´ë²¤íŠ¸ ì—°ê²°(ë³µêµ¬ í•µì‹¬) ---------- */
let typing;
$('#btnSearch').addEventListener('click', doSearch);
$('#btnReset').addEventListener('click', ()=>{
  $('#q').value=''; $('#searchResult').innerHTML='';
  $('#pickedName').textContent='ì—†ìŒ';
  ['pickedChange','cur','buy','sell','stop','risk','comment','tick','market'].forEach(id=>{
    const el=$('#'+id); el.textContent='â€”'; if(id==='pickedChange') el.className='chip';
  });
});
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
$('#q').addEventListener('input', ()=>{
  clearTimeout(typing);
  typing=setTimeout(()=>{ if($('#q').value.trim()) doSearch(); }, 300);
});
$('#reloadUp').addEventListener('click', buildTables);
$('#reloadDown').addEventListener('click', buildTables);

/* ---------- ë¶€íŒ… ---------- */
(async function init(){
  // ì‹œê³„
  setInterval(()=>{
    const d=new Date(); const z=n=>String(n).padStart(2,'0');
    $('#clock').textContent = `${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
  },1000);

  try{
    await loadMarkets();  // ë¨¼ì € ì‹œì¥ ë¡œë“œ
    await buildTables();  // í‘œ êµ¬ì„±
    // 30ì´ˆë§ˆë‹¤ í‘œ ê°±ì‹ 
    setInterval(buildTables, 30000);
  }catch(e){
    $('#searchResult').innerHTML = `<div class="card" style="color:#ffb4c1">ì´ˆê¸°í™” ì‹¤íŒ¨: ${e.message}</div>`;
  }

  // ì£¼ì†Œ í•´ì‹œ(#ETH / #ì´ë”ë¦¬ì›€ / #KRW-ETH) ìë™ ê²€ìƒ‰
  const hash = decodeURIComponent(location.hash.replace('#','')).trim();
  if(hash){ $('#q').value = hash; doSearch(); }
})();
</script>
 <!-- ====== zzeol v7.x ê²€ìƒ‰ íŒ¨ì¹˜: UI & ë¡œì§ (ë¶™ì—¬ë„£ê¸°) ====== -->
<style>
  /* ê²€ìƒ‰ ê²°ê³¼ í‘œ ìŠ¤íƒ€ì¼(ê°€ë³ê²Œ) */
  #zsearch-wrap { margin-top: 12px; }
  #zsearch-box { display:flex; gap:8px; align-items:center; }
  #zsearch-input { flex:1; height:36px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:#0e0f14; color:#eaeef7; }
  #zsearch-btn { height:36px; padding:0 14px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:#151823; color:#eaeef7; cursor:pointer; }
  #zsearch-result { margin-top:10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden; }
  #zsearch-result table { width:100%; border-collapse:collapse; font-size:13px; }
  #zsearch-result thead { background:#11131a; }
  #zsearch-result th, #zsearch-result td { padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:right; }
  #zsearch-result th:first-child, #zsearch-result td:first-child { text-align:left; }
  .zpos { color:#3fe1a1; } .zneg { color:#ff6b74; }
  .zmuted { opacity:.7 }
  #zsearch-empty { padding:16px; text-align:center; opacity:.8 }
</style>

<div id="zsearch-wrap">
  <!-- ì´ë¯¸ í˜ì´ì§€ì— ê²€ìƒ‰ì°½ì´ ìˆë‹¤ë©´ ì•„ë˜ê°€ ë¬´ì‹œë˜ê³ , ê¸°ì¡´ #zsearch-input ìš”ì†Œë§Œ ì¡ì•„ì„œ ì”ë‹ˆë‹¤. -->
  <div id="zsearch-box">
    <input id="zsearch-input" type="text" placeholder="ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ: ì˜ˆ) ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
    <button id="zsearch-btn">ê²€ìƒ‰</button>
  </div>
  <div id="zsearch-result" style="display:none"></div>
</div>

<script>
(function(){
  // ===== ì„¤ì • =====
  const API = '/api/upbit?path=';            // í”„ë¡ì‹œ ê³ ì •
  const MAX_ROWS = 20;                       // ê²€ìƒ‰ ê²°ê³¼ ìµœëŒ€ í‘œì‹œ
  const DEBOUNCE_MS = 300;                   // ì…ë ¥ ë””ë°”ìš´ìŠ¤

  // ===== ì—˜ë¦¬ë¨¼íŠ¸ ë°”ì¸ë”©(ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©) =====
  const inputEl = document.getElementById('zsearch-input') || (function(){
    // í˜¹ì‹œ ìƒë‹¨ì— ì´ë¯¸ ê²€ìƒ‰ì°½ì´ ìˆë‹¤ë©´ ê±°ê¸°ì— idë§Œ ë¶€ì—¬í•´ ì¬í™œìš©
    const prior = document.querySelector('input[type="search"], input[placeholder*="ê²€ìƒ‰"]');
    if (prior) prior.id = 'zsearch-input';
    return prior || document.getElementById('zsearch-input');
  })();
  const btnEl = document.getElementById('zsearch-btn');
  const resultEl = document.getElementById('zsearch-result');

  // ===== ìœ í‹¸ =====
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  const debounce = (fn, ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const norm = (s)=> (s||'').toString().trim().toLowerCase().replace(/\s+/g,'');
  const fmt = (n, d=2)=> (n==null || isNaN(n)) ? '-' : Number(n).toLocaleString('ko-KR', { maximumFractionDigits:d });
  const pct = (n)=> (n==null || isNaN(n)) ? '-' : (n>0 ? `<span class="zpos">+${n.toFixed(2)}%</span>` : `<span class="zneg">${n.toFixed(2)}%</span>`);

  // ===== ë§ˆì¼“ ë§µ(í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ) ìºì‹œ =====
  let marketMap = null; // Map(symbol|korean|english|market) -> marketCode(KRW-XXX)
  let marketInfo = null; // marketCode -> {korean_name, english_name}
  async function ensureMarkets() {
    if (marketMap) return;
    const url = API + encodeURIComponent('/v1/market/all?isDetails=true');
    const res = await fetch(url, { cache: 'no-store' });
    const list = await res.json();
    marketMap = new Map();
    marketInfo = new Map();
    list.forEach(it=>{
      const market = it.market;               // KRW-ETH
      const sym = market.split('-')[1];       // ETH
      const k = norm(it.korean_name);
      const e = norm(it.english_name);
      const s = norm(sym);
      marketMap.set(norm(market), market);
      marketMap.set(k, market);
      marketMap.set(e, market);
      marketMap.set(s, market);
      marketInfo.set(market, { k: it.korean_name, e: it.english_name, market });
    });
  }

  // ===== í‹°ì»¤ ì¡°íšŒ =====
  async function fetchTickers(markets){
    if (!markets.length) return [];
    const batched = [];
    // ì—…ë¹„íŠ¸ëŠ” 100ê°œê¹Œì§€ í•œë²ˆì— OK. ì•ˆì „í•˜ê²Œ 50ê°œì”©
    for (let i=0; i<markets.length; i+=50) {
      const part = markets.slice(i, i+50).join(',');
      const url = API + encodeURIComponent('/v1/ticker?markets=' + part);
      batched.push(fetch(url, { cache: 'no-store' }).then(r=>r.json()));
    }
    const chunks = await Promise.all(batched);
    return chunks.flat();
  }

  // ===== ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìœ„í—˜ë„/í•œë§ˆë”” ê³„ì‚° (ê¸°ì¡´ í•¨ìˆ˜ ì¡´ì¤‘) =====
  function defaultAdvice(t){ // t: ì—…ë¹„íŠ¸ í‹°ì»¤ ì›ë³¸
    const p = t.trade_price;
    const chg = ((t.signed_change_rate||0) * 100);
    const buy  = p * 0.995;     // ë³´ìˆ˜ì  ì§„ì… ì œì•ˆ(0.5% í•˜ë½ì‹œ)
    const sell = p * 1.005;     // ë‹¨ê¸° ë¶„í•  ìµì ˆ(0.5%)
    const sl   = p * 0.980;     // 2% ì†ì ˆ
    const risk = (Math.abs(chg) > 5 ? '3(ì£¼ì˜)' : Math.abs(chg) > 2 ? '2(ë³´í†µ)' : '1(ì•ˆì •)');
    let say = 'ê´€ë§';
    if (chg > 3) say = 'ìƒìŠ¹ì¤‘';
    if (chg > 6) say = 'í­ë“± ëª¨ë“œ!';
    if (chg < -3) say = 'ë‚™í­ê²½ê³„';
    return { buy, sell, sl, risk, say };
  }
  function computeAdvice(t){
    // í˜ì´ì§€ì— ê¸°ì¡´ ê³„ì‚°ê¸°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    if (window.ZZEOL && typeof window.ZZEOL.compute === 'function') {
      try{ return window.ZZEOL.compute(t); }catch(_){}
    }
    return defaultAdvice(t);
  }

  // ===== ë Œë”ë§ =====
  function renderEmpty(msg='ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'){
    resultEl.style.display = 'block';
    resultEl.innerHTML = `<div id="zsearch-empty">${msg}</div>`;
  }
  function renderTable(rows){
    resultEl.style.display = 'block';
    resultEl.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ì½”ì¸ëª…(í•œê¸€)</th>
            <th>í˜„ì¬ê°€</th>
            <th>ë³€ë™ë¥ </th>
            <th>ë§¤ìˆ˜</th>
            <th>ë§¤ë„</th>
            <th>ì†ì ˆ</th>
            <th>ìœ„í—˜ë„</th>
            <th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.name} <span class="zmuted">(${r.market})</span></td>
              <td>${fmt(r.price, r.price>100 ? 0 : 2)}</td>
              <td>${pct(r.change)}</td>
              <td>${fmt(r.buy)}</td>
              <td>${fmt(r.sell)}</td>
              <td>${fmt(r.sl)}</td>
              <td>${r.risk}</td>
              <td>${r.say}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // ===== ê²€ìƒ‰ ì‹¤í–‰ =====
  async function runSearch(q){
    try{
      await ensureMarkets();
      const key = norm(q);
      if (!key) { resultEl.style.display='none'; resultEl.innerHTML=''; return; }

      // í‚¤ì›Œë“œë¡œ ì‹œì¥ì½”ë“œ ì°¾ê¸°(ì™„ì „/ë¶€ë¶„ì¼ì¹˜ ì§€ì›)
      let targets = new Set();
      // ì™„ì „ì¼ì¹˜ ìš°ì„ 
      if (marketMap.has(key)) targets.add(marketMap.get(key));
      // ë¶€ë¶„ì¼ì¹˜
      for (const [k, mkt] of marketMap.entries()) {
        if (k.includes(key)) targets.add(mkt);
        if (targets.size >= 200) break;
      }
      const markets = Array.from(targets).filter(m=>m.startsWith('KRW-')).slice(0, 200);
      if (!markets.length) { renderEmpty('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }

      const tickers = await fetchTickers(markets);
      if (!tickers.length) { renderEmpty('í‹°ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const rows = tickers.slice(0, MAX_ROWS).map(t=>{
        const info = marketInfo.get(t.market) || { k: t.market, e: '' };
        const adv = computeAdvice(t);
        return {
          name: info.k,
          market: t.market,
          price: t.trade_price,
          change: (t.signed_change_rate||0) * 100,
          buy: adv.buy, sell: adv.sell, sl: adv.sl, risk: adv.risk, say: adv.say
        };
      });
      renderTable(rows);
    }catch(e){
      console.error('ê²€ìƒ‰ ì‹¤íŒ¨', e);
      renderEmpty('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ===== ì´ë²¤íŠ¸ =====
  const doSearch = ()=> runSearch(inputEl && inputEl.value || '');
  const doSearchDebounced = debounce(doSearch, DEBOUNCE_MS);

  if (inputEl) {
    inputEl.addEventListener('input', doSearchDebounced);
    inputEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') doSearch(); });
  }
  if (btnEl) btnEl.addEventListener('click', doSearch);

  // í˜ì´ì§€ ì§„ì… ì‹œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤(ì„ íƒ)
  // inputEl && inputEl.focus();

})();  
</script>
<!-- ====== /ê²€ìƒ‰ íŒ¨ì¹˜ ë ====== --> 
</body>
</html>

