<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v6.6</title>
<style>
  :root{
    --bg:#0d1117;--panel:#111827;--muted:#9ca3af;--text:#e5e7eb;--green:#22c55e;--red:#ef4444;
    --amber:#f59e0b;--blue:#60a5fa;--chip:#1f2937;--chip2:#0b1220;
  }
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Apple Color Emoji,Segoe UI Emoji; margin:0}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#18212f;color:#b9d3ff;font-size:12px}
  .online{background:#0a2d14;color:#9effc1}
  .offline{background:#2a1313;color:#ffbdbd}
  .topbar{justify-content:space-between}
  input,button,select{background:#0f172a;border:1px solid #1f2937;color:#e5e7eb;padding:10px 12px;border-radius:8px}
  input{min-width:260px}
  button{cursor:pointer}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:14px;margin-top:14px}
  .panel h3{margin:0 0 12px 0;font-size:15px;color:#cbd5e1}
  .grid-head,.grid-row{display:grid;grid-template-columns: 40px 1.4fr 1fr 1fr 1fr 1fr 0.9fr 1.2fr;gap:8px;align-items:center}
  .grid-head{color:#9ca3af;font-size:12px;padding:8px 0;border-bottom:1px solid #223047}
  .grid-row{padding:10px 0;border-bottom:1px dashed #1e293b}
  .muted{color:var(--muted)}
  .chip{padding:4px 8px;border-radius:8px;background:var(--chip);font-size:12px}
  .chip-up{background:#05251a;color:#a5ffd0}
  .chip-dn{background:#2a1111;color:#ffc2c2}
  .risk{padding:4px 10px;border-radius:999px;font-size:12px}
  .r1{background:#0e2211;color:#9fffba}
  .r2{background:#261e07;color:#ffd98f}
  .r3{background:#2a1212;color:#ffb3b3}
  .note{background:#0b1220;border:1px solid #1e293b;border-left:3px solid #60a5fa;padding:8px 12px;border-radius:8px;margin-top:10px;color:#cbd5e1;font-size:13px}
  .cols{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .stat{background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:10px}
  .stat .t{font-size:12px;color:#9ca3af}
  .stat .v{font-weight:700;margin-top:6px}
  .danger{display:none;margin-top:8px}
  .danger.show{display:block}
  .right{margin-left:auto}
  .small{font-size:12px;color:#9ca3af}
  .blink{animation:bl 1.5s infinite}
  @keyframes bl{50%{opacity:.5}}
  .kbd{background:#111827;border:1px solid #293244;padding:2px 6px;border-radius:6px;font-size:11px;color:#a9b4c8}
</style>
</head>
<body>
<div class="wrap">
  <div class="row topbar">
    <div class="row">
      <strong>쩔어지갑 <span class="small">v6.6</span></strong>
      <span id="net" class="badge offline">OFFLINE</span>
      <span id="clock" class="badge">KST — --:--:--</span>
    </div>
    <div class="row">
      <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH)" />
      <button id="btnSearch" disabled>검색</button>
      <button id="btnReset">초기화</button>
    </div>
  </div>

  <div id="offlineBox" class="note danger">
    현재 네트워크 또는 API 연결이 불안정합니다. 데이터가 최신이 아닐 수 있습니다.
  </div>

  <div id="selected" class="panel" style="display:none">
    <h3>선택된 코인</h3>
    <div class="cols">
      <div class="stat"><div class="t">현재가</div><div id="s_price" class="v">-</div></div>
      <div class="stat"><div class="t">변동률</div><div id="s_rate" class="v">-</div></div>
      <div class="stat"><div class="t">매수</div><div id="s_bid" class="v">-</div></div>
      <div class="stat"><div class="t">매도</div><div id="s_ask" class="v">-</div></div>
      <div class="stat"><div class="t">손절</div><div id="s_cut" class="v">-</div></div>
      <div class="stat"><div class="t">위험도</div><div id="s_risk" class="v">-</div></div>
      <div class="stat"><div class="t">쩔어한마디</div><div id="s_msg" class="v">-</div></div>
    </div>
  </div>

  <div class="panel">
    <h3 class="row">
      <span>🔥 급등코인 Top 10 <span class="small">(조건: 실시간 기준)</span></span>
      <span id="refreshUp" class="small right">실시간 자동 정렬 중…</span>
    </h3>
    <div class="grid-head">
      <div>#</div><div>코인명(한글)</div><div>현재가</div><div>변동률</div><div>매수</div>
      <div>매도</div><div>손절</div><div>위험도 · 쩔어한마디</div>
    </div>
    <div id="up_rows"></div>
  </div>

  <div class="panel">
    <h3 class="row">
      <span>💧 급락코인 Top 10 <span class="small">(조건: 실시간 기준)</span></span>
      <span id="refreshDn" class="small right">실시간 자동 정렬 중…</span>
    </h3>
    <div class="grid-head">
      <div>#</div><div>코인명(한글)</div><div>현재가</div><div>변동률</div><div>매수</div>
      <div>매도</div><div>손절</div><div>위험도 · 쩔어한마디</div>
    </div>
    <div id="dn_rows"></div>
  </div>

  <div class="note" style="margin-bottom:24px">
    ⌨️ <span class="kbd">Enter</span> 로 검색, <span class="kbd">ESC</span> 로 초기화, 데이터는 12~15초 주기로 갱신됩니다.
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const state = {
    markets:[], // {market, korean_name, english_name}
    tickers:[], // last fetched tickers
    online:false,
    lastFetch:0
  };

  // ===== 공용 =====
  function fmt(n, d=0){
    if(n==null || isNaN(n)) return '-';
    return Number(n).toLocaleString('ko-KR',{maximumFractionDigits:d});
  }
  function pct(x){ return (x>0?'+':'') + (x*100).toFixed(2) + '%'; }
  function setNet(on){
    state.online = !!on;
    const el=$("#net");
    el.className='badge ' + (on?'online':'offline');
    el.textContent= on? 'ONLINE':'OFFLINE';
    $("#offlineBox").classList.toggle('show', !on);
    $("#btnSearch").disabled = !on || !state.markets.length;
  }
  function tickClock(){
    const k = new Date();
    $("#clock").textContent = 'KST — ' + k.toLocaleTimeString('ko-KR',{hour12:false});
  }
  setInterval(tickClock,1000); tickClock();

  // ===== API =====
  const API = {
    async markets(){
      const r = await fetch('/api/upbit?path=/v1/market/all?isDetails=true',{cache:'no-store'});
      if(!r.ok) throw new Error('markets '+r.status);
      return r.json();
    },
    async tickers(mkts){
      const r = await fetch('/api/upbit?path=/v1/ticker?markets='+encodeURIComponent(mkts.join(',')),{cache:'no-store'});
      if(!r.ok) throw new Error('tickers '+r.status);
      return r.json();
    }
  };

  // ===== 초기 로드 =====
  async function boot(){
    try{
      setNet(navigator.onLine);
      const mm = await API.markets();
      // KRW 마켓만 우선 사용
      state.markets = mm.filter(m=>/^KRW-/.test(m.market));
      $("#btnSearch").disabled = !state.online || !state.markets.length;
      loop(); // ticker 시작
    }catch(e){
      console.error(e);
      setNet(false);
      setTimeout(boot, 4000);
    }
  }

  // ===== 티커 루프 =====
  async function loop(){
    try{
      const mkts = state.markets.map(m=>m.market);
      // 너무 길면 분할
      const chunk = 80;
      let all=[];
      for(let i=0;i<mkts.length;i+=chunk){
        const part = mkts.slice(i,i+chunk);
        const arr = await API.tickers(part);
        all = all.concat(arr);
      }
      state.tickers = all;
      state.lastFetch = Date.now();
      setNet(true);
      renderLists();
    }catch(e){
      console.error(e);
      setNet(false);
    }finally{
      // 12초 간격
      setTimeout(loop, 12000);
    }
  }

  // ===== 입력 정규화 / 시장 찾기 =====
  function normalizeQuery(q){
    if(!q) return '';
    q = q.trim().toUpperCase().replace(/\s+/g,'');
    const alias = {
      'BTC':'KRW-BTC','비트':'KRW-BTC','비트코인':'KRW-BTC',
      'ETH':'KRW-ETH','이더':'KRW-ETH','이더리움':'KRW-ETH',
      'ETC':'KRW-ETC','이더리움클래식':'KRW-ETC','제로지':'KRW-OG', // 예시 별칭
    };
    if(alias[q]) return alias[q];
    // KRW-XXX 형태면 그대로
    if(/^KRW-[A-Z0-9]+$/.test(q)) return q;
    // 심볼만 주면 KRW- 붙여보기
    if(/^[A-Z0-9]{2,}$/.test(q)) return 'KRW-'+q;
    return q;
  }
  function resolveMarket(input){
    if(!state.markets.length) return null;
    const q = input.trim();
    if(!q) return null;

    // 1) 정규화 우선
    const norm = normalizeQuery(q);
    let found = state.markets.find(x=>x.market===norm);
    if(found) return found.market;

    // 2) 한글/영문/마켓코드 폭넓게
    const qLower = q.toLowerCase();
    found = state.markets.find(x =>
      x.korean_name.replace(/\s/g,'').toLowerCase().includes(qLower.replace(/\s/g,'')) ||
      (x.english_name||'').toLowerCase().includes(qLower) ||
      x.market.toLowerCase()===qLower
    );
    return found? found.market : null;
  }

  // ===== 위험도 / 메시지 / 손절 =====
  function riskLevel(t){
    // 변동성·체결강도 간단 버킷팅
    const r = Math.abs(t.signed_change_rate||0);
    if(r < 0.02) return {k:1, text:'1(안정)'};
    if(r < 0.05) return {k:2, text:'2(보통)'};
    return {k:3, text:'3(주의)'};
  }
  function zMsg(t){
    const r = t.signed_change_rate||0;
    if(r>=0.07) return '🚀 폭등 모드!';
    if(r>=0.03) return '🔥 불장 신호!';
    if(r<=-0.05) return '⚠️ 낙폭경계';
    return '👀 관망';
  }
  function priceStep(p){
  // ===== 업비트 호가단위 완전반영 =====
function priceStep(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000) return 100;
  if (p >= 100000) return 50;
  if (p >= 10000) return 10;
  if (p >= 1000) return 1;
  if (p >= 100) return 0.1;
  if (p >= 10) return 0.01;
  if (p >= 1) return 0.001;
  if (p >= 0.1) return 0.0001;
  if (p >= 0.01) return 0.00001;
  return 0.000001; // 극저가코인(시바이누 등)
}

// ===== 표시 자리수 자동판별 =====
function fmtPrice(p){
  if(p >= 1000) return p.toLocaleString('ko-KR', { maximumFractionDigits: 0 });
  if(p >= 100) return p.toFixed(1);
  if(p >= 10) return p.toFixed(2);
  if(p >= 1) return p.toFixed(3);
  if(p >= 0.1) return p.toFixed(4);
  if(p >= 0.01) return p.toFixed(5);
  return p.toFixed(6);
}

// ===== 매수·매도·손절 계산 =====
function roundToStep(x, step, dir=0){
  const factor = 1 / step;
  if (dir < 0) return Math.floor(x * factor) / factor;
  if (dir > 0) return Math.ceil(x * factor) / factor;
  return Math.round(x * factor) / factor;
}

function computeTap(t){
  const p = t.trade_price || 0;
  const step = priceStep(p);
  const bid = roundToStep(p * 0.998, step, -1); // 매수 -0.2%
  const ask = roundToStep(p * 1.002, step, +1); // 매도 +0.2%
  const cut = roundToStep(p * 0.98, step, 0);   // 손절 -2%
  return { bid, ask, cut };
}
  }
  function computeTap(t){
    const p = t.trade_price||0;
    const step = priceStep(p);
    const bid = roundToStep(t.bid_price||p, step, -1);
    const ask = roundToStep(t.ask_price||p, step, +1);
    const cut = roundToStep(p*0.98, step, 0); // 기본 2% 손절 기준
    return {bid, ask, cut};
  }

  // ===== 렌더 =====
  function rRow(i, t){
    const r = t.signed_change_rate||0;
    const taps = computeTap(t);
    const rk = riskLevel(t);
    return `
      <div class="grid-row">
        <div>${i}</div>
        <div>${t.korean_name||'-'} <span class="muted">(${t.market||''})</span></div>
        <div>${fmt(t.trade_price, (t.trade_price>=100?0:(t.trade_price>=1?2:4)))}</div>
        <div><span class="chip ${r>=0?'chip-up':'chip-dn'}">${pct(r)}</span></div>
        <div>${fmt(taps.bid, (taps.bid>=100?0:(taps.bid>=1?2:4)))}</div>
        <div>${fmt(taps.ask, (taps.ask>=100?0:(taps.ask>=1?2:4)))}</div>
        <div>${fmt(taps.cut, (taps.cut>=100?0:(taps.cut>=1?2:4)))}</div>
        <div>
          <span class="risk r${rk.k}">${rk.text}</span>
          &nbsp; <span class="muted">${zMsg(t)}</span>
        </div>
      </div>
    `;
  }

  function mergeTickerName(tk){
    const m = state.markets.find(x=>x.market===tk.market);
    return Object.assign({}, tk, { korean_name: m? m.korean_name : '-', english_name: m? m.english_name : '-' });
  }

  function renderLists(){
    if(!state.tickers.length) return;
    // 변동률 기준 정렬
    const merged = state.tickers.map(mergeTickerName).filter(t=>isFinite(t.signed_change_rate||0));
    const ups = merged.slice().sort((a,b)=>(b.signed_change_rate)-(a.signed_change_rate)).slice(0,10);
    const dns = merged.slice().sort((a,b)=>(a.signed_change_rate)-(b.signed_change_rate)).slice(0,10);

    $("#up_rows").innerHTML = ups.map((t,i)=>rRow(i+1,t)).join('');
    $("#dn_rows").innerHTML = dns.map((t,i)=>rRow(i+1,t)).join('');
  }

  function renderSelectedByMarket(market){
    const t = state.tickers.find(x=>x.market===market);
    if(!t){ alert('데이터 준비 중입니다. 잠시 후 다시 시도해주세요.'); return; }
    const tt = mergeTickerName(t);
    const taps = computeTap(t);
    const rk = riskLevel(t);
    $("#s_price").textContent = fmt(t.trade_price, t.trade_price>=100?0:(t.trade_price>=1?2:4));
    $("#s_rate").innerHTML   = (t.signed_change_rate>=0?'+':'')+ (t.signed_change_rate*100).toFixed(2)+'%';
    $("#s_bid").textContent  = fmt(taps.bid,  taps.bid>=100?0:(taps.bid>=1?2:4));
    $("#s_ask").textContent  = fmt(taps.ask,  taps.ask>=100?0:(taps.ask>=1?2:4));
    $("#s_cut").textContent  = fmt(taps.cut,  taps.cut>=100?0:(taps.cut>=1?2:4));
    $("#s_risk").textContent = rk.text;
    $("#s_msg").textContent  = zMsg(t);
    $("#selected").style.display='block';
  }

  // ===== 이벤트 =====
  function doSearch(){
    if(!state.online || !state.markets.length){
      alert('데이터를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
      return;
    }
    const val = $("#q").value.trim();
    if(!val){ $("#selected").style.display='none'; return; }
    const m = resolveMarket(val);
    if(!m){ alert('코인을 찾지 못했습니다. (한글/영문/심볼/마켓코드 지원)'); return; }
    renderSelectedByMarket(m);
  }
  $("#btnSearch").addEventListener('click', doSearch);
  $("#btnReset").addEventListener('click', ()=>{
    $("#q").value=''; $("#selected").style.display='none';
  });
  $("#q").addEventListener('keydown', e=>{
    if(e.key==='Enter') doSearch();
    else if(e.key==='Escape'){ $("#q").value=''; $("#selected").style.display='none'; }
  });

  // 네트워크 상태 감지
  window.addEventListener('online',  ()=> setNet(true));
  window.addEventListener('offline', ()=> setNet(false));

  // 부트
  boot();
})();
</script>
</body>
</html>

