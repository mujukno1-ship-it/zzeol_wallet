<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v7.0 â€” ì†ë„íŒ¨ì¹˜ ì•ˆì •íŒ</title>
<style>
  :root{
    --bg:#0f141a;--panel:#121821;--muted:#9fb0c3;--text:#d7e2f2;--green:#2bd093;--red:#ff5a6f;--line:#1c2733;--chip:#0f1722;--badge:#0e1724
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
  .title{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{background:var(--badge);color:#bcd0e6;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px}
  .bar{display:flex;gap:8px;margin-bottom:12px}
  .bar .grow{flex:1}
  .ipt{width:100%;background:#0c1219;border:1px solid var(--line);color:var(--text);padding:12px;border-radius:10px;outline:none}
  .btn{background:#0c1219;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#2a3a4d}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .panel + .panel{margin-top:10px}
  .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);background:#0f1722;font-size:14px;color:#bcd0e6;display:flex;justify-content:space-between;align-items:center}
  .summary{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:10px 12px}
  .cell{background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:10px}
  .ttl{font-size:12px;color:#9fb0c3;margin-bottom:6px}
  .val{font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);white-space:nowrap}
  th{background:#0f1722;color:#9fb0c3;font-weight:600;text-align:right}
  td{text-align:right}
  th:first-child,td:first-child{text-align:center}
  th:nth-child(2),td:nth-child(2){text-align:left}
  .green{color:var(--green)} .red{color:var(--red)}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1722;color:#cfe2ff;font-size:12px}
  .footer{margin-top:12px;color:#8597ab}
  /* ê¸‰ë“±(ìœ„) â†’ ê¸‰ë½(ì•„ë˜) ì„¸ë¡œ ì •ë ¬ */
  .stack{display:flex;flex-direction:column;gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <span class="badge">ì©”ì–´ì§€ê°‘ v7.0</span>
    <span class="badge" id="net">ONLINE</span>
    <span class="badge" id="clock">KST â€” --:--:--</span>
    <span class="badge">ì—…ë¹„íŠ¸ í˜¸ê°€ë™ê¸°í™”Â·ì†ë„íŒ¨ì¹˜</span>
  </div>

  <!-- ê²€ìƒ‰ë°” + ë¡œì»¬ ìë™ì™„ì„± -->
  <div class="bar">
    <input id="q" class="ipt grow" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH / ë³´ë¼ / BORA)" list="coins_datalist" />
    <datalist id="coins_datalist"></datalist>
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒì½”ì¸ ìš”ì•½: í•œ ì¤„ 8ì¹¸ -->
  <div class="panel">
    <div class="summary" id="selectedSummary">
      <!-- JSê°€ ì±„ì›€ -->
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½: í•­ìƒ ì„¸ë¡œ(ê¸‰ë“± ìœ„, ê¸‰ë½ ì•„ë˜) -->
  <div class="stack">
    <div class="panel">
      <h3><span>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</span><button class="btn" id="btnRiseRefresh">ìƒˆë¡œê³ ì¹¨</button></h3>
      <table id="riseTable">
        <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
            <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h3><span>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</span><button class="btn" id="btnFallRefresh">ìƒˆë¡œê³ ì¹¨</button></h3>
      <table id="fallTable">
        <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th>
            <th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    â“˜ ì‹¤ì‹œê°„ ìë™ ì •ë ¬ Â· ë¡œì»¬ ê²€ìƒ‰ ì¸ë±ìŠ¤ Â· 429 ë°±ì˜¤í”„ Â· ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ë™ê¸°í™”
  </div>
</div>

<script>
/* ========= ê³µìš© ========= */
const API = (p) => `/api/upbit?path=${encodeURIComponent(p)}`;
function tickClock(){
  const now=new Date();
  document.getElementById('clock').textContent='KST â€” '+now.toLocaleTimeString('ko-KR',{hour12:false});
}
setInterval(tickClock,1000); tickClock();

/* ========= í˜¸ê°€/í¬ë§· ========= */
function priceUnit(p){
  if (p >= 2_000_000) return 1_000;
  if (p >= 1_000_000) return 500;
  if (p >= 500_000)  return 100;
  if (p >= 100_000)  return 50;
  if (p >= 10_000)   return 10;
  if (p >= 1_000)    return 1;
  if (p >= 100)      return 0.1;
  if (p >= 10)       return 0.01;
  if (p >= 1)        return 0.001;
  if (p >= 0.1)      return 0.0001;
  if (p >= 0.01)     return 0.00001;
  return 0.000001;
}
function roundHoga(x){
  const u=priceUnit(x), f=1/u;
  return Math.round(x*f)/f;
}
function fmtKRW(x){
  if (x==null || Number.isNaN(x)) return '-';
  const u=priceUnit(Math.abs(x));
  const d=(u<1)?String(u).split('.')[1].length:0;
  return x.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function fmtRate(r){ const p=(r*100).toFixed(2)+'%'; return r>=0?`<span class="green">${p}</span>`:`<span class="red">${p}</span>`; }

/* ========= ê²€ìƒ‰ ì¸ë±ìŠ¤ (ë¡œì»¬, ì´ˆê³ ì†) ========= */
let MARKETS=[];                   // KRW-* only
let NAME_MAP=new Map();           // ë‹¤ì–‘í•œ í‚¤ -> market
let IDX=[];                       // {market, key, sym, ko, en}
const $q = document.getElementById('q');
const $dl= document.getElementById('coins_datalist');

function norm(s){return String(s||'').toLowerCase().replace(/\s+/g,'');}

async function buildIndex(){
  const r=await fetch(API('/v1/market/all?isDetails=true'),{cache:'no-store'});
  const arr=await r.json();
  MARKETS = arr.filter(m=>m.market.startsWith('KRW-'));
  NAME_MAP.clear(); IDX.length=0; $dl.innerHTML='';
  for (const m of MARKETS){
    const sym = m.market.replace('KRW-','');
    NAME_MAP.set(m.market, m.market);
    NAME_MAP.set(sym, m.market);
    NAME_MAP.set((m.korean_name||'').trim(), m.market);
    NAME_MAP.set((m.english_name||'').toUpperCase(), m.market);
    IDX.push({
      market:m.market,
      sym:norm(sym),
      ko:norm(m.korean_name||''),
      en:norm(m.english_name||''),
      key:norm(`${m.korean_name}${m.english_name}${sym}${m.market}`)
    });
  }
}

function suggest(q){
  q=norm(q);
  if(!q) return [];
  const hits=[];
  for (const it of IDX){
    let score=0;
    if (it.sym===q) score+=10;
    if (it.ko===q || it.en===q) score+=9;
    if (it.key.includes(q)) score+=5;
    if (it.sym.startsWith(q)) score+=4;
    if (it.ko.startsWith(q) || it.en.startsWith(q)) score+=3;
    if (score>0) hits.push({m:it.market,score});
  }
  hits.sort((a,b)=>b.score-a.score);
  return hits.slice(0,15).map(h=>MARKETS.find(mm=>mm.market===h.m));
}
function renderDatalist(list){
  const frag=document.createDocumentFragment();
  list.forEach(it=>{
    const op=document.createElement('option');
    op.value=`${it.korean_name} (${it.market})`;
    frag.appendChild(op);
  });
  $dl.innerHTML=''; $dl.appendChild(frag);
}

/* ========= ì‹¤ì‹œê°„ ë°ì´í„° ========= */
async function fetchTickers(mkts){
  if(!mkts.length) return [];
  const out=[]; const B=90;
  for(let i=0;i<mkts.length;i+=B){
    const part=mkts.slice(i,i+B).join(',');
    const r=await fetch(API(`/v1/ticker?markets=${encodeURIComponent(part)}`),{cache:'no-store'});
    if(!r.ok) continue;
    out.push(...await r.json());
  }
  return out;
}
async function fetchOrderbook(mkts){
  if(!mkts.length) return [];
  const out=[]; const B=50;
  for(let i=0;i<mkts.length;i+=B){
    const part=mkts.slice(i,i+B).join(',');
    const r=await fetch(API(`/v1/orderbook?markets=${encodeURIComponent(part)}`),{cache:'no-store'});
    if(!r.ok) continue;
    out.push(...await r.json());
  }
  return out;
}

/* ========= ë¶„ì„(ìœ„í—˜ë„/íƒ€ì /ë©”ì‹œì§€) ========= */
function analyze(t, ob){
  const ch=t.signed_change_rate||0, p=t.trade_price||0;
  let bidSum=0,askSum=0;
  const units = ob?.orderbook_units?.slice(0,10)||[];
  units.forEach(u=>{ bidSum+=u.bid_size; askSum+=u.ask_size; });
  const im = bidSum/(askSum||1);

  const buy  = roundHoga(p*(ch>0?0.996:0.992));
  const sell = roundHoga(p*(ch>0?1.004:1.006));
  const stop = roundHoga(p*(ch>0?0.985:0.975));

  let risk='1(ì•ˆì •)';
  if (Math.abs(ch)>0.05 || im>1.6 || im<0.65) risk='3(ì£¼ì˜)';
  else if (Math.abs(ch)>0.02 || im>1.25 || im<0.8) risk='2(ë³´í†µ)';

  let note='ê´€ë§';
  if (ch>0.06 && im>1.3) note='ğŸš€ í­ë“± ëª¨ë“œ!';
  else if (ch>0.02 && im>1.2) note='ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  else if (ch<-0.06 && im<0.8) note='ğŸ“‰ ë‚™í­ê²½ê³„';

  return {buy,sell,stop,risk,note};
}

/* ========= ë Œë” ========= */
function fillSelectedSummary(row){
  const el=document.getElementById('selectedSummary');
  if(!row){
    el.innerHTML = Array.from({length:8}).map(()=>`
      <div class="cell"><div class="ttl">-</div><div class="val">â€”</div></div>`).join('');
    return;
  }
  el.innerHTML = `
    <div class="cell"><div class="ttl">ì„ íƒëœ ì½”ì¸</div><div class="val">${row.korean_name} <span class="muted">(${row.market})</span></div></div>
    <div class="cell"><div class="ttl">í˜„ì¬ê°€</div><div class="val">${fmtKRW(row.trade_price)}</div></div>
    <div class="cell"><div class="ttl">ë³€ë™ë¥ </div><div class="val">${fmtRate(row.signed_change_rate)}</div></div>
    <div class="cell"><div class="ttl">ë§¤ìˆ˜</div><div class="val">${fmtKRW(row.buy)}</div></div>
    <div class="cell"><div class="ttl">ë§¤ë„</div><div class="val">${fmtKRW(row.sell)}</div></div>
    <div class="cell"><div class="ttl">ì†ì ˆ</div><div class="val">${fmtKRW(row.stop)}</div></div>
    <div class="cell"><div class="ttl">ìœ„í—˜ë„</div><div class="val">${row.risk}</div></div>
    <div class="cell"><div class="ttl">ì©”ì–´í•œë§ˆë””</div><div class="val">${row.note}</div></div>
  `;
}
function renderTable(tbody, rows){
  const frag=document.createDocumentFragment();
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.korean_name} <span class="muted">(${r.market})</span></td>
      <td>${fmtKRW(r.trade_price)}</td>
      <td>${fmtRate(r.signed_change_rate)}</td>
      <td>${fmtKRW(r.buy)}</td>
      <td>${fmtKRW(r.sell)}</td>
      <td>${fmtKRW(r.stop)}</td>
      <td>${r.risk}</td>
      <td><span class="tag">${r.note}</span></td>`;
    frag.appendChild(tr);
  });
  tbody.innerHTML=''; tbody.appendChild(frag);
}

/* ========= ë©”ì¸ ë£¨í”„ ========= */
let LAST_MARKET=null;
let LAST_ROWS=null;

async function refreshAll(selectMarket=null){
  // ì¸ë±ìŠ¤(ë§ˆì¼“) ì¤€ë¹„
  if(!MARKETS.length) await buildIndex();

  const mkts = MARKETS.map(m=>m.market);
  const [ticks, books] = await Promise.all([fetchTickers(mkts), fetchOrderbook(mkts)]);
  const obMap = new Map(books.map(b=>[b.market,b]));
  const nameMap = new Map(MARKETS.map(m=>[m.market,m.korean_name]));

  const rows = ticks.map(t=>{
    const a=analyze(t, obMap.get(t.market));
    return {...t, korean_name:nameMap.get(t.market)||t.market, ...a};
  });
  LAST_ROWS = rows;

  const rising = [...rows].filter(r=>r.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const falling= [...rows].filter(r=>r.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);

  renderTable(document.querySelector('#riseTable tbody'), rising);
  renderTable(document.querySelector('#fallTable tbody'), falling);

  const m = selectMarket || LAST_MARKET;
  const sel = m ? rows.find(r=>r.market===m) : null;
  fillSelectedSummary(sel);
}

/* ========= ê²€ìƒ‰(ì´ˆê³ ì†) ========= */
function resolveMarket(query){
  if(!query) return null;
  const q = query.trim();
  // "(KRW-XXX)" í˜•ì‹ì—ì„œ ì¶”ì¶œ
  const m = q.match(/\((KRW-[A-Z0-9]+)\)\s*$/i);
  if (m) return m[1].toUpperCase();

  // ì™„ì „ì¼ì¹˜ ìš°ì„ 
  if (NAME_MAP.has(q)) return NAME_MAP.get(q);
  if (NAME_MAP.has(q.toUpperCase())) return NAME_MAP.get(q.toUpperCase());

  // ë¶€ë¶„ì¼ì¹˜: ì œì•ˆ ìƒìœ„ 1ê°œ
  const s = suggest(q);
  return s[0]?.market || null;
}

function updateDatalist(){
  const list=suggest($q.value);
  const frag=document.createDocumentFragment();
  list.forEach(it=>{
    const op=document.createElement('option');
    op.value=`${it.korean_name} (${it.market})`;
    frag.appendChild(op);
  });
  $dl.innerHTML=''; $dl.appendChild(frag);
}

let typingTimer;
$q.addEventListener('input', ()=>{
  clearTimeout(typingTimer);
  typingTimer = setTimeout(updateDatalist, 160); // 160ms ë””ë°”ìš´ìŠ¤
});
$q.addEventListener('keydown', e=>{
  if(e.key==='Enter'){ doSearch(); }
});

function doSearch(){
  const m = resolveMarket($q.value);
  if(!m){ alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }
  LAST_MARKET = m;
  if (LAST_ROWS){
    const sel = LAST_ROWS.find(r=>r.market===m);
    if (sel) { fillSelectedSummary(sel); return; }
  }
  // ì„ íƒì½”ì¸ë§Œ ë°˜ì˜í•˜ë„ë¡ ì „ì²´ ê°±ì‹ 
  refreshAll(m);
}
document.getElementById('btnSearch').onclick = doSearch;
document.getElementById('btnReset').onclick  = ()=>{ $q.value=''; LAST_MARKET=null; fillSelectedSummary(null); };
document.getElementById('btnRiseRefresh').onclick = ()=>refreshAll(LAST_MARKET);
document.getElementById('btnFallRefresh').onclick = ()=>refreshAll(LAST_MARKET);

/* ========= ë¶€íŒ… ========= */
refreshAll();
// 15ì´ˆ ê°„ê²© ìë™ ê°±ì‹ 
setInterval(()=>refreshAll(LAST_MARKET), 15000);
</script>
</body>
</html>
