<script>
/* ──────────────────────────────────────────────────────────────
   쩔어지갑 v6.x 올인원 패치
   - 기존 기능 유지 (UI/표 구조 동일)
   - 새로운 기능 추가: 업비트 실시간 WS + 자동 폴백(1초 REST)
   - 오류 수정: 429 회피, 끊김 자동 복구, 무효 마켓코드 필터, 안전 기본값
   - 급등/급락 스캐너 안정화(조건 완화/최소조건 폴백)
   ────────────────────────────────────────────────────────────── */

/* ========== 안전 유틸(없으면 주입) ========== */
const fmtKRW = (typeof window.fmtKRW === 'function')
  ? window.fmtKRW
  : (n)=> (Math.round(n).toLocaleString('ko-KR'));

function riskClass(r){
  const a = Math.abs(r||0);
  return a>0.12?'risk-4':a>0.08?'risk-3':a>0.04?'risk-2':'risk-1';
}
function riskText(r){
  const a = Math.abs(r||0);
  return a>0.12?'4(초고)':a>0.08?'3(주의)':a>0.04?'2(보통)':'1(안정)';
}
function zzeolComment(r){
  if (r>0.12) return '🚀 폭등 모드!';
  if (r>0.05) return '🔥 불장 신호!';
  if (r<-0.12) return '🧯 급락 주의';
  if (r<-0.05) return '⚠ 하락 신호';
  return '👀 관망';
}

/* ========== 마켓/한글명 로딩 ========== */
const NAME_BY_MARKET = window.NAME_BY_MARKET || {};
async function ensureMarkets(){
  if (Object.keys(NAME_BY_MARKET).length) return;
  try{
    const r = await fetch('https://api.upbit.com/v1/market/all?isDetails=true',{cache:'no-store'});
    const arr = await r.json();
    arr.filter(x=>x.market.startsWith('KRW-')).forEach(x=>{
      NAME_BY_MARKET[x.market] = x.korean_name || x.english_name || x.market.replace('KRW-','');
    });
    console.log('[MARKETS] loaded', Object.keys(NAME_BY_MARKET).length);
  }catch(e){ console.warn('[MARKETS] load failed', e); }
}
function ko(m){
  return (NAME_BY_MARKET[m] || m.replace('KRW-',''));
}

/* ========== 상태 배지 표시 ========== */
function mark(status){
  const n = document.getElementById('net');
  if(!n) return;
  if(status==='ONLINE'){ n.textContent='ONLINE'; n.style.background='#123922'; }
  else { n.textContent='OFFLINE'; n.style.background='#3a1a1a'; }
}

/* ========== 업비트 실시간 동기화 (WS + 폴백) ========== */
(function(){
  const WS_URL = 'wss://api.upbit.com/websocket/v1';
  let ws=null, alive=false, reconnectTimer=null, pollTimer=null;

  const FORCE_POLL = /[?&]poll=1\b/.test(location.search);
  window.addEventListener('online', ()=>{ try{ if(ws) ws.close(); }catch(_){ } connect(); });
  window.addEventListener('offline',()=>{ startPolling(); mark('OFFLINE'); });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ try{ if(ws) ws.close(); }catch(_){ } connect(); }});

  const isMarket = (m)=> /^KRW-[A-Z0-9]{2,}$/.test(m||'');

  function collectMarkets(){
    const set = new Set();
    const selMkt = document.getElementById('selMarket');
    if (selMkt){
      const m = (selMkt.textContent||'').trim();
      if (isMarket(m)) set.add(m);
    }
    document.querySelectorAll('#feedUp tr[data-market], #feedDown tr[data-market]').forEach(tr=>{
      const m = tr.getAttribute('data-market'); if(isMarket(m)) set.add(m);
    });
    const list = Array.from(set).filter(isMarket);
    if (list.length===0) list.push('KRW-BTC');
    return list.slice(0,80);
  }

  function applyTicker(t){
    const market = t.code || t.market;
    const price  = t.trade_price;
    const rate   = (t.signed_change_rate ?? 0);

    // 검색 카드
    const selMkt = document.getElementById('selMarket');
    if (selMkt && (selMkt.textContent||'').trim()===market){
      const asKRW=(x)=>fmtKRW(x);
      const calc=(window.calcTradeLevels||(p=>({buy:p*0.988,sell:p*1.012,stop:p*0.975})));
      const L = calc(price, rate);
      const priceEl=document.getElementById('s_price');
      const rateEl =document.getElementById('s_rate');
      const ids=['s_buy','s_sell','s_stop']; const vals=[L.buy,L.sell,L.stop];
      if(priceEl) priceEl.textContent=asKRW(price);
      if(rateEl) rateEl.innerHTML=`<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
      ids.forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.textContent=asKRW(vals[i]); });
    }

    // 급등/급락 표
    document.querySelectorAll(`tr[data-market="${market}"]`).forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if (tds.length>=9){
        const asKRW=(x)=>fmtKRW(x);
        const calc=(window.calcTradeLevels||(p=>({buy:p*0.988,sell:p*1.012,stop:p*0.975})));
        const L=calc(price, rate);
        tds[2].textContent = asKRW(price);
        tds[3].innerHTML   = `<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
        tds[4].textContent = asKRW(L.buy);
        tds[5].textContent = asKRW(L.sell);
        tds[6].textContent = asKRW(L.stop);
      }
    });
  }

  function connect(){
    const codes = collectMarkets();
    console.log('[WS] subscribe', codes);
    if (FORCE_POLL){ console.log('[WS] force poll mode'); startPolling(); return; }
    if (!codes.length){ startPolling(); return; }

    try{
      stopPolling();
      if (ws){ try{ws.close();}catch(_){ } ws=null; }
      ws = new WebSocket(WS_URL);
      ws.binaryType='blob';

      ws.onopen = ()=>{
        alive = true; mark('ONLINE');
        const msg = [{ticket:'zzeol-wallet'},{type:'ticker',codes,isOnlyRealtime:true}];
        ws.send(JSON.stringify(msg));
        console.log('[WS] opened');
      };
      ws.onmessage = async (e)=>{
        try{
          const text = await e.data.text();
          const data = JSON.parse(text);
          applyTicker(data);
        }catch(_){}
      };
      ws.onclose = ()=>{ alive=false; scheduleReconnect(); };
      ws.onerror = ()=>{ alive=false; scheduleReconnect(); };
    }catch(e){
      console.warn('[WS] connect fail', e); scheduleReconnect();
    }
  }
  function scheduleReconnect(){
    if (reconnectTimer) return;
    reconnectTimer=setTimeout(()=>{ reconnectTimer=null; connect(); }, 1500);
    startPolling(); mark('OFFLINE');
  }
  function startPolling(){
    if (pollTimer) return;
    console.log('[POLL] start');
    const api='https://api.upbit.com/v1/ticker?markets=';
    pollTimer=setInterval(async ()=>{
      const mkts=collectMarkets(); if(!mkts.length) return;
      try{
        const r=await fetch(api+encodeURIComponent(mkts.join(',')),{cache:'no-store'});
        if(!r.ok) throw 0;
        const arr=await r.json();
        arr.forEach(applyTicker);
      }catch(_){}
    },1000);
  }
  function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; console.log('[POLL] stop'); } }

  connect();
  setInterval(()=>{ if(alive){ try{ws.close();}catch(_){ } } connect(); }, 60000); // 1분마다 재구독
})();

/* ========== 급등/급락 스캐너 안정화 (429 회피 + 조건 완화/폴백) ========== */
async function fetchJSONWithFallback(url, timeout=9000){
  const PROXIES = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
  for (let i=0;i<PROXIES.length;i++){
    try{
      const ctrl=new AbortController();
      const timer=setTimeout(()=>ctrl.abort(), timeout);
      const r=await fetch(PROXIES[i]+url, {signal:ctrl.signal, cache:'no-store'});
      clearTimeout(timer);
      if(!r.ok) throw 0;
      return await r.json();
    }catch(e){
      if (i===PROXIES.length-1) throw e;
    }
  }
}
async function fetchAllTickersSafe(){
  await ensureMarkets();
  const markets = Object.keys(NAME_BY_MARKET); // KRW-만 포함
  const chunkSize=50, chunks=[];
  for(let i=0;i<markets.length;i+=chunkSize) chunks.push(markets.slice(i,i+chunkSize));

  const results=[];
  for(const part of chunks){
    let ok=false, batch=[];
    try{
      const r=await fetch('https://api.upbit.com/v1/ticker?markets='+encodeURIComponent(part.join(',')),{cache:'no-store'});
      if (r.ok){ batch=await r.json(); ok=true; }
    }catch(_){}
    if(!ok){
      try{ batch=await fetchJSONWithFallback('https://api.upbit.com/v1/ticker?markets='+part.join(',')); ok=true; }catch(_){}
    }
    if (ok && Array.isArray(batch)) results.push(...batch);
    await new Promise(r=>setTimeout(r,250)); // 429 방지 텀
  }
  console.log('[SCAN] collected tickers:', results.length);
  return results;
}

function renderList(tbodyId, arr, reorder){
  const el=document.getElementById(tbodyId); if(!el) return;
  if(!arr||arr.length===0){
    el.innerHTML = `<tr><td colspan="9" class="muted">${tbodyId==='feedUp'?'조건에 맞는 급등코인이 현재 없습니다.':'조건에 맞는 급락코인이 현재 없습니다.'}</td></tr>`;
    return;
  }
  if(!reorder) el.innerHTML='';
  for(let i=arr.length-1;i>=0;i--){
    const t=arr[i], p=t.trade_price, r=t.signed_change_rate, m=t.market;
    const calc=(window.calcTradeLevels||(x=>({buy:x*0.988,sell:x*1.012,stop:x*0.975})));
    const L=calc(p,r);
    const html = `
      <td class="rank"></td>
      <td>${ko(m)}</td>
      <td>${fmtKRW(p)}</td>
      <td class="chg ${r>=0?'up':'down'}">${(r*100).toFixed(2)}%</td>
      <td>${fmtKRW(L.buy)}</td>
      <td>${fmtKRW(L.sell)}</td>
      <td>${fmtKRW(L.stop)}</td>
      <td><span class="risk ${riskClass(r)}">${riskText(r)}</span></td>
      <td>${zzeolComment(r)}</td>
    `;
    const row = el.querySelector(`tr[data-market="${m}"]`);
    if(row){ row.innerHTML=html; row.classList.add('flash'); el.prepend(row); setTimeout(rr=>rr.classList.remove('flash'),800,row); }
    else   { const tr=document.createElement('tr'); tr.dataset.market=m; tr.classList.add('flash'); tr.innerHTML=html; el.prepend(tr); setTimeout(rr=>rr.classList.remove('flash'),800,tr); }
  }
  while(el.children.length>10) el.removeChild(el.lastChild);
  el.querySelectorAll('tr').forEach((r,i)=>{ const c=r.querySelector('.rank'); if(c) c.textContent=(i+1); });
}

async function scanOnce(){
  try{
    const all = await fetchAllTickersSafe();
    const upBadge=document.getElementById('upSource');
    const dnBadge=document.getElementById('downSource');
    if(upBadge) upBadge.style.display='none';
    if(dnBadge) dnBadge.style.display='none';

    // 1차 기준(기본값)
    const ups1 = all.filter(t=>(t.signed_change_rate||0)> 0.05 && (t.acc_trade_price_24h||0)>=1_000_000_000)
                    .sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
    const dns1 = all.filter(t=>(t.signed_change_rate||0)<-0.05 && (t.acc_trade_price_24h||0)>=  500_000_000)
                    .sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);

    let ups=ups1, dns=dns1;

    // 2차 완화
    if(ups.length===0){
      ups = all.filter(t=>(t.signed_change_rate||0)> 0.03 && (t.acc_trade_price_24h||0)>=300_000_000)
               .sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
      if(upBadge){ upBadge.textContent='완화'; upBadge.style.display='inline-block'; }
    }
    if(dns.length===0){
      dns = all.filter(t=>(t.signed_change_rate||0)<-0.03 && (t.acc_trade_price_24h||0)>=300_000_000)
               .sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
      if(dnBadge){ dnBadge.textContent='완화'; dnBadge.style.display='inline-block'; }
    }

    // 3차 최소조건
    if(ups.length===0){
      ups = all.filter(t=>(t.acc_trade_price_24h||0)>=100_000_000)
               .sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
      if(upBadge){ upBadge.textContent='최소조건'; upBadge.style.display='inline-block'; }
    }
    if(dns.length===0){
      dns = all.filter(t=>(t.acc_trade_price_24h||0)>=100_000_000)
               .sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
      if(dnBadge){ dnBadge.textContent='최소조건'; dnBadge.style.display='inline-block'; }
    }

    console.log('[SCAN] ups:', ups.length, 'downs:', dns.length);
    renderList('feedUp', ups, true);
    renderList('feedDown', dns, true);
    mark('ONLINE');
  }catch(e){
    console.error('[SCAN] fail', e);
    renderList('feedUp', [], false);
    renderList('feedDown', [], false);
    mark('OFFLINE');
  }
}

/* ========== 부팅: 캐시 표시 → 실데이터 덮어쓰기 → 1분 주기 갱신 ========== */
(function bootStableFeed(){
  try{
    const loadFeedCache = window.loadFeedCache || null;
    if(loadFeedCache){
      const cache = loadFeedCache();
      if (cache){
        const inflate=arr=>(arr||[]).map(x=>({market:x.m, trade_price:x.p, signed_change_rate:x.r}));
        const ups=inflate(cache.ups), downs=inflate(cache.downs);
        if(ups.length){ renderList('feedUp',ups,true); const b=document.getElementById('upSource'); if(b){ b.textContent='캐시'; b.style.display='inline-block'; } }
        if(downs.length){ renderList('feedDown',downs,true); const b=document.getElementById('downSource'); if(b){ b.textContent='캐시'; b.style.display='inline-block'; } }
      }
    }
  }catch(_){}

  scanOnce();
  setInterval(scanOnce, 60*1000);
})();
</script>
