<script>
// ===== ê¸‰ë“± í”¼ë“œ (í•­ìƒ 'ìµœì‹  ê°ì§€'ê°€ ë§¨ ìœ„) =====
const FEED_KEY = 'zzeol_hot_feed_v1';
const FEED_TTL_HOURS = 24;
const rowBySym = new Map(); // ì‹¬ë³¼ -> <tr> ë§¤í•‘
let storeCache = [];        // ì €ì¥ì†Œ ìºì‹œ (ìµœì‹ ì´ ì•)

function loadFeedFromStore() {
  try {
    const raw = localStorage.getItem(FEED_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    const now = Date.now();
    return arr.filter(x => now - x.ts < FEED_TTL_HOURS * 3600 * 1000).slice(0, 100);
  } catch { return []; }
}
function saveFeedToStore(items) {
  try { localStorage.setItem(FEED_KEY, JSON.stringify(items.slice(0, 100))); }
  catch (e) { console.warn('feed save failed', e); }
}
function renderFeed(items) {
  const feed = document.getElementById('hotFeed');
  feed.innerHTML = '';
  rowBySym.clear();
  for (const it of items) {
    const tr = document.createElement('tr');
    tr.style.textAlign = 'center';
    tr.innerHTML = `
      <td>ğŸ’¥ ${it.nameKo || it.sym}</td>
      <td>${it.price}</td>
      <td>${it.buy}</td>
      <td>${it.sell}</td>
      <td>${it.stop}</td>
      <td>${it.risk}</td>
      <td>${it.comment}</td>`;
    feed.appendChild(tr);
    rowBySym.set(it.sym, tr);
  }
  storeCache = items;
}
document.getElementById('btnFeedClear')?.addEventListener('click', () => {
  localStorage.removeItem(FEED_KEY);
  renderFeed([]);
  alert('ê¸‰ë“± í”¼ë“œë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤.');
});

// ìœ í‹¸: ë°°ì—´ ë§¨ ì•ì— ìµœì‹ ìœ¼ë¡œ ë„£ë˜ ì¤‘ë³µ ì œê±°
function upsertFront(entry) {
  storeCache = [entry, ...storeCache.filter(x => x.sym !== entry.sym)];
  saveFeedToStore(storeCache);
}

// ì—…ë¹„íŠ¸ ìš”ì²­ ë³´ì¡°
function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
async function fetchJSON(url, {timeout=8000, retries=2, backoff=500}={}) {
  for (let a=0; a<=retries; a++) {
    const ctrl = new AbortController(); const timer = setTimeout(()=>ctrl.abort(), timeout);
    try {
      const res = await fetch(url, {signal: ctrl.signal, cache: 'no-store'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    } catch (e) {
      if (a === retries) throw e;
      await new Promise(r => setTimeout(r, backoff * Math.pow(2,a)));
    } finally { clearTimeout(timer); }
  }
}
async function getTickersBatch(markets){
  const parts = chunk(markets, 60);
  const out = [];
  for (const p of parts) {
    const r = await fetchJSON('https://api.upbit.com/v1/ticker?markets='+p.join(',')); 
    out.push(...r);
  }
  return out;
}

// í•µì‹¬: ìƒˆë¡œ ê°ì§€ë˜ë©´ (ì´ë¯¸ í‘œì— ìˆì–´ë„) ê°’ ì—…ë°ì´íŠ¸ + ë§¨ ìœ„ë¡œ ì´ë™
async function loadHotOnce() {
  const list = await ensureMarkets();      // <- ë„ˆì˜ ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ë¨
  const tickers = await getTickersBatch(list.map(x => x.market));
  const hot = tickers
    .filter(t => t.signed_change_rate > 0.05 && t.acc_trade_price_24h > 10_000_000_000)
    .sort((a,b)=> b.signed_change_rate - a.signed_change_rate);

  const feed = document.getElementById('hotFeed');

  for (const t of hot) {
    const market = t.market;
    const sym = market.replace('KRW-','');
    const nameKo = (typeof NAME_KO !== 'undefined' && NAME_KO.get) ? (NAME_KO.get(market) || sym) : sym;

    const p = t.trade_price, rate = t.signed_change_rate;
    const entry = {
      ts: Date.now(),
      sym,
      nameKo,
      price: fmtKRW(p),
      buy:   fmtKRW(p*0.988),
      sell:  fmtKRW(p*1.012),
      stop:  fmtKRW(p*0.975),
      risk:  (typeof riskText==='function'? riskText(rate): 'â€”'),
      comment: (typeof zzeolComment==='function'? zzeolComment(rate): 'â€”')
    };

    if (rowBySym.has(sym)) {
      // ì´ë¯¸ í‘œì— ìˆë˜ ì½”ì¸: ë‚´ìš© ì—…ë°ì´íŠ¸ í›„ ë§¨ ìœ„ë¡œ ì´ë™
      const tr = rowBySym.get(sym);
      tr.innerHTML = `
        <td>ğŸ’¥ ${entry.nameKo}</td>
        <td>${entry.price}</td>
        <td>${entry.buy}</td>
        <td>${entry.sell}</td>
        <td>${entry.stop}</td>
        <td>${entry.risk}</td>
        <td>${entry.comment}</td>`;
      tr.classList.add('flash');
      feed.prepend(tr);            // âœ… í•­ìƒ ìœ„ë¡œ
      setTimeout(()=>tr.classList.remove('flash'), 900);
      upsertFront(entry);          // ì €ì¥ì†Œì—ì„œë„ ìµœì‹ ìœ¼ë¡œ ê°±ì‹ 
    } else {
      // ìƒˆ ì½”ì¸: ìƒˆ í–‰ ë§Œë“¤ê³  ë§¨ ìœ„ë¡œ
      const tr = document.createElement('tr');
      tr.style.textAlign='center'; tr.classList.add('flash');
      tr.innerHTML = `
        <td>ğŸ’¥ ${entry.nameKo}</td>
        <td>${entry.price}</td>
        <td>${entry.buy}</td>
        <td>${entry.sell}</td>
        <td>${entry.stop}</td>
        <td>${entry.risk}</td>
        <td>${entry.comment}</td>`;
      feed.prepend(tr);
      setTimeout(()=>tr.classList.remove('flash'), 900);
      rowBySym.set(sym, tr);
      upsertFront(entry);
    }
  }
}

// ë¶€íŒ…: ì €ì¥ë³¸ ë¨¼ì € ë³µì› â†’ ì£¼ê¸°ì ìœ¼ë¡œ ìŠ¤ìº”(30ì´ˆ)
window.addEventListener('DOMContentLoaded', async ()=>{
  // í•œê¸€ëª… ë§µì„ ì“°ëŠ” ë²„ì „ì´ë©´ ensureMarkets ë¨¼ì €
  try { if (typeof ensureMarkets==='function') await ensureMarkets(); } catch {}
  const boot = loadFeedFromStore();
  if (boot.length) renderFeed(boot);
  await loadHotOnce();
  setInterval(loadHotOnce, 30000); // 30ì´ˆë§ˆë‹¤ ê°ì§€
});
</script>
