<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.7 â€“ ì—…ë¹„íŠ¸ í˜¸ê°€ ì™„ì „ë™ê¸°í™”</title>
<style>
  :root{
    --bg:#0e1116; --panel:#141a22; --muted:#8b98a5; --text:#e6edf3; --accent:#00c2ff;
    --pos:#2ecb70; --neg:#ff5c5c; --chip:#1b2531; --chipb:#0f1620; --border:#1f2a36;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
    color:var(--text); background:var(--bg);
  }
  .wrap{max-width:1280px; margin:24px auto; padding:0 16px}
  .header{display:flex; align-items:center; gap:8px; margin-bottom:12px}
  .badge{font-size:12px; padding:4px 8px; background:#0d1b27; border:1px solid var(--border); border-radius:999px}
  .title{font-weight:800; letter-spacing:.2px}
  .row{display:flex; gap:12px; align-items:center}
  .sp{flex:1}
  .input, .btn{
    height:40px; border-radius:10px; border:1px solid var(--border); background:var(--chipb); color:var(--text);
    padding:0 12px; font-size:14px; outline:none;
  }
  .btn{cursor:pointer; background:#0f1d2a; border-color:#203040}
  .btn:hover{filter:brightness(1.15)}
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px}
  .grid{display:grid; gap:8px}
  .grid-cols-8{grid-template-columns: 1.2fr repeat(7, 1fr)}
  .th, .td{padding:10px 8px; border-bottom:1px solid #18222f; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .th{color:var(--muted); font-size:12px}
  .td{font-size:14px}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:var(--chip); border:1px solid var(--border); border-radius:999px; font-size:12px; color:#a8b6c5}
  .kicker{display:flex; gap:8px; align-items:center; margin:8px 0 12px}
  .section-title{font-weight:700}
  .right{justify-content:flex-end}
  .muted{color:var(--muted)}
  a{color:inherit; text-decoration:none}
  .small{font-size:12px}
  .ghost{opacity:.6}
  .table{overflow:auto; border-radius:12px}
  .sticky-head{position:sticky; top:0; backdrop-filter: blur(6px); background:linear-gradient(180deg, rgba(14,17,22,.9), rgba(14,17,22,.75)); z-index:3}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <span class="badge">ì©”ì–´ì§€ê°‘ v6.7</span>
    <span class="badge">ONLINE</span>
    <div class="sp"></div>
    <span class="small muted" id="clock">KST â€”</span>
  </div>

  <!-- ê²€ìƒ‰ ë°” -->
  <div class="panel" style="margin-bottom:12px">
    <div class="row" style="gap:8px">
      <input id="q" class="input sp" placeholder="ì½”ì¸ ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“, ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
      <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
      <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- ì„ íƒëœ ì½”ì¸ ìš”ì•½ -->
  <div class="panel" style="margin-bottom:16px">
    <div class="kicker">
      <span class="section-title">ì„ íƒëœ ì½”ì¸</span>
      <span id="selMarket" class="chip">ì—†ìŒ</span>
      <span class="chip" id="selMode">ìƒìŠ¹ ë‹¨ë½</span>
    </div>
    <div class="grid grid-cols-8" id="selHead">
      <div class="th">ì½”ì¸ëª…</div>
      <div class="th">í˜„ì¬ê°€</div>
      <div class="th">ë³€ë™ë¥ </div>
      <div class="th">ë§¤ìˆ˜</div>
      <div class="th">ë§¤ë„</div>
      <div class="th">ì†ì ˆ</div>
      <div class="th">ìœ„í—˜ë„</div>
      <div class="th">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div class="grid grid-cols-8" id="selRow">
      <div class="td muted">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
      <div class="td">â€”</div>
    </div>
  </div>

  <!-- ê¸‰ë“±/ê¸‰ë½ -->
  <div class="row" style="gap:16px">
    <div class="panel sp">
      <div class="kicker">
        <span class="section-title">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</span>
        <span class="chip" id="upCond">ì¡°ê±´: ì‹¤ì‹œê°„</span>
        <div class="sp"></div>
        <span class="small muted">ì‹¤ì‹œê°„ ìë™ ì •ë ¬</span>
      </div>
      <div class="table">
        <div class="grid grid-cols-8 sticky-head" style="padding:0 8px">
          <div class="th">ì½”ì¸ëª…(í•œê¸€)</div>
          <div class="th">í˜„ì¬ê°€</div>
          <div class="th">ë³€ë™ë¥ </div>
          <div class="th">ë§¤ìˆ˜</div>
          <div class="th">ë§¤ë„</div>
          <div class="th">ì†ì ˆ</div>
          <div class="th">ìœ„í—˜ë„</div>
          <div class="th">ì©”ì–´í•œë§ˆë””</div>
        </div>
        <div id="upList"></div>
      </div>
    </div>
    <div class="panel sp">
      <div class="kicker">
        <span class="section-title">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</span>
        <span class="chip" id="dnCond">ì¡°ê±´: ì‹¤ì‹œê°„</span>
        <div class="sp"></div>
        <span class="small muted">ì‹¤ì‹œê°„ ìë™ ì •ë ¬</span>
      </div>
      <div class="table">
        <div class="grid grid-cols-8 sticky-head" style="padding:0 8px">
          <div class="th">ì½”ì¸ëª…(í•œê¸€)</div>
          <div class="th">í˜„ì¬ê°€</div>
          <div class="th">ë³€ë™ë¥ </div>
          <div class="th">ë§¤ìˆ˜</div>
          <div class="th">ë§¤ë„</div>
          <div class="th">ì†ì ˆ</div>
          <div class="th">ìœ„í—˜ë„</div>
          <div class="th">ì©”ì–´í•œë§ˆë””</div>
        </div>
        <div id="dnList"></div>
      </div>
    </div>
  </div>

  <div class="small muted" style="margin-top:12px">
    â€» í˜¸ê°€/í‘œì‹œ ì†Œìˆ˜ ìë¦¿ìˆ˜ëŠ” ì—…ë¹„íŠ¸ì™€ 1:1 ë™ê¸°í™”ë¨. (ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆë„ ë™ì¼ ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼/ì˜¬ë¦¼/ë‚´ë¦¼)
  </div>
</div>

<script>
/* ================ ê³µí†µ ================ */
const API = (path) => `/api/upbit?path=${encodeURIComponent(path)}`;

const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function nowKST(){
  const d = new Date();
  const k = new Date(d.getTime()+9*3600*1000 - d.getTimezoneOffset()*60000);
  return k.toISOString().substring(11,19).replace('T',' ');
}
setInterval(()=>{ document.getElementById('clock').textContent = 'KST â€” ' + nowKST(); }, 1000);

/* ===== ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„ ì™„ì „ë°˜ì˜ ===== */
function priceStep(p){
  if (p >= 2000000) return 1000;
  if (p >= 1000000) return 500;
  if (p >= 500000)  return 100;
  if (p >= 100000)  return 50;
  if (p >= 10000)   return 10;
  if (p >= 1000)    return 1;
  if (p >= 100)     return 0.1;
  if (p >= 10)      return 0.01;
  if (p >= 1)       return 0.001;
  if (p >= 0.1)     return 0.0001;
  if (p >= 0.01)    return 0.00001;
  return 0.000001; // ultra-low
}
function fmtPrice(p){
  if (p>=1000) return p.toLocaleString('ko-KR', {maximumFractionDigits:0});
  if (p>=100)  return p.toFixed(1);
  if (p>=10)   return p.toFixed(2);
  if (p>=1)    return p.toFixed(3);
  if (p>=0.1)  return p.toFixed(4);
  if (p>=0.01) return p.toFixed(5);
  return p.toFixed(6);
}
function roundToStep(x, step, dir=0){
  const f = 1/step;
  if (dir<0) return Math.floor(x*f)/f; // ì•„ë˜
  if (dir>0) return Math.ceil(x*f)/f;  // ìœ„
  return Math.round(x*f)/f;
}
function computeTap(t){ // bid/ask/cut
  const p = t.trade_price || 0;
  const step = priceStep(p);
  const bid = roundToStep(p * 0.998, step, -1); // -0.2%
  const ask = roundToStep(p * 1.002, step, +1); // +0.2%
  const cut = roundToStep(p * 0.98,  step, 0);  // -2%
  return { bid, ask, cut };
}
function riskBadge(t){ // ë§¤ìš° ë¼ì´íŠ¸í•œ ìœ„í—˜ë„
  const r = Math.abs(t.signed_change_rate||0);
  let txt='1(ì•ˆì •)', col='#a8b6c5';
  if (r>0.08) { txt='3(ì£¼ì˜)'; col='#ff9b6a'; }
  else if (r>0.04) { txt='2(ë³´í†µ)'; col='#ffd36a'; }
  return `<span class="chip" style="color:${col}">${txt}</span>`;
}
function vibeWord(t){ // ì©”ì–´í•œë§ˆë””
  const r = t.signed_change_rate||0;
  if (r>0.06) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
  if (r>0.02) return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  if (r<-0.06) return 'ğŸ§Š ê¸‰ë½ ìœ„í—˜';
  if (r<-0.02) return 'âš ï¸ ì•½ì„¸';
  return 'ğŸ‘€ ê´€ë§';
}

/* ================ ë°ì´í„° ë¡œë”© ================ */
let MARKET_ALL = [];     // {market, korean_name, english_name}
let KMAP = new Map();    // market -> name
let TICK = new Map();    // market -> ticker

async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'));
  if (!r.ok){ throw new Error('ë§ˆì¼“ì¡°íšŒ ì‹¤íŒ¨'); }
  const arr = await r.json();
  MARKET_ALL = arr.filter(x=>x.market.startsWith('KRW-'));
  KMAP.clear();
  MARKET_ALL.forEach(m=>KMAP.set(m.market, m.korean_name));
}

async function loadTickers(markets){
  const qs = markets.join(',');
  const r = await fetch(API('/v1/ticker?markets='+qs), {cache:'no-store'});
  if (!r.ok) return;
  const arr = await r.json();
  arr.forEach(t=>TICK.set(t.market, t));
}

async function refreshAll(){
  // ë§ˆì¼“ 100ê°œì”© ë‚˜ëˆ ì„œ
  const CHUNK = 80;
  for (let i=0;i<MARKET_ALL.length;i+=CHUNK){
    const part = MARKET_ALL.slice(i, i+CHUNK).map(m=>m.market);
    await loadTickers(part);
    await sleep(120); // Gateway 429 íšŒí”¼ (ê°€ë²¼ìš´ í˜ì´ìŠ¤)
  }
}

/* ================ ë Œë”ë§ ================ */
function rowDom(t){
  const tap = computeTap(t);
  const rate = (t.signed_change_rate||0)*100;
  const rateCls = rate>=0?'pos':'neg';
  return `
    <div class="grid grid-cols-8">
      <div class="td">${KMAP.get(t.market)||t.market}</div>
      <div class="td">${fmtPrice(t.trade_price)}</div>
      <div class="td ${rateCls}">${rate.toFixed(2)}%</div>
      <div class="td">${fmtPrice(tap.bid)}</div>
      <div class="td">${fmtPrice(tap.ask)}</div>
      <div class="td">${fmtPrice(tap.cut)}</div>
      <div class="td">${riskBadge(t)}</div>
      <div class="td">${vibeWord(t)}</div>
    </div>`;
}

function renderTop(){
  // ë°°ì—´í™”
  const arr = [...TICK.values()];
  // ë³€ë™ë¥  ê¸°ì¤€
  const up = arr.filter(t=>t.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const dn = arr.filter(t=>t.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);

  document.getElementById('upList').innerHTML = up.map(rowDom).join('');
  document.getElementById('dnList').innerHTML = dn.map(rowDom).join('');
}

function findMarketByQuery(q){
  q = q.trim().toLowerCase();
  if (!q) return null;
  // ì •í™• ë§¤ì¹­ ìš°ì„ 
  const direct = MARKET_ALL.find(m=>{
    return m.market.toLowerCase()===q || m.english_name.toLowerCase()===q || m.korean_name.toLowerCase()===q;
  });
  if (direct) return direct;
  // í¬í•¨ ê²€ìƒ‰
  return MARKET_ALL.find(m=>{
    return m.market.toLowerCase().includes(q) || m.english_name.toLowerCase().includes(q) || m.korean_name.toLowerCase().includes(q);
  }) || null;
}

function renderSelected(t){
  if (!t){
    document.getElementById('selMarket').textContent = 'ì—†ìŒ';
    document.querySelectorAll('#selRow .td').forEach((el,i)=>{ el.textContent = ['â€”','â€”','â€”','â€”','â€”','â€”','â€”','â€”'][i]; });
    return;
  }
  const tap = computeTap(t);
  const rate = (t.signed_change_rate||0)*100;
  const rateCls = rate>=0?'pos':'neg';
  document.getElementById('selMarket').textContent = t.market;
  const cells = [
    KMAP.get(t.market)||t.market,
    fmtPrice(t.trade_price),
    `<span class="${rateCls}">${rate.toFixed(2)}%</span>`,
    fmtPrice(tap.bid),
    fmtPrice(tap.ask),
    fmtPrice(tap.cut),
    riskBadge(t),
    vibeWord(t)
  ];
  document.querySelectorAll('#selRow .td').forEach((el,i)=>{ el.innerHTML = cells[i]; });
}

/* ================ ì´ë²¤íŠ¸/ì£¼ê¸° ================ */
async function boot(){
  try{
    await loadMarkets();
    await refreshAll(); // ì´ˆê¸°í’€
    renderTop();
  }catch(e){
    console.error(e);
  }

  // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (15ì´ˆ)
  setInterval(async()=>{
    try{
      await refreshAll();
      renderTop();
      // ì„ íƒì½”ì¸ ë³´ì •
      if (window.__sel) renderSelected(TICK.get(window.__sel) || null);
    }catch(e){ console.log('poll err', e); }
  }, 15000);
}

document.getElementById('btnSearch').onclick = ()=>{
  const q = document.getElementById('q').value||'';
  const m = findMarketByQuery(q);
  if (!m){ alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }
  window.__sel = m.market;
  renderSelected(TICK.get(m.market));
}
document.getElementById('btnReset').onclick = ()=>{
  document.getElementById('q').value='';
  window.__sel = null;
  renderSelected(null);
}

boot();
</script>
</body>
</html>
