<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ v4.6 â€” ì‹¤ì‹œê°„ WS + ê¸‰ë“± í”¼ë“œ(í•œê¸€ëª…)</title>
  <style>
    :root{--bg:#0d1117;--panel:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#9fb1c1;--up:#16c784;--down:#ea3943;--chip:#223045}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    .badge{background:var(--chip);border:1px solid #283752;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25);margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    input,button{background:#0e141b;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
    input{flex:1;min-width:260px}
    button{cursor:pointer}
    button:hover{background:#1a2330}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:center}
    .price{font-weight:800;font-size:28px}
    .diff.up{color:var(--up)}.diff.down{color:var(--down)}
    .muted{color:var(--muted)}
    .error{color:#ff6b6b;font-size:12px;margin-top:6px}
    @keyframes flash{0%{background:rgba(255,255,0,.18)}100%{background:transparent}}
    .flash{animation:flash 1s ease-out 1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ì©”ì–´ì§€ê°‘ <span class="badge">v4.6</span> <span class="badge" id="net">OFFLINE</span></h1>
      <div class="badge" id="clock">KST â€” --:--:--</div>
    </header>

    <!-- ê²€ìƒ‰ -->
    <div class="card">
      <div class="row">
        <div class="search">
          <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" autocomplete="off" />
          <button id="btnSearch">ê²€ìƒ‰</button>
          <button id="btnClear">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div id="searchError" class="error" style="display:none;"></div>
    </div>

    <!-- ì„ íƒ ì½”ì¸ ê²°ê³¼ (WebSocket ì‹¤ì‹œê°„) -->
    <div class="card" id="result" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:end">
        <div>
          <div style="font-weight:700;font-size:18px">ì„ íƒëœ ì½”ì¸: <span id="selName" class="muted">-</span></div>
          <div id="selMarket" class="badge" style="margin-top:6px">â€”</div>
        </div>
        <div style="text-align:right">
          <div id="nowPrice" class="price">â€”</div>
          <div id="nowChange" class="diff">â€”</div>
        </div>
      </div>
      <table style="margin-top:10px">
        <thead>
          <tr class="muted"><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th><th class="muted">ì—°ê²°</th></tr>
        </thead>
        <tbody>
          <tr>
            <td id="c_price">â€”</td>
            <td id="c_buy">â€”</td>
            <td id="c_sell">â€”</td>
            <td id="c_stop">â€”</td>
            <td id="c_risk">â€”</td>
            <td id="c_comment">â€”</td>
            <td id="wsState" class="muted">â€”</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ğŸ”¥ ê¸‰ë“±ì½”ì¸ ì‹¤ì‹œê°„ í”¼ë“œ (ëˆ„ì  + í•œê¸€ëª… ì €ì¥/ë³µì›) -->
    <div class="card" id="hotCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ğŸ”¥ ê¸‰ë“±ì½”ì¸ ì‹¤ì‹œê°„ í”¼ë“œ (5%â†‘, 10ì–µâ†‘)</h3>
        <button id="btnFeedClear" title="ì €ì¥ëœ ê¸‰ë“± í”¼ë“œ ë¹„ìš°ê¸°">í”¼ë“œ ë¹„ìš°ê¸°</button>
      </div>
      <table>
        <thead>
          <tr class="muted"><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr>
        </thead>
        <tbody id="hotFeed"></tbody>
      </table>
      <div class="muted" style="font-size:12px;margin-top:6px">â€» ìƒˆë¡œ ê°ì§€ëœ ê¸‰ë“±ì½”ì¸ì€ ìœ„ë¡œ ì¶”ê°€, ê¸°ì¡´ í•­ëª©ì€ ì•„ë˜ë¡œ ì´ë™. (ìµœëŒ€ 100ê°œ, 24ì‹œê°„ ë³´ê´€)</div>
    </div>
  </div>

  <script>
    /* ===== ê³µí†µ: ì‹œê³„/ì˜¨ë¼ì¸ ===== */
    const $=(id)=>document.getElementById(id);
    function tick(){
      const clock=$('clock'), net=$('net');
      if(!clock||!net) return;
      const now=new Date(), utc=now.getTime()+now.getTimezoneOffset()*60000;
      const kst=new Date(utc+9*3600000);
      clock.textContent='KST â€” '+kst.toLocaleTimeString('ko-KR',{hour12:false});
      net.textContent=navigator.onLine?'ONLINE':'OFFLINE';
      net.style.background=navigator.onLine?'#123922':'#3a1a1a';
    }
    window.addEventListener('DOMContentLoaded',()=>{ tick(); setInterval(tick,1000); });

    /* ===== ì—…ë¹„íŠ¸ í¬ë§·(í˜¸ê°€ë‹¨ìœ„) ===== */
    function getTick(price){
      if(price>=2000000) return 1000;
      if(price>=1000000) return 500;
      if(price>=500000)  return 100;
      if(price>=100000)  return 50;
      if(price>=10000)   return 10;
      if(price>=1000)    return 5;
      if(price>=100)     return 1;
      if(price>=10)      return 0.1;
      if(price>=1)       return 0.01;
      if(price>=0.1)     return 0.001;
      if(price>=0.01)    return 0.0001;
      if(price>=0.001)   return 0.00001;
      if(price>=0.0001)  return 0.000001;
      if(price>=0.00001) return 0.0000001;
      if(price>=0.000001)return 0.00000001;
      return 0.000000001;
    }
    function fmtKRW(x){
      const t=getTick(x);
      const d=(t.toString().split('.')[1]||'').length;
      const r=Math.round(x/t)*t;
      return r.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
    }
    function riskText(rate){ const r=Math.abs(rate*100); if(r<1) return '1(ì•ˆì •)'; if(r<3) return '2(ë³´í†µ)'; return '3(ì£¼ì˜)'; }
    function zzeolComment(rate){
      if(rate>0.08) return 'ğŸš€ í­ë“± ëª¨ë“œ!';
      if(rate>0.05) return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
      if(rate>0.02) return 'ğŸ“ˆ ìƒìŠ¹ íƒ„ë ¥';
      if(rate>-0.02) return 'âš–ï¸ ê´€ë§';
      return 'ğŸ’€ í•˜ë½ ë¦¬ìŠ¤í¬';
    }

    /* ===== ë„¤íŠ¸ì›Œí¬ ìœ í‹¸(REST ë‚´êµ¬ì„±) ===== */
    async function fetchJSON(url, {timeout=7000, retries=2, backoff=500}={}){
      for(let a=0;a<=retries;a++){
        const ctrl=new AbortController(); const timer=setTimeout(()=>ctrl.abort(), timeout);
        try{
          const res=await fetch(url,{signal:ctrl.signal,cache:'no-store'});
          if(!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){
          if(a===retries) throw e;
          await new Promise(r=>setTimeout(r, backoff*Math.pow(2,a)));
        }finally{ clearTimeout(timer); }
      }
    }

    /* ===== ë§ˆì¼“ ë¡œë”© & í•œê¸€ëª… ë§µ ===== */
    let MARKETS=[];                 // KRW- ë§ˆì¼“ ì „ì²´
    const NAME_KO = new Map();      // 'KRW-BTC' -> 'ë¹„íŠ¸ì½”ì¸'
    const SYM_FROM_MARKET = (m)=>m.replace('KRW-','');

    async function ensureMarkets(){
      if(MARKETS.length) return MARKETS;
      const all=await fetchJSON('https://api.upbit.com/v1/market/all?isDetails=false');
      MARKETS=all.filter(m=>m.market.startsWith('KRW-'));
      // í•œê¸€ëª… ë§µ êµ¬ì„±
      for(const m of MARKETS){
        NAME_KO.set(m.market, m.korean_name || SYM_FROM_MARKET(m.market));
      }
      return MARKETS;
    }

    /* ===== ê²€ìƒ‰ + ì„ íƒ(WS êµ¬ë…) ===== */
    let currentMarket=null;
    let ws=null, wsTimer=null, wsHeartbeat=null, wsBackoff=1000;

    function wsSetState(txt){ $('wsState').textContent=txt; }

    function openWS(market){
      // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
      if(ws){ try{ ws.close(); }catch{} ws=null; }
      if(wsTimer){ clearTimeout(wsTimer); wsTimer=null; }
      if(wsHeartbeat){ clearInterval(wsHeartbeat); wsHeartbeat=null; }

      wsSetState('ì—°ê²°ì¤‘â€¦');
      ws = new WebSocket('wss://api.upbit.com/websocket/v1');
      ws.binaryType='arraybuffer';

      ws.onopen=()=>{
        const msg = [
          {ticket:'zzeol-wallet'},
          {type:'ticker', codes:[market], isOnlyRealtime:true}
        ];
        ws.send(JSON.stringify(msg));
        wsSetState('ì—°ê²°ë¨');
        wsBackoff=1000;
        wsHeartbeat=setInterval(()=>{ try{ ws.send(JSON.stringify([{ticket:'ping'}])); }catch{} }, 15000);
      };

      ws.onmessage=(ev)=>{
        const data = new TextDecoder('utf-8').decode(new Uint8Array(ev.data));
        let t; try{ t=JSON.parse(data); }catch{ return; }
        if(!t || (t.type!=='ticker' && t.ty!=='ticker')) return;
        const price = t.trade_price ?? t.tp;
        const rate  = (t.signed_change_rate ?? t.scr) ?? 0;
        const change= (t.change ?? t.c) || 'EVEN';

        $('nowPrice').textContent = fmtKRW(price)+' ì›';
        $('nowChange').className = 'diff '+(change==='RISE'?'up':change==='FALL'?'down':'');
        $('nowChange').textContent = `${change==='RISE'?'+':''}${(rate*100).toFixed(2)}%`;

        $('c_price').textContent = fmtKRW(price);
        $('c_buy').textContent   = fmtKRW(price*0.988);
        $('c_sell').textContent  = fmtKRW(price*1.012);
        $('c_stop').textContent  = fmtKRW(price*0.975);
        $('c_risk').textContent  = riskText(rate);
        $('c_comment').textContent = zzeolComment(rate);
      };

      ws.onclose=()=>{
        wsSetState('ì¬ì—°ê²° ëŒ€ê¸°â€¦');
        wsTimer=setTimeout(()=>openWS(market), wsBackoff);
        wsBackoff = Math.min(wsBackoff*2, 15000);
      };
      ws.onerror=()=>{ try{ ws.close(); }catch{} };
    }

    async function doSearch(){
      const err=$('searchError'); err.style.display='none';
      const q=($('q').value||'').trim();
      if(!q){ $('q').focus(); return; }
      try{
        const list=await ensureMarkets();
        const s=q.toLowerCase();

        const exact=list.find(x =>
          x.korean_name.toLowerCase()===s ||
          (x.english_name||'').toLowerCase()===s ||
          x.market.toLowerCase()===s ||
          x.market.replace('KRW-','').toLowerCase()===s
        );
        const coin=exact || list.find(x =>
          x.korean_name.toLowerCase().includes(s) ||
          (x.english_name||'').toLowerCase().includes(s) ||
          x.market.toLowerCase().includes(s) ||
          x.market.replace('KRW-','').toLowerCase().includes(s)
        );
        if(!coin){ err.textContent='ì¼ì¹˜í•˜ëŠ” ì½”ì¸ì„ ëª» ì°¾ì•˜ì–´. (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)'; err.style.display='block'; return; }

        currentMarket = coin.market;
        $('result').style.display='block';
        $('selName').textContent=coin.korean_name;
        $('selMarket').textContent=coin.market;
        wsSetState('ì—°ê²° ì¤€ë¹„â€¦');
        openWS(currentMarket);
      }catch(e){
        console.error(e);
        err.textContent='ì—…ë¹„íŠ¸ ì—°ê²°ì— ë¬¸ì œê°€ ìˆì–´. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜!';
        err.style.display='block';
      }
    }
    $('btnSearch').addEventListener('click', doSearch);
    $('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    $('btnClear').addEventListener('click', ()=>{
      $('q').value=''; $('result').style.display='none'; $('searchError').style.display='none';
      if(ws){ try{ ws.close(); }catch{} ws=null; }
    });

    /* ===== ê¸‰ë“± í”¼ë“œ (REST ë‚´êµ¬ì„± + í•œê¸€ëª… ì €ì¥/ë³µì›) ===== */
    const FEED_KEY='zzeol_hot_feed_v1';
    const FEED_TTL_HOURS=24;
    const shown={};

    function loadFeedFromStore(){
      try{
        const raw=localStorage.getItem(FEED_KEY);
        if(!raw) return [];
        const arr=JSON.parse(raw);
        const now=Date.now();
        return arr.filter(x=> now-x.ts < FEED_TTL_HOURS*3600*1000).slice(0,100);
      }catch{return [];}
    }
    function saveFeedToStore(items){
      try{ localStorage.setItem(FEED_KEY, JSON.stringify(items.slice(0,100))); }
      catch(e){ console.warn('feed save failed', e); }
    }
    function renderFeed(items){
      const feed=$('hotFeed'); feed.innerHTML='';
      for(const it of items){
        const nameKo = it.nameKo || it.sym; // ê³¼ê±° ì €ì¥ë³¸ í˜¸í™˜
        const tr=document.createElement('tr'); tr.style.textAlign='center';
        tr.innerHTML=`
          <td>ğŸ’¥ ${nameKo}</td>
          <td>${it.price}</td>
          <td>${it.buy}</td>
          <td>${it.sell}</td>
          <td>${it.stop}</td>
          <td>${it.risk}</td>
          <td>${it.comment}</td>`;
        feed.appendChild(tr);
      }
    }
    $('btnFeedClear').addEventListener('click', ()=>{
      localStorage.removeItem(FEED_KEY);
      renderFeed([]);
      alert('ê¸‰ë“± í”¼ë“œë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤.');
    });

    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
    async function getTickersBatch(markets){
      const chunks=chunk(markets,60); const out=[];
      for(const c of chunks){
        const part=await fetchJSON('https://api.upbit.com/v1/ticker?markets='+c.join(','), {timeout:8000,retries:2,backoff:500});
        out.push(...part);
      }
      return out;
    }

    async function loadHotOnce(){
      const list=await ensureMarkets();
      const tickers=await getTickersBatch(list.map(x=>x.market));
      const hot=tickers.filter(t=> t.signed_change_rate>0.05 && t.acc_trade_price_24h>10_000_000_000)
                       .sort((a,b)=> b.signed_change_rate-a.signed_change_rate);

      const feedEl=$('hotFeed'); let store=loadFeedFromStore();
      let added=0;
      for(const t of hot){
        const market=t.market;
        const sym = market.replace('KRW-','');
        if(shown[sym]) continue;
        shown[sym]=true;

        const p=t.trade_price, rate=t.signed_change_rate;
        const nameKo = NAME_KO.get(market) || sym;

        // ìƒˆ í–‰ (í•œê¸€ëª…)
        const tr=document.createElement('tr'); tr.style.textAlign='center'; tr.classList.add('flash');
        tr.innerHTML=`
          <td>ğŸ’¥ ${nameKo}</td>
          <td>${fmtKRW(p)}</td>
          <td>${fmtKRW(p*0.988)}</td>
          <td>${fmtKRW(p*1.012)}</td>
          <td>${fmtKRW(p*0.975)}</td>
          <td>${riskText(rate)}</td>
          <td>${zzeolComment(rate)}</td>`;
        feedEl.prepend(tr);
        setTimeout(()=>tr.classList.remove('flash'), 900);

        // ì €ì¥(í•œê¸€ëª… í¬í•¨)
        const entry={
          ts:Date.now(),
          sym,           // í˜¸í™˜ìš©
          nameKo,        // âœ… í•œê¸€ëª… ì €ì¥
          price:fmtKRW(p),
          buy:fmtKRW(p*0.988),
          sell:fmtKRW(p*1.012),
          stop:fmtKRW(p*0.975),
          risk:riskText(rate),
          comment:zzeolComment(rate)
        };
        store=[entry, ...store.filter(x=> (x.sym!==sym && x.nameKo!==nameKo))];
        added++;
      }
      if(added>0) saveFeedToStore(store);
    }

    // ë¶€íŒ…: ë§ˆì¼“ ë¡œë“œ â†’ ì €ì¥ëœ í”¼ë“œ ë³µì› â†’ 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
    window.addEventListener('DOMContentLoaded', async ()=>{
      await ensureMarkets();                 // âœ… í•œê¸€ëª… ë§µ ë¨¼ì € êµ¬ì¶•
      const boot=loadFeedFromStore();
      if(boot.length) renderFeed(boot);
      await loadHotOnce();
      setInterval(loadHotOnce, 60000);
    });
  </script>
</body>
</html>
