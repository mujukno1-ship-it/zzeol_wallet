<!-- zzeol v7.3.1 2025-10-22 13:15 -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쩔어지갑 v7.3 안정판 (실시간 급등형)</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{
    --bg:#0b0f14;--panel:#121823;--muted:#96a2b4;--text:#e7eef7;--accent:#53b3ff;
    --up:#33d69f;--down:#ff6b6b;--chip:#1a2230;--chip2:#0f1520;--border:#1e2735;
    --warn:#f7b731;--danger:#ff6b6b;--ok:#33d69f;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .badge{background:#0d1320;border:1px solid var(--border);color:#9dc8ff;padding:4px 8px;border-radius:999px;font-size:12px}
  .title{font-weight:700;font-size:18px}
  .search-bar{display:flex;gap:8px;align-items:center;background:var(--panel);padding:12px;border:1px solid var(--border);border-radius:12px}
  .search-bar input{flex:1;background:var(--chip2);color:var(--text);border:1px solid var(--border);padding:12px 14px;border-radius:10px;outline:none}
  .btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .btn-ghost{background:transparent;border:1px solid var(--border)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .panel + .panel{margin-top:14px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .chip strong{color:var(--text)}
  .grid{display:grid;grid-template-columns: 40px 1fr repeat(7, minmax(80px, 110px));gap:0}
  .thead,.trow{display:contents}
  .th,.td{padding:10px;border-bottom:1px solid var(--border);background:transparent}
  .th{color:#9ab; font-size:12px}
  .td{font-size:14px}
  .num{font-variant-numeric:tabular-nums}
  .up{color:var(--up)} .down{color:var(--down)} .muted{color:var(--muted)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip2);font-size:12px;color:#cbd6e5}
  .pill.warn{background:#2a1e10;border-color:#4d3215;color:#f7d7a6}
  .pill.ok{background:#11261e;border-color:#1b3b2b;color:#b7f2d9}
  .pill.danger{background:#2a1112;border-color:#472022;color:#ffc7c9}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:18px 0 10px}
  .small{font-size:12px;color:#9ab}
  .right{justify-content:flex-end}
  .sticky-row{position:sticky;top:10px;z-index:5}
  .flex{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;gap:8px;align-items:center}
  .switch input{accent-color:var(--accent)}
  .empty{padding:20px;text-align:center;color:#9ab}
  @media (max-width: 980px){
    .grid{grid-template-columns: 32px 1fr repeat(7, minmax(72px, 92px))}
  }
  @media (max-width: 760px){
    .grid{grid-template-columns: 28px 1fr repeat(7, minmax(68px, 84px))}
    .td,.th{padding:8px}
    .chips{gap:6px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="row">
      <span class="badge">쩔어지갑 v7.3 안정판</span>
      <span class="badge">ONLINE</span>
    </div>
    <div class="row">
      <span class="badge" id="clock">KST — --:--:--</span>
      <button class="btn btn-ghost" id="refreshBtn">새로고침</button>
      <label class="switch small">
        <input type="checkbox" id="autoTick"> 자동 새로고침(60s)
      </label>
    </div>
  </div>

  <!-- 검색 -->
  <div class="panel search-bar sticky-row">
    <input id="q" placeholder="코인 검색 (예: 이더리움 / ETH / KRW-ETH / ethereum)" />
    <button class="btn" id="searchBtn">검색</button>
    <button class="btn btn-ghost" id="resetBtn">초기화</button>
  </div>

  <!-- 선택 코인 한 줄 요약 -->
  <div id="selectedBox" class="panel" style="display:none;">
    <div class="chips" id="selectedChips"></div>
  </div>

  <!-- 급등/급락 -->
  <div class="panel">
    <div class="section-title">
      <div class="title">🔥 급등코인 Top 10 <span class="small">(조건: 실시간 변동률)</span></div>
      <div class="small" id="updatedAt">업데이트: --:--:--</div>
    </div>
    <div class="grid" id="upGrid">
      <div class="thead">
        <div class="th">#</div>
        <div class="th">코인명(한글)</div>
        <div class="th right">현재가</div>
        <div class="th right">변동률</div>
        <div class="th right">매수</div>
        <div class="th right">매도</div>
        <div class="th right">손절</div>
        <div class="th right">위험도</div>
        <div class="th right">쩔어한마디</div>
      </div>
      <!-- rows here -->
    </div>
    <div class="empty" id="upEmpty" style="display:none;">조건에 맞는 코인이 없습니다.</div>
  </div>

  <div class="panel">
    <div class="section-title">
      <div class="title">💧 급락코인 Top 10 <span class="small">(조건: 실시간 변동률)</span></div>
    </div>
    <div class="grid" id="downGrid">
      <div class="thead">
        <div class="th">#</div>
        <div class="th">코인명(한글)</div>
        <div class="th right">현재가</div>
        <div class="th right">변동률</div>
        <div class="th right">매수</div>
        <div class="th right">매도</div>
        <div class="th right">손절</div>
        <div class="th right">위험도</div>
        <div class="th right">쩔어한마디</div>
      </div>
      <!-- rows here -->
    </div>
    <div class="empty" id="downEmpty" style="display:none;">조건에 맞는 코인이 없습니다.</div>
  </div>

</div>

<script>
const $ = sel => document.querySelector(sel);
const upGrid = $('#upGrid');
const downGrid = $('#downGrid');
const upEmpty = $('#upEmpty');
const downEmpty = $('#downEmpty');
const updatedAt = $('#updatedAt');
const q = $('#q');
const selectedBox = $('#selectedBox');
const selectedChips = $('#selectedChips');
const API = (path) => `/api/upbit?path=${encodeURIComponent(path)}`;

// 상태
let markets = [];           // KRW- 마켓 배열
let nameMap = {};           // market -> { kr, en, sym }
let timer = null;

// 유틸
const fmt = (n, d=0) => Number(n).toLocaleString('ko-KR', {maximumFractionDigits:d});
const nowKST = () => {
  const k = new Date(Date.now() + 9*3600*1000);
  return `${String(k.getUTCHours()).padStart(2,'0')}:${String(k.getUTCMinutes()).padStart(2,'0')}:${String(k.getUTCSeconds()).padStart(2,'0')}`;
};
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
const pickRisk = (vol) => { // vol: 0~?
  if (vol < 0.02) return {txt:'1(안정)', cls:'ok'};
  if (vol < 0.06) return {txt:'2(보통)', cls:'warn'};
  return {txt:'3(주의)', cls:'danger'};
};
const say = (chg, vol) => {
  if (chg >= 0.07 && vol > 0.05) return '🚀 폭등';
  if (chg <= -0.07) return '📉 낙폭경계';
  if (chg > 0.02) return '📈 상승중';
  if (chg < -0.02) return '📉 하락중';
  return '👀 관망';
};

// 1) 마켓 불러오기
async function loadMarkets(){
  const res = await fetch(API('/v1/market/all?isDetails=true'), {cache:'no-store'});
  const data = await res.json();
  markets = data.filter(m => m.market?.startsWith('KRW-'));
  nameMap = {};
  markets.forEach(m=>{
    const sym = m.market.split('-')[1];
    nameMap[m.market] = {kr:m.korean_name, en:m.english_name, sym};
  });
}

// 2) 티커 일괄 조회 (배치)
async function loadTickers(mkts){
  const out = [];
  const size = 90;
  for(let i=0;i<mkts.length;i+=size){
    const slice = mkts.slice(i,i+size).map(m=>m.market || m);
    const res = await fetch(API(`/v1/ticker?markets=${slice.join(',')}`), {cache:'no-store'});
    out.push(...await res.json());
  }
  return out;
}

// 3) 계산: 포인트/위험/메시지
function makeRow(t){
  const m = t.market;
  const nm = nameMap[m] || {kr:m, en:m, sym:m.split('-')[1]};
  const price = t.trade_price;
  const change = t.signed_change_rate ?? 0;    // -0.05 ~ +0.05
  const chg = change; // 비율(소수), 화면은 %
  const high = t.high_price ?? price;
  const low  = t.low_price  ?? price;
  const vol  = (high-low) / (t.prev_closing_price || price); // 대략적 변동성
  const risk = pickRisk(vol);
  // 간단한 타점 모델 (타협형)
  const riskK = risk.txt.startsWith('3') ? 1.15 : risk.txt.startsWith('2') ? 1.0 : 0.85;
  const buy  = price * (1 - 0.0065 * riskK);
  const sell = price * (1 + 0.0075 * riskK);
  const stop = price * (1 - 0.020 * riskK);
  const remark = say(chg, vol);

  return {
    market:m, name:nm.kr, sym:nm.sym, price, chg, buy, sell, stop, risk, remark
  };
}

// 4) 렌더
function renderList(container, list){
  // 기존 행 제거
  container.querySelectorAll('.trow').forEach(el=>el.remove());
  if (!list.length){
    (container===upGrid?upEmpty:downEmpty).style.display='block';
    return;
  }
  (container===upGrid?upEmpty:downEmpty).style.display='none';

  list.forEach((r, idx)=>{
    const row = document.createElement('div');
    row.className = 'trow';
    row.innerHTML = `
      <div class="td num">${idx+1}</div>
      <div class="td"><span class="muted">${r.sym}</span> ${r.name}</div>
      <div class="td num right">${fmt(r.price, r.price>=1000?0:2)}</div>
      <div class="td num right ${r.chg>=0?'up':'down'}">${(r.chg*100).toFixed(2)}%</div>
      <div class="td num right">${fmt(r.buy, r.price>=1000?0:2)}</div>
      <div class="td num right">${fmt(r.sell, r.price>=1000?0:2)}</div>
      <div class="td num right">${fmt(r.stop, r.price>=1000?0:2)}</div>
      <div class="td right"><span class="pill ${r.risk.cls}">${r.risk.txt}</span></div>
      <div class="td right"><span class="pill">${r.remark}</span></div>
    `;
    row.addEventListener('click', ()=>showSelected(r));
    container.appendChild(row);
  });
}

// 5) 선택 코인 요약
function showSelected(r){
  selectedChips.innerHTML = `
    <span class="chip"><strong>${r.name}</strong> (${r.market})</span>
    <span class="chip">현재가 <strong>${fmt(r.price, r.price>=1000?0:2)}</strong></span>
    <span class="chip">변동률 <strong class="${r.chg>=0?'up':'down'}">${(r.chg*100).toFixed(2)}%</strong></span>
    <span class="chip">매수 <strong>${fmt(r.buy, r.price>=1000?0:2)}</strong></span>
    <span class="chip">매도 <strong>${fmt(r.sell, r.price>=1000?0:2)}</strong></span>
    <span class="chip">손절 <strong>${fmt(r.stop, r.price>=1000?0:2)}</strong></span>
    <span class="chip">위험도 <strong>${r.risk.txt}</strong></span>
    <span class="chip">쩔어한마디 <strong>${r.remark}</strong></span>
  `;
  selectedBox.style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
}

// 6) 검색
function doSearch(tickers){
  const kw = (q.value||'').trim().toLowerCase();
  if (!kw){ alert('검색어를 입력하세요. (한글/영문/심볼/마켓코드)'); return; }
  // 매칭: 한글/영문/심볼/마켓코드
  const found = tickers
    .map(makeRow)
    .find(r=>{
      const nm = r.name.toLowerCase();
      const sym = r.sym.toLowerCase();
      const code = r.market.toLowerCase();
      return nm.includes(kw) || sym.includes(kw) || code.includes(kw);
    });
  if (!found){
    alert('코인을 찾지 못했습니다.');
    return;
  }
  showSelected(found);
}

// 7) 메인 로드 & 주기 갱신
async function refresh(){
  try{
    if (!markets.length) await loadMarkets();
    const tickers = await loadTickers(markets.map(m=>m.market));
    // 상하위 정렬
    const rows = tickers.map(makeRow);
    const ups = rows.filter(r=>r.chg>0).sort((a,b)=>b.chg-a.chg).slice(0,10);
    const downs = rows.filter(r=>r.chg<0).sort((a,b)=>a.chg-b.chg).slice(0,10);

    renderList(upGrid, ups);
    renderList(downGrid, downs);
    updatedAt.textContent = `업데이트: ${nowKST()}`;
  }catch(e){
    console.error(e);
    alert('데이터를 불러오지 못했습니다.');
  }
}

// 이벤트
$('#searchBtn').addEventListener('click', async ()=>{
  if (!markets.length) await loadMarkets();
  const tickers = await loadTickers(markets.map(m=>m.market));
  doSearch(tickers);
});
q.addEventListener('keydown', async (e)=>{
  if (e.key === 'Enter'){
    if (!markets.length) await loadMarkets();
    const tickers = await loadTickers(markets.map(m=>m.market));
    doSearch(tickers);
  }
});
$('#resetBtn').addEventListener('click', ()=>{
  q.value=''; selectedBox.style.display='none';
});
$('#refreshBtn').addEventListener('click', refresh);
$('#autoTick').addEventListener('change', e=>{
  if (e.target.checked){
    if (timer) clearInterval(timer);
    timer = setInterval(refresh, 60000);
  }else{
    if (timer) clearInterval(timer);
    timer = null;
  }
});

// 시계
setInterval(()=>{ $('#clock').textContent='KST — ' + nowKST(); }, 1000);

// 첫 로드
refresh();
</script>
</body>
</html>

