<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.3 (ë°±ì—…)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{--bg:#0f141a;--card:#141a21;--fg:#d8e1ea;--muted:#93a1b3;--green:#2ecc71;--red:#ff5c5c;--amber:#ffb020;--line:#1f2937;--chip:#1b2430}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .card h3{margin:0 0 12px;font-size:16px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:#cfe2ff;font-size:12px;margin-left:6px}
  .muted{color:var(--muted)}
  .grid{width:100%;border-collapse:collapse}
  .grid th,.grid td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:right}
  .grid th:first-child,.grid td:first-child{text-align:left}
  .grid tr:hover{background:#0e1218}
  .pos{color:var(--green)} .neg{color:var(--red)}
  input[type="text"]{width:100%;background:#0e1218;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:10px 12px}
  .cols{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  @media(max-width:900px){.cols{grid-template-columns:1fr}}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{padding:4px 8px;border-radius:8px;background:var(--chip);color:#cfe2ff}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="card" style="flex:1 1 320px">
      <h3>ê²€ìƒ‰ <span class="pill">ì‹œì¥: KRW</span></h3>
      <input id="q" type="text" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH)" />
      <div id="summary" style="margin-top:12px" class="muted">ì½”ì¸ì„ ê²€ìƒ‰í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="tags" class="chips" style="margin-top:10px"></div>
    </div>

    <div class="card" style="flex:1 1 320px">
      <h3>ì„ íƒëœ ì½”ì¸ ìš”ì•½</h3>
      <div id="sel">â€”</div>
      <div id="selMore" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="cols" style="margin-top:16px">
    <div class="card">
      <h3>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10 <span id="tsUp" class="muted"></span></h3>
      <table class="grid" id="upT">
        <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10 <span id="tsDn" class="muted"></span></h3>
      <table class="grid" id="dnT">
        <thead>
          <tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = (p)=>`/api/upbit?path=${encodeURIComponent(p)}`;
const state = {
  markets: [],            // {market, korean_name, english_name, market_warning}
  mapByMarket: new Map(), // market -> { ... }
  mapByKorean: new Map(), // korean_name -> market
  lastTick: new Map()     // market -> ticker
};

// ìˆ«ì í¬ë§¤íŒ…
const nf0 = new Intl.NumberFormat('ko-KR',{maximumFractionDigits:0});
const nf1 = new Intl.NumberFormat('ko-KR',{maximumFractionDigits:1});
const nf2 = new Intl.NumberFormat('ko-KR',{maximumFractionDigits:2});
const pct = v => (v>0?`+${(v*100).toFixed(2)}%`:`${(v*100).toFixed(2)}%`);
const riskText = chg => chg > 0.08 ? '3(ì£¼ì˜)' : chg > 0.04 ? '2(ë³´í†µ)' : '1(ì•ˆì •)';
const noteText = chg => chg > 0.08 ? 'í­ë“±' : chg > 0.04 ? 'ìƒìŠ¹ì¤‘' : 'ê´€ë§';

// ë§ˆì¼“/ì½”ë“œ ë¡œë“œ
async function loadMarkets(){
  const r = await fetch(API('/v1/market/all?isDetails=true'));
  const j = await r.json();
  state.markets = j.filter(x=>x.market.startsWith('KRW-'));
  state.mapByMarket.clear(); state.mapByKorean.clear();
  for(const m of state.markets){
    state.mapByMarket.set(m.market, m);
    state.mapByKorean.set(m.korean_name, m.market);
  }
  // ê²€ìƒ‰ íƒœê·¸ í‘œì‹œ
  const tags = document.getElementById('tags');
  tags.innerHTML = state.markets.slice(0,20).map(m=>`<span class="chip">${m.korean_name}</span>`).join('');
}

// í‹°ì»¤ ë¡œë“œ (ë³€ë™ë¥ /ê°€ê²©)
async function loadTickers(){
  const markets = state.markets.map(m=>m.market).join(',');
  const r = await fetch(API(`/v1/ticker?markets=${markets}`));
  const j = await r.json();
  state.lastTick.clear();
  for(const t of j) state.lastTick.set(t.market, t);
  document.getElementById('tsUp').textContent = 'ï½œì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');
  document.getElementById('tsDn').textContent = 'ï½œì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');
  renderLists();
}

// ì˜¤ë”ë¶ ì¼ë¶€ (ë§¤ìˆ˜/ë§¤ë„ ëŒ€ëµ í‘œì‹œ)
async function getOrderbook(market){
  const r = await fetch(API(`/v1/orderbook?markets=${market}`));
  const j = await r.json();
  const ob = j && j[0];
  if(!ob) return {bid: null, ask: null};
  const bid = ob.bid_units?.[0]?.price ?? null;
  const ask = ob.ask_units?.[0]?.price ?? null;
  return {bid, ask};
}

function renderLists(){
  const arr = [];
  for(const m of state.markets){
    const t = state.lastTick.get(m.market);
    if(!t) continue;
    arr.push({
      market: m.market,
      name: m.korean_name,
      price: t.trade_price,
      chg: t.signed_change_rate || 0
    });
  }
  const up = [...arr].sort((a,b)=>b.chg-a.chg).slice(0,10);
  const dn = [...arr].sort((a,b)=>a.chg-b.chg).slice(0,10);
  fillTable('upT', up);
  fillTable('dnT', dn);
}

async function fillTable(id, rows){
  const tb = document.querySelector(`#${id} tbody`);
  const html = await Promise.all(rows.map(async (r,i)=>{
    const ob = await getOrderbook(r.market);
    const buy = ob.bid ? nf0.format(ob.bid) : 'â€”';
    const sell = ob.ask ? nf0.format(ob.ask) : 'â€”';
    const stop = nf0.format(Math.max(r.price*0.95, r.price - r.price*0.07)); // v6.3 ë°±ì—… ê¸°ì¤€ ë³´ìˆ˜ì  ì†ì ˆ ë””í´íŠ¸
    const risk = riskText(r.chg);
    const note = noteText(r.chg);
    return `<tr>
      <td>${i+1}</td>
      <td>${r.name} <span class="muted">(${r.market})</span></td>
      <td>${nf0.format(r.price)}</td>
      <td class="${r.chg>=0?'pos':'neg'}">${pct(r.chg)}</td>
      <td>${buy}</td>
      <td>${sell}</td>
      <td>${stop}</td>
      <td>${risk}</td>
      <td>${note}</td>
    </tr>`;
  }));
  tb.innerHTML = html.join('');
}

// ê²€ìƒ‰ í•¸ë“¤ë§
async function onSearch(q){
  q = q.trim();
  if(!q){ document.getElementById('summary').textContent='ì½”ì¸ì„ ê²€ìƒ‰í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.'; return; }
  let market = null;

  if(q.toUpperCase().startsWith('KRW-')) market = q.toUpperCase();
  if(!market){
    // í•œê¸€ëª…/ì˜ë¬¸ì‹¬ë³¼ ì‹œë„
    if(state.mapByKorean.has(q)) market = state.mapByKorean.get(q);
    else {
      // ì‹¬ë³¼/ì˜ë¬¸ëª… ì¶”ì •
      const cand = state.markets.find(m=>m.english_name?.toUpperCase().includes(q.toUpperCase()) || m.market.endsWith('-'+q.toUpperCase()));
      if(cand) market = cand.market;
    }
  }
  if(!market){ alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }

  const t = state.lastTick.get(market);
  if(!t){ alert('í‹°ì»¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

  const ob = await getOrderbook(market);
  const buy = ob.bid ? nf0.format(ob.bid) : 'â€”';
  const sell = ob.ask ? nf0.format(ob.ask) : 'â€”';
  const stop = nf0.format(Math.max(t.trade_price*0.95, t.trade_price - t.trade_price*0.07));
  const risk = riskText(t.signed_change_rate||0);
  const note = noteText(t.signed_change_rate||0);

  document.getElementById('summary').innerHTML =
    `<div><b>${state.mapByMarket.get(market)?.korean_name}</b> <span class="muted">(${market})</span></div>
     <div style="margin-top:6px">í˜„ì¬ê°€ <b>${nf0.format(t.trade_price)}</b> / ë³€ë™ë¥  <b class="${t.signed_change_rate>=0?'pos':'neg'}">${pct(t.signed_change_rate)}</b></div>`;
  document.getElementById('sel').innerHTML =
    `ë§¤ìˆ˜ <b>${buy}</b> ï½œ ë§¤ë„ <b>${sell}</b> ï½œ ì†ì ˆ <b>${stop}</b>`;
  document.getElementById('selMore').textContent = `ìœ„í—˜ë„ ${risk} ï½œ ì©”ì–´í•œë§ˆë””: ${note}`;
}

document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') onSearch(e.target.value);
});

(async function boot(){
  try{
    await loadMarkets();
    await loadTickers();
    // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
    setInterval(loadTickers, 30000);
  }catch(e){
    console.error(e);
    alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + e);
  }
})();
</script>
</body>
</html>
