<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ v6.7a</title>
<style>
  :root{
    --bg:#0e1116; --panel:#121923; --panel2:#0f151e; --muted:#9aa9bb; --text:#e6edf3;
    --br:#1e2a39; --chip:#152131; --chip2:#0f1a28;
    --pos:#2ecb70; --neg:#ff6377; --warn:#ffb84d; --accent:#5ec8ff;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  a{color:inherit}
  .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
  .row{display:flex;align-items:center;gap:10px}
  .sp{flex:1}
  .badge{font-size:12px;padding:5px 10px;border:1px solid var(--br);background:#0b1522;border-radius:999px}
  .hud{gap:8px;margin-bottom:12px}
  .clock{color:var(--muted);font-size:12px}

  .panel{background:var(--panel);border:1px solid var(--br);border-radius:14px;padding:14px}
  .panel + .panel{margin-top:12px}

  /* ê²€ìƒ‰ì¤„ */
  .searchbar{background:var(--panel2);border:1px solid var(--br);border-radius:12px;padding:10px}
  .input{height:40px;background:var(--chip2);border:1px solid var(--br);border-radius:10px;color:var(--text);padding:0 12px;outline:none;flex:1}
  .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid var(--br);background:#102033;color:var(--text);cursor:pointer}
  .btn:hover{filter:brightness(1.12)}

  /* ì„ íƒì½”ì¸ 1ì¤„ */
  .bar{display:grid;grid-template-columns:1.4fr repeat(7,1fr);gap:8px}
  .cell,.th{height:46px;display:flex;align-items:center;justify-content:center;border:1px solid var(--br);border-radius:10px;background:var(--chip2)}
  .th{background:#0e1623;color:var(--muted);height:34px;border-radius:8px;font-size:12px}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 9px;border:1px solid var(--br);background:var(--chip);border-radius:999px;font-size:12px;color:#a9b8c9}

  /* í‘œ */
  .table{border:1px solid var(--br);border-radius:12px;overflow:auto;max-height:520px}
  .head{position:sticky;top:0;background:linear-gradient(180deg,rgba(18,25,35,.95),rgba(18,25,35,.86));backdrop-filter:blur(6px);z-index:3}
  .grid{display:grid;gap:8px;padding:8px}
  .cols{grid-template-columns: 56px 1.4fr repeat(6,1fr)}
  .th2{padding:8px 6px;border-bottom:1px solid #182232;color:var(--muted);font-size:12px;white-space:nowrap}
  .row2{padding:10px 6px;border-bottom:1px solid #182232;display:grid;grid-template-columns:inherit;align-items:center}
  .right{justify-self:end}
  .center{text-align:center}
  .tag{font-size:12px;padding:3px 8px;border:1px solid var(--br);background:#0f1826;border-radius:999px}
  .tag.warn{color:#ffc56b;border-color:#3a2b12;background:#2a1d08}
  .tag.ok{color:#9ecbff;border-color:#263a57;background:#0f213a}

  /* íƒ€ì´í‹€ */
  .title-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .ttl{font-weight:700}
</style>
</head>
<body>
<div class="wrap">

  <!-- HUD -->
  <div class="row hud">
    <span class="badge">ì©”ì–´ì§€ê°‘ v6.7a</span>
    <span class="badge" id="net">ONLINE</span>
    <div class="sp"></div>
    <span class="clock" id="clock">KST â€”</span>
  </div>

  <!-- ê²€ìƒ‰/ì´ˆê¸°í™” -->
  <div class="searchbar row">
    <input id="q" class="input" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH / ì•„ë°œë€ì²´ / AVAX)" />
    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
    <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- ì„ íƒ ì½”ì¸ ìš”ì•½ -->
  <div class="panel">
    <div class="bar" style="margin-bottom:8px">
      <div class="th">ì½”ì¸ëª…</div><div class="th">í˜„ì¬ê°€</div><div class="th">ë³€ë™ë¥ </div>
      <div class="th">ë§¤ìˆ˜</div><div class="th">ë§¤ë„</div><div class="th">ì†ì ˆ</div><div class="th">ìœ„í—˜ë„</div><div class="th">ì©”ì–´í•œë§ˆë””</div>
    </div>
    <div class="bar">
      <div class="cell" id="sel-name">ì—†ìŒ</div>
      <div class="cell" id="sel-price">â€”</div>
      <div class="cell" id="sel-rate">â€”</div>
      <div class="cell" id="sel-bid">â€”</div>
      <div class="cell" id="sel-ask">â€”</div>
      <div class="cell" id="sel-cut">â€”</div>
      <div class="cell" id="sel-risk">â€”</div>
      <div class="cell" id="sel-note">â€”</div>
    </div>
  </div>

  <!-- ê¸‰ë“± -->
  <div class="panel">
    <div class="title-row">
      <span class="ttl">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</span>
      <span class="small muted">ì‹¤ì‹œê°„ ìë™ ì •ë ¬</span>
    </div>
    <div class="table">
      <div class="grid cols head">
        <div class="th2">#</div><div class="th2">ì½”ì¸ëª…(í•œê¸€)</div>
        <div class="th2 right">í˜„ì¬ê°€</div><div class="th2 right">ë³€ë™ë¥ </div>
        <div class="th2 right">ë§¤ìˆ˜</div><div class="th2 right">ë§¤ë„</div>
        <div class="th2 right">ì†ì ˆ</div><div class="th2 center">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      </div>
      <div id="upList"></div>
    </div>
  </div>

  <!-- ê¸‰ë½ -->
  <div class="panel">
    <div class="title-row">
      <span class="ttl">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</span>
      <span class="small muted">ê¸‰ë“±ê³¼ ë™ì¼ í¬ë§·</span>
    </div>
    <div class="table">
      <div class="grid cols head">
        <div class="th2">#</div><div class="th2">ì½”ì¸ëª…(í•œê¸€)</div>
        <div class="th2 right">í˜„ì¬ê°€</div><div class="th2 right">ë³€ë™ë¥ </div>
        <div class="th2 right">ë§¤ìˆ˜</div><div class="th2 right">ë§¤ë„</div>
        <div class="th2 right">ì†ì ˆ</div><div class="th2 center">ìœ„í—˜ë„ Â· ì©”ì–´í•œë§ˆë””</div>
      </div>
      <div id="dnList"></div>
    </div>
  </div>

</div>

<script>
/* ========== ê³µí†µ ========== */
const API = p => `/api/upbit?path=${encodeURIComponent(p)}`;
function nowKST(){
  const d=new Date(),z=d.getTimezoneOffset();
  return new Date(d.getTime()-z*60000+9*3600000).toISOString().substring(11,19);
}
setInterval(()=>{document.getElementById('clock').textContent='KST â€” '+nowKST();},1000);

/* ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„(í‹±ì‚¬ì´ì¦ˆ) */
function priceStep(p){
  if(p>=2_000_000) return 1000;
  if(p>=1_000_000) return 500;
  if(p>=500_000)  return 100;
  if(p>=100_000)  return 50;
  if(p>=10_000)   return 10;
  if(p>=1_000)    return 1;
  if(p>=100)      return 0.1;
  if(p>=10)       return 0.01;
  if(p>=1)        return 0.001;
  if(p>=0.1)      return 0.0001;
  if(p>=0.01)     return 0.00001;
  return 0.000001;
}
function roundStep(x,s,dir=0){const f=1/s; if(dir<0) return Math.floor(x*f)/f; if(dir>0) return Math.ceil(x*f)/f; return Math.round(x*f)/f;}
function fmt(p){
  if(p>=1_000) return p.toLocaleString('ko-KR',{maximumFractionDigits:0});
  if(p>=100)   return p.toFixed(1);
  if(p>=10)    return p.toFixed(2);
  if(p>=1)     return p.toFixed(3);
  if(p>=0.1)   return p.toFixed(4);
  if(p>=0.01)  return p.toFixed(5);
  return p.toFixed(6);
}
function taps(t){
  const p=t.trade_price||0, s=priceStep(p);
  return {
    bid: roundStep(p*0.998,s,-1),
    ask: roundStep(p*1.002,s,+1),
    cut: roundStep(p*0.980,s, 0)
  };
}
function riskBadge(t){
  const r=Math.abs(t.signed_change_rate||0);
  if(r>0.08) return '<span class="tag warn">3(ì£¼ì˜)</span>';
  if(r>0.04) return '<span class="tag">2(ë³´í†µ)</span>';
  return '<span class="tag ok">1(ì•ˆì •)</span>';
}
function noteWord(t){
  const r=t.signed_change_rate||0;
  if(r>0.06) return 'ğŸš€ í­ë“± ì‹ í˜¸!';
  if(r>0.02) return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
  if(r<-0.06) return 'ğŸ§Š ê¸‰ë½ ìœ„í—˜';
  if(r<-0.02) return 'âš ï¸ ì•½ì„¸';
  return 'ğŸ‘€ ê´€ë§';
}

/* ========== ë°ì´í„° ========== */
let MARKETS=[], KNAME=new Map(), TICK=new Map();
async function loadMarkets(){
  try{
    const r=await fetch(API('/v1/market/all?isDetails=true'));
    const a=await r.json();
    MARKETS = a.filter(m=>m.market.startsWith('KRW-'));
    MARKETS.forEach(m=>KNAME.set(m.market, m.korean_name));
  }catch(e){ alert('ë§ˆì¼“ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); }
}
async function loadTickers(list){
  const r=await fetch(API('/v1/ticker?markets='+list.join(',')),{cache:'no-store'});
  if(!r.ok) return;
  const a=await r.json();
  a.forEach(t=>TICK.set(t.market,t));
}
async function refreshAll(){
  const batch=80;
  for(let i=0;i<MARKETS.length;i+=batch){
    await loadTickers(MARKETS.slice(i,i+batch).map(m=>m.market));
    await new Promise(res=>setTimeout(res,120));
  }
}

/* ========== ë Œë”ë§ ========== */
function coinRow(t, idx){
  const r=(t.signed_change_rate||0)*100;
  const cls=r>=0?'pos':'neg';
  const tv=taps(t);
  return `
    <div class="row2 cols">
      <div>${idx}</div>
      <div>${KNAME.get(t.market)||t.market}</div>
      <div class="right">${fmt(t.trade_price)}</div>
      <div class="right ${cls}">${r.toFixed(2)}%</div>
      <div class="right">${fmt(tv.bid)}</div>
      <div class="right">${fmt(tv.ask)}</div>
      <div class="right">${fmt(tv.cut)}</div>
      <div class="center">${riskBadge(t)} &nbsp; <span class="small">${noteWord(t)}</span></div>
    </div>`;
}
function renderTop(){
  const arr=[...TICK.values()];
  const ups=arr.filter(t=>t.signed_change_rate>0).sort((a,b)=>b.signed_change_rate-a.signed_change_rate).slice(0,10);
  const dns=arr.filter(t=>t.signed_change_rate<0).sort((a,b)=>a.signed_change_rate-b.signed_change_rate).slice(0,10);
  document.getElementById('upList').innerHTML = ups.map((t,i)=>coinRow(t,i+1)).join('')||'';
  document.getElementById('dnList').innerHTML = dns.map((t,i)=>coinRow(t,i+1)).join('')||'';
}
function renderSelected(mkt){
  const t=TICK.get(mkt);
  if(!t){
    document.getElementById('sel-name').textContent='ì—†ìŒ';
    ['price','rate','bid','ask','cut','risk','note'].forEach(id=>document.getElementById('sel-'+id).textContent='â€”');
    return;
  }
  const tv=taps(t), r=(t.signed_change_rate||0)*100, cls=r>=0?'pos':'neg';
  document.getElementById('sel-name').textContent = `${KNAME.get(t.market)||t.market} (${t.market})`;
  document.getElementById('sel-price').textContent = fmt(t.trade_price);
  document.getElementById('sel-rate').innerHTML = `<span class="${cls}">${r.toFixed(2)}%</span>`;
  document.getElementById('sel-bid').textContent = fmt(tv.bid);
  document.getElementById('sel-ask').textContent = fmt(tv.ask);
  document.getElementById('sel-cut').textContent = fmt(tv.cut);
  document.getElementById('sel-risk').innerHTML = riskBadge(t);
  document.getElementById('sel-note').textContent = noteWord(t);
}

/* ========== ê²€ìƒ‰ ========== */
function findMarket(q){
  q=q.trim().toLowerCase();
  if(!q) return null;
  return MARKETS.find(m=>
     m.market.toLowerCase()===q ||
     m.market.toLowerCase().includes(q) ||
     (m.korean_name||'').toLowerCase().includes(q) ||
     (m.english_name||'').toLowerCase().includes(q)
  ) || null;
}
document.getElementById('btnSearch').onclick=()=>{
  const q=document.getElementById('q').value;
  const m=findMarket(q);
  if(!m){ alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼/ë§ˆì¼“ì½”ë“œ ì§€ì›)'); return; }
  window.__sel=m.market; renderSelected(window.__sel);
};
document.getElementById('btnReset').onclick=()=>{
  document.getElementById('q').value=''; window.__sel=null; renderSelected(null);
};

/* ========== ë¶€íŒ… ========== */
async function boot(){
  await loadMarkets();
  await refreshAll();
  renderTop();
  // ê¸°ë³¸ ì„ íƒ: ì²« ê¸‰ë“± í•­ëª©ì´ ìˆìœ¼ë©´ í‘œì‹œ
  const firstUp=[...TICK.values()].sort((a,b)=>b.signed_change_rate-a.signed_change_rate)[0];
  if(firstUp){ window.__sel=firstUp.market; renderSelected(window.__sel); }

  setInterval(async()=>{
    await refreshAll();
    renderTop();
    if(window.__sel) renderSelected(window.__sel);
  }, 15000);
}
boot();
</script>
</body>
</html>
