<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì©”ì–´ì§€ê°‘ v6.3 â€” ì§€ì†í˜• ì €ì¥(ìºì‹œ) + ìœ„ë¡œì •ë ¬ + í”„ë¡ì‹œìë™ëŒ€ì²´</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
:root{--bg:#0d1117;--panel:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#9fb1c1;--up:#16c784;--down:#ea3943;--chip:#223045}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR}
.wrap{max-width:1150px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
.badge{background:var(--chip);border:1px solid #283752;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25);margin-top:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button{background:#0e141b;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
input{flex:1;min-width:260px}button{cursor:pointer}button:hover{background:#1a2330}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--line);text-align:center}
.muted{color:var(--muted)}.chg.up{color:var(--up);font-weight:700}.chg.down{color:var(--down);font-weight:700}
.risk{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-weight:700}
.r1{background:#0f2b12;color:#88f36b}.r2{background:#2b230f;color:#ffd75e}.r3{background:#2b0f0f;color:#ff6b6b}
.title{display:flex;align-items:center;gap:8px}.title .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0e141b}
.err{color:#ff6b6b;font-size:12px;margin-top:6px;display:none}
.flash{animation:flash .9s ease-out 1}@keyframes flash{0%{background:rgba(255,255,0,.18)}100%{background:transparent}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ì©”ì–´ì§€ê°‘ <span class="badge">v6.3</span> <span class="badge" id="net">OFFLINE</span></h1>
    <div class="badge" id="clock">KST â€” --:--:--</div>
  </header>

  <!-- ê²€ìƒ‰ -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸/ë¹„íŠ¸ì½”ì¸ìºì‹œ/ì´ë”ë¦¬ì›€/ì´ë”ë¦¬ì›€í´ë˜ì‹/ETH/BTC/KRW-ETH)" autocomplete="off"/>
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnClear">ì´ˆê¸°í™”</button>
    </div>
    <div id="searchError" class="err"></div>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <div class="card" id="result" style="display:none">
    <div class="title"><b>ì„ íƒëœ ì½”ì¸:</b> <span id="selName">-</span> <span class="tag" id="selMarket">â€”</span></div>
    <table style="margin-top:10px">
      <thead><tr class="muted"><th>í˜„ì¬ê°€</th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ë³€ë™ë¥ </th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr></thead>
      <tbody><tr>
        <td id="s_price">â€”</td><td id="s_buy">â€”</td><td id="s_sell">â€”</td><td id="s_stop">â€”</td>
        <td id="s_rate">â€”</td><td id="s_risk">â€”</td><td id="s_comment">â€”</td>
      </tr></tbody>
    </table>
  </div>

  <!-- ê¸‰ë“± Top 10 -->
  <div class="card">
    <div class="title">
      <b>ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</b>
      <span class="tag" id="tagUp">ì¡°ê±´: 5%â†‘ Â· 24h 10ì–µâ†‘</span>
      <span class="tag" id="upSource" style="display:none">ìºì‹œ</span>
    </div>
    <table>
      <thead><tr class="muted"><th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr></thead>
      <tbody id="feedUp"></tbody>
    </table>
  </div>

  <!-- ê¸‰ë½ Top 10 -->
  <div class="card">
    <div class="title">
      <b>ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</b>
      <span class="tag" id="tagDown">ì¡°ê±´: -5%â†“ Â· 24h 10ì–µâ†‘</span>
      <span class="tag" id="downSource" style="display:none">ìºì‹œ</span>
    </div>
    <table>
      <thead><tr class="muted"><th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th></tr></thead>
      <tbody id="feedDown"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== ì‹œê³„/ìƒíƒœ ===== */
(function(){
  function tick(){
    var c=document.getElementById('clock'), n=document.getElementById('net'); if(!c||!n) return;
    var now=new Date(), utc=now.getTime()+now.getTimezoneOffset()*60000, kst=new Date(utc+9*3600000);
    c.textContent='KST â€” '+kst.toLocaleTimeString('ko-KR',{hour12:false});
    var on=navigator.onLine; n.textContent=on?'ONLINE':'OFFLINE'; n.style.background=on?'#123922':'#3a1a1a';
  }
  setInterval(tick,1000); tick();
})();

/* ===== í”„ë¡ì‹œ/API (ìë™ ëŒ€ì²´) ===== */
var PROXIES = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
var API = 'https://api.upbit.com/v1/';
function withProxy(url,i){ return (PROXIES[i||0]) + url; }
async function fetchJSONWithFallback(url,timeout){
  const ts = timeout || 9000;
  for(let i=0;i<PROXIES.length;i++){
    try{
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), ts);
      const r = await fetch(withProxy(url, i), {signal:ctrl.signal, cache:'no-store'});
      clearTimeout(t); if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ if(i===PROXIES.length-1) throw e; }
  }
}

/* ===== ì´ë¦„ ë§µ/ìºì‹œ + ë³„ëª…(ì•Œë¦¬ì•„ìŠ¤) ===== */
var NAME_CACHE_KEY='upbit_names_cache_v3';
var NAME_BY_MARKET={}, NAME_BY_SYM={}, ALIAS_TO_MARKET={
  'ë¹„íŠ¸ì½”ì¸':'KRW-BTC','ë¹„íŠ¸':'KRW-BTC','BTC':'KRW-BTC','BITCOIN':'KRW-BTC',
  'ë¹„íŠ¸ì½”ì¸ìºì‹œ':'KRW-BCH','ë¹„íŠ¸ì½”ì¸ìºì‰¬':'KRW-BCH','ë¹„ìº':'KRW-BCH','BCH':'KRW-BCH','BITCOINCASH':'KRW-BCH',
  'ì´ë”ë¦¬ì›€':'KRW-ETH','ETH':'KRW-ETH','ETHEREUM':'KRW-ETH',
  'ì´ë”ë¦¬ì›€í´ë˜ì‹':'KRW-ETC','ì´í´':'KRW-ETC','ETC':'KRW-ETC','ETHEREUMCLASSIC':'KRW-ETC',
};
function saveNameCache(o){ try{localStorage.setItem(NAME_CACHE_KEY,JSON.stringify(o));}catch(e){} }
function loadNameCache(){ try{return JSON.parse(localStorage.getItem(NAME_CACHE_KEY)||'{}');}catch(e){return {}} }
function normalize(s){ return (s||'').toString().normalize('NFC').replace(/\s+/g,'').toUpperCase(); }
function SYM(m){ return m.replace('KRW-',''); }
function ko(mOrS){
  if(!mOrS) return 'ì´ë¦„ë¯¸ì •';
  if(mOrS.indexOf && mOrS.indexOf('KRW-')===0) return NAME_BY_MARKET[mOrS]||'ì´ë¦„ë¯¸ì •';
  return NAME_BY_SYM[mOrS]||'ì´ë¦„ë¯¸ì •';
}
(function hydrate(){
  var c=loadNameCache(); var bm=c.byMarket||{}, bs=c.bySym||{};
  for(var k in bm) NAME_BY_MARKET[k]=bm[k];
  for(var s in bs) NAME_BY_SYM[s]=bs[s];
})();
async function ensureMarkets(){
  if(Object.keys(NAME_BY_MARKET).length) return;
  const all = await fetchJSONWithFallback(API+'market/all?isDetails=false', 9000);
  const list = (all||[]).filter(x=>x.market.indexOf('KRW-')===0);
  for(let i=0;i<list.length;i++){
    const m=list[i], sym=SYM(m.market), k=(m.korean_name||'').trim()||sym;
    NAME_BY_MARKET[m.market]=k; NAME_BY_SYM[sym]=k;
  }
  saveNameCache({byMarket:NAME_BY_MARKET, bySym:NAME_BY_SYM});
  var n=document.getElementById('net'); n.textContent='ONLINE'; n.style.background='#123922';
}

/* ===== í˜¸ê°€ë‹¨ìœ„/í‘œì‹œ (ì ˆì‚¬ë¡œ ì •í™•íˆ) ===== */
function getTick(p){
  if(p>=2000000) return 1000; if(p>=1000000) return 500; if(p>=500000) return 100;
  if(p>=100000) return 50; if(p>=10000) return 10; if(p>=1000) return 5; if(p>=100) return 1;
  if(p>=10) return 0.1; if(p>=1) return 0.01; if(p>=0.1) return 0.001; if(p>=0.01) return 0.0001;
  if(p>=0.001) return 0.00001; if(p>=0.0001) return 0.000001; if(p>=0.00001) return 0.0000001;
  if(p>=0.000001) return 0.00000001; return 0.000000001;
}
function fmtKRW(x){
  var t=getTick(x), d=(t.toString().split('.')[1]||'').length;
  var r=Math.floor(x/t)*t; // ì—…ë¹„íŠ¸ í˜¸ê°€ ë‹¨ìœ„ì™€ ì¼ì¹˜
  return r.toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function riskText(r){var v=Math.abs(r*100); return v<1?'1(ì•ˆì •)':(v<3?'2(ë³´í†µ)':'3(ì£¼ì˜)');}
function riskClass(r){var v=Math.abs(r*100); return v<1?'r1':(v<3?'r2':'r3');}
function zzeolComment(r){return r>0.1?'ğŸš€ í­ë“± ëª¨ë“œ!':(r>0.05?'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!':(r>0.02?'ğŸ“ˆ ìƒìŠ¹ íƒ„ë ¥':(r<-0.1?'ğŸ’£ ê¸‰ë½ ê²½ê³ ':(r<-0.05?'âš ï¸ ì•½ì„¸ ì „í™˜':'âš–ï¸ ê´€ë§'))));}

/* ===== ê²€ìƒ‰ ===== */
function findMarketByQuery(qRaw){
  var q=normalize(qRaw);
  if(ALIAS_TO_MARKET[q]) return ALIAS_TO_MARKET[q];
  if(/^KRW-[A-Z0-9]+$/.test(qRaw.toUpperCase())) return qRaw.toUpperCase();
  var keys=Object.keys(NAME_BY_MARKET), found=null;
  for(var i=0;i<keys.length;i++){
    var k=keys[i]; var sym=normalize(SYM(k)); var koName=normalize(NAME_BY_MARKET[k]||'');
    if(normalize(k)===q || sym===q || koName===q){ found=k; break; }
  }
  if(!found){
    for(var j=0;j<keys.length;j++){
      var kk=keys[j]; var sym2=normalize(SYM(kk)); var ko2=normalize(NAME_BY_MARKET[kk]||'');
      if(normalize(kk).indexOf(q)>-1 || sym2.indexOf(q)>-1 || ko2.indexOf(q)>-1){ found=kk; break; }
    }
  }
  return found;
}
async function doSearch(){
  var err=document.getElementById('searchError'); if(err) err.style.display='none';
  var q=document.getElementById('q').value; if(!q){document.getElementById('q').focus();return;}
  try{
    await ensureMarkets();
    var market=findMarketByQuery(q);
    if(!market){ err.textContent="ì¼ì¹˜ ì½”ì¸ ì—†ìŒ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸/ë¹„íŠ¸ì½”ì¸ìºì‹œ/ì´ë”ë¦¬ì›€/ì´ë”ë¦¬ì›€í´ë˜ì‹/ETH/BTC/KRW-ETH)"; err.style.display='block'; return; }
    var d=await fetchJSONWithFallback(API+'ticker?markets='+market,9000);
    var t=d[0], p=t.trade_price, r=t.signed_change_rate;
    document.getElementById('result').style.display='block';
    document.getElementById('selName').textContent=ko(market); document.getElementById('selMarket').textContent=market;
    document.getElementById('s_price').textContent=fmtKRW(p);
    document.getElementById('s_buy').textContent=fmtKRW(p*0.988);
    document.getElementById('s_sell').textContent=fmtKRW(p*1.012);
    document.getElementById('s_stop').textContent=fmtKRW(p*0.975);
    document.getElementById('s_rate').innerHTML='<span class="chg '+(r>=0?'up':'down')+'">'+(r*100).toFixed(2)+'%</span>';
    document.getElementById('s_risk').innerHTML='<span class="risk '+riskClass(r)+'">'+riskText(r)+'</span>';
    document.getElementById('s_comment').textContent=zzeolComment(r);
  }catch(e){ err.textContent='ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; err.style.display='block'; }
}
document.getElementById('btnSearch').addEventListener('click',doSearch);
document.getElementById('q').addEventListener('keydown',function(e){ if(e.key==='Enter') doSearch(); });
document.getElementById('btnClear').addEventListener('click',function(){ document.getElementById('q').value=''; document.getElementById('result').style.display='none'; document.getElementById('searchError').style.display='none'; });

/* ===== ì§€ì†í˜• ì €ì¥ (ê¸‰ë“±/ê¸‰ë½ ìºì‹œ) ===== */
const FEED_CACHE_KEY='zzeol_feed_cache_v1'; // {ts, ups:[{m,p,r}], downs:[{m,p,r}]}
function saveFeedCache(ups,downs){
  try{
    const pack=(arr)=>arr.map(t=>({m:t.market,p:t.trade_price,r:t.signed_change_rate}));
    const data={ts:Date.now(), ups:pack(ups).slice(0,10), downs:pack(downs).slice(0,10)};
    localStorage.setItem(FEED_CACHE_KEY, JSON.stringify(data));
  }catch(e){}
}
function loadFeedCache(){
  try{
    const s=localStorage.getItem(FEED_CACHE_KEY); if(!s) return null;
    const o=JSON.parse(s);
    if(!o.ups||!o.downs) return null;
    // 12ì‹œê°„ ì´ë‚´ ìºì‹œë§Œ ì‹ ë¢°
    if(Date.now() - (o.ts||0) > 12*3600*1000) return null;
    return o;
  }catch(e){ return null; }
}

/* ===== ê¸‰ë“±/ê¸‰ë½ ìŠ¤ìº” (ì¡°ê±´ ì™„í™” + ë¹ˆìƒíƒœ í‘œì‹œ + ìœ„ë¡œì •ë ¬) ===== */
function chunk(a,s){var o=[]; for(var i=0;i<a.length;i+=s) o.push(a.slice(i,i+s)); return o;}
async function scanOnce(){
  try{
    await ensureMarkets();
    const markets = Object.keys(NAME_BY_MARKET);
    const parts = chunk(markets, 60);
    let all = [];
    for(const part of parts){
      const j = await fetchJSONWithFallback(API+'ticker?markets='+part.join(','), 9000);
      all = all.concat(j||[]);
    }
    const volMin = 1_000_000_000; // 24h 10ì–µ
    const ups   = all.filter(t =>  (t.signed_change_rate||0) >  0.05 && (t.acc_trade_price_24h||0) >= volMin)
                     .sort((a,b)=> b.signed_change_rate - a.signed_change_rate).slice(0,10);
    const downs = all.filter(t =>  (t.signed_change_rate||0) < -0.05 && (t.acc_trade_price_24h||0) >= volMin)
                     .sort((a,b)=> a.signed_change_rate - b.signed_change_rate).slice(0,10);

    renderList('feedUp',   ups,   true);
    renderList('feedDown', downs, true);
    saveFeedCache(ups,downs);

    document.getElementById('upSource').style.display='none';
    document.getElementById('downSource').style.display='none';

    const n = document.getElementById('net'); n.textContent='ONLINE'; n.style.background='#123922';
  }catch(e){
    console.error(e);
    const n = document.getElementById('net'); n.textContent='OFFLINE (ì¬ì‹œë„ì¤‘)'; n.style.background='#3a1a1a';
    renderEmptyIfNeeded('feedUp',   'ì¡°ê±´ì— ë§ëŠ” ê¸‰ë“±ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.');
    renderEmptyIfNeeded('feedDown', 'ì¡°ê±´ì— ë§ëŠ” ê¸‰ë½ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.');
  }
}
function renderList(tbodyId, arr, reorder){
  const el = document.getElementById(tbodyId);
  if(!reorder) el.innerHTML='';
  if(!arr || arr.length===0){ renderEmptyIfNeeded(tbodyId, tbodyId==='feedUp' ? 'ì¡°ê±´ì— ë§ëŠ” ê¸‰ë“±ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.' : 'ì¡°ê±´ì— ë§ëŠ” ê¸‰ë½ì½”ì¸ì´ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.'); return; }

  // ë’¤ì—ì„œë¶€í„° prepend â†’ í™”ë©´ì—” ì˜¬ë°”ë¥¸ ìˆœì„œ
  for(let i=arr.length-1;i>=0;i--){
    const t = arr[i], p=t.trade_price, r=t.signed_change_rate, market=t.market;
    const row = el.querySelector('tr[data-market="'+market+'"]');
    const html = `
      <td class="rank"></td>
      <td>${ko(market)}</td>
      <td>${fmtKRW(p)}</td>
      <td class="chg ${r>=0?'up':'down'}">${(r*100).toFixed(2)}%</td>
      <td>${fmtKRW(p*0.988)}</td>
      <td>${fmtKRW(p*1.012)}</td>
      <td>${fmtKRW(p*0.975)}</td>
      <td><span class="risk ${riskClass(r)}">${riskText(r)}</span></td>
      <td>${zzeolComment(r)}</td>`;
    if(row){
      row.innerHTML = html; row.classList.add('flash'); el.prepend(row); setTimeout(rr=>rr.classList.remove('flash'), 800, row);
    }else{
      const tr=document.createElement('tr'); tr.dataset.market=market; tr.classList.add('flash'); tr.innerHTML=html; el.prepend(tr); setTimeout(rr=>rr.classList.remove('flash'), 800, tr);
    }
  }
  while(el.children.length>10) el.removeChild(el.lastChild);
  el.querySelectorAll('tr').forEach((r,idx)=>{ const c=r.querySelector('.rank'); if(c) c.textContent=(idx+1); });
}
function renderEmptyIfNeeded(tbodyId, msg){
  const el = document.getElementById(tbodyId);
  if(!el) return;
  el.innerHTML = `<tr><td colspan="9" class="muted">${msg}</td></tr>`;
}

/* ===== ë¶€íŒ…: ìºì‹œ ë¨¼ì € ë³´ì—¬ì£¼ê³  â†’ ì‹¤ë°ì´í„° ë®ì–´ì“°ê¸° ===== */
(function boot(){
  // 1) ìºì‹œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œ
  const cache = loadFeedCache();
  if(cache){
    // ìºì‹œ â†’ ê°€ì§œ í‹°ì»¤ë¡œ ë³µì›í•˜ì—¬ ë™ì¼ ë Œë” ì‚¬ìš©
    const inflate = (arr)=> (arr||[]).map(x=>({market:x.m, trade_price:x.p, signed_change_rate:x.r}));
    const ups = inflate(cache.ups), downs = inflate(cache.downs);
    if(ups.length){ renderList('feedUp', ups, true); document.getElementById('upSource').style.display='inline-block'; }
    if(downs.length){ renderList('feedDown', downs, true); document.getElementById('downSource').style.display='inline-block'; }
  }
  // 2) ë°”ë¡œ ì‹¤ì‹œê°„ ìŠ¤ìº”ìœ¼ë¡œ ë®ì–´ì“°ê¸°
  scanOnce();
  // 3) ì£¼ê¸° ê°±ì‹ (60ì´ˆ)
  setInterval(scanOnce, 60000);
})();

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
document.getElementById('btnSearch').addEventListener('click',doSearch);
document.getElementById('q').addEventListener('keydown',function(e){ if(e.key==='Enter') doSearch(); });
document.getElementById('btnClear').addEventListener('click',function(){ document.getElementById('q').value=''; document.getElementById('result').style.display='none'; document.getElementById('searchError').style.display='none'; });
<!-- íƒ€ì  ì „ëµ ë¡œë” (UI ê±´ë“œë¦¬ì§€ ì•ŠìŒ) -->
<script type="module" src="/strategies/loader.js"></script>
</script>
<!-- ì©”ì–´ì§€ê°‘ 6.0 íƒ€ì  ë¡œë” ì—°ê²° -->
<script type="module" src="/strategies/loader.js"></script>
<script>
/* ===== Upbit ì‹¤ì‹œê°„ ë™ê¸°í™” ëª¨ë“ˆ =====
   - WebSocket(ì—…ë¹„íŠ¸ ê³µì‹)ë¡œ í˜„ì¬ê°€ë¥¼ ì‹¤ì‹œê°„ ë°˜ì˜
   - ì‹¤íŒ¨/ì°¨ë‹¨ ì‹œ 1ì´ˆ REST í´ë§ìœ¼ë¡œ ìë™ í´ë°±
   - ê¸°ì¡´ UI/í•¨ìˆ˜(fmtKRW ë“±) ê·¸ëŒ€ë¡œ ì‚¬ìš©
*/
(function(){
  const WS_URL = 'wss://api.upbit.com/websocket/v1';
  let ws = null, alive = false, reconnectTimer = null, pollTimer = null;

  // í˜„ì¬ í™”ë©´ì—ì„œ êµ¬ë…í•´ì•¼ í•  ë§ˆì¼“ ì½”ë“œ ìˆ˜ì§‘
  function collectMarkets(){
    const set = new Set();

    // 1) ê²€ìƒ‰ ê²°ê³¼
    const selMkt = document.getElementById('selMarket');
    if (selMkt && selMkt.textContent && /^KRW-[A-Z0-9]+$/.test(selMkt.textContent)) {
      set.add(selMkt.textContent.trim());
    }

    // 2) ê¸‰ë“±/ê¸‰ë½ í‘œ
    document.querySelectorAll('#feedUp tr[data-market], #feedDown tr[data-market]').forEach(tr=>{
      const m = tr.getAttribute('data-market');
      if (m) set.add(m);
    });

    // ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ (ì•ˆì „)
    return Array.from(set).slice(0, 100);
  }

  // DOM ì—…ë°ì´íŠ¸ (í˜„ì¬ê°€ & ë³€ë™ë¥ )
  function applyTicker(t){
    const market = t.code || t.market;
    const price  = t.trade_price;
    const rate   = (t.signed_change_rate ?? 0);

    // 1) ê²€ìƒ‰ ì¹´ë“œ
    const selMkt = document.getElementById('selMarket');
    if (selMkt && selMkt.textContent === market) {
      const priceEl = document.getElementById('s_price');
      const rateEl  = document.getElementById('s_rate');
      if (priceEl) priceEl.textContent = (typeof fmtKRW==='function') ? fmtKRW(price) : price.toLocaleString('ko-KR');
      if (rateEl)  rateEl.innerHTML = `<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
    }

    // 2) ê¸‰ë“±/ê¸‰ë½ í‘œ
    document.querySelectorAll(`tr[data-market="${market}"]`).forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      // ì»¬ëŸ¼: #, ì½”ì¸(í•œê¸€), í˜„ì¬ê°€, ë³€ë™ë¥ , ë§¤ìˆ˜, ë§¤ë„, ì†ì ˆ, ìœ„í—˜ë„, í•œë§ˆë””
      if (tds.length >= 9) {
        const pTxt = (typeof fmtKRW==='function') ? fmtKRW(price) : price.toLocaleString('ko-KR');
        tds[2].textContent = pTxt;                                 // í˜„ì¬ê°€
        tds[3].innerHTML   = `<span class="chg ${rate>=0?'up':'down'}">${(rate*100).toFixed(2)}%</span>`;
        // ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆì€ ê¸°ì¡´ ê³ ì •ì‹ ê¸°ì¤€ ì¦‰ì‹œ ê°±ì‹ (ì „ëµ ì£¼ì… ì‹œ calcTradeLevels ì‚¬ìš©)
        const calc = (window.calcTradeLevels || function(p){return {buy:p*0.988, sell:p*1.012, stop:p*0.975};});
        const L = calc(price, rate);
        tds[4].textContent = (typeof fmtKRW==='function') ? fmtKRW(L.buy)  : Math.floor(L.buy);
        tds[5].textContent = (typeof fmtKRW==='function') ? fmtKRW(L.sell) : Math.floor(L.sell);
        tds[6].textContent = (typeof fmtKRW==='function') ? fmtKRW(L.stop) : Math.floor(L.stop);
      }
    });
  }

  // WebSocket ì—°ê²°/êµ¬ë…
  function connect(){
    const codes = collectMarkets();
    if (codes.length === 0) { startPolling(); return; } // í™”ë©´ì— êµ¬ë… ëŒ€ìƒ ì—†ìœ¼ë©´ í´ë§ë¡œ

    try {
      stopPolling();
      if (ws) { try{ ws.close(); }catch(_){} ws=null; }
      ws = new WebSocket(WS_URL);

      ws.binaryType = 'blob';
      ws.onopen = () => {
        alive = true;
        // êµ¬ë… ë©”ì‹œì§€ ì „ì†¡
        const msg = [
          { ticket: 'zzeol-wallet' },
          { type: 'ticker', codes, isOnlyRealtime: true }
        ];
        ws.send(JSON.stringify(msg));
        // ìƒíƒœí‘œì‹œ
        const n=document.getElementById('net'); if(n){ n.textContent='ONLINE'; n.style.background='#123922'; }
      };
      ws.onmessage = async (e) => {
        // Upbit WSëŠ” Blob(JSON)ë¡œ ì˜´
        const text = await e.data.text();
        try { const data = JSON.parse(text); applyTicker(data); } catch (_){}
      };
      ws.onclose = () => { alive = false; scheduleReconnect(); };
      ws.onerror = () => { alive = false; scheduleReconnect(); };
    } catch (_) {
      scheduleReconnect();
    }
  }

  // ì¬ì—°ê²°
  function scheduleReconnect(){
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connect(); }, 1500);
    startPolling(); // WS ì•ˆë  ë•Œ ì¦‰ì‹œ í´ë°±
    const n=document.getElementById('net'); if(n){ n.textContent='OFFLINE (ì¬ì‹œë„)'; n.style.background='#3a1a1a'; }
  }

  // 1ì´ˆ REST í´ë§(WS ì°¨ë‹¨/ì‹¤íŒ¨ í´ë°±)
  function startPolling(){
    if (pollTimer) return;
    const api = 'https://api.upbit.com/v1/ticker?markets=';
    pollTimer = setInterval(async ()=>{
      const mkts = collectMarkets();
      if (mkts.length===0) return;
      try{
        const r = await fetch(api + encodeURIComponent(mkts.join(',')), { cache:'no-store' });
        if(!r.ok) throw 0;
        const arr = await r.json();
        arr.forEach(applyTicker);
      }catch(_){}
    }, 1000);
  }
  function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

  // ìµœì´ˆ ì—°ê²° & ì£¼ê¸°ì  ì¬êµ¬ë… (ë¦¬ìŠ¤íŠ¸ ë°”ë€” ìˆ˜ ìˆìœ¼ë‹ˆ)
  connect();
  setInterval(()=>{
    // ë¦¬ìŠ¤íŠ¸ ë³€ë™ ê°ì§€ìš©: ê°„ë‹¨íˆ ì¬ì—°ê²°
    if (alive) { try{ ws.close(); }catch(_){} }
    connect();
  }, 60*1000); // 1ë¶„ë§ˆë‹¤ êµ¬ë… ê°±ì‹ 
})();
</script>

</body>
</html>



