<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì©”ì–´ì§€ê°‘ v7.2 (ì•ˆì •íŒ)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif; background:#0b0f14; color:#e6edf3;}
    .wrap { max-width:1200px; margin:40px auto; padding:0 16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .chip { background:#121923; border:1px solid #1c2735; color:#a9b4c2; padding:6px 10px; border-radius:10px; font-size:12px;}
    .title { font-size:20px; font-weight:700; margin:8px 0 16px;}
    .card { background:#0f141c; border:1px solid #1b2533; border-radius:12px; padding:14px; }
    .search { flex:1; min-width:260px; display:flex; gap:8px; }
    .search input { flex:1; background:#0b1118; border:1px solid #1c2735; outline:none; color:#e6edf3; padding:10px 12px; border-radius:10px; }
    .btn { background:#142031; border:1px solid #243043; color:#cfe4ff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn:hover{ filter:brightness(1.15); }
    .metrics { display:grid; grid-template-columns: repeat(8, 1fr); gap:10px; }
    .metric { background:#0b1118; border:1px solid #1c2735; border-radius:10px; padding:10px; text-align:center;}
    .metric .k { display:block; color:#8aa4bd; font-size:12px;}
    .metric .v { display:block; color:#e6edf3; font-size:16px; font-weight:700;}
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #182234; text-align:right; white-space:nowrap;}
    th:nth-child(2), td:nth-child(2){ text-align:left; }
    thead th { color:#8aa4bd; font-weight:600; }
    .pos { color:#2ecb70; font-weight:700;}
    .neg { color:#ff6b6b; font-weight:700;}
    .muted{ color:#8aa4bd;}
    .tag { padding:2px 8px; border-radius:999px; font-size:12px; background:#101724; border:1px solid #233049; color:#c8d8ef; display:inline-block;}
    .sticky { position:sticky; top:0; background:#0f141c; z-index:5;}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="row">
      <span class="chip">ì©”ì–´ì§€ê°‘ v7.2</span>
      <span class="chip">ONLINE</span>
      <span id="clock" class="chip">KST â€”</span>
    </div>

    <div class="row" style="margin:14px 0 18px;">
      <div class="search">
        <input id="searchInput" type="search" placeholder="ì½”ì¸ëª… ì…ë ¥ (ì˜ˆ: ì´ë”ë¦¬ì›€ / ETH / KRW-ETH / ì‹œë°”ì´ëˆ„ / SHIB)" />
        <button id="btnSearch" class="btn">ê²€ìƒ‰</button>
        <button id="btnReset" class="btn" title="ì„ íƒ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
      </div>
      <span class="chip">ì‹¤ì‹œê°„ ê¸‰ë“±í˜•</span>
    </div>

    <div id="selectedCard" class="card" style="margin-bottom:18px;">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="title" id="selTitle">ì„ íƒëœ ì½”ì¸: <span class="muted">ì—†ìŒ</span></div>
        <div class="muted">ë³€ë™ë¥ ì€ í‹°ì»¤ ê¸°ì¤€(ì—…ë¹„íŠ¸) â€¢ í˜¸ê°€ë‹¨ìœ„ ë°˜ì˜</div>
      </div>
      <div class="metrics">
        <div class="metric"><span class="k">í˜„ì¬ê°€</span><span id="mPrice" class="v">â€”</span></div>
        <div class="metric"><span class="k">ë³€ë™ë¥ </span><span id="mChange" class="v">â€”</span></div>
        <div class="metric"><span class="k">ë§¤ìˆ˜</span><span id="mBid" class="v">â€”</span></div>
        <div class="metric"><span class="k">ë§¤ë„</span><span id="mAsk" class="v">â€”</span></div>
        <div class="metric"><span class="k">ì†ì ˆ</span><span id="mStop" class="v">â€”</span></div>
        <div class="metric"><span class="k">ìœ„í—˜ë„</span><span id="mRisk" class="v">â€”</span></div>
        <div class="metric"><span class="k">ì©”ì–´í•œë§ˆë””</span><span id="mZz" class="v">â€”</span></div>
        <div class="metric"><span class="k">ë§ˆì¼“ì½”ë“œ</span><span id="mCode" class="v">â€”</span></div>
      </div>
    </div>

    <div class="row" style="gap:16px;">
      <div class="card" style="flex:1; min-width:520px;">
        <div class="title sticky">ğŸ”¥ ê¸‰ë“±ì½”ì¸ Top 10</div>
        <table>
          <thead><tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr></thead>
          <tbody id="upList"></tbody>
        </table>
      </div>
      <div class="card" style="flex:1; min-width:520px;">
        <div class="title sticky">ğŸ’§ ê¸‰ë½ì½”ì¸ Top 10</div>
        <table>
          <thead><tr>
            <th>#</th><th>ì½”ì¸ëª…(í•œê¸€)</th><th>í˜„ì¬ê°€</th><th>ë³€ë™ë¥ </th><th>ë§¤ìˆ˜</th><th>ë§¤ë„</th><th>ì†ì ˆ</th><th>ìœ„í—˜ë„</th><th>ì©”ì–´í•œë§ˆë””</th>
          </tr></thead>
          <tbody id="downList"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    /* ================= ê³µí†µ ìœ í‹¸ ================= */
    function pad2(n){return n<10?'0'+n:n}
    function tickClock(){
      const d = new Date();
      const kst = new Date(d.getTime() + (9*60 + d.getTimezoneOffset())*60000);
      const s = `KST â€” ${pad2(kst.getHours())}:${pad2(kst.getMinutes())}:${pad2(kst.getSeconds())}`;
      document.getElementById('clock').textContent = s;
      requestAnimationFrame(()=>setTimeout(tickClock, 500));
    }
    tickClock();

    const KRW = new Intl.NumberFormat('ko-KR');
    const PC = new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 4 });

    function formatKRW(x){
      if (x==null || isNaN(x)) return 'â€”';
      if (x >= 100) return KRW.format(Math.round(x));
      if (x >= 1)   return x.toFixed(2);
      return x.toFixed(4);
    }
    function formatRate(r){
      if (r==null || isNaN(r)) return 'â€”';
      const p = (r*100);
      const cls = p>=0 ? 'pos':'neg';
      return `<span class="${cls}">${p>=0?'+':''}${p.toFixed(2)}%</span>`;
    }

    /* ========== ì—…ë¹„íŠ¸ í˜¸ê°€ë‹¨ìœ„(ì—…ë¹„íŠ¸ ê·œì¹™ ë™ì¼) ========== */
    function priceUnit(p){
      // https://docs.upbit.com/docs/market-info-trade-price-unit ì°¸ê³  ê·œì¹™
      if (p >= 2_000_000) return 1000;
      if (p >= 1_000_000) return 500;
      if (p >=   500_000) return 100;
      if (p >=   100_000) return 50;
      if (p >=    10_000) return 10;
      if (p >=     1_000) return 1;
      if (p >=       100) return 0.1;
      if (p >=        10) return 0.01;
      if (p >=         1) return 0.001;
      return 0.0001;
    }
    function roundByUnit(x){
      const u = priceUnit(x);
      return Math.round(x / u) * u;
    }

    /* ========== ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë””(ê°„ë‹¨ ê·œì¹™, ê¸°ì¡´ í†¤ ìœ ì§€) ========== */
    function riskText(rate){
      const p = rate*100;
      if (p >= 7)  return '3(ì£¼ì˜)';
      if (p >= 2)  return '2(ë³´í†µ)';
      return '1(ì•ˆì •)';
    }
    function zzuText(rate){
      const p = rate*100;
      if (p >= 8)  return 'ğŸš€ í­ë“± ëª¨ë“œ!';
      if (p >= 2)  return 'ğŸ”¥ ë¶ˆì¥ ì‹ í˜¸!';
      if (p <= -6) return 'ğŸ“‰ ë‚™í­ê²½ê³„';
      return 'ğŸ‘€ ê´€ë§';
    }

    /* ================= ê²€ìƒ‰ ì •ê·œí™”(ì•ˆì •íŒ) ================= */
    function normalize(s){
      return (s??'').toString()
        .normalize('NFKD')
        .replace(/\s+/g,'')
        .replace(/[^\wê°€-í£]+/g,'')
        .toLowerCase();
    }
    let allMarkets = [];   // { market, korean_name, english_name }
    let nameMap   = {};    // ì •ê·œí™” ì¸ë±ìŠ¤
    let fuzzyList = [];    // ë¶€ë¶„ì¼ì¹˜ìš©

    async function loadMarkets(){
      const r = await fetch('/api/upbit?path=/v1/market/all?isDetails=true');
      if (!r.ok) throw new Error('ë§ˆì¼“ ì¡°íšŒ ì‹¤íŒ¨');
      const js = await r.json();
      allMarkets = js.filter(x => x.market?.startsWith('KRW-'));
      nameMap = {}; fuzzyList = [];

      allMarkets.forEach(x=>{
        const m = x.market; const sym = m.replace('KRW-','');
        const ko = x.korean_name||''; const en = x.english_name||'';

        // ì›ë¬¸/ì •ê·œí™” direct ë§¤í•‘
        [m, sym, ko, en, normalize(m), normalize(sym), normalize(ko), normalize(en)]
          .forEach(k => { if(k) nameMap[k]=m; });

        // ë¶€ë¶„ì¼ì¹˜ í›„ë³´
        fuzzyList.push({ market:m, keys:[m, sym, ko, en, normalize(m), normalize(sym), normalize(ko), normalize(en)] });
      });
    }
    function resolveMarket(query){
      if(!query) return null;
      const raw=query.trim();
      if(nameMap[raw]) return nameMap[raw];
      const norm=normalize(raw);
      if(nameMap[norm]) return nameMap[norm];
      for(const f of fuzzyList){
        if(f.keys.some(k=>k.includes(norm))) return f.market;
      }
      return null;
    }

    /* ================= í‹°ì»¤/ë¦¬ìŠ¤íŠ¸ ê°±ì‹  ================= */
    async function fetchTickers(mkts){
      if (!mkts.length) return [];
      const url = '/api/upbit?path=' + encodeURIComponent('/v1/ticker?markets=' + mkts.join(','));
      const r = await fetch(url);
      if(!r.ok) throw new Error('í‹°ì»¤ ì‹¤íŒ¨');
      return r.json(); // [{market, trade_price, signed_change_rate, ...}]
    }

    async function refreshLists(){
      // 100ê°œ ë‹¨ìœ„ë¡œ ë¶„í•  í˜¸ì¶œ
      const chunks = [];
      for(let i=0;i<allMarkets.length;i+=100) chunks.push(allMarkets.slice(i,i+100).map(x=>x.market));
      const results = (await Promise.all(chunks.map(fetchTickers))).flat();

      // market -> ì´ë¦„ ë§µ
      const meta = {};
      allMarkets.forEach(x => meta[x.market] = x);

      const rows = results.map(t => {
        const price = t.trade_price ?? 0;
        const rate  = t.signed_change_rate ?? 0; // -1~+1 (ì˜ˆ: 0.034 = +3.4%)
        const unit  = priceUnit(price);
        const bid   = roundByUnit(price - unit);
        const ask   = roundByUnit(price + unit);
        const stop  = roundByUnit(price * 0.98); // ì†ì ˆ ì„ì˜ 2% (í™”ë©´ í†¤ ìœ ì§€ ìš©)
        return {
          market: t.market,
          nameKo: meta[t.market]?.korean_name || t.market,
          price, rate, bid, ask, stop,
          risk: riskText(rate),
          zzu:  zzuText(rate)
        };
      });

      const ups   = rows.slice().sort((a,b)=> b.rate - a.rate).slice(0,10);
      const downs = rows.slice().sort((a,b)=> a.rate - b.rate).slice(0,10);

      renderList('upList', ups);
      renderList('downList', downs);
    }

    function renderList(tbodyId, list){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = list.map((r, i) => {
        return `<tr data-m="${r.market}" style="cursor:pointer" onclick="selectCoin('${r.market}')">
          <td class="muted">${i+1}</td>
          <td>${r.nameKo} <span class="muted">(${r.market})</span></td>
          <td>${formatKRW(r.price)}</td>
          <td>${formatRate(r.rate)}</td>
          <td>${formatKRW(r.bid)}</td>
          <td>${formatKRW(r.ask)}</td>
          <td>${formatKRW(r.stop)}</td>
          <td><span class="tag">${r.risk}</span></td>
          <td><span class="tag">${r.zzu}</span></td>
        </tr>`;
      }).join('');
    }

    /* ================= ì„ íƒ ì½”ì¸ ================= */
    let current = null;
    async function selectCoin(market){
      current = market;
      const meta = allMarkets.find(x => x.market===market);
      document.getElementById('selTitle').innerHTML =
        `ì„ íƒëœ ì½”ì¸: <strong>${meta?.korean_name || market}</strong> <span class="muted">(${market})</span>`;

      const t = (await fetchTickers([market]))[0];
      if (!t) return;
      const price = t.trade_price ?? 0;
      const rate  = t.signed_change_rate ?? 0;
      const unit  = priceUnit(price);
      const bid   = roundByUnit(price - unit);
      const ask   = roundByUnit(price + unit);
      const stop  = roundByUnit(price * 0.98);

      document.getElementById('mPrice').textContent = formatKRW(price);
      document.getElementById('mChange').innerHTML  = formatRate(rate);
      document.getElementById('mBid').textContent   = formatKRW(bid);
      document.getElementById('mAsk').textContent   = formatKRW(ask);
      document.getElementById('mStop').textContent  = formatKRW(stop);
      document.getElementById('mRisk').textContent  = riskText(rate);
      document.getElementById('mZz').textContent    = zzuText(rate);
      document.getElementById('mCode').textContent  = market;
    }

    function resetSelection(){
      current = null;
      document.getElementById('selTitle').innerHTML = 'ì„ íƒëœ ì½”ì¸: <span class="muted">ì—†ìŒ</span>';
      ['mPrice','mChange','mBid','mAsk','mStop','mRisk','mZz','mCode'].forEach(id=>{
        document.getElementById(id).textContent='â€”';
      });
    }

    /* ================= ê²€ìƒ‰ UX ================= */
    const $input = document.getElementById('searchInput');
    const $btn   = document.getElementById('btnSearch');
    const $reset = document.getElementById('btnReset');

    let searchTimer=null;
    function doSearch(){
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{
        const q = $input.value.trim();
        const m = resolveMarket(q);
        if(!m) { alert('ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
        selectCoin(m);
        // ê²€ìƒ‰ ê²°ê³¼ê°€ ë³´ì´ë„ë¡ ìƒë‹¨ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        document.getElementById('selectedCard').scrollIntoView({behavior:'smooth', block:'start'});
      },150);
    }
    $btn.addEventListener('click', doSearch);
    $input.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    $reset.addEventListener('click', ()=>{ $input.value=''; resetSelection(); });

    /* ================= ì´ˆê¸°í™” & ì£¼ê¸° ê°±ì‹  ================= */
    (async function init(){
      try{
        await loadMarkets();               // ë§ˆì¼“ ë¡œë“œ(ê²€ìƒ‰ ì¸ë±ìŠ¤ êµ¬ì„±)
        await refreshLists();              // ì´ˆê¸° ë¦¬ìŠ¤íŠ¸
        // 15ì´ˆë§ˆë‹¤ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  (í•„ìš”ì‹œ ì¡°ì •)
        setInterval(refreshLists, 15000);
        // ì„ íƒëœ ì½”ì¸ì´ ìˆìœ¼ë©´ 5ì´ˆë§ˆë‹¤ ì¹´ë“œ ê°±ì‹ 
        setInterval(()=>{ if(current) selectCoin(current); }, 5000);
      }catch(e){
        console.error(e);
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
      }
    })();
  </script>
</body>
</html>
