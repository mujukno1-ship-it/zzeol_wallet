<script>
const $=(id)=>document.getElementById(id);
let marketList=[]; // ✅ 전역 변수
let currentMarket=null, stopPoll=null;

// ✅ 업비트 호가단위
function getTickSize(price){if(price>=2000000)return 1000;if(price>=1000000)return 500;if(price>=500000)return 100;if(price>=100000)return 50;if(price>=10000)return 10;if(price>=1000)return 5;if(price>=100)return 1;if(price>=10)return 0.1;if(price>=1)return 0.01;if(price>=0.1)return 0.001;if(price>=0.01)return 0.0001;if(price>=0.001)return 0.00001;if(price>=0.0001)return 0.000001;if(price>=0.00001)return 0.0000001;if(price>=0.000001)return 0.00000001;return 0.000000001;}

const Upbit={
  async getMarkets(){
    const res=await fetch('https://api.upbit.com/v1/market/all?isDetails=false');
    return (await res.json()).filter(x=>x.market.startsWith('KRW-'));
  },
  async getTicker(m){
    const t=await fetch(`https://api.upbit.com/v1/ticker?markets=${m}`).then(r=>r.json());
    return t[0];
  },
  format(p){
    if(!p)return '—';
    const tick=getTickSize(p);
    const rounded=Math.round(p/tick)*tick;
    const dec=(tick.toString().split('.')[1]||'').length;
    return rounded.toLocaleString('ko-KR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
  }
};

// ✅ 실시간 시계
function tick(){
  const now=new Date(),utc=now.getTime()+now.getTimezoneOffset()*60000;
  const kst=new Date(utc+9*3600000);
  $('clock').textContent='KST — '+kst.toLocaleTimeString('ko-KR',{hour12:false});
  $('net').textContent=navigator.onLine?'ONLINE':'OFFLINE';
  $('net').style.background=navigator.onLine?'#123922':'#3a1a1a';
}
setInterval(tick,1000); tick();

// ✅ 패널 초기화
function clearPanel(){['price','change','v_price','v_buy','v_sell','v_stop','v_risk','v_comment'].forEach(id=>$(id).textContent='—');}

function aiComment(rate){
  if(rate>0.05)return'🔥 불장 초입, 급등 주의!';
  if(rate>0.02)return'📈 상승 탄력, 추세 유지';
  if(rate>-0.02)return'⚖️ 횡보 구간 — 관망 권장';
  if(rate<-0.02&&rate>-0.05)return'📉 단기 조정 구간, 매수 분할 유효';
  return'💀 급락 리스크 구간 — 철저한 손절 필요';
}

// ✅ 가격 패널 업데이트
function updatePanel(t){
  if(!t)return;
  const p=t.trade_price,rate=t.signed_change_rate;
  $('price').textContent=Upbit.format(p)+' 원';
  $('change').className='diff '+(t.change==='RISE'?'up':t.change==='FALL'?'down':'');
  $('change').textContent=`${t.change==='RISE'?'+':''}${(rate*100).toFixed(2)}%`;
  $('v_price').textContent=Upbit.format(p)+' 원';
  const buy=p*0.988,sell=p*1.012,stop=p*0.975;
  $('v_buy').textContent=Upbit.format(buy)+' 원';
  $('v_sell').textContent=Upbit.format(sell)+' 원';
  $('v_stop').textContent=Upbit.format(stop)+' 원';
  $('v_risk').textContent=Math.abs(rate*100)<1?'1(안정)':Math.abs(rate*100)<2?'2(보통)':'3(주의)';
  $('v_comment').textContent=aiComment(rate);
}

// ✅ 코인 선택 후 실시간 갱신
async function select(market,metaName){
  currentMarket=market; clearPanel();
  const t=await Upbit.getTicker(market);
  updatePanel(t);
  const now=new Date().toLocaleString('ko-KR');
  const record=`[${now}] ${metaName} (${market}) — 현재가: ${Upbit.format(t.trade_price)}원\n`;
  const prev=localStorage.getItem('zzeol_memo')||'';
  localStorage.setItem('zzeol_memo',record+prev);
  $('memoText').value=localStorage.getItem('zzeol_memo');
  if(stopPoll)clearInterval(stopPoll);
  stopPoll=setInterval(async()=>{
    const t=await Upbit.getTicker(market);
    if(currentMarket!==market)return;
    updatePanel(t);
  },1000);
}

// ✅ 페이지 로드 후 실행
window.addEventListener('DOMContentLoaded',async()=>{
  try{
    marketList=await Upbit.getMarkets();
    const input=$('search'),box=$('list');
    input.placeholder='코인명 입력 (예: 시바이누, 비트코인)';
    input.addEventListener('input',()=>{
      const s=input.value.toLowerCase().trim();
      if(!s){box.innerHTML='';box.classList.remove('show');return;}
      const items=marketList.filter(x=>x.korean_name.toLowerCase().includes(s)||x.market.toLowerCase().includes(s));
      box.innerHTML=items.map(x=>`<div class="item" data-m="${x.market}" data-n="${x.korean_name}">${x.korean_name} <span style="color:#8aa0b6">(${x.market.replace('KRW-','')})</span></div>`).join('');
      box.classList.add('show');
    });
    box.addEventListener('click',e=>{
      const el=e.target.closest('.item'); if(!el)return;
      const m=el.dataset.m,n=el.dataset.n;
      input.value='';box.classList.remove('show');
      $('coin-name').innerHTML=`${n} <span style="color:#8aa0b6">(${m.replace('KRW-','')})</span>`;
      $('market').textContent=m;
      select(m,n);
    });
  }catch(err){
    console.error('업비트 연결 실패:',err);
    $('search').placeholder='🚫 업비트 연결 실패 (새로고침)';
  }
});
</script>
