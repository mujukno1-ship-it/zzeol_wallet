<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„ (íƒ€ì Â·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””)</title>
<meta name="color-scheme" content="dark" />
<style>
:root{
  --bg:#0d1117;--card:#161b22;--muted:#98a2b3;--line:#26313c;--up:#16a34a;--dn:#ef4444;--text:#e6edf3;--accent:#3b82f6;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Pretendard,Malgun Gothic,Arial}
a{color:inherit;text-decoration:none}
.wrap{max-width:1180px;margin:22px auto;padding:0 14px}
.header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
.brand{font-weight:700;font-size:18px}
.badge{padding:4px 8px;border:1px solid var(--line);background:var(--card);border-radius:999px;color:#aeb8c4}
.status{margin-left:auto}
.status .ok{color:var(--up)}
.status .err{color:var(--dn)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.card h3{margin:0 0 8px;font-size:13px;color:#aeb8c4}
.row{display:flex;gap:8px;align-items:center}
.input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--line);background:transparent;color:var(--text)}
.btn{padding:10px 12px;border:1px solid var(--line);background:var(--card);border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4756}
.kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px}
.kv div{min-height:22px}
.kv .key{color:#93a4b4}
.table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
.table th,.table td{border-top:1px solid var(--line);padding:10px}
.table th{color:#93a4b4;font-weight:600}
.tr{cursor:pointer}
.tr:hover{background:#121720}
.up{color:var(--up)} .dn{color:var(--dn)}
.pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1520;font-size:12px}
.hint{color:#93a4b4;font-size:12px}
.hr{height:1px;background:var(--line);margin:8px 0}
.note{color:#93a4b4}
.small{font-size:12px}
.footer{margin:18px 0;color:#6a7786;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="brand">ì©”ì–´ì§€ê°‘ ğŸ”¥ v10.4 â€” Upbit KRW ì‹¤ì‹œê°„</div>
    <span class="badge" id="ver-badge">ìƒíƒœ: <b id="ws-status" class="err">ì—°ê²° í™•ì¸ì¤‘â€¦</b></span>
    <div class="row">
      <select class="input" id="tf">
        <option value="1">1ë¶„</option>
        <option value="3">3ë¶„</option>
        <option value="5" selected>5ë¶„</option>
        <option value="10">10ë¶„</option>
        <option value="15">15ë¶„</option>
      </select>
      <button class="btn" id="btn-refresh">KRW ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- ìƒë‹¨ ê²€ìƒ‰/ì„ íƒ -->
  <div class="grid">
    <div class="card">
      <h3>ì½”ì¸ ê²€ìƒ‰</h3>
      <div class="row">
        <input id="search" class="input" placeholder="í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ Â· ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC, ì´ë”ë¦¬ì›€" />
        <button class="btn" id="btn-clear">ì´ˆê¸°í™”</button>
      </div>
      <div class="hr"></div>
      <div class="small hint">KRW ë§ˆì¼“ë§Œ í‘œì‹œ. í–‰ í´ë¦­ ì‹œ ìƒì„¸Â·ì‹ í˜¸ ì¦‰ì‹œ ê°±ì‹ .</div>
    </div>
    <div class="card">
      <h3>ì„ íƒ ì½”ì¸</h3>
      <div class="kv">
        <div class="key">ì´ë¦„</div><div id="sel-name">-</div>
        <div class="key">ì‹¬ë³¼</div><div id="sel-symbol">-</div>
        <div class="key">í˜„ì¬ê°€</div><div id="sel-price">-</div>
        <div class="key">ë“±ë½ë¥ (24h)</div><div id="sel-chg">-</div>
        <div class="key">ê±°ë˜ëŒ€ê¸ˆ(24h)</div><div id="sel-vol">-</div>
        <div class="key">í‹± ì²´ê²°ê°•ë„</div><div id="sel-ts">-</div>
      </div>
    </div>
  </div>

  <!-- ì†ì„± -->
  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>ìœ ë™ì„±Â·ë³€ë™ì„±</h3>
      <div class="kv">
        <div class="key">EMA20</div><div id="m-ema20">-</div>
        <div class="key">ATR(14)</div><div id="m-atr">-</div>
        <div class="key">EMA ê¸°ìš¸ê¸°</div><div id="m-slope">-</div>
        <div class="key">ë¸”ë™ìŠ¤ì™„ ê°ì§€</div><div id="m-swan">-</div>
      </div>
    </div>
    <div class="card">
      <h3>ì†ì ˆÂ·ìœ„í—˜ë„Â·ì©”ì–´í•œë§ˆë””</h3>
      <div class="kv">
        <div class="key">ì†ì ˆ</div><div id="m-sl">-</div>
        <div class="key">ìœ„í—˜ë„</div><div id="m-risk">-</div>
        <div class="key">ì©”ì–´í•œë§ˆë””</div><div id="m-say">-</div>
      </div>
    </div>
  </div>

  <!-- íƒ€ì  -->
  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>ë§¤ìˆ˜ íƒ€ì </h3>
      <div class="kv">
        <div class="key">1ì°¨</div><div id="b1">-</div>
        <div class="key">2ì°¨</div><div id="b2">-</div>
        <div class="key">3ì°¨</div><div id="b3">-</div>
      </div>
      <div class="hr"></div>
      <div class="small note">ê¸°ë³¸ ë£°: EMA20 ê·¼ì²˜ ëˆŒë¦¼ + **Adaptive ATR** ë¶„í•  ì§„ì….</div>
    </div>
    <div class="card">
      <h3>ë§¤ë„(ìµì ˆ) íƒ€ì </h3>
      <div class="kv">
        <div class="key">TP1</div><div id="s1">-</div>
        <div class="key">TP2</div><div id="s2">-</div>
        <div class="key">TP3</div><div id="s3">-</div>
      </div>
      <div class="hr"></div>
      <div class="small note">ê¸°ë³¸ ë£°: í˜„ì¬ê°€ ê¸°ì¤€ ATRÃ—(1.0, 1.6, 2.2) + ì²´ê²°ê°•ë„ ë³´ì •.</div>
    </div>
  </div>

  <!-- ëª©ë¡ -->
  <div class="card" style="margin-top:12px">
    <h3>KRW ì½”ì¸ ëª©ë¡ (ì‹¤ì‹œê°„)</h3>
    <table class="table" id="list">
      <thead><tr>
        <th style="width:90px">ì‹¬ë³¼</th>
        <th>ì½”ì¸ëª…(í•œê¸€)</th>
        <th style="width:120px">í˜„ì¬ê°€</th>
        <th style="width:100px">ë“±ë½ë¥ </th>
        <th style="width:160px">ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
      </tr></thead>
      <tbody id="list-body"></tbody>
    </table>
    <div class="hr"></div>
    <div class="small hint">í–‰ í´ë¦­ ì‹œ ìƒë‹¨ íƒ€ì /ìœ„í—˜ë„/í•œë§ˆë”” ì¦‰ì‹œ ê°±ì‹ .</div>
  </div>

  <div class="footer">Â© 2025 ì©”ì–´ì§€ê°‘ â€” Upbit KRW ì‹¤ì‹œê°„ | ë°ì´í„°: Upbit Public API</div>
</div>

<script>
/* ===========================
   ìœ í‹¸
=========================== */
const qs = s => document.querySelector(s);
const KRW = m => m.startsWith('KRW-');
const fmtN = n => (n==null?'-':Number(n).toLocaleString('ko-KR'));
const sleep = ms => new Promise(r => setTimeout(r, ms));
const chunk = (arr, size) => Array.from({length: Math.ceil(arr.length/size)}, (_,i)=>arr.slice(i*size,(i+1)*size));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

function setStatus(ok, msgOk='ì •ìƒ ì—°ê²°', msgErr='ì—°ê²° ì‹¤íŒ¨'){
  const el = qs('#ws-status');
  el.className = ok?'ok':'err';
  el.textContent = ok?msgOk:msgErr;
}

/* ===========================
   Upbit API (ì¬ì‹œë„ í¬í•¨)
=========================== */
async function apiGet(url, tryMax=2){
  for(let i=0;i<tryMax;i++){
    try{
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){
      if(i===tryMax-1) throw e;
      await sleep(280);
    }
  }
}

const UPBIT = {
  markets: ()=> apiGet('https://api.upbit.com/v1/market/all?isDetails=true'),
  ticker: (markets)=> apiGet('https://api.upbit.com/v1/ticker?markets='+markets.join(',')),
  candles: (tf, market, count=200)=> apiGet(`https://api.upbit.com/v1/candles/minutes/${tf}?market=${market}&count=${count}`),
  trades: (market, count=200)=> apiGet(`https://api.upbit.com/v1/trades/ticks?market=${market}&count=${count}`),
}

/* ===========================
   ì§€í‘œ ê³„ì‚°
=========================== */
function ema(values, period=20){
  const k = 2/(period+1);
  let ema = values[0];
  for(let i=1;i<values.length;i++) ema = values[i]*k + ema*(1-k);
  return ema;
}
function emaSeries(values, period=20){
  const out=[]; let e = values[0];
  const k=2/(period+1);
  for(let i=0;i<values.length;i++){
    e = (i===0?values[i]:values[i]*k + e*(1-k));
    out.push(e);
  }
  return out;
}
function atrFromCandles(c, period=14){
  // Upbit ë¶„ë´‰ ê°ì²´: trade_price, high_price, low_price, opening_price
  const trs=[];
  for(let i=0;i<c.length;i++){
    const H = c[i].high_price, L = c[i].low_price;
    const prevClose = i>0 ? c[i-1].trade_price : c[i].opening_price;
    const tr = Math.max(H-L, Math.abs(H-prevClose), Math.abs(L-prevClose));
    trs.push(tr);
  }
  // Wilder ATR
  let atr = trs[0];
  for(let i=1;i<trs.length;i++){
    atr = (atr*(period-1) + trs[i]) / period;
  }
  return atr;
}
function slopeOf(arr){
  // ê°„ë‹¨í•œ ê¸°ìš¸ê¸°(ì¢…ê°€ EMAì˜ ë§ˆì§€ë§‰-ì´ì „)
  if(arr.length<2) return 0;
  const n = arr.length;
  return arr[n-1] - arr[n-2];
}
function tickStrength(trades){
  // BID/ASK ëˆ„ì  ë¸íƒ€ ì •ê·œí™” [-1,1]
  let bid=0, ask=0;
  for(const t of trades){
    if(t.ask_bid==='BID') bid+= t.volume * t.trade_price;
    else ask+= t.volume * t.trade_price;
  }
  const total = bid+ask;
  if(total===0) return 0;
  const s = (bid-ask)/total;
  return clamp(s, -1, 1);
}

/* ===========================
   Adaptive ATR & íƒ€ì 
=========================== */
function buildTargets({price, ema20, atr, ts, emaSlope}){
  // ë³€ë™ì„±/ì¶”ì„¸/ì²´ê²°ê°•ë„ ê¸°ë°˜ ê°€ì¤‘ì¹˜
  const regime =
    (Math.abs(emaSlope) > atr*0.05 ? 'trend' : 'range');

  // ì²´ê²°ê°•ë„ ë³´ì • (ì–‘ìˆ˜ë©´ ë§¤ìˆ˜ ìš°ì„¸)
  const buyBias = ts>0 ? 1 : 0;
  const sellBias = ts<0 ? 1 : 0;

  // Adaptive ATR multiplier
  const mulBuyBase = regime==='trend' ? 0.8 : 1.0;
  const mulSellBase = regime==='trend' ? 1.2 : 1.0;

  const b1 = ema20 - atr*(0.5*mulBuyBase);
  const b2 = ema20 - atr*(1.0*mulBuyBase);
  const b3 = ema20 - atr*(1.5*mulBuyBase + (buyBias?0.1:0));

  const s1 = price + atr*(1.0*mulSellBase + (sellBias?0.05:0));
  const s2 = price + atr*(1.6*mulSellBase + (sellBias?0.1:0));
  const s3 = price + atr*(2.2*mulSellBase + (sellBias?0.15:0));

  const stop = Math.min(b3 - atr*0.6, ema20 - atr*2.4);

  return {b1,b2,b3,s1,s2,s3,stop, regime};
}

function riskScore({price, ema20, atr, ts, vol24, chg24}){
  // ê±°ë¦¬/ì²´ê²°ê°•ë„/ê±°ë˜ëŒ€ê¸ˆ/ë³€ë™ ê¸°ë°˜ 1~5
  const dist = Math.abs(price-ema20)/Math.max(atr,1);
  const distScore = dist<0.6?1 : dist<1.2?2 : dist<1.8?3 : dist<2.6?4 : 5;

  const tsScore = ts>0.25?1 : ts>-0.2?2 : ts>-0.45?3 : ts>-0.7?4 : 5;

  const volScore = vol24>5e8?1 : vol24>1e8?2 : vol24>3e7?3 : 4;

  const chgAbs = Math.abs(chg24||0);
  const chgScore = chgAbs<2?1 : chgAbs<5?2 : chgAbs<9?3 : 4;

  let sum = distScore+tsScore+volScore+chgScore;
  let risk = Math.round(sum/4);
  return clamp(risk,1,5);
}

function zzeolOneLine({regime, ts, risk, emaSlope}){
  const dir = emaSlope>0 ? 'ìš°ìƒí–¥' : emaSlope<0 ? 'í•˜ë½' : 'íš¡ë³´';
  const tsWord = ts>0.3?'ë§¤ìˆ˜ ìš°ìœ„' : ts<-0.3?'ë§¤ë„ ìš°ìœ„' : 'ì¤‘ë¦½';
  const riskW = ['ë§¤ìš° ì•ˆì •','ì•ˆì •','ë³´í†µ','ì£¼ì˜','ê³ ìœ„í—˜'][risk-1] || 'ë³´í†µ';
  if(regime==='trend'){
    return `ì¶”ì„¸ ${dir} ì§€ì†, ì²´ê²°ê°•ë„ ${tsWord}. ëˆŒë¦¼ ë¶„í• ë§¤ìˆ˜ ìœ íš¨ â€” ìœ„í—˜ë„ ${riskW}.`;
  }else{
    return `ë°•ìŠ¤/ë³€ë™ êµ¬ê°„, ì²´ê²°ê°•ë„ ${tsWord}. í•˜ë‹¨ ë§¤ìˆ˜Â·ìƒë‹¨ ìµì ˆ ìœ„ì£¼ â€” ìœ„í—˜ë„ ${riskW}.`;
  }
}

/* ===========================
   í™”ë©´ ë°”ì¸ë”©
=========================== */
const UI = {
  list: qs('#list-body'),
  search: qs('#search'),
  clear: qs('#btn-clear'),
  refresh: qs('#btn-refresh'),
  tf: qs('#tf'),
  // selected panel
  sel: {
    name: qs('#sel-name'),
    symbol: qs('#sel-symbol'),
    price: qs('#sel-price'),
    chg: qs('#sel-chg'),
    vol: qs('#sel-vol'),
    ts: qs('#sel-ts'),
  },
  meta: {
    ema20: qs('#m-ema20'),
    atr: qs('#m-atr'),
    slope: qs('#m-slope'),
    swan: qs('#m-swan'),
    sl: qs('#m-sl'),
    risk: qs('#m-risk'),
    say: qs('#m-say'),
  },
  buy:{b1:qs('#b1'),b2:qs('#b2'),b3:qs('#b3')},
  sell:{s1:qs('#s1'),s2:qs('#s2'),s3:qs('#s3')},
};

let ALL = []; // ëª¨ë“  KRW ë§ˆì¼“ ë©”íƒ€
let CURRENT = null; // {market, korean_name, english_name, symbol}

/* ëª©ë¡ ë¡œë“œ */
async function loadKRWList(){
  try{
    setStatus(true,'ì—°ê²° ì¤€ë¹„ì¤‘â€¦');
    const mk = await UPBIT.markets();
    const krw = mk.filter(x=>KRW(x.market));
    ALL = krw.map(x=>({
      market:x.market,
      symbol:x.market.replace('KRW-',''),
      korean:x.korean_name, eng:x.english_name
    }));
    // ë°°ì¹˜ í‹°ì»¤
    const chunks = chunk(ALL.map(x=>x.market), 80);
    const rows = [];
    for(const c of chunks){
      const t = await UPBIT.ticker(c);
      rows.push(...t);
      await sleep(80);
    }
    renderList(rows);
    setStatus(true,'ì •ìƒ ì—°ê²°');
  }catch(e){
    console.error(e);
    setStatus(false,'ì—°ê²° ì‹¤íŒ¨');
  }
}

function renderList(tickers){
  const map = new Map(tickers.map(t=>[t.market,t]));
  const term = (UI.search.value||'').trim().toLowerCase();
  const arr = ALL.filter(a=>{
    const txt = (a.korean+' '+a.eng+' '+a.symbol).toLowerCase();
    return !term || txt.includes(term);
  }).map(a=>{
    const t = map.get(a.market)||{};
    return {
      market:a.market,symbol:a.symbol,korean:a.korean,
      price:t.trade_price, chg:t.signed_change_rate? t.signed_change_rate*100:0,
      vol:t.acc_trade_price_24h||0
    }
  }).sort((a,b)=>b.vol-a.vol);

  UI.list.innerHTML = arr.map(o=>`
    <tr class="tr" data-market="${o.market}">
      <td>${o.symbol}</td>
      <td>${o.korean}</td>
      <td class="${o.chg>=0?'up':'dn'}">${fmtN(Math.round(o.price||0))}</td>
      <td class="${o.chg>=0?'up':'dn'}">${(o.chg||0).toFixed(2)}%</td>
      <td>${fmtN(Math.round(o.vol||0))}ì›</td>
    </tr>
  `).join('');

  // click bind
  UI.list.querySelectorAll('.tr').forEach(tr=>{
    tr.onclick = ()=> selectMarket(tr.dataset.market);
  });
}

/* ë§ˆì¼“ ì„ íƒ â†’ ì§€í‘œ/íƒ€ì  ê³„ì‚° */
async function selectMarket(market){
  CURRENT = ALL.find(x=>x.market===market);
  if(!CURRENT) return;
  const tf = Number(UI.tf.value||5);

  try{
    const [ticker] = await UPBIT.ticker([market]);
    const [candles, trades] = await Promise.all([
      UPBIT.candles(tf, market, 200),
      UPBIT.trades(market, 200)
    ]);

    const closes = candles.slice().reverse().map(c=>c.trade_price);
    const ema20Series = emaSeries(closes, 20);
    const ema20 = ema20Series[ema20Series.length-1];
    const emaSlope = slopeOf(ema20Series);
    const atr = atrFromCandles(candles.slice().reverse(), 14);
    const ts = tickStrength(trades);

    // í‘œì‹œ
    UI.sel.name.textContent = CURRENT.korean;
    UI.sel.symbol.textContent = `${CURRENT.symbol} (${market})`;
    UI.sel.price.textContent = fmtN(Math.round(ticker.trade_price||0))+' ì›';
    UI.sel.chg.innerHTML = (ticker.signed_change_rate>=0?'<span class="up">':'<span class="dn">')
       + ((ticker.signed_change_rate*100)||0).toFixed(2) + '%</span>';
    UI.sel.vol.textContent = fmtN(Math.round(ticker.acc_trade_price_24h||0))+' ì›';
    UI.sel.ts.innerHTML = ts>0?`<span class="up">${(ts*100).toFixed(0)}%</span>`:
                                 ts<0?`<span class="dn">${(ts*100).toFixed(0)}%</span>`:`0%`;

    UI.meta.ema20.textContent = fmtN(Math.round(ema20));
    UI.meta.atr.textContent = fmtN(Math.round(atr));
    UI.meta.slope.innerHTML = emaSlope>0?`<span class="up">+${Math.round(emaSlope)}</span>`:
                               emaSlope<0?`<span class="dn">${Math.round(emaSlope)}</span>`:'0';

    // ë¸”ë™ìŠ¤ì™„(ì´ìƒì¹˜) ê°„ë‹¨ ê°ì§€: ìµœê·¼ 3ìº”ë“¤ ì¤‘ ë‹¨ì¼ TRì´ ATRx3 ì´ˆê³¼
    const rev = candles.slice().reverse();
    let swan = false;
    for(let i=Math.max(1,rev.length-4);i<rev.length;i++){
      const tr = Math.max(rev[i].high_price-rev[i].low_price,
                          Math.abs(rev[i].high_price-rev[i-1].trade_price),
                          Math.abs(rev[i].low_price-rev[i-1].trade_price));
      if(tr > atr*3.2){ swan=true; break; }
    }
    UI.meta.swan.textContent = swan? 'ê°ì§€ë¨(ì£¼ì˜)' : 'ì •ìƒ';

    // íƒ€ì 
    const tgt = buildTargets({
      price:ticker.trade_price, ema20, atr, ts, emaSlope
    });

    UI.buy.b1.textContent = fmtN(Math.round(tgt.b1));
    UI.buy.b2.textContent = fmtN(Math.round(tgt.b2));
    UI.buy.b3.textContent = fmtN(Math.round(tgt.b3));
    UI.sell.s1.textContent = fmtN(Math.round(tgt.s1));
    UI.sell.s2.textContent = fmtN(Math.round(tgt.s2));
    UI.sell.s3.textContent = fmtN(Math.round(tgt.s3));
    UI.meta.sl.textContent = fmtN(Math.round(tgt.stop));

    // ìœ„í—˜ë„/í•œë§ˆë””
    const risk = riskScore({
      price:ticker.trade_price, ema20, atr, ts,
      vol24:ticker.acc_trade_price_24h, chg24:(ticker.signed_change_rate||0)*100
    });
    UI.meta.risk.innerHTML = `<span class="pill">Risk ${risk}</span>`;
    UI.meta.say.textContent = zzeolOneLine({
      regime:tgt.regime, ts, risk, emaSlope
    });

    setStatus(true,'ì •ìƒ ì—°ê²°');
  }catch(e){
    console.error(e);
    setStatus(false,'ì—°ê²° ì‹¤íŒ¨');
  }
}

/* ===========================
   ì´ë²¤íŠ¸
=========================== */
UI.search.addEventListener('input', ()=> loadKRWList()); // ê°„ë‹¨ í•„í„°
UI.clear.onclick = ()=>{ UI.search.value=''; loadKRWList(); };
UI.refresh.onclick = ()=> loadKRWList();
UI.tf.onchange = ()=> { if(CURRENT) selectMarket(CURRENT.market); };

/* ì´ˆê¸° ë¡œë“œ */
loadKRWList();
</script>
</body>
</html>
